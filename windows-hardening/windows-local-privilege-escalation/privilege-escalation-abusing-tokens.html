<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Abusing Tokens</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="æ»¥ç”¨ä»¤ç‰Œ"><a class="header" href="#æ»¥ç”¨ä»¤ç‰Œ">æ»¥ç”¨ä»¤ç‰Œ</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨ Twitter ä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="ä»¤ç‰Œ"><a class="header" href="#ä»¤ç‰Œ">ä»¤ç‰Œ</a></h2>
<p>å¦‚æœä½ <strong>ä¸çŸ¥é“ Windows è®¿é—®ä»¤ç‰Œæ˜¯ä»€ä¹ˆ</strong>ï¼Œè¯·åœ¨ç»§ç»­ä¹‹å‰é˜…è¯»æ­¤é¡µé¢ï¼š</p>
<p>{% content-ref url="access-tokens.md" %}
<a href="access-tokens.html">access-tokens.md</a>
{% endcontent-ref %}</p>
<p><strong>ä¹Ÿè®¸ä½ å¯ä»¥é€šè¿‡æ»¥ç”¨ä½ å·²ç»æ‹¥æœ‰çš„ä»¤ç‰Œæ¥æå‡æƒé™</strong></p>
<h3 id="seimpersonateprivilege"><a class="header" href="#seimpersonateprivilege">SeImpersonatePrivilege</a></h3>
<p>è¿™æ˜¯ä»»ä½•è¿›ç¨‹æŒæœ‰çš„ç‰¹æƒï¼Œå…è®¸å¯¹ä»»ä½•ä»¤ç‰Œè¿›è¡Œ impersonationï¼ˆä½†ä¸å…è®¸åˆ›å»ºï¼‰ï¼Œå‰ææ˜¯å¯ä»¥è·å¾—å…¶å¥æŸ„ã€‚å¯ä»¥é€šè¿‡è¯±ä½¿ Windows æœåŠ¡ï¼ˆDCOMï¼‰å¯¹ä¸€ä¸ªæ¼æ´æ‰§è¡Œ NTLM è®¤è¯æ¥è·å–ç‰¹æƒä»¤ç‰Œï¼Œä»è€Œå¯ç”¨ä»¥ SYSTEM æƒé™æ‰§è¡Œè¿›ç¨‹ã€‚å¯ä»¥ä½¿ç”¨å„ç§å·¥å…·åˆ©ç”¨æ­¤æ¼æ´ï¼Œä¾‹å¦‚ <a href="https://github.com/ohpe/juicy-potato">juicy-potato</a>ã€<a href="https://github.com/antonioCoco/RogueWinRM">RogueWinRM</a>ï¼ˆéœ€è¦ç¦ç”¨ winrmï¼‰ã€<a href="https://github.com/CCob/SweetPotato">SweetPotato</a> å’Œ <a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a>ã€‚</p>
<p>{% content-ref url="roguepotato-and-printspoofer.md" %}
<a href="roguepotato-and-printspoofer.html">roguepotato-and-printspoofer.md</a>
{% endcontent-ref %}</p>
<p>{% content-ref url="juicypotato.md" %}
<a href="juicypotato.html">juicypotato.md</a>
{% endcontent-ref %}</p>
<h3 id="seassignprimaryprivilege"><a class="header" href="#seassignprimaryprivilege">SeAssignPrimaryPrivilege</a></h3>
<p>å®ƒä¸ <strong>SeImpersonatePrivilege</strong> éå¸¸ç›¸ä¼¼ï¼Œå°†ä½¿ç”¨ <strong>ç›¸åŒçš„æ–¹æ³•</strong> æ¥è·å–ç‰¹æƒä»¤ç‰Œã€‚<br />
ç„¶åï¼Œæ­¤ç‰¹æƒå…è®¸<strong>å°†ä¸»ä»¤ç‰Œåˆ†é…</strong>ç»™æ–°çš„/æŒ‚èµ·çš„è¿›ç¨‹ã€‚ä½¿ç”¨ç‰¹æƒ impersonation ä»¤ç‰Œå¯ä»¥æ´¾ç”Ÿå‡ºä¸»ä»¤ç‰Œï¼ˆDuplicateTokenExï¼‰ã€‚<br />
ä½¿ç”¨è¯¥ä»¤ç‰Œï¼Œå¯ä»¥é€šè¿‡ 'CreateProcessAsUser' åˆ›å»ºä¸€ä¸ª <strong>æ–°è¿›ç¨‹</strong>ï¼Œæˆ–åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„è¿›ç¨‹å¹¶<strong>è®¾ç½®ä»¤ç‰Œ</strong>ï¼ˆé€šå¸¸ï¼Œæ— æ³•ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¸»ä»¤ç‰Œï¼‰ã€‚</p>
<h3 id="setcbprivilege"><a class="header" href="#setcbprivilege">SeTcbPrivilege</a></h3>
<p>å¦‚æœä½ å¯ç”¨äº†æ­¤ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨ <strong>KERB_S4U_LOGON</strong> ä¸ºä»»ä½•å…¶ä»–ç”¨æˆ·è·å– <strong>impersonation ä»¤ç‰Œ</strong>ï¼Œè€Œæ— éœ€çŸ¥é“å‡­æ®ï¼Œ<strong>å‘ä»¤ç‰Œæ·»åŠ ä»»æ„ç»„</strong>ï¼ˆç®¡ç†å‘˜ï¼‰ï¼Œå°†ä»¤ç‰Œçš„ <strong>å®Œæ•´æ€§çº§åˆ«</strong> è®¾ç½®ä¸º "<strong>ä¸­ç­‰</strong>"ï¼Œå¹¶å°†æ­¤ä»¤ç‰Œåˆ†é…ç»™ <strong>å½“å‰çº¿ç¨‹</strong>ï¼ˆSetThreadTokenï¼‰ã€‚</p>
<h3 id="sebackupprivilege"><a class="header" href="#sebackupprivilege">SeBackupPrivilege</a></h3>
<p>æ­¤ç‰¹æƒä½¿ç³»ç»Ÿèƒ½å¤Ÿ<strong>æˆäºˆå¯¹ä»»ä½•æ–‡ä»¶çš„æ‰€æœ‰è¯»å–è®¿é—®</strong>æ§åˆ¶ï¼ˆä»…é™è¯»å–æ“ä½œï¼‰ã€‚å®ƒç”¨äº<strong>ä»æ³¨å†Œè¡¨ä¸­è¯»å–æœ¬åœ°ç®¡ç†å‘˜</strong>å¸æˆ·çš„å¯†ç å“ˆå¸Œï¼Œéšåå¯ä»¥ä½¿ç”¨åƒ "<strong>psexec</strong>" æˆ– "<strong>wmiexec</strong>" è¿™æ ·çš„å·¥å…·ä¸å“ˆå¸Œä¸€èµ·ä½¿ç”¨ï¼ˆPass-the-Hash æŠ€æœ¯ï¼‰ã€‚ç„¶è€Œï¼Œåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ­¤æŠ€æœ¯ä¼šå¤±è´¥ï¼šå½“æœ¬åœ°ç®¡ç†å‘˜å¸æˆ·è¢«ç¦ç”¨ï¼Œæˆ–å½“æœ‰æ”¿ç­–é™åˆ¶æœ¬åœ°ç®¡ç†å‘˜çš„è¿œç¨‹è¿æ¥çš„ç®¡ç†æƒé™æ—¶ã€‚<br />
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼<strong>æ»¥ç”¨æ­¤ç‰¹æƒ</strong>ï¼š</p>
<ul>
<li><a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1</a></li>
<li><a href="https://github.com/giuliano108/SeBackupPrivilege/tree/master/SeBackupPrivilegeCmdLets/bin/Debug">https://github.com/giuliano108/SeBackupPrivilege/tree/master/SeBackupPrivilegeCmdLets/bin/Debug</a></li>
<li>å…³æ³¨ <strong>IppSec</strong> åœ¨ <a href="https://www.youtube.com/watch?v=IfCysW0Od8w&amp;t=2610&amp;ab_channel=IppSec">https://www.youtube.com/watch?v=IfCysW0Od8w&amp;t=2610&amp;ab_channel=IppSec</a></li>
<li>æˆ–å¦‚åœ¨ä»¥ä¸‹å†…å®¹ä¸­æ‰€è¿°çš„ <strong>ä½¿ç”¨å¤‡ä»½æ“ä½œå‘˜æå‡æƒé™</strong> éƒ¨åˆ†ï¼š</li>
</ul>
<p>{% content-ref url="../active-directory-methodology/privileged-groups-and-token-privileges.md" %}
<a href="../active-directory-methodology/privileged-groups-and-token-privileges.html">privileged-groups-and-token-privileges.md</a>
{% endcontent-ref %}</p>
<h3 id="serestoreprivilege"><a class="header" href="#serestoreprivilege">SeRestorePrivilege</a></h3>
<p>æ­¤ç‰¹æƒæä¾›å¯¹ä»»ä½•ç³»ç»Ÿæ–‡ä»¶çš„ <strong>å†™è®¿é—®</strong> æƒé™ï¼Œæ— è®ºæ–‡ä»¶çš„è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰å¦‚ä½•ã€‚å®ƒä¸ºæå‡æƒé™æ‰“å¼€äº†è®¸å¤šå¯èƒ½æ€§ï¼ŒåŒ…æ‹¬<strong>ä¿®æ”¹æœåŠ¡</strong>ã€æ‰§è¡Œ DLL åŠ«æŒä»¥åŠé€šè¿‡å›¾åƒæ–‡ä»¶æ‰§è¡Œé€‰é¡¹è®¾ç½® <strong>è°ƒè¯•å™¨</strong>ç­‰å¤šç§æŠ€æœ¯ã€‚</p>
<h3 id="secreatetokenprivilege"><a class="header" href="#secreatetokenprivilege">SeCreateTokenPrivilege</a></h3>
<p>SeCreateTokenPrivilege æ˜¯ä¸€ç§å¼ºå¤§çš„æƒé™ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”¨æˆ·å…·å¤‡ impersonate ä»¤ç‰Œçš„èƒ½åŠ›æ—¶ï¼Œä½†åœ¨ç¼ºä¹ SeImpersonatePrivilege çš„æƒ…å†µä¸‹ä¹Ÿå¾ˆæœ‰ç”¨ã€‚æ­¤èƒ½åŠ›ä¾èµ–äºèƒ½å¤Ÿ impersonate ä»£è¡¨åŒä¸€ç”¨æˆ·çš„ä»¤ç‰Œï¼Œå¹¶ä¸”å…¶å®Œæ•´æ€§çº§åˆ«ä¸è¶…è¿‡å½“å‰è¿›ç¨‹çš„å®Œæ•´æ€§çº§åˆ«ã€‚</p>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>åœ¨æ²¡æœ‰ SeImpersonatePrivilege çš„æƒ…å†µä¸‹è¿›è¡Œ impersonationï¼š</strong> å¯ä»¥åˆ©ç”¨ SeCreateTokenPrivilege åœ¨ç‰¹å®šæ¡ä»¶ä¸‹é€šè¿‡ impersonate ä»¤ç‰Œå®ç°æƒé™æå‡ã€‚</li>
<li><strong>ä»¤ç‰Œ impersonation çš„æ¡ä»¶ï¼š</strong> æˆåŠŸçš„ impersonation è¦æ±‚ç›®æ ‡ä»¤ç‰Œå±äºåŒä¸€ç”¨æˆ·ï¼Œå¹¶ä¸”å…¶å®Œæ•´æ€§çº§åˆ«å°äºæˆ–ç­‰äºå°è¯• impersonation çš„è¿›ç¨‹çš„å®Œæ•´æ€§çº§åˆ«ã€‚</li>
<li><strong>åˆ›å»ºå’Œä¿®æ”¹ impersonation ä»¤ç‰Œï¼š</strong> ç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ª impersonation ä»¤ç‰Œï¼Œå¹¶é€šè¿‡æ·»åŠ ç‰¹æƒç»„çš„ SIDï¼ˆå®‰å…¨æ ‡è¯†ç¬¦ï¼‰æ¥å¢å¼ºå®ƒã€‚</li>
</ul>
<h3 id="seloaddriverprivilege"><a class="header" href="#seloaddriverprivilege">SeLoadDriverPrivilege</a></h3>
<p>æ­¤ç‰¹æƒå…è®¸<strong>åŠ è½½å’Œå¸è½½è®¾å¤‡é©±åŠ¨ç¨‹åº</strong>ï¼Œé€šè¿‡åˆ›å»ºå…·æœ‰ç‰¹å®šå€¼çš„æ³¨å†Œè¡¨é¡¹ <code>ImagePath</code> å’Œ <code>Type</code>ã€‚ç”±äºå¯¹ <code>HKLM</code>ï¼ˆHKEY_LOCAL_MACHINEï¼‰çš„ç›´æ¥å†™è®¿é—®å—åˆ°é™åˆ¶ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨ <code>HKCU</code>ï¼ˆHKEY_CURRENT_USERï¼‰ã€‚ç„¶è€Œï¼Œä¸ºäº†ä½¿ <code>HKCU</code> å¯¹å†…æ ¸å¯è¯†åˆ«ä»¥è¿›è¡Œé©±åŠ¨ç¨‹åºé…ç½®ï¼Œå¿…é¡»éµå¾ªç‰¹å®šè·¯å¾„ã€‚</p>
<p>æ­¤è·¯å¾„ä¸º <code>\Registry\User\&lt;RID&gt;\System\CurrentControlSet\Services\DriverName</code>ï¼Œå…¶ä¸­ <code>&lt;RID&gt;</code> æ˜¯å½“å‰ç”¨æˆ·çš„ç›¸å¯¹æ ‡è¯†ç¬¦ã€‚åœ¨ <code>HKCU</code> ä¸­ï¼Œå¿…é¡»åˆ›å»ºæ•´ä¸ªè·¯å¾„ï¼Œå¹¶è®¾ç½®ä¸¤ä¸ªå€¼ï¼š</p>
<ul>
<li><code>ImagePath</code>ï¼Œå³è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„</li>
<li><code>Type</code>ï¼Œå€¼ä¸º <code>SERVICE_KERNEL_DRIVER</code>ï¼ˆ<code>0x00000001</code>ï¼‰ã€‚</li>
</ul>
<p><strong>éµå¾ªçš„æ­¥éª¤ï¼š</strong></p>
<ol>
<li>ç”±äºå†™è®¿é—®å—é™ï¼Œè®¿é—® <code>HKCU</code> è€Œä¸æ˜¯ <code>HKLM</code>ã€‚</li>
<li>åœ¨ <code>HKCU</code> ä¸­åˆ›å»ºè·¯å¾„ <code>\Registry\User\&lt;RID&gt;\System\CurrentControlSet\Services\DriverName</code>ï¼Œå…¶ä¸­ <code>&lt;RID&gt;</code> ä»£è¡¨å½“å‰ç”¨æˆ·çš„ç›¸å¯¹æ ‡è¯†ç¬¦ã€‚</li>
<li>å°† <code>ImagePath</code> è®¾ç½®ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰§è¡Œè·¯å¾„ã€‚</li>
<li>å°† <code>Type</code> è®¾ç½®ä¸º <code>SERVICE_KERNEL_DRIVER</code>ï¼ˆ<code>0x00000001</code>ï¼‰ã€‚</li>
</ol>
<pre><code class="language-python"># Example Python code to set the registry values
import winreg as reg

# Define the path and values
path = r'Software\YourPath\System\CurrentControlSet\Services\DriverName' # Adjust 'YourPath' as needed
key = reg.OpenKey(reg.HKEY_CURRENT_USER, path, 0, reg.KEY_WRITE)
reg.SetValueEx(key, "ImagePath", 0, reg.REG_SZ, "path_to_binary")
reg.SetValueEx(key, "Type", 0, reg.REG_DWORD, 0x00000001)
reg.CloseKey(key)
</code></pre>
<p>æ›´å¤šæ»¥ç”¨æ­¤æƒé™çš„æ–¹æ³•åœ¨ <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/privileged-accounts-and-token-privileges#seloaddriverprivilege">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/privileged-accounts-and-token-privileges#seloaddriverprivilege</a></p>
<h3 id="setakeownershipprivilege"><a class="header" href="#setakeownershipprivilege">SeTakeOwnershipPrivilege</a></h3>
<p>è¿™ä¸ <strong>SeRestorePrivilege</strong> ç±»ä¼¼ã€‚å…¶ä¸»è¦åŠŸèƒ½å…è®¸ä¸€ä¸ªè¿›ç¨‹ <strong>å‡å®šå¯¹è±¡çš„æ‰€æœ‰æƒ</strong>ï¼Œç»•è¿‡é€šè¿‡æä¾› WRITE_OWNER è®¿é—®æƒé™çš„æ˜ç¡®è‡ªç”±è£é‡è®¿é—®è¦æ±‚ã€‚è¯¥è¿‡ç¨‹é¦–å…ˆç¡®ä¿è·å¾—æ‰€éœ€æ³¨å†Œè¡¨é¡¹çš„æ‰€æœ‰æƒä»¥è¿›è¡Œå†™å…¥ï¼Œç„¶åæ›´æ”¹ DACL ä»¥å¯ç”¨å†™å…¥æ“ä½œã€‚</p>
<pre><code class="language-bash">takeown /f 'C:\some\file.txt' #Now the file is owned by you
icacls 'C:\some\file.txt' /grant &lt;your_username&gt;:F #Now you have full access
# Use this with files that might contain credentials such as
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software
%WINDIR%\repair\security
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
c:\inetpub\wwwwroot\web.config
</code></pre>
<h3 id="sedebugprivilege"><a class="header" href="#sedebugprivilege">SeDebugPrivilege</a></h3>
<p>æ­¤æƒé™å…è®¸<strong>è°ƒè¯•å…¶ä»–è¿›ç¨‹</strong>ï¼ŒåŒ…æ‹¬è¯»å–å’Œå†™å…¥å†…å­˜ã€‚å¯ä»¥åˆ©ç”¨æ­¤æƒé™é‡‡ç”¨å„ç§å†…å­˜æ³¨å…¥ç­–ç•¥ï¼Œèƒ½å¤Ÿè§„é¿å¤§å¤šæ•°æ€æ¯’è½¯ä»¶å’Œä¸»æœºå…¥ä¾µé˜²å¾¡è§£å†³æ–¹æ¡ˆã€‚</p>
<h4 id="dump-memory"><a class="header" href="#dump-memory">Dump memory</a></h4>
<p>æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a>æ¥è‡ª<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">SysInternals Suite</a>æ¥<strong>æ•è·è¿›ç¨‹çš„å†…å­˜</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™å¯ä»¥åº”ç”¨äº<strong>æœ¬åœ°å®‰å…¨æˆæƒå­ç³»ç»ŸæœåŠ¡ï¼ˆ</strong><a href="https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service"><strong>LSASS</strong></a>**ï¼‰**è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹è´Ÿè´£åœ¨ç”¨æˆ·æˆåŠŸç™»å½•ç³»ç»Ÿåå­˜å‚¨ç”¨æˆ·å‡­æ®ã€‚</p>
<p>ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨mimikatzä¸­åŠ è½½æ­¤è½¬å‚¨ä»¥è·å–å¯†ç ï¼š</p>
<pre><code>mimikatz.exe
mimikatz # log
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
</code></pre>
<h4 id="rce"><a class="header" href="#rce">RCE</a></h4>
<p>å¦‚æœä½ æƒ³è·å¾—ä¸€ä¸ª <code>NT SYSTEM</code> shellï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š</p>
<ul>
<li><a href="https://github.com/bruno-1337/SeDebugPrivilege-Exploit"><strong>SeDebugPrivilege-Exploit (C++)</strong></a></li>
<li><a href="https://github.com/daem0nc0re/PrivFu/tree/main/PrivilegedOperations/SeDebugPrivilegePoC"><strong>SeDebugPrivilegePoC (C#)</strong></a></li>
<li><a href="https://raw.githubusercontent.com/decoder-it/psgetsystem/master/psgetsys.ps1"><strong>psgetsys.ps1 (Powershell Script)</strong></a></li>
</ul>
<pre><code class="language-powershell"># Get the PID of a process running as NT SYSTEM
import-module psgetsys.ps1; [MyProcess]::CreateProcessFromParent(&lt;system_pid&gt;,&lt;command_to_execute&gt;)
</code></pre>
<h2 id="æ£€æŸ¥æƒé™"><a class="header" href="#æ£€æŸ¥æƒé™">æ£€æŸ¥æƒé™</a></h2>
<pre><code>whoami /priv
</code></pre>
<p><strong>æ˜¾ç¤ºä¸ºç¦ç”¨çš„ä»¤ç‰Œ</strong>å¯ä»¥è¢«å¯ç”¨ï¼Œæ‚¨å®é™…ä¸Šå¯ä»¥åˆ©ç”¨_å¯ç”¨_å’Œ_ç¦ç”¨_ä»¤ç‰Œã€‚</p>
<h3 id="å¯ç”¨æ‰€æœ‰ä»¤ç‰Œ"><a class="header" href="#å¯ç”¨æ‰€æœ‰ä»¤ç‰Œ">å¯ç”¨æ‰€æœ‰ä»¤ç‰Œ</a></h3>
<p>å¦‚æœæ‚¨æœ‰ç¦ç”¨çš„ä»¤ç‰Œï¼Œå¯ä»¥ä½¿ç”¨è„šæœ¬<a href="https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1"><strong>EnableAllTokenPrivs.ps1</strong></a>æ¥å¯ç”¨æ‰€æœ‰ä»¤ç‰Œï¼š</p>
<pre><code class="language-powershell">.\EnableAllTokenPrivs.ps1
whoami /priv
</code></pre>
<p>æˆ–åµŒå…¥åœ¨è¿™ä¸ª<a href="https://www.leeholmes.com/adjusting-token-privileges-in-powershell/"><strong>å¸–å­</strong></a>ä¸­çš„<strong>è„šæœ¬</strong>ã€‚</p>
<h2 id="è¡¨æ ¼"><a class="header" href="#è¡¨æ ¼">è¡¨æ ¼</a></h2>
<p>å®Œæ•´çš„ä»¤ç‰Œæƒé™å¤‡å¿˜å•åœ¨<a href="https://github.com/gtworek/Priv2Admin">https://github.com/gtworek/Priv2Admin</a>ï¼Œä¸‹é¢çš„æ‘˜è¦å°†ä»…åˆ—å‡ºç›´æ¥åˆ©ç”¨è¯¥æƒé™ä»¥è·å¾—ç®¡ç†å‘˜ä¼šè¯æˆ–è¯»å–æ•æ„Ÿæ–‡ä»¶çš„æ–¹æ³•ã€‚</p>
<div class="table-wrapper"><table><thead><tr><th>æƒé™</th><th>å½±å“</th><th>å·¥å…·</th><th>æ‰§è¡Œè·¯å¾„</th><th>å¤‡æ³¨</th></tr></thead><tbody>
<tr><td><strong><code>SeAssignPrimaryToken</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td>ç¬¬ä¸‰æ–¹å·¥å…·</td><td><em>"è¿™å°†å…è®¸ç”¨æˆ·æ¨¡æ‹Ÿä»¤ç‰Œå¹¶ä½¿ç”¨è¯¸å¦‚potato.exeã€rottenpotato.exeå’Œjuicypotato.exeç­‰å·¥å…·æå‡åˆ°ntç³»ç»Ÿ"</em></td><td>æ„Ÿè°¢<a href="https://twitter.com/Defte_">AurÃ©lien Chalot</a>çš„æ›´æ–°ã€‚æˆ‘ä¼šå°½å¿«å°è¯•å°†å…¶é‡æ–°è¡¨è¿°ä¸ºæ›´åƒé£Ÿè°±çš„å†…å®¹ã€‚</td></tr>
<tr><td><strong><code>SeBackup</code></strong></td><td><strong>å¨èƒ</strong></td><td><em><strong>å†…ç½®å‘½ä»¤</strong></em></td><td>ä½¿ç”¨<code>robocopy /b</code>è¯»å–æ•æ„Ÿæ–‡ä»¶</td><td><p>- å¦‚æœæ‚¨å¯ä»¥è¯»å–%WINDIR%\MEMORY.DMPï¼Œå¯èƒ½ä¼šæ›´æœ‰è¶£<br><br>- <code>SeBackupPrivilege</code>ï¼ˆå’Œrobocopyï¼‰åœ¨æ‰“å¼€æ–‡ä»¶æ—¶æ²¡æœ‰å¸®åŠ©ã€‚<br><br>- Robocopyéœ€è¦åŒæ—¶å…·æœ‰SeBackupå’ŒSeRestoreæ‰èƒ½ä½¿ç”¨/bå‚æ•°ã€‚</p></td></tr>
<tr><td><strong><code>SeCreateToken</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td>ç¬¬ä¸‰æ–¹å·¥å…·</td><td>ä½¿ç”¨<code>NtCreateToken</code>åˆ›å»ºä»»æ„ä»¤ç‰Œï¼ŒåŒ…æ‹¬æœ¬åœ°ç®¡ç†å‘˜æƒé™ã€‚</td><td></td></tr>
<tr><td><strong><code>SeDebug</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td><strong>PowerShell</strong></td><td>å¤åˆ¶<code>lsass.exe</code>ä»¤ç‰Œã€‚</td><td>è„šæœ¬å¯ä»¥åœ¨<a href="https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Conjure-LSASS.ps1">FuzzySecurity</a>æ‰¾åˆ°</td></tr>
<tr><td><strong><code>SeLoadDriver</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td>ç¬¬ä¸‰æ–¹å·¥å…·</td><td><p>1. åŠ è½½æœ‰ç¼ºé™·çš„å†…æ ¸é©±åŠ¨ç¨‹åºï¼Œå¦‚<code>szkg64.sys</code><br>2. åˆ©ç”¨é©±åŠ¨ç¨‹åºæ¼æ´<br><br>æˆ–è€…ï¼Œè¯¥æƒé™å¯ç”¨äºå¸è½½ä¸å®‰å…¨ç›¸å…³çš„é©±åŠ¨ç¨‹åºï¼Œä½¿ç”¨<code>ftlMC</code>å†…ç½®å‘½ä»¤ã€‚å³ï¼š<code>fltMC sysmondrv</code></p></td><td><p>1. <code>szkg64</code>æ¼æ´è¢«åˆ—ä¸º<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-15732">CVE-2018-15732</a><br>2. <code>szkg64</code> <a href="https://www.greyhathacker.net/?p=1025">åˆ©ç”¨ä»£ç </a>ç”±<a href="https://twitter.com/parvezghh">Parvez Anwar</a>åˆ›å»º</p></td></tr>
<tr><td><strong><code>SeRestore</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td><strong>PowerShell</strong></td><td><p>1. å¯åŠ¨å…·æœ‰SeRestoreæƒé™çš„PowerShell/ISEã€‚<br>2. ä½¿ç”¨<a href="https://github.com/gtworek/PSBits/blob/master/Misc/EnableSeRestorePrivilege.ps1">Enable-SeRestorePrivilege</a>å¯ç”¨è¯¥æƒé™ã€‚<br>3. å°†utilman.exeé‡å‘½åä¸ºutilman.old<br>4. å°†cmd.exeé‡å‘½åä¸ºutilman.exe<br>5. é”å®šæ§åˆ¶å°å¹¶æŒ‰Win+U</p></td><td><p>æ”»å‡»å¯èƒ½ä¼šè¢«æŸäº›AVè½¯ä»¶æ£€æµ‹åˆ°ã€‚</p><p>æ›¿ä»£æ–¹æ³•ä¾èµ–äºä½¿ç”¨ç›¸åŒæƒé™æ›¿æ¢å­˜å‚¨åœ¨â€œProgram Filesâ€ä¸­çš„æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶</p></td></tr>
<tr><td><strong><code>SeTakeOwnership</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td><em><strong>å†…ç½®å‘½ä»¤</strong></em></td><td><p>1. <code>takeown.exe /f "%windir%\system32"</code><br>2. <code>icalcs.exe "%windir%\system32" /grant "%username%":F</code><br>3. å°†cmd.exeé‡å‘½åä¸ºutilman.exe<br>4. é”å®šæ§åˆ¶å°å¹¶æŒ‰Win+U</p></td><td><p>æ”»å‡»å¯èƒ½ä¼šè¢«æŸäº›AVè½¯ä»¶æ£€æµ‹åˆ°ã€‚</p><p>æ›¿ä»£æ–¹æ³•ä¾èµ–äºä½¿ç”¨ç›¸åŒæƒé™æ›¿æ¢å­˜å‚¨åœ¨â€œProgram Filesâ€ä¸­çš„æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p></td></tr>
<tr><td><strong><code>SeTcb</code></strong></td><td><em><strong>ç®¡ç†å‘˜</strong></em></td><td>ç¬¬ä¸‰æ–¹å·¥å…·</td><td><p>æ“çºµä»¤ç‰Œä»¥åŒ…å«æœ¬åœ°ç®¡ç†å‘˜æƒé™ã€‚å¯èƒ½éœ€è¦SeImpersonateã€‚</p><p>å¾…éªŒè¯ã€‚</p></td><td></td></tr>
</tbody></table>
</div>
<h2 id="å‚è€ƒ"><a class="header" href="#å‚è€ƒ">å‚è€ƒ</a></h2>
<ul>
<li>æŸ¥çœ‹å®šä¹‰Windowsä»¤ç‰Œçš„æ­¤è¡¨ï¼š <a href="https://github.com/gtworek/Priv2Admin">https://github.com/gtworek/Priv2Admin</a></li>
<li>æŸ¥çœ‹å…³äºä½¿ç”¨ä»¤ç‰Œè¿›è¡Œprivescçš„<a href="https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt"><strong>è¿™ç¯‡è®ºæ–‡</strong></a>ã€‚</li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒHackTricks</summary>
<ul>
<li>æŸ¥çœ‹<a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discordç¾¤ç»„</strong></a>æˆ–<a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a>æˆ–<strong>åœ¨Twitterä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>å’Œ<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> githubåº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../windows-hardening/windows-local-privilege-escalation/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/windows-local-privilege-escalation/access-tokens.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../windows-hardening/windows-local-privilege-escalation/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/windows-local-privilege-escalation/access-tokens.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
