<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS Apps - Inspecting, debugging and Fuzzing</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-åº”ç”¨---æ£€æŸ¥è°ƒè¯•å’Œæ¨¡ç³Šæµ‹è¯•"><a class="header" href="#macos-åº”ç”¨---æ£€æŸ¥è°ƒè¯•å’Œæ¨¡ç³Šæµ‹è¯•">macOS åº”ç”¨ - æ£€æŸ¥ã€è°ƒè¯•å’Œæ¨¡ç³Šæµ‹è¯•</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="é™æ€åˆ†æ"><a class="header" href="#é™æ€åˆ†æ">é™æ€åˆ†æ</a></h2>
<h3 id="otool--objdump--nm"><a class="header" href="#otool--objdump--nm">otool &amp; objdump &amp; nm</a></h3>
<pre><code class="language-bash">otool -L /bin/ls #List dynamically linked libraries
otool -tv /bin/ps #Decompile application
</code></pre>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">objdump -m --dylibs-used /bin/ls #List dynamically linked libraries
objdump -m -h /bin/ls # Get headers information
objdump -m --syms /bin/ls # Check if the symbol table exists to get function names
objdump -m --full-contents /bin/ls # Dump every section
objdump -d /bin/ls # Dissasemble the binary
objdump --disassemble-symbols=_hello --x86-asm-syntax=intel toolsdemo #Disassemble a function using intel flavour
</code></pre>
<p>{% endcode %}</p>
<pre><code class="language-bash">nm -m ./tccd # List of symbols
</code></pre>
<h3 id="jtool2--disarm"><a class="header" href="#jtool2--disarm">jtool2 &amp; Disarm</a></h3>
<p>æ‚¨å¯ä»¥<a href="https://newosxbook.com/tools/disarm.html"><strong>ä»è¿™é‡Œä¸‹è½½ disarm</strong></a>ã€‚</p>
<pre><code class="language-bash">ARCH=arm64e disarm -c -i -I --signature /path/bin # Get bin info and signature
ARCH=arm64e disarm -c -l /path/bin # Get binary sections
ARCH=arm64e disarm -c -L /path/bin # Get binary commands (dependencies included)
ARCH=arm64e disarm -c -S /path/bin # Get symbols (func names, strings...)
ARCH=arm64e disarm -c -d /path/bin # Get disasembled
jtool2 -d __DATA.__const myipc_server | grep MIG # Get MIG info
</code></pre>
<p>æ‚¨å¯ä»¥<a href="http://www.newosxbook.com/tools/jtool.html"><strong>åœ¨è¿™é‡Œä¸‹è½½ jtool2</strong></a>æˆ–ä½¿ç”¨ <code>brew</code> å®‰è£…å®ƒã€‚</p>
<pre><code class="language-bash"># Install
brew install --cask jtool2

jtool2 -l /bin/ls # Get commands (headers)
jtool2 -L /bin/ls # Get libraries
jtool2 -S /bin/ls # Get symbol info
jtool2 -d /bin/ls # Dump binary
jtool2 -D /bin/ls # Decompile binary

# Get signature information
ARCH=x86_64 jtool2 --sig /System/Applications/Automator.app/Contents/MacOS/Automator

# Get MIG information
jtool2 -d __DATA.__const myipc_server | grep MIG
</code></pre>
<p>{% hint style="danger" %}
<strong>jtool å·²è¢« disarm æ›¿ä»£</strong>
{% endhint %}</p>
<h3 id="ä»£ç ç­¾å--ldid"><a class="header" href="#ä»£ç ç­¾å--ldid">ä»£ç ç­¾å / ldid</a></h3>
<p>{% hint style="success" %}
<strong><code>Codesign</code></strong> å¯ä»¥åœ¨ <strong>macOS</strong> ä¸­æ‰¾åˆ°ï¼Œè€Œ <strong><code>ldid</code></strong> å¯ä»¥åœ¨ <strong>iOS</strong> ä¸­æ‰¾åˆ°
{% endhint %}</p>
<pre><code class="language-bash"># Get signer
codesign -vv -d /bin/ls 2&gt;&amp;1 | grep -E "Authority|TeamIdentifier"

# Check if the appâ€™s contents have been modified
codesign --verify --verbose /Applications/Safari.app

# Get entitlements from the binary
codesign -d --entitlements :- /System/Applications/Automator.app # Check the TCC perms

# Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app

# Sign a binary
codesign -s &lt;cert-name-keychain&gt; toolsdemo

# Get signature info
ldid -h &lt;binary&gt;

# Get entitlements
ldid -e &lt;binary&gt;

# Change entilements
## /tmp/entl.xml is a XML file with the new entitlements to add
ldid -S/tmp/entl.xml &lt;binary&gt;
</code></pre>
<h3 id="suspiciouspackage"><a class="header" href="#suspiciouspackage">SuspiciousPackage</a></h3>
<p><a href="https://mothersruin.com/software/SuspiciousPackage/get.html"><strong>SuspiciousPackage</strong></a> æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æ£€æŸ¥ <strong>.pkg</strong> æ–‡ä»¶ï¼ˆå®‰è£…ç¨‹åºï¼‰ï¼Œå¹¶åœ¨å®‰è£…ä¹‹å‰æŸ¥çœ‹å…¶å†…å®¹ã€‚<br />
è¿™äº›å®‰è£…ç¨‹åºé€šå¸¸å…·æœ‰ <code>preinstall</code> å’Œ <code>postinstall</code> bash è„šæœ¬ï¼Œæ¶æ„è½¯ä»¶ä½œè€…é€šå¸¸åˆ©ç”¨è¿™äº›è„šæœ¬æ¥ <strong>æŒä¹…åŒ–</strong> <strong>æ¶æ„è½¯ä»¶</strong>ã€‚</p>
<h3 id="hdiutil"><a class="header" href="#hdiutil">hdiutil</a></h3>
<p>æ­¤å·¥å…·å…è®¸ <strong>æŒ‚è½½</strong> Apple ç£ç›˜æ˜ åƒï¼ˆ<strong>.dmg</strong>ï¼‰æ–‡ä»¶ï¼Œä»¥ä¾¿åœ¨è¿è¡Œä»»ä½•å†…å®¹ä¹‹å‰è¿›è¡Œæ£€æŸ¥ï¼š</p>
<pre><code class="language-bash">hdiutil attach ~/Downloads/Firefox\ 58.0.2.dmg
</code></pre>
<p>It will be mounted in <code>/Volumes</code></p>
<h3 id="packed-binaries"><a class="header" href="#packed-binaries">Packed binaries</a></h3>
<ul>
<li>æ£€æŸ¥é«˜ç†µ</li>
<li>æ£€æŸ¥å­—ç¬¦ä¸²ï¼ˆå‡ ä¹æ²¡æœ‰å¯ç†è§£çš„å­—ç¬¦ä¸²ï¼Œå·²æ‰“åŒ…ï¼‰</li>
<li>MacOS çš„ UPX æ‰“åŒ…å™¨ç”Ÿæˆä¸€ä¸ªåä¸º "__XHDR" çš„éƒ¨åˆ†</li>
</ul>
<h2 id="static-objective-c-analysis"><a class="header" href="#static-objective-c-analysis">Static Objective-C analysis</a></h2>
<h3 id="metadata"><a class="header" href="#metadata">Metadata</a></h3>
<p>{% hint style="danger" %}
æ³¨æ„ï¼Œç”¨ Objective-C ç¼–å†™çš„ç¨‹åºåœ¨ç¼–è¯‘æˆ <a href="../macos-files-folders-and-binaries/universal-binaries-and-mach-o-format.html">Mach-O binaries</a> æ—¶ <strong>ä¿ç•™</strong> å…¶ç±»å£°æ˜ã€‚è¿™æ ·çš„ç±»å£°æ˜ <strong>åŒ…æ‹¬</strong>ï¼š
{% endhint %}</p>
<ul>
<li>å®šä¹‰çš„æ¥å£</li>
<li>æ¥å£æ–¹æ³•</li>
<li>æ¥å£å®ä¾‹å˜é‡</li>
<li>å®šä¹‰çš„åè®®</li>
</ul>
<p>æ³¨æ„ï¼Œè¿™äº›åç§°å¯èƒ½ä¼šè¢«æ··æ·†ï¼Œä»¥ä½¿äºŒè¿›åˆ¶æ–‡ä»¶çš„é€†å‘å·¥ç¨‹æ›´åŠ å›°éš¾ã€‚</p>
<h3 id="function-calling"><a class="header" href="#function-calling">Function calling</a></h3>
<p>å½“åœ¨ä½¿ç”¨ Objective-C çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œç¼–è¯‘åçš„ä»£ç ä¸ä¼šç›´æ¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œè€Œæ˜¯ä¼šè°ƒç”¨ <strong><code>objc_msgSend</code></strong>ã€‚è¿™å°†è°ƒç”¨æœ€ç»ˆçš„å‡½æ•°ï¼š</p>
<p><img src="../../../.gitbook/assets/image%20(305).png" alt="" /></p>
<p>æ­¤å‡½æ•°æœŸæœ›çš„å‚æ•°ä¸ºï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•° (<strong>self</strong>) æ˜¯â€œæŒ‡å‘ <strong>æ¥æ”¶æ¶ˆæ¯çš„ç±»å®ä¾‹çš„æŒ‡é’ˆ</strong>â€ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ­£åœ¨è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡ã€‚å¦‚æœè¯¥æ–¹æ³•æ˜¯ç±»æ–¹æ³•ï¼Œåˆ™è¿™æ˜¯ç±»å¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ï¼ˆæ•´ä½“ï¼‰ï¼Œè€Œå¯¹äºå®ä¾‹æ–¹æ³•ï¼Œself å°†æŒ‡å‘ç±»çš„ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ã€‚</li>
<li>ç¬¬äºŒä¸ªå‚æ•° (<strong>op</strong>) æ˜¯â€œå¤„ç†æ¶ˆæ¯çš„æ–¹æ³•é€‰æ‹©å™¨â€ã€‚åŒæ ·ï¼Œç®€å•æ¥è¯´ï¼Œè¿™åªæ˜¯ <strong>æ–¹æ³•çš„åç§°</strong>ã€‚</li>
<li>å‰©ä½™çš„å‚æ•°æ˜¯æ–¹æ³•æ‰€éœ€çš„ä»»ä½• <strong>å€¼</strong>ï¼ˆopï¼‰ã€‚</li>
</ul>
<p>è¯·å‚è§å¦‚ä½•åœ¨æ­¤é¡µé¢ä¸­ <strong>ä½¿ç”¨ <code>lldb</code> åœ¨ ARM64 ä¸­è½»æ¾è·å–æ­¤ä¿¡æ¯</strong>ï¼š</p>
<p>{% content-ref url="arm64-basic-assembly.md" %}
<a href="arm64-basic-assembly.html">arm64-basic-assembly.md</a>
{% endcontent-ref %}</p>
<p>x64:</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Argument</strong></th><th><strong>Register</strong></th><th><strong>(for) objc_msgSend</strong></th></tr></thead><tbody>
<tr><td><strong>1st argument</strong></td><td><strong>rdi</strong></td><td><strong>self: object that the method is being invoked upon</strong></td></tr>
<tr><td><strong>2nd argument</strong></td><td><strong>rsi</strong></td><td><strong>op: name of the method</strong></td></tr>
<tr><td><strong>3rd argument</strong></td><td><strong>rdx</strong></td><td><strong>1st argument to the method</strong></td></tr>
<tr><td><strong>4th argument</strong></td><td><strong>rcx</strong></td><td><strong>2nd argument to the method</strong></td></tr>
<tr><td><strong>5th argument</strong></td><td><strong>r8</strong></td><td><strong>3rd argument to the method</strong></td></tr>
<tr><td><strong>6th argument</strong></td><td><strong>r9</strong></td><td><strong>4th argument to the method</strong></td></tr>
<tr><td><strong>7th+ argument</strong></td><td><p><strong>rsp+</strong><br><strong>(on the stack)</strong></p></td><td><strong>5th+ argument to the method</strong></td></tr>
</tbody></table>
</div>
<h3 id="dump-objectivec-metadata"><a class="header" href="#dump-objectivec-metadata">Dump ObjectiveC metadata</a></h3>
<h3 id="dynadump"><a class="header" href="#dynadump">Dynadump</a></h3>
<p><a href="https://github.com/DerekSelander/dynadump"><strong>Dynadump</strong></a> æ˜¯ä¸€ä¸ªç”¨äºç±»è½¬å‚¨ Objective-C äºŒè¿›åˆ¶æ–‡ä»¶çš„å·¥å…·ã€‚GitHub æŒ‡å®šäº† dylibsï¼Œä½†è¿™ä¹Ÿé€‚ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<pre><code class="language-bash">./dynadump dump /path/to/bin
</code></pre>
<p>åœ¨æ’°å†™æ—¶ï¼Œè¿™æ˜¯<strong>ç›®å‰æ•ˆæœæœ€å¥½çš„</strong>ã€‚</p>
<h4 id="å¸¸è§„å·¥å…·"><a class="header" href="#å¸¸è§„å·¥å…·">å¸¸è§„å·¥å…·</a></h4>
<pre><code class="language-bash">nm --dyldinfo-only /path/to/bin
otool -ov /path/to/bin
objdump --macho --objc-meta-data /path/to/bin
</code></pre>
<h4 id="class-dump"><a class="header" href="#class-dump">class-dump</a></h4>
<p><a href="https://github.com/nygard/class-dump/"><strong>class-dump</strong></a> æ˜¯ä¸€ä¸ªåŸå§‹å·¥å…·ï¼Œç”¨äºç”Ÿæˆ ObjetiveC æ ¼å¼ä»£ç ä¸­çš„ç±»ã€ç±»åˆ«å’Œåè®®çš„å£°æ˜ã€‚</p>
<p>å®ƒå¾ˆæ—§ä¸”æœªç»´æŠ¤ï¼Œå› æ­¤å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
<h4 id="icdump"><a class="header" href="#icdump">ICDump</a></h4>
<p><a href="https://github.com/romainthomas/iCDump"><strong>iCDump</strong></a> æ˜¯ä¸€ä¸ªç°ä»£çš„è·¨å¹³å° Objective-C ç±»è½¬å‚¨å·¥å…·ã€‚ä¸ç°æœ‰å·¥å…·ç›¸æ¯”ï¼ŒiCDump å¯ä»¥ç‹¬ç«‹äº Apple ç”Ÿæ€ç³»ç»Ÿè¿è¡Œï¼Œå¹¶ä¸”å®ƒæä¾›äº† Python ç»‘å®šã€‚</p>
<pre><code class="language-python">import icdump
metadata = icdump.objc.parse("/path/to/bin")

print(metadata.to_decl())
</code></pre>
<h2 id="é™æ€-swift-åˆ†æ"><a class="header" href="#é™æ€-swift-åˆ†æ">é™æ€ Swift åˆ†æ</a></h2>
<p>å¯¹äº Swift äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”±äºä¸ Objective-C çš„å…¼å®¹æ€§ï¼Œæœ‰æ—¶å¯ä»¥ä½¿ç”¨ <a href="https://github.com/nygard/class-dump/">class-dump</a> æå–å£°æ˜ï¼Œä½†å¹¶ä¸æ€»æ˜¯å¦‚æ­¤ã€‚</p>
<p>ä½¿ç”¨ <strong><code>jtool -l</code></strong> æˆ– <strong><code>otool -l</code></strong> å‘½ä»¤è¡Œï¼Œå¯ä»¥æ‰¾åˆ°å¤šä¸ªä»¥ <strong><code>__swift5</code></strong> å‰ç¼€å¼€å¤´çš„éƒ¨åˆ†ï¼š</p>
<pre><code class="language-bash">jtool2 -l /Applications/Stocks.app/Contents/MacOS/Stocks
LC 00: LC_SEGMENT_64              Mem: 0x000000000-0x100000000    __PAGEZERO
LC 01: LC_SEGMENT_64              Mem: 0x100000000-0x100028000    __TEXT
[...]
Mem: 0x100026630-0x100026d54        __TEXT.__swift5_typeref
Mem: 0x100026d60-0x100027061        __TEXT.__swift5_reflstr
Mem: 0x100027064-0x1000274cc        __TEXT.__swift5_fieldmd
Mem: 0x1000274cc-0x100027608        __TEXT.__swift5_capture
[...]
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨<a href="https://knight.sc/reverse%20engineering/2019/07/17/swift-metadata.html"><strong>è¿™ç¯‡åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°å…³äºè¿™äº›éƒ¨åˆ†å­˜å‚¨çš„ä¿¡æ¯</strong></a>çš„æ›´å¤šä¿¡æ¯ã€‚</p>
<p>æ­¤å¤–ï¼Œ<strong>Swift äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½åŒ…å«ç¬¦å·</strong>ï¼ˆä¾‹å¦‚ï¼Œåº“éœ€è¦å­˜å‚¨ç¬¦å·ä»¥ä¾¿å…¶å‡½æ•°å¯ä»¥è¢«è°ƒç”¨ï¼‰ã€‚<strong>ç¬¦å·é€šå¸¸ä»¥ä¸‘é™‹çš„æ–¹å¼åŒ…å«å‡½æ•°åç§°å’Œå±æ€§çš„ä¿¡æ¯</strong>ï¼Œå› æ­¤å®ƒä»¬éå¸¸æœ‰ç”¨ï¼Œå¹¶ä¸”æœ‰â€œ<strong>å»æ··æ·†å™¨</strong>â€å¯ä»¥è·å–åŸå§‹åç§°ï¼š</p>
<pre><code class="language-bash"># Ghidra plugin
https://github.com/ghidraninja/ghidra_scripts/blob/master/swift_demangler.py

# Swift cli
swift demangle
</code></pre>
<h2 id="åŠ¨æ€åˆ†æ"><a class="header" href="#åŠ¨æ€åˆ†æ">åŠ¨æ€åˆ†æ</a></h2>
<p>{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†è°ƒè¯•äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<strong>éœ€è¦ç¦ç”¨ SIP</strong>ï¼ˆ<code>csrutil disable</code> æˆ– <code>csrutil enable --without debug</code>ï¼‰ï¼Œæˆ–è€…å°†äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹å¹¶<strong>ç§»é™¤ç­¾å</strong>ï¼ˆä½¿ç”¨ <code>codesign --remove-signature &lt;binary-path&gt;</code>ï¼‰ï¼Œæˆ–è€…å…è®¸è°ƒè¯•è¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://gist.github.com/carlospolop/a66b8d72bb8f43913c4b5ae45672578b">è¿™ä¸ªè„šæœ¬</a>ï¼‰ã€‚
{% endhint %}</p>
<p>{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†åœ¨ macOS ä¸Š<strong>æ’æ¡©ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶</strong>ï¼ˆä¾‹å¦‚ <code>cloudconfigurationd</code>ï¼‰ï¼Œ<strong>å¿…é¡»ç¦ç”¨ SIP</strong>ï¼ˆä»…ç§»é™¤ç­¾åæ˜¯æ— æ•ˆçš„ï¼‰ã€‚
{% endhint %}</p>
<h3 id="apis"><a class="header" href="#apis">APIs</a></h3>
<p>macOS æš´éœ²äº†ä¸€äº›æœ‰è¶£çš„ APIï¼Œæä¾›æœ‰å…³è¿›ç¨‹çš„ä¿¡æ¯ï¼š</p>
<ul>
<li><code>proc_info</code>ï¼šè¿™æ˜¯ä¸»è¦çš„ APIï¼Œæä¾›æœ‰å…³æ¯ä¸ªè¿›ç¨‹çš„å¤§é‡ä¿¡æ¯ã€‚æ‚¨éœ€è¦ä»¥ root èº«ä»½è·å–å…¶ä»–è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä½†ä¸éœ€è¦ç‰¹æ®Šçš„æƒé™æˆ– mach ç«¯å£ã€‚</li>
<li><code>libsysmon.dylib</code>ï¼šå®ƒå…è®¸é€šè¿‡ XPC æš´éœ²çš„å‡½æ•°è·å–æœ‰å…³è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä½†éœ€è¦å…·æœ‰ <code>com.apple.sysmond.client</code> æƒé™ã€‚</li>
</ul>
<h3 id="stackshot--microstackshots"><a class="header" href="#stackshot--microstackshots">Stackshot &amp; microstackshots</a></h3>
<p><strong>Stackshotting</strong> æ˜¯ä¸€ç§ç”¨äºæ•è·è¿›ç¨‹çŠ¶æ€çš„æŠ€æœ¯ï¼ŒåŒ…æ‹¬æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„è°ƒç”¨æ ˆã€‚è¿™å¯¹äºè°ƒè¯•ã€æ€§èƒ½åˆ†æä»¥åŠåœ¨ç‰¹å®šæ—¶é—´ç‚¹ç†è§£ç³»ç»Ÿè¡Œä¸ºç‰¹åˆ«æœ‰ç”¨ã€‚åœ¨ iOS å’Œ macOS ä¸Šï¼Œå¯ä»¥ä½¿ç”¨å¤šç§å·¥å…·å’Œæ–¹æ³•è¿›è¡Œ stackshottingï¼Œä¾‹å¦‚å·¥å…· <strong><code>sample</code></strong> å’Œ <strong><code>spindump</code></strong>ã€‚</p>
<h3 id="sysdiagnose"><a class="header" href="#sysdiagnose">Sysdiagnose</a></h3>
<p>è¯¥å·¥å…·ï¼ˆ<code>/usr/bini/ysdiagnose</code>ï¼‰åŸºæœ¬ä¸Šä»æ‚¨çš„è®¡ç®—æœºæ”¶é›†å¤§é‡ä¿¡æ¯ï¼Œæ‰§è¡Œæ•°åä¸ªä¸åŒçš„å‘½ä»¤ï¼Œä¾‹å¦‚ <code>ps</code>ã€<code>zprint</code>...</p>
<p>å®ƒå¿…é¡»ä»¥ <strong>root</strong> èº«ä»½è¿è¡Œï¼Œå®ˆæŠ¤è¿›ç¨‹ <code>/usr/libexec/sysdiagnosed</code> å…·æœ‰éå¸¸æœ‰è¶£çš„æƒé™ï¼Œä¾‹å¦‚ <code>com.apple.system-task-ports</code> å’Œ <code>get-task-allow</code>ã€‚</p>
<p>å…¶ plist ä½äº <code>/System/Library/LaunchDaemons/com.apple.sysdiagnose.plist</code>ï¼Œå£°æ˜äº† 3 ä¸ª MachServicesï¼š</p>
<ul>
<li><code>com.apple.sysdiagnose.CacheDelete</code>ï¼šåˆ é™¤ /var/rmp ä¸­çš„æ—§æ¡£æ¡ˆ</li>
<li><code>com.apple.sysdiagnose.kernel.ipc</code>ï¼šç‰¹æ®Šç«¯å£ 23ï¼ˆå†…æ ¸ï¼‰</li>
<li><code>com.apple.sysdiagnose.service.xpc</code>ï¼šé€šè¿‡ <code>Libsysdiagnose</code> Obj-C ç±»çš„ç”¨æˆ·æ¨¡å¼æ¥å£ã€‚å¯ä»¥åœ¨å­—å…¸ä¸­ä¼ é€’ä¸‰ä¸ªå‚æ•°ï¼ˆ<code>compress</code>ã€<code>display</code>ã€<code>run</code>ï¼‰</li>
</ul>
<h3 id="ç»Ÿä¸€æ—¥å¿—"><a class="header" href="#ç»Ÿä¸€æ—¥å¿—">ç»Ÿä¸€æ—¥å¿—</a></h3>
<p>MacOS ç”Ÿæˆå¤§é‡æ—¥å¿—ï¼Œè¿™åœ¨è¿è¡Œåº”ç”¨ç¨‹åºæ—¶å°è¯•ç†è§£<strong>å®ƒåœ¨åšä»€ä¹ˆ</strong>æ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<p>æ­¤å¤–ï¼Œæœ‰ä¸€äº›æ—¥å¿—å°†åŒ…å«æ ‡ç­¾ <code>&lt;private&gt;</code> ä»¥<strong>éšè—</strong>æŸäº›<strong>ç”¨æˆ·</strong>æˆ–<strong>è®¡ç®—æœº</strong>çš„<strong>å¯è¯†åˆ«</strong>ä¿¡æ¯ã€‚ç„¶è€Œï¼Œå¯ä»¥<strong>å®‰è£…è¯ä¹¦ä»¥æŠ«éœ²æ­¤ä¿¡æ¯</strong>ã€‚è¯·æŒ‰ç…§ <a href="https://superuser.com/questions/1532031/how-to-show-private-data-in-macos-unified-log"><strong>è¿™é‡Œ</strong></a> çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚</p>
<h3 id="hopper"><a class="header" href="#hopper">Hopper</a></h3>
<h4 id="å·¦ä¾§é¢æ¿"><a class="header" href="#å·¦ä¾§é¢æ¿">å·¦ä¾§é¢æ¿</a></h4>
<p>åœ¨ Hopper çš„å·¦ä¾§é¢æ¿ä¸­ï¼Œå¯ä»¥çœ‹åˆ°äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·ï¼ˆ<strong>æ ‡ç­¾</strong>ï¼‰ã€è¿‡ç¨‹å’Œå‡½æ•°çš„åˆ—è¡¨ï¼ˆ<strong>Proc</strong>ï¼‰ä»¥åŠå­—ç¬¦ä¸²ï¼ˆ<strong>Str</strong>ï¼‰ã€‚è¿™äº›å¹¶ä¸æ˜¯æ‰€æœ‰å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å®šä¹‰åœ¨ Mac-O æ–‡ä»¶çš„å¤šä¸ªéƒ¨åˆ†ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ <em>cstring æˆ–</em> <code>objc_methname</code>ï¼‰ã€‚</p>
<h4 id="ä¸­é—´é¢æ¿"><a class="header" href="#ä¸­é—´é¢æ¿">ä¸­é—´é¢æ¿</a></h4>
<p>åœ¨ä¸­é—´é¢æ¿ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°<strong>åæ±‡ç¼–ä»£ç </strong>ã€‚æ‚¨å¯ä»¥é€šè¿‡å•å‡»ç›¸åº”çš„å›¾æ ‡æŸ¥çœ‹<strong>åŸå§‹</strong>åæ±‡ç¼–ã€<strong>å›¾å½¢</strong>ã€<strong>åç¼–è¯‘</strong>å’Œ<strong>äºŒè¿›åˆ¶</strong>ï¼š</p>
<figure><img src="../../../.gitbook/assets/image (343).png" alt=""><figcaption></figcaption></figure>
<p>å³é”®å•å‡»ä»£ç å¯¹è±¡ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹<strong>å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨</strong>æˆ–ç”šè‡³æ›´æ”¹å…¶åç§°ï¼ˆè¿™åœ¨åç¼–è¯‘çš„ä¼ªä»£ç ä¸­æ— æ•ˆï¼‰ï¼š</p>
<figure><img src="../../../.gitbook/assets/image (1117).png" alt=""><figcaption></figcaption></figure>
<p>æ­¤å¤–ï¼Œåœ¨<strong>ä¸­é—´ä¸‹æ–¹ï¼Œæ‚¨å¯ä»¥ç¼–å†™ Python å‘½ä»¤</strong>ã€‚</p>
<h4 id="å³ä¾§é¢æ¿"><a class="header" href="#å³ä¾§é¢æ¿">å³ä¾§é¢æ¿</a></h4>
<p>åœ¨å³ä¾§é¢æ¿ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æœ‰è¶£çš„ä¿¡æ¯ï¼Œä¾‹å¦‚<strong>å¯¼èˆªå†å²</strong>ï¼ˆä»¥ä¾¿æ‚¨çŸ¥é“å¦‚ä½•åˆ°è¾¾å½“å‰æƒ…å†µï¼‰ã€<strong>è°ƒç”¨å›¾</strong>ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ‰€æœ‰<strong>è°ƒç”¨æ­¤å‡½æ•°çš„å‡½æ•°</strong>ä»¥åŠæ‰€æœ‰<strong>æ­¤å‡½æ•°è°ƒç”¨çš„å‡½æ•°</strong>ï¼Œä»¥åŠ<strong>å±€éƒ¨å˜é‡</strong>ä¿¡æ¯ã€‚</p>
<h3 id="dtrace"><a class="header" href="#dtrace">dtrace</a></h3>
<p>å®ƒå…è®¸ç”¨æˆ·ä»¥æä½çš„<strong>çº§åˆ«</strong>è®¿é—®åº”ç”¨ç¨‹åºï¼Œå¹¶æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œè®©ç”¨æˆ·å¯ä»¥<strong>è·Ÿè¸ª</strong> <strong>ç¨‹åº</strong>ï¼Œç”šè‡³æ›´æ”¹å…¶æ‰§è¡Œæµç¨‹ã€‚Dtrace ä½¿ç”¨<strong>æ¢é’ˆ</strong>ï¼Œè¿™äº›æ¢é’ˆ<strong>åˆ†å¸ƒåœ¨å†…æ ¸ä¸­</strong>ï¼Œä½äºç³»ç»Ÿè°ƒç”¨çš„å¼€å§‹å’Œç»“æŸä½ç½®ã€‚</p>
<p>DTrace ä½¿ç”¨ <strong><code>dtrace_probe_create</code></strong> å‡½æ•°ä¸ºæ¯ä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ¢é’ˆã€‚è¿™äº›æ¢é’ˆå¯ä»¥åœ¨æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„<strong>å…¥å£å’Œå‡ºå£</strong>è§¦å‘ã€‚ä¸ DTrace çš„äº¤äº’é€šè¿‡ /dev/dtrace è¿›è¡Œï¼Œè¯¥æ¥å£ä»…å¯¹ root ç”¨æˆ·å¯ç”¨ã€‚</p>
<p>{% hint style="success" %}
è¦åœ¨ä¸å®Œå…¨ç¦ç”¨ SIP ä¿æŠ¤çš„æƒ…å†µä¸‹å¯ç”¨ Dtraceï¼Œæ‚¨å¯ä»¥åœ¨æ¢å¤æ¨¡å¼ä¸‹æ‰§è¡Œï¼š<code>csrutil enable --without dtrace</code></p>
<p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ‚¨<strong>ç¼–è¯‘çš„</strong> <strong><code>dtrace</code></strong> æˆ– <strong><code>dtruss</code></strong> äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
{% endhint %}</p>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å– dtrace çš„å¯ç”¨æ¢é’ˆï¼š</p>
<pre><code class="language-bash">dtrace -l | head
ID   PROVIDER            MODULE                          FUNCTION NAME
1     dtrace                                                     BEGIN
2     dtrace                                                     END
3     dtrace                                                     ERROR
43    profile                                                     profile-97
44    profile                                                     profile-199
</code></pre>
<p>æ¢é’ˆåç§°ç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼šæä¾›è€…ã€æ¨¡å—ã€å‡½æ•°å’Œåç§°ï¼ˆ<code>fbt:mach_kernel:ptrace:entry</code>ï¼‰ã€‚å¦‚æœæ‚¨æ²¡æœ‰æŒ‡å®šåç§°çš„æŸä¸ªéƒ¨åˆ†ï¼ŒDtrace å°†å°†è¯¥éƒ¨åˆ†åº”ç”¨ä¸ºé€šé…ç¬¦ã€‚</p>
<p>è¦é…ç½® DTrace ä»¥æ¿€æ´»æ¢é’ˆå¹¶æŒ‡å®šè§¦å‘æ—¶è¦æ‰§è¡Œçš„æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ D è¯­è¨€ã€‚</p>
<p>æ›´è¯¦ç»†çš„è§£é‡Šå’Œæ›´å¤šç¤ºä¾‹å¯ä»¥åœ¨ <a href="https://illumos.org/books/dtrace/chp-intro.html">https://illumos.org/books/dtrace/chp-intro.html</a> ä¸­æ‰¾åˆ°ã€‚</p>
<h4 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h4>
<p>è¿è¡Œ <code>man -k dtrace</code> åˆ—å‡º <strong>å¯ç”¨çš„ DTrace è„šæœ¬</strong>ã€‚ç¤ºä¾‹ï¼š<code>sudo dtruss -n binary</code></p>
<pre><code class="language-bash">#Count the number of syscalls of each running process
sudo dtrace -n 'syscall:::entry {@[execname] = count()}'
</code></pre>
<ul>
<li>è„šæœ¬</li>
</ul>
<pre><code class="language-bash">syscall:::entry
/pid == $1/
{
}

#Log every syscall of a PID
sudo dtrace -s script.d 1234
</code></pre>
<pre><code class="language-bash">syscall::open:entry
{
printf("%s(%s)", probefunc, copyinstr(arg0));
}
syscall::close:entry
{
printf("%s(%d)\n", probefunc, arg0);
}

#Log files opened and closed by a process
sudo dtrace -s b.d -c "cat /etc/hosts"
</code></pre>
<pre><code class="language-bash">syscall:::entry
{
;
}
syscall:::return
{
printf("=%d\n", arg1);
}

#Log sys calls with values
sudo dtrace -s syscalls_info.d -c "cat /etc/hosts"
</code></pre>
<h3 id="dtruss"><a class="header" href="#dtruss">dtruss</a></h3>
<pre><code class="language-bash">dtruss -c ls #Get syscalls of ls
dtruss -c -p 1000 #get syscalls of PID 1000
</code></pre>
<h3 id="kdebug"><a class="header" href="#kdebug">kdebug</a></h3>
<p>è¿™æ˜¯ä¸€ä¸ªå†…æ ¸è·Ÿè¸ªå·¥å…·ã€‚æ–‡æ¡£ä»£ç å¯ä»¥åœ¨ <strong><code>/usr/share/misc/trace.codes</code></strong> ä¸­æ‰¾åˆ°ã€‚</p>
<p>åƒ <code>latency</code>ã€<code>sc_usage</code>ã€<code>fs_usage</code> å’Œ <code>trace</code> è¿™æ ·çš„å·¥å…·åœ¨å†…éƒ¨ä½¿ç”¨å®ƒã€‚</p>
<p>è¦ä¸ <code>kdebug</code> è¿›è¡Œæ¥å£ï¼Œä½¿ç”¨ <code>sysctl</code> é€šè¿‡ <code>kern.kdebug</code> å‘½åç©ºé—´ï¼Œä½¿ç”¨çš„ MIB å¯ä»¥åœ¨ <code>sys/sysctl.h</code> ä¸­æ‰¾åˆ°ï¼Œç›¸å…³å‡½æ•°åœ¨ <code>bsd/kern/kdebug.c</code> ä¸­å®ç°ã€‚</p>
<p>ä¸ kdebug è¿›è¡Œäº¤äº’çš„è‡ªå®šä¹‰å®¢æˆ·ç«¯é€šå¸¸éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>ä½¿ç”¨ KERN_KDSETREMOVE ç§»é™¤ç°æœ‰è®¾ç½®</li>
<li>ä½¿ç”¨ KERN_KDSETBUF å’Œ KERN_KDSETUP è®¾ç½®è·Ÿè¸ª</li>
<li>ä½¿ç”¨ KERN_KDGETBUF è·å–ç¼“å†²åŒºæ¡ç›®æ•°é‡</li>
<li>ä½¿ç”¨ KERN_KDPINDEX ä»è·Ÿè¸ªä¸­è·å–è‡ªå·±çš„å®¢æˆ·ç«¯</li>
<li>ä½¿ç”¨ KERN_KDENABLE å¯ç”¨è·Ÿè¸ª</li>
<li>è°ƒç”¨ KERN_KDREADTR è¯»å–ç¼“å†²åŒº</li>
<li>è¦å°†æ¯ä¸ªçº¿ç¨‹ä¸å…¶è¿›ç¨‹åŒ¹é…ï¼Œè°ƒç”¨ KERN_KDTHRMAPã€‚</li>
</ul>
<p>ä¸ºäº†è·å–è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ Apple å·¥å…· <strong><code>trace</code></strong> æˆ–è‡ªå®šä¹‰å·¥å…· <a href="https://newosxbook.com/tools/kdv.html">kDebugView (kdv)</a><strong>ã€‚</strong></p>
<p><strong>è¯·æ³¨æ„ï¼ŒKdebug ä¸€æ¬¡åªèƒ½ä¸ºä¸€ä¸ªå®¢æˆ·æä¾›æœåŠ¡ã€‚</strong> å› æ­¤ï¼Œåªæœ‰ä¸€ä¸ª k-debug é©±åŠ¨çš„å·¥å…·å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚</p>
<h3 id="ktrace"><a class="header" href="#ktrace">ktrace</a></h3>
<p><code>ktrace_*</code> API æ¥è‡ª <code>libktrace.dylib</code>ï¼Œå®ƒå°è£…äº† <code>Kdebug</code> çš„ APIã€‚ç„¶åï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è°ƒç”¨ <code>ktrace_session_create</code> å’Œ <code>ktrace_events_[single/class]</code> åœ¨ç‰¹å®šä»£ç ä¸Šè®¾ç½®å›è°ƒï¼Œç„¶åä½¿ç”¨ <code>ktrace_start</code> å¯åŠ¨å®ƒã€‚</p>
<p>å³ä½¿åœ¨ <strong>SIP æ¿€æ´»</strong> çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨å®ç”¨ç¨‹åº <code>ktrace</code> ä½œä¸ºå®¢æˆ·ç«¯ï¼š</p>
<pre><code class="language-bash">ktrace trace -s -S -t c -c ls | grep "ls("
</code></pre>
<p>Or <code>tailspin</code>.</p>
<h3 id="kperf"><a class="header" href="#kperf">kperf</a></h3>
<p>è¿™ç”¨äºè¿›è¡Œå†…æ ¸çº§åˆ«çš„æ€§èƒ½åˆ†æï¼Œå¹¶ä¸”æ˜¯ä½¿ç”¨ <code>Kdebug</code> è°ƒç”¨æ„å»ºçš„ã€‚</p>
<p>åŸºæœ¬ä¸Šï¼Œæ£€æŸ¥å…¨å±€å˜é‡ <code>kernel_debug_active</code>ï¼Œå¦‚æœè®¾ç½®äº†å®ƒï¼Œåˆ™è°ƒç”¨ <code>kperf_kdebug_handler</code>ï¼Œå¹¶ä¼ å…¥ <code>Kdebug</code> ä»£ç å’Œè°ƒç”¨çš„å†…æ ¸å¸§åœ°å€ã€‚å¦‚æœ <code>Kdebug</code> ä»£ç ä¸æ‰€é€‰çš„åŒ¹é…ï¼Œåˆ™è·å–é…ç½®ä¸ºä½å›¾çš„â€œæ“ä½œâ€ï¼ˆè¯·æŸ¥çœ‹ <code>osfmk/kperf/action.h</code> ä»¥è·å–é€‰é¡¹ï¼‰ã€‚</p>
<p>Kperf è¿˜æœ‰ä¸€ä¸ª sysctl MIB è¡¨ï¼š (ä½œä¸º root) <code>sysctl kperf</code>ã€‚è¿™äº›ä»£ç å¯ä»¥åœ¨ <code>osfmk/kperf/kperfbsd.c</code> ä¸­æ‰¾åˆ°ã€‚</p>
<p>æ­¤å¤–ï¼ŒKperf çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ä½äº <code>kpc</code> ä¸­ï¼Œå®ƒæä¾›æœ‰å…³æœºå™¨æ€§èƒ½è®¡æ•°å™¨çš„ä¿¡æ¯ã€‚</p>
<h3 id="processmonitor"><a class="header" href="#processmonitor">ProcessMonitor</a></h3>
<p><a href="https://objective-see.com/products/utilities.html#ProcessMonitor"><strong>ProcessMonitor</strong></a> æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œç”¨äºæ£€æŸ¥è¿›ç¨‹ç›¸å…³çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œç›‘è§†ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨åˆ›å»ºå“ªäº›æ–°è¿›ç¨‹ï¼‰ã€‚</p>
<h3 id="spritetree"><a class="header" href="#spritetree">SpriteTree</a></h3>
<p><a href="https://themittenmac.com/tools/"><strong>SpriteTree</strong></a> æ˜¯ä¸€ä¸ªæ‰“å°è¿›ç¨‹ä¹‹é—´å…³ç³»çš„å·¥å…·ã€‚<br />
æ‚¨éœ€è¦ä½¿ç”¨ç±»ä¼¼ <strong><code>sudo eslogger fork exec rename create &gt; cap.json</code></strong> çš„å‘½ä»¤ç›‘è§†æ‚¨çš„ Macï¼ˆå¯åŠ¨æ­¤ç»ˆç«¯éœ€è¦ FDAï¼‰ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å·¥å…·ä¸­åŠ è½½ json ä»¥æŸ¥çœ‹æ‰€æœ‰å…³ç³»ï¼š</p>
<figure><img src="../../../.gitbook/assets/image (1182).png" alt="" width="375"><figcaption></figcaption></figure>
<h3 id="filemonitor"><a class="header" href="#filemonitor">FileMonitor</a></h3>
<p><a href="https://objective-see.com/products/utilities.html#FileMonitor"><strong>FileMonitor</strong></a> å…è®¸ç›‘è§†æ–‡ä»¶äº‹ä»¶ï¼ˆä¾‹å¦‚åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤ï¼‰ï¼Œæä¾›æœ‰å…³è¿™äº›äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<h3 id="crescendo"><a class="header" href="#crescendo">Crescendo</a></h3>
<p><a href="https://github.com/SuprHackerSteve/Crescendo"><strong>Crescendo</strong></a> æ˜¯ä¸€ä¸ª GUI å·¥å…·ï¼Œå¤–è§‚å’Œæ„Ÿè§‰ä¸ Windows ç”¨æˆ·å¯èƒ½ç†Ÿæ‚‰çš„ Microsoft Sysinternal çš„ <em>Procmon</em> ç›¸ä¼¼ã€‚æ­¤å·¥å…·å…è®¸å¼€å§‹å’Œåœæ­¢å„ç§äº‹ä»¶ç±»å‹çš„è®°å½•ï¼Œå…è®¸æŒ‰æ–‡ä»¶ã€è¿›ç¨‹ã€ç½‘ç»œç­‰ç±»åˆ«è¿‡æ»¤è¿™äº›äº‹ä»¶ï¼Œå¹¶æä¾›ä»¥ json æ ¼å¼ä¿å­˜è®°å½•äº‹ä»¶çš„åŠŸèƒ½ã€‚</p>
<h3 id="apple-instruments"><a class="header" href="#apple-instruments">Apple Instruments</a></h3>
<p><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CellularBestPractices/Appendix/Appendix.html"><strong>Apple Instruments</strong></a> æ˜¯ Xcode å¼€å‘å·¥å…·çš„ä¸€éƒ¨åˆ† â€“ ç”¨äºç›‘è§†åº”ç”¨ç¨‹åºæ€§èƒ½ã€è¯†åˆ«å†…å­˜æ³„æ¼å’Œè·Ÿè¸ªæ–‡ä»¶ç³»ç»Ÿæ´»åŠ¨ã€‚</p>
<p><img src="../../../.gitbook/assets/image%20(1138).png" alt="" /></p>
<h3 id="fs_usage"><a class="header" href="#fs_usage">fs_usage</a></h3>
<p>å…è®¸è·Ÿè¸ªè¿›ç¨‹æ‰§è¡Œçš„æ“ä½œï¼š</p>
<pre><code class="language-bash">fs_usage -w -f filesys ls #This tracks filesystem actions of proccess names containing ls
fs_usage -w -f network curl #This tracks network actions
</code></pre>
<h3 id="taskexplorer"><a class="header" href="#taskexplorer">TaskExplorer</a></h3>
<p><a href="https://objective-see.com/products/taskexplorer.html"><strong>Taskexplorer</strong></a> æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨çš„ <strong>libraries</strong>ã€å®ƒæ­£åœ¨ä½¿ç”¨çš„ <strong>files</strong> å’Œ <strong>network</strong> è¿æ¥ã€‚<br />
å®ƒè¿˜ä¼šæ£€æŸ¥äºŒè¿›åˆ¶è¿›ç¨‹ä¸ <strong>virustotal</strong> çš„å¯¹æ¯”ï¼Œå¹¶æ˜¾ç¤ºæœ‰å…³è¯¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¿¡æ¯ã€‚</p>
<h2 id="pt_deny_attach"><a class="header" href="#pt_deny_attach">PT_DENY_ATTACH <a href="#page-title" id="page-title"></a></a></h2>
<p>åœ¨ <a href="https://knight.sc/debugging/2019/06/03/debugging-apple-binaries-that-use-pt-deny-attach.html"><strong>è¿™ç¯‡åšå®¢æ–‡ç« </strong></a> ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå…³äºå¦‚ä½• <strong>è°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹</strong> çš„ç¤ºä¾‹ï¼Œè¯¥å®ˆæŠ¤è¿›ç¨‹ä½¿ç”¨ <strong><code>PT_DENY_ATTACH</code></strong> æ¥é˜²æ­¢è°ƒè¯•ï¼Œå³ä½¿ SIP è¢«ç¦ç”¨ã€‚</p>
<h3 id="lldb"><a class="header" href="#lldb">lldb</a></h3>
<p><strong>lldb</strong> æ˜¯ <strong>macOS</strong> äºŒè¿›åˆ¶ <strong>debugging</strong> çš„äº‹å®æ ‡å‡†å·¥å…·ã€‚</p>
<pre><code class="language-bash">lldb ./malware.bin
lldb -p 1122
lldb -n malware.bin
lldb -n malware.bin --waitfor
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨ä½¿ç”¨ lldb æ—¶è®¾ç½® intel é£å‘³ï¼Œé€šè¿‡åœ¨æ‚¨çš„ä¸»æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <strong><code>.lldbinit</code></strong> çš„æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹è¡Œï¼š</p>
<pre><code class="language-bash">settings set target.x86-disassembly-flavor intel
</code></pre>
<p>{% hint style="warning" %}
åœ¨ lldb ä¸­ï¼Œä½¿ç”¨ <code>process save-core</code> è½¬å‚¨è¿›ç¨‹
{% endhint %}</p>
<table data-header-hidden><thead><tr><th width="225"></th><th></th></tr></thead><tbody><tr><td><strong>(lldb) å‘½ä»¤</strong></td><td><strong>æè¿°</strong></td></tr><tr><td><strong>run (r)</strong></td><td>å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°å‘½ä¸­æ–­ç‚¹æˆ–è¿›ç¨‹ç»ˆæ­¢ã€‚</td></tr><tr><td><strong>process launch --stop-at-entry</strong></td><td>ä»å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œå¹¶åœæ­¢</td></tr><tr><td><strong>continue (c)</strong></td><td>ç»§ç»­è°ƒè¯•çš„è¿›ç¨‹çš„æ‰§è¡Œã€‚</td></tr><tr><td><strong>nexti (n / ni)</strong></td><td>æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æ­¤å‘½ä»¤å°†è·³è¿‡å‡½æ•°è°ƒç”¨ã€‚</td></tr><tr><td><strong>stepi (s / si)</strong></td><td>æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ä¸ nexti å‘½ä»¤ä¸åŒï¼Œæ­¤å‘½ä»¤å°†è¿›å…¥å‡½æ•°è°ƒç”¨ã€‚</td></tr><tr><td><strong>finish (f)</strong></td><td>æ‰§è¡Œå½“å‰å‡½æ•°ï¼ˆâ€œå¸§â€ï¼‰ä¸­çš„å…¶ä½™æŒ‡ä»¤ï¼Œè¿”å›å¹¶åœæ­¢ã€‚</td></tr><tr><td><strong>control + c</strong></td><td>æš‚åœæ‰§è¡Œã€‚å¦‚æœè¿›ç¨‹å·²è¿è¡Œ (r) æˆ–ç»§ç»­ (c)ï¼Œè¿™å°†å¯¼è‡´è¿›ç¨‹åœ¨å½“å‰æ‰§è¡Œä½ç½®åœæ­¢ã€‚</td></tr><tr><td><strong>breakpoint (b)</strong></td><td><p><code>b main</code> #ä»»ä½•åä¸º main çš„å‡½æ•°</p><p><code>b &#x3C;binname>`main</code> #äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸»å‡½æ•°</p><p><code>b set -n main --shlib &#x3C;lib_name></code> #æŒ‡å®šäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸»å‡½æ•°</p><p><code>breakpoint set -r '\[NSFileManager .*\]$'</code> #ä»»ä½• NSFileManager æ–¹æ³•</p><p><code>breakpoint set -r '\[NSFileManager contentsOfDirectoryAtPath:.*\]$'</code></p><p><code>break set -r . -s libobjc.A.dylib</code> # åœ¨è¯¥åº“çš„æ‰€æœ‰å‡½æ•°ä¸­è®¾ç½®æ–­ç‚¹</p><p><code>b -a 0x0000000100004bd9</code></p><p><code>br l</code> #æ–­ç‚¹åˆ—è¡¨</p><p><code>br e/dis &#x3C;num></code> #å¯ç”¨/ç¦ç”¨æ–­ç‚¹</p><p>breakpoint delete &#x3C;num></p></td></tr><tr><td><strong>help</strong></td><td><p>help breakpoint #è·å–æ–­ç‚¹å‘½ä»¤çš„å¸®åŠ©</p><p>help memory write #è·å–å†™å…¥å†…å­˜çš„å¸®åŠ©</p></td></tr><tr><td><strong>reg</strong></td><td><p>reg read</p><p>reg read $rax</p><p>reg read $rax --format &#x3C;<a href="https://lldb.llvm.org/use/variable.html#type-format">format</a>></p><p>reg write $rip 0x100035cc0</p></td></tr><tr><td><strong>x/s &#x3C;reg/memory address></strong></td><td>å°†å†…å­˜æ˜¾ç¤ºä¸ºä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</td></tr><tr><td><strong>x/i &#x3C;reg/memory address></strong></td><td>å°†å†…å­˜æ˜¾ç¤ºä¸ºæ±‡ç¼–æŒ‡ä»¤ã€‚</td></tr><tr><td><strong>x/b &#x3C;reg/memory address></strong></td><td>å°†å†…å­˜æ˜¾ç¤ºä¸ºå­—èŠ‚ã€‚</td></tr><tr><td><strong>print object (po)</strong></td><td><p>è¿™å°†æ‰“å°ç”±å‚æ•°å¼•ç”¨çš„å¯¹è±¡</p><p>po $raw</p><p><code>{</code></p><p><code>dnsChanger = {</code></p><p><code>"affiliate" = "";</code></p><p><code>"blacklist_dns" = ();</code></p><p>è¯·æ³¨æ„ï¼ŒApple çš„å¤§å¤šæ•° Objective-C API æˆ–æ–¹æ³•è¿”å›å¯¹è±¡ï¼Œå› æ­¤åº”é€šè¿‡â€œæ‰“å°å¯¹è±¡â€ï¼ˆpoï¼‰å‘½ä»¤æ˜¾ç¤ºã€‚å¦‚æœ po æ²¡æœ‰äº§ç”Ÿæœ‰æ„ä¹‰çš„è¾“å‡ºï¼Œè¯·ä½¿ç”¨ <code>x/b</code></p></td></tr><tr><td><strong>memory</strong></td><td>memory read 0x000....<br>memory read $x0+0xf2a<br>memory write 0x100600000 -s 4 0x41414141 #åœ¨è¯¥åœ°å€å†™å…¥ AAAA<br>memory write -f s $rip+0x11f+7 "AAAA" #åœ¨åœ°å€ä¸­å†™å…¥ AAAA</td></tr><tr><td><strong>disassembly</strong></td><td><p>dis #åæ±‡ç¼–å½“å‰å‡½æ•°</p><p>dis -n &#x3C;funcname> #åæ±‡ç¼–å‡½æ•°</p><p>dis -n &#x3C;funcname> -b &#x3C;basename> #åæ±‡ç¼–å‡½æ•°<br>dis -c 6 #åæ±‡ç¼– 6 è¡Œ<br>dis -c 0x100003764 -e 0x100003768 # ä»ä¸€ä¸ªåœ°å€åˆ°å¦ä¸€ä¸ªåœ°å€<br>dis -p -c 4 # ä»å½“å‰åœ°å€å¼€å§‹åæ±‡ç¼–</p></td></tr><tr><td><strong>parray</strong></td><td>parray 3 (char **)$x1 # æ£€æŸ¥ x1 å¯„å­˜å™¨ä¸­ 3 ä¸ªç»„ä»¶çš„æ•°ç»„</td></tr><tr><td><strong>image dump sections</strong></td><td>æ‰“å°å½“å‰è¿›ç¨‹å†…å­˜çš„æ˜ å°„</td></tr><tr><td><strong>image dump symtab &#x3C;library></strong></td><td><code>image dump symtab CoreNLP</code> #è·å– CoreNLP çš„æ‰€æœ‰ç¬¦å·çš„åœ°å€</td></tr></tbody></table>
<p>{% hint style="info" %}
è°ƒç”¨ <strong><code>objc_sendMsg</code></strong> å‡½æ•°æ—¶ï¼Œ<strong>rsi</strong> å¯„å­˜å™¨ä¿å­˜æ–¹æ³•çš„ <strong>åç§°</strong>ï¼Œä»¥ null ç»“å°¾çš„ï¼ˆâ€œCâ€ï¼‰å­—ç¬¦ä¸²ã€‚è¦é€šè¿‡ lldb æ‰“å°åç§°ï¼Œè¯·æ‰§è¡Œï¼š</p>
<p><code>(lldb) x/s $rsi: 0x1000f1576: "startMiningWithPort:password:coreCount:slowMemory:currency:"</code></p>
<p><code>(lldb) print (char*)$rsi:</code><br />
<code>(char *) $1 = 0x00000001000f1576 "startMiningWithPort:password:coreCount:slowMemory:currency:"</code></p>
<p><code>(lldb) reg read $rsi: rsi = 0x00000001000f1576 "startMiningWithPort:password:coreCount:slowMemory:currency:"</code>
{% endhint %}</p>
<h3 id="ååŠ¨æ€åˆ†æ"><a class="header" href="#ååŠ¨æ€åˆ†æ">ååŠ¨æ€åˆ†æ</a></h3>
<h4 id="è™šæ‹Ÿæœºæ£€æµ‹"><a class="header" href="#è™šæ‹Ÿæœºæ£€æµ‹">è™šæ‹Ÿæœºæ£€æµ‹</a></h4>
<ul>
<li>å‘½ä»¤ <strong><code>sysctl hw.model</code></strong> åœ¨ <strong>ä¸»æœºä¸º MacOS</strong> æ—¶è¿”å› "Mac"ï¼Œä½†åœ¨è™šæ‹Ÿæœºæ—¶è¿”å›ä¸åŒçš„å†…å®¹ã€‚</li>
<li>ä¸€äº›æ¶æ„è½¯ä»¶é€šè¿‡ç©å¼„ <strong><code>hw.logicalcpu</code></strong> å’Œ <strong><code>hw.physicalcpu</code></strong> çš„å€¼æ¥å°è¯•æ£€æµ‹æ˜¯å¦ä¸ºè™šæ‹Ÿæœºã€‚</li>
<li>ä¸€äº›æ¶æ„è½¯ä»¶è¿˜å¯ä»¥æ ¹æ® MAC åœ°å€ï¼ˆ00:50:56ï¼‰<strong>æ£€æµ‹</strong>æœºå™¨æ˜¯å¦ä¸º <strong>VMware</strong>ã€‚</li>
<li>è¿˜å¯ä»¥é€šè¿‡ç®€å•çš„ä»£ç æ£€æŸ¥ <strong>è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¢«è°ƒè¯•</strong>ï¼š</li>
<li><code>if(P_TRACED == (info.kp_proc.p_flag &amp; P_TRACED)){ //è¿›ç¨‹æ­£åœ¨è¢«è°ƒè¯• }</code></li>
<li>å®ƒè¿˜å¯ä»¥è°ƒç”¨ <strong><code>ptrace</code></strong> ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨ <strong><code>PT_DENY_ATTACH</code></strong> æ ‡å¿—ã€‚è¿™ <strong>é˜²æ­¢</strong> è°ƒè¯•å™¨é™„åŠ å’Œè·Ÿè¸ªã€‚</li>
<li>æ‚¨å¯ä»¥æ£€æŸ¥ <strong><code>sysctl</code></strong> æˆ– <strong><code>ptrace</code></strong> å‡½æ•°æ˜¯å¦è¢« <strong>å¯¼å…¥</strong>ï¼ˆä½†æ¶æ„è½¯ä»¶å¯ä»¥åŠ¨æ€å¯¼å…¥å®ƒï¼‰</li>
<li>æ­£å¦‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­æ‰€è¿°ï¼Œâ€œ<a href="https://alexomara.com/blog/defeating-anti-debug-techniques-macos-ptrace-variants/">å‡»è´¥åè°ƒè¯•æŠ€æœ¯ï¼šmacOS ptrace å˜ä½“</a>â€ï¼š<br />
â€œ<em>æ¶ˆæ¯ Process # exited with <strong>status = 45 (0x0000002d)</strong> é€šå¸¸æ˜¯è°ƒè¯•ç›®æ ‡ä½¿ç”¨ <strong>PT_DENY_ATTACH</strong> çš„æ˜æ˜¾è¿¹è±¡</em>â€</li>
</ul>
<h2 id="æ ¸å¿ƒè½¬å‚¨"><a class="header" href="#æ ¸å¿ƒè½¬å‚¨">æ ¸å¿ƒè½¬å‚¨</a></h2>
<p>å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™ä¼šåˆ›å»ºæ ¸å¿ƒè½¬å‚¨ï¼š</p>
<ul>
<li><code>kern.coredump</code> sysctl è®¾ç½®ä¸º 1ï¼ˆé»˜è®¤å€¼ï¼‰</li>
<li>å¦‚æœè¿›ç¨‹ä¸æ˜¯ suid/sgid æˆ– <code>kern.sugid_coredump</code> ä¸º 1ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼‰</li>
<li><code>AS_CORE</code> é™åˆ¶å…è®¸è¯¥æ“ä½œã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ <code>ulimit -c 0</code> æ¥æŠ‘åˆ¶æ ¸å¿ƒè½¬å‚¨çš„åˆ›å»ºï¼Œå¹¶é€šè¿‡ <code>ulimit -c unlimited</code> é‡æ–°å¯ç”¨å®ƒä»¬ã€‚</li>
</ul>
<p>åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ ¸å¿ƒè½¬å‚¨æ ¹æ® <code>kern.corefile</code> sysctl ç”Ÿæˆï¼Œå¹¶é€šå¸¸å­˜å‚¨åœ¨ <code>/cores/core/.%P</code> ä¸­ã€‚</p>
<h2 id="æ¨¡ç³Šæµ‹è¯•"><a class="header" href="#æ¨¡ç³Šæµ‹è¯•">æ¨¡ç³Šæµ‹è¯•</a></h2>
<h3 id="reportcrash"><a class="header" href="#reportcrash"><a href="https://ss64.com/osx/reportcrash.html">ReportCrash</a></a></h3>
<p>ReportCrash <strong>åˆ†æå´©æºƒçš„è¿›ç¨‹å¹¶å°†å´©æºƒæŠ¥å‘Šä¿å­˜åˆ°ç£ç›˜</strong>ã€‚å´©æºƒæŠ¥å‘ŠåŒ…å«å¯ä»¥ <strong>å¸®åŠ©å¼€å‘äººå‘˜è¯Šæ–­</strong> å´©æºƒåŸå› çš„ä¿¡æ¯ã€‚<br />
å¯¹äºåœ¨æ¯ä¸ªç”¨æˆ· launchd ä¸Šä¸‹æ–‡ä¸­ <strong>è¿è¡Œçš„åº”ç”¨ç¨‹åºå’Œå…¶ä»–è¿›ç¨‹</strong>ï¼ŒReportCrash ä½œä¸º LaunchAgent è¿è¡Œï¼Œå¹¶å°†å´©æºƒæŠ¥å‘Šä¿å­˜åœ¨ç”¨æˆ·çš„ <code>~/Library/Logs/DiagnosticReports/</code> ä¸­ã€‚<br />
å¯¹äºå®ˆæŠ¤è¿›ç¨‹ã€åœ¨ç³»ç»Ÿ launchd ä¸Šä¸‹æ–‡ä¸­ <strong>è¿è¡Œçš„å…¶ä»–è¿›ç¨‹</strong> å’Œå…¶ä»–ç‰¹æƒè¿›ç¨‹ï¼ŒReportCrash ä½œä¸º LaunchDaemon è¿è¡Œï¼Œå¹¶å°†å´©æºƒæŠ¥å‘Šä¿å­˜åœ¨ç³»ç»Ÿçš„ <code>/Library/Logs/DiagnosticReports</code> ä¸­ã€‚</p>
<p>å¦‚æœæ‚¨æ‹…å¿ƒå´©æºƒæŠ¥å‘Š <strong>è¢«å‘é€åˆ° Apple</strong>ï¼Œå¯ä»¥ç¦ç”¨å®ƒä»¬ã€‚å¦‚æœä¸æ‹…å¿ƒï¼Œå´©æºƒæŠ¥å‘Šå¯ä»¥å¸®åŠ© <strong>æ‰¾å‡ºæœåŠ¡å™¨å´©æºƒçš„åŸå› </strong>ã€‚</p>
<pre><code class="language-bash">#To disable crash reporting:
launchctl unload -w /System/Library/LaunchAgents/com.apple.ReportCrash.plist
sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ReportCrash.Root.plist

#To re-enable crash reporting:
launchctl load -w /System/Library/LaunchAgents/com.apple.ReportCrash.plist
sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.ReportCrash.Root.plist
</code></pre>
<h3 id="ç¡çœ "><a class="header" href="#ç¡çœ ">ç¡çœ </a></h3>
<p>åœ¨ MacOS ä¸­è¿›è¡Œæ¨¡ç³Šæµ‹è¯•æ—¶ï¼Œé‡è¦çš„æ˜¯ä¸è¦è®© Mac è¿›å…¥ç¡çœ çŠ¶æ€ï¼š</p>
<ul>
<li>systemsetup -setsleep Never</li>
<li>pmset, ç³»ç»Ÿåå¥½è®¾ç½®</li>
<li><a href="https://github.com/newmarcel/KeepingYouAwake">KeepingYouAwake</a></li>
</ul>
<h4 id="ssh-æ–­å¼€è¿æ¥"><a class="header" href="#ssh-æ–­å¼€è¿æ¥">SSH æ–­å¼€è¿æ¥</a></h4>
<p>å¦‚æœæ‚¨é€šè¿‡ SSH è¿æ¥è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œç¡®ä¿ä¼šè¯ä¸ä¼šæ–­å¼€æ˜¯å¾ˆé‡è¦çš„ã€‚å› æ­¤ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å†…å®¹æ›´æ”¹ sshd_config æ–‡ä»¶ï¼š</p>
<ul>
<li>TCPKeepAlive Yes</li>
<li>ClientAliveInterval 0</li>
<li>ClientAliveCountMax 0</li>
</ul>
<pre><code class="language-bash">sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist
sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
</code></pre>
<h3 id="internal-handlers"><a class="header" href="#internal-handlers">Internal Handlers</a></h3>
<p><strong>æŸ¥çœ‹ä»¥ä¸‹é¡µé¢</strong> ä»¥äº†è§£å¦‚ä½•æ‰¾åˆ°å“ªä¸ªåº”ç”¨ç¨‹åºè´Ÿè´£ <strong>å¤„ç†æŒ‡å®šçš„æ–¹æ¡ˆæˆ–åè®®ï¼š</strong></p>
<p>{% content-ref url="../macos-file-extension-apps.md" %}
<a href="../macos-file-extension-apps.html">macos-file-extension-apps.md</a>
{% endcontent-ref %}</p>
<h3 id="enumerating-network-processes"><a class="header" href="#enumerating-network-processes">Enumerating Network Processes</a></h3>
<p>è¿™å¾ˆæœ‰è¶£ï¼Œå¯ä»¥æ‰¾åˆ°ç®¡ç†ç½‘ç»œæ•°æ®çš„è¿›ç¨‹ï¼š</p>
<pre><code class="language-bash">dtrace -n 'syscall::recv*:entry { printf("-&gt; %s (pid=%d)", execname, pid); }' &gt;&gt; recv.log
#wait some time
sort -u recv.log &gt; procs.txt
cat procs.txt
</code></pre>
<p>æˆ–è€…ä½¿ç”¨ <code>netstat</code> æˆ– <code>lsof</code></p>
<h3 id="libgmalloc"><a class="header" href="#libgmalloc">Libgmalloc</a></h3>
<figure><img src="../../../.gitbook/assets/Pasted Graphic 14.png" alt=""><figcaption></figcaption></figure>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">lldb -o "target create `which some-binary`" -o "settings set target.env-vars DYLD_INSERT_LIBRARIES=/usr/lib/libgmalloc.dylib" -o "run arg1 arg2" -o "bt" -o "reg read" -o "dis -s \$pc-32 -c 24 -m -F intel" -o "quit"
</code></pre>
<p>{% endcode %}</p>
<h3 id="æ¨¡ç³Šæµ‹è¯•å·¥å…·"><a class="header" href="#æ¨¡ç³Šæµ‹è¯•å·¥å…·">æ¨¡ç³Šæµ‹è¯•å·¥å…·</a></h3>
<h4 id="afl"><a class="header" href="#afl"><a href="https://github.com/AFLplusplus/AFLplusplus">AFL++</a></a></h4>
<p>é€‚ç”¨äºCLIå·¥å…·</p>
<h4 id="litefuzz"><a class="header" href="#litefuzz"><a href="https://github.com/sec-tools/litefuzz">Litefuzz</a></a></h4>
<p>å®ƒâ€œ<strong>å¯ä»¥æ­£å¸¸å·¥ä½œ</strong>â€ä¸macOS GUIå·¥å…·ã€‚è¯·æ³¨æ„ï¼Œä¸€äº›macOSåº”ç”¨ç¨‹åºæœ‰ä¸€äº›ç‰¹å®šè¦æ±‚ï¼Œå¦‚å”¯ä¸€çš„æ–‡ä»¶åã€æ­£ç¡®çš„æ‰©å±•åï¼Œéœ€è¦ä»æ²™ç›’ä¸­è¯»å–æ–‡ä»¶ï¼ˆ<code>~/Library/Containers/com.apple.Safari/Data</code>ï¼‰...</p>
<p>ä¸€äº›ç¤ºä¾‹ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># iBooks
litefuzz -l -c "/System/Applications/Books.app/Contents/MacOS/Books FUZZ" -i files/epub -o crashes/ibooks -t /Users/test/Library/Containers/com.apple.iBooksX/Data/tmp -x 10 -n 100000 -ez

# -l : Local
# -c : cmdline with FUZZ word (if not stdin is used)
# -i : input directory or file
# -o : Dir to output crashes
# -t : Dir to output runtime fuzzing artifacts
# -x : Tmeout for the run (default is 1)
# -n : Num of fuzzing iterations (default is 1)
# -e : enable second round fuzzing where any crashes found are reused as inputs
# -z : enable malloc debug helpers

# Font Book
litefuzz -l -c "/System/Applications/Font Book.app/Contents/MacOS/Font Book FUZZ" -i input/fonts -o crashes/font-book -x 2 -n 500000 -ez

# smbutil (using pcap capture)
litefuzz -lk -c "smbutil view smb://localhost:4455" -a tcp://localhost:4455 -i input/mac-smb-resp -p -n 100000 -z

# screensharingd (using pcap capture)
litefuzz -s -a tcp://localhost:5900 -i input/screenshared-session --reportcrash screensharingd -p -n 100000
</code></pre>
<p>{% endcode %}</p>
<h3 id="æ›´å¤šæ¨¡ç³Šæµ‹è¯•-macos-ä¿¡æ¯"><a class="header" href="#æ›´å¤šæ¨¡ç³Šæµ‹è¯•-macos-ä¿¡æ¯">æ›´å¤šæ¨¡ç³Šæµ‹è¯• MacOS ä¿¡æ¯</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=T5xfL9tEg44">https://www.youtube.com/watch?v=T5xfL9tEg44</a></li>
<li><a href="https://github.com/bnagy/slides/blob/master/OSXScale.pdf">https://github.com/bnagy/slides/blob/master/OSXScale.pdf</a></li>
<li><a href="https://github.com/bnagy/francis/tree/master/exploitaben">https://github.com/bnagy/francis/tree/master/exploitaben</a></li>
<li><a href="https://github.com/ant4g0nist/crashwrangler">https://github.com/ant4g0nist/crashwrangler</a></li>
</ul>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://www.amazon.com/OS-Incident-Response-Scripting-Analysis-ebook/dp/B01FHOHHVS"><strong>OS X äº‹ä»¶å“åº”ï¼šè„šæœ¬å’Œåˆ†æ</strong></a></li>
<li><a href="https://www.youtube.com/watch?v=T5xfL9tEg44"><strong>https://www.youtube.com/watch?v=T5xfL9tEg44</strong></a></li>
<li><a href="https://taomm.org/vol1/analysis.html"><strong>https://taomm.org/vol1/analysis.html</strong></a></li>
<li><a href="https://taomm.org/"><strong>Mac æ¶æ„è½¯ä»¶çš„è‰ºæœ¯ï¼šåˆ†ææ¶æ„è½¯ä»¶çš„æŒ‡å—</strong></a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
