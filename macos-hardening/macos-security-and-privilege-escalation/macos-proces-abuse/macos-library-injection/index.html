<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS Library Injection</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-library-injection"><a class="header" href="#macos-library-injection">macOS Library Injection</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<p>{% hint style="danger" %}
<strong>dyld çš„ä»£ç æ˜¯å¼€æºçš„</strong>ï¼Œå¯ä»¥åœ¨ <a href="https://opensource.apple.com/source/dyld/">https://opensource.apple.com/source/dyld/</a> æ‰¾åˆ°ï¼Œå¹¶å¯ä»¥ä½¿ç”¨ <strong>URL å¦‚</strong> <a href="https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz">https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz</a> ä¸‹è½½ä¸º tar æ–‡ä»¶ã€‚
{% endhint %}</p>
<h2 id="dyld-è¿›ç¨‹"><a class="header" href="#dyld-è¿›ç¨‹"><strong>Dyld è¿›ç¨‹</strong></a></h2>
<p>æŸ¥çœ‹ Dyld å¦‚ä½•åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­åŠ è½½åº“ï¼š</p>
<p>{% content-ref url="macos-dyld-process.md" %}
<a href="macos-dyld-process.html">macos-dyld-process.md</a>
{% endcontent-ref %}</p>
<h2 id="dyld_insert_libraries"><a class="header" href="#dyld_insert_libraries"><strong>DYLD_INSERT_LIBRARIES</strong></a></h2>
<p>è¿™ç±»ä¼¼äº <a href="../../../../linux-hardening/privilege-escalation/#ld_preload"><strong>Linux ä¸Šçš„ LD_PRELOAD</strong></a>ã€‚å®ƒå…è®¸æŒ‡ç¤ºå³å°†è¿è¡Œçš„è¿›ç¨‹ä»è·¯å¾„åŠ è½½ç‰¹å®šåº“ï¼ˆå¦‚æœç¯å¢ƒå˜é‡å·²å¯ç”¨ï¼‰ã€‚</p>
<p>æ­¤æŠ€æœ¯ä¹Ÿå¯ä»¥ä½œä¸º <strong>ASEP æŠ€æœ¯</strong> ä½¿ç”¨ï¼Œå› ä¸ºæ¯ä¸ªå®‰è£…çš„åº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªåä¸º "Info.plist" çš„ plistï¼Œå…è®¸ä½¿ç”¨åä¸º <code>LSEnvironmental</code> çš„é”® <strong>åˆ†é…ç¯å¢ƒå˜é‡</strong>ã€‚</p>
<p>{% hint style="info" %}
è‡ª 2012 å¹´ä»¥æ¥ï¼Œ<strong>Apple å¤§å¹…å‡å°‘äº†</strong> <strong><code>DYLD_INSERT_LIBRARIES</code></strong> çš„åŠŸèƒ½ã€‚</p>
<p>æŸ¥çœ‹ä»£ç å¹¶ <strong>æ£€æŸ¥ <code>src/dyld.cpp</code></strong>ã€‚åœ¨å‡½æ•° <strong><code>pruneEnvironmentVariables</code></strong> ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° <strong><code>DYLD_*</code></strong> å˜é‡è¢«ç§»é™¤ã€‚</p>
<p>åœ¨å‡½æ•° <strong><code>processRestricted</code></strong> ä¸­è®¾ç½®äº†é™åˆ¶çš„åŸå› ã€‚æ£€æŸ¥è¯¥ä»£ç ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åŸå› åŒ…æ‹¬ï¼š</p>
<ul>
<li>äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ <code>setuid/setgid</code></li>
<li>macho äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ <code>__RESTRICT/__restrict</code> éƒ¨åˆ†ã€‚</li>
<li>è½¯ä»¶å…·æœ‰æƒé™ï¼ˆå¼ºåŒ–è¿è¡Œæ—¶ï¼‰ï¼Œä½†æ²¡æœ‰ <a href="https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_security_cs_allow-dyld-environment-variables"><code>com.apple.security.cs.allow-dyld-environment-variables</code></a> æƒé™ã€‚</li>
<li>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ <strong>æƒé™</strong>ï¼š<code>codesign -dv --entitlements :- &lt;/path/to/bin&gt;</code></li>
</ul>
<p>åœ¨æ›´æ–°ç‰ˆæœ¬ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨å‡½æ•° <strong><code>configureProcessRestrictions</code></strong> çš„ç¬¬äºŒéƒ¨åˆ†æ‰¾åˆ°æ­¤é€»è¾‘ã€‚ç„¶è€Œï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­æ‰§è¡Œçš„æ˜¯è¯¥å‡½æ•°çš„ <strong>å¼€å§‹æ£€æŸ¥</strong>ï¼ˆæ‚¨å¯ä»¥åˆ é™¤ä¸ iOS æˆ–æ¨¡æ‹Ÿç›¸å…³çš„ ifï¼Œå› ä¸ºè¿™äº›åœ¨ macOS ä¸­ä¸ä¼šä½¿ç”¨ï¼‰ã€‚
{% endhint %}</p>
<h3 id="åº“éªŒè¯"><a class="header" href="#åº“éªŒè¯">åº“éªŒè¯</a></h3>
<p>å³ä½¿äºŒè¿›åˆ¶æ–‡ä»¶å…è®¸ä½¿ç”¨ <strong><code>DYLD_INSERT_LIBRARIES</code></strong> ç¯å¢ƒå˜é‡ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ£€æŸ¥è¦åŠ è½½çš„åº“çš„ç­¾åï¼Œå®ƒä¹Ÿä¸ä¼šåŠ è½½è‡ªå®šä¹‰åº“ã€‚</p>
<p>ä¸ºäº†åŠ è½½è‡ªå®šä¹‰åº“ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…·æœ‰ <strong>ä»¥ä¸‹ä»»ä¸€æƒé™</strong>ï¼š</p>
<ul>
<li><a href="../../macos-security-protections/macos-dangerous-entitlements.html#com.apple.security.cs.disable-library-validation"><code>com.apple.security.cs.disable-library-validation</code></a></li>
<li><a href="../../macos-security-protections/macos-dangerous-entitlements.html#com.apple.private.security.clear-library-validation"><code>com.apple.private.security.clear-library-validation</code></a></li>
</ul>
<p>æˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶ <strong>ä¸åº”</strong> å…·æœ‰ <strong>å¼ºåŒ–è¿è¡Œæ—¶æ ‡å¿—</strong> æˆ– <strong>åº“éªŒè¯æ ‡å¿—</strong>ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <code>codesign --display --verbose &lt;bin&gt;</code> æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å…·æœ‰ <strong>å¼ºåŒ–è¿è¡Œæ—¶</strong>ï¼Œæ£€æŸ¥ <strong><code>CodeDirectory</code></strong> ä¸­çš„ runtime æ ‡å¿—ï¼Œå¦‚ï¼š<strong><code>CodeDirectory v=20500 size=767 flags=0x10000(runtime) hashes=13+7 location=embedded</code></strong></p>
<p>å¦‚æœåº“ <strong>ä½¿ç”¨ä¸äºŒè¿›åˆ¶æ–‡ä»¶ç›¸åŒçš„è¯ä¹¦ç­¾å</strong>ï¼Œæ‚¨ä¹Ÿå¯ä»¥åŠ è½½è¯¥åº“ã€‚</p>
<p>æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼Œäº†è§£å¦‚ä½•ï¼ˆæ»¥ç”¨ï¼‰æ­¤åŠŸèƒ½å¹¶æ£€æŸ¥é™åˆ¶ï¼š</p>
<p>{% content-ref url="macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
<a href="macos-dyld-hijacking-and-dyld_insert_libraries.html">macos-dyld-hijacking-and-dyld_insert_libraries.md</a>
{% endcontent-ref %}</p>
<h2 id="dylib-åŠ«æŒ"><a class="header" href="#dylib-åŠ«æŒ">Dylib åŠ«æŒ</a></h2>
<p>{% hint style="danger" %}
è¯·è®°ä½ï¼Œ<strong>ä¹‹å‰çš„åº“éªŒè¯é™åˆ¶ä¹Ÿé€‚ç”¨äº</strong> æ‰§è¡Œ Dylib åŠ«æŒæ”»å‡»ã€‚
{% endhint %}</p>
<p>ä¸ Windows ä¸€æ ·ï¼Œåœ¨ MacOS ä¸­ï¼Œæ‚¨ä¹Ÿå¯ä»¥ <strong>åŠ«æŒ dylibs</strong> ä½¿ <strong>åº”ç”¨ç¨‹åº</strong> <strong>æ‰§è¡Œ</strong> <strong>ä»»æ„</strong> <strong>ä»£ç </strong>ï¼ˆå®é™…ä¸Šï¼Œä»æ™®é€šç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿™å¯èƒ½ä¸å¯è¡Œï¼Œå› ä¸ºæ‚¨å¯èƒ½éœ€è¦ TCC æƒé™æ‰èƒ½å†™å…¥ <code>.app</code> åŒ…å¹¶åŠ«æŒåº“ï¼‰ã€‚<br />
ç„¶è€Œï¼Œ<strong>MacOS</strong> åº”ç”¨ç¨‹åº <strong>åŠ è½½</strong> åº“çš„æ–¹å¼ <strong>æ¯” Windows æ›´å—é™åˆ¶</strong>ã€‚è¿™æ„å‘³ç€ <strong>æ¶æ„è½¯ä»¶</strong> å¼€å‘äººå‘˜ä»ç„¶å¯ä»¥ä½¿ç”¨æ­¤æŠ€æœ¯è¿›è¡Œ <strong>éšè”½</strong>ï¼Œä½†èƒ½å¤Ÿ <strong>æ»¥ç”¨æ­¤æŠ€æœ¯ä»¥æå‡æƒé™çš„å¯èƒ½æ€§è¦ä½å¾—å¤š</strong>ã€‚</p>
<p>é¦–å…ˆï¼Œ<strong>æ›´å¸¸è§</strong> çš„æƒ…å†µæ˜¯ <strong>MacOS äºŒè¿›åˆ¶æ–‡ä»¶æŒ‡ç¤ºè¦åŠ è½½çš„åº“çš„å®Œæ•´è·¯å¾„</strong>ã€‚å…¶æ¬¡ï¼Œ<strong>MacOS ä»ä¸åœ¨</strong> <strong>$PATH</strong> çš„æ–‡ä»¶å¤¹ä¸­æœç´¢åº“ã€‚</p>
<p>ä¸æ­¤åŠŸèƒ½ç›¸å…³çš„ <strong>ä¸»è¦</strong> ä»£ç éƒ¨åˆ†åœ¨ <strong><code>ImageLoader::recursiveLoadLibraries</code></strong> ä¸­ï¼Œä½äº <code>ImageLoader.cpp</code>ã€‚</p>
<p>macho äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ä½¿ç”¨ <strong>4 ç§ä¸åŒçš„å¤´å‘½ä»¤</strong> æ¥åŠ è½½åº“ï¼š</p>
<ul>
<li><strong><code>LC_LOAD_DYLIB</code></strong> å‘½ä»¤æ˜¯åŠ è½½ dylib çš„å¸¸ç”¨å‘½ä»¤ã€‚</li>
<li><strong><code>LC_LOAD_WEAK_DYLIB</code></strong> å‘½ä»¤çš„å·¥ä½œæ–¹å¼ä¸å‰è€…ç›¸åŒï¼Œä½†å¦‚æœæœªæ‰¾åˆ° dylibï¼Œæ‰§è¡Œå°†ç»§ç»­è€Œä¸ä¼šå‡ºç°é”™è¯¯ã€‚</li>
<li><strong><code>LC_REEXPORT_DYLIB</code></strong> å‘½ä»¤ä»£ç†ï¼ˆæˆ–é‡æ–°å¯¼å‡ºï¼‰æ¥è‡ªä¸åŒåº“çš„ç¬¦å·ã€‚</li>
<li><strong><code>LC_LOAD_UPWARD_DYLIB</code></strong> å‘½ä»¤åœ¨ä¸¤ä¸ªåº“ç›¸äº’ä¾èµ–æ—¶ä½¿ç”¨ï¼ˆè¿™ç§°ä¸º <em>å‘ä¸Šä¾èµ–</em>ï¼‰ã€‚</li>
</ul>
<p>ç„¶è€Œï¼Œæœ‰ <strong>2 ç§ç±»å‹çš„ dylib åŠ«æŒ</strong>ï¼š</p>
<ul>
<li><strong>ç¼ºå¤±çš„å¼±é“¾æ¥åº“</strong>ï¼šè¿™æ„å‘³ç€åº”ç”¨ç¨‹åºå°†å°è¯•åŠ è½½ä¸€ä¸ªä¸å­˜åœ¨çš„åº“ï¼Œé…ç½®ä¸º <strong>LC_LOAD_WEAK_DYLIB</strong>ã€‚ç„¶åï¼Œ<strong>å¦‚æœæ”»å‡»è€…åœ¨é¢„æœŸåŠ è½½çš„ä½ç½®æ”¾ç½®äº†ä¸€ä¸ª dylib</strong>ã€‚</li>
<li>é“¾æ¥æ˜¯â€œå¼±â€çš„äº‹å®æ„å‘³ç€å³ä½¿æœªæ‰¾åˆ°åº“ï¼Œåº”ç”¨ç¨‹åºä»å°†ç»§ç»­è¿è¡Œã€‚</li>
<li>ä¸æ­¤ç›¸å…³çš„ <strong>ä»£ç </strong> åœ¨ <code>ImageLoaderMachO::doGetDependentLibraries</code> å‡½æ•°ä¸­ï¼Œ<code>lib-&gt;required</code> ä»…åœ¨ <code>LC_LOAD_WEAK_DYLIB</code> ä¸º true æ—¶ä¸º <code>false</code>ã€‚</li>
<li><strong>åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æŸ¥æ‰¾å¼±é“¾æ¥åº“</strong>ï¼ˆç¨åæ‚¨å°†çœ‹åˆ°å¦‚ä½•åˆ›å»ºåŠ«æŒåº“çš„ç¤ºä¾‹ï¼‰ï¼š</li>
<li>
<pre><code class="language-bash"></code></pre>
</li>
</ul>
<p>otool -l &lt;/path/to/bin&gt; | grep LC_LOAD_WEAK_DYLIB -A 5 cmd LC_LOAD_WEAK_DYLIB
cmdsize 56
name /var/tmp/lib/libUtl.1.dylib (offset 24)
time stamp 2 Wed Jun 21 12:23:31 1969
current version 1.0.0
compatibility version 1.0.0</p>
<pre><code>* **é…ç½®ä¸º @rpath**ï¼šMach-O äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥å…·æœ‰ **`LC_RPATH`** å’Œ **`LC_LOAD_DYLIB`** å‘½ä»¤ã€‚æ ¹æ®è¿™äº›å‘½ä»¤çš„ **å€¼**ï¼Œ**åº“** å°†ä» **ä¸åŒç›®å½•** åŠ è½½ã€‚
* **`LC_RPATH`** åŒ…å«ç”¨äºé€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åº“çš„ä¸€äº›æ–‡ä»¶å¤¹çš„è·¯å¾„ã€‚
* **`LC_LOAD_DYLIB`** åŒ…å«è¦åŠ è½½çš„ç‰¹å®šåº“çš„è·¯å¾„ã€‚è¿™äº›è·¯å¾„å¯ä»¥åŒ…å« **`@rpath`**ï¼Œå°†è¢« **`LC_RPATH`** ä¸­çš„å€¼ **æ›¿æ¢**ã€‚å¦‚æœ **`LC_RPATH`** ä¸­æœ‰å¤šä¸ªè·¯å¾„ï¼Œå°†ä½¿ç”¨æ‰€æœ‰è·¯å¾„æ¥æœç´¢è¦åŠ è½½çš„åº“ã€‚ä¾‹å¦‚ï¼š
* å¦‚æœ **`LC_LOAD_DYLIB`** åŒ…å« `@rpath/library.dylib`ï¼Œè€Œ **`LC_RPATH`** åŒ…å« `/application/app.app/Contents/Framework/v1/` å’Œ `/application/app.app/Contents/Framework/v2/`ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹å°†ç”¨äºåŠ è½½ `library.dylib`**ã€‚** å¦‚æœåº“åœ¨ `[...]/v1/` ä¸­ä¸å­˜åœ¨ï¼Œæ”»å‡»è€…å¯ä»¥å°†å…¶æ”¾ç½®åœ¨é‚£é‡Œä»¥åŠ«æŒåœ¨ `[...]/v2/` ä¸­åŠ è½½åº“ï¼Œå› ä¸ºéµå¾ª **`LC_LOAD_DYLIB`** ä¸­è·¯å¾„çš„é¡ºåºã€‚
* **åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æŸ¥æ‰¾ rpath è·¯å¾„å’Œåº“**ï¼š`otool -l &lt;/path/to/binary&gt; | grep -E "LC_RPATH|LC_LOAD_DYLIB" -A 5`

{% hint style="info" %}
**`@executable_path`**ï¼šæ˜¯ **ä¸»å¯æ‰§è¡Œæ–‡ä»¶** æ‰€åœ¨ç›®å½•çš„ **è·¯å¾„**ã€‚

**`@loader_path`**ï¼šæ˜¯ **åŒ…å«** **Mach-O äºŒè¿›åˆ¶æ–‡ä»¶** çš„ **ç›®å½•** çš„ **è·¯å¾„**ï¼Œè¯¥æ–‡ä»¶åŒ…å«åŠ è½½å‘½ä»¤ã€‚

* åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä½¿ç”¨æ—¶ï¼Œ**`@loader_path`** å®é™…ä¸Šä¸ **`@executable_path`** ç›¸åŒã€‚
* åœ¨ **dylib** ä¸­ä½¿ç”¨æ—¶ï¼Œ**`@loader_path`** ç»™å‡º **dylib** çš„ **è·¯å¾„**ã€‚
{% endhint %}

æ»¥ç”¨æ­¤åŠŸèƒ½ä»¥ **æå‡æƒé™** çš„æ–¹å¼æ˜¯åœ¨ **åº”ç”¨ç¨‹åº** ç”± **root** æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œ**æŸ¥æ‰¾** åœ¨æ”»å‡»è€…å…·æœ‰å†™æƒé™çš„æŸä¸ªæ–‡ä»¶å¤¹ä¸­çš„ **åº“**ã€‚

{% hint style="success" %}
ä¸€ä¸ªå¾ˆå¥½çš„ **æ‰«æå™¨** ç”¨äºæŸ¥æ‰¾åº”ç”¨ç¨‹åºä¸­çš„ **ç¼ºå¤±åº“** æ˜¯ [**Dylib åŠ«æŒæ‰«æå™¨**](https://objective-see.com/products/dhs.html) æˆ– [**CLI ç‰ˆæœ¬**](https://github.com/pandazheng/DylibHijack)ã€‚\
å…³äºæ­¤æŠ€æœ¯çš„ **æŠ€æœ¯ç»†èŠ‚** çš„å¾ˆå¥½çš„ **æŠ¥å‘Š** å¯ä»¥åœ¨ [**è¿™é‡Œ**](https://www.virusbulletin.com/virusbulletin/2015/03/dylib-hijacking-os-x) æ‰¾åˆ°ã€‚
{% endhint %}

**ç¤ºä¾‹**

{% content-ref url="macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

## Dlopen åŠ«æŒ

{% hint style="danger" %}
è¯·è®°ä½ï¼Œ**ä¹‹å‰çš„åº“éªŒè¯é™åˆ¶ä¹Ÿé€‚ç”¨äº** æ‰§è¡Œ Dlopen åŠ«æŒæ”»å‡»ã€‚
{% endhint %}

æ¥è‡ª **`man dlopen`**ï¼š

* å½“è·¯å¾„ **ä¸åŒ…å«æ–œæ å­—ç¬¦**ï¼ˆå³å®ƒåªæ˜¯ä¸€ä¸ªå¶åç§°ï¼‰æ—¶ï¼Œ**dlopen() å°†è¿›è¡Œæœç´¢**ã€‚å¦‚æœ **`$DYLD_LIBRARY_PATH`** åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼Œdyld å°†é¦–å…ˆ **åœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾**ã€‚æ¥ä¸‹æ¥ï¼Œå¦‚æœè°ƒç”¨çš„ mach-o æ–‡ä»¶æˆ–ä¸»å¯æ‰§è¡Œæ–‡ä»¶æŒ‡å®šäº† **`LC_RPATH`**ï¼Œåˆ™ dyld å°† **åœ¨è¿™äº›** ç›®å½•ä¸­æŸ¥æ‰¾ã€‚æ¥ä¸‹æ¥ï¼Œå¦‚æœè¿›ç¨‹æ˜¯ **ä¸å—é™åˆ¶çš„**ï¼Œdyld å°†åœ¨ **å½“å‰å·¥ä½œç›®å½•** ä¸­æœç´¢ã€‚æœ€åï¼Œå¯¹äºæ—§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œdyld å°†å°è¯•ä¸€äº›åå¤‡æ–¹æ¡ˆã€‚å¦‚æœ **`$DYLD_FALLBACK_LIBRARY_PATH`** åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼Œdyld å°†åœ¨ **è¿™äº›ç›®å½•ä¸­æœç´¢**ï¼Œå¦åˆ™ï¼Œdyld å°†åœ¨ **`/usr/local/lib/`** ä¸­æŸ¥æ‰¾ï¼ˆå¦‚æœè¿›ç¨‹ä¸å—é™åˆ¶ï¼‰ï¼Œç„¶ååœ¨ **`/usr/lib/`** ä¸­æŸ¥æ‰¾ï¼ˆæ­¤ä¿¡æ¯æ¥è‡ª **`man dlopen`**ï¼‰ã€‚
1. `$DYLD_LIBRARY_PATH`
2. `LC_RPATH`
3. `CWD`ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼‰
4. `$DYLD_FALLBACK_LIBRARY_PATH`
5. `/usr/local/lib/`ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼‰
6. `/usr/lib/`

{% hint style="danger" %}
å¦‚æœåç§°ä¸­æ²¡æœ‰æ–œæ ï¼Œåˆ™æœ‰ 2 ç§æ–¹å¼è¿›è¡ŒåŠ«æŒï¼š

* å¦‚æœä»»ä½• **`LC_RPATH`** æ˜¯ **å¯å†™çš„**ï¼ˆä½†ç­¾åä¼šè¢«æ£€æŸ¥ï¼Œå› æ­¤ä¸ºæ­¤æ‚¨è¿˜éœ€è¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸å—é™åˆ¶ï¼‰
* å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ **ä¸å—é™åˆ¶çš„**ï¼Œç„¶åå¯ä»¥ä» CWD åŠ è½½æŸäº›å†…å®¹ï¼ˆæˆ–æ»¥ç”¨æåˆ°çš„ç¯å¢ƒå˜é‡ä¹‹ä¸€ï¼‰
{% endhint %}

* å½“è·¯å¾„ **çœ‹èµ·æ¥åƒæ¡†æ¶** è·¯å¾„ï¼ˆä¾‹å¦‚ `/stuff/foo.framework/foo`ï¼‰æ—¶ï¼Œå¦‚æœ **`$DYLD_FRAMEWORK_PATH`** åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼Œdyld å°†é¦–å…ˆåœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾ **æ¡†æ¶éƒ¨åˆ†è·¯å¾„**ï¼ˆä¾‹å¦‚ `foo.framework/foo`ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œdyld å°†å°è¯• **æŒ‰åŸæ ·ä½¿ç”¨æä¾›çš„è·¯å¾„**ï¼ˆä½¿ç”¨å½“å‰å·¥ä½œç›®å½•è¿›è¡Œç›¸å¯¹è·¯å¾„ï¼‰ã€‚æœ€åï¼Œå¯¹äºæ—§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œdyld å°†å°è¯•ä¸€äº›åå¤‡æ–¹æ¡ˆã€‚å¦‚æœ **`$DYLD_FALLBACK_FRAMEWORK_PATH`** åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼Œdyld å°†åœ¨è¿™äº›ç›®å½•ä¸­æœç´¢ã€‚å¦åˆ™ï¼Œå®ƒå°†æœç´¢ **`/Library/Frameworks`**ï¼ˆåœ¨ macOS ä¸Šï¼Œå¦‚æœè¿›ç¨‹ä¸å—é™åˆ¶ï¼‰ï¼Œç„¶å **`/System/Library/Frameworks`**ã€‚
1. `$DYLD_FRAMEWORK_PATH`
2. æä¾›çš„è·¯å¾„ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼Œä½¿ç”¨å½“å‰å·¥ä½œç›®å½•è¿›è¡Œç›¸å¯¹è·¯å¾„ï¼‰
3. `$DYLD_FALLBACK_FRAMEWORK_PATH`
4. `/Library/Frameworks`ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼‰
5. `/System/Library/Frameworks`

{% hint style="danger" %}
å¦‚æœæ˜¯æ¡†æ¶è·¯å¾„ï¼ŒåŠ«æŒå®ƒçš„æ–¹æ³•å°†æ˜¯ï¼š

* å¦‚æœè¿›ç¨‹æ˜¯ **ä¸å—é™åˆ¶çš„**ï¼Œæ»¥ç”¨ **ç›¸å¯¹è·¯å¾„ä» CWD** æåˆ°çš„ç¯å¢ƒå˜é‡ï¼ˆå³ä½¿æ–‡æ¡£ä¸­æ²¡æœ‰è¯´æ˜ï¼Œå¦‚æœè¿›ç¨‹å—é™ï¼ŒDYLD\_\* ç¯å¢ƒå˜é‡ä¼šè¢«ç§»é™¤ï¼‰
{% endhint %}

* å½“è·¯å¾„ **åŒ…å«æ–œæ ä½†ä¸æ˜¯æ¡†æ¶è·¯å¾„**ï¼ˆå³åˆ° dylib çš„å®Œæ•´è·¯å¾„æˆ–éƒ¨åˆ†è·¯å¾„ï¼‰æ—¶ï¼Œdlopen() é¦–å…ˆåœ¨ï¼ˆå¦‚æœè®¾ç½®ï¼‰ **`$DYLD_LIBRARY_PATH`** ä¸­æŸ¥æ‰¾ï¼ˆä½¿ç”¨è·¯å¾„çš„å¶éƒ¨åˆ†ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œdyld **å°è¯•æä¾›çš„è·¯å¾„**ï¼ˆä½¿ç”¨å½“å‰å·¥ä½œç›®å½•è¿›è¡Œç›¸å¯¹è·¯å¾„ï¼ˆä½†ä»…é€‚ç”¨äºä¸å—é™åˆ¶çš„è¿›ç¨‹ï¼‰ï¼‰ã€‚æœ€åï¼Œå¯¹äºæ—§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œdyld å°†å°è¯•åå¤‡æ–¹æ¡ˆã€‚å¦‚æœ **`$DYLD_FALLBACK_LIBRARY_PATH`** åœ¨å¯åŠ¨æ—¶è®¾ç½®ï¼Œdyld å°†åœ¨è¿™äº›ç›®å½•ä¸­æœç´¢ï¼Œå¦åˆ™ï¼Œdyld å°†åœ¨ **`/usr/local/lib/`** ä¸­æŸ¥æ‰¾ï¼ˆå¦‚æœè¿›ç¨‹ä¸å—é™åˆ¶ï¼‰ï¼Œç„¶ååœ¨ **`/usr/lib/`** ä¸­æŸ¥æ‰¾ã€‚
1. `$DYLD_LIBRARY_PATH`
2. æä¾›çš„è·¯å¾„ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼Œä½¿ç”¨å½“å‰å·¥ä½œç›®å½•è¿›è¡Œç›¸å¯¹è·¯å¾„ï¼‰
3. `$DYLD_FALLBACK_LIBRARY_PATH`
4. `/usr/local/lib/`ï¼ˆå¦‚æœä¸å—é™åˆ¶ï¼‰
5. `/usr/lib/`

{% hint style="danger" %}
å¦‚æœåç§°ä¸­æœ‰æ–œæ ä¸”ä¸æ˜¯æ¡†æ¶ï¼Œåˆ™åŠ«æŒå®ƒçš„æ–¹æ³•å°†æ˜¯ï¼š

* å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ **ä¸å—é™åˆ¶çš„**ï¼Œç„¶åå¯ä»¥ä» CWD æˆ– `/usr/local/lib` åŠ è½½æŸäº›å†…å®¹ï¼ˆæˆ–æ»¥ç”¨æåˆ°çš„ç¯å¢ƒå˜é‡ä¹‹ä¸€ï¼‰
{% endhint %}

{% hint style="info" %}
æ³¨æ„ï¼šæ²¡æœ‰é…ç½®æ–‡ä»¶æ¥ **æ§åˆ¶ dlopen æœç´¢**ã€‚

æ³¨æ„ï¼šå¦‚æœä¸»å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ **set\[ug]id äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…·æœ‰æƒé™çš„ä»£ç ç­¾å**ï¼Œåˆ™ **æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å°†è¢«å¿½ç•¥**ï¼Œåªèƒ½ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼ˆ[æ£€æŸ¥ DYLD\_INSERT\_LIBRARIES é™åˆ¶](macos-dyld-hijacking-and-dyld\_insert\_libraries.md#check-dyld\_insert\_librery-restrictions)ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼‰ã€‚

æ³¨æ„ï¼šApple å¹³å°ä½¿ç”¨â€œé€šç”¨â€æ–‡ä»¶æ¥ç»„åˆ 32 ä½å’Œ 64 ä½åº“ã€‚è¿™æ„å‘³ç€æ²¡æœ‰å•ç‹¬çš„ 32 ä½å’Œ 64 ä½æœç´¢è·¯å¾„ã€‚

æ³¨æ„ï¼šåœ¨ Apple å¹³å°ä¸Šï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿ dylibs è¢« **ç»„åˆåˆ° dyld ç¼“å­˜ä¸­**ï¼Œå¹¶ä¸”åœ¨ç£ç›˜ä¸Šä¸å­˜åœ¨ã€‚å› æ­¤ï¼Œè°ƒç”¨ **`stat()`** ä»¥é¢„æ£€æ“ä½œç³»ç»Ÿ dylib æ˜¯å¦å­˜åœ¨ **å°†ä¸èµ·ä½œç”¨**ã€‚ç„¶è€Œï¼Œ**`dlopen_preflight()`** ä½¿ç”¨ä¸ **`dlopen()`** ç›¸åŒçš„æ­¥éª¤æ¥æŸ¥æ‰¾å…¼å®¹çš„ mach-o æ–‡ä»¶ã€‚
{% endhint %}

**æ£€æŸ¥è·¯å¾„**

è®©æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä»£ç æ£€æŸ¥æ‰€æœ‰é€‰é¡¹ï¼š
```c
// gcc dlopentest.c -o dlopentest -Wl,-rpath,/tmp/test
#include &lt;dlfcn.h&gt;
#include &lt;stdio.h&gt;

int main(void)
{
void* handle;

fprintf("--- No slash ---\n");
handle = dlopen("just_name_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative framework ---\n");
handle = dlopen("a/framework/rel_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs framework ---\n");
handle = dlopen("/a/abs/framework/abs_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative Path ---\n");
handle = dlopen("a/folder/rel_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs Path ---\n");
handle = dlopen("/a/abs/folder/abs_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

return 0;
}
</code></pre>
<p>å¦‚æœä½ ç¼–è¯‘å¹¶æ‰§è¡Œå®ƒï¼Œä½ å¯ä»¥çœ‹åˆ°<strong>æ¯ä¸ªåº“æœªæˆåŠŸæœç´¢çš„ä½ç½®</strong>ã€‚æ­¤å¤–ï¼Œä½ å¯ä»¥<strong>è¿‡æ»¤æ–‡ä»¶ç³»ç»Ÿæ—¥å¿—</strong>ï¼š</p>
<pre><code class="language-bash">sudo fs_usage | grep "dlopentest"
</code></pre>
<h2 id="ç›¸å¯¹è·¯å¾„åŠ«æŒ"><a class="header" href="#ç›¸å¯¹è·¯å¾„åŠ«æŒ">ç›¸å¯¹è·¯å¾„åŠ«æŒ</a></h2>
<p>å¦‚æœä¸€ä¸ª <strong>ç‰¹æƒäºŒè¿›åˆ¶æ–‡ä»¶/åº”ç”¨ç¨‹åº</strong>ï¼ˆå¦‚ SUID æˆ–æŸäº›å…·æœ‰å¼ºå¤§æƒé™çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰æ­£åœ¨ <strong>åŠ è½½ç›¸å¯¹è·¯å¾„</strong> åº“ï¼ˆä¾‹å¦‚ä½¿ç”¨ <code>@executable_path</code> æˆ– <code>@loader_path</code>ï¼‰å¹¶ä¸” <strong>ç¦ç”¨åº“éªŒè¯</strong>ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šå°†äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°ä¸€ä¸ªä½ç½®ï¼Œåœ¨é‚£é‡Œæ”»å‡»è€…å¯ä»¥ <strong>ä¿®æ”¹ç›¸å¯¹è·¯å¾„åŠ è½½çš„åº“</strong>ï¼Œå¹¶åˆ©ç”¨å®ƒåœ¨è¿›ç¨‹ä¸­æ³¨å…¥ä»£ç ã€‚</p>
<h2 id="ä¿®å‰ª-dyld_-å’Œ-ld_library_path-ç¯å¢ƒå˜é‡"><a class="header" href="#ä¿®å‰ª-dyld_-å’Œ-ld_library_path-ç¯å¢ƒå˜é‡">ä¿®å‰ª <code>DYLD_*</code> å’Œ <code>LD_LIBRARY_PATH</code> ç¯å¢ƒå˜é‡</a></h2>
<p>åœ¨æ–‡ä»¶ <code>dyld-dyld-832.7.1/src/dyld2.cpp</code> ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å‡½æ•° <strong><code>pruneEnvironmentVariables</code></strong>ï¼Œè¯¥å‡½æ•°å°†åˆ é™¤ä»»ä½• <strong>ä»¥ <code>DYLD_</code> å¼€å¤´</strong> å’Œ <strong><code>LD_LIBRARY_PATH=</code></strong> çš„ç¯å¢ƒå˜é‡ã€‚</p>
<p>å®ƒè¿˜å°†ç‰¹å®šåœ°å°†ç¯å¢ƒå˜é‡ <strong><code>DYLD_FALLBACK_FRAMEWORK_PATH</code></strong> å’Œ <strong><code>DYLD_FALLBACK_LIBRARY_PATH</code></strong> è®¾ç½®ä¸º <strong>null</strong>ï¼Œé€‚ç”¨äº <strong>suid</strong> å’Œ <strong>sgid</strong> äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>å¦‚æœç›®æ ‡æ˜¯ OSXï¼Œè¯¥å‡½æ•°ä¼šä»åŒä¸€æ–‡ä»¶çš„ <strong><code>_main</code></strong> å‡½æ•°ä¸­è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-cpp">#if TARGET_OS_OSX
if ( !gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache ) {
pruneEnvironmentVariables(envp, &amp;apple);
</code></pre>
<p>è¿™äº›å¸ƒå°”æ ‡å¿—åœ¨ä»£ç ä¸­çš„åŒä¸€æ–‡ä»¶ä¸­è®¾ç½®ï¼š</p>
<pre><code class="language-cpp">#if TARGET_OS_OSX
// support chrooting from old kernel
bool isRestricted = false;
bool libraryValidation = false;
// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
isRestricted = true;
}
bool usingSIP = (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0);
uint32_t flags;
if ( csops(0, CS_OPS_STATUS, &amp;flags, sizeof(flags)) != -1 ) {
// On OS X CS_RESTRICT means the program was signed with entitlements
if ( ((flags &amp; CS_RESTRICT) == CS_RESTRICT) &amp;&amp; usingSIP ) {
isRestricted = true;
}
// Library Validation loosens searching but requires everything to be code signed
if ( flags &amp; CS_REQUIRE_LV ) {
isRestricted = false;
libraryValidation = true;
}
}
gLinkContext.allowAtPaths                = !isRestricted;
gLinkContext.allowEnvVarsPrint           = !isRestricted;
gLinkContext.allowEnvVarsPath            = !isRestricted;
gLinkContext.allowEnvVarsSharedCache     = !libraryValidation || !usingSIP;
gLinkContext.allowClassicFallbackPaths   = !isRestricted;
gLinkContext.allowInsertFailures         = false;
gLinkContext.allowInterposing         	 = true;
</code></pre>
<p>è¿™åŸºæœ¬ä¸Šæ„å‘³ç€ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ <strong>suid</strong> æˆ– <strong>sgid</strong>ï¼Œæˆ–è€…åœ¨å¤´æ–‡ä»¶ä¸­æœ‰ <strong>RESTRICT</strong> æ®µï¼Œæˆ–è€…å®ƒæ˜¯ç”¨ <strong>CS_RESTRICT</strong> æ ‡å¿—ç­¾åçš„ï¼Œé‚£ä¹ˆ <strong><code>!gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache</code></strong> ä¸ºçœŸï¼Œç¯å¢ƒå˜é‡å°†è¢«ä¿®å‰ªã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœ CS_REQUIRE_LV ä¸ºçœŸï¼Œåˆ™å˜é‡ä¸ä¼šè¢«ä¿®å‰ªï¼Œä½†åº“éªŒè¯å°†æ£€æŸ¥å®ƒä»¬æ˜¯å¦ä½¿ç”¨ä¸åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ç›¸åŒçš„è¯ä¹¦ã€‚</p>
<h2 id="æ£€æŸ¥é™åˆ¶"><a class="header" href="#æ£€æŸ¥é™åˆ¶">æ£€æŸ¥é™åˆ¶</a></h2>
<h3 id="suid--sgid"><a class="header" href="#suid--sgid">SUID &amp; SGID</a></h3>
<pre><code class="language-bash"># Make it owned by root and suid
sudo chown root hello
sudo chmod +s hello
# Insert the library
DYLD_INSERT_LIBRARIES=inject.dylib ./hello

# Remove suid
sudo chmod -s hello
</code></pre>
<h3 id="section-__restrict-with-segment-__restrict"><a class="header" href="#section-__restrict-with-segment-__restrict">Section <code>__RESTRICT</code> with segment <code>__restrict</code></a></h3>
<pre><code class="language-bash">gcc -sectcreate __RESTRICT __restrict /dev/null hello.c -o hello-restrict
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-restrict
</code></pre>
<h3 id="åŠ å›ºè¿è¡Œæ—¶"><a class="header" href="#åŠ å›ºè¿è¡Œæ—¶">åŠ å›ºè¿è¡Œæ—¶</a></h3>
<p>åœ¨é’¥åŒ™ä¸²ä¸­åˆ›å»ºä¸€ä¸ªæ–°è¯ä¹¦ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥ç­¾ç½²äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># Apply runtime proetction
codesign -s &lt;cert-name&gt; --option=runtime ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello #Library won't be injected

# Apply library validation
codesign -f -s &lt;cert-name&gt; --option=library ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed #Will throw an error because signature of binary and library aren't signed by same cert (signs must be from a valid Apple-signed developer certificate)

# Sign it
## If the signature is from an unverified developer the injection will still work
## If it's from a verified developer, it won't
codesign -f -s &lt;cert-name&gt; inject.dylib
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed

# Apply CS_RESTRICT protection
codesign -f -s &lt;cert-name&gt; --option=restrict hello-signed
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed # Won't work
</code></pre>
<p>{% endcode %}</p>
<p>{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œå³ä½¿æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å¸¦æœ‰æ ‡å¿— <strong><code>0x0(none)</code></strong>ï¼Œå®ƒä»¬åœ¨æ‰§è¡Œæ—¶ä¹Ÿå¯ä»¥åŠ¨æ€è·å¾— <strong><code>CS_RESTRICT</code></strong> æ ‡å¿—ï¼Œå› æ­¤æ­¤æŠ€æœ¯åœ¨å®ƒä»¬ä¸­å°†ä¸èµ·ä½œç”¨ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡ (è·å– <a href="https://github.com/axelexic/CSOps"><strong>csops è¿™é‡Œ</strong></a>) æ£€æŸ¥ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦å…·æœ‰æ­¤æ ‡å¿—ï¼š</p>
<pre><code class="language-bash">csops -status &lt;pid&gt;
</code></pre>
<p>ç„¶åæ£€æŸ¥æ ‡å¿— 0x800 æ˜¯å¦å¯ç”¨ã€‚
{% endhint %}</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://theevilbit.github.io/posts/dyld_insert_libraries_dylib_injection_in_macos_osx_deep_dive/">https://theevilbit.github.io/posts/dyld_insert_libraries_dylib_injection_in_macos_osx_deep_dive/</a></li>
<li><a href="https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X"><strong>*OS Internals, Volume I: User Mode. By Jonathan Levin</strong></a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**</li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-java-apps-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-library-injection/macos-dyld-hijacking-and-dyld_insert_libraries.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-java-apps-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-library-injection/macos-dyld-hijacking-and-dyld_insert_libraries.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
