<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS Process Abuse</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-进程滥用"><a class="header" href="#macos-进程滥用">macOS 进程滥用</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="进程基本信息"><a class="header" href="#进程基本信息">进程基本信息</a></h2>
<p>进程是正在运行的可执行文件的实例，但进程并不运行代码，这些是线程。因此 <strong>进程只是运行线程的容器</strong>，提供内存、描述符、端口、权限...</p>
<p>传统上，进程是在其他进程中启动的（除了 PID 1），通过调用 <strong><code>fork</code></strong> 创建当前进程的精确副本，然后 <strong>子进程</strong> 通常会调用 <strong><code>execve</code></strong> 来加载新的可执行文件并运行它。随后，引入了 <strong><code>vfork</code></strong> 以加快此过程而无需任何内存复制。<br />
然后引入了 <strong><code>posix_spawn</code></strong>，将 <strong><code>vfork</code></strong> 和 <strong><code>execve</code></strong> 结合在一个调用中，并接受标志：</p>
<ul>
<li><code>POSIX_SPAWN_RESETIDS</code>: 将有效 ID 重置为真实 ID</li>
<li><code>POSIX_SPAWN_SETPGROUP</code>: 设置进程组归属</li>
<li><code>POSUX_SPAWN_SETSIGDEF</code>: 设置信号默认行为</li>
<li><code>POSIX_SPAWN_SETSIGMASK</code>: 设置信号掩码</li>
<li><code>POSIX_SPAWN_SETEXEC</code>: 在同一进程中执行（类似于 <code>execve</code>，但有更多选项）</li>
<li><code>POSIX_SPAWN_START_SUSPENDED</code>: 启动时挂起</li>
<li><code>_POSIX_SPAWN_DISABLE_ASLR</code>: 启动时不使用 ASLR</li>
<li><code>_POSIX_SPAWN_NANO_ALLOCATOR:</code> 使用 libmalloc 的 Nano 分配器</li>
<li><code>_POSIX_SPAWN_ALLOW_DATA_EXEC:</code> 允许数据段的 <code>rwx</code></li>
<li><code>POSIX_SPAWN_CLOEXEC_DEFAULT</code>: 默认情况下在 exec(2) 时关闭所有文件描述符</li>
<li><code>_POSIX_SPAWN_HIGH_BITS_ASLR:</code> 随机化 ASLR 滑动的高位</li>
</ul>
<p>此外，<code>posix_spawn</code> 允许指定一个 <strong><code>posix_spawnattr</code></strong> 数组，以控制生成进程的某些方面，以及 <strong><code>posix_spawn_file_actions</code></strong> 来修改描述符的状态。</p>
<p>当进程终止时，它会向 <strong>父进程发送返回代码</strong>（如果父进程已终止，则新父进程为 PID 1），并发送信号 <code>SIGCHLD</code>。父进程需要通过调用 <code>wait4()</code> 或 <code>waitid()</code> 来获取此值，直到那时，子进程保持在僵尸状态，仍然被列出但不消耗资源。</p>
<h3 id="pids"><a class="header" href="#pids">PIDs</a></h3>
<p>PID，进程标识符，标识一个唯一的进程。在 XNU 中，<strong>PIDs</strong> 是 <strong>64 位</strong>，单调递增且 <strong>永不回绕</strong>（以避免滥用）。</p>
<h3 id="进程组会话与联盟"><a class="header" href="#进程组会话与联盟">进程组、会话与联盟</a></h3>
<p><strong>进程</strong> 可以被插入到 <strong>组</strong> 中，以便更容易地处理它们。例如，shell 脚本中的命令将处于同一进程组中，因此可以使用 kill 等方式 <strong>一起发送信号</strong>。<br />
也可以 <strong>将进程分组到会话中</strong>。当进程启动会话（<code>setsid(2)</code>）时，子进程被设置在会话内，除非它们启动自己的会话。</p>
<p>联盟是另一种在 Darwin 中分组进程的方式。加入联盟的进程可以访问池资源，共享账本或面对 Jetsam。联盟有不同的角色：领导者、XPC 服务、扩展。</p>
<h3 id="凭证与角色"><a class="header" href="#凭证与角色">凭证与角色</a></h3>
<p>每个进程持有 <strong>凭证</strong>，以 <strong>识别其在系统中的权限</strong>。每个进程将有一个主要的 <code>uid</code> 和一个主要的 <code>gid</code>（尽管可能属于多个组）。<br />
如果二进制文件具有 <code>setuid/setgid</code> 位，也可以更改用户和组 ID。<br />
有几个函数可以 <strong>设置新的 uids/gids</strong>。</p>
<p>系统调用 <strong><code>persona</code></strong> 提供了一组 <strong>替代</strong> 的 <strong>凭证</strong>。采用角色会同时假设其 uid、gid 和组成员资格。在 <a href="https://github.com/apple/darwin-xnu/blob/main/bsd/sys/persona.h"><strong>源代码</strong></a> 中可以找到该结构：</p>
<pre><code class="language-c">struct kpersona_info { uint32_t persona_info_version;
uid_t    persona_id; /* overlaps with UID */
int      persona_type;
gid_t    persona_gid;
uint32_t persona_ngroups;
gid_t    persona_groups[NGROUPS];
uid_t    persona_gmuid;
char     persona_name[MAXLOGNAME + 1];

/* TODO: MAC policies?! */
}
</code></pre>
<h2 id="线程基本信息"><a class="header" href="#线程基本信息">线程基本信息</a></h2>
<ol>
<li><strong>POSIX 线程 (pthreads):</strong> macOS 支持 POSIX 线程（<code>pthreads</code>），这是 C/C++ 的标准线程 API 的一部分。macOS 中 pthreads 的实现位于 <code>/usr/lib/system/libsystem_pthread.dylib</code>，该库来自公开可用的 <code>libpthread</code> 项目。此库提供创建和管理线程所需的函数。</li>
<li><strong>创建线程:</strong> <code>pthread_create()</code> 函数用于创建新线程。内部，该函数调用 <code>bsdthread_create()</code>，这是一个特定于 XNU 内核的低级系统调用（macOS 基于的内核）。此系统调用接受来自 <code>pthread_attr</code>（属性）的各种标志，这些标志指定线程行为，包括调度策略和堆栈大小。</li>
</ol>
<ul>
<li><strong>默认堆栈大小:</strong> 新线程的默认堆栈大小为 512 KB，足以满足典型操作，但如果需要更多或更少的空间，可以通过线程属性进行调整。</li>
</ul>
<ol start="3">
<li><strong>线程初始化:</strong> <code>__pthread_init()</code> 函数在线程设置过程中至关重要，利用 <code>env[]</code> 参数解析环境变量，这些变量可以包含有关堆栈位置和大小的详细信息。</li>
</ol>
<h4 id="macos-中的线程终止"><a class="header" href="#macos-中的线程终止">macOS 中的线程终止</a></h4>
<ol>
<li><strong>退出线程:</strong> 线程通常通过调用 <code>pthread_exit()</code> 来终止。此函数允许线程干净地退出，执行必要的清理，并允许线程将返回值发送回任何加入者。</li>
<li><strong>线程清理:</strong> 调用 <code>pthread_exit()</code> 后，将调用 <code>pthread_terminate()</code> 函数，该函数处理所有相关线程结构的移除。它会释放 Mach 线程端口（Mach 是 XNU 内核中的通信子系统），并调用 <code>bsdthread_terminate</code>，这是一个移除与线程相关的内核级结构的系统调用。</li>
</ol>
<h4 id="同步机制"><a class="header" href="#同步机制">同步机制</a></h4>
<p>为了管理对共享资源的访问并避免竞争条件，macOS 提供了几种同步原语。这些在多线程环境中对于确保数据完整性和系统稳定性至关重要：</p>
<ol>
<li><strong>互斥锁:</strong></li>
</ol>
<ul>
<li><strong>常规互斥锁 (签名: 0x4D555458):</strong> 标准互斥锁，内存占用为 60 字节（56 字节用于互斥锁，4 字节用于签名）。</li>
<li><strong>快速互斥锁 (签名: 0x4d55545A):</strong> 类似于常规互斥锁，但经过优化以实现更快的操作，大小也为 60 字节。</li>
</ul>
<ol start="2">
<li><strong>条件变量:</strong></li>
</ol>
<ul>
<li>用于等待某些条件发生，大小为 44 字节（40 字节加 4 字节签名）。</li>
<li><strong>条件变量属性 (签名: 0x434e4441):</strong> 条件变量的配置属性，大小为 12 字节。</li>
</ul>
<ol start="3">
<li><strong>一次变量 (签名: 0x4f4e4345):</strong></li>
</ol>
<ul>
<li>确保一段初始化代码仅执行一次。其大小为 12 字节。</li>
</ul>
<ol start="4">
<li><strong>读写锁:</strong></li>
</ol>
<ul>
<li>允许多个读者或一个写者同时访问，促进对共享数据的高效访问。</li>
<li><strong>读写锁 (签名: 0x52574c4b):</strong> 大小为 196 字节。</li>
<li><strong>读写锁属性 (签名: 0x52574c41):</strong> 读写锁的属性，大小为 20 字节。</li>
</ul>
<p>{% hint style="success" %}
这些对象的最后 4 字节用于检测溢出。
{% endhint %}</p>
<h3 id="线程局部变量-tlv"><a class="header" href="#线程局部变量-tlv">线程局部变量 (TLV)</a></h3>
<p><strong>线程局部变量 (TLV)</strong> 在 Mach-O 文件（macOS 中可执行文件的格式）的上下文中用于声明特定于 <strong>每个线程</strong> 的变量，以便在多线程应用程序中使用。这确保每个线程都有自己独立的变量实例，提供了一种避免冲突和维护数据完整性的方法，而无需像互斥锁那样的显式同步机制。</p>
<p>在 C 及相关语言中，可以使用 <strong><code>__thread</code></strong> 关键字声明线程局部变量。以下是它在您的示例中的工作方式：</p>
<pre><code class="language-c">cCopy code__thread int tlv_var;

void main (int argc, char **argv){
tlv_var = 10;
}
</code></pre>
<p>这个片段将 <code>tlv_var</code> 定义为线程局部变量。每个运行此代码的线程将拥有自己的 <code>tlv_var</code>，一个线程对 <code>tlv_var</code> 的更改不会影响另一个线程中的 <code>tlv_var</code>。</p>
<p>在 Mach-O 二进制文件中，与线程局部变量相关的数据被组织成特定的部分：</p>
<ul>
<li><strong><code>__DATA.__thread_vars</code></strong>：此部分包含有关线程局部变量的元数据，如它们的类型和初始化状态。</li>
<li><strong><code>__DATA.__thread_bss</code></strong>：此部分用于未显式初始化的线程局部变量。它是为零初始化数据保留的内存的一部分。</li>
</ul>
<p>Mach-O 还提供了一个特定的 API，称为 <strong><code>tlv_atexit</code></strong>，用于管理线程退出时的线程局部变量。此 API 允许您 <strong>注册析构函数</strong>——在线程终止时清理线程局部数据的特殊函数。</p>
<h3 id="线程优先级"><a class="header" href="#线程优先级">线程优先级</a></h3>
<p>理解线程优先级涉及查看操作系统如何决定运行哪些线程以及何时运行。这一决定受到分配给每个线程的优先级级别的影响。在 macOS 和类 Unix 系统中，这通过 <code>nice</code>、<code>renice</code> 和服务质量 (QoS) 类等概念来处理。</p>
<h4 id="nice-和-renice"><a class="header" href="#nice-和-renice">Nice 和 Renice</a></h4>
<ol>
<li><strong>Nice:</strong></li>
</ol>
<ul>
<li>进程的 <code>nice</code> 值是一个影响其优先级的数字。每个进程的 nice 值范围从 -20（最高优先级）到 19（最低优先级）。进程创建时的默认 nice 值通常为 0。</li>
<li>较低的 nice 值（接近 -20）使进程变得更加“自私”，相对于其他具有较高 nice 值的进程，给予其更多的 CPU 时间。</li>
</ul>
<ol start="2">
<li><strong>Renice:</strong></li>
</ol>
<ul>
<li><code>renice</code> 是一个用于更改已运行进程的 nice 值的命令。这可以用于动态调整进程的优先级，基于新的 nice 值增加或减少其 CPU 时间分配。</li>
<li>例如，如果一个进程暂时需要更多的 CPU 资源，您可以使用 <code>renice</code> 降低其 nice 值。</li>
</ul>
<h4 id="服务质量-qos-类"><a class="header" href="#服务质量-qos-类">服务质量 (QoS) 类</a></h4>
<p>QoS 类是处理线程优先级的更现代的方法，特别是在支持 <strong>Grand Central Dispatch (GCD)</strong> 的系统中。QoS 类允许开发人员根据任务的重要性或紧急性将工作 <strong>分类</strong> 为不同级别。macOS 根据这些 QoS 类自动管理线程优先级：</p>
<ol>
<li><strong>用户交互：</strong></li>
</ol>
<ul>
<li>此类用于当前与用户交互或需要立即结果以提供良好用户体验的任务。这些任务被赋予最高优先级，以保持界面的响应性（例如，动画或事件处理）。</li>
</ul>
<ol start="2">
<li><strong>用户启动：</strong></li>
</ol>
<ul>
<li>用户启动并期望立即结果的任务，例如打开文档或单击需要计算的按钮。这些任务优先级较高，但低于用户交互。</li>
</ul>
<ol start="3">
<li><strong>实用程序：</strong></li>
</ol>
<ul>
<li>这些任务是长时间运行的，通常显示进度指示器（例如，下载文件、导入数据）。它们的优先级低于用户启动的任务，不需要立即完成。</li>
</ul>
<ol start="4">
<li><strong>后台：</strong></li>
</ol>
<ul>
<li>此类用于在后台运行且对用户不可见的任务。这些可以是索引、同步或备份等任务。它们的优先级最低，对系统性能的影响最小。</li>
</ul>
<p>使用 QoS 类，开发人员不需要管理确切的优先级数字，而是专注于任务的性质，系统会相应优化 CPU 资源。</p>
<p>此外，还有不同的 <strong>线程调度策略</strong>，用于指定调度器将考虑的一组调度参数。这可以通过 <code>thread_policy_[set/get]</code> 来完成。这在竞争条件攻击中可能会很有用。</p>
<h2 id="macos-进程滥用-1"><a class="header" href="#macos-进程滥用-1">MacOS 进程滥用</a></h2>
<p>MacOS 像其他操作系统一样，提供多种方法和机制供 <strong>进程交互、通信和共享数据</strong>。虽然这些技术对系统的高效运行至关重要，但也可能被威胁行为者滥用以 <strong>执行恶意活动</strong>。</p>
<h3 id="库注入"><a class="header" href="#库注入">库注入</a></h3>
<p>库注入是一种技术，攻击者 <strong>强制进程加载恶意库</strong>。一旦注入，库将在目标进程的上下文中运行，攻击者将获得与该进程相同的权限和访问权限。</p>
<p>{% content-ref url="macos-library-injection/" %}
<a href="macos-library-injection/">macos-library-injection</a>
{% endcontent-ref %}</p>
<h3 id="函数钩子"><a class="header" href="#函数钩子">函数钩子</a></h3>
<p>函数钩子涉及 <strong>拦截软件代码中的函数调用</strong> 或消息。通过钩住函数，攻击者可以 <strong>修改进程的行为</strong>、观察敏感数据，甚至控制执行流程。</p>
<p>{% content-ref url="macos-function-hooking.md" %}
<a href="macos-function-hooking.html">macos-function-hooking.md</a>
{% endcontent-ref %}</p>
<h3 id="进程间通信"><a class="header" href="#进程间通信">进程间通信</a></h3>
<p>进程间通信 (IPC) 指的是不同方法，通过这些方法，独立进程 <strong>共享和交换数据</strong>。虽然 IPC 对许多合法应用程序至关重要，但也可能被滥用以破坏进程隔离、泄露敏感信息或执行未经授权的操作。</p>
<p>{% content-ref url="macos-ipc-inter-process-communication/" %}
<a href="macos-ipc-inter-process-communication/">macos-ipc-inter-process-communication</a>
{% endcontent-ref %}</p>
<h3 id="electron-应用程序注入"><a class="header" href="#electron-应用程序注入">Electron 应用程序注入</a></h3>
<p>使用特定环境变量执行的 Electron 应用程序可能容易受到进程注入的攻击：</p>
<p>{% content-ref url="macos-electron-applications-injection.md" %}
<a href="macos-electron-applications-injection.html">macos-electron-applications-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="chromium-注入"><a class="header" href="#chromium-注入">Chromium 注入</a></h3>
<p>可以使用标志 <code>--load-extension</code> 和 <code>--use-fake-ui-for-media-stream</code> 执行 <strong>浏览器中的中间人攻击</strong>，从而窃取击键、流量、cookie，在页面中注入脚本...：</p>
<p>{% content-ref url="macos-chromium-injection.md" %}
<a href="macos-chromium-injection.html">macos-chromium-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="脏-nib"><a class="header" href="#脏-nib">脏 NIB</a></h3>
<p>NIB 文件 <strong>定义用户界面 (UI) 元素</strong> 及其在应用程序中的交互。然而，它们可以 <strong>执行任意命令</strong>，而且 <strong>Gatekeeper 不会阻止</strong> 已执行的应用程序在 <strong>NIB 文件被修改</strong> 后再次执行。因此，它们可以用于使任意程序执行任意命令：</p>
<p>{% content-ref url="macos-dirty-nib.md" %}
<a href="macos-dirty-nib.html">macos-dirty-nib.md</a>
{% endcontent-ref %}</p>
<h3 id="java-应用程序注入"><a class="header" href="#java-应用程序注入">Java 应用程序注入</a></h3>
<p>可以滥用某些 Java 功能（如 <strong><code>_JAVA_OPTS</code></strong> 环境变量）使 Java 应用程序执行 <strong>任意代码/命令</strong>。</p>
<p>{% content-ref url="macos-java-apps-injection.md" %}
<a href="macos-java-apps-injection.html">macos-java-apps-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="net-应用程序注入"><a class="header" href="#net-应用程序注入">.Net 应用程序注入</a></h3>
<p>可以通过 <strong>滥用 .Net 调试功能</strong>（不受 macOS 保护，如运行时强化）向 .Net 应用程序注入代码。</p>
<p>{% content-ref url="macos-.net-applications-injection.md" %}
<a href="macos-.net-applications-injection.html">macos-.net-applications-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="perl-注入"><a class="header" href="#perl-注入">Perl 注入</a></h3>
<p>检查不同选项以使 Perl 脚本执行任意代码：</p>
<p>{% content-ref url="macos-perl-applications-injection.md" %}
<a href="macos-perl-applications-injection.html">macos-perl-applications-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="ruby-注入"><a class="header" href="#ruby-注入">Ruby 注入</a></h3>
<p>也可以滥用 Ruby 环境变量使任意脚本执行任意代码：</p>
<p>{% content-ref url="macos-ruby-applications-injection.md" %}
<a href="macos-ruby-applications-injection.html">macos-ruby-applications-injection.md</a>
{% endcontent-ref %}</p>
<h3 id="python-注入"><a class="header" href="#python-注入">Python 注入</a></h3>
<p>如果环境变量 <strong><code>PYTHONINSPECT</code></strong> 被设置，Python 进程将在完成后进入 Python CLI。也可以使用 <strong><code>PYTHONSTARTUP</code></strong> 指定在交互会话开始时执行的 Python 脚本。<br />
但是，请注意，当 <strong><code>PYTHONINSPECT</code></strong> 创建交互会话时，<strong><code>PYTHONSTARTUP</code></strong> 脚本不会被执行。</p>
<p>其他环境变量如 <strong><code>PYTHONPATH</code></strong> 和 <strong><code>PYTHONHOME</code></strong> 也可能对使 Python 命令执行任意代码有用。</p>
<p>请注意，使用 <strong><code>pyinstaller</code></strong> 编译的可执行文件即使在使用嵌入式 Python 运行时也不会使用这些环境变量。</p>
<p>{% hint style="danger" %}
总体而言，我找不到通过滥用环境变量使 Python 执行任意代码的方法。<br />
然而，大多数人使用 <strong>Hombrew</strong> 安装 Python，这将在 <strong>可写位置</strong> 为默认管理员用户安装 Python。您可以通过类似的方式劫持它：</p>
<pre><code class="language-bash">mv /opt/homebrew/bin/python3 /opt/homebrew/bin/python3.old
cat &gt; /opt/homebrew/bin/python3 &lt;&lt;EOF
#!/bin/bash
# Extra hijack code
/opt/homebrew/bin/python3.old "$@"
EOF
chmod +x /opt/homebrew/bin/python3
</code></pre>
<p>即使<strong>root</strong>在运行python时也会运行此代码。<br />
{% endhint %}</p>
<h2 id="检测"><a class="header" href="#检测">检测</a></h2>
<h3 id="shield"><a class="header" href="#shield">Shield</a></h3>
<p><a href="https://theevilbit.github.io/shield/"><strong>Shield</strong></a> (<a href="https://github.com/theevilbit/Shield"><strong>Github</strong></a>) 是一个开源应用程序，可以<strong>检测和阻止进程注入</strong>操作：</p>
<ul>
<li>使用<strong>环境变量</strong>：它将监控以下环境变量的存在：<strong><code>DYLD_INSERT_LIBRARIES</code></strong>、<strong><code>CFNETWORK_LIBRARY_PATH</code></strong>、<strong><code>RAWCAMERA_BUNDLE_PATH</code><strong>和</strong><code>ELECTRON_RUN_AS_NODE</code></strong></li>
<li>使用**<code>task_for_pid</code><strong>调用：查找一个进程何时想要获取</strong>另一个进程的任务端口**，这允许在该进程中注入代码。</li>
<li><strong>Electron应用参数</strong>：有人可以使用**<code>--inspect</code><strong>、</strong><code>--inspect-brk</code><strong>和</strong><code>--remote-debugging-port</code>**命令行参数以调试模式启动Electron应用，从而向其注入代码。</li>
<li>使用<strong>符号链接</strong>或<strong>硬链接</strong>：通常最常见的滥用是<strong>以我们的用户权限放置一个链接</strong>，并<strong>指向更高权限</strong>的位置。对于硬链接和符号链接，检测非常简单。如果创建链接的进程与目标文件具有<strong>不同的权限级别</strong>，我们会创建一个<strong>警报</strong>。不幸的是，在符号链接的情况下，无法阻止，因为我们在创建之前没有关于链接目标的信息。这是Apple的EndpointSecurity框架的一个限制。</li>
</ul>
<h3 id="其他进程发出的调用"><a class="header" href="#其他进程发出的调用">其他进程发出的调用</a></h3>
<p>在<a href="https://knight.sc/reverse%20engineering/2019/04/15/detecting-task-modifications.html"><strong>这篇博客文章</strong></a>中，您可以找到如何使用函数**<code>task_name_for_pid</code><strong>获取关于其他</strong>进程在一个进程中注入代码**的信息，然后获取关于该其他进程的信息。</p>
<p>请注意，要调用该函数，您需要与运行该进程的<strong>相同uid</strong>或<strong>root</strong>（并且它返回关于该进程的信息，而不是注入代码的方法）。</p>
<h2 id="参考"><a class="header" href="#参考">参考</a></h2>
<ul>
<li><a href="https://theevilbit.github.io/shield/">https://theevilbit.github.io/shield/</a></li>
<li><a href="https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f">https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f</a></li>
</ul>
<p>{% hint style="success" %}
学习和实践AWS黑客攻击：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客攻击：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>上关注我们。</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github库提交PR分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-privilege-escalation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-dirty-nib.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-privilege-escalation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-dirty-nib.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
