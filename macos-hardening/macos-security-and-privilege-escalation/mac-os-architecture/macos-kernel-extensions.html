<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS Kernel Extensions &amp; Debugging</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-内核扩展与调试"><a class="header" href="#macos-内核扩展与调试">macOS 内核扩展与调试</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p>内核扩展（Kexts）是 <strong>以 <code>.kext</code></strong> 扩展名的 <strong>包</strong>，它们 <strong>直接加载到 macOS 内核空间</strong>，为主操作系统提供额外功能。</p>
<h3 id="要求"><a class="header" href="#要求">要求</a></h3>
<p>显然，这非常强大，以至于 <strong>加载内核扩展</strong> 是 <strong>复杂的</strong>。内核扩展必须满足以下 <strong>要求</strong> 才能被加载：</p>
<ul>
<li>当 <strong>进入恢复模式</strong> 时，必须 <strong>允许加载内核扩展</strong>：</li>
</ul>
<figure><img src="../../../.gitbook/assets/image (327).png" alt=""><figcaption></figcaption></figure>
<ul>
<li>内核扩展必须 <strong>使用内核代码签名证书签名</strong>，该证书只能由 <strong>Apple</strong> 授予。谁将详细审查公司及其所需的原因。</li>
<li>内核扩展还必须 <strong>经过公证</strong>，Apple 将能够检查其是否含有恶意软件。</li>
<li>然后，<strong>root</strong> 用户是唯一可以 <strong>加载内核扩展</strong> 的人，包内的文件必须 <strong>属于 root</strong>。</li>
<li>在上传过程中，包必须准备在 <strong>受保护的非 root 位置</strong>：<code>/Library/StagedExtensions</code>（需要 <code>com.apple.rootless.storage.KernelExtensionManagement</code> 授权）。</li>
<li>最后，当尝试加载时，用户将 <a href="https://developer.apple.com/library/archive/technotes/tn2459/_index.html"><strong>收到确认请求</strong></a>，如果接受，计算机必须 <strong>重启</strong> 以加载它。</li>
</ul>
<h3 id="加载过程"><a class="header" href="#加载过程">加载过程</a></h3>
<p>在 Catalina 中是这样的：有趣的是，<strong>验证</strong> 过程发生在 <strong>用户空间</strong>。然而，只有具有 <strong><code>com.apple.private.security.kext-management</code></strong> 授权的应用程序可以 <strong>请求内核加载扩展</strong>：<code>kextcache</code>、<code>kextload</code>、<code>kextutil</code>、<code>kextd</code>、<code>syspolicyd</code></p>
<ol>
<li><strong><code>kextutil</code></strong> CLI <strong>启动</strong> 加载扩展的 <strong>验证</strong> 过程</li>
</ol>
<ul>
<li>它将通过发送 <strong>Mach 服务</strong> 与 <strong><code>kextd</code></strong> 进行通信。</li>
</ul>
<ol start="2">
<li><strong><code>kextd</code></strong> 将检查多个内容，例如 <strong>签名</strong></li>
</ol>
<ul>
<li>它将与 <strong><code>syspolicyd</code></strong> 进行通信以 <strong>检查</strong> 扩展是否可以 <strong>加载</strong>。</li>
</ul>
<ol start="3">
<li><strong><code>syspolicyd</code></strong> 将 <strong>提示</strong> <strong>用户</strong> 如果扩展尚未被加载。</li>
</ol>
<ul>
<li><strong><code>syspolicyd</code></strong> 将结果报告给 <strong><code>kextd</code></strong></li>
</ul>
<ol start="4">
<li><strong><code>kextd</code></strong> 最终将能够 <strong>告诉内核加载</strong> 扩展</li>
</ol>
<p>如果 <strong><code>kextd</code></strong> 不可用，<strong><code>kextutil</code></strong> 可以执行相同的检查。</p>
<h3 id="枚举已加载的-kexts"><a class="header" href="#枚举已加载的-kexts">枚举（已加载的 kexts）</a></h3>
<pre><code class="language-bash"># Get loaded kernel extensions
kextstat

# Get dependencies of the kext number 22
kextstat | grep " 22 " | cut -c2-5,50- | cut -d '(' -f1
</code></pre>
<h2 id="kernelcache"><a class="header" href="#kernelcache">Kernelcache</a></h2>
<p>{% hint style="danger" %}
尽管内核扩展预计位于 <code>/System/Library/Extensions/</code> 中，但如果你去这个文件夹，你 <strong>不会找到任何二进制文件</strong>。这是因为 <strong>kernelcache</strong>，为了反向工程一个 <code>.kext</code>，你需要找到获取它的方法。
{% endhint %}</p>
<p><strong>kernelcache</strong> 是 <strong>XNU 内核的预编译和预链接版本</strong>，以及基本的设备 <strong>驱动程序</strong> 和 <strong>内核扩展</strong>。它以 <strong>压缩</strong> 格式存储，并在启动过程中解压到内存中。kernelcache 通过提供一个准备就绪的内核和关键驱动程序的版本，促进了 <strong>更快的启动时间</strong>，减少了在启动时动态加载和链接这些组件所需的时间和资源。</p>
<h3 id="local-kerlnelcache"><a class="header" href="#local-kerlnelcache">Local Kerlnelcache</a></h3>
<p>在 iOS 中，它位于 <strong><code>/System/Library/Caches/com.apple.kernelcaches/kernelcache</code></strong>，在 macOS 中可以通过以下命令找到：<strong><code>find / -name "kernelcache" 2&gt;/dev/null</code></strong> <br />
在我的 macOS 中，我找到了它在：</p>
<ul>
<li><code>/System/Volumes/Preboot/1BAEB4B5-180B-4C46-BD53-51152B7D92DA/boot/DAD35E7BC0CDA79634C20BD1BD80678DFB510B2AAD3D25C1228BB34BCD0A711529D3D571C93E29E1D0C1264750FA043F/System/Library/Caches/com.apple.kernelcaches/kernelcache</code></li>
</ul>
<h4 id="img4"><a class="header" href="#img4">IMG4</a></h4>
<p>IMG4 文件格式是苹果在其 iOS 和 macOS 设备中用于安全 <strong>存储和验证固件</strong> 组件（如 <strong>kernelcache</strong>）的容器格式。IMG4 格式包括一个头部和多个标签，封装了不同的数据片段，包括实际的有效载荷（如内核或引导加载程序）、签名和一组清单属性。该格式支持加密验证，允许设备在执行固件组件之前确认其真实性和完整性。</p>
<p>它通常由以下组件组成：</p>
<ul>
<li><strong>有效载荷 (IM4P)</strong>：</li>
<li>通常是压缩的 (LZFSE4, LZSS, …)</li>
<li>可选加密</li>
<li><strong>清单 (IM4M)</strong>：</li>
<li>包含签名</li>
<li>额外的键/值字典</li>
<li><strong>恢复信息 (IM4R)</strong>：</li>
<li>也称为 APNonce</li>
<li>防止某些更新的重放</li>
<li>可选：通常不会找到</li>
</ul>
<p>解压 Kernelcache：</p>
<pre><code class="language-bash"># img4tool (https://github.com/tihmstar/img4tool
img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e

# pyimg4 (https://github.com/m1stadev/PyIMG4)
pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
</code></pre>
<h3 id="下载"><a class="header" href="#下载">下载 </a></h3>
<ul>
<li><a href="https://github.com/dortania/KdkSupportPkg/releases"><strong>KernelDebugKit Github</strong></a></li>
</ul>
<p>在 <a href="https://github.com/dortania/KdkSupportPkg/releases">https://github.com/dortania/KdkSupportPkg/releases</a> 可以找到所有的内核调试工具包。你可以下载它，挂载它，用 <a href="https://www.mothersruin.com/software/SuspiciousPackage/get.html">Suspicious Package</a> 工具打开它，访问 <strong><code>.kext</code></strong> 文件夹并 <strong>提取它</strong>。</p>
<p>使用以下命令检查符号：</p>
<pre><code class="language-bash">nm -a ~/Downloads/Sandbox.kext/Contents/MacOS/Sandbox | wc -l
</code></pre>
<ul>
<li><a href="https://theapplewiki.com/wiki/Firmware/Mac/14.x"><strong>theapplewiki.com</strong></a><strong>,</strong> <a href="https://ipsw.me/"><strong>ipsw.me</strong></a><strong>,</strong> <a href="https://www.theiphonewiki.com/"><strong>theiphonewiki.com</strong></a></li>
</ul>
<p>有时，Apple 会发布带有 <strong>symbols</strong> 的 <strong>kernelcache</strong>。您可以通过这些页面上的链接下载一些带有符号的固件。固件将包含 <strong>kernelcache</strong> 以及其他文件。</p>
<p>要 <strong>extract</strong> 文件，首先将扩展名从 <code>.ipsw</code> 更改为 <code>.zip</code> 并 <strong>unzip</strong> 它。</p>
<p>提取固件后，您将获得一个文件，如：<strong><code>kernelcache.release.iphone14</code></strong>。它是 <strong>IMG4</strong> 格式，您可以使用以下工具提取有趣的信息：</p>
<p><a href="https://github.com/m1stadev/PyIMG4"><strong>pyimg4</strong></a><strong>:</strong></p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
</code></pre>
<p>{% endcode %}</p>
<p><a href="https://github.com/tihmstar/img4tool"><strong>img4tool</strong></a><strong>:</strong></p>
<pre><code class="language-bash">img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
</code></pre>
<h3 id="inspecting-kernelcache"><a class="header" href="#inspecting-kernelcache">Inspecting kernelcache</a></h3>
<p>检查 kernelcache 是否具有符号</p>
<pre><code class="language-bash">nm -a kernelcache.release.iphone14.e | wc -l
</code></pre>
<p>通过这个，我们现在可以<strong>提取所有扩展</strong>或<strong>您感兴趣的一个：</strong></p>
<pre><code class="language-bash"># List all extensions
kextex -l kernelcache.release.iphone14.e
## Extract com.apple.security.sandbox
kextex -e com.apple.security.sandbox kernelcache.release.iphone14.e

# Extract all
kextex_all kernelcache.release.iphone14.e

# Check the extension for symbols
nm -a binaries/com.apple.security.sandbox | wc -l
</code></pre>
<h2 id="调试"><a class="header" href="#调试">调试</a></h2>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://www.makeuseof.com/how-to-enable-third-party-kernel-extensions-apple-silicon-mac/">https://www.makeuseof.com/how-to-enable-third-party-kernel-extensions-apple-silicon-mac/</a></li>
<li><a href="https://www.youtube.com/watch?v=hGKOskSiaQo">https://www.youtube.com/watch?v=hGKOskSiaQo</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-iokit.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-kernel-vulnerabilities.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-iokit.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/mac-os-architecture/macos-kernel-vulnerabilities.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
