<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS MACF - Mandatory Access Control Framework</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-macf"><a class="header" href="#macos-macf">macOS MACF</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="åŸºæœ¬ä¿¡æ¯"><a class="header" href="#åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</a></h2>
<p><strong>MACF</strong> ä»£è¡¨ <strong>å¼ºåˆ¶è®¿é—®æ§åˆ¶æ¡†æ¶</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªå†…ç½®äºæ“ä½œç³»ç»Ÿçš„å®‰å…¨ç³»ç»Ÿï¼Œæ—¨åœ¨å¸®åŠ©ä¿æŠ¤æ‚¨çš„è®¡ç®—æœºã€‚å®ƒé€šè¿‡è®¾ç½® <strong>å…³äºè°æˆ–ä»€ä¹ˆå¯ä»¥è®¿é—®ç³»ç»ŸæŸäº›éƒ¨åˆ†çš„ä¸¥æ ¼è§„åˆ™</strong>ï¼ˆä¾‹å¦‚æ–‡ä»¶ã€åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿèµ„æºï¼‰æ¥å·¥ä½œã€‚é€šè¿‡è‡ªåŠ¨æ‰§è¡Œè¿™äº›è§„åˆ™ï¼ŒMACF ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å’Œè¿›ç¨‹å¯ä»¥æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œä»è€Œé™ä½æœªç»æˆæƒè®¿é—®æˆ–æ¶æ„æ´»åŠ¨çš„é£é™©ã€‚</p>
<p>è¯·æ³¨æ„ï¼ŒMACF å¹¶ä¸çœŸæ­£åšå‡ºä»»ä½•å†³ç­–ï¼Œå› ä¸ºå®ƒåªæ˜¯ <strong>æ‹¦æˆª</strong> æ“ä½œï¼Œå®ƒå°†å†³ç­–ç•™ç»™å®ƒè°ƒç”¨çš„ <strong>ç­–ç•¥æ¨¡å—</strong>ï¼ˆå†…æ ¸æ‰©å±•ï¼‰ï¼Œå¦‚ <code>AppleMobileFileIntegrity.kext</code>ã€<code>Quarantine.kext</code>ã€<code>Sandbox.kext</code>ã€<code>TMSafetyNet.kext</code> å’Œ <code>mcxalr.kext</code>ã€‚</p>
<h3 id="æµç¨‹"><a class="header" href="#æµç¨‹">æµç¨‹</a></h3>
<ol>
<li>è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨/mach trap</li>
<li>å†…æ ¸å†…éƒ¨è°ƒç”¨ç›¸å…³å‡½æ•°</li>
<li>å‡½æ•°è°ƒç”¨ MACF</li>
<li>MACF æ£€æŸ¥è¯·æ±‚åœ¨å…¶ç­–ç•¥ä¸­æŒ‚é’©è¯¥å‡½æ•°çš„ç­–ç•¥æ¨¡å—</li>
<li>MACF è°ƒç”¨ç›¸å…³ç­–ç•¥</li>
<li>ç­–ç•¥æŒ‡ç¤ºæ˜¯å¦å…è®¸æˆ–æ‹’ç»è¯¥æ“ä½œ</li>
</ol>
<p>{% hint style="danger" %}
è‹¹æœæ˜¯å”¯ä¸€å¯ä»¥ä½¿ç”¨ MAC æ¡†æ¶ KPI çš„å…¬å¸ã€‚
{% endhint %}</p>
<h3 id="æ ‡ç­¾"><a class="header" href="#æ ‡ç­¾">æ ‡ç­¾</a></h3>
<p>MACF ä½¿ç”¨ <strong>æ ‡ç­¾</strong>ï¼Œç„¶åç­–ç•¥æ£€æŸ¥æ˜¯å¦åº”æˆäºˆæŸäº›è®¿é—®æƒé™ã€‚æ ‡ç­¾ç»“æ„å£°æ˜çš„ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/_label.h">è¿™é‡Œ</a> æ‰¾åˆ°ï¼Œè¯¥ä»£ç éšååœ¨ <strong><code>struct ucred</code></strong> ä¸­ä½¿ç”¨ï¼Œè§ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/sys/ucred.h#L86"><strong>è¿™é‡Œ</strong></a> çš„ <strong><code>cr_label</code></strong> éƒ¨åˆ†ã€‚æ ‡ç­¾åŒ…å«æ ‡å¿—å’Œå¯ç”± <strong>MACF ç­–ç•¥åˆ†é…æŒ‡é’ˆ</strong> çš„å¤šä¸ª <strong>æ§½</strong>ã€‚ä¾‹å¦‚ï¼ŒSandbox å°†æŒ‡å‘å®¹å™¨é…ç½®æ–‡ä»¶ã€‚</p>
<h2 id="macf-ç­–ç•¥"><a class="header" href="#macf-ç­–ç•¥">MACF ç­–ç•¥</a></h2>
<p>MACF ç­–ç•¥å®šä¹‰äº† <strong>åœ¨æŸäº›å†…æ ¸æ“ä½œä¸­åº”ç”¨çš„è§„åˆ™å’Œæ¡ä»¶</strong>ã€‚ </p>
<p>å†…æ ¸æ‰©å±•å¯ä»¥é…ç½® <code>mac_policy_conf</code> ç»“æ„ï¼Œç„¶åé€šè¿‡è°ƒç”¨ <code>mac_policy_register</code> æ³¨å†Œå®ƒã€‚ä» <a href="https://opensource.apple.com/source/xnu/xnu-2050.18.24/security/mac_policy.h.auto.html">è¿™é‡Œ</a>ï¼š</p>
<pre><code class="language-c">#define mpc_t	struct mac_policy_conf *

/**
@brief Mac policy configuration

This structure specifies the configuration information for a
MAC policy module.  A policy module developer must supply
a short unique policy name, a more descriptive full name, a list of label
namespaces and count, a pointer to the registered enty point operations,
any load time flags, and optionally, a pointer to a label slot identifier.

The Framework will update the runtime flags (mpc_runtime_flags) to
indicate that the module has been registered.

If the label slot identifier (mpc_field_off) is NULL, the Framework
will not provide label storage for the policy.  Otherwise, the
Framework will store the label location (slot) in this field.

The mpc_list field is used by the Framework and should not be
modified by policies.
*/
/* XXX - reorder these for better aligment on 64bit platforms */
struct mac_policy_conf {
const char		*mpc_name;		/** policy name */
const char		*mpc_fullname;		/** full name */
const char		**mpc_labelnames;	/** managed label namespaces */
unsigned int		 mpc_labelname_count;	/** number of managed label namespaces */
struct mac_policy_ops	*mpc_ops;		/** operation vector */
int			 mpc_loadtime_flags;	/** load time flags */
int			*mpc_field_off;		/** label slot */
int			 mpc_runtime_flags;	/** run time flags */
mpc_t			 mpc_list;		/** List reference */
void			*mpc_data;		/** module data */
};
</code></pre>
<p>å¾ˆå®¹æ˜“é€šè¿‡æ£€æŸ¥å¯¹ <code>mac_policy_register</code> çš„è°ƒç”¨æ¥è¯†åˆ«é…ç½®è¿™äº›ç­–ç•¥çš„å†…æ ¸æ‰©å±•ã€‚æ­¤å¤–ï¼Œé€šè¿‡æ£€æŸ¥æ‰©å±•çš„åæ±‡ç¼–ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°ä½¿ç”¨çš„ <code>mac_policy_conf</code> ç»“æ„ã€‚</p>
<p>è¯·æ³¨æ„ï¼ŒMACF ç­–ç•¥ä¹Ÿå¯ä»¥<strong>åŠ¨æ€</strong>æ³¨å†Œå’Œæ³¨é”€ã€‚</p>
<p><code>mac_policy_conf</code> çš„ä¸»è¦å­—æ®µä¹‹ä¸€æ˜¯ <strong><code>mpc_ops</code></strong>ã€‚è¯¥å­—æ®µæŒ‡å®šäº†ç­–ç•¥æ„Ÿå…´è¶£çš„æ“ä½œã€‚è¯·æ³¨æ„ï¼Œå®ƒä»¬æœ‰æ•°ç™¾ä¸ªï¼Œå› æ­¤å¯ä»¥å°†æ‰€æœ‰æ“ä½œç½®ä¸ºé›¶ï¼Œç„¶åä»…é€‰æ‹©ç­–ç•¥æ„Ÿå…´è¶£çš„æ“ä½œã€‚ä» <a href="https://opensource.apple.com/source/xnu/xnu-2050.18.24/security/mac_policy.h.auto.html">è¿™é‡Œ</a>:</p>
<pre><code class="language-c">struct mac_policy_ops {
mpo_audit_check_postselect_t		*mpo_audit_check_postselect;
mpo_audit_check_preselect_t		*mpo_audit_check_preselect;
mpo_bpfdesc_label_associate_t		*mpo_bpfdesc_label_associate;
mpo_bpfdesc_label_destroy_t		*mpo_bpfdesc_label_destroy;
mpo_bpfdesc_label_init_t		*mpo_bpfdesc_label_init;
mpo_bpfdesc_check_receive_t		*mpo_bpfdesc_check_receive;
mpo_cred_check_label_update_execve_t	*mpo_cred_check_label_update_execve;
mpo_cred_check_label_update_t		*mpo_cred_check_label_update;
[...]
</code></pre>
<p>å‡ ä¹æ‰€æœ‰çš„é’©å­åœ¨æ‹¦æˆªè¿™äº›æ“ä½œæ—¶éƒ½ä¼šè¢« MACF å›è°ƒã€‚ç„¶è€Œï¼Œ<strong><code>mpo_policy_*</code></strong> é’©å­æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œå› ä¸º <code>mpo_hook_policy_init()</code> æ˜¯åœ¨æ³¨å†Œæ—¶è°ƒç”¨çš„å›è°ƒï¼ˆå³åœ¨ <code>mac_policy_register()</code> ä¹‹åï¼‰ï¼Œè€Œ <code>mpo_hook_policy_initbsd()</code> æ˜¯åœ¨ BSD å­ç³»ç»Ÿæ­£ç¡®åˆå§‹åŒ–åè¿›è¡Œæ™šæœŸæ³¨å†Œæ—¶è°ƒç”¨çš„ã€‚</p>
<p>æ­¤å¤–ï¼Œ<strong><code>mpo_policy_syscall</code></strong> é’©å­å¯ä»¥è¢«ä»»ä½• kext æ³¨å†Œï¼Œä»¥æš´éœ²ä¸€ä¸ªç§æœ‰çš„ <strong>ioctl</strong> é£æ ¼è°ƒç”¨ <strong>æ¥å£</strong>ã€‚ç„¶åï¼Œç”¨æˆ·å®¢æˆ·ç«¯å°†èƒ½å¤Ÿè°ƒç”¨ <code>mac_syscall</code> (#381)ï¼Œå¹¶æŒ‡å®š <strong>ç­–ç•¥åç§°</strong>ã€ä¸€ä¸ªæ•´æ•° <strong>ä»£ç </strong> å’Œå¯é€‰çš„ <strong>å‚æ•°</strong> ä½œä¸ºå‚æ•°ã€‚<br />
ä¾‹å¦‚ï¼Œ<strong><code>Sandbox.kext</code></strong> ç»å¸¸ä½¿ç”¨è¿™ä¸ªã€‚</p>
<p>æ£€æŸ¥ kext çš„ <strong><code>__DATA.__const*</code></strong> å¯ä»¥è¯†åˆ«åœ¨æ³¨å†Œç­–ç•¥æ—¶ä½¿ç”¨çš„ <code>mac_policy_ops</code> ç»“æ„ã€‚å¯ä»¥æ‰¾åˆ°å®ƒï¼Œå› ä¸ºå®ƒçš„æŒ‡é’ˆåœ¨ <code>mpo_policy_conf</code> å†…éƒ¨çš„ä¸€ä¸ªåç§»é‡å¤„ï¼Œå¹¶ä¸”å› ä¸ºè¯¥åŒºåŸŸå°†æœ‰è®¸å¤š NULL æŒ‡é’ˆã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»å†…å­˜ä¸­è½¬å‚¨ç»“æ„ <strong><code>_mac_policy_list</code></strong> æ¥è·å–å·²é…ç½®ç­–ç•¥çš„ kext åˆ—è¡¨ï¼Œè¯¥ç»“æ„ä¼šéšç€æ¯ä¸ªæ³¨å†Œçš„ç­–ç•¥è€Œæ›´æ–°ã€‚</p>
<h2 id="macf-åˆå§‹åŒ–"><a class="header" href="#macf-åˆå§‹åŒ–">MACF åˆå§‹åŒ–</a></h2>
<p>MACF å¾ˆå¿«å°±ä¼šåˆå§‹åŒ–ã€‚å®ƒåœ¨ XNU çš„ <code>bootstrap_thread</code> ä¸­è®¾ç½®ï¼šåœ¨ <code>ipc_bootstrap</code> ä¹‹åè°ƒç”¨ <code>mac_policy_init()</code>ï¼Œè¯¥å‡½æ•°åˆå§‹åŒ– <code>mac_policy_list</code>ï¼Œéšåè°ƒç”¨ <code>mac_policy_initmach()</code>ã€‚é™¤äº†å…¶ä»–åŠŸèƒ½å¤–ï¼Œè¯¥å‡½æ•°å°†è·å–æ‰€æœ‰åœ¨å…¶ Info.plist ä¸­å…·æœ‰ <code>AppleSecurityExtension</code> é”®çš„ Apple kextï¼Œå¦‚ <code>ALF.kext</code>ã€<code>AppleMobileFileIntegrity.kext</code>ã€<code>Quarantine.kext</code>ã€<code>Sandbox.kext</code> å’Œ <code>TMSafetyNet.kext</code> å¹¶åŠ è½½å®ƒä»¬ã€‚</p>
<h2 id="macf-å›è°ƒ"><a class="header" href="#macf-å›è°ƒ">MACF å›è°ƒ</a></h2>
<p>åœ¨ä»£ç ä¸­å¸¸å¸¸å¯ä»¥æ‰¾åˆ°å¯¹ MACF çš„å›è°ƒå®šä¹‰ï¼Œä¾‹å¦‚ï¼š<strong><code>#if CONFIG_MAC</code></strong> æ¡ä»¶å—ã€‚æ­¤å¤–ï¼Œåœ¨è¿™äº›å—å†…å¯ä»¥æ‰¾åˆ°å¯¹ <code>mac_proc_check*</code> çš„è°ƒç”¨ï¼Œè¯¥è°ƒç”¨ä¼šè°ƒç”¨ MACF æ¥ <strong>æ£€æŸ¥æƒé™</strong> ä»¥æ‰§è¡ŒæŸäº›æ“ä½œã€‚æ­¤å¤–ï¼ŒMACF å›è°ƒçš„æ ¼å¼ä¸ºï¼š<strong><code>mac_&lt;object&gt;_&lt;opType&gt;_opName</code></strong>ã€‚</p>
<p>å¯¹è±¡æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š<code>bpfdesc</code>ã€<code>cred</code>ã€<code>file</code>ã€<code>proc</code>ã€<code>vnode</code>ã€<code>mount</code>ã€<code>devfs</code>ã€<code>ifnet</code>ã€<code>inpcb</code>ã€<code>mbuf</code>ã€<code>ipq</code>ã€<code>pipe</code>ã€<code>sysv[msg/msq/shm/sem]</code>ã€<code>posix[shm/sem]</code>ã€<code>socket</code>ã€<code>kext</code>ã€‚<br />
<code>opType</code> é€šå¸¸æ˜¯ checkï¼Œç”¨äºå…è®¸æˆ–æ‹’ç»è¯¥æ“ä½œã€‚ç„¶è€Œï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ° notifyï¼Œè¿™å°†å…è®¸ kext å¯¹ç»™å®šæ“ä½œåšå‡ºååº”ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_mman.c#L621">https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_mman.c#L621</a> ä¸­æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<pre class="language-c"><code class="lang-c">int
mmap(proc_t p, struct mmap_args *uap, user_addr_t *retval)
{
[...]
#if CONFIG_MACF
<strong>			error = mac_file_check_mmap(vfs_context_ucred(ctx),
</strong>			    fp->fp_glob, prot, flags, file_pos + pageoff,
&#x26;maxprot);
if (error) {
(void)vnode_put(vp);
goto bad;
}
#endif /* MAC */
[...]
</code></pre>
<p>ç„¶åï¼Œå¯ä»¥åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_file.c#L174">https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_file.c#L174</a> ä¸­æ‰¾åˆ° <code>mac_file_check_mmap</code> çš„ä»£ç ã€‚</p>
<pre><code class="language-c">mac_file_check_mmap(struct ucred *cred, struct fileglob *fg, int prot,
int flags, uint64_t offset, int *maxprot)
{
int error;
int maxp;

maxp = *maxprot;
MAC_CHECK(file_check_mmap, cred, fg, NULL, prot, flags, offset, &amp;maxp);
if ((maxp | *maxprot) != *maxprot) {
panic("file_check_mmap increased max protections");
}
*maxprot = maxp;
return error;
}
</code></pre>
<p>è°ƒç”¨ <code>MAC_CHECK</code> å®çš„ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L261">https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L261</a> æ‰¾åˆ°ã€‚</p>
<pre><code class="language-c">/*
* MAC_CHECK performs the designated check by walking the policy
* module list and checking with each as to how it feels about the
* request.  Note that it returns its value via 'error' in the scope
* of the caller.
*/
#define MAC_CHECK(check, args...) do {                              \
error = 0;                                                      \
MAC_POLICY_ITERATE({                                            \
if (mpc-&gt;mpc_ops-&gt;mpo_ ## check != NULL) {              \
DTRACE_MACF3(mac__call__ ## check, void *, mpc, int, error, int, MAC_ITERATE_CHECK); \
int __step_err = mpc-&gt;mpc_ops-&gt;mpo_ ## check (args); \
DTRACE_MACF2(mac__rslt__ ## check, void *, mpc, int, __step_err); \
error = mac_error_select(__step_err, error);         \
}                                                           \
});                                                             \
} while (0)
</code></pre>
<p>å°†éå†æ‰€æœ‰æ³¨å†Œçš„ mac ç­–ç•¥ï¼Œè°ƒç”¨å®ƒä»¬çš„å‡½æ•°å¹¶å°†è¾“å‡ºå­˜å‚¨åœ¨ error å˜é‡ä¸­ï¼Œè¯¥å˜é‡ä»…å¯é€šè¿‡æˆåŠŸä»£ç çš„ <code>mac_error_select</code> è¿›è¡Œè¦†ç›–ï¼Œå› æ­¤å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ•´ä¸ªæ£€æŸ¥å°†å¤±è´¥ï¼Œæ“ä½œå°†ä¸è¢«å…è®¸ã€‚</p>
<p>{% hint style="success" %}
ç„¶è€Œï¼Œè¯·è®°ä½ï¼Œå¹¶éæ‰€æœ‰ MACF è°ƒç”¨ä»…ç”¨äºæ‹’ç»æ“ä½œã€‚ä¾‹å¦‚ï¼Œ<code>mac_priv_grant</code> è°ƒç”¨å® <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L274"><strong>MAC_GRANT</strong></a>ï¼Œå¦‚æœä»»ä½•ç­–ç•¥ä»¥ 0 å“åº”ï¼Œå°†æˆäºˆè¯·æ±‚çš„ç‰¹æƒï¼š</p>
<pre><code class="language-c">/*
* MAC_GRANT performs the designated check by walking the policy
* module list and checking with each as to how it feels about the
* request.  Unlike MAC_CHECK, it grants if any policies return '0',
* and otherwise returns EPERM.  Note that it returns its value via
* 'error' in the scope of the caller.
*/
#define MAC_GRANT(check, args...) do {                              \
error = EPERM;                                                  \
MAC_POLICY_ITERATE({                                            \
if (mpc-&gt;mpc_ops-&gt;mpo_ ## check != NULL) {                  \
DTRACE_MACF3(mac__call__ ## check, void *, mpc, int, error, int, MAC_ITERATE_GRANT); \
int __step_res = mpc-&gt;mpc_ops-&gt;mpo_ ## check (args); \
if (__step_res == 0) {                              \
error = 0;                                  \
}                                                   \
DTRACE_MACF2(mac__rslt__ ## check, void *, mpc, int, __step_res); \
}                                                           \
});                                                             \
} while (0)
</code></pre>
<p>{% endhint %}</p>
<h3 id="priv_check--priv_grant"><a class="header" href="#priv_check--priv_grant">priv_check &amp; priv_grant</a></h3>
<p>è¿™äº›è°ƒç”¨æ—¨åœ¨æ£€æŸ¥å’Œæä¾›åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/sys/priv.h"><strong>bsd/sys/priv.h</strong></a> ä¸­å®šä¹‰çš„ï¼ˆæ•°åä¸ªï¼‰<strong>æƒé™</strong>ã€‚<br />
ä¸€äº›å†…æ ¸ä»£ç ä¼šä» <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_priv.c"><strong>bsd/kern/kern_priv.c</strong></a> è°ƒç”¨ <code>priv_check_cred()</code>ï¼Œä½¿ç”¨è¿›ç¨‹çš„ KAuth å‡­æ®å’Œä¸€ä¸ªæƒé™ä»£ç ï¼Œè¿™å°†è°ƒç”¨ <code>mac_priv_check</code> æ¥æŸ¥çœ‹æ˜¯å¦æœ‰ä»»ä½•ç­–ç•¥<strong>æ‹’ç»</strong>æˆäºˆè¯¥æƒé™ï¼Œç„¶åè°ƒç”¨ <code>mac_priv_grant</code> æ¥æŸ¥çœ‹æ˜¯å¦æœ‰ä»»ä½•ç­–ç•¥æˆäºˆè¯¥ <code>privilege</code>ã€‚</p>
<h3 id="proc_check_syscall_unix"><a class="header" href="#proc_check_syscall_unix">proc_check_syscall_unix</a></h3>
<p>æ­¤é’©å­å…è®¸æ‹¦æˆªæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨ <code>bsd/dev/[i386|arm]/systemcalls.c</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å£°æ˜çš„å‡½æ•° <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/dev/arm/systemcalls.c#L160C1-L167C25"><code>unix_syscall</code></a>ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-c">#if CONFIG_MACF
if (__improbable(proc_syscall_filter_mask(proc) != NULL &amp;&amp; !bitstr_test(proc_syscall_filter_mask(proc), syscode))) {
error = mac_proc_check_syscall_unix(proc, syscode);
if (error) {
goto skip_syscall;
}
}
#endif /* CONFIG_MACF */
</code></pre>
<p>å°†æ£€æŸ¥è°ƒç”¨è¿›ç¨‹çš„ <strong>bitmask</strong>ï¼Œä»¥ç¡®å®šå½“å‰çš„ç³»ç»Ÿè°ƒç”¨æ˜¯å¦åº”è¯¥è°ƒç”¨ <code>mac_proc_check_syscall_unix</code>ã€‚è¿™æ˜¯å› ä¸ºç³»ç»Ÿè°ƒç”¨çš„é¢‘ç‡å¾ˆé«˜ï¼Œå› æ­¤é¿å…æ¯æ¬¡éƒ½è°ƒç”¨ <code>mac_proc_check_syscall_unix</code> æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå‡½æ•° <code>proc_set_syscall_filter_mask()</code>ï¼Œç”¨äºè®¾ç½®è¿›ç¨‹ä¸­çš„ bitmask ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯ç”± Sandbox è°ƒç”¨ä»¥åœ¨æ²™ç®±è¿›ç¨‹ä¸Šè®¾ç½®æ©ç çš„ã€‚</p>
<h2 id="æš´éœ²çš„-macf-ç³»ç»Ÿè°ƒç”¨"><a class="header" href="#æš´éœ²çš„-macf-ç³»ç»Ÿè°ƒç”¨">æš´éœ²çš„ MACF ç³»ç»Ÿè°ƒç”¨</a></h2>
<p>å¯ä»¥é€šè¿‡åœ¨ <a href="https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac.h#L151">security/mac.h</a> ä¸­å®šä¹‰çš„ä¸€äº›ç³»ç»Ÿè°ƒç”¨ä¸ MACF è¿›è¡Œäº¤äº’ï¼š</p>
<pre><code class="language-c">/*
* Extended non-POSIX.1e interfaces that offer additional services
* available from the userland and kernel MAC frameworks.
*/
#ifdef __APPLE_API_PRIVATE
__BEGIN_DECLS
int      __mac_execve(char *fname, char **argv, char **envv, mac_t _label);
int      __mac_get_fd(int _fd, mac_t _label);
int      __mac_get_file(const char *_path, mac_t _label);
int      __mac_get_link(const char *_path, mac_t _label);
int      __mac_get_pid(pid_t _pid, mac_t _label);
int      __mac_get_proc(mac_t _label);
int      __mac_set_fd(int _fildes, const mac_t _label);
int      __mac_set_file(const char *_path, mac_t _label);
int      __mac_set_link(const char *_path, mac_t _label);
int      __mac_mount(const char *type, const char *path, int flags, void *data,
struct mac *label);
int      __mac_get_mount(const char *path, struct mac *label);
int      __mac_set_proc(const mac_t _label);
int      __mac_syscall(const char *_policyname, int _call, void *_arg);
__END_DECLS
#endif /*__APPLE_API_PRIVATE*/
</code></pre>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://newosxbook.com/home.html"><strong>*OS å†…éƒ¨ç»“æ„ ç¬¬ä¸‰å·</strong></a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <strong>ä¸Šå…³æ³¨æˆ‘ä»¬</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-amfi-applemobilefileintegrity.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-code-signing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-amfi-applemobilefileintegrity.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-code-signing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
