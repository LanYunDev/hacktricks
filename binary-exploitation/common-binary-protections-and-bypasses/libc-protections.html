<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Libc Protections</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="libc-protections"><a class="header" href="#libc-protections">Libc Protections</a></h1>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>telegram 群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="chunk-alignment-enforcement"><a class="header" href="#chunk-alignment-enforcement">Chunk Alignment Enforcement</a></h2>
<p><strong>Malloc</strong> 在 <strong>8 字节 (32 位) 或 16 字节 (64 位) 分组</strong> 中分配内存。这意味着在 32 位系统中，块的结束应与 <strong>0x8</strong> 对齐，而在 64 位系统中应与 <strong>0x0</strong> 对齐。安全特性检查每个块在使用 bin 中的指针之前是否在这些特定位置 <strong>正确对齐</strong>。</p>
<h3 id="security-benefits"><a class="header" href="#security-benefits">Security Benefits</a></h3>
<p>在 64 位系统中强制块对齐显著增强了 Malloc 的安全性，通过 <strong>将假块的放置限制为每 16 个地址中的 1 个</strong>。这使得利用攻击变得更加复杂，尤其是在用户对输入值的控制有限的情况下，使攻击更复杂且更难成功执行。</p>
<ul>
<li><strong>对 __malloc_hook 的 Fastbin 攻击</strong></li>
</ul>
<p>Malloc 中的新对齐规则也阻止了涉及 <code>__malloc_hook</code> 的经典攻击。之前，攻击者可以操纵块大小以 <strong>覆盖此函数指针</strong> 并获得 <strong>代码执行</strong>。现在，严格的对齐要求确保此类操纵不再可行，关闭了一个常见的利用途径，增强了整体安全性。</p>
<h2 id="pointer-mangling-on-fastbins-and-tcache"><a class="header" href="#pointer-mangling-on-fastbins-and-tcache">Pointer Mangling on fastbins and tcache</a></h2>
<p><strong>Pointer Mangling</strong> 是一种安全增强，用于保护内存管理操作中的 <strong>fastbin 和 tcache Fd 指针</strong>。该技术有助于防止某些类型的内存利用战术，特别是那些不需要泄漏内存信息或直接相对于已知位置操纵内存位置的战术（相对 <strong>覆盖</strong>）。</p>
<p>该技术的核心是一个模糊公式：</p>
<p><strong><code>New_Ptr = (L &gt;&gt; 12) XOR P</code></strong></p>
<ul>
<li><strong>L</strong> 是指针的 <strong>存储位置</strong>。</li>
<li><strong>P</strong> 是实际的 <strong>fastbin/tcache Fd 指针</strong>。</li>
</ul>
<p>在 XOR 操作之前，将存储位置 (L) 向右移动 12 位的位移是至关重要的。这种操作解决了内存地址最低有效 12 位的确定性特性所固有的漏洞，这些位通常由于系统架构限制而可预测。通过移动位，预测部分被排除在外，从而增强了新混淆指针的随机性，从而保护免受依赖这些位可预测性的利用。</p>
<p>这个混淆指针利用了 <strong>地址空间布局随机化 (ASLR)</strong> 提供的现有随机性，ASLR 随机化程序使用的地址，使攻击者难以预测进程的内存布局。</p>
<p><strong>解混淆</strong> 指针以检索原始地址涉及使用相同的 XOR 操作。在这里，混淆指针被视为公式中的 P，当与未更改的存储位置 (L) 进行 XOR 时，结果是原始指针被揭示。这种混淆和解混淆的对称性确保系统能够高效地编码和解码指针，而不会产生显著的开销，同时大大提高了对操纵内存指针攻击的安全性。</p>
<h3 id="security-benefits-1"><a class="header" href="#security-benefits-1">Security Benefits</a></h3>
<p>指针混淆旨在 <strong>防止堆管理中的部分和完整指针覆盖</strong>，这是安全性的重要增强。此功能以多种方式影响利用技术：</p>
<ol>
<li><strong>防止字节相对覆盖</strong>：之前，攻击者可以更改指针的一部分以 <strong>在不知道确切地址的情况下将堆块重定向到不同位置</strong>，这种技术在无泄漏的 <strong>House of Roman</strong> 利用中显而易见。通过指针混淆，此类相对覆盖 <strong>在没有堆泄漏的情况下现在需要暴力破解</strong>，大大降低了成功的可能性。</li>
<li><strong>增加 Tcache Bin/Fastbin 攻击的难度</strong>：通过操纵 fastbin 或 tcache 条目来覆盖函数指针（如 <code>__malloc_hook</code>）的常见攻击受到阻碍。例如，一种攻击可能涉及泄漏 LibC 地址，将一个块释放到 tcache bin 中，然后覆盖 Fd 指针以将其重定向到 <code>__malloc_hook</code> 以进行任意代码执行。通过指针混淆，这些指针必须正确混淆，<strong>需要堆泄漏以进行准确操纵</strong>，从而提高了利用门槛。</li>
<li><strong>在非堆位置需要堆泄漏</strong>：在非堆区域（如栈、.bss 段或 PLT/GOT）创建假块现在也 <strong>需要堆泄漏</strong>，因为需要指针混淆。这增加了利用这些区域的复杂性，类似于操纵 LibC 地址的要求。</li>
<li><strong>泄漏堆地址变得更加困难</strong>：指针混淆限制了 Fd 指针在 fastbin 和 tcache bins 中作为堆地址泄漏源的有效性。然而，未排序、小型和大型 bins 中的指针仍然未混淆，因此仍可用于泄漏地址。这一变化迫使攻击者探索这些 bins 以获取可利用的信息，尽管某些技术仍可能允许在泄漏之前解混淆指针，但有一定的限制。</li>
</ol>
<h3 id="通过堆泄漏解混淆指针"><a class="header" href="#通过堆泄漏解混淆指针"><strong>通过堆泄漏解混淆指针</strong></a></h3>
<p>{% hint style="danger" %}
有关该过程的更好解释 <a href="https://maxwelldulin.com/BlogPost?post=5445977088"><strong>请查看原始帖子</strong></a>。
{% endhint %}</p>
<h3 id="algorithm-overview"><a class="header" href="#algorithm-overview">Algorithm Overview</a></h3>
<p>用于混淆和解混淆指针的公式是： </p>
<p><strong><code>New_Ptr = (L &gt;&gt; 12) XOR P</code></strong></p>
<p>其中 <strong>L</strong> 是存储位置，<strong>P</strong> 是 Fd 指针。当 <strong>L</strong> 向右移动 12 位时，它暴露了 <strong>P</strong> 的最高有效位，由于 <strong>XOR</strong> 的特性，当位与自身进行 XOR 时输出为 0。</p>
<p><strong>算法中的关键步骤：</strong></p>
<ol>
<li><strong>最初泄漏最高有效位</strong>：通过将移位后的 <strong>L</strong> 与 <strong>P</strong> 进行 XOR，您有效地获得了 <strong>P</strong> 的前 12 位，因为移位部分的 <strong>L</strong> 将为零，留下 <strong>P</strong> 的相应位不变。</li>
<li><strong>恢复指针位</strong>：由于 XOR 是可逆的，知道结果和一个操作数可以让您计算另一个操作数。这个特性用于通过将已知的位集与混淆指针的部分进行逐步 XOR 来推导 <strong>P</strong> 的整个位集。</li>
<li><strong>迭代解混淆</strong>：该过程重复进行，每次使用从上一步中发现的 <strong>P</strong> 的新位来解码混淆指针的下一个部分，直到所有位都被恢复。</li>
<li><strong>处理确定性位</strong>：由于移位，<strong>L</strong> 的最后 12 位丢失，但它们是确定性的，可以在后处理时重建。</li>
</ol>
<p>您可以在这里找到该算法的实现：<a href="https://github.com/mdulin2/mangle">https://github.com/mdulin2/mangle</a></p>
<h2 id="pointer-guard"><a class="header" href="#pointer-guard">Pointer Guard</a></h2>
<p>指针保护是一种在 glibc 中使用的利用缓解技术，用于保护存储的函数指针，特别是那些通过库调用（如 <code>atexit()</code>）注册的指针。该保护涉及通过将指针与存储在线程数据中的秘密 (<code>fs:0x30</code>) 进行 XOR 并应用位旋转来打乱指针。该机制旨在防止攻击者通过覆盖函数指针来劫持控制流。</p>
<h3 id="通过泄漏绕过指针保护"><a class="header" href="#通过泄漏绕过指针保护"><strong>通过泄漏绕过指针保护</strong></a></h3>
<ol>
<li><strong>理解指针保护操作</strong>：指针的打乱（混淆）是使用 <code>PTR_MANGLE</code> 宏完成的，该宏将指针与 64 位秘密进行 XOR，然后执行 0x11 位的左旋转。恢复原始指针的反向操作由 <code>PTR_DEMANGLE</code> 处理。</li>
<li><strong>攻击策略</strong>：该攻击基于已知明文的方法，攻击者需要知道指针的原始版本和混淆版本，以推导用于混淆的秘密。</li>
<li><strong>利用已知明文：</strong></li>
</ol>
<ul>
<li><strong>识别固定函数指针</strong>：通过检查 glibc 源代码或初始化的函数指针表（如 <code>__libc_pthread_functions</code>），攻击者可以找到可预测的函数指针。</li>
<li><strong>计算秘密</strong>：使用已知的函数指针（如 <code>__pthread_attr_destroy</code>）及其来自函数指针表的混淆版本，可以通过反向旋转（右旋转）混淆指针，然后与函数的地址进行 XOR 来计算秘密。</li>
</ul>
<ol start="4">
<li><strong>替代明文</strong>：攻击者还可以尝试使用已知值（如 0 或 -1）混淆指针，以查看这些是否在内存中产生可识别的模式，当这些模式在内存转储中找到时，可能会揭示秘密。</li>
<li><strong>实际应用</strong>：在计算出秘密后，攻击者可以以受控的方式操纵指针，从而在了解 libc 基地址和能够读取任意内存位置的情况下，基本上绕过多线程应用中的指针保护。</li>
</ol>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://maxwelldulin.com/BlogPost?post=5445977088">https://maxwelldulin.com/BlogPost?post=5445977088</a></li>
<li><a href="https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1">https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1</a></li>
</ul>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>telegram 群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../binary-exploitation/common-binary-protections-and-bypasses/cet-and-shadow-stack.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../binary-exploitation/common-binary-protections-and-bypasses/memory-tagging-extension-mte.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../binary-exploitation/common-binary-protections-and-bypasses/cet-and-shadow-stack.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../binary-exploitation/common-binary-protections-and-bypasses/memory-tagging-extension-mte.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
