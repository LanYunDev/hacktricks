<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WWW2Exec - atexit()</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="www2exec---atexit-tlså­˜å‚¨å’Œå…¶ä»–æ··æ·†æŒ‡é’ˆ"><a class="header" href="#www2exec---atexit-tlså­˜å‚¨å’Œå…¶ä»–æ··æ·†æŒ‡é’ˆ">WWW2Exec - atexit(), TLSå­˜å‚¨å’Œå…¶ä»–æ··æ·†æŒ‡é’ˆ</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒHackTricks</summary>
<ul>
<li>æŸ¥çœ‹<a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discordç¾¤ç»„</strong></a>æˆ–<a href="https://t.me/peass"><strong>Telegramç¾¤ç»„</strong></a>æˆ–<strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>å’Œ<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="__atexitç»“æ„"><a class="header" href="#__atexitç»“æ„"><strong>__atexitç»“æ„</strong></a></h2>
<p>{% hint style="danger" %}
ç°åœ¨åˆ©ç”¨è¿™ä¸ªæ˜¯éå¸¸<strong>å¥‡æ€ªçš„ï¼</strong>
{% endhint %}</p>
<p><strong><code>atexit()</code><strong>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ<strong>å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚<strong>è¿™äº›</strong>å‡½æ•°</strong>å°†åœ¨æ‰§è¡Œ</strong><code>exit()</code><strong>æˆ–</strong>main</strong>çš„<strong>è¿”å›</strong>æ—¶è¢«<strong>æ‰§è¡Œ</strong>ã€‚<br />
å¦‚æœä½ èƒ½<strong>ä¿®æ”¹</strong>è¿™äº›<strong>å‡½æ•°</strong>çš„<strong>åœ°å€</strong>ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªshellcodeï¼Œä¾‹å¦‚ï¼Œä½ å°†<strong>è·å¾—å¯¹</strong>è¯¥<strong>è¿›ç¨‹çš„æ§åˆ¶æƒ</strong>ï¼Œä½†è¿™ç›®å‰æ›´å¤æ‚ã€‚<br />
ç›®å‰è¦æ‰§è¡Œçš„<strong>å‡½æ•°çš„åœ°å€</strong>è¢«<strong>éšè—</strong>åœ¨å‡ ä¸ªç»“æ„åï¼Œæœ€ç»ˆæŒ‡å‘çš„åœ°å€ä¸æ˜¯å‡½æ•°çš„åœ°å€ï¼Œè€Œæ˜¯<strong>ç”¨XORåŠ å¯†</strong>å’Œç”¨<strong>éšæœºå¯†é’¥</strong>è¿›è¡Œä½ç§»ã€‚å› æ­¤ï¼Œç›®å‰è¿™ä¸ªæ”»å‡»å‘é‡åœ¨x86å’Œx64_86ä¸Š<strong>ä¸æ˜¯å¾ˆæœ‰ç”¨</strong>ã€‚<br />
<strong>åŠ å¯†å‡½æ•°</strong>æ˜¯**<code>PTR_MANGLE</code><strong>ã€‚<strong>å…¶ä»–æ¶æ„</strong>å¦‚m68kã€mips32ã€mips64ã€aarch64ã€armã€hppa...<strong>ä¸å®ç°åŠ å¯†</strong>å‡½æ•°ï¼Œå› ä¸ºå®ƒ</strong>è¿”å›ä¸è¾“å…¥ç›¸åŒ**çš„å†…å®¹ã€‚å› æ­¤ï¼Œè¿™äº›æ¶æ„å¯ä»¥é€šè¿‡è¿™ä¸ªå‘é‡è¿›è¡Œæ”»å‡»ã€‚</p>
<p>ä½ å¯ä»¥åœ¨<a href="https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html">https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html</a>æ‰¾åˆ°å…³äºè¿™ä¸ªå¦‚ä½•å·¥ä½œçš„æ·±å…¥è§£é‡Šã€‚</p>
<h2 id="link_map"><a class="header" href="#link_map">link_map</a></h2>
<p>å¦‚<a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link_map-structure"><strong>åœ¨è¿™ç¯‡æ–‡ç« ä¸­</strong></a>æ‰€è¿°ï¼Œå¦‚æœç¨‹åºé€šè¿‡<code>return</code>æˆ–<code>exit()</code>é€€å‡ºï¼Œå®ƒå°†è¿è¡Œ<code>__run_exit_handlers()</code>ï¼Œè¿™å°†è°ƒç”¨æ³¨å†Œçš„ææ„å‡½æ•°ã€‚</p>
<p>{% hint style="danger" %}
å¦‚æœç¨‹åºé€šè¿‡**<code>_exit()</code><strong>å‡½æ•°é€€å‡ºï¼Œå®ƒå°†è°ƒç”¨</strong><code>exit</code>ç³»ç»Ÿè°ƒç”¨**ï¼Œè€Œé€€å‡ºå¤„ç†ç¨‹åºå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œä¸ºäº†ç¡®è®¤<code>__run_exit_handlers()</code>è¢«æ‰§è¡Œï¼Œä½ å¯ä»¥åœ¨å®ƒä¸Šé¢è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ã€‚
{% endhint %}</p>
<p>é‡è¦ä»£ç æ˜¯(<a href="https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131">source</a>):</p>
<pre><code class="language-c">ElfW(Dyn) *fini_array = map-&gt;l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map-&gt;l_addr + fini_array-&gt;d_un.d_ptr);
size_t sz = (map-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- &gt; 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l-&gt;l_addr of our structure
}
</code></pre>
<p>æ³¨æ„å¦‚ä½• <code>map -&gt; l_addr + fini_array -&gt; d_un.d_ptr</code> è¢«ç”¨æ¥<strong>è®¡ç®—</strong>è¦è°ƒç”¨çš„<strong>å‡½æ•°æ•°ç»„</strong>çš„ä½ç½®ã€‚</p>
<p>æœ‰<strong>å‡ ç§é€‰æ‹©</strong>ï¼š</p>
<ul>
<li>è¦†ç›– <code>map-&gt;l_addr</code> çš„å€¼ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ª<strong>å‡çš„ <code>fini_array</code></strong>ï¼Œå…¶ä¸­åŒ…å«æ‰§è¡Œä»»æ„ä»£ç çš„æŒ‡ä»¤</li>
<li>è¦†ç›– <code>l_info[DT_FINI_ARRAY]</code> å’Œ <code>l_info[DT_FINI_ARRAYSZ]</code> æ¡ç›®ï¼ˆåœ¨å†…å­˜ä¸­å¤§è‡´æ˜¯è¿ç»­çš„ï¼‰ï¼Œä½¿å®ƒä»¬<strong>æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„ <code>Elf64_Dyn</code></strong> ç»“æ„ï¼Œè¿™å°†ä½¿**<code>array</code>å†æ¬¡æŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„å†…å­˜**åŒºåŸŸã€‚ </li>
<li><a href="https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell"><strong>è¿™ä¸ªå†™ä½œ</strong></a> ç”¨ä¸€ä¸ªå—æ§å†…å­˜ä¸­çš„åœ°å€è¦†ç›– <code>l_info[DT_FINI_ARRAY]</code>ï¼Œè¯¥å†…å­˜ä½äº <code>.bss</code> ä¸­ï¼ŒåŒ…å«ä¸€ä¸ªå‡çš„ <code>fini_array</code>ã€‚è¿™ä¸ªå‡æ•°ç»„<strong>é¦–å…ˆåŒ…å«ä¸€ä¸ª</strong> <a href="../rop-return-oriented-programing/ret2lib/one-gadget.html"><strong>one gadget</strong></a> <strong>åœ°å€</strong>ï¼Œå°†è¢«æ‰§è¡Œï¼Œç„¶åæ˜¯è¿™ä¸ª<strong>å‡æ•°ç»„</strong>çš„åœ°å€ä¸**<code>map-&gt;l_addr</code><strong>çš„</strong>å·®å€¼**ï¼Œä½¿å¾— <code>*array</code> æŒ‡å‘å‡æ•°ç»„ã€‚</li>
<li>æ ¹æ®è¯¥æŠ€æœ¯çš„ä¸»è¦å¸–å­å’Œ<a href="https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet"><strong>è¿™ä¸ªå†™ä½œ</strong></a>ï¼Œld.so åœ¨æ ˆä¸Šç•™ä¸‹ä¸€ä¸ªæŒ‡å‘ ld.so ä¸­äºŒè¿›åˆ¶ <code>link_map</code> çš„æŒ‡é’ˆã€‚é€šè¿‡ä»»æ„å†™å…¥ï¼Œå¯ä»¥è¦†ç›–å®ƒå¹¶ä½¿å…¶æŒ‡å‘ä¸€ä¸ªç”±æ”»å‡»è€…æ§åˆ¶çš„å‡ <code>fini_array</code>ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <a href="../rop-return-oriented-programing/ret2lib/one-gadget.html"><strong>one gadget</strong></a> çš„åœ°å€ï¼Œä¾‹å¦‚ã€‚</li>
</ul>
<p>åœ¨å‰é¢çš„ä»£ç ä¹‹åï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å¦ä¸€ä¸ªæœ‰è¶£çš„ä»£ç éƒ¨åˆ†ï¼š</p>
<pre><code class="language-c">/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map-&gt;l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map-&gt;l_addr + fini-&gt;d_un.d_ptr));
}
</code></pre>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è¦†ç›–æŒ‡å‘ä¼ªé€ çš„ <code>ElfW(Dyn)</code> ç»“æ„çš„ <code>map-&gt;l_info[DT_FINI]</code> çš„å€¼ã€‚æŸ¥æ‰¾ <a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link_map-structure"><strong>æ›´å¤šä¿¡æ¯è¿™é‡Œ</strong></a>ã€‚</p>
<h2 id="tls-storage-dtor_list-åœ¨-__run_exit_handlers-ä¸­çš„è¦†ç›–"><a class="header" href="#tls-storage-dtor_list-åœ¨-__run_exit_handlers-ä¸­çš„è¦†ç›–">TLS-Storage dtor_list åœ¨ <strong><code>__run_exit_handlers</code></strong> ä¸­çš„è¦†ç›–</a></h2>
<p>æ­£å¦‚ <a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor_list-overwrite"><strong>è¿™é‡Œè§£é‡Šçš„</strong></a>ï¼Œå¦‚æœç¨‹åºé€šè¿‡ <code>return</code> æˆ– <code>exit()</code> é€€å‡ºï¼Œå®ƒå°†æ‰§è¡Œ <strong><code>__run_exit_handlers()</code></strong>ï¼Œè¯¥å‡½æ•°å°†è°ƒç”¨ä»»ä½•æ³¨å†Œçš„ææ„å‡½æ•°ã€‚</p>
<p>æ¥è‡ª <code>_run_exit_handlers()</code> çš„ä»£ç ï¼š</p>
<pre><code class="language-c">/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&amp;__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
</code></pre>
<p><strong><code>__call_tls_dtors()</code></strong> çš„ä»£ç ï¼š</p>
<pre><code class="language-c">typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur-&gt;func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list-&gt;next;		// next dtor_list structure
func (cur-&gt;obj);
[...]
}
}
</code></pre>
<p>å¯¹äº**<code>tls_dtor_list</code><strong>ä¸­æ¯ä¸ªæ³¨å†Œçš„å‡½æ•°ï¼Œå®ƒå°†ä»</strong><code>cur-&gt;func</code><strong>ä¸­è§£ç æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨å‚æ•°</strong><code>cur-&gt;obj</code>**è°ƒç”¨å®ƒã€‚</p>
<p>ä½¿ç”¨è¿™ä¸ª<a href="https://github.com/bata24/gef"><strong>GEFçš„åˆ†æ”¯</strong></a>ä¸­çš„**<code>tls</code><strong>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Š</strong><code>dtor_list</code><strong>éå¸¸</strong>æ¥è¿‘<strong>äº</strong>stack canary<strong>å’Œ</strong>PTR_MANGLE cookie**ã€‚å› æ­¤ï¼Œé€šè¿‡å¯¹å…¶è¿›è¡Œæº¢å‡ºï¼Œå°†æœ‰å¯èƒ½<strong>è¦†ç›–</strong>è¯¥<strong>cookie</strong>å’Œ<strong>stack canary</strong>ã€‚<br />
è¦†ç›–PTR_MANGLE cookieåï¼Œé€šè¿‡å°†å…¶è®¾ç½®ä¸º0x00ï¼Œå¯ä»¥<strong>ç»•è¿‡<code>PTR_DEMANLE</code>å‡½æ•°</strong>ï¼Œè¿™æ„å‘³ç€ç”¨äºè·å–çœŸå®åœ°å€çš„**<code>xor</code><strong>åªæ˜¯é…ç½®çš„åœ°å€ã€‚ç„¶åï¼Œé€šè¿‡å†™å…¥</strong><code>dtor_list</code><strong>ï¼Œå¯ä»¥</strong>é“¾æ¥å¤šä¸ªå‡½æ•°<strong>åŠå…¶</strong>åœ°å€<strong>å’Œ</strong>å‚æ•°**ã€‚</p>
<p>æœ€åè¯·æ³¨æ„ï¼Œå­˜å‚¨çš„æŒ‡é’ˆä¸ä»…ä¼šä¸cookieè¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œè¿˜ä¼šæ—‹è½¬17ä½ï¼š</p>
<pre><code class="language-armasm">0x00007fc390444dd4 &lt;+36&gt;:	mov    rax,QWORD PTR [rbx]      --&gt; mangled ptr
0x00007fc390444dd7 &lt;+39&gt;:	ror    rax,0x11		        --&gt; rotate of 17 bits
0x00007fc390444ddb &lt;+43&gt;:	xor    rax,QWORD PTR fs:0x30	--&gt; xor with PTR_MANGLE
</code></pre>
<p>æ‰€ä»¥åœ¨æ·»åŠ æ–°åœ°å€ä¹‹å‰ï¼Œä½ éœ€è¦è€ƒè™‘è¿™ä¸€ç‚¹ã€‚</p>
<p>åœ¨<a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor_list-overwrite"><strong>åŸå§‹å¸–å­</strong></a>ä¸­æ‰¾åˆ°ä¸€ä¸ªä¾‹å­ã€‚</p>
<h2 id="__run_exit_handlersä¸­çš„å…¶ä»–æŸåæŒ‡é’ˆ"><a class="header" href="#__run_exit_handlersä¸­çš„å…¶ä»–æŸåæŒ‡é’ˆ">**<code>__run_exit_handlers</code>**ä¸­çš„å…¶ä»–æŸåæŒ‡é’ˆ</a></h2>
<p>è¿™ä¸ªæŠ€æœ¯åœ¨<a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor_list-overwrite"><strong>è¿™é‡Œè§£é‡Š</strong></a>ï¼Œå¹¶ä¸”å†æ¬¡ä¾èµ–äºç¨‹åº<strong>é€šè¿‡è°ƒç”¨<code>return</code>æˆ–<code>exit()</code>é€€å‡º</strong>ï¼Œå› æ­¤è°ƒç”¨äº†**<code>__run_exit_handlers()</code>**ã€‚</p>
<p>è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ›´å¤šä»£ç ï¼š</p>
<pre><code class="language-c">while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur-&gt;idx &gt; 0)
{
struct exit_function *const f = &amp;cur-&gt;fns[--cur-&gt;idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f-&gt;flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f-&gt;func.on.fn;
arg = f-&gt;func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f-&gt;func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f-&gt;flavor = ef_free;
cxafct = f-&gt;func.cxa.fn;
arg = f-&gt;func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur-&gt;next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
</code></pre>
<p>å˜é‡ <code>f</code> æŒ‡å‘ <strong><code>initial</code></strong> ç»“æ„ï¼Œå…·ä½“è°ƒç”¨å“ªä¸ªå‡½æ•°å–å†³äº <code>f-&gt;flavor</code> çš„å€¼ã€‚<br />
æ ¹æ®è¯¥å€¼ï¼Œè°ƒç”¨çš„å‡½æ•°åœ°å€ä¼šåœ¨ä¸åŒçš„ä½ç½®ï¼Œä½†å®ƒå§‹ç»ˆæ˜¯ <strong>demangled</strong> çš„ã€‚</p>
<p>æ­¤å¤–ï¼Œåœ¨é€‰é¡¹ <strong><code>ef_on</code></strong> å’Œ <strong><code>ef_cxa</code></strong> ä¸­ï¼Œä¹Ÿå¯ä»¥æ§åˆ¶ä¸€ä¸ª <strong>argument</strong>ã€‚</p>
<p>å¯ä»¥åœ¨è°ƒè¯•ä¼šè¯ä¸­ä½¿ç”¨ GEF æ£€æŸ¥ <strong><code>initial</code> ç»“æ„</strong>ï¼Œå‘½ä»¤ä¸º <strong><code>gef&gt; p initial</code></strong>ã€‚</p>
<p>è¦åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦ <strong>leak æˆ–è€…æ“¦é™¤ <code>PTR_MANGLE</code>cookie</strong>ï¼Œç„¶åç”¨ <code>system('/bin/sh')</code> è¦†ç›– <code>initial</code> ä¸­çš„ <code>cxa</code> æ¡ç›®ã€‚<br />
ä½ å¯ä»¥åœ¨ <a href="https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure"><strong>å…³äºè¯¥æŠ€æœ¯çš„åŸå§‹åšå®¢æ–‡ç« </strong></a> ä¸­æ‰¾åˆ°è¿™ä¸ªä¾‹å­ã€‚</p>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../binary-exploitation/arbitrary-write-2-exec/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../binary-exploitation/arbitrary-write-2-exec/www2exec-.dtors-and-.fini_array.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../binary-exploitation/arbitrary-write-2-exec/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../binary-exploitation/arbitrary-write-2-exec/www2exec-.dtors-and-.fini_array.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
