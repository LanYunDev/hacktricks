<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Nginx</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nginx"><a class="header" href="#nginx">Nginx</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>从黑客的角度看待您的网络应用、网络和云</strong></p>
<p><strong>查找并报告具有实际商业影响的关键可利用漏洞。</strong> 使用我们 20 多个自定义工具来映射攻击面，发现让您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<h2 id="缺失的根目录"><a class="header" href="#缺失的根目录">缺失的根目录 <a href="#missing-root-location" id="missing-root-location"></a></a></h2>
<p>在配置 Nginx 服务器时，<strong>root 指令</strong>通过定义文件提供的基础目录发挥着关键作用。考虑以下示例：</p>
<pre><code class="language-bash">server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
</code></pre>
<p>在此配置中，<code>/etc/nginx</code> 被指定为根目录。此设置允许访问指定根目录中的文件，例如 <code>/hello.txt</code>。然而，重要的是要注意，仅定义了一个特定位置（<code>/hello.txt</code>）。根位置（<code>location / {...}</code>）没有配置。这一遗漏意味着根指令适用于全局，使得对根路径 <code>/</code> 的请求能够访问 <code>/etc/nginx</code> 下的文件。</p>
<p>此配置引发了一个关键的安全考虑。一个简单的 <code>GET</code> 请求，例如 <code>GET /nginx.conf</code>，可能会通过提供位于 <code>/etc/nginx/nginx.conf</code> 的 Nginx 配置文件而暴露敏感信息。将根目录设置为不那么敏感的目录，例如 <code>/etc</code>，可以减轻此风险，但仍可能允许对其他关键文件的意外访问，包括其他配置文件、访问日志，甚至用于 HTTP 基本身份验证的加密凭据。</p>
<h2 id="alias-lfi-misconfiguration"><a class="header" href="#alias-lfi-misconfiguration">Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a></a></h2>
<p>在 Nginx 的配置文件中，"location" 指令需要仔细检查。通过类似以下的配置，可能会无意中引入一种称为本地文件包含（LFI）的漏洞：</p>
<pre><code>location /imgs {
alias /path/images/;
}
</code></pre>
<p>此配置容易受到LFI攻击，因为服务器将请求如<code>/imgs../flag.txt</code>解释为尝试访问意图之外的文件，有效地解析为<code>/path/images/../flag.txt</code>。此缺陷允许攻击者从服务器的文件系统中检索不应通过网络访问的文件。</p>
<p>为了减轻此漏洞，应调整配置为：</p>
<pre><code>location /imgs/ {
alias /path/images/;
}
</code></pre>
<p>更多信息: <a href="https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/">https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/</a></p>
<p>Accunetix 测试:</p>
<pre><code>alias../ =&gt; HTTP status code 403
alias.../ =&gt; HTTP status code 404
alias../../ =&gt; HTTP status code 403
alias../../../../../../../../../../../ =&gt; HTTP status code 400
alias../ =&gt; HTTP status code 403
</code></pre>
<h2 id="不安全的路径限制"><a class="header" href="#不安全的路径限制">不安全的路径限制 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a></a></h2>
<p>查看以下页面以了解如何绕过指令，例如：</p>
<pre><code class="language-plaintext">location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
</code></pre>
<p>{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
<a href="../../pentesting-web/proxy-waf-protections-bypass.html">proxy-waf-protections-bypass.md</a>
{% endcontent-ref %}</p>
<h2 id="不安全的变量使用--http-请求分割"><a class="header" href="#不安全的变量使用--http-请求分割">不安全的变量使用 / HTTP 请求分割 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a></a></h2>
<p>{% hint style="danger" %}
易受攻击的变量 <code>$uri</code> 和 <code>$document_uri</code>，可以通过用 <code>$request_uri</code> 替换它们来修复。</p>
<p>正则表达式也可能存在漏洞，例如：</p>
<p><code>location ~ /docs/([^/])? { … $1 … }</code> - 易受攻击 </p>
<p><code>location ~ /docs/([^/\s])? { … $1 … }</code> - 不易受攻击（检查空格）</p>
<p><code>location ~ /docs/(.*)? { … $1 … }</code>  - 不易受攻击
{% endhint %}</p>
<p>Nginx 配置中的一个漏洞通过以下示例演示：</p>
<pre><code>location / {
return 302 https://example.com$uri;
}
</code></pre>
<p>在HTTP请求中，字符\r（回车）和\n（换行）表示新行字符，它们的URL编码形式表示为<code>%0d%0a</code>。在请求中包含这些字符（例如，<code>http://localhost/%0d%0aDetectify:%20clrf</code>）到一个配置错误的服务器，会导致服务器发出一个名为<code>Detectify</code>的新头。这是因为$uri变量解码了URL编码的新行字符，从而导致响应中出现意外的头：</p>
<pre><code>HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
</code></pre>
<p>了解有关 CRLF 注入和响应拆分风险的更多信息，请访问 <a href="https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/">https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/</a>。</p>
<p>此外，这种技术在 <a href="https://www.youtube.com/watch?v=gWQyWdZbdoY&amp;list=PL0xCSYnG_iTtJe2V6PQqamBF73n7-f1Nr&amp;index=77"><strong>这个演讲中解释</strong></a> 了，其中包含一些易受攻击的示例和检测机制。例如，为了从黑箱的角度检测此错误配置，您可以使用以下请求：</p>
<ul>
<li><code>https://example.com/%20X</code> - 任何 HTTP 代码</li>
<li><code>https://example.com/%20H</code> - 400 错误请求</li>
</ul>
<p>如果存在漏洞，第一个将返回，因为 "X" 是任何 HTTP 方法，第二个将返回错误，因为 H 不是有效的方法。因此，服务器将接收到类似于 <code>GET / H HTTP/1.1</code> 的内容，这将触发错误。</p>
<p>另一个检测示例是：</p>
<ul>
<li><code>http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x</code> - 任何 HTTP 代码</li>
<li><code>http://company.tld/%20HTTP/1.1%0D%0AHost:%20x</code> - 400 错误请求</li>
</ul>
<p>在该演讲中发现的一些易受攻击的配置是：</p>
<ul>
<li>注意 <strong><code>$uri</code></strong> 在最终 URL 中是如何设置的</li>
</ul>
<pre><code>location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
</code></pre>
<ul>
<li>注意**<code>$uri</code>**再次出现在URL中（这次在一个参数内）</li>
</ul>
<pre><code>location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&amp;context=$1&amp;native_uri=$uri break;
proxy_pass http://$back;
</code></pre>
<ul>
<li>现在在 AWS S3</li>
</ul>
<pre><code>location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
</code></pre>
<h3 id="any-variable"><a class="header" href="#any-variable">Any variable</a></h3>
<p>发现<strong>用户提供的数据</strong>在某些情况下可能被视为<strong>Nginx 变量</strong>。这种行为的原因仍然有些模糊，但并不罕见，也不容易验证。这个异常在HackerOne的安全报告中被强调，可以在<a href="https://hackerone.com/reports/370094">这里</a>查看。对错误消息的进一步调查导致识别出它在<a href="https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365">Nginx代码库的SSI过滤模块</a>中的发生，确定服务器端包含（SSI）是根本原因。</p>
<p>要<strong>检测此错误配置</strong>，可以执行以下命令，该命令涉及设置引用头以测试变量打印：</p>
<pre><code class="language-bash">$ curl -H ‘Referer: bar’ http://localhost/foo$http_referer | grep ‘foobar’
</code></pre>
<p>扫描此配置错误的系统揭示了多个实例，其中用户可以打印Nginx变量。然而，易受攻击实例数量的减少表明，修补此问题的努力已取得了一定成功。</p>
<h2 id="原始后端响应读取"><a class="header" href="#原始后端响应读取">原始后端响应读取</a></h2>
<p>Nginx通过<code>proxy_pass</code>提供了一项功能，允许拦截后端产生的错误和HTTP头，旨在隐藏内部错误消息和头。这是通过Nginx在响应后端错误时提供自定义错误页面来实现的。然而，当Nginx遇到无效的HTTP请求时，会出现挑战。这样的请求会按原样转发到后端，后端的原始响应随后直接发送给客户端，而不经过Nginx的干预。</p>
<p>考虑一个涉及uWSGI应用的示例场景：</p>
<pre><code class="language-python">def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
</code></pre>
<p>为了管理这一点，在 Nginx 配置中使用了特定的指令：</p>
<pre><code>http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
</code></pre>
<ul>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_intercept_errors"><strong>proxy_intercept_errors</strong></a>: 此指令使 Nginx 能够为状态码大于 300 的后端响应提供自定义响应。它确保对于我们的示例 uWSGI 应用程序，<code>500 错误</code> 响应被 Nginx 拦截并处理。</li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header"><strong>proxy_hide_header</strong></a>: 正如其名称所示，此指令从客户端隐藏指定的 HTTP 头，增强隐私和安全性。</li>
</ul>
<p>当发出有效的 <code>GET</code> 请求时，Nginx 正常处理，返回标准错误响应而不泄露任何秘密头。然而，无效的 HTTP 请求绕过此机制，导致原始后端响应的暴露，包括秘密头和错误消息。</p>
<h2 id="merge_slashes-设置为-off"><a class="header" href="#merge_slashes-设置为-off">merge_slashes 设置为 off</a></h2>
<p>默认情况下，Nginx 的 <strong><code>merge_slashes</code> 指令</strong> 设置为 <strong><code>on</code></strong>，这会将 URL 中的多个正斜杠压缩为一个斜杠。此功能虽然简化了 URL 处理，但可能无意中掩盖了 Nginx 后面应用程序中的漏洞，特别是那些容易受到本地文件包含 (LFI) 攻击的应用程序。安全专家 <strong>Danny Robinson 和 Rotem Bar</strong> 强调了与此默认行为相关的潜在风险，尤其是当 Nginx 作为反向代理时。</p>
<p>为了减轻此类风险，建议对易受这些漏洞影响的应用程序 <strong>关闭 <code>merge_slashes</code> 指令</strong>。这确保 Nginx 在不改变 URL 结构的情况下将请求转发到应用程序，从而不掩盖任何潜在的安全问题。</p>
<p>有关更多信息，请查看 <a href="https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d">Danny Robinson 和 Rotem Bar</a>。</p>
<h3 id="恶意响应头"><a class="header" href="#恶意响应头"><strong>恶意响应头</strong></a></h3>
<p>如 <a href="https://mizu.re/post/cors-playground"><strong>此文</strong></a> 所示，如果某些头出现在 Web 服务器的响应中，它们将改变 Nginx 代理的行为。您可以在 <a href="https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/"><strong>文档中查看</strong></a>：</p>
<ul>
<li><code>X-Accel-Redirect</code>: 指示 Nginx 将请求内部重定向到指定位置。</li>
<li><code>X-Accel-Buffering</code>: 控制 Nginx 是否应缓冲响应。</li>
<li><code>X-Accel-Charset</code>: 在使用 X-Accel-Redirect 时设置响应的字符集。</li>
<li><code>X-Accel-Expires</code>: 在使用 X-Accel-Redirect 时设置响应的过期时间。</li>
<li><code>X-Accel-Limit-Rate</code>: 在使用 X-Accel-Redirect 时限制响应的传输速率。</li>
</ul>
<p>例如，头 <strong><code>X-Accel-Redirect</code></strong> 将导致 Nginx 内部 <strong>重定向</strong>。因此，具有类似 <strong><code>root /</code></strong> 的 Nginx 配置和来自 Web 服务器的响应 <strong><code>X-Accel-Redirect: .env</code></strong> 将使 Nginx 发送 <strong><code>/.env</code></strong> 的内容（路径遍历）。</p>
<h3 id="映射指令中的默认值"><a class="header" href="#映射指令中的默认值"><strong>映射指令中的默认值</strong></a></h3>
<p>在 <strong>Nginx 配置</strong>中，<code>map</code> 指令通常在 <strong>授权控制</strong> 中发挥作用。一个常见的错误是未指定 <strong>默认</strong> 值，这可能导致未经授权的访问。例如：</p>
<pre><code class="language-yaml">http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
</code></pre>
<pre><code class="language-yaml">server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
</code></pre>
<p>没有 <code>default</code>，<strong>恶意用户</strong> 可以通过访问 <code>/map-poc</code> 中的 <strong>未定义 URI</strong> 来绕过安全性。<a href="https://nginx.org/en/docs/http/ngx_http_map_module.html">Nginx 手册</a> 建议设置 <strong>默认值</strong> 以避免此类问题。</p>
<h3 id="dns-欺骗漏洞"><a class="header" href="#dns-欺骗漏洞"><strong>DNS 欺骗漏洞</strong></a></h3>
<p>在某些条件下，对 Nginx 进行 DNS 欺骗是可行的。如果攻击者知道 Nginx 使用的 <strong>DNS 服务器</strong> 并且能够拦截其 DNS 查询，他们可以伪造 DNS 记录。然而，如果 Nginx 配置为使用 <strong>localhost (127.0.0.1)</strong> 进行 DNS 解析，则此方法无效。Nginx 允许如下指定 DNS 服务器：</p>
<pre><code class="language-yaml">resolver 8.8.8.8;
</code></pre>
<h3 id="proxy_pass-和-internal-指令"><a class="header" href="#proxy_pass-和-internal-指令"><strong><code>proxy_pass</code> 和 <code>internal</code> 指令</strong></a></h3>
<p><strong><code>proxy_pass</code></strong> 指令用于将请求重定向到其他服务器，无论是内部还是外部。<strong><code>internal</code></strong> 指令确保某些位置仅在 Nginx 内部可访问。虽然这些指令本身并不是漏洞，但其配置需要仔细检查，以防止安全漏洞。</p>
<h2 id="proxy_set_header-upgrade--connection"><a class="header" href="#proxy_set_header-upgrade--connection">proxy_set_header Upgrade &amp; Connection</a></h2>
<p>如果 nginx 服务器配置为传递 Upgrade 和 Connection 头，则可以执行 <a href="../../pentesting-web/h2c-smuggling.html"><strong>h2c Smuggling attack</strong></a> 来访问受保护的/内部端点。</p>
<p>{% hint style="danger" %}
此漏洞将允许攻击者 <strong>与 <code>proxy_pass</code> 端点建立直接连接</strong>（在此情况下为 <code>http://backend:9999</code>），其内容不会被 nginx 检查。
{% endhint %}</p>
<p>从 <a href="https://bishopfox.com/blog/h2c-smuggling-request">这里</a> 偷取 <code>/flag</code> 的脆弱配置示例：</p>
<pre><code>server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
</code></pre>
<p>{% hint style="warning" %}
请注意，即使 <code>proxy_pass</code> 指向特定的 <strong>路径</strong>，例如 <code>http://backend:9999/socket.io</code>，连接将与 <code>http://backend:9999</code> 建立，因此您可以 <strong>联系该内部端点内的任何其他路径。因此，proxy_pass 的 URL 中指定路径并不重要。</strong>
{% endhint %}</p>
<h2 id="尝试一下"><a class="header" href="#尝试一下">尝试一下</a></h2>
<p>Detectify 创建了一个 GitHub 仓库，您可以使用 Docker 设置自己的易受攻击的 Nginx 测试服务器，包含本文讨论的一些错误配置，并尝试自己找到它们！</p>
<p><a href="https://github.com/detectify/vulnerable-nginx">https://github.com/detectify/vulnerable-nginx</a></p>
<h2 id="静态分析工具"><a class="header" href="#静态分析工具">静态分析工具</a></h2>
<h3 id="gixy"><a class="header" href="#gixy"><a href="https://github.com/yandex/gixy">GIXY</a></a></h3>
<p>Gixy 是一个分析 Nginx 配置的工具。Gixy 的主要目标是防止安全错误配置并自动检测缺陷。</p>
<h3 id="nginxpwner"><a class="header" href="#nginxpwner"><a href="https://github.com/stark0de/nginxpwner">Nginxpwner</a></a></h3>
<p>Nginxpwner 是一个简单的工具，用于查找常见的 Nginx 错误配置和漏洞。</p>
<h2 id="参考资料"><a class="header" href="#参考资料">参考资料</a></h2>
<ul>
<li><a href="https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/"><strong>https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/</strong></a></li>
<li><a href="http://blog.zorinaq.com/nginx-resolver-vulns/"><strong>http://blog.zorinaq.com/nginx-resolver-vulns/</strong></a></li>
<li><a href="https://github.com/yandex/gixy/issues/115"><strong>https://github.com/yandex/gixy/issues/115</strong></a></li>
</ul>
<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>获取黑客对您的网络应用程序、网络和云的看法</strong></p>
<p><strong>查找并报告具有实际业务影响的关键可利用漏洞。</strong> 使用我们 20 多个自定义工具来映射攻击面，查找让您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<p>{% hint style="success" %}
学习与实践 AWS 黑客攻击：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客攻击：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在 Twitter 上关注</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/pentesting-web/moodle.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/pentesting-web/nextjs-1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/pentesting-web/moodle.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/pentesting-web/nextjs-1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
