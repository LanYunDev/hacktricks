<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SIP (Session Initiation Protocol)</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sip-会话发起协议"><a class="header" href="#sip-会话发起协议">SIP (会话发起协议)</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
{% endhint %}
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p>SIP (会话发起协议) 是一种<strong>信令和呼叫控制协议</strong>，广泛用于在IP网络上建立、修改和终止多媒体会话，包括语音、视频和即时消息。SIP由<strong>互联网工程任务组 (IETF)</strong> 开发，定义在<strong>RFC 3261</strong>中，已成为VoIP和统一通信的事实标准。</p>
<p>SIP的一些关键特性包括：</p>
<ol>
<li><strong>基于文本的协议</strong>：SIP是基于文本的协议，使其易于阅读和调试。它基于请求-响应模型，类似于HTTP，并使用INVITE、ACK、BYE和CANCEL等方法来控制呼叫会话。</li>
<li><strong>可扩展性和灵活性</strong>：SIP具有高度的可扩展性，可用于小规模部署以及大型企业和运营商级环境。它可以轻松扩展新功能，使其适应各种用例和需求。</li>
<li><strong>互操作性</strong>：SIP的广泛采用和标准化确保了不同设备、应用程序和服务提供商之间更好的互操作性，促进了各种平台之间的无缝通信。</li>
<li><strong>模块化设计</strong>：SIP与其他协议（如**RTP（实时传输协议）<strong>用于媒体传输和</strong>SDP（会话描述协议）**用于描述多媒体会话）协同工作。这种模块化设计允许更大的灵活性和与不同媒体类型和编解码器的兼容性。</li>
<li><strong>代理和重定向服务器</strong>：SIP可以使用代理和重定向服务器来促进呼叫路由，并提供呼叫转移、呼叫转接和语音邮件服务等高级功能。</li>
<li><strong>状态和即时消息</strong>：SIP不仅限于语音和视频通信。它还支持状态和即时消息，使广泛的统一通信应用成为可能。</li>
</ol>
<p>尽管SIP有许多优点，但在配置和管理时可能会很复杂，特别是在处理NAT穿越和防火墙问题时。然而，其多功能性、可扩展性和行业广泛支持使其成为VoIP和多媒体通信的热门选择。</p>
<h3 id="sip方法"><a class="header" href="#sip方法">SIP方法</a></h3>
<p>在<strong>RFC 3261</strong>中定义的核心SIP方法包括：</p>
<ol>
<li><strong>INVITE</strong>：用于**发起新会话（呼叫）**或修改现有会话。INVITE方法携带会话描述（通常使用SDP）以通知接收方有关提议会话的详细信息，例如媒体类型、编解码器和传输协议。</li>
<li><strong>ACK</strong>：发送以<strong>确认收到</strong>对INVITE请求的最终响应。ACK方法通过提供端到端确认来确保INVITE事务的可靠性。</li>
<li><strong>BYE</strong>：用于<strong>终止已建立的会话（呼叫）</strong>。BYE方法由会话中的任一方发送，以表示他们希望结束通信。</li>
<li><strong>CANCEL</strong>：在会话建立之前发送以<strong>取消待处理的INVITE</strong>请求。CANCEL方法允许发送方在改变主意或接收方没有响应时中止INVITE事务。</li>
<li><strong>OPTIONS</strong>：用于<strong>查询SIP服务器或用户代理的能力</strong>。OPTIONS方法可以发送请求有关支持的方法、媒体类型或其他扩展的信息，而无需实际建立会话。</li>
<li><strong>REGISTER</strong>：用户代理用于<strong>向SIP注册服务器注册其当前位置</strong>。REGISTER方法有助于维护用户的SIP URI与其当前IP地址之间的最新映射，从而实现呼叫路由和交付。</li>
</ol>
<p>{% hint style="warning" %}
请注意，呼叫某人<strong>不需要使用REGISTER</strong>。<br />
然而，可能在进行<strong>INVITE</strong>之前，呼叫者需要<strong>进行身份验证</strong>，否则将收到**<code>401 Unauthorized</code>**响应。
{% endhint %}</p>
<p>除了这些核心方法外，还有<strong>在其他RFC中定义的几种SIP扩展方法</strong>，例如：</p>
<ol>
<li><strong>SUBSCRIBE</strong>：在RFC 6665中定义，SUBSCRIBE方法用于<strong>请求有关特定资源状态的通知</strong>，例如用户的状态或呼叫状态。</li>
<li><strong>NOTIFY</strong>：同样在RFC 6665中定义，NOTIFY方法由服务器发送，以<strong>通知订阅的用户代理</strong>有关监控资源状态的变化。</li>
<li><strong>REFER</strong>：在RFC 3515中定义，REFER方法用于<strong>请求接收方执行转接或引用第三方</strong>。这通常用于<strong>呼叫转接</strong>场景。</li>
<li><strong>MESSAGE</strong>：在RFC 3428中定义，MESSAGE方法用于<strong>在SIP用户代理之间发送即时消息</strong>，使得在SIP框架内进行基于文本的通信成为可能。</li>
<li><strong>UPDATE</strong>：在RFC 3311中定义，UPDATE方法允许<strong>在不影响现有对话状态的情况下修改会话</strong>。这对于在进行中的呼叫中更新会话参数（例如编解码器或媒体类型）非常有用。</li>
<li><strong>PUBLISH</strong>：在RFC 3903中定义，PUBLISH方法由用户代理用于<strong>向服务器发布事件状态信息</strong>，使其对其他感兴趣方可用。</li>
</ol>
<h3 id="sip响应代码"><a class="header" href="#sip响应代码">SIP响应代码</a></h3>
<ul>
<li><strong>1xx（临时响应）</strong>：这些响应表示请求已被接收，服务器正在继续处理。</li>
<li>100 Trying: 请求已被接收，服务器正在处理。</li>
<li>180 Ringing: 被叫方正在被提醒，将接听电话。</li>
<li>183 Session Progress: 提供有关呼叫进展的信息。</li>
<li><strong>2xx（成功响应）</strong>：这些响应表示请求已成功接收、理解和接受。</li>
<li>200 OK: 请求成功，服务器已完成处理。</li>
<li>202 Accepted: 请求已被接受处理，但尚未完成。</li>
<li><strong>3xx（重定向响应）</strong>：这些响应表示需要进一步的操作来满足请求，通常是通过联系替代资源。</li>
<li>300 Multiple Choices: 有多个可用选项，用户或客户端必须选择一个。</li>
<li>301 Moved Permanently: 请求的资源已分配新的永久URI。</li>
<li>302 Moved Temporarily: 请求的资源暂时可在不同的URI上使用。</li>
<li>305 Use Proxy: 请求必须发送到指定的代理。</li>
<li><strong>4xx（客户端错误响应）</strong>：这些响应表示请求包含错误的语法或服务器无法满足请求。</li>
<li>400 Bad Request: 请求格式错误或无效。</li>
<li>401 Unauthorized: 请求需要用户身份验证。</li>
<li>403 Forbidden: 服务器理解请求但拒绝满足。</li>
<li>404 Not Found: 请求的资源在服务器上未找到。</li>
<li>408 Request Timeout: 服务器在准备等待的时间内未收到完整请求。</li>
<li>486 Busy Here: 被叫方当前忙碌，无法接听电话。</li>
<li><strong>5xx（服务器错误响应）</strong>：这些响应表示服务器未能满足有效请求。</li>
<li>500 Internal Server Error: 服务器在处理请求时遇到错误。</li>
<li>501 Not Implemented: 服务器不支持满足请求所需的功能。</li>
<li>503 Service Unavailable: 服务器当前无法处理请求，因维护或过载。</li>
<li><strong>6xx（全局失败响应）</strong>：这些响应表示请求无法被任何服务器满足。</li>
<li>600 Busy Everywhere: 呼叫的所有可能目的地都忙。</li>
<li>603 Decline: 被叫方不愿意参与呼叫。</li>
<li>604 Does Not Exist Anywhere: 请求的资源在网络中不可用。</li>
</ul>
<h2 id="示例"><a class="header" href="#示例">示例</a></h2>
<h3 id="sip-invite-示例"><a class="header" href="#sip-invite-示例">SIP INVITE 示例</a></h3>
<pre><code>INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe &lt;sip:jdoe@example.com&gt;
From: Jane Smith &lt;sip:jsmith@example.org&gt;;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: &lt;sip:jsmith@pc33.example.com&gt;
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
</code></pre>
<details>
<summary>每个参数解释</summary>
<ol>
<li><strong>Request-Line</strong>: <code>INVITE sip:jdoe@example.com SIP/2.0</code> - 该行指示方法（INVITE）、请求URI（sip:<a href="mailto:jdoe@example.com">jdoe@example.com</a>）和SIP版本（SIP/2.0）。</li>
<li><strong>Via</strong>: <code>Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds</code> - Via头指定传输协议（UDP）和客户端地址（pc33.example.com）。"branch"参数用于循环检测和事务匹配。</li>
<li><strong>Max-Forwards</strong>: <code>Max-Forwards: 70</code> - 此头字段限制请求可以被代理转发的次数，以避免无限循环。</li>
<li><strong>To</strong>: <code>To: John Doe &lt;sip:jdoe@example.com&gt;</code> - To头指定通话的接收者，包括他们的显示名称（John Doe）和SIP URI（sip:<a href="mailto:jdoe@example.com">jdoe@example.com</a>）。</li>
<li><strong>From</strong>: <code>From: Jane Smith &lt;sip:jsmith@example.org&gt;;tag=1928301774</code> - From头指定通话的发送者，包括他们的显示名称（Jane Smith）和SIP URI（sip:<a href="mailto:jsmith@example.org">jsmith@example.org</a>）。"tag"参数用于唯一标识发送者在对话中的角色。</li>
<li><strong>Call-ID</strong>: <code>Call-ID: a84b4c76e66710</code> - Call-ID头唯一标识两个用户代理之间的通话会话。</li>
<li><strong>CSeq</strong>: <code>CSeq: 314159 INVITE</code> - CSeq头包含一个序列号和请求中使用的方法。它用于将响应与请求匹配并检测乱序消息。</li>
<li><strong>Contact</strong>: <code>Contact: &lt;sip:jsmith@pc33.example.com&gt;</code> - Contact头提供发送者的直接路径，可用于后续请求和响应。</li>
<li><strong>User-Agent</strong>: <code>User-Agent: ExampleSIPClient/1.0</code> - User-Agent头提供有关发送者的软件或硬件的信息，包括其名称和版本。</li>
<li><strong>Allow</strong>: <code>Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO</code> - Allow头列出发送者支持的SIP方法。这有助于接收者了解在通信中可以使用哪些方法。</li>
<li><strong>Content-Type</strong>: <code>Content-Type: application/sdp</code> - Content-Type头指定消息体的媒体类型，在这种情况下为SDP（会话描述协议）。</li>
<li><strong>Content-Length</strong>: <code>Content-Length: 142</code> - Content-Length头指示消息体的字节大小。</li>
<li><strong>Message Body</strong>: 消息体包含SDP会话描述，其中包括有关媒体类型、编解码器和提议会话的传输协议的信息。</li>
</ol>
<ul>
<li><code>v=0</code> - 协议版本（SDP为0）</li>
<li><code>o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com</code> - 发起者和会话标识符</li>
<li><code>s=-</code> - 会话名称（单个连字符表示没有会话名称）</li>
<li><code>c=IN IP4 pc33.example.com</code> - 连接信息（网络类型、地址类型和地址）</li>
<li><code>t=0 0</code> - 时间信息（开始和停止时间，0 0表示会话没有边界）</li>
<li><code>m=audio 49170 RTP/AVP 0</code> - 媒体描述（媒体类型、端口号、传输协议和格式列表）。在这种情况下，它指定使用RTP/AVP（实时传输协议/音视频配置文件）和格式0（PCMU/8000）的音频流。</li>
<li><code>a=rtpmap:0 PCMU/8000</code> - 属性将格式（0）映射到编解码器（PCMU）及其时钟频率（8000 Hz）。</li>
</ul>
</details>
<h3 id="sip-register-示例"><a class="header" href="#sip-register-示例">SIP REGISTER 示例</a></h3>
<p>REGISTER方法用于会话发起协议（SIP），允许用户代理（UA），例如VoIP电话或软电话，<strong>向SIP注册服务器注册其位置</strong>。此过程让服务器知道<strong>将传入的SIP请求路由到注册用户的地方</strong>。注册服务器通常是SIP代理服务器或专用注册服务器的一部分。</p>
<p>以下是REGISTER身份验证过程中的SIP消息的详细示例：</p>
<ol>
<li>从UA到注册服务器的初始<strong>REGISTER</strong>请求：</li>
</ol>
<pre><code class="language-yaml">REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice &lt;sip:alice@example.com&gt;;tag=565656
To: Alice &lt;sip:alice@example.com&gt;
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: &lt;sip:alice@192.168.1.100:5060&gt;;expires=3600
Expires: 3600
Content-Length: 0
</code></pre>
<p>这个初始的 REGISTER 消息由 UA（Alice）发送到注册服务器。它包含重要信息，例如所需的注册持续时间（Expires）、用户的 SIP URI（sip:<a href="mailto:alice@example.com">alice@example.com</a>）和用户的联系地址（sip:alice@192.168.1.100:5060）。</p>
<ol start="2">
<li><strong>401 Unauthorized</strong> 来自注册服务器的响应：</li>
</ol>
<pre><code class="language-css">cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice &lt;sip:alice@example.com&gt;;tag=565656
To: Alice &lt;sip:alice@example.com&gt;;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
</code></pre>
<p>注册服务器以“401 Unauthorized”消息响应，其中包含“WWW-Authenticate”头。该头包含UA进行身份验证所需的信息，例如<strong>身份验证域、随机数和算法</strong>。</p>
<ol start="3">
<li>带有身份验证凭据的REGISTER请求：</li>
</ol>
<pre><code class="language-vbnet">REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice &lt;sip:alice@example.com&gt;;tag=565656
To: Alice &lt;sip:alice@example.com&gt;
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: &lt;sip:alice@192.168.1.100:5060&gt;;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
</code></pre>
<p>The UA发送另一个REGISTER请求，这次包括**“Authorization”头，带有必要的凭据，例如用户名、域、随机数和使用提供的信息和用户密码计算的响应值**。</p>
<p>这就是<strong>Authorization响应</strong>的计算方式：</p>
<pre><code class="language-python">import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
</code></pre>
<ol start="4">
<li><strong>成功注册</strong> 响应来自注册服务器：</li>
</ol>
<pre><code class="language-yaml">SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice &lt;sip:alice@example.com&gt;;tag=565656
To: Alice &lt;sip:alice@example.com&gt;;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: &lt;sip:alice@192.168.1.100:5060&gt;;expires=3600
Expires: 3600
Content-Length: 0
</code></pre>
<p>在注册服务器验证提供的凭据后，<strong>它发送一个“200 OK”响应以指示注册成功</strong>。响应包括注册的联系信息和注册的过期时间。此时，用户代理（Alice）已成功注册到SIP注册服务器，针对Alice的传入SIP请求可以路由到适当的联系地址。</p>
<h3 id="呼叫示例"><a class="header" href="#呼叫示例">呼叫示例</a></h3>
<figure><img src="../../../.gitbook/assets/image (1101).png" alt=""><figcaption></figcaption></figure>
<p>{% hint style="info" %}
虽然没有提到，但用户B需要在能够接听电话之前向代理2发送<strong>REGISTER消息</strong>。
{% endhint %}
{% hint style="success" %}
学习和实践AWS黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>上关注我们。</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub库提交PR来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../network-services-pentesting/pentesting-voip/basic-voip-protocols/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../network-services-pentesting/pentesting-remote-gdbserver.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../network-services-pentesting/pentesting-voip/basic-voip-protocols/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../network-services-pentesting/pentesting-remote-gdbserver.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
