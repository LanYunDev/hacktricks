<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>22 - Pentesting SSH/SFTP</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="22---pentesting-sshsftp"><a class="header" href="#22---pentesting-sshsftp">22 - Pentesting SSH/SFTP</a></h1>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>
<p><strong>漏洞赏金提示</strong>：<strong>注册</strong> <strong>Intigriti</strong>，一个由黑客为黑客创建的高级 <strong>漏洞赏金平台</strong>！今天就加入我们 <a href="https://go.intigriti.com/hacktricks"><strong>https://go.intigriti.com/hacktricks</strong></a>，开始赚取高达 <strong>$100,000</strong> 的赏金！</p>
<p>{% embed url="https://go.intigriti.com/hacktricks" %}</p>
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p><strong>SSH（安全外壳或安全套接字外壳）</strong> 是一种网络协议，能够在不安全的网络上与计算机建立安全连接。它在访问远程系统时对于维护数据的机密性和完整性至关重要。</p>
<p><strong>默认端口：</strong> 22</p>
<pre><code>22/tcp open  ssh     syn-ack
</code></pre>
<p><strong>SSH 服务器：</strong></p>
<ul>
<li><a href="http://www.openssh.org">openSSH</a> – OpenBSD SSH，自 Windows 10 起在 BSD、Linux 发行版和 Windows 中提供</li>
<li><a href="https://matt.ucc.asn.au/dropbear/dropbear.html">Dropbear</a> – 适用于内存和处理器资源有限环境的 SSH 实现，包含在 OpenWrt 中</li>
<li><a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/">PuTTY</a> – 适用于 Windows 的 SSH 实现，客户端常用，但服务器使用较少</li>
<li><a href="https://www.itefix.net/copssh">CopSSH</a> – Windows 的 OpenSSH 实现</li>
</ul>
<p><strong>SSH 库（实现服务器端）：</strong></p>
<ul>
<li><a href="https://www.libssh.org">libssh</a> – 多平台 C 库，实现 SSHv2 协议，支持 <a href="https://github.com/ParallelSSH/ssh-python">Python</a>、<a href="https://github.com/garnier-quentin/perl-libssh/">Perl</a> 和 <a href="https://github.com/ropensci/ssh">R</a> 的绑定；KDE 用于 sftp，GitHub 用于 git SSH 基础设施</li>
<li><a href="https://www.wolfssl.com/products/wolfssh/">wolfSSH</a> – 用 ANSI C 编写的 SSHv2 服务器库，针对嵌入式、RTOS 和资源受限环境</li>
<li><a href="https://mina.apache.org/sshd-project/index.html">Apache MINA SSHD</a> – 基于 Apache MINA 的 Apache SSHD Java 库</li>
<li><a href="https://github.com/paramiko/paramiko">paramiko</a> – Python SSHv2 协议库</li>
</ul>
<h2 id="枚举"><a class="header" href="#枚举">枚举</a></h2>
<h3 id="横幅抓取"><a class="header" href="#横幅抓取">横幅抓取</a></h3>
<pre><code class="language-bash">nc -vn &lt;IP&gt; 22
</code></pre>
<h3 id="自动化-ssh-audit"><a class="header" href="#自动化-ssh-audit">自动化 ssh-audit</a></h3>
<p>ssh-audit 是一个用于 ssh 服务器和客户端配置审计的工具。</p>
<p><a href="https://github.com/jtesta/ssh-audit">https://github.com/jtesta/ssh-audit</a> 是一个来自 <a href="https://github.com/arthepsy/ssh-audit/">https://github.com/arthepsy/ssh-audit/</a> 的更新分支</p>
<p><strong>特点：</strong></p>
<ul>
<li>支持 SSH1 和 SSH2 协议服务器；</li>
<li>分析 SSH 客户端配置；</li>
<li>抓取横幅，识别设备或软件和操作系统，检测压缩；</li>
<li>收集密钥交换、主机密钥、加密和消息认证码算法；</li>
<li>输出算法信息（可用自、已移除/禁用、不安全/弱/遗留等）；</li>
<li>输出算法建议（根据识别的软件版本添加或移除）；</li>
<li>输出安全信息（相关问题、分配的 CVE 列表等）；</li>
<li>根据算法信息分析 SSH 版本兼容性；</li>
<li>来自 OpenSSH、Dropbear SSH 和 libssh 的历史信息；</li>
<li>在 Linux 和 Windows 上运行；</li>
<li>无依赖</li>
</ul>
<pre><code class="language-bash">usage: ssh-audit.py [-1246pbcnjvlt] &lt;host&gt;

-1,  --ssh1             force ssh version 1 only
-2,  --ssh2             force ssh version 2 only
-4,  --ipv4             enable IPv4 (order of precedence)
-6,  --ipv6             enable IPv6 (order of precedence)
-p,  --port=&lt;port&gt;      port to connect
-b,  --batch            batch output
-c,  --client-audit     starts a server on port 2222 to audit client
software config (use -p to change port;
use -t to change timeout)
-n,  --no-colors        disable colors
-j,  --json             JSON output
-v,  --verbose          verbose output
-l,  --level=&lt;level&gt;    minimum output level (info|warn|fail)
-t,  --timeout=&lt;secs&gt;   timeout (in seconds) for connection and reading
(default: 5)
$ python3 ssh-audit &lt;IP&gt;
</code></pre>
<p><a href="https://asciinema.org/a/96ejZKxpbuupTK9j7h8BdClzp">查看实际操作 (Asciinema)</a></p>
<h3 id="服务器的公钥-ssh"><a class="header" href="#服务器的公钥-ssh">服务器的公钥 SSH</a></h3>
<pre><code class="language-bash">ssh-keyscan -t rsa &lt;IP&gt; -p &lt;PORT&gt;
</code></pre>
<h3 id="弱加密算法"><a class="header" href="#弱加密算法">弱加密算法</a></h3>
<p>这可以通过 <strong>nmap</strong> 默认发现。但你也可以使用 <strong>sslcan</strong> 或 <strong>sslyze</strong>。</p>
<h3 id="nmap-脚本"><a class="header" href="#nmap-脚本">Nmap 脚本</a></h3>
<pre><code class="language-bash">nmap -p22 &lt;ip&gt; -sC # Send default nmap scripts for SSH
nmap -p22 &lt;ip&gt; -sV # Retrieve version
nmap -p22 &lt;ip&gt; --script ssh2-enum-algos # Retrieve supported algorythms
nmap -p22 &lt;ip&gt; --script ssh-hostkey --script-args ssh_hostkey=full # Retrieve weak keys
nmap -p22 &lt;ip&gt; --script ssh-auth-methods --script-args="ssh.user=root" # Check authentication methods
</code></pre>
<h3 id="shodan"><a class="header" href="#shodan">Shodan</a></h3>
<ul>
<li><code>ssh</code></li>
</ul>
<h2 id="暴力破解用户名密码和私钥"><a class="header" href="#暴力破解用户名密码和私钥">暴力破解用户名、密码和私钥</a></h2>
<h3 id="用户名枚举"><a class="header" href="#用户名枚举">用户名枚举</a></h3>
<p>在某些版本的 OpenSSH 中，您可以进行时间攻击以枚举用户。您可以使用 metasploit 模块来利用这一点：</p>
<pre><code>msf&gt; use scanner/ssh/ssh_enumusers
</code></pre>
<h3 id="暴力破解"><a class="header" href="#暴力破解"><a href="../generic-hacking/brute-force.html#ssh">暴力破解</a></a></h3>
<p>一些常见的 ssh 凭据 <a href="https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ssh-betterdefaultpasslist.txt">在这里</a> 和 <a href="https://github.com/danielmiessler/SecLists/blob/master/Passwords/Common-Credentials/top-20-common-SSH-passwords.txt">在这里</a> 以及下面。</p>
<h3 id="私钥暴力破解"><a class="header" href="#私钥暴力破解">私钥暴力破解</a></h3>
<p>如果你知道一些可以使用的 ssh 私钥... 那就试试吧。你可以使用 nmap 脚本：</p>
<pre><code>https://nmap.org/nsedoc/scripts/ssh-publickey-acceptance.html
</code></pre>
<p>或 MSF 辅助模块：</p>
<pre><code>msf&gt; use scanner/ssh/ssh_identify_pubkeys
</code></pre>
<p>或使用 <code>ssh-keybrute.py</code>（原生 python3，轻量且启用了遗留算法）：<a href="https://github.com/snowdroppe/ssh-keybrute">snowdroppe/ssh-keybrute</a>。</p>
<h4 id="已知的坏密钥可以在这里找到"><a class="header" href="#已知的坏密钥可以在这里找到">已知的坏密钥可以在这里找到：</a></h4>
<p>{% embed url="https://github.com/rapid7/ssh-badkeys/tree/master/authorized" %}</p>
<h4 id="弱-ssh-密钥--debian-可预测-prng"><a class="header" href="#弱-ssh-密钥--debian-可预测-prng">弱 SSH 密钥 / Debian 可预测 PRNG</a></h4>
<p>某些系统在用于生成加密材料的随机种子中存在已知缺陷。这可能导致密钥空间显著减少，从而可以被暴力破解。受弱 PRNG 影响的 Debian 系统上生成的预生成密钥集可以在这里找到：<a href="https://github.com/g0tmi1k/debian-ssh">g0tmi1k/debian-ssh</a>。</p>
<p>您应该在这里查找受害者机器的有效密钥。</p>
<h3 id="kerberos"><a class="header" href="#kerberos">Kerberos</a></h3>
<p><strong>crackmapexec</strong> 使用 <code>ssh</code> 协议可以使用选项 <code>--kerberos</code> 来 <strong>通过 kerberos 进行身份验证</strong>。<br />
有关更多信息，请运行 <code>crackmapexec ssh --help</code>。</p>
<h2 id="默认凭据"><a class="header" href="#默认凭据">默认凭据</a></h2>
<div class="table-wrapper"><table><thead><tr><th><strong>供应商</strong></th><th><strong>用户名</strong></th><th><strong>密码</strong></th></tr></thead><tbody>
<tr><td>APC</td><td>apc, device</td><td>apc</td></tr>
<tr><td>Brocade</td><td>admin</td><td>admin123, password, brocade, fibranne</td></tr>
<tr><td>Cisco</td><td>admin, cisco, enable, hsa, pix, pnadmin, ripeop, root, shelladmin</td><td>admin, Admin123, default, password, secur4u, cisco, Cisco, _Cisco, cisco123, C1sco!23, Cisco123, Cisco1234, TANDBERG, change_it, 12345, ipics, pnadmin, diamond, hsadb, c, cc, attack, blender, changeme</td></tr>
<tr><td>Citrix</td><td>root, nsroot, nsmaint, vdiadmin, kvm, cli, admin</td><td>C1trix321, nsroot, nsmaint, kaviza, kaviza123, freebsd, public, rootadmin, wanscaler</td></tr>
<tr><td>D-Link</td><td>admin, user</td><td>private, admin, user</td></tr>
<tr><td>Dell</td><td>root, user1, admin, vkernel, cli</td><td>calvin, 123456, password, vkernel, Stor@ge!, admin</td></tr>
<tr><td>EMC</td><td>admin, root, sysadmin</td><td>EMCPMAdm7n, Password#1, Password123#, sysadmin, changeme, emc</td></tr>
<tr><td>HP/3Com</td><td>admin, root, vcx, app, spvar, manage, hpsupport, opc_op</td><td>admin, password, hpinvent, iMC123, pvadmin, passw0rd, besgroup, vcx, nice, access, config, 3V@rpar, 3V#rpar, procurve, badg3r5, OpC_op, !manage, !admin</td></tr>
<tr><td>Huawei</td><td>admin, root</td><td>123456, admin, root, Admin123, Admin@storage, Huawei12#$, HwDec@01, hwosta2.0, HuaWei123, fsp200@HW, huawei123</td></tr>
<tr><td>IBM</td><td>USERID, admin, manager, mqm, db2inst1, db2fenc1, dausr1, db2admin, iadmin, system, device, ufmcli, customer</td><td>PASSW0RD, passw0rd, admin, password, Passw8rd, iadmin, apc, 123456, cust0mer</td></tr>
<tr><td>Juniper</td><td>netscreen</td><td>netscreen</td></tr>
<tr><td>NetApp</td><td>admin</td><td>netapp123</td></tr>
<tr><td>Oracle</td><td>root, oracle, oravis, applvis, ilom-admin, ilom-operator, nm2user</td><td>changeme, ilom-admin, ilom-operator, welcome1, oracle</td></tr>
<tr><td>VMware</td><td>vi-admin, root, hqadmin, vmware, admin</td><td>vmware, vmw@re, hqadmin, default</td></tr>
</tbody></table>
</div>
<h2 id="ssh-mitm"><a class="header" href="#ssh-mitm">SSH-MitM</a></h2>
<p>如果您在本地网络中作为即将使用用户名和密码连接到 SSH 服务器的受害者，您可以尝试 <strong>执行 MitM 攻击以窃取这些凭据：</strong></p>
<p><strong>攻击路径：</strong></p>
<ul>
<li><strong>流量重定向：</strong> 攻击者 <strong>转移</strong> 受害者的流量到他们的机器，有效地 <strong>拦截</strong> 连接尝试到 SSH 服务器。</li>
<li><strong>拦截和记录：</strong> 攻击者的机器充当 <strong>代理</strong>，通过假装是合法的 SSH 服务器来 <strong>捕获</strong> 用户的登录信息。</li>
<li><strong>命令执行和转发：</strong> 最后，攻击者的服务器 <strong>记录用户的凭据</strong>，<strong>将命令转发</strong> 到真实的 SSH 服务器，<strong>执行</strong> 它们，并 <strong>将结果发送回</strong> 用户，使过程看起来无缝且合法。</li>
</ul>
<p><a href="https://github.com/jtesta/ssh-mitm"><strong>SSH MITM</strong></a> 正是如上所述的功能。</p>
<p>为了捕获执行实际的 MitM，您可以使用 ARP 欺骗、DNS 欺骗或在 <a href="../generic-methodologies-and-resources/pentesting-network/#spoofing"><strong>网络欺骗攻击</strong></a> 中描述的其他技术。</p>
<h2 id="ssh-snake"><a class="header" href="#ssh-snake">SSH-Snake</a></h2>
<p>如果您想使用在系统上发现的 SSH 私钥遍历网络，利用每个系统上的每个私钥连接到新主机，那么 <a href="https://github.com/MegaManSec/SSH-Snake"><strong>SSH-Snake</strong></a> 是您所需要的。</p>
<p>SSH-Snake 自动且递归地执行以下任务：</p>
<ol>
<li>在当前系统上，查找任何 SSH 私钥，</li>
<li>在当前系统上，查找任何可能接受私钥的主机或目标（user@host），</li>
<li>尝试使用所有发现的私钥 SSH 连接到所有目标，</li>
<li>如果成功连接到某个目标，则在连接的系统上重复步骤 #1 - #4。</li>
</ol>
<p>它是完全自我复制和自我传播的——并且完全无文件。</p>
<h2 id="配置错误"><a class="header" href="#配置错误">配置错误</a></h2>
<h3 id="根登录"><a class="header" href="#根登录">根登录</a></h3>
<p>SSH 服务器默认允许 root 用户登录，这构成了重大安全风险。<strong>禁用根登录</strong> 是保护服务器的关键步骤。通过进行此更改，可以减轻未经授权的管理权限访问和暴力攻击的风险。</p>
<p><strong>在 OpenSSH 中禁用根登录：</strong></p>
<ol>
<li><strong>编辑 SSH 配置文件</strong>：<code>sudoedit /etc/ssh/sshd_config</code></li>
<li><strong>将设置更改</strong> 从 <code>#PermitRootLogin yes</code> 为 <strong><code>PermitRootLogin no</code></strong>。</li>
<li><strong>使用以下命令重新加载配置</strong>：<code>sudo systemctl daemon-reload</code></li>
<li><strong>重启 SSH 服务器</strong> 以应用更改：<code>sudo systemctl restart sshd</code></li>
</ol>
<h3 id="sftp-暴力破解"><a class="header" href="#sftp-暴力破解">SFTP 暴力破解</a></h3>
<ul>
<li><a href="../generic-hacking/brute-force.html#sftp"><strong>SFTP 暴力破解</strong></a></li>
</ul>
<h3 id="sftp-命令执行"><a class="header" href="#sftp-命令执行">SFTP 命令执行</a></h3>
<p>在 SFTP 设置中常见的一个疏忽是，管理员希望用户在不启用远程 shell 访问的情况下交换文件。尽管将用户设置为非交互式 shell（例如 <code>/usr/bin/nologin</code>）并将其限制在特定目录中，但仍然存在安全漏洞。<strong>用户可以通过在登录后立即请求执行命令（如 <code>/bin/bash</code>）来规避这些限制</strong>，在其指定的非交互式 shell 接管之前。这允许未经授权的命令执行，破坏了预期的安全措施。</p>
<p><a href="https://community.turgensec.com/ssh-hacking-guide/">示例来自这里</a>：</p>
<pre><code class="language-bash">ssh -v noraj@192.168.1.94 id
...
Password:
debug1: Authentication succeeded (keyboard-interactive).
Authenticated to 192.168.1.94 ([192.168.1.94]:22).
debug1: channel 0: new [client-session]
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0
debug1: Sending command: id
debug1: client_input_channel_req: channel 0 rtype exit-status reply 0
debug1: client_input_channel_req: channel 0 rtype eow@openssh.com reply 0
uid=1000(noraj) gid=100(users) groups=100(users)
debug1: channel 0: free: client-session, nchannels 1
Transferred: sent 2412, received 2480 bytes, in 0.1 seconds
Bytes per second: sent 43133.4, received 44349.5
debug1: Exit status 0

$ ssh noraj@192.168.1.94 /bin/bash
</code></pre>
<p>这是用户 <code>noraj</code> 的安全 SFTP 配置示例 (<code>/etc/ssh/sshd_config</code> – openSSH)：</p>
<pre><code>Match User noraj
ChrootDirectory %h
ForceCommand internal-sftp
AllowTcpForwarding no
PermitTunnel no
X11Forwarding no
PermitTTY no
</code></pre>
<p>此配置将仅允许 SFTP：通过强制启动命令并禁用 TTY 访问来禁用 shell 访问，同时还禁用所有类型的端口转发或隧道。</p>
<h3 id="sftp-隧道"><a class="header" href="#sftp-隧道">SFTP 隧道</a></h3>
<p>如果您可以访问 SFTP 服务器，您还可以通过此方式隧道您的流量，例如使用常见的端口转发：</p>
<pre><code class="language-bash">sudo ssh -L &lt;local_port&gt;:&lt;remote_host&gt;:&lt;remote_port&gt; -N -f &lt;username&gt;@&lt;ip_compromised&gt;
</code></pre>
<h3 id="sftp-symlink"><a class="header" href="#sftp-symlink">SFTP Symlink</a></h3>
<p>The <strong>sftp</strong> have the command "<strong>symlink</strong>". Therefore, if you have <strong>可写权限</strong> in some folder, you can create <strong>symlinks</strong> of <strong>其他文件夹/文件</strong>. As you are probably <strong>被困</strong> inside a chroot this <strong>对你来说不会特别有用</strong>, but, if you can <strong>访问</strong> the created <strong>symlink</strong> from a <strong>no-chroot</strong> <strong>服务</strong> (for example, if you can access the symlink from the web), you could <strong>通过网络打开链接的文件</strong>.</p>
<p>For example, to create a <strong>symlink</strong> from a new file <strong>"</strong><em><strong>froot</strong></em><strong>" to "</strong><em><strong>/</strong></em><strong>"</strong>:</p>
<pre><code class="language-bash">sftp&gt; symlink / froot
</code></pre>
<p>如果您可以通过网络访问文件 "<em>froot</em>"，您将能够列出系统的根 ("/") 文件夹。</p>
<h3 id="认证方法"><a class="header" href="#认证方法">认证方法</a></h3>
<p>在高安全性环境中，通常的做法是仅启用基于密钥或双因素认证，而不是简单的基于密码的单因素认证。但通常情况下，较强的认证方法被启用而没有禁用较弱的认证方法。一个常见的情况是在 openSSH 配置中启用 <code>publickey</code> 并将其设置为默认方法，但没有禁用 <code>password</code>。因此，通过使用 SSH 客户端的详细模式，攻击者可以看到较弱的方法被启用：</p>
<pre><code class="language-bash">ssh -v 192.168.1.94
OpenSSH_8.1p1, OpenSSL 1.1.1d  10 Sep 2019
...
debug1: Authentications that can continue: publickey,password,keyboard-interactive
</code></pre>
<p>例如，如果设置了身份验证失败限制，并且您从未有机会达到密码方法，则可以使用 <code>PreferredAuthentications</code> 选项强制使用此方法。</p>
<pre><code class="language-bash">ssh -v 192.168.1.94 -o PreferredAuthentications=password
...
debug1: Next authentication method: password
</code></pre>
<p>检查SSH服务器配置是必要的，以确保仅授权预期的方法。使用客户端的详细模式可以帮助查看配置的有效性。</p>
<h3 id="配置文件"><a class="header" href="#配置文件">配置文件</a></h3>
<pre><code class="language-bash">ssh_config
sshd_config
authorized_keys
ssh_known_hosts
known_hosts
id_rsa
</code></pre>
<h2 id="fuzzing"><a class="header" href="#fuzzing">Fuzzing</a></h2>
<ul>
<li><a href="https://packetstormsecurity.com/files/download/71252/sshfuzz.txt">https://packetstormsecurity.com/files/download/71252/sshfuzz.txt</a></li>
<li><a href="https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh_version_2">https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh_version_2</a></li>
</ul>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li>你可以在 <a href="https://www.ssh-audit.com/hardening_guides.html">https://www.ssh-audit.com/hardening_guides.html</a> 找到关于如何加固 SSH 的有趣指南</li>
<li><a href="https://community.turgensec.com/ssh-hacking-guide">https://community.turgensec.com/ssh-hacking-guide</a></li>
</ul>
<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>
<p><strong>Bug bounty tip</strong>: <strong>注册</strong> <strong>Intigriti</strong>，一个由黑客为黑客创建的高级 <strong>bug bounty 平台</strong>！今天就加入我们 <a href="https://go.intigriti.com/hacktricks"><strong>https://go.intigriti.com/hacktricks</strong></a>，开始赚取高达 <strong>$100,000</strong> 的赏金！</p>
<p>{% embed url="https://go.intigriti.com/hacktricks" %}</p>
<h2 id="hacktricks-automatic-commands"><a class="header" href="#hacktricks-automatic-commands">HackTricks Automatic Commands</a></h2>
<pre><code>Protocol_Name: SSH
Port_Number: 22
Protocol_Description: Secure Shell Hardening

Entry_1:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -v -V -u -l {Username} -P {Big_Passwordlist} -t 1 {IP} ssh

Entry_2:
Name: consolesless mfs enumeration
Description: SSH enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ssh/ssh_version; set RHOSTS {IP}; set RPORT 22; run; exit' &amp;&amp; msfconsole -q -x 'use scanner/ssh/ssh_enumusers; set RHOSTS {IP}; set RPORT 22; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/ssh/juniper_backdoor; set RHOSTS {IP}; set RPORT 22; run; exit'

</code></pre>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-ftp/ftp-bounce-download-2oftp-file.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/pentesting-telnet.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-ftp/ftp-bounce-download-2oftp-file.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/pentesting-telnet.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
