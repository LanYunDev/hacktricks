<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>11211 - Pentesting Memcache</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="11211---pentesting-memcache"><a class="header" href="#11211---pentesting-memcache">11211 - Pentesting Memcache</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="协议信息"><a class="header" href="#协议信息">协议信息</a></h2>
<p>来自 <a href="https://en.wikipedia.org/wiki/Memcached">wikipedia</a>:</p>
<blockquote>
<p><strong>Memcached</strong>（发音：mem-cashed, mem-cash-dee）是一个通用的分布式 <a href="https://en.wikipedia.org/wiki/Memory_caching">内存缓存</a> 系统。它通常用于通过在 RAM 中缓存数据和对象来加速动态数据库驱动的网站，以减少读取外部数据源（如数据库或 API）的次数。</p>
</blockquote>
<p>尽管 Memcached 支持 SASL，但大多数实例是 <strong>未经过身份验证</strong> 的。</p>
<p><strong>默认端口：</strong> 11211</p>
<pre><code>PORT      STATE SERVICE
11211/tcp open  unknown
</code></pre>
<h2 id="enumeration"><a class="header" href="#enumeration">Enumeration</a></h2>
<h3 id="manual"><a class="header" href="#manual">Manual</a></h3>
<p>要提取 memcache 实例中保存的所有信息，您需要：</p>
<ol>
<li>找到 <strong>slabs</strong> 中的 <strong>活动项</strong></li>
<li>获取之前检测到的 slabs 的 <strong>键名</strong></li>
<li>通过 <strong>获取键名</strong> 来提取 <strong>保存的数据</strong></li>
</ol>
<p>请记住，这项服务只是一个 <strong>缓存</strong>，因此 <strong>数据可能会出现和消失</strong>。</p>
<pre><code class="language-bash">echo "version" | nc -vn -w 1 &lt;IP&gt; 11211      #Get version
echo "stats" | nc -vn -w 1 &lt;IP&gt; 11211        #Get status
echo "stats slabs" | nc -vn -w 1 &lt;IP&gt; 11211  #Get slabs
echo "stats items" | nc -vn -w 1 &lt;IP&gt; 11211  #Get items of slabs with info
echo "stats cachedump &lt;number&gt; 0" | nc -vn -w 1 &lt;IP&gt; 11211  #Get key names (the 0 is for unlimited output size)
echo "get &lt;item_name&gt;" | nc -vn -w 1 &lt;IP&gt; 11211  #Get saved info

#This php will just dump the keys, you need to use "get &lt;item_name&gt; later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c-&gt;addServer("localhost", 11211); var_dump( $c-&gt;getAllKeys() );'
</code></pre>
<h3 id="手动2"><a class="header" href="#手动2">手动2</a></h3>
<pre><code class="language-bash">sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 &lt;item1&gt; &lt;item2&gt; &lt;item3&gt; #Get info inside the item(s)
</code></pre>
<h3 id="自动"><a class="header" href="#自动">自动</a></h3>
<pre><code class="language-bash">nmap -n -sV --script memcached-info -p 11211 &lt;IP&gt;   #Just gather info
msf &gt; use auxiliary/gather/memcached_extractor      #Extracts saved data
msf &gt; use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
</code></pre>
<h2 id="dumping-memcache-keys"><a class="header" href="#dumping-memcache-keys"><strong>Dumping Memcache Keys</strong></a></h2>
<p>在memcache领域，一个帮助组织数据的协议，通过slabs，存在特定的命令用于检查存储的数据，尽管有显著的限制：</p>
<ol>
<li>只能按slab类转储键，将相似内容大小的键分组。</li>
<li>每个slab类的限制为一页，相当于1MB的数据。</li>
<li>此功能是非官方的，可能随时被取消，如在<a href="https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM">社区论坛</a>中讨论的那样。</li>
</ol>
<p>只能从潜在的千兆字节数据中转储1MB的限制尤其显著。然而，这一功能仍然可以根据特定需求提供对键使用模式的洞察。对于那些对机制不太感兴趣的人，可以访问<a href="https://lzone.de/cheat-sheet/memcached#tools">工具部分</a>，查看全面转储的实用工具。或者，下面概述了使用telnet与memcached设置直接交互的过程。</p>
<h3 id="how-it-works"><a class="header" href="#how-it-works"><strong>How it Works</strong></a></h3>
<p>Memcache的内存组织至关重要。使用"-vv"选项启动memcache可以显示它生成的slab类，如下所示：</p>
<pre><code class="language-bash">$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
</code></pre>
<p>要显示所有当前存在的 slabs，可以使用以下命令：</p>
<pre><code class="language-bash">stats slabs
</code></pre>
<p>将单个键添加到 memcached 1.4.13 演示了如何填充和管理 slab 类。例如：</p>
<pre><code class="language-bash">set mykey 0 60 1
1
STORED
</code></pre>
<p>执行“stats slabs”命令后添加键会产生关于 slab 利用率的详细统计信息：</p>
<pre><code class="language-bash">stats slabs
[...]
</code></pre>
<p>此输出显示了活动的 slab 类型、使用的块和操作统计信息，提供了有关读写操作效率的见解。</p>
<p>另一个有用的命令 "stats items" 提供了关于驱逐、内存限制和项目生命周期的数据：</p>
<pre><code class="language-bash">stats items
[...]
</code></pre>
<p>这些统计数据允许对应用程序缓存行为进行有根据的假设，包括不同内容大小的缓存效率、内存分配和缓存大对象的能力。</p>
<h3 id="转储键"><a class="header" href="#转储键"><strong>转储键</strong></a></h3>
<p>对于1.4.31之前的版本，键是通过 slab 类转储的，使用：</p>
<pre><code class="language-bash">stats cachedump &lt;slab class&gt; &lt;number of items to dump&gt;
</code></pre>
<p>例如，要转储类 #1 中的一个键：</p>
<pre><code class="language-bash">stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
</code></pre>
<p>此方法遍历 slab 类，提取并可选地转储键值。</p>
<h3 id="转储-memcache-键-ver-1431"><a class="header" href="#转储-memcache-键-ver-1431"><strong>转储 MEMCACHE 键 (VER 1.4.31+)</strong></a></h3>
<p>在 memcache 版本 1.4.31 及以上，引入了一种新的、更安全的方法来在生产环境中转储键，利用非阻塞模式，如 <a href="https://github.com/memcached/memcached/wiki/ReleaseNotes1431">发布说明</a> 中详细说明。这种方法生成大量输出，因此建议使用 'nc' 命令以提高效率。示例包括：</p>
<pre><code class="language-bash">echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
</code></pre>
<h3 id="dumping-tools"><a class="header" href="#dumping-tools"><strong>DUMPING TOOLS</strong></a></h3>
<p>Table <a href="https://lzone.de/blog">from here</a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Programming Languages</th><th>Tools</th><th>Functionality</th><th></th><th></th></tr></thead><tbody>
<tr><td>PHP</td><td><a href="http://snipt.org/xtP">simple script</a></td><td>打印键名。</td><td></td><td></td></tr>
<tr><td>Perl</td><td><a href="https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1&amp;modificationDate=1229693957401">simple script</a></td><td>打印键和值</td><td></td><td></td></tr>
<tr><td>Ruby</td><td><a href="https://gist.github.com/1365005">simple script</a></td><td>打印键名。</td><td></td><td></td></tr>
<tr><td>Perl</td><td><a href="https://search.cpan.org/~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod">memdump</a></td><td>CPAN模块中的工具</td><td><a href="https://search.cpan.org/~dmaki/Memcached-libmemc">Memcached-libmemcached</a></td><td>ached/)</td></tr>
<tr><td>PHP</td><td><a href="http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/">memcache.php</a></td><td>Memcache监控GUI，也允许转储键</td><td></td><td></td></tr>
<tr><td>libmemcached</td><td><a href="http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/">peep</a></td><td><strong>会冻结你的memcached进程!!!</strong> 使用时请小心。如果仍然使用它，你可以绕过1MB限制，真正转储<strong>所有</strong>键。</td><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a></a></h2>
<h3 id="1mb-data-limit"><a class="header" href="#1mb-data-limit">1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a></a></h3>
<p>请注意，在memcached 1.4之前，您无法存储大于1MB的对象，因为默认的最大块大小。</p>
<h3 id="never-set-a-timeout--30-days"><a class="header" href="#never-set-a-timeout--30-days">Never Set a Timeout &gt; 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a></a></h3>
<p>如果您尝试“设置”或“添加”一个超时大于允许的最大值的键，您可能不会得到预期的结果，因为memcached会将该值视为Unix时间戳。如果时间戳在过去，它将完全不执行任何操作。您的命令将默默失败。</p>
<p>因此，如果您想使用最大生命周期，请指定2592000。示例：</p>
<pre><code>set my_key 0 2592000 1
1
</code></pre>
<h3 id="消失的键在溢出时"><a class="header" href="#消失的键在溢出时">消失的键在溢出时 <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a></a></h3>
<p>尽管文档提到使用“incr”导致64位溢出值的情况会使值消失，但需要使用“add”/“set”重新创建。</p>
<h3 id="复制"><a class="header" href="#复制">复制 <a href="#replication" id="replication"></a></a></h3>
<p>memcached本身不支持复制。如果你真的需要它，你需要使用第三方解决方案：</p>
<ul>
<li><a href="http://repcached.lab.klab.org/">repcached</a>: 多主异步复制（memcached 1.2补丁集）</li>
<li><a href="http://www.couchbase.com/memcached">Couchbase memcached接口</a>: 使用CouchBase作为memcached的替代</li>
<li><a href="https://cybozu.github.io/yrmcds/">yrmcds</a>: 与memcached兼容的主从键值存储</li>
<li><a href="https://github.com/twitter/twemproxy">twemproxy</a>（又名nutcracker）：支持memcached的代理</li>
</ul>
<h3 id="命令备忘单"><a class="header" href="#命令备忘单">命令备忘单</a></h3>
<p>{% content-ref url="memcache-commands.md" %}
<a href="memcache-commands.html">memcache-commands.md</a>
{% endcontent-ref %}</p>
<h3 id="shodan"><a class="header" href="#shodan"><strong>Shodan</strong></a></h3>
<ul>
<li><code>port:11211 "STAT pid"</code></li>
<li><code>"STAT pid"</code></li>
</ul>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://lzone.de/cheat-sheet/memcached">https://lzone.de/cheat-sheet/memcached</a></li>
</ul>
<p>{% hint style="success" %}
学习和实践AWS黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>上关注我们。</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub库提交PR分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/10000-network-data-management-protocol-ndmp.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/11211-memcache/memcache-commands.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/10000-network-data-management-protocol-ndmp.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/11211-memcache/memcache-commands.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
