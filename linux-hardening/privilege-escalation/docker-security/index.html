<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Docker Security</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="docker-å®‰å…¨"><a class="header" href="#docker-å®‰å…¨">Docker å®‰å…¨</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
ä½¿ç”¨ <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=docker-security"><strong>Trickest</strong></a> è½»æ¾æ„å»ºå’Œ <strong>è‡ªåŠ¨åŒ–å·¥ä½œæµ</strong>ï¼Œç”±ä¸–ç•Œä¸Š <strong>æœ€å…ˆè¿›</strong> çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚<br />
ä»Šå¤©å°±è·å–è®¿é—®æƒé™ï¼š</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=docker-security" %}</p>
<h2 id="åŸºæœ¬-docker-å¼•æ“å®‰å…¨"><a class="header" href="#åŸºæœ¬-docker-å¼•æ“å®‰å…¨"><strong>åŸºæœ¬ Docker å¼•æ“å®‰å…¨</strong></a></h2>
<p><strong>Docker å¼•æ“</strong> åˆ©ç”¨ Linux å†…æ ¸çš„ <strong>Namespaces</strong> å’Œ <strong>Cgroups</strong> æ¥éš”ç¦»å®¹å™¨ï¼Œæä¾›åŸºæœ¬çš„å®‰å…¨å±‚ã€‚é€šè¿‡ <strong>èƒ½åŠ›ä¸¢å¼ƒ</strong>ã€<strong>Seccomp</strong> å’Œ <strong>SELinux/AppArmor</strong> æä¾›é¢å¤–ä¿æŠ¤ï¼Œå¢å¼ºå®¹å™¨éš”ç¦»ã€‚ä¸€ä¸ª <strong>auth æ’ä»¶</strong> å¯ä»¥è¿›ä¸€æ­¥é™åˆ¶ç”¨æˆ·æ“ä½œã€‚</p>
<p><img src="https://sreeninet.files.wordpress.com/2016/03/dockersec1.png" alt="Docker å®‰å…¨" /></p>
<h3 id="å®‰å…¨è®¿é—®-docker-å¼•æ“"><a class="header" href="#å®‰å…¨è®¿é—®-docker-å¼•æ“">å®‰å…¨è®¿é—® Docker å¼•æ“</a></h3>
<p>Docker å¼•æ“å¯ä»¥é€šè¿‡ Unix å¥—æ¥å­—æœ¬åœ°è®¿é—®æˆ–é€šè¿‡ HTTP è¿œç¨‹è®¿é—®ã€‚å¯¹äºè¿œç¨‹è®¿é—®ï¼Œä½¿ç”¨ HTTPS å’Œ <strong>TLS</strong> ç¡®ä¿æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œèº«ä»½éªŒè¯è‡³å…³é‡è¦ã€‚</p>
<p>Docker å¼•æ“é»˜è®¤åœ¨ <code>unix:///var/run/docker.sock</code> ä¸Šç›‘å¬ Unix å¥—æ¥å­—ã€‚åœ¨ Ubuntu ç³»ç»Ÿä¸Šï¼ŒDocker çš„å¯åŠ¨é€‰é¡¹åœ¨ <code>/etc/default/docker</code> ä¸­å®šä¹‰ã€‚è¦å¯ç”¨å¯¹ Docker API å’Œå®¢æˆ·ç«¯çš„è¿œç¨‹è®¿é—®ï¼Œé€šè¿‡æ·»åŠ ä»¥ä¸‹è®¾ç½®æ¥é€šè¿‡ HTTP å¥—æ¥å­—å…¬å¼€ Docker å®ˆæŠ¤è¿›ç¨‹ï¼š</p>
<pre><code class="language-bash">DOCKER_OPTS="-D -H unix:///var/run/docker.sock -H tcp://192.168.56.101:2376"
sudo service docker restart
</code></pre>
<p>ç„¶è€Œï¼Œç”±äºå®‰å…¨é—®é¢˜ï¼Œä¸å»ºè®®é€šè¿‡HTTPæš´éœ²Dockerå®ˆæŠ¤è¿›ç¨‹ã€‚å»ºè®®ä½¿ç”¨HTTPSæ¥ä¿æŠ¤è¿æ¥ã€‚ä¿æŠ¤è¿æ¥çš„ä¸»è¦æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨çš„èº«ä»½ã€‚</li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç›¸äº’éªŒè¯å¯¹æ–¹çš„èº«ä»½ã€‚</li>
</ol>
<p>è¯ä¹¦ç”¨äºç¡®è®¤æœåŠ¡å™¨çš„èº«ä»½ã€‚æœ‰å…³è¿™ä¸¤ç§æ–¹æ³•çš„è¯¦ç»†ç¤ºä¾‹ï¼Œè¯·å‚é˜…<a href="https://sreeninet.wordpress.com/2016/03/06/docker-security-part-3engine-access/"><strong>æœ¬æŒ‡å—</strong></a>ã€‚</p>
<h3 id="å®¹å™¨é•œåƒçš„å®‰å…¨æ€§"><a class="header" href="#å®¹å™¨é•œåƒçš„å®‰å…¨æ€§">å®¹å™¨é•œåƒçš„å®‰å…¨æ€§</a></h3>
<p>å®¹å™¨é•œåƒå¯ä»¥å­˜å‚¨åœ¨ç§æœ‰æˆ–å…¬å…±ä»“åº“ä¸­ã€‚Dockerä¸ºå®¹å™¨é•œåƒæä¾›äº†å‡ ç§å­˜å‚¨é€‰é¡¹ï¼š</p>
<ul>
<li><a href="https://hub.docker.com"><strong>Docker Hub</strong></a>: Dockerçš„å…¬å…±æ³¨å†ŒæœåŠ¡ã€‚</li>
<li><a href="https://github.com/docker/distribution"><strong>Docker Registry</strong></a>: ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå…è®¸ç”¨æˆ·æ‰˜ç®¡è‡ªå·±çš„æ³¨å†Œè¡¨ã€‚</li>
<li><a href="https://www.docker.com/docker-trusted-registry"><strong>Docker Trusted Registry</strong></a>: Dockerçš„å•†ä¸šæ³¨å†Œè¡¨äº§å“ï¼Œå…·æœ‰åŸºäºè§’è‰²çš„ç”¨æˆ·èº«ä»½éªŒè¯å’Œä¸LDAPç›®å½•æœåŠ¡çš„é›†æˆã€‚</li>
</ul>
<h3 id="é•œåƒæ‰«æ"><a class="header" href="#é•œåƒæ‰«æ">é•œåƒæ‰«æ</a></h3>
<p>å®¹å™¨å¯èƒ½å­˜åœ¨<strong>å®‰å…¨æ¼æ´</strong>ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºåŸºç¡€é•œåƒæˆ–åœ¨åŸºç¡€é•œåƒä¸Šå®‰è£…çš„è½¯ä»¶é€ æˆçš„ã€‚Dockeræ­£åœ¨è¿›è¡Œä¸€ä¸ªåä¸º<strong>Nautilus</strong>çš„é¡¹ç›®ï¼Œè¯¥é¡¹ç›®å¯¹å®¹å™¨è¿›è¡Œå®‰å…¨æ‰«æå¹¶åˆ—å‡ºæ¼æ´ã€‚Nautilusé€šè¿‡å°†æ¯ä¸ªå®¹å™¨é•œåƒå±‚ä¸æ¼æ´åº“è¿›è¡Œæ¯”è¾ƒæ¥è¯†åˆ«å®‰å…¨æ¼æ´ã€‚</p>
<p>æœ‰å…³æ›´å¤š<a href="https://docs.docker.com/engine/scan/"><strong>ä¿¡æ¯ï¼Œè¯·é˜…è¯»æ­¤æ–‡</strong></a>ã€‚</p>
<ul>
<li><strong><code>docker scan</code></strong></li>
</ul>
<p>**<code>docker scan</code>**å‘½ä»¤å…è®¸æ‚¨ä½¿ç”¨é•œåƒåç§°æˆ–IDæ‰«æç°æœ‰çš„Dockeré•œåƒã€‚ä¾‹å¦‚ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æ‰«æhello-worldé•œåƒï¼š</p>
<pre><code class="language-bash">docker scan hello-world

Testing hello-world...

Organization:      docker-desktop-test
Package manager:   linux
Project name:      docker-image|hello-world
Docker image:      hello-world
Licenses:          enabled

âœ“ Tested 0 dependencies for known issues, no vulnerable paths found.

Note that we do not currently have vulnerability data for your image.
</code></pre>
<ul>
<li><a href="https://github.com/aquasecurity/trivy"><strong><code>trivy</code></strong></a></li>
</ul>
<pre><code class="language-bash">trivy -q -f json &lt;container_name&gt;:&lt;tag&gt;
</code></pre>
<ul>
<li><a href="https://docs.snyk.io/snyk-cli/getting-started-with-the-cli"><strong><code>snyk</code></strong></a></li>
</ul>
<pre><code class="language-bash">snyk container test &lt;image&gt; --json-file-output=&lt;output file&gt; --severity-threshold=high
</code></pre>
<ul>
<li><a href="https://github.com/arminc/clair-scanner"><strong><code>clair-scanner</code></strong></a></li>
</ul>
<pre><code class="language-bash">clair-scanner -w example-alpine.yaml --ip YOUR_LOCAL_IP alpine:3.5
</code></pre>
<h3 id="docker-é•œåƒç­¾å"><a class="header" href="#docker-é•œåƒç­¾å">Docker é•œåƒç­¾å</a></h3>
<p>Docker é•œåƒç­¾åç¡®ä¿äº†åœ¨å®¹å™¨ä¸­ä½¿ç”¨çš„é•œåƒçš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚ä»¥ä¸‹æ˜¯ç®€è¦è¯´æ˜ï¼š</p>
<ul>
<li><strong>Docker å†…å®¹ä¿¡ä»»</strong> åˆ©ç”¨åŸºäºæ›´æ–°æ¡†æ¶ (TUF) çš„ Notary é¡¹ç›®æ¥ç®¡ç†é•œåƒç­¾åã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ <a href="https://github.com/docker/notary">Notary</a> å’Œ <a href="https://theupdateframework.github.io">TUF</a>ã€‚</li>
<li>è¦æ¿€æ´» Docker å†…å®¹ä¿¡ä»»ï¼Œè¯·è®¾ç½® <code>export DOCKER_CONTENT_TRUST=1</code>ã€‚åœ¨ Docker ç‰ˆæœ¬ 1.10 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œæ­¤åŠŸèƒ½é»˜è®¤å…³é—­ã€‚</li>
<li>å¯ç”¨æ­¤åŠŸèƒ½åï¼Œä»…å¯ä»¥ä¸‹è½½ç­¾åçš„é•œåƒã€‚åˆå§‹é•œåƒæ¨é€éœ€è¦ä¸ºæ ¹å¯†é’¥å’Œæ ‡è®°å¯†é’¥è®¾ç½®å¯†ç çŸ­è¯­ï¼ŒDocker è¿˜æ”¯æŒ Yubikey ä»¥å¢å¼ºå®‰å…¨æ€§ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨ <a href="https://blog.docker.com/2015/11/docker-content-trust-yubikey/">è¿™é‡Œ</a> æ‰¾åˆ°ã€‚</li>
<li>å°è¯•åœ¨å¯ç”¨å†…å®¹ä¿¡ä»»çš„æƒ…å†µä¸‹æ‹‰å–æœªç­¾åçš„é•œåƒä¼šå¯¼è‡´ "No trust data for latest" é”™è¯¯ã€‚</li>
<li>åœ¨ç¬¬ä¸€æ¬¡ä¹‹åçš„é•œåƒæ¨é€ä¸­ï¼ŒDocker ä¼šè¦æ±‚è¾“å…¥å­˜å‚¨åº“å¯†é’¥çš„å¯†ç çŸ­è¯­ä»¥ç­¾ç½²é•œåƒã€‚</li>
</ul>
<p>è¦å¤‡ä»½æ‚¨çš„ç§é’¥ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">tar -zcvf private_keys_backup.tar.gz ~/.docker/trust/private
</code></pre>
<p>å½“åˆ‡æ¢ Docker ä¸»æœºæ—¶ï¼Œå¿…é¡»ç§»åŠ¨æ ¹å’Œå­˜å‚¨åº“å¯†é’¥ä»¥ç»´æŒæ“ä½œã€‚</p>
<hr />
<figure><img src="../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
ä½¿ç”¨ <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=docker-security"><strong>Trickest</strong></a> è½»æ¾æ„å»ºå’Œ <strong>è‡ªåŠ¨åŒ–å·¥ä½œæµ</strong>ï¼Œç”±ä¸–ç•Œä¸Š <strong>æœ€å…ˆè¿›</strong> çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚<br />
ç«‹å³è·å–è®¿é—®æƒé™ï¼š</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=docker-security" %}</p>
<h2 id="å®¹å™¨å®‰å…¨ç‰¹æ€§"><a class="header" href="#å®¹å™¨å®‰å…¨ç‰¹æ€§">å®¹å™¨å®‰å…¨ç‰¹æ€§</a></h2>
<details>
<summary>å®¹å™¨å®‰å…¨ç‰¹æ€§æ‘˜è¦</summary>
<p><strong>ä¸»è¦è¿›ç¨‹éš”ç¦»ç‰¹æ€§</strong></p>
<p>åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œéš”ç¦»é¡¹ç›®åŠå…¶è¿›ç¨‹å¯¹äºå®‰å…¨å’Œèµ„æºç®¡ç†è‡³å…³é‡è¦ã€‚ä»¥ä¸‹æ˜¯å…³é”®æ¦‚å¿µçš„ç®€åŒ–è§£é‡Šï¼š</p>
<p><strong>å‘½åç©ºé—´</strong></p>
<ul>
<li><strong>ç›®çš„</strong>ï¼šç¡®ä¿è¿›ç¨‹ã€ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿç­‰èµ„æºçš„éš”ç¦»ã€‚ç‰¹åˆ«æ˜¯åœ¨ Docker ä¸­ï¼Œå‘½åç©ºé—´ä½¿å®¹å™¨çš„è¿›ç¨‹ä¸ä¸»æœºå’Œå…¶ä»–å®¹å™¨åˆ†å¼€ã€‚</li>
<li><strong><code>unshare</code> çš„ä½¿ç”¨</strong>ï¼š<code>unshare</code> å‘½ä»¤ï¼ˆæˆ–åº•å±‚ç³»ç»Ÿè°ƒç”¨ï¼‰ç”¨äºåˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œæä¾›é¢å¤–çš„éš”ç¦»å±‚ã€‚ç„¶è€Œï¼Œè™½ç„¶ Kubernetes æœ¬èº«å¹¶ä¸é˜»æ­¢è¿™ä¸€ç‚¹ï¼Œä½† Docker æ˜¯ä¼šçš„ã€‚</li>
<li><strong>é™åˆ¶</strong>ï¼šåˆ›å»ºæ–°å‘½åç©ºé—´å¹¶ä¸å…è®¸è¿›ç¨‹æ¢å¤åˆ°ä¸»æœºçš„é»˜è®¤å‘½åç©ºé—´ã€‚è¦è¿›å…¥ä¸»æœºå‘½åç©ºé—´ï¼Œé€šå¸¸éœ€è¦è®¿é—®ä¸»æœºçš„ <code>/proc</code> ç›®å½•ï¼Œå¹¶ä½¿ç”¨ <code>nsenter</code> è¿›è¡Œè¿›å…¥ã€‚</li>
</ul>
<p><strong>æ§åˆ¶ç»„ (CGroups)</strong></p>
<ul>
<li><strong>åŠŸèƒ½</strong>ï¼šä¸»è¦ç”¨äºåœ¨è¿›ç¨‹ä¹‹é—´åˆ†é…èµ„æºã€‚</li>
<li><strong>å®‰å…¨æ–¹é¢</strong>ï¼šCGroups æœ¬èº«ä¸æä¾›éš”ç¦»å®‰å…¨ï¼Œé™¤äº† <code>release_agent</code> ç‰¹æ€§ï¼Œå¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šè¢«åˆ©ç”¨è¿›è¡Œæœªç»æˆæƒçš„è®¿é—®ã€‚</li>
</ul>
<p><strong>èƒ½åŠ›ä¸¢å¼ƒ</strong></p>
<ul>
<li><strong>é‡è¦æ€§</strong>ï¼šè¿™æ˜¯è¿›ç¨‹éš”ç¦»çš„é‡è¦å®‰å…¨ç‰¹æ€§ã€‚</li>
<li><strong>åŠŸèƒ½</strong>ï¼šé€šè¿‡ä¸¢å¼ƒæŸäº›èƒ½åŠ›æ¥é™åˆ¶æ ¹è¿›ç¨‹å¯ä»¥æ‰§è¡Œçš„æ“ä½œã€‚å³ä½¿è¿›ç¨‹ä»¥æ ¹æƒé™è¿è¡Œï¼Œç¼ºä¹å¿…è¦çš„èƒ½åŠ›ä¹Ÿä¼šé˜»æ­¢å…¶æ‰§è¡Œç‰¹æƒæ“ä½œï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨å°†å› æƒé™ä¸è¶³è€Œå¤±è´¥ã€‚</li>
</ul>
<p>è¿™äº›æ˜¯è¿›ç¨‹ä¸¢å¼ƒå…¶ä»–èƒ½åŠ›åçš„ <strong>å‰©ä½™èƒ½åŠ›</strong>ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code>Current: cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap=ep
</code></pre>
<p>{% endcode %}</p>
<p><strong>Seccomp</strong></p>
<p>å®ƒåœ¨ Docker ä¸­é»˜è®¤å¯ç”¨ã€‚å®ƒæœ‰åŠ©äº<strong>è¿›ä¸€æ­¥é™åˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨</strong>ã€‚<br />
<strong>é»˜è®¤çš„ Docker Seccomp é…ç½®æ–‡ä»¶</strong>å¯ä»¥åœ¨ <a href="https://github.com/moby/moby/blob/master/profiles/seccomp/default.json">https://github.com/moby/moby/blob/master/profiles/seccomp/default.json</a> æ‰¾åˆ°ã€‚</p>
<p><strong>AppArmor</strong></p>
<p>Docker æœ‰ä¸€ä¸ªå¯ä»¥æ¿€æ´»çš„æ¨¡æ¿ï¼š<a href="https://github.com/moby/moby/tree/master/profiles/apparmor">https://github.com/moby/moby/tree/master/profiles/apparmor</a></p>
<p>è¿™å°†å…è®¸å‡å°‘èƒ½åŠ›ã€ç³»ç»Ÿè°ƒç”¨ã€å¯¹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„è®¿é—®...</p>
</details>
<h3 id="namespaces"><a class="header" href="#namespaces">Namespaces</a></h3>
<p><strong>Namespaces</strong> æ˜¯ Linux å†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒ<strong>å°†å†…æ ¸èµ„æºè¿›è¡Œåˆ†åŒº</strong>ï¼Œä½¿å¾—ä¸€ç»„<strong>è¿›ç¨‹****çœ‹åˆ°</strong>ä¸€ç»„<strong>èµ„æº</strong>ï¼Œè€Œ<strong>å¦ä¸€</strong>ç»„<strong>è¿›ç¨‹</strong>çœ‹åˆ°<strong>ä¸åŒ</strong>çš„èµ„æºã€‚è¯¥ç‰¹æ€§é€šè¿‡ä¸ºä¸€ç»„èµ„æºå’Œè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„å‘½åç©ºé—´æ¥å·¥ä½œï¼Œä½†è¿™äº›å‘½åç©ºé—´æŒ‡å‘ä¸åŒçš„èµ„æºã€‚èµ„æºå¯ä»¥å­˜åœ¨äºå¤šä¸ªç©ºé—´ä¸­ã€‚</p>
<p>Docker åˆ©ç”¨ä»¥ä¸‹ Linux å†…æ ¸å‘½åç©ºé—´æ¥å®ç°å®¹å™¨éš”ç¦»ï¼š</p>
<ul>
<li>pid namespace</li>
<li>mount namespace</li>
<li>network namespace</li>
<li>ipc namespace</li>
<li>UTS namespace</li>
</ul>
<p>æœ‰å…³<strong>å‘½åç©ºé—´çš„æ›´å¤šä¿¡æ¯</strong>ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼š</p>
<p>{% content-ref url="namespaces/" %}
<a href="namespaces/">namespaces</a>
{% endcontent-ref %}</p>
<h3 id="cgroups"><a class="header" href="#cgroups">cgroups</a></h3>
<p>Linux å†…æ ¸ç‰¹æ€§<strong>cgroups</strong>æä¾›äº†<strong>é™åˆ¶ä¸€ç»„è¿›ç¨‹çš„èµ„æºï¼Œå¦‚ CPUã€å†…å­˜ã€IOã€ç½‘ç»œå¸¦å®½</strong>çš„èƒ½åŠ›ã€‚Docker å…è®¸ä½¿ç”¨ cgroup ç‰¹æ€§åˆ›å»ºå®¹å™¨ï¼Œä»è€Œå®ç°å¯¹ç‰¹å®šå®¹å™¨çš„èµ„æºæ§åˆ¶ã€‚<br />
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´å†…å­˜é™åˆ¶ä¸º 500mï¼Œå†…æ ¸å†…å­˜é™åˆ¶ä¸º 50mï¼ŒCPU å…±äº«ä¸º 512ï¼Œblkio-weight ä¸º 400 çš„å®¹å™¨ã€‚CPU å…±äº«æ˜¯æ§åˆ¶å®¹å™¨ CPU ä½¿ç”¨çš„æ¯”ä¾‹ã€‚å®ƒçš„é»˜è®¤å€¼ä¸º 1024ï¼ŒèŒƒå›´åœ¨ 0 åˆ° 1024 ä¹‹é—´ã€‚å¦‚æœä¸‰ä¸ªå®¹å™¨çš„ CPU å…±äº«å‡ä¸º 1024ï¼Œåˆ™åœ¨ CPU èµ„æºäº‰ç”¨çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå®¹å™¨æœ€å¤šå¯ä»¥å ç”¨ 33% çš„ CPUã€‚blkio-weight æ˜¯æ§åˆ¶å®¹å™¨ IO çš„æ¯”ä¾‹ã€‚å®ƒçš„é»˜è®¤å€¼ä¸º 500ï¼ŒèŒƒå›´åœ¨ 10 åˆ° 1000 ä¹‹é—´ã€‚</p>
<pre><code>docker run -it -m 500M --kernel-memory 50M --cpu-shares 512 --blkio-weight 400 --name ubuntu1 ubuntu bash
</code></pre>
<p>è¦è·å–å®¹å™¨çš„ cgroupï¼Œæ‚¨å¯ä»¥æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">docker run -dt --rm denial sleep 1234 #Run a large sleep inside a Debian container
ps -ef | grep 1234 #Get info about the sleep process
ls -l /proc/&lt;PID&gt;/ns #Get the Group and the namespaces (some may be uniq to the hosts and some may be shred with it)
</code></pre>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š</p>
<p>{% content-ref url="cgroups.md" %}
<a href="cgroups.html">cgroups.md</a>
{% endcontent-ref %}</p>
<h3 id="èƒ½åŠ›"><a class="header" href="#èƒ½åŠ›">èƒ½åŠ›</a></h3>
<p>èƒ½åŠ›å…è®¸<strong>å¯¹å¯ä»¥å…è®¸çš„æ ¹ç”¨æˆ·èƒ½åŠ›è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶</strong>ã€‚Dockerä½¿ç”¨Linuxå†…æ ¸èƒ½åŠ›ç‰¹æ€§æ¥<strong>é™åˆ¶å¯ä»¥åœ¨å®¹å™¨å†…æ‰§è¡Œçš„æ“ä½œ</strong>ï¼Œæ— è®ºç”¨æˆ·ç±»å‹å¦‚ä½•ã€‚</p>
<p>å½“è¿è¡Œdockerå®¹å™¨æ—¶ï¼Œ<strong>è¿›ç¨‹ä¼šæ”¾å¼ƒæ•æ„Ÿèƒ½åŠ›ï¼Œä»¥é˜²æ­¢è¿›ç¨‹é€ƒç¦»éš”ç¦»</strong>ã€‚è¿™è¯•å›¾ç¡®ä¿è¿›ç¨‹æ— æ³•æ‰§è¡Œæ•æ„Ÿæ“ä½œå¹¶é€ƒé€¸ï¼š</p>
<p>{% content-ref url="../linux-capabilities.md" %}
<a href="../linux-capabilities.html">linux-capabilities.md</a>
{% endcontent-ref %}</p>
<h3 id="dockerä¸­çš„seccomp"><a class="header" href="#dockerä¸­çš„seccomp">Dockerä¸­çš„Seccomp</a></h3>
<p>è¿™æ˜¯ä¸€ç§å®‰å…¨ç‰¹æ€§ï¼Œå…è®¸Docker<strong>é™åˆ¶å¯ä»¥åœ¨å®¹å™¨å†…ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼š</p>
<p>{% content-ref url="seccomp.md" %}
<a href="seccomp.html">seccomp.md</a>
{% endcontent-ref %}</p>
<h3 id="dockerä¸­çš„apparmor"><a class="header" href="#dockerä¸­çš„apparmor">Dockerä¸­çš„AppArmor</a></h3>
<p><strong>AppArmor</strong>æ˜¯ä¸€ä¸ªå†…æ ¸å¢å¼ºï¼Œç”¨äºå°†<strong>å®¹å™¨</strong>é™åˆ¶åœ¨<strong>æœ‰é™</strong>çš„<strong>èµ„æº</strong>é›†å†…ï¼Œå¹¶å…·æœ‰<strong>æ¯ä¸ªç¨‹åºçš„é…ç½®æ–‡ä»¶</strong>ï¼š</p>
<p>{% content-ref url="apparmor.md" %}
<a href="apparmor.html">apparmor.md</a>
{% endcontent-ref %}</p>
<h3 id="dockerä¸­çš„selinux"><a class="header" href="#dockerä¸­çš„selinux">Dockerä¸­çš„SELinux</a></h3>
<ul>
<li><strong>æ ‡è®°ç³»ç»Ÿ</strong>ï¼šSELinuxä¸ºæ¯ä¸ªè¿›ç¨‹å’Œæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ ‡ç­¾ã€‚</li>
<li><strong>ç­–ç•¥æ‰§è¡Œ</strong>ï¼šå®ƒæ‰§è¡Œå®šä¹‰è¿›ç¨‹æ ‡ç­¾å¯ä»¥å¯¹ç³»ç»Ÿå†…å…¶ä»–æ ‡ç­¾æ‰§è¡Œå“ªäº›æ“ä½œçš„å®‰å…¨ç­–ç•¥ã€‚</li>
<li><strong>å®¹å™¨è¿›ç¨‹æ ‡ç­¾</strong>ï¼šå½“å®¹å™¨å¼•æ“å¯åŠ¨å®¹å™¨è¿›ç¨‹æ—¶ï¼Œé€šå¸¸ä¼šåˆ†é…ä¸€ä¸ªå—é™çš„SELinuxæ ‡ç­¾ï¼Œé€šå¸¸ä¸º<code>container_t</code>ã€‚</li>
<li><strong>å®¹å™¨å†…çš„æ–‡ä»¶æ ‡è®°</strong>ï¼šå®¹å™¨å†…çš„æ–‡ä»¶é€šå¸¸æ ‡è®°ä¸º<code>container_file_t</code>ã€‚</li>
<li><strong>ç­–ç•¥è§„åˆ™</strong>ï¼šSELinuxç­–ç•¥ä¸»è¦ç¡®ä¿å…·æœ‰<code>container_t</code>æ ‡ç­¾çš„è¿›ç¨‹åªèƒ½ä¸æ ‡è®°ä¸º<code>container_file_t</code>çš„æ–‡ä»¶è¿›è¡Œäº¤äº’ï¼ˆè¯»å–ã€å†™å…¥ã€æ‰§è¡Œï¼‰ã€‚</li>
</ul>
<p>è¯¥æœºåˆ¶ç¡®ä¿å³ä½¿å®¹å™¨å†…çš„è¿›ç¨‹è¢«æ”»é™·ï¼Œå®ƒä¹Ÿä»…é™äºä¸å…·æœ‰ç›¸åº”æ ‡ç­¾çš„å¯¹è±¡è¿›è¡Œäº¤äº’ï¼Œä»è€Œæ˜¾è‘—é™åˆ¶æ­¤ç±»æ”»é™·å¯èƒ½é€ æˆçš„æŸå®³ã€‚</p>
<p>{% content-ref url="../selinux.md" %}
<a href="../selinux.html">selinux.md</a>
{% endcontent-ref %}</p>
<h3 id="authz--authn"><a class="header" href="#authz--authn">AuthZ &amp; AuthN</a></h3>
<p>åœ¨Dockerä¸­ï¼Œæˆæƒæ’ä»¶åœ¨å®‰å…¨æ€§æ–¹é¢å‘æŒ¥ç€å…³é”®ä½œç”¨ï¼Œé€šè¿‡å†³å®šæ˜¯å¦å…è®¸æˆ–é˜»æ­¢å¯¹Dockerå®ˆæŠ¤è¿›ç¨‹çš„è¯·æ±‚æ¥å®ç°ã€‚è¿™ä¸€å†³å®šæ˜¯é€šè¿‡æ£€æŸ¥ä¸¤ä¸ªå…³é”®ä¸Šä¸‹æ–‡æ¥åšå‡ºçš„ï¼š</p>
<ul>
<li><strong>èº«ä»½éªŒè¯ä¸Šä¸‹æ–‡</strong>ï¼šè¿™åŒ…æ‹¬æœ‰å…³ç”¨æˆ·çš„å…¨é¢ä¿¡æ¯ï¼Œä¾‹å¦‚ä»–ä»¬æ˜¯è°ä»¥åŠä»–ä»¬å¦‚ä½•è¿›è¡Œèº«ä»½éªŒè¯ã€‚</li>
<li><strong>å‘½ä»¤ä¸Šä¸‹æ–‡</strong>ï¼šè¿™åŒ…æ‹¬ä¸æ‰€å‘å‡ºè¯·æ±‚ç›¸å…³çš„æ‰€æœ‰ç›¸å…³æ•°æ®ã€‚</li>
</ul>
<p>è¿™äº›ä¸Šä¸‹æ–‡æœ‰åŠ©äºç¡®ä¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·çš„åˆæ³•è¯·æ±‚è¢«å¤„ç†ï¼Œä»è€Œå¢å¼ºDockeræ“ä½œçš„å®‰å…¨æ€§ã€‚</p>
<p>{% content-ref url="authz-and-authn-docker-access-authorization-plugin.md" %}
<a href="authz-and-authn-docker-access-authorization-plugin.html">authz-and-authn-docker-access-authorization-plugin.md</a>
{% endcontent-ref %}</p>
<h2 id="æ¥è‡ªå®¹å™¨çš„dos"><a class="header" href="#æ¥è‡ªå®¹å™¨çš„dos">æ¥è‡ªå®¹å™¨çš„DoS</a></h2>
<p>å¦‚æœæ‚¨æ²¡æœ‰æ­£ç¡®é™åˆ¶å®¹å™¨å¯ä»¥ä½¿ç”¨çš„èµ„æºï¼Œåˆ™è¢«æ”»é™·çš„å®¹å™¨å¯èƒ½ä¼šå¯¹å…¶è¿è¡Œçš„ä¸»æœºé€ æˆDoSã€‚</p>
<ul>
<li>CPU DoS</li>
</ul>
<pre><code class="language-bash"># stress-ng
sudo apt-get install -y stress-ng &amp;&amp; stress-ng --vm 1 --vm-bytes 1G --verify -t 5m

# While loop
docker run -d --name malicious-container -c 512 busybox sh -c 'while true; do :; done'
</code></pre>
<ul>
<li>å¸¦å®½ DoS</li>
</ul>
<pre><code class="language-bash">nc -lvp 4444 &gt;/dev/null &amp; while true; do cat /dev/urandom | nc &lt;target IP&gt; 4444; done
</code></pre>
<h2 id="æœ‰è¶£çš„-docker-æ ‡å¿—"><a class="header" href="#æœ‰è¶£çš„-docker-æ ‡å¿—">æœ‰è¶£çš„ Docker æ ‡å¿—</a></h2>
<h3 id="--privileged-æ ‡å¿—"><a class="header" href="#--privileged-æ ‡å¿—">--privileged æ ‡å¿—</a></h3>
<p>åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥äº†è§£ <strong><code>--privileged</code> æ ‡å¿—çš„å«ä¹‰</strong>ï¼š</p>
<p>{% content-ref url="docker-privileged.md" %}
<a href="docker-privileged.html">docker-privileged.md</a>
{% endcontent-ref %}</p>
<h3 id="--security-opt"><a class="header" href="#--security-opt">--security-opt</a></h3>
<h4 id="no-new-privileges"><a class="header" href="#no-new-privileges">no-new-privileges</a></h4>
<p>å¦‚æœæ‚¨æ­£åœ¨è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œæ”»å‡»è€…è®¾æ³•ä»¥ä½æƒé™ç”¨æˆ·èº«ä»½è·å¾—è®¿é—®æƒé™ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ª <strong>é…ç½®é”™è¯¯çš„ suid äºŒè¿›åˆ¶æ–‡ä»¶</strong>ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨å®ƒå¹¶ <strong>åœ¨å®¹å™¨å†…æå‡æƒé™</strong>ã€‚è¿™å¯èƒ½å…è®¸ä»–é€ƒç¦»å®¹å™¨ã€‚</p>
<p>å¯ç”¨ <strong><code>no-new-privileges</code></strong> é€‰é¡¹è¿è¡Œå®¹å™¨å°† <strong>é˜²æ­¢è¿™ç§æƒé™æå‡</strong>ã€‚</p>
<pre><code>docker run -it --security-opt=no-new-privileges:true nonewpriv
</code></pre>
<h4 id="å…¶ä»–"><a class="header" href="#å…¶ä»–">å…¶ä»–</a></h4>
<pre><code class="language-bash">#You can manually add/drop capabilities with
--cap-add
--cap-drop

# You can manually disable seccomp in docker with
--security-opt seccomp=unconfined

# You can manually disable seccomp in docker with
--security-opt apparmor=unconfined

# You can manually disable selinux in docker with
--security-opt label:disable
</code></pre>
<p>å¯¹äºæ›´å¤š <strong><code>--security-opt</code></strong> é€‰é¡¹ï¼Œè¯·æŸ¥çœ‹: <a href="https://docs.docker.com/engine/reference/run/#security-configuration">https://docs.docker.com/engine/reference/run/#security-configuration</a></p>
<h2 id="å…¶ä»–å®‰å…¨è€ƒè™‘"><a class="header" href="#å…¶ä»–å®‰å…¨è€ƒè™‘">å…¶ä»–å®‰å…¨è€ƒè™‘</a></h2>
<h3 id="ç®¡ç†æœºå¯†æœ€ä½³å®è·µ"><a class="header" href="#ç®¡ç†æœºå¯†æœ€ä½³å®è·µ">ç®¡ç†æœºå¯†ï¼šæœ€ä½³å®è·µ</a></h3>
<p>é¿å…ç›´æ¥åœ¨ Docker é•œåƒä¸­åµŒå…¥æœºå¯†æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡è‡³å…³é‡è¦ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•ä¼šé€šè¿‡ <code>docker inspect</code> æˆ– <code>exec</code> ç­‰å‘½ä»¤å°†æ‚¨çš„æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™ä»»ä½•å¯ä»¥è®¿é—®å®¹å™¨çš„äººã€‚</p>
<p><strong>Docker å·</strong> æ˜¯ä¸€ç§æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ¨èç”¨äºè®¿é—®æ•æ„Ÿä¿¡æ¯ã€‚å®ƒä»¬å¯ä»¥ä½œä¸ºå†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ï¼Œä»è€Œé™ä½ä¸ <code>docker inspect</code> å’Œæ—¥å¿—è®°å½•ç›¸å…³çš„é£é™©ã€‚ç„¶è€Œï¼Œæ ¹ç”¨æˆ·å’Œå…·æœ‰ <code>exec</code> è®¿é—®æƒé™çš„ç”¨æˆ·ä»ç„¶å¯èƒ½è®¿é—®è¿™äº›æœºå¯†ã€‚</p>
<p><strong>Docker secrets</strong> æä¾›äº†ä¸€ç§æ›´å®‰å…¨çš„æ–¹æ³•æ¥å¤„ç†æ•æ„Ÿä¿¡æ¯ã€‚å¯¹äºåœ¨é•œåƒæ„å»ºé˜¶æ®µéœ€è¦æœºå¯†çš„å®ä¾‹ï¼Œ<strong>BuildKit</strong> æä¾›äº†ä¸€ç§é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒæ„å»ºæ—¶æœºå¯†ï¼Œæå‡æ„å»ºé€Ÿåº¦å¹¶æä¾›é¢å¤–åŠŸèƒ½ã€‚</p>
<p>è¦åˆ©ç”¨ BuildKitï¼Œå¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¿€æ´»ï¼š</p>
<ol>
<li>é€šè¿‡ç¯å¢ƒå˜é‡: <code>export DOCKER_BUILDKIT=1</code></li>
<li>é€šè¿‡å‘½ä»¤å‰ç¼€: <code>DOCKER_BUILDKIT=1 docker build .</code></li>
<li>é€šè¿‡åœ¨ Docker é…ç½®ä¸­é»˜è®¤å¯ç”¨: <code>{ "features": { "buildkit": true } }</code>ï¼Œç„¶åé‡å¯ Dockerã€‚</li>
</ol>
<p>BuildKit å…è®¸ä½¿ç”¨ <code>--secret</code> é€‰é¡¹æ¥ä½¿ç”¨æ„å»ºæ—¶æœºå¯†ï¼Œç¡®ä¿è¿™äº›æœºå¯†ä¸åŒ…å«åœ¨é•œåƒæ„å»ºç¼“å­˜æˆ–æœ€ç»ˆé•œåƒä¸­ï¼Œä½¿ç”¨å‘½ä»¤å¦‚ä¸‹:</p>
<pre><code class="language-bash">docker build --secret my_key=my_value ,src=path/to/my_secret_file .
</code></pre>
<p>å¯¹äºè¿è¡Œä¸­çš„å®¹å™¨æ‰€éœ€çš„ç§˜å¯†ï¼Œ<strong>Docker Compose å’Œ Kubernetes</strong> æä¾›äº†å¼ºå¤§çš„è§£å†³æ–¹æ¡ˆã€‚Docker Compose åœ¨æœåŠ¡å®šä¹‰ä¸­ä½¿ç”¨ <code>secrets</code> é”®æ¥æŒ‡å®šç§˜å¯†æ–‡ä»¶ï¼Œå¦‚ <code>docker-compose.yml</code> ç¤ºä¾‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-yaml">version: "3.7"
services:
my_service:
image: centos:7
entrypoint: "cat /run/secrets/my_secret"
secrets:
- my_secret
secrets:
my_secret:
file: ./my_secret_file.txt
</code></pre>
<p>æ­¤é…ç½®å…è®¸åœ¨ä½¿ç”¨ Docker Compose å¯åŠ¨æœåŠ¡æ—¶ä½¿ç”¨ç§˜å¯†ã€‚</p>
<p>åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œç§˜å¯†æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡åƒ <a href="https://github.com/futuresimple/helm-secrets">Helm-Secrets</a> è¿™æ ·çš„å·¥å…·è¿›ä¸€æ­¥ç®¡ç†ã€‚Kubernetes çš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC) å¢å¼ºäº†ç§˜å¯†ç®¡ç†çš„å®‰å…¨æ€§ï¼Œç±»ä¼¼äº Docker Enterpriseã€‚</p>
<h3 id="gvisor"><a class="header" href="#gvisor">gVisor</a></h3>
<p><strong>gVisor</strong> æ˜¯ä¸€ä¸ªåº”ç”¨å†…æ ¸ï¼Œä½¿ç”¨ Go ç¼–å†™ï¼Œå®æ–½äº† Linux ç³»ç»Ÿè¡¨é¢çš„ç›¸å½“å¤§ä¸€éƒ¨åˆ†ã€‚å®ƒåŒ…æ‹¬ä¸€ä¸ªåä¸º <code>runsc</code> çš„ <a href="https://www.opencontainers.org">å¼€æ”¾å®¹å™¨å€¡è®® (OCI)</a> è¿è¡Œæ—¶ï¼Œæä¾›äº† <strong>åº”ç”¨ç¨‹åºä¸ä¸»æœºå†…æ ¸ä¹‹é—´çš„éš”ç¦»è¾¹ç•Œ</strong>ã€‚<code>runsc</code> è¿è¡Œæ—¶ä¸ Docker å’Œ Kubernetes é›†æˆï¼Œä½¿å¾—è¿è¡Œæ²™ç®±å®¹å™¨å˜å¾—ç®€å•ã€‚</p>
<p>{% embed url="https://github.com/google/gvisor" %}</p>
<h3 id="kata-containers"><a class="header" href="#kata-containers">Kata Containers</a></h3>
<p><strong>Kata Containers</strong> æ˜¯ä¸€ä¸ªå¼€æºç¤¾åŒºï¼Œè‡´åŠ›äºæ„å»ºä¸€ä¸ªå®‰å…¨çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨è½»é‡çº§è™šæ‹Ÿæœºï¼Œæ„Ÿè§‰å’Œè¡¨ç°åƒå®¹å™¨ï¼Œä½†æä¾› <strong>ä½¿ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯çš„æ›´å¼ºå·¥ä½œè´Ÿè½½éš”ç¦»</strong> ä½œä¸ºç¬¬äºŒé“é˜²çº¿ã€‚</p>
<p>{% embed url="https://katacontainers.io/" %}</p>
<h3 id="æ€»ç»“æç¤º"><a class="header" href="#æ€»ç»“æç¤º">æ€»ç»“æç¤º</a></h3>
<ul>
<li><strong>ä¸è¦ä½¿ç”¨ <code>--privileged</code> æ ‡å¿—æˆ–åœ¨å®¹å™¨å†…æŒ‚è½½</strong> <a href="https://raesene.github.io/blog/2016/03/06/The-Dangers-Of-Docker.sock/"><strong>Docker å¥—æ¥å­—</strong></a><strong>ã€‚</strong> Docker å¥—æ¥å­—å…è®¸ç”Ÿæˆå®¹å™¨ï¼Œå› æ­¤è¿™æ˜¯å®Œå…¨æ§åˆ¶ä¸»æœºçš„ç®€å•æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡ä½¿ç”¨ <code>--privileged</code> æ ‡å¿—è¿è¡Œå¦ä¸€ä¸ªå®¹å™¨ã€‚</li>
<li><strong>ä¸è¦åœ¨å®¹å™¨å†…ä»¥ root èº«ä»½è¿è¡Œã€‚ä½¿ç”¨</strong> <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user"><strong>ä¸åŒç”¨æˆ·</strong></a> <strong>å’Œ</strong> <a href="https://docs.docker.com/engine/security/userns-remap/"><strong>ç”¨æˆ·å‘½åç©ºé—´</strong></a><strong>ã€‚</strong> å®¹å™¨ä¸­çš„ root ä¸ä¸»æœºä¸Šçš„ root æ˜¯ç›¸åŒçš„ï¼Œé™¤éé€šè¿‡ç”¨æˆ·å‘½åç©ºé—´é‡æ–°æ˜ å°„ã€‚å®ƒä»…å—åˆ° Linux å‘½åç©ºé—´ã€èƒ½åŠ›å’Œ cgroups çš„è½»å¾®é™åˆ¶ã€‚</li>
<li><a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities"><strong>ä¸¢å¼ƒæ‰€æœ‰èƒ½åŠ›</strong></a> <strong>(<code>--cap-drop=all</code>)ï¼Œä»…å¯ç”¨æ‰€éœ€çš„èƒ½åŠ›</strong> (<code>--cap-add=...</code>)ã€‚è®¸å¤šå·¥ä½œè´Ÿè½½ä¸éœ€è¦ä»»ä½•èƒ½åŠ›ï¼Œæ·»åŠ å®ƒä»¬ä¼šå¢åŠ æ½œåœ¨æ”»å‡»çš„èŒƒå›´ã€‚</li>
<li><a href="https://raesene.github.io/blog/2019/06/01/docker-capabilities-and-no-new-privs/"><strong>ä½¿ç”¨â€œno-new-privilegesâ€å®‰å…¨é€‰é¡¹</strong></a> é˜²æ­¢è¿›ç¨‹è·å¾—æ›´å¤šæƒé™ï¼Œä¾‹å¦‚é€šè¿‡ suid äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li>
<li><a href="https://docs.docker.com/engine/reference/run/#runtime-constraints-on-resources"><strong>é™åˆ¶å®¹å™¨å¯ç”¨çš„èµ„æº</strong></a><strong>ã€‚</strong> èµ„æºé™åˆ¶å¯ä»¥ä¿æŠ¤æœºå™¨å…å—æ‹’ç»æœåŠ¡æ”»å‡»ã€‚</li>
<li><strong>è°ƒæ•´</strong> <a href="https://docs.docker.com/engine/security/seccomp/"><strong>seccomp</strong></a><strong>ã€</strong> <a href="https://docs.docker.com/engine/security/apparmor/"><strong>AppArmor</strong></a> <strong>ï¼ˆæˆ– SELinuxï¼‰</strong> é…ç½®æ–‡ä»¶ï¼Œä»¥å°†å®¹å™¨å¯ç”¨çš„æ“ä½œå’Œç³»ç»Ÿè°ƒç”¨é™åˆ¶åˆ°æœ€ä½è¦æ±‚ã€‚</li>
<li><strong>ä½¿ç”¨</strong> <a href="https://docs.docker.com/docker-hub/official_images/"><strong>å®˜æ–¹ Docker é•œåƒ</strong></a> <strong>å¹¶è¦æ±‚ç­¾å</strong>ï¼Œæˆ–åŸºäºå®ƒä»¬æ„å»ºè‡ªå·±çš„é•œåƒã€‚ä¸è¦ç»§æ‰¿æˆ–ä½¿ç”¨ <a href="https://arstechnica.com/information-technology/2018/06/backdoored-images-downloaded-5-million-times-finally-removed-from-docker-hub/">åé—¨</a> é•œåƒã€‚è¿˜è¦å°† root å¯†é’¥ã€å¯†ç çŸ­è¯­å­˜æ”¾åœ¨å®‰å…¨çš„åœ°æ–¹ã€‚Docker è®¡åˆ’é€šè¿‡ UCP ç®¡ç†å¯†é’¥ã€‚</li>
<li><strong>å®šæœŸ</strong> <strong>é‡å»º</strong> é•œåƒä»¥ <strong>åº”ç”¨å®‰å…¨è¡¥ä¸åˆ°ä¸»æœºå’Œé•œåƒã€‚</strong></li>
<li>æ˜æ™ºåœ°ç®¡ç†æ‚¨çš„ <strong>ç§˜å¯†</strong>ï¼Œä½¿æ”»å‡»è€…éš¾ä»¥è®¿é—®å®ƒä»¬ã€‚</li>
<li>å¦‚æœæ‚¨ <strong>æš´éœ² Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œè¯·ä½¿ç”¨ HTTPS</strong>ï¼Œå¹¶è¿›è¡Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨èº«ä»½éªŒè¯ã€‚</li>
<li>åœ¨æ‚¨çš„ Dockerfile ä¸­ï¼Œ<strong>ä¼˜å…ˆä½¿ç”¨ COPY è€Œä¸æ˜¯ ADD</strong>ã€‚ADD ä¼šè‡ªåŠ¨æå–å‹ç¼©æ–‡ä»¶ï¼Œå¹¶å¯ä»¥ä» URL å¤åˆ¶æ–‡ä»¶ã€‚COPY æ²¡æœ‰è¿™äº›åŠŸèƒ½ã€‚å°½å¯èƒ½é¿å…ä½¿ç”¨ ADDï¼Œä»¥å…å—åˆ°é€šè¿‡è¿œç¨‹ URL å’Œ Zip æ–‡ä»¶çš„æ”»å‡»ã€‚</li>
<li>ä¸ºæ¯ä¸ªå¾®æœåŠ¡ <strong>ä½¿ç”¨å•ç‹¬çš„å®¹å™¨</strong></li>
<li><strong>ä¸è¦åœ¨å®¹å™¨å†…æ”¾ç½® ssh</strong>ï¼Œå¯ä»¥ä½¿ç”¨ â€œdocker execâ€ è¿æ¥åˆ°å®¹å™¨ã€‚</li>
<li>æ‹¥æœ‰ <strong>æ›´å°çš„</strong> å®¹å™¨ <strong>é•œåƒ</strong></li>
</ul>
<h2 id="docker-çªç ´--æƒé™æå‡"><a class="header" href="#docker-çªç ´--æƒé™æå‡">Docker çªç ´ / æƒé™æå‡</a></h2>
<p>å¦‚æœæ‚¨ <strong>åœ¨ Docker å®¹å™¨å†…</strong> æˆ–è€…æ‚¨æœ‰æƒè®¿é—® <strong>docker ç»„ä¸­çš„ç”¨æˆ·</strong>ï¼Œæ‚¨å¯ä»¥å°è¯• <strong>é€ƒé€¸å¹¶æå‡æƒé™</strong>ï¼š</p>
<p>{% content-ref url="docker-breakout-privilege-escalation/" %}
<a href="docker-breakout-privilege-escalation/">docker-breakout-privilege-escalation</a>
{% endcontent-ref %}</p>
<h2 id="docker-èº«ä»½éªŒè¯æ’ä»¶ç»•è¿‡"><a class="header" href="#docker-èº«ä»½éªŒè¯æ’ä»¶ç»•è¿‡">Docker èº«ä»½éªŒè¯æ’ä»¶ç»•è¿‡</a></h2>
<p>å¦‚æœæ‚¨å¯ä»¥è®¿é—® Docker å¥—æ¥å­—æˆ–æœ‰æƒè®¿é—® <strong>docker ç»„ä¸­çš„ç”¨æˆ·ï¼Œä½†æ‚¨çš„æ“ä½œå—åˆ° Docker èº«ä»½éªŒè¯æ’ä»¶çš„é™åˆ¶</strong>ï¼Œè¯·æ£€æŸ¥æ‚¨æ˜¯å¦å¯ä»¥ <strong>ç»•è¿‡å®ƒï¼š</strong></p>
<p>{% content-ref url="authz-and-authn-docker-access-authorization-plugin.md" %}
<a href="authz-and-authn-docker-access-authorization-plugin.html">authz-and-authn-docker-access-authorization-plugin.md</a>
{% endcontent-ref %}</p>
<h2 id="åŠ å›º-docker"><a class="header" href="#åŠ å›º-docker">åŠ å›º Docker</a></h2>
<ul>
<li>å·¥å…· <a href="https://github.com/docker/docker-bench-security"><strong>docker-bench-security</strong></a> æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ£€æŸ¥åœ¨ç”Ÿäº§ä¸­éƒ¨ç½² Docker å®¹å™¨çš„æ•°åä¸ªå¸¸è§æœ€ä½³å®è·µã€‚æ‰€æœ‰æµ‹è¯•éƒ½æ˜¯è‡ªåŠ¨åŒ–çš„ï¼ŒåŸºäº <a href="https://www.cisecurity.org/benchmark/docker/">CIS Docker åŸºå‡† v1.3.1</a>ã€‚<br />
æ‚¨éœ€è¦ä»è¿è¡Œ Docker çš„ä¸»æœºæˆ–å…·æœ‰è¶³å¤Ÿæƒé™çš„å®¹å™¨ä¸­è¿è¡Œè¯¥å·¥å…·ã€‚äº†è§£ <strong>å¦‚ä½•åœ¨ README ä¸­è¿è¡Œå®ƒï¼š</strong> <a href="https://github.com/docker/docker-bench-security"><strong>https://github.com/docker/docker-bench-security</strong></a>ã€‚</li>
</ul>
<h2 id="å‚è€ƒ"><a class="header" href="#å‚è€ƒ">å‚è€ƒ</a></h2>
<ul>
<li><a href="https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/">https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/</a></li>
<li><a href="https://twitter.com/_fel1x/status/1151487051986087936">https://twitter.com/_fel1x/status/1151487051986087936</a></li>
<li><a href="https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html">https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html</a></li>
<li><a href="https://sreeninet.wordpress.com/2016/03/06/docker-security-part-1overview/">https://sreeninet.wordpress.com/2016/03/06/docker-security-part-1overview/</a></li>
<li><a href="https://sreeninet.wordpress.com/2016/03/06/docker-security-part-2docker-engine/">https://sreeninet.wordpress.com/2016/03/06/docker-security-part-2docker-engine/</a></li>
<li><a href="https://sreeninet.wordpress.com/2016/03/06/docker-security-part-3engine-access/">https://sreeninet.wordpress.com/2016/03/06/docker-security-part-3engine-access/</a></li>
<li><a href="https://sreeninet.wordpress.com/2016/03/06/docker-security-part-4container-image/">https://sreeninet.wordpress.com/2016/03/06/docker-security-part-4container-image/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Linux_namespaces">https://en.wikipedia.org/wiki/Linux_namespaces</a></li>
<li><a href="https://towardsdatascience.com/top-20-docker-security-tips-81c41dd06f57">https://towardsdatascience.com/top-20-docker-security-tips-81c41dd06f57</a></li>
<li><a href="https://www.redhat.com/sysadmin/privileged-flag-container-engines">https://www.redhat.com/sysadmin/privileged-flag-container-engines</a></li>
<li><a href="https://docs.docker.com/engine/extend/plugins_authorization">https://docs.docker.com/engine/extend/plugins_authorization</a></li>
<li><a href="https://towardsdatascience.com/top-20-docker-security-tips-81c41dd06f57">https://towardsdatascience.com/top-20-docker-security-tips-81c41dd06f57</a></li>
<li><a href="https://resources.experfy.com/bigdata-cloud/top-20-docker-security-tips/">https://resources.experfy.com/bigdata-cloud/top-20-docker-security-tips/</a></li>
</ul>
<figure><img src="../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
ä½¿ç”¨ <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=docker-security"><strong>Trickest</strong></a> è½»æ¾æ„å»ºå’Œ <strong>è‡ªåŠ¨åŒ–å·¥ä½œæµ</strong>ï¼Œç”±ä¸–ç•Œä¸Š <strong>æœ€å…ˆè¿›</strong> çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚<br />
ç«‹å³è·å–è®¿é—®æƒé™ï¼š</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=docker-security" %}</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨ Twitter ä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../linux-hardening/privilege-escalation/d-bus-enumeration-and-command-injection-privilege-escalation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../linux-hardening/privilege-escalation/docker-security/abusing-docker-socket-for-privilege-escalation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../linux-hardening/privilege-escalation/d-bus-enumeration-and-command-injection-privilege-escalation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../linux-hardening/privilege-escalation/docker-security/abusing-docker-socket-for-privilege-escalation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
