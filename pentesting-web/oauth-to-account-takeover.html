<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OAuth to Account takeover</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="oauth-到账户接管"><a class="header" href="#oauth-到账户接管">OAuth 到账户接管</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在 Twitter 上关注</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<h2 id="基本信息"><a class="header" href="#基本信息">基本信息 <a href="#d4a8" id="d4a8"></a></a></h2>
<p>OAuth 提供多种版本，基础信息可在 <a href="https://oauth.net/2/">OAuth 2.0 文档</a> 中获取。本讨论主要集中在广泛使用的 <a href="https://oauth.net/2/grant-types/authorization-code/">OAuth 2.0 授权码授权类型</a>，提供一个 <strong>授权框架，使应用程序能够访问或在另一个应用程序中执行用户账户的操作</strong>（授权服务器）。</p>
<p>考虑一个假设的网站 <em><strong>https://example.com</strong></em>，旨在 <strong>展示您所有的社交媒体帖子</strong>，包括私人帖子。为此，使用了 OAuth 2.0。<em>https://example.com</em> 将请求您的许可以 <strong>访问您的社交媒体帖子</strong>。因此，<em>https://socialmedia.com</em> 上会出现一个同意屏幕，概述 <strong>请求的权限和发起请求的开发者</strong>。在您授权后，<em>https://example.com</em> 获得 <strong>代表您访问您的帖子</strong> 的能力。</p>
<p>理解 OAuth 2.0 框架中的以下组件至关重要：</p>
<ul>
<li><strong>资源拥有者</strong>：您，作为 <strong>用户/实体</strong>，授权访问您的资源，例如您的社交媒体账户帖子。</li>
<li><strong>资源服务器</strong>：在应用程序代表 <code>资源拥有者</code> 获取 <code>访问令牌</code> 后，<strong>管理经过身份验证请求的服务器</strong>，例如 <strong>https://socialmedia.com</strong>。</li>
<li><strong>客户端应用程序</strong>：向 <code>资源拥有者</code> 请求授权的 <strong>应用程序</strong>，例如 <strong>https://example.com</strong>。</li>
<li><strong>授权服务器</strong>：在成功验证 <code>资源拥有者</code> 并获得授权后，<strong>向 <code>客户端应用程序</code> 发放 <code>访问令牌</code> 的服务器</strong>，例如 <strong>https://socialmedia.com</strong>。</li>
<li><strong>client_id</strong>：应用程序的公共唯一标识符。</li>
<li><strong>client_secret</strong>：仅应用程序和授权服务器知道的机密密钥，用于生成 <code>访问令牌</code>。</li>
<li><strong>response_type</strong>：指定 <strong>请求的令牌类型</strong> 的值，例如 <code>code</code>。</li>
<li><strong>scope</strong>：<code>客户端应用程序</code> 请求的 <strong>访问级别</strong>。</li>
<li><strong>redirect_uri</strong>：用户在授权后被重定向的 <strong>URL</strong>。这通常必须与预注册的重定向 URL 一致。</li>
<li><strong>state</strong>：一个参数，用于 <strong>在用户重定向到授权服务器及返回时维护数据</strong>。其唯一性对于作为 <strong>CSRF 保护机制</strong> 至关重要。</li>
<li><strong>grant_type</strong>：指示 <strong>授权类型和要返回的令牌类型</strong> 的参数。</li>
<li><strong>code</strong>：来自 <code>授权服务器</code> 的授权码，客户端应用程序与 <code>client_id</code> 和 <code>client_secret</code> 一起使用以获取 <code>访问令牌</code>。</li>
<li><strong>access_token</strong>：客户端应用程序代表 <code>资源拥有者</code> 用于 API 请求的 <strong>令牌</strong>。</li>
<li><strong>refresh_token</strong>：使应用程序能够 <strong>在不重新提示用户的情况下获取新的 <code>访问令牌</code></strong>。</li>
</ul>
<h3 id="流程"><a class="header" href="#流程">流程</a></h3>
<p><strong>实际的 OAuth 流程</strong>如下：</p>
<ol>
<li>您导航到 <a href="https://example.com">https://example.com</a> 并选择“与社交媒体集成”按钮。</li>
<li>然后该网站向 <a href="https://socialmedia.com">https://socialmedia.com</a> 发送请求，请求您的授权以让 https://example.com 的应用程序访问您的帖子。请求的结构为：</li>
</ol>
<pre><code>https://socialmedia.com/auth
?response_type=code
&amp;client_id=example_clientId
&amp;redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&amp;scope=readPosts
&amp;state=randomString123
</code></pre>
<ol start="3">
<li>然后您将看到一个同意页面。</li>
<li>在您批准后，社交媒体会向 <code>redirect_uri</code> 发送一个包含 <code>code</code> 和 <code>state</code> 参数的响应：</li>
</ol>
<pre><code>https://example.com?code=uniqueCode123&amp;state=randomString123
</code></pre>
<ol start="5">
<li>https://example.com 利用这个 <code>code</code>，连同它的 <code>client_id</code> 和 <code>client_secret</code>，发起服务器端请求以代表您获取 <code>access_token</code>，从而访问您同意的权限：</li>
</ol>
<pre><code>POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
</code></pre>
<ol start="6">
<li>最后，过程结束时 https://example.com 使用你的 <code>access_token</code> 进行 API 调用以访问</li>
</ol>
<h2 id="漏洞"><a class="header" href="#漏洞">漏洞 <a href="#id-323a" id="id-323a"></a></a></h2>
<h3 id="开放的-redirect_uri"><a class="header" href="#开放的-redirect_uri">开放的 redirect_uri <a href="#cc36" id="cc36"></a></a></h3>
<p><code>redirect_uri</code> 对于 OAuth 和 OpenID 实现的安全性至关重要，因为它指示在授权后敏感数据（如授权代码）发送到何处。如果配置错误，可能会允许攻击者将这些请求重定向到恶意服务器，从而实现账户接管。</p>
<p>利用技术根据授权服务器的验证逻辑而异。它们可以从严格的路径匹配到接受指定域或子目录内的任何 URL。常见的利用方法包括开放重定向、路径遍历、利用弱正则表达式和 HTML 注入进行令牌窃取。</p>
<p>除了 <code>redirect_uri</code>，其他 OAuth 和 OpenID 参数如 <code>client_uri</code>、<code>policy_uri</code>、<code>tos_uri</code> 和 <code>initiate_login_uri</code> 也容易受到重定向攻击。这些参数是可选的，其支持在不同服务器之间有所不同。</p>
<p>对于那些针对 OpenID 服务器的攻击者，发现端点（<code>**.well-known/openid-configuration**</code>）通常列出有价值的配置细节，如 <code>registration_endpoint</code>、<code>request_uri_parameter_supported</code> 和 "<code>require_request_uri_registration</code>。这些细节可以帮助识别注册端点和服务器的其他配置细节。</p>
<h3 id="重定向实现中的-xss"><a class="header" href="#重定向实现中的-xss">重定向实现中的 XSS <a href="#bda5" id="bda5"></a></a></h3>
<p>正如在这个漏洞赏金报告中提到的 <a href="https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html">https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html</a>，重定向 <strong>URL 可能在用户认证后被反射在服务器的响应中</strong>，因此 <strong>容易受到 XSS 攻击</strong>。可以测试的有效载荷：</p>
<pre><code>https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard&lt;/script&gt;&lt;h1&gt;test&lt;/h1&gt;
</code></pre>
<h3 id="csrf---improper-handling-of-state-parameter"><a class="header" href="#csrf---improper-handling-of-state-parameter">CSRF - Improper handling of state parameter <a href="#bda5" id="bda5"></a></a></h3>
<p>在OAuth实现中，<strong><code>state</code>参数</strong>的误用或遗漏会显著增加<strong>跨站请求伪造（CSRF）<strong>攻击的风险。当<code>state</code>参数</strong>未使用、作为静态值使用或未正确验证</strong>时，攻击者可以绕过CSRF保护，从而产生此漏洞。</p>
<p>攻击者可以通过拦截授权过程，将他们的账户与受害者的账户关联，从而导致潜在的<strong>账户接管</strong>。在使用OAuth进行<strong>身份验证</strong>的应用程序中，这一点尤其关键。</p>
<p>在各种<strong>CTF挑战</strong>和<strong>黑客平台</strong>中，已经记录了此漏洞的真实案例，突显了其实际影响。该问题还扩展到与第三方服务的集成，如<strong>Slack</strong>、<strong>Stripe</strong>和<strong>PayPal</strong>，攻击者可以将通知或付款重定向到他们的账户。</p>
<p>正确处理和验证**<code>state</code>参数**对于防范CSRF和保护OAuth流程至关重要。</p>
<h3 id="pre-account-takeover"><a class="header" href="#pre-account-takeover">Pre Account Takeover <a href="#ebe4" id="ebe4"></a></a></h3>
<ol>
<li><strong>在账户创建时未进行电子邮件验证</strong>：攻击者可以预先使用受害者的电子邮件创建账户。如果受害者稍后使用第三方服务登录，应用程序可能会不经意地将此第三方账户与攻击者预先创建的账户关联，从而导致未经授权的访问。</li>
<li><strong>利用宽松的OAuth电子邮件验证</strong>：攻击者可能会利用不验证电子邮件的OAuth服务，通过注册其服务并将账户电子邮件更改为受害者的电子邮件来进行攻击。这种方法同样存在未经授权的账户访问风险，类似于第一种情况，但通过不同的攻击向量。</li>
</ol>
<h3 id="disclosure-of-secrets"><a class="header" href="#disclosure-of-secrets">Disclosure of Secrets <a href="#e177" id="e177"></a></a></h3>
<p>识别和保护秘密的OAuth参数至关重要。虽然**<code>client_id</code><strong>可以安全披露，但泄露</strong><code>client_secret</code><strong>会带来重大风险。如果<code>client_secret</code>被泄露，攻击者可以利用应用程序的身份和信任来</strong>窃取用户的<code>access_tokens</code>**和私人信息。</p>
<p>一个常见的漏洞出现在应用程序错误地在客户端而非服务器端处理授权<code>code</code>与<code>access_token</code>的交换时。这个错误导致<code>client_secret</code>的暴露，使攻击者能够以应用程序的名义生成<code>access_tokens</code>。此外，通过社会工程学，攻击者可以通过向OAuth授权添加额外的范围来提升权限，进一步利用应用程序的信任状态。</p>
<h3 id="client-secret-bruteforce"><a class="header" href="#client-secret-bruteforce">Client Secret Bruteforce</a></h3>
<p>您可以尝试<strong>暴力破解服务提供商的client_secret</strong>与身份提供者，以试图窃取账户。<br />
暴力破解的请求可能类似于：</p>
<pre><code>POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&amp;redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&amp;grant_type=authorization_code&amp;client_id=public_client_id&amp;client_secret=[bruteforce]
</code></pre>
<h3 id="referer-header-leaking-code--state"><a class="header" href="#referer-header-leaking-code--state">Referer Header leaking Code + State</a></h3>
<p>一旦客户端拥有了 <strong>code 和 state</strong>，如果它们在浏览到不同页面时 <strong>反映在 Referer 头中</strong>，那么它就存在漏洞。</p>
<h3 id="access-token-stored-in-browser-history"><a class="header" href="#access-token-stored-in-browser-history">Access Token Stored in Browser History</a></h3>
<p>前往 <strong>浏览器历史记录并检查访问令牌是否保存在其中</strong>。</p>
<h3 id="everlasting-authorization-code"><a class="header" href="#everlasting-authorization-code">Everlasting Authorization Code</a></h3>
<p><strong>授权码应该只存在一段时间，以限制攻击者可以窃取和使用它的时间窗口</strong>。</p>
<h3 id="authorizationrefresh-token-not-bound-to-client"><a class="header" href="#authorizationrefresh-token-not-bound-to-client">Authorization/Refresh Token not bound to client</a></h3>
<p>如果你可以获取 <strong>授权码并在不同的客户端上使用它，那么你可以接管其他账户</strong>。</p>
<h3 id="happy-paths-xss-iframes--post-messages-to-leak-code--state-values"><a class="header" href="#happy-paths-xss-iframes--post-messages-to-leak-code--state-values">Happy Paths, XSS, Iframes &amp; Post Messages to leak code &amp; state values</a></h3>
<p><a href="https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url"><strong>查看此帖子</strong></a></p>
<h3 id="aws-cognito"><a class="header" href="#aws-cognito">AWS Cognito <a href="#bda5" id="bda5"></a></a></h3>
<p>在这个漏洞赏金报告中：<a href="https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/"><strong>https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/</strong></a> 你可以看到 <strong>AWS Cognito</strong> 返回给用户的 <strong>token</strong> 可能具有 <strong>足够的权限来覆盖用户数据</strong>。因此，如果你可以 <strong>将用户电子邮件更改为其他用户的电子邮件</strong>，你可能能够 <strong>接管</strong> 其他账户。</p>
<pre><code class="language-bash"># Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
</code></pre>
<p>为了获取有关如何滥用 AWS cognito 的更详细信息，请查看：</p>
<p>{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}</p>
<h3 id="滥用其他应用程序令牌"><a class="header" href="#滥用其他应用程序令牌">滥用其他应用程序令牌 <a href="#bda5" id="bda5"></a></a></h3>
<p>正如 <a href="https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts"><strong>在这篇文章中提到的</strong></a>，期望接收 <strong>令牌</strong>（而不是代码）的 OAuth 流程可能会受到攻击，如果它们没有检查令牌是否属于该应用程序。</p>
<p>这是因为 <strong>攻击者</strong> 可以在自己的应用程序中创建一个 <strong>支持 OAuth 并使用 Facebook 登录的应用程序</strong>（例如）。然后，一旦受害者在 <strong>攻击者的应用程序</strong>中使用 Facebook 登录，攻击者就可以获取 <strong>授予其应用程序的用户的 OAuth 令牌，并使用该令牌在受害者的 OAuth 应用程序中登录</strong>。</p>
<p>{% hint style="danger" %}
因此，如果攻击者设法让用户访问自己的 OAuth 应用程序，他将能够在期望令牌且未检查令牌是否授予其应用程序 ID 的应用程序中接管受害者的帐户。
{% endhint %}</p>
<h3 id="两个链接和-cookie"><a class="header" href="#两个链接和-cookie">两个链接和 cookie <a href="#bda5" id="bda5"></a></a></h3>
<p>根据 <a href="https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f"><strong>这篇文章</strong></a>，可以让受害者打开一个指向攻击者主机的 <strong>returnUrl</strong> 的页面。此信息将被 <strong>存储在 cookie (RU)</strong> 中，并且在 <strong>后续步骤</strong> 中，<strong>提示</strong> 将 <strong>询问</strong> <strong>用户</strong> 是否希望授予对该攻击者主机的访问权限。</p>
<p>为了绕过此提示，可以打开一个选项卡以启动 <strong>Oauth 流程</strong>，该流程将使用 <strong>returnUrl</strong> 设置此 RU cookie，在提示显示之前关闭选项卡，然后打开一个没有该值的新选项卡。然后，<strong>提示不会通知攻击者主机</strong>，但 cookie 将被设置为它，因此 <strong>令牌将被发送到攻击者主机</strong> 进行重定向。</p>
<h3 id="提示交互绕过"><a class="header" href="#提示交互绕过">提示交互绕过 <a href="#bda5" id="bda5"></a></a></h3>
<p>正如 <a href="https://www.youtube.com/watch?v=n9x7_J_a_7Q"><strong>在这段视频中解释的</strong></a>，一些 OAuth 实现允许将 <strong><code>prompt</code></strong> GET 参数指示为 None (<strong><code>&amp;prompt=none</code></strong>) 以 <strong>防止用户在已登录平台时被要求确认</strong> 给定的访问权限。</p>
<h3 id="response_mode"><a class="header" href="#response_mode">response_mode</a></h3>
<p>正如 <a href="https://www.youtube.com/watch?v=n9x7_J_a_7Q"><strong>在这段视频中解释的</strong></a>，可能可以指示参数 <strong><code>response_mode</code></strong> 来指示您希望在最终 URL 中提供代码的位置：</p>
<ul>
<li><code>response_mode=query</code> -&gt; 代码在 GET 参数中提供： <code>?code=2397rf3gu93f</code></li>
<li><code>response_mode=fragment</code> -&gt; 代码在 URL 片段参数中提供 <code>#code=2397rf3gu93f</code></li>
<li><code>response_mode=form_post</code> -&gt; 代码在一个名为 <code>code</code> 的 POST 表单输入中提供</li>
<li><code>response_mode=web_message</code> -&gt; 代码通过 post 消息发送： <code>window.opener.postMessage({"code": "asdasdasd...</code></li>
</ul>
<h3 id="oauth-ropc-流程---2-fa-绕过"><a class="header" href="#oauth-ropc-流程---2-fa-绕过">OAuth ROPC 流程 - 2 FA 绕过 <a href="#b440" id="b440"></a></a></h3>
<p>根据 <a href="https://cybxis.medium.com/a-bypass-on-gitlabs-login-email-verification-via-oauth-ropc-flow-e194242cad96"><strong>这篇博客文章</strong></a>，这是一个允许通过 <strong>用户名</strong> 和 <strong>密码</strong> 登录 OAuth 的 OAuth 流程。如果在这个简单流程中返回一个具有用户可以执行的所有操作的访问权限的 <strong>令牌</strong>，那么就可以使用该令牌绕过 2FA。</p>
<h3 id="基于开放重定向到引荐者的网页重定向-ato"><a class="header" href="#基于开放重定向到引荐者的网页重定向-ato">基于开放重定向到引荐者的网页重定向 ATO <a href="#bda5" id="bda5"></a></a></h3>
<p>这篇 <a href="https://blog.voorivex.team/oauth-non-happy-path-to-ato"><strong>博客文章</strong></a> 评论了如何利用 <strong>开放重定向</strong> 从 <strong>引荐者</strong> 的值来滥用 OAuth 进行 ATO。攻击步骤如下：</p>
<ol>
<li>受害者访问攻击者的网页</li>
<li>受害者打开恶意链接，打开者开始使用 <code>response_type=id_token,code&amp;prompt=none</code> 作为附加参数的 Google OAuth 流程，<strong>引荐者为攻击者网站</strong>。</li>
<li>在打开者中，提供者在授权受害者后，将他们发送回 <code>redirect_uri</code> 参数的值（受害者网站），并使用 30X 代码，这仍然保持攻击者网站在引荐者中。</li>
<li>受害者 <strong>网站根据引荐者触发开放重定向</strong>，将受害者用户重定向到攻击者网站，因为 <strong><code>respose_type</code></strong> 是 <strong><code>id_token,code</code></strong>，代码将通过 URL 的 <strong>片段</strong> 返回给攻击者，从而允许他通过 Google 在受害者网站上接管用户的帐户。</li>
</ol>
<h3 id="ssrfs-参数"><a class="header" href="#ssrfs-参数">SSRFs 参数 <a href="#bda5" id="bda5"></a></a></h3>
<p><a href="https://portswigger.net/research/hidden-oauth-attack-vectors"><strong>查看这项研究</strong></a> <strong>以获取有关此技术的更多详细信息。</strong></p>
<p>OAuth 中的动态客户端注册作为一个不太明显但关键的安全漏洞向量，特别是针对 <strong>服务器端请求伪造 (SSRF)</strong> 攻击。此端点允许 OAuth 服务器接收有关客户端应用程序的详细信息，包括可能被利用的敏感 URL。</p>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>动态客户端注册</strong> 通常映射到 <code>/register</code>，并接受 <code>client_name</code>、<code>client_secret</code>、<code>redirect_uris</code> 和通过 POST 请求的徽标或 JSON Web 密钥集 (JWKs) 的 URL 等详细信息。</li>
<li>此功能遵循 <strong>RFC7591</strong> 和 <strong>OpenID Connect Registration 1.0</strong> 中列出的规范，其中包括可能对 SSRF 易受攻击的参数。</li>
<li>注册过程可能会以多种方式无意中使服务器暴露于 SSRF：</li>
<li><strong><code>logo_uri</code></strong>：客户端应用程序徽标的 URL，服务器可能会获取该 URL，从而触发 SSRF 或导致 XSS（如果 URL 处理不当）。</li>
<li><strong><code>jwks_uri</code></strong>：客户端 JWK 文档的 URL，如果恶意构造，可能导致服务器向攻击者控制的服务器发出外部请求。</li>
<li><strong><code>sector_identifier_uri</code></strong>：引用 <code>redirect_uris</code> 的 JSON 数组，服务器可能会获取该数组，从而创建 SSRF 机会。</li>
<li><strong><code>request_uris</code></strong>：列出客户端允许的请求 URI，如果服务器在授权过程开始时获取这些 URI，则可能被利用。</li>
</ul>
<p><strong>利用策略：</strong></p>
<ul>
<li>通过在 <code>logo_uri</code>、<code>jwks_uri</code> 或 <code>sector_identifier_uri</code> 等参数中注册带有恶意 URL 的新客户端，可以触发 SSRF。</li>
<li>尽管通过白名单控制可能会减轻直接通过 <code>request_uris</code> 的利用，但提供一个预注册的、攻击者控制的 <code>request_uri</code> 可以在授权阶段促进 SSRF。</li>
</ul>
<h2 id="oauth-提供者竞争条件"><a class="header" href="#oauth-提供者竞争条件">OAuth 提供者竞争条件</a></h2>
<p>如果您正在测试的平台是 OAuth 提供者 <a href="race-condition.html"><strong>请阅读此内容以测试可能的竞争条件</strong></a>。</p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1"><strong>https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1</strong></a></li>
<li><a href="https://portswigger.net/research/hidden-oauth-attack-vectors"><strong>https://portswigger.net/research/hidden-oauth-attack-vectors</strong></a></li>
</ul>
<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>
<p>{% embed url="https://websec.nl/" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客攻击：<img src="../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="../.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客攻击： <img src="../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在 Twitter 上关注</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pentesting-web/nosql-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pentesting-web/open-redirect.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pentesting-web/nosql-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pentesting-web/open-redirect.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
