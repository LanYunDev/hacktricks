<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>7.2. Fine-Tuning to follow instructions</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="72-微调以遵循指令"><a class="header" href="#72-微调以遵循指令">7.2. 微调以遵循指令</a></h1>
<p>{% hint style="success" %}
本节的目标是展示如何<strong>微调一个已经预训练的模型以遵循指令</strong>，而不仅仅是生成文本，例如，作为聊天机器人响应任务。
{% endhint %}</p>
<h2 id="数据集"><a class="header" href="#数据集">数据集</a></h2>
<p>为了微调一个 LLM 以遵循指令，需要有一个包含指令和响应的数据集来微调 LLM。训练 LLM 以遵循指令有不同的格式，例如：</p>
<ul>
<li>Apply Alpaca 提示样式示例：</li>
</ul>
<pre><code class="language-csharp">Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Calculate the area of a circle with a radius of 5 units.

### Response:
The area of a circle is calculated using the formula \( A = \pi r^2 \). Plugging in the radius of 5 units:

\( A = \pi (5)^2 = \pi \times 25 = 25\pi \) square units.
</code></pre>
<ul>
<li>Phi-3 提示样式示例：</li>
</ul>
<pre><code class="language-vbnet">&lt;|User|&gt;
Can you explain what gravity is in simple terms?

&lt;|Assistant|&gt;
Absolutely! Gravity is a force that pulls objects toward each other.
</code></pre>
<p>用这些数据集训练LLM，而不仅仅是原始文本，可以帮助LLM理解它需要对收到的问题给出具体的回答。</p>
<p>因此，处理包含请求和答案的数据集时，首先要做的事情之一是将这些数据建模为所需的提示格式，例如：</p>
<pre><code class="language-python"># Code from https://github.com/rasbt/LLMs-from-scratch/blob/main/ch07/01_main-chapter-code/ch07.ipynb
def format_input(entry):
instruction_text = (
f"Below is an instruction that describes a task. "
f"Write a response that appropriately completes the request."
f"\n\n### Instruction:\n{entry['instruction']}"
)

input_text = f"\n\n### Input:\n{entry['input']}" if entry["input"] else ""

return instruction_text + input_text

model_input = format_input(data[50])

desired_response = f"\n\n### Response:\n{data[50]['output']}"

print(model_input + desired_response)
</code></pre>
<p>然后，像往常一样，需要将数据集分为训练集、验证集和测试集。</p>
<h2 id="批处理和数据加载器"><a class="header" href="#批处理和数据加载器">批处理和数据加载器</a></h2>
<p>然后，需要对所有输入和期望输出进行批处理以进行训练。为此，需要：</p>
<ul>
<li>对文本进行标记化</li>
<li>将所有样本填充到相同的长度（通常长度将与用于预训练LLM的上下文长度相同）</li>
<li>在自定义合并函数中将输入向右移动1以创建期望的标记</li>
<li>用-100替换一些填充标记，以将其排除在训练损失之外：在第一个<code>endoftext</code>标记之后，用-100替换所有其他<code>endoftext</code>标记（因为使用<code>cross_entropy(...,ignore_index=-100)</code>意味着它将忽略目标为-100的标记）</li>
<li>[可选] 使用-100掩盖所有属于问题的标记，以便LLM仅学习如何生成答案。在应用Alpaca风格时，这将意味着掩盖所有内容直到<code>### Response:</code></li>
</ul>
<p>创建完这些后，是时候为每个数据集（训练、验证和测试）创建数据加载器了。</p>
<h2 id="加载预训练llm--微调--损失检查"><a class="header" href="#加载预训练llm--微调--损失检查">加载预训练LLM &amp; 微调 &amp; 损失检查</a></h2>
<p>需要加载一个预训练的LLM进行微调。这在其他页面中已经讨论过。然后，可以使用之前使用的训练函数来微调LLM。</p>
<p>在训练过程中，还可以查看训练损失和验证损失在各个时期的变化，以查看损失是否在减少以及是否发生了过拟合。<br />
请记住，过拟合发生在训练损失减少但验证损失没有减少甚至增加时。为了避免这种情况，最简单的方法是在这种行为开始的时期停止训练。</p>
<h2 id="响应质量"><a class="header" href="#响应质量">响应质量</a></h2>
<p>由于这不是一个分类微调，因此不太可能信任损失变化，因此检查测试集中的响应质量也很重要。因此，建议从所有测试集中收集生成的响应并<strong>手动检查其质量</strong>，以查看是否存在错误答案（请注意，LLM可能正确生成响应句子的格式和语法，但给出完全错误的响应。损失变化不会反映这种行为）。<br />
请注意，也可以通过将生成的响应和期望的响应传递给<strong>其他LLM并要求它们评估响应</strong>来进行此审查。</p>
<p>验证响应质量的其他测试：</p>
<ol>
<li><strong>测量大规模多任务语言理解（</strong><a href="https://arxiv.org/abs/2009.03300"><strong>MMLU</strong></a><strong>）：</strong> MMLU评估模型在57个学科（包括人文学科、科学等）中的知识和解决问题的能力。它使用多项选择题在从初级到高级专业的不同难度级别上评估理解能力。</li>
<li><a href="https://arena.lmsys.org"><strong>LMSYS聊天机器人竞技场</strong></a>：该平台允许用户并排比较不同聊天机器人的响应。用户输入提示，多个聊天机器人生成可以直接比较的响应。</li>
<li><a href="https://github.com/tatsu-lab/alpaca_eval"><strong>AlpacaEval</strong></a><strong>：</strong> AlpacaEval是一个自动评估框架，其中像GPT-4这样的高级LLM评估其他模型对各种提示的响应。</li>
<li><strong>通用语言理解评估（</strong><a href="https://gluebenchmark.com/"><strong>GLUE</strong></a><strong>）：</strong> GLUE是九个自然语言理解任务的集合，包括情感分析、文本蕴含和问答。</li>
<li><a href="https://super.gluebenchmark.com/"><strong>SuperGLUE</strong></a><strong>：</strong> 在GLUE的基础上，SuperGLUE包括更具挑战性的任务，旨在对当前模型构成困难。</li>
<li><strong>超越模仿游戏基准（</strong><a href="https://github.com/google/BIG-bench"><strong>BIG-bench</strong></a><strong>）：</strong> BIG-bench是一个大规模基准，包含200多个任务，测试模型在推理、翻译和问答等领域的能力。</li>
<li><strong>语言模型的整体评估（</strong><a href="https://crfm.stanford.edu/helm/lite/latest/"><strong>HELM</strong></a><strong>）：</strong> HELM提供了在准确性、鲁棒性和公平性等各种指标上的全面评估。</li>
<li><a href="https://github.com/openai/evals"><strong>OpenAI Evals</strong></a><strong>：</strong> OpenAI的开源评估框架，允许在自定义和标准化任务上测试AI模型。</li>
<li><a href="https://github.com/openai/human-eval"><strong>HumanEval</strong></a><strong>：</strong> 一组用于评估语言模型代码生成能力的编程问题。</li>
<li><strong>斯坦福问答数据集（</strong><a href="https://rajpurkar.github.io/SQuAD-explorer/"><strong>SQuAD</strong></a><strong>）：</strong> SQuAD由关于维基百科文章的问题组成，模型必须理解文本以准确回答。</li>
<li><a href="https://nlp.cs.washington.edu/triviaqa/"><strong>TriviaQA</strong></a><strong>：</strong> 一个大规模的琐事问题和答案数据集，以及证据文档。</li>
</ol>
<p>还有很多很多其他的</p>
<h2 id="跟随指令微调代码"><a class="header" href="#跟随指令微调代码">跟随指令微调代码</a></h2>
<p>您可以在<a href="https://github.com/rasbt/LLMs-from-scratch/blob/main/ch07/01_main-chapter-code/gpt_instruction_finetuning.py">https://github.com/rasbt/LLMs-from-scratch/blob/main/ch07/01_main-chapter-code/gpt_instruction_finetuning.py</a>找到执行此微调的代码示例。</p>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://www.manning.com/books/build-a-large-language-model-from-scratch">https://www.manning.com/books/build-a-large-language-model-from-scratch</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../todo/llm-training-data-preparation/7.1.-fine-tuning-for-classification.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../todo/burp-suite.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../todo/llm-training-data-preparation/7.1.-fine-tuning-for-classification.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../todo/burp-suite.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
