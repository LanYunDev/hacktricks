<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Malware Analysis</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="恶意软件分析"><a class="header" href="#恶意软件分析">恶意软件分析</a></h1>
<p>{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习与实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>Telegram 群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> GitHub 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="取证备忘单"><a class="header" href="#取证备忘单">取证备忘单</a></h2>
<p><a href="https://www.jaiminton.com/cheatsheet/DFIR/">https://www.jaiminton.com/cheatsheet/DFIR/#</a></p>
<h2 id="在线服务"><a class="header" href="#在线服务">在线服务</a></h2>
<ul>
<li><a href="https://www.virustotal.com/gui/home/upload">VirusTotal</a></li>
<li><a href="https://www.hybrid-analysis.com">HybridAnalysis</a></li>
<li><a href="https://koodous.com">Koodous</a></li>
<li><a href="https://analyze.intezer.com">Intezer</a></li>
<li><a href="https://any.run/">Any.Run</a></li>
</ul>
<h2 id="离线杀毒和检测工具"><a class="header" href="#离线杀毒和检测工具">离线杀毒和检测工具</a></h2>
<h3 id="yara"><a class="header" href="#yara">Yara</a></h3>
<h4 id="安装"><a class="header" href="#安装">安装</a></h4>
<pre><code class="language-bash">sudo apt-get install -y yara
</code></pre>
<h4 id="准备规则"><a class="header" href="#准备规则">准备规则</a></h4>
<p>使用此脚本从github下载并合并所有yara恶意软件规则: <a href="https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9">https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9</a><br />
创建_<strong>rules</strong><em>目录并执行它。这将创建一个名为</em><strong>malware_rules.yar</strong>_的文件，其中包含所有恶意软件的yara规则。</p>
<pre><code class="language-bash">wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
</code></pre>
<h4 id="扫描"><a class="header" href="#扫描">扫描</a></h4>
<pre><code class="language-bash">yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
</code></pre>
<h4 id="yaragen-检查恶意软件并创建规则"><a class="header" href="#yaragen-检查恶意软件并创建规则">YaraGen: 检查恶意软件并创建规则</a></h4>
<p>您可以使用工具 <a href="https://github.com/Neo23x0/yarGen"><strong>YaraGen</strong></a> 从二进制文件生成 yara 规则。查看这些教程: <a href="https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/"><strong>第 1 部分</strong></a>, <a href="https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/"><strong>第 2 部分</strong></a>, <a href="https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/"><strong>第 3 部分</strong></a></p>
<pre><code class="language-bash">python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
</code></pre>
<h3 id="clamav"><a class="header" href="#clamav">ClamAV</a></h3>
<h4 id="安装-1"><a class="header" href="#安装-1">安装</a></h4>
<pre><code>sudo apt-get install -y clamav
</code></pre>
<h4 id="扫描-1"><a class="header" href="#扫描-1">扫描</a></h4>
<pre><code class="language-bash">sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
</code></pre>
<h3 id="capa"><a class="header" href="#capa"><a href="https://github.com/mandiant/capa">Capa</a></a></h3>
<p><strong>Capa</strong> 检测可疑的 <strong>能力</strong> 在可执行文件中：PE, ELF, .NET。因此，它会找到诸如 Att&amp;ck 策略或可疑能力，例如：</p>
<ul>
<li>检查 OutputDebugString 错误</li>
<li>作为服务运行</li>
<li>创建进程</li>
</ul>
<p>在 <a href="https://github.com/mandiant/capa"><strong>Github repo</strong></a> 中获取它。</p>
<h3 id="iocs"><a class="header" href="#iocs">IOCs</a></h3>
<p>IOC 代表妥协指标。IOC 是一组 <strong>条件，用于识别</strong> 一些潜在的不需要的软件或确认的 <strong>恶意软件</strong>。蓝队使用这种定义来 <strong>搜索这种恶意文件</strong> 在他们的 <strong>系统</strong> 和 <strong>网络</strong> 中。<br />
共享这些定义非常有用，因为当恶意软件在计算机中被识别并为该恶意软件创建 IOC 时，其他蓝队可以使用它更快地识别恶意软件。</p>
<p>创建或修改 IOC 的工具是 <a href="https://www.fireeye.com/services/freeware/ioc-editor.html"><strong>IOC Editor</strong></a><strong>.</strong><br />
您可以使用 <a href="https://www.fireeye.com/services/freeware/redline.html"><strong>Redline</strong></a> 等工具来 <strong>搜索设备中的定义 IOC</strong>。</p>
<h3 id="loki"><a class="header" href="#loki">Loki</a></h3>
<p><a href="https://github.com/Neo23x0/Loki"><strong>Loki</strong></a> 是一个简单妥协指标的扫描器。<br />
检测基于四种检测方法：</p>
<pre><code>1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
</code></pre>
<h3 id="linux-malware-detect"><a class="header" href="#linux-malware-detect">Linux Malware Detect</a></h3>
<p><a href="https://www.rfxn.com/projects/linux-malware-detect/"><strong>Linux Malware Detect (LMD)</strong></a> 是一个针对Linux的恶意软件扫描器，发布于GNU GPLv2许可证，旨在应对共享托管环境中面临的威胁。它使用来自网络边缘入侵检测系统的威胁数据，提取正在攻击中积极使用的恶意软件，并生成检测签名。此外，威胁数据还来自用户提交的LMD结账功能和恶意软件社区资源。</p>
<h3 id="rkhunter"><a class="header" href="#rkhunter">rkhunter</a></h3>
<p>像<a href="http://rkhunter.sourceforge.net"><strong>rkhunter</strong></a>这样的工具可以用来检查文件系统中可能存在的<strong>rootkits</strong>和恶意软件。</p>
<pre><code class="language-bash">sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
</code></pre>
<h3 id="floss"><a class="header" href="#floss">FLOSS</a></h3>
<p><a href="https://github.com/mandiant/flare-floss"><strong>FLOSS</strong></a> 是一个工具，尝试使用不同的技术在可执行文件中查找混淆字符串。</p>
<h3 id="pepper"><a class="header" href="#pepper">PEpper</a></h3>
<p><a href="https://github.com/Th3Hurrican3/PEpper">PEpper</a> 检查可执行文件中的一些基本内容（如二进制数据、熵、URLs 和 IPs，以及一些 yara 规则）。</p>
<h3 id="pestudio"><a class="header" href="#pestudio">PEstudio</a></h3>
<p><a href="https://www.winitor.com/download">PEstudio</a> 是一个工具，可以获取 Windows 可执行文件的信息，如导入、导出、头部信息，同时还会检查病毒总数并找到潜在的 Att&amp;ck 技术。</p>
<h3 id="detect-it-easydie"><a class="header" href="#detect-it-easydie">Detect It Easy(DiE)</a></h3>
<p><a href="https://github.com/horsicq/Detect-It-Easy/"><strong>DiE</strong></a> 是一个检测文件是否被 <strong>加密</strong> 的工具，同时也能找到 <strong>打包器</strong>。</p>
<h3 id="neopi"><a class="header" href="#neopi">NeoPI</a></h3>
<p><a href="https://github.com/CiscoCXSecurity/NeoPI"><strong>NeoPI</strong></a> 是一个 Python 脚本，使用多种 <strong>统计方法</strong> 来检测文本/脚本文件中的 <strong>混淆</strong> 和 <strong>加密</strong> 内容。NeoPI 的预期目的是帮助 <strong>检测隐藏的 web shell 代码</strong>。</p>
<h3 id="php-malware-finder"><a class="header" href="#php-malware-finder"><strong>php-malware-finder</strong></a></h3>
<p><a href="https://github.com/nbs-system/php-malware-finder"><strong>PHP-malware-finder</strong></a> 尽力检测 <strong>混淆</strong>/<strong>可疑代码</strong> 以及使用 <strong>PHP</strong> 函数的文件，这些函数通常用于 <strong>恶意软件</strong>/webshells。</p>
<h3 id="apple-binary-signatures"><a class="header" href="#apple-binary-signatures">Apple Binary Signatures</a></h3>
<p>在检查某些 <strong>恶意软件样本</strong> 时，您应该始终 <strong>检查二进制文件的签名</strong>，因为签名的 <strong>开发者</strong> 可能已经与 <strong>恶意软件</strong> 有关。</p>
<pre><code class="language-bash">#Get signer
codesign -vv -d /bin/ls 2&gt;&amp;1 | grep -E "Authority|TeamIdentifier"

#Check if the app’s contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
</code></pre>
<h2 id="检测技术"><a class="header" href="#检测技术">检测技术</a></h2>
<h3 id="文件堆叠"><a class="header" href="#文件堆叠">文件堆叠</a></h3>
<p>如果你知道某个包含<strong>文件</strong>的文件夹<strong>最后更新于某个日期</strong>。<strong>检查</strong>该<strong>文件夹</strong>中所有<strong>文件</strong>的<strong>创建和修改日期</strong>，如果有任何日期是<strong>可疑的</strong>，请检查该文件。</p>
<h3 id="基线"><a class="header" href="#基线">基线</a></h3>
<p>如果一个文件夹的文件<strong>不应该被修改</strong>，你可以计算该文件夹<strong>原始文件</strong>的<strong>哈希值</strong>并与<strong>当前</strong>文件进行<strong>比较</strong>。任何被修改的文件都将是<strong>可疑的</strong>。</p>
<h3 id="统计分析"><a class="header" href="#统计分析">统计分析</a></h3>
<p>当信息保存在日志中时，你可以<strong>检查统计数据，例如每个文件在web服务器上被访问的次数，因为web shell可能是其中之一</strong>。</p>
<p>{% hint style="success" %}
学习和实践AWS黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks培训AWS红队专家（ARTE）</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践GCP黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks培训GCP红队专家（GRTE）</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持HackTricks</summary>
<ul>
<li>查看<a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord群组</strong></a>或<a href="https://t.me/peass"><strong>电报群组</strong></a>或<strong>关注</strong>我们的<strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a>和<a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github库提交PR分享黑客技巧。</li>
</ul>
</details>
{% endhint %}

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../generic-methodologies-and-resources/basic-forensic-methodology/linux-forensics.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../generic-methodologies-and-resources/basic-forensic-methodology/memory-dump-analysis/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../generic-methodologies-and-resources/basic-forensic-methodology/linux-forensics.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../generic-methodologies-and-resources/basic-forensic-methodology/memory-dump-analysis/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
