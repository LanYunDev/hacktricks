<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Linux Forensics</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linux-forensics"><a class="header" href="#linux-forensics">Linux Forensics</a></h1>
<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
使用 <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=linux-forensics"><strong>Trickest</strong></a> 轻松构建和 <strong>自动化工作流程</strong>，由世界上 <strong>最先进</strong> 的社区工具提供支持。<br />
今天获取访问权限：</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=linux-forensics" %}</p>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>在</strong> <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a>** 上关注我们。**</li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 来分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<h2 id="初始信息收集"><a class="header" href="#初始信息收集">初始信息收集</a></h2>
<h3 id="基本信息"><a class="header" href="#基本信息">基本信息</a></h3>
<p>首先，建议准备一些 <strong>USB</strong>，上面有 <strong>已知的良好二进制文件和库</strong>（你可以直接获取 ubuntu 并复制文件夹 <em>/bin</em>, <em>/sbin</em>, <em>/lib,</em> 和 <em>/lib64</em>），然后挂载 USB，并修改环境变量以使用这些二进制文件：</p>
<pre><code class="language-bash">export PATH=/mnt/usb/bin:/mnt/usb/sbin
export LD_LIBRARY_PATH=/mnt/usb/lib:/mnt/usb/lib64
</code></pre>
<p>一旦您配置系统以使用良好且已知的二进制文件，您可以开始<strong>提取一些基本信息</strong>：</p>
<pre><code class="language-bash">date #Date and time (Clock may be skewed, Might be at a different timezone)
uname -a #OS info
ifconfig -a || ip a #Network interfaces (promiscuous mode?)
ps -ef #Running processes
netstat -anp #Proccess and ports
lsof -V #Open files
netstat -rn; route #Routing table
df; mount #Free space and mounted devices
free #Meam and swap space
w #Who is connected
last -Faiwx #Logins
lsmod #What is loaded
cat /etc/passwd #Unexpected data?
cat /etc/shadow #Unexpected data?
find /directory -type f -mtime -1 -print #Find modified files during the last minute in the directory
</code></pre>
<h4 id="可疑信息"><a class="header" href="#可疑信息">可疑信息</a></h4>
<p>在获取基本信息时，您应该检查一些奇怪的事情，例如：</p>
<ul>
<li><strong>Root 进程</strong> 通常使用低 PIDS，因此如果您发现一个具有大 PID 的 root 进程，您可能会怀疑</li>
<li>检查 <code>/etc/passwd</code> 中没有 shell 的用户的 <strong>注册登录</strong></li>
<li>检查 <code>/etc/shadow</code> 中没有 shell 的用户的 <strong>密码哈希</strong></li>
</ul>
<h3 id="内存转储"><a class="header" href="#内存转储">内存转储</a></h3>
<p>要获取运行系统的内存，建议使用 <a href="https://github.com/504ensicsLabs/LiME"><strong>LiME</strong></a>。<br />
要 <strong>编译</strong> 它，您需要使用受害者机器正在使用的 <strong>相同内核</strong>。</p>
<p>{% hint style="info" %}
请记住，您 <strong>不能在受害者机器上安装 LiME 或其他任何东西</strong>，因为这会对其进行多项更改
{% endhint %}</p>
<p>因此，如果您有一个相同版本的 Ubuntu，您可以使用 <code>apt-get install lime-forensics-dkms</code><br />
在其他情况下，您需要从 github 下载 <a href="https://github.com/504ensicsLabs/LiME"><strong>LiME</strong></a> 并使用正确的内核头文件进行编译。要 <strong>获取受害者机器的确切内核头文件</strong>，您可以直接 <strong>复制目录</strong> <code>/lib/modules/&lt;kernel version&gt;</code> 到您的机器，然后使用它们 <strong>编译</strong> LiME：</p>
<pre><code class="language-bash">make -C /lib/modules/&lt;kernel version&gt;/build M=$PWD
sudo insmod lime.ko "path=/home/sansforensics/Desktop/mem_dump.bin format=lime"
</code></pre>
<p>LiME 支持 3 <strong>格式</strong>：</p>
<ul>
<li>原始（每个段落连接在一起）</li>
<li>填充（与原始相同，但右侧位用零填充）</li>
<li>Lime（推荐格式，带有元数据）</li>
</ul>
<p>LiME 还可以用于 <strong>通过网络发送转储</strong>，而不是使用类似 <code>path=tcp:4444</code> 的方式将其存储在系统上。</p>
<h3 id="磁盘成像"><a class="header" href="#磁盘成像">磁盘成像</a></h3>
<h4 id="关机"><a class="header" href="#关机">关机</a></h4>
<p>首先，您需要 <strong>关闭系统</strong>。这并不总是一个选项，因为有时系统可能是公司无法承受关闭的生产服务器。<br />
有 <strong>2 种方法</strong> 可以关闭系统，<strong>正常关机</strong> 和 <strong>“拔掉插头”关机</strong>。第一种方法将允许 <strong>进程正常终止</strong>，并使 <strong>文件系统</strong> <strong>同步</strong>，但这也可能允许潜在的 <strong>恶意软件</strong> <strong>破坏证据</strong>。“拔掉插头”方法可能会导致 <strong>一些信息丢失</strong>（由于我们已经获取了内存的映像，丢失的信息不会很多），并且 <strong>恶意软件将没有机会</strong> 采取任何行动。因此，如果您 <strong>怀疑</strong> 可能存在 <strong>恶意软件</strong>，请在系统上执行 <strong><code>sync</code></strong> <strong>命令</strong> 然后拔掉插头。</p>
<h4 id="获取磁盘映像"><a class="header" href="#获取磁盘映像">获取磁盘映像</a></h4>
<p>重要的是要注意，在 <strong>将计算机连接到与案件相关的任何设备之前</strong>，您需要确保它将以 <strong>只读方式挂载</strong>，以避免修改任何信息。</p>
<pre><code class="language-bash">#Create a raw copy of the disk
dd if=&lt;subject device&gt; of=&lt;image file&gt; bs=512

#Raw copy with hashes along the way (more secure as it checks hashes while it's copying the data)
dcfldd if=&lt;subject device&gt; of=&lt;image file&gt; bs=512 hash=&lt;algorithm&gt; hashwindow=&lt;chunk size&gt; hashlog=&lt;hash file&gt;
dcfldd if=/dev/sdc of=/media/usb/pc.image hash=sha256 hashwindow=1M hashlog=/media/usb/pc.hashes
</code></pre>
<h3 id="磁盘映像预分析"><a class="header" href="#磁盘映像预分析">磁盘映像预分析</a></h3>
<p>对没有更多数据的磁盘映像进行成像。</p>
<pre><code class="language-bash">#Find out if it's a disk image using "file" command
file disk.img
disk.img: Linux rev 1.0 ext4 filesystem data, UUID=59e7a736-9c90-4fab-ae35-1d6a28e5de27 (extents) (64bit) (large files) (huge files)

#Check which type of disk image it's
img_stat -t evidence.img
raw
#You can list supported types with
img_stat -i list
Supported image format types:
raw (Single or split raw file (dd))
aff (Advanced Forensic Format)
afd (AFF Multiple File)
afm (AFF with external metadata)
afflib (All AFFLIB image formats (including beta ones))
ewf (Expert Witness Format (EnCase))

#Data of the image
fsstat -i raw -f ext4 disk.img
FILE SYSTEM INFORMATION
--------------------------------------------
File System Type: Ext4
Volume Name:
Volume ID: 162850f203fd75afab4f1e4736a7e776

Last Written at: 2020-02-06 06:22:48 (UTC)
Last Checked at: 2020-02-06 06:15:09 (UTC)

Last Mounted at: 2020-02-06 06:15:18 (UTC)
Unmounted properly
Last mounted on: /mnt/disk0

Source OS: Linux
[...]

#ls inside the image
fls -i raw -f ext4 disk.img
d/d 11: lost+found
d/d 12: Documents
d/d 8193:       folder1
d/d 8194:       folder2
V/V 65537:      $OrphanFiles

#ls inside folder
fls -i raw -f ext4 disk.img 12
r/r 16: secret.txt

#cat file inside image
icat -i raw -f ext4 disk.img 16
ThisisTheMasterSecret
</code></pre>
<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
使用 <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=linux-forensics"><strong>Trickest</strong></a> 轻松构建和 <strong>自动化工作流程</strong>，由世界上 <strong>最先进</strong> 的社区工具提供支持。<br />
立即获取访问权限：</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=linux-forensics" %}</p>
<h2 id="搜索已知恶意软件"><a class="header" href="#搜索已知恶意软件">搜索已知恶意软件</a></h2>
<h3 id="修改过的系统文件"><a class="header" href="#修改过的系统文件">修改过的系统文件</a></h3>
<p>Linux 提供工具以确保系统组件的完整性，这对于发现潜在问题文件至关重要。</p>
<ul>
<li><strong>基于 RedHat 的系统</strong>：使用 <code>rpm -Va</code> 进行全面检查。</li>
<li><strong>基于 Debian 的系统</strong>：使用 <code>dpkg --verify</code> 进行初步验证，然后使用 <code>debsums | grep -v "OK$"</code>（在使用 <code>apt-get install debsums</code> 安装 <code>debsums</code> 后）来识别任何问题。</li>
</ul>
<h3 id="恶意软件rootkit-检测器"><a class="header" href="#恶意软件rootkit-检测器">恶意软件/Rootkit 检测器</a></h3>
<p>阅读以下页面以了解可以用于查找恶意软件的工具：</p>
<p>{% content-ref url="malware-analysis.md" %}
<a href="malware-analysis.html">malware-analysis.md</a>
{% endcontent-ref %}</p>
<h2 id="搜索已安装程序"><a class="header" href="#搜索已安装程序">搜索已安装程序</a></h2>
<p>要有效搜索 Debian 和 RedHat 系统上已安装的程序，可以考虑利用系统日志和数据库，同时在常见目录中进行手动检查。</p>
<ul>
<li>对于 Debian，检查 <em><strong><code>/var/lib/dpkg/status</code></strong></em> 和 <em><strong><code>/var/log/dpkg.log</code></strong></em> 以获取有关软件包安装的详细信息，使用 <code>grep</code> 过滤特定信息。</li>
<li>RedHat 用户可以使用 <code>rpm -qa --root=/mntpath/var/lib/rpm</code> 查询 RPM 数据库以列出已安装的软件包。</li>
</ul>
<p>要发现手动安装或在这些软件包管理器之外安装的软件，探索目录如 <em><strong><code>/usr/local</code></strong></em>、<em><strong><code>/opt</code></strong></em>、<em><strong><code>/usr/sbin</code></strong></em>、<em><strong><code>/usr/bin</code></strong></em>、<em><strong><code>/bin</code></strong></em> 和 <em><strong><code>/sbin</code></strong></em>。将目录列表与特定于系统的命令结合使用，以识别与已知软件包无关的可执行文件，从而增强您对所有已安装程序的搜索。</p>
<pre><code class="language-bash"># Debian package and log details
cat /var/lib/dpkg/status | grep -E "Package:|Status:"
cat /var/log/dpkg.log | grep installed
# RedHat RPM database query
rpm -qa --root=/mntpath/var/lib/rpm
# Listing directories for manual installations
ls /usr/sbin /usr/bin /bin /sbin
# Identifying non-package executables (Debian)
find /sbin/ -exec dpkg -S {} \; | grep "no path found"
# Identifying non-package executables (RedHat)
find /sbin/ –exec rpm -qf {} \; | grep "is not"
# Find exacuable files
find / -type f -executable | grep &lt;something&gt;
</code></pre>
<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
使用 <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=linux-forensics"><strong>Trickest</strong></a> 轻松构建和 <strong>自动化工作流程</strong>，由世界上 <strong>最先进</strong> 的社区工具提供支持。<br />
立即获取访问权限：</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=linux-forensics" %}</p>
<h2 id="恢复已删除的运行二进制文件"><a class="header" href="#恢复已删除的运行二进制文件">恢复已删除的运行二进制文件</a></h2>
<p>想象一下一个从 /tmp/exec 执行并随后被删除的进程。可以提取它</p>
<pre><code class="language-bash">cd /proc/3746/ #PID with the exec file deleted
head -1 maps #Get address of the file. It was 08048000-08049000
dd if=mem bs=1 skip=08048000 count=1000 of=/tmp/exec2 #Recorver it
</code></pre>
<h2 id="检查自启动位置"><a class="header" href="#检查自启动位置">检查自启动位置</a></h2>
<h3 id="计划任务"><a class="header" href="#计划任务">计划任务</a></h3>
<pre><code class="language-bash">cat /var/spool/cron/crontabs/*  \
/var/spool/cron/atjobs \
/var/spool/anacron \
/etc/cron* \
/etc/at* \
/etc/anacrontab \
/etc/incron.d/* \
/var/spool/incron/* \

#MacOS
ls -l /usr/lib/cron/tabs/ /Library/LaunchAgents/ /Library/LaunchDaemons/ ~/Library/LaunchAgents/
</code></pre>
<h3 id="服务"><a class="header" href="#服务">服务</a></h3>
<p>恶意软件可以作为服务安装的路径：</p>
<ul>
<li><strong>/etc/inittab</strong>: 调用初始化脚本，如 rc.sysinit，进一步指向启动脚本。</li>
<li><strong>/etc/rc.d/</strong> 和 <strong>/etc/rc.boot/</strong>: 包含服务启动的脚本，后者在较旧的 Linux 版本中找到。</li>
<li><strong>/etc/init.d/</strong>: 在某些 Linux 版本中（如 Debian）用于存储启动脚本。</li>
<li>服务也可以通过 <strong>/etc/inetd.conf</strong> 或 <strong>/etc/xinetd/</strong> 激活，具体取决于 Linux 变体。</li>
<li><strong>/etc/systemd/system</strong>: 系统和服务管理器脚本的目录。</li>
<li><strong>/etc/systemd/system/multi-user.target.wants/</strong>: 包含应在多用户运行级别启动的服务的链接。</li>
<li><strong>/usr/local/etc/rc.d/</strong>: 用于自定义或第三方服务。</li>
<li><strong>~/.config/autostart/</strong>: 用户特定的自动启动应用程序，可以是针对用户的恶意软件的隐藏地点。</li>
<li><strong>/lib/systemd/system/</strong>: 安装包提供的系统范围默认单元文件。</li>
</ul>
<h3 id="内核模块"><a class="header" href="#内核模块">内核模块</a></h3>
<p>Linux 内核模块，通常被恶意软件作为 rootkit 组件使用，在系统启动时加载。与这些模块相关的关键目录和文件包括：</p>
<ul>
<li><strong>/lib/modules/$(uname -r)</strong>: 存放正在运行的内核版本的模块。</li>
<li><strong>/etc/modprobe.d</strong>: 包含控制模块加载的配置文件。</li>
<li><strong>/etc/modprobe</strong> 和 <strong>/etc/modprobe.conf</strong>: 全局模块设置的文件。</li>
</ul>
<h3 id="其他自动启动位置"><a class="header" href="#其他自动启动位置">其他自动启动位置</a></h3>
<p>Linux 使用各种文件在用户登录时自动执行程序，可能隐藏恶意软件：</p>
<ul>
<li><strong>/etc/profile.d/</strong>*, <strong>/etc/profile</strong> 和 <strong>/etc/bash.bashrc</strong>: 针对任何用户登录执行。</li>
<li><strong>~/.bashrc</strong>, <strong>~/.bash_profile</strong>, <strong>~/.profile</strong> 和 <strong>~/.config/autostart</strong>: 用户特定的文件，在他们登录时运行。</li>
<li><strong>/etc/rc.local</strong>: 在所有系统服务启动后运行，标志着过渡到多用户环境的结束。</li>
</ul>
<h2 id="检查日志"><a class="header" href="#检查日志">检查日志</a></h2>
<p>Linux 系统通过各种日志文件跟踪用户活动和系统事件。这些日志对于识别未经授权的访问、恶意软件感染和其他安全事件至关重要。关键日志文件包括：</p>
<ul>
<li><strong>/var/log/syslog</strong> (Debian) 或 <strong>/var/log/messages</strong> (RedHat): 捕获系统范围的消息和活动。</li>
<li><strong>/var/log/auth.log</strong> (Debian) 或 <strong>/var/log/secure</strong> (RedHat): 记录身份验证尝试、成功和失败的登录。</li>
<li>使用 <code>grep -iE "session opened for|accepted password|new session|not in sudoers" /var/log/auth.log</code> 过滤相关的身份验证事件。</li>
<li><strong>/var/log/boot.log</strong>: 包含系统启动消息。</li>
<li><strong>/var/log/maillog</strong> 或 <strong>/var/log/mail.log</strong>: 记录邮件服务器活动，有助于跟踪与邮件相关的服务。</li>
<li><strong>/var/log/kern.log</strong>: 存储内核消息，包括错误和警告。</li>
<li><strong>/var/log/dmesg</strong>: 保存设备驱动程序消息。</li>
<li><strong>/var/log/faillog</strong>: 记录失败的登录尝试，有助于安全漏洞调查。</li>
<li><strong>/var/log/cron</strong>: 记录 cron 作业执行。</li>
<li><strong>/var/log/daemon.log</strong>: 跟踪后台服务活动。</li>
<li><strong>/var/log/btmp</strong>: 记录失败的登录尝试。</li>
<li><strong>/var/log/httpd/</strong>: 包含 Apache HTTPD 错误和访问日志。</li>
<li><strong>/var/log/mysqld.log</strong> 或 <strong>/var/log/mysql.log</strong>: 记录 MySQL 数据库活动。</li>
<li><strong>/var/log/xferlog</strong>: 记录 FTP 文件传输。</li>
<li><strong>/var/log/</strong>: 始终检查此处是否有意外日志。</li>
</ul>
<p>{% hint style="info" %}
Linux 系统日志和审计子系统可能在入侵或恶意软件事件中被禁用或删除。由于 Linux 系统上的日志通常包含有关恶意活动的一些最有用的信息，入侵者通常会删除它们。因此，在检查可用日志文件时，重要的是查找可能表明删除或篡改的间隙或无序条目。
{% endhint %}</p>
<p><strong>Linux 为每个用户维护命令历史</strong>，存储在：</p>
<ul>
<li>~/.bash_history</li>
<li>~/.zsh_history</li>
<li>~/.zsh_sessions/*</li>
<li>~/.python_history</li>
<li>~/.*_history</li>
</ul>
<p>此外，<code>last -Faiwx</code> 命令提供用户登录的列表。检查是否有未知或意外的登录。</p>
<p>检查可以授予额外权限的文件：</p>
<ul>
<li>审查 <code>/etc/sudoers</code> 以查找可能被授予的意外用户权限。</li>
<li>审查 <code>/etc/sudoers.d/</code> 以查找可能被授予的意外用户权限。</li>
<li>检查 <code>/etc/groups</code> 以识别任何不寻常的组成员资格或权限。</li>
<li>检查 <code>/etc/passwd</code> 以识别任何不寻常的组成员资格或权限。</li>
</ul>
<p>一些应用程序还会生成自己的日志：</p>
<ul>
<li><strong>SSH</strong>: 检查 <em>~/.ssh/authorized_keys</em> 和 <em>~/.ssh/known_hosts</em> 以查找未经授权的远程连接。</li>
<li><strong>Gnome 桌面</strong>: 查看 <em>~/.recently-used.xbel</em> 以查找通过 Gnome 应用程序最近访问的文件。</li>
<li><strong>Firefox/Chrome</strong>: 检查 <em>~/.mozilla/firefox</em> 或 <em>~/.config/google-chrome</em> 中的浏览器历史和下载，以查找可疑活动。</li>
<li><strong>VIM</strong>: 检查 <em>~/.viminfo</em> 以获取使用详情，如访问的文件路径和搜索历史。</li>
<li><strong>Open Office</strong>: 检查最近的文档访问，以指示可能被破坏的文件。</li>
<li><strong>FTP/SFTP</strong>: 检查 <em>~/.ftp_history</em> 或 <em>~/.sftp_history</em> 中的日志，以查找可能未经授权的文件传输。</li>
<li><strong>MySQL</strong>: 检查 <em>~/.mysql_history</em> 以调查执行的 MySQL 查询，可能揭示未经授权的数据库活动。</li>
<li><strong>Less</strong>: 分析 <em>~/.lesshst</em> 以获取使用历史，包括查看的文件和执行的命令。</li>
<li><strong>Git</strong>: 检查 <em>~/.gitconfig</em> 和项目 <em>.git/logs</em> 以查找对存储库的更改。</li>
</ul>
<h3 id="usb-日志"><a class="header" href="#usb-日志">USB 日志</a></h3>
<p><a href="https://github.com/snovvcrash/usbrip"><strong>usbrip</strong></a> 是一个用纯 Python 3 编写的小软件，它解析 Linux 日志文件（<code>/var/log/syslog*</code> 或 <code>/var/log/messages*</code>，具体取决于发行版），以构建 USB 事件历史表。</p>
<p>了解<strong>所有使用过的 USB</strong> 是很有趣的，如果你有一个授权的 USB 列表来查找“违规事件”（不在该列表中的 USB 使用），将更有用。</p>
<h3 id="安装"><a class="header" href="#安装">安装</a></h3>
<pre><code class="language-bash">pip3 install usbrip
usbrip ids download #Download USB ID database
</code></pre>
<h3 id="示例"><a class="header" href="#示例">示例</a></h3>
<pre><code class="language-bash">usbrip events history #Get USB history of your curent linux machine
usbrip events history --pid 0002 --vid 0e0f --user kali #Search by pid OR vid OR user
#Search for vid and/or pid
usbrip ids download #Downlaod database
usbrip ids search --pid 0002 --vid 0e0f #Search for pid AND vid
</code></pre>
<p>更多示例和信息请查看 GitHub: <a href="https://github.com/snovvcrash/usbrip">https://github.com/snovvcrash/usbrip</a></p>
<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
使用 <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=linux-forensics"><strong>Trickest</strong></a> 轻松构建和 <strong>自动化工作流程</strong>，由世界上 <strong>最先进</strong> 的社区工具提供支持。<br />
今天就获取访问权限：</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=linux-forensics" %}</p>
<h2 id="审查用户账户和登录活动"><a class="header" href="#审查用户账户和登录活动">审查用户账户和登录活动</a></h2>
<p>检查 <em><strong>/etc/passwd</strong></em>、<em><strong>/etc/shadow</strong></em> 和 <strong>安全日志</strong>，寻找不寻常的名称或在已知未授权事件附近创建和使用的账户。同时，检查可能的 sudo 暴力攻击。<br />
此外，检查像 <em><strong>/etc/sudoers</strong></em> 和 <em><strong>/etc/groups</strong></em> 这样的文件，寻找意外授予用户的特权。<br />
最后，查找 <strong>没有密码</strong> 或 <strong>容易猜测</strong> 的密码的账户。</p>
<h2 id="检查文件系统"><a class="header" href="#检查文件系统">检查文件系统</a></h2>
<h3 id="在恶意软件调查中分析文件系统结构"><a class="header" href="#在恶意软件调查中分析文件系统结构">在恶意软件调查中分析文件系统结构</a></h3>
<p>在调查恶意软件事件时，文件系统的结构是重要的信息来源，揭示事件的顺序和恶意软件的内容。然而，恶意软件作者正在开发技术来阻碍这种分析，例如修改文件时间戳或避免使用文件系统进行数据存储。</p>
<p>为了对抗这些反取证方法，至关重要的是：</p>
<ul>
<li><strong>进行彻底的时间线分析</strong>，使用像 <strong>Autopsy</strong> 这样的工具可视化事件时间线，或使用 <strong>Sleuth Kit</strong> 的 <code>mactime</code> 获取详细的时间线数据。</li>
<li><strong>调查系统 $PATH 中的意外脚本</strong>，这些脚本可能包括攻击者使用的 shell 或 PHP 脚本。</li>
<li><strong>检查 <code>/dev</code> 中的非典型文件</strong>，因为它通常包含特殊文件，但可能存放与恶意软件相关的文件。</li>
<li><strong>搜索隐藏的文件或目录</strong>，名称可能为 ".. "（点点空格）或 "..^G"（点点控制-G），这些可能隐藏恶意内容。</li>
<li><strong>识别 setuid root 文件</strong>，使用命令：<code>find / -user root -perm -04000 -print</code> 这将找到具有提升权限的文件，可能被攻击者滥用。</li>
<li><strong>检查 inode 表中的删除时间戳</strong>，以发现大规模文件删除，可能表明存在 rootkit 或木马。</li>
<li><strong>在识别到一个恶意文件后，检查连续的 inode</strong>，因为它们可能被放置在一起。</li>
<li><strong>检查常见的二进制目录</strong> (<em>/bin</em>、<em>/sbin</em>) 中最近修改的文件，因为这些文件可能被恶意软件更改。</li>
</ul>
<pre><code class="language-bash"># List recent files in a directory:
ls -laR --sort=time /bin```

# Sort files in a directory by inode:
ls -lai /bin | sort -n```
</code></pre>
<p>{% hint style="info" %}
注意，<strong>攻击者</strong>可以<strong>修改****时间</strong>以使<strong>文件看起来</strong>是<strong>合法的</strong>，但他<strong>无法</strong>修改<strong>inode</strong>。如果你发现一个<strong>文件</strong>显示它的创建和修改时间与同一文件夹中其他文件的<strong>时间相同</strong>，但<strong>inode</strong>却<strong>意外地更大</strong>，那么该<strong>文件的时间戳被修改了</strong>。
{% endhint %}</p>
<h2 id="比较不同文件系统版本的文件"><a class="header" href="#比较不同文件系统版本的文件">比较不同文件系统版本的文件</a></h2>
<h3 id="文件系统版本比较摘要"><a class="header" href="#文件系统版本比较摘要">文件系统版本比较摘要</a></h3>
<p>为了比较文件系统版本并确定更改，我们使用简化的 <code>git diff</code> 命令：</p>
<ul>
<li><strong>查找新文件</strong>，比较两个目录：</li>
</ul>
<pre><code class="language-bash">git diff --no-index --diff-filter=A path/to/old_version/ path/to/new_version/
</code></pre>
<ul>
<li><strong>对于修改过的内容</strong>，列出更改，同时忽略特定行：</li>
</ul>
<pre><code class="language-bash">git diff --no-index --diff-filter=M path/to/old_version/ path/to/new_version/ | grep -E "^\+" | grep -v "Installed-Time"
</code></pre>
<ul>
<li><strong>检测已删除文件</strong>:</li>
</ul>
<pre><code class="language-bash">git diff --no-index --diff-filter=D path/to/old_version/ path/to/new_version/
</code></pre>
<ul>
<li><strong>过滤选项</strong> (<code>--diff-filter</code>) 有助于缩小到特定的更改，如添加的 (<code>A</code>)、删除的 (<code>D</code>) 或修改的 (<code>M</code>) 文件。</li>
<li><code>A</code>: 添加的文件</li>
<li><code>C</code>: 复制的文件</li>
<li><code>D</code>: 删除的文件</li>
<li><code>M</code>: 修改的文件</li>
<li><code>R</code>: 重命名的文件</li>
<li><code>T</code>: 类型更改（例如，从文件到符号链接）</li>
<li><code>U</code>: 未合并的文件</li>
<li><code>X</code>: 未知的文件</li>
<li><code>B</code>: 损坏的文件</li>
</ul>
<h2 id="参考文献"><a class="header" href="#参考文献">参考文献</a></h2>
<ul>
<li><a href="https://cdn.ttgtmedia.com/rms/security/Malware%20Forensics%20Field%20Guide%20for%20Linux%20Systems_Ch3.pdf">https://cdn.ttgtmedia.com/rms/security/Malware%20Forensics%20Field%20Guide%20for%20Linux%20Systems_Ch3.pdf</a></li>
<li><a href="https://www.plesk.com/blog/featured/linux-logs-explained/">https://www.plesk.com/blog/featured/linux-logs-explained/</a></li>
<li><a href="https://git-scm.com/docs/git-diff#Documentation/git-diff.txt---diff-filterACDMRTUXB82308203">https://git-scm.com/docs/git-diff#Documentation/git-diff.txt---diff-filterACDMRTUXB82308203</a></li>
<li><strong>书籍：Linux系统恶意软件取证实用指南：数字取证实用指南</strong></li>
</ul>
<p>{% hint style="success" %}
学习和实践 AWS 黑客技术：<img src="/.gitbook/assets/arte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/arte"><strong>HackTricks 培训 AWS 红队专家 (ARTE)</strong></a><img src="/.gitbook/assets/arte.png" alt="" data-size="line"><br />
学习和实践 GCP 黑客技术：<img src="/.gitbook/assets/grte.png" alt="" data-size="line"><a href="https://training.hacktricks.xyz/courses/grte"><strong>HackTricks 培训 GCP 红队专家 (GRTE)</strong><img src="/.gitbook/assets/grte.png" alt="" data-size="line"></a></p>
<details>
<summary>支持 HackTricks</summary>
<ul>
<li>查看 <a href="https://github.com/sponsors/carlospolop"><strong>订阅计划</strong></a>!</li>
<li><strong>加入</strong> 💬 <a href="https://discord.gg/hRep4RUj7f"><strong>Discord 群组</strong></a> 或 <a href="https://t.me/peass"><strong>电报群组</strong></a> 或 <strong>关注</strong> 我们的 <strong>Twitter</strong> 🐦 <a href="https://twitter.com/hacktricks_live"><strong>@hacktricks_live</strong></a><strong>.</strong></li>
<li><strong>通过向</strong> <a href="https://github.com/carlospolop/hacktricks"><strong>HackTricks</strong></a> 和 <a href="https://github.com/carlospolop/hacktricks-cloud"><strong>HackTricks Cloud</strong></a> github 仓库提交 PR 分享黑客技巧。</li>
</ul>
</details>
{% endhint %}
<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>
<p><br />
使用 <a href="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=text&amp;utm_campaign=ppc&amp;utm_content=linux-forensics"><strong>Trickest</strong></a> 轻松构建和 <strong>自动化工作流程</strong>，由世界上 <strong>最先进</strong> 的社区工具提供支持。<br />
今天就获取访问权限：</p>
<p>{% embed url="https://trickest.com/?utm_source=hacktricks&amp;utm_medium=banner&amp;utm_campaign=ppc&amp;utm_content=linux-forensics" %}</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../generic-methodologies-and-resources/basic-forensic-methodology/image-acquisition-and-mount.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../generic-methodologies-and-resources/basic-forensic-methodology/malware-analysis.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../generic-methodologies-and-resources/basic-forensic-methodology/image-acquisition-and-mount.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../generic-methodologies-and-resources/basic-forensic-methodology/malware-analysis.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
